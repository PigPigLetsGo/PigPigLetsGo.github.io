<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="Dkx の Java小窝" href="https://pigpigletsgo.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" title="Dkx の Java小窝" href="https://pigpigletsgo.github.io/atom.xml"><link rel="alternate" type="application/json" title="Dkx の Java小窝" href="https://pigpigletsgo.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="计算机学科,springcloud,Elasticsearch"><link rel="canonical" href="https://pigpigletsgo.github.io/computer-science/java/spring/springcloud/Elasticsearch/springcloud-elasticsearch/"><title>九、分布式搜索 - Elasticsearch - springcloud - spring - java - 计算机学科 | Dou的个人博客 = Dkx の Java 小窝 = 别怕路长梦远</title><meta name="generator" content="Hexo 5.4.2"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">九、分布式搜索</h1><div class="meta"><span class="item" title="创建时间：2024-01-24 18:48:46"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2024-01-24T18:48:46+08:00">2024-01-24</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>70k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>1:04</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Dou的个人博客</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/a8d0ac76b87f7593653e29559d61b32d.jpg"></li><li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/5651daf17bf5de77514e658264d7cccc.jpg"></li><li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/6c7f469735b99a6a04773240429dc7e0.jpg"></li><li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/666b3077b407f3c0ce9c10c00b861abe.jpg"></li><li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/6c7f469735b99a6a04773240429dc7e0.jpg"></li><li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/5651daf17bf5de77514e658264d7cccc.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/computer-science/" itemprop="item" rel="index" title="分类于 计算机学科"><span itemprop="name">计算机学科</span></a><meta itemprop="position" content="1"></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/computer-science/java/" itemprop="item" rel="index" title="分类于 java"><span itemprop="name">java</span></a><meta itemprop="position" content="2"></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/computer-science/java/spring/" itemprop="item" rel="index" title="分类于 spring"><span itemprop="name">spring</span></a><meta itemprop="position" content="3"></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/computer-science/java/spring/springcloud/" itemprop="item" rel="index" title="分类于 springcloud"><span itemprop="name">springcloud</span></a><meta itemprop="position" content="4"></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/computer-science/java/spring/springcloud/Elasticsearch/" itemprop="item" rel="index" title="分类于 Elasticsearch"><span itemprop="name">Elasticsearch</span></a><meta itemprop="position" content="5"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://pigpigletsgo.github.io/computer-science/java/spring/springcloud/Elasticsearch/springcloud-elasticsearch/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="Dkx"><meta itemprop="description" content="别怕路长梦远, 欢迎来我的博客空间"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Dkx の Java 小窝"></span><div class="body md" itemprop="articleBody"><h2 id="九-分布式搜索"><a class="anchor" href="#九-分布式搜索">#</a> 九、分布式搜索🎄</h2><p>elasticsearch 基础</p><ul><li>初始 elasticsearch</li><li>索引库操作</li><li>文档操作</li><li>RestAPI</li></ul><h3 id="91-初始elasticsearch"><a class="anchor" href="#91-初始elasticsearch">#</a> 9.1、初始 elasticsearch🌳</h3><ul><li>了解 ES</li><li>倒排索引</li><li>es 的一些概念</li><li>安装 es，kibana</li></ul><h4 id="911-什么是elasticsearch"><a class="anchor" href="#911-什么是elasticsearch">#</a> 9.1.1、什么是 elasticsearch🌲</h4><p>elasticsearch 是一款非常强大的开源<mark>搜索引擎</mark>，可以帮助我们从<mark>海量数据中快速找到需要的内容</mark>。</p><p>elasticsearch 结合 kibana，Logstash，Beats，也就是 elastic stack (ELK)。被广泛应用在日志数据分析，实时监控等领域。</p><p>elasticsearch 是 elastic stack 的核心，负责存储，搜索，分析数据。</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310111754105.png" alt="image-20231011175401979"></p><p>Elasticsearch 的底层实现就是<mark> Lucene</mark> 的技术</p><p>Lucene 是一个 Java 语言的<mark>搜索引擎类库</mark>，是 Apache 公司的顶级项目，由 Doug Cutting 于 1999 年研发。</p><p>官网地址：<span class="exturl" data-url="aHR0cHM6Ly9sdWNlbmUuYXBhY2hlLm9yZy8=">https://lucene.apache.org/</span></p><p>Lucene 的优势：</p><ul><li>易扩展</li><li>高性能 (基于倒排索引)</li></ul><p>2004 年 Shay Banon 基于 Lucene 开发了 Compass</p><p>2010 年 Shay Banon 重写了 Compass，取名为 Elasticsearch</p><p>官网地址：<span class="exturl" data-url="aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9jbi8=">https://www.elastic.co/cn/</span></p><p>目前最新的版本是：7.12.1</p><p>相比与 lucene，elasticsearch 具备下列优势：</p><ul><li>支持分布式，可水平扩展</li><li>提供 Restful 接口，可被任何语言调用</li></ul><p><strong>为什么学习 elasticsearch?</strong>。</p><p>搜索引擎技术排名：</p><p>1、Elasticsearch：开源的分布式搜索引擎</p><p>2、Splunk：商业项目</p><p>3、Solr：Apache 的开源搜索引擎</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310111923929.png" alt="image-20231011192322393"></p><blockquote><p><strong>总结</strong>：</p><p>什么是 elasticsearch?</p><ul><li>一个开源的<mark>分布式搜索引擎</mark>，可以用来实现搜索，日志统计，分析，系统监控等功能</li></ul><p>什么是 elastic stack (LEK)？</p><ul><li>是以 elasticsearch 为核心的技术栈，包括 beats，Logstash，kibana，elasticsearch</li></ul><p>什么是 Lucene?</p><ul><li>是 Apache 的开源搜索引擎类库，提供了搜索引擎的核心 API</li></ul></blockquote><h3 id="92-正向索引和倒排索引"><a class="anchor" href="#92-正向索引和倒排索引">#</a> 9.2、正向索引和倒排索引🌳</h3><p>传统数据库 (如 MySQL) 采用正向索引，例如给下表 (tb_goods) 中的 id 创建索引：</p><p>正向索引：做局部内部检索的时候性能比较差</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310111933421.png" alt="image-20231011193327307"></p><p>elasticsearch 采用倒排索引：</p><ul><li>文档 (document)：每条数据就是一个文档<ul><li>代表的就是数据，每一条数据就是一个文档</li></ul></li><li>词条 (term)：文档按照语义分成的词语<ul><li>如果是中文就按照中文的语义进行分词</li></ul></li></ul><p>倒排索引，会形成一个<mark>新的表</mark>。这张<mark>表里面有两个字段</mark>，一个字段是<mark>词条</mark>另一个是<mark>文档 id</mark>。</p><p>倒排索引，它在存储时会先把文档中的<mark>内容分成词条去存储</mark>。比方说我拿到了第一条数据那我要对标题创建倒排索引，那么我就来吧标题内容做个分词得到两个词语小米和手机，然后把每个这两个词语存到词条里，然后后面记录它的文档 id。<mark>重复的词语不会存入词条而是在已存在的词条后面追加上这个重复的词语的 id</mark>.</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310111945438.gif" alt="test"></p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310111953084.png" alt="image-20231011195333829"></p><blockquote><p><strong>总结</strong>:</p><p>什么是文档和词条？</p><ul><li>每一条数据就是一个文档</li><li>对文档中的内容分词，得到的词语就是词条</li></ul><p>什么是正向索引？</p><ul><li>基于文档 id 创建索引。查询词条时必须先找到文档，而后判断是否包含词条</li></ul><p>什么是倒排索引？</p><ul><li>对文档内容分词，对词条创建索引，并记录词条所在文档的信息。查询时先根据词条查询到文档 id，而后获取到文档</li></ul></blockquote><h3 id="93-文档"><a class="anchor" href="#93-文档">#</a> 9.3、文档🌳</h3><p>elasticsearch 是面向文档存储的，可以是数据库中的一条商品数据，一个订单信息。</p><p>文档数据会被序列化为 json 格式后存储在 elasticsearch 中。</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310112001435.png" alt="image-20231011200117293"></p><h3 id="94-索引-index"><a class="anchor" href="#94-索引-index">#</a> 9.4、索引 (index)🌳</h3><ul><li>索引 (index)：相同类型的文档的集合</li><li>映射 (mapping)：索引中文档的字段约束信息，类似表的结构约束</li></ul><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310112003417.png" alt="image-20231011200324370"></p><h3 id="95-概念对比"><a class="anchor" href="#95-概念对比">#</a> 9.5、概念对比🌳</h3><table><thead><tr><th>MySQL</th><th>Elasticsearch</th><th>说明</th></tr></thead><tbody><tr><td>Table</td><td>Index</td><td>索引 (index)，就是文档的集合，类似数据库的表 (table)</td></tr><tr><td>Row</td><td>Document</td><td>文档 (document)，就是一条条的数据，类似数据库中的行 (Row)，文档都是 JSON 格式</td></tr><tr><td>Column</td><td>Field</td><td>字段 (Field)，就是 JSON 文档中的字段，类似数据库中的列 (Column)</td></tr><tr><td>Schema</td><td>Mapping</td><td>Mapping (映射) 是索引中文档的约束，例如字段类型约束。类似数据库的表结构 (Schema)</td></tr><tr><td>SQL</td><td>DSL</td><td>DSL 是 elasticsearch 提供的 JSON 风格的请求语句，用来操作 elasticsearch，实现 CRUD</td></tr></tbody></table><h3 id="95-架构"><a class="anchor" href="#95-架构">#</a> 9.5、架构🌳</h3><p>MySQL：擅长事务类型操作，可以确保数据的安全和一致性</p><p>Elasticsearch：擅长海量数据的搜索，分析，计算</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310112013859.png" alt="image-20231011201341793"></p><blockquote><p><strong>总结</strong>：</p><p>文档：一条数据就是一个文档，es 中是 json 格式</p><p>字段：json 文档中的字段</p><p>索引：同类型文档的集合</p><p>映射：索引中文档的约束，比如字段名称，类型</p><p>elasticsearch 与数据库的关系：</p><ul><li>数据库负责事务类型操作</li><li>elasticsearch 负责海量数据的搜索，分析，计算</li></ul></blockquote><h3 id="96-安装和部署"><a class="anchor" href="#96-安装和部署">#</a> 9.6、安装和部署🌳</h3><p><a href="./Elasearch/%E5%AE%89%E8%A3%85elasticsearch.md">查看 elaticsearch 安装和部署</a>。</p><h3 id="97-分词器"><a class="anchor" href="#97-分词器">#</a> 9.7、分词器🌳</h3><p>es 在创建倒排索引时需要对文档进行分词；在搜索时，需要对用户输入内容分词。但默认的分词规则对中文处理并不友好。我们在 kibana 的 DevTools 中测试：</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310112105308.png" alt="image-20231011210532721"></p><p>语法说明：</p><ul><li>POST：请求方式</li><li>/_analyze：请求路径，这里省略了 http://192.168.150.101:9200，有 kibana 帮我们补充</li><li>请求参数，json 风格：<ul><li>analyzer：分词器类型，这里是默认的 standard 分词器</li><li>text：要分词的内容</li></ul></li></ul><p>kibana 中测试结果如下：</p><pre><code>&#123;
  &quot;tokens&quot; : [
    &#123;
      &quot;token&quot; : &quot;黑&quot;,
      &quot;start_offset&quot; : 0,
      &quot;end_offset&quot; : 1,
      &quot;type&quot; : &quot;&lt;IDEOGRAPHIC&gt;&quot;,
      &quot;position&quot; : 0
    &#125;,
    &#123;
      &quot;token&quot; : &quot;马&quot;,
      &quot;start_offset&quot; : 1,
      &quot;end_offset&quot; : 2,
      &quot;type&quot; : &quot;&lt;IDEOGRAPHIC&gt;&quot;,
      &quot;position&quot; : 1
    &#125;,
    &#123;
      &quot;token&quot; : &quot;程&quot;,
      &quot;start_offset&quot; : 2,
      &quot;end_offset&quot; : 3,
      &quot;type&quot; : &quot;&lt;IDEOGRAPHIC&gt;&quot;,
      &quot;position&quot; : 2
    &#125;,
    &#123;
      &quot;token&quot; : &quot;序&quot;,
      &quot;start_offset&quot; : 3,
      &quot;end_offset&quot; : 4,
      &quot;type&quot; : &quot;&lt;IDEOGRAPHIC&gt;&quot;,
      &quot;position&quot; : 3
    &#125;,
    &#123;
      &quot;token&quot; : &quot;员&quot;,
      &quot;start_offset&quot; : 4,
      &quot;end_offset&quot; : 5,
      &quot;type&quot; : &quot;&lt;IDEOGRAPHIC&gt;&quot;,
      &quot;position&quot; : 4
    &#125;,
    &#123;
      &quot;token&quot; : &quot;学&quot;,
      &quot;start_offset&quot; : 5,
      &quot;end_offset&quot; : 6,
      &quot;type&quot; : &quot;&lt;IDEOGRAPHIC&gt;&quot;,
      &quot;position&quot; : 5
    &#125;,
    &#123;
      &quot;token&quot; : &quot;习&quot;,
      &quot;start_offset&quot; : 6,
      &quot;end_offset&quot; : 7,
      &quot;type&quot; : &quot;&lt;IDEOGRAPHIC&gt;&quot;,
      &quot;position&quot; : 6
    &#125;,
    &#123;
      &quot;token&quot; : &quot;java&quot;,
      &quot;start_offset&quot; : 7,
      &quot;end_offset&quot; : 11,
      &quot;type&quot; : &quot;&lt;ALPHANUM&gt;&quot;,
      &quot;position&quot; : 7
    &#125;,
    &#123;
      &quot;token&quot; : &quot;太&quot;,
      &quot;start_offset&quot; : 11,
      &quot;end_offset&quot; : 12,
      &quot;type&quot; : &quot;&lt;IDEOGRAPHIC&gt;&quot;,
      &quot;position&quot; : 8
    &#125;,
    &#123;
      &quot;token&quot; : &quot;棒&quot;,
      &quot;start_offset&quot; : 12,
      &quot;end_offset&quot; : 13,
      &quot;type&quot; : &quot;&lt;IDEOGRAPHIC&gt;&quot;,
      &quot;position&quot; : 9
    &#125;,
    &#123;
      &quot;token&quot; : &quot;了&quot;,
      &quot;start_offset&quot; : 13,
      &quot;end_offset&quot; : 14,
      &quot;type&quot; : &quot;&lt;IDEOGRAPHIC&gt;&quot;,
      &quot;position&quot; : 10
    &#125;
  ]
&#125;
</code></pre><p>可以看到它对英文的分词挺好的但是对中文的分词却不好</p><p>解决办法：</p><p>处理中文分词，一般会使用 IK 分词器：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL21lZGNsL2VsYXN0aWNzZWFyY2gtYW5hbHlzaXMtaWs=">https://github.com/medcl/elasticsearch-analysis-ik</span></p><p>安装和使用 IK 分词器，参考文章：<a href="./Elasearch/%E5%AE%89%E8%A3%85elasticsearch.md">查看 IK 安装</a>.</p><h3 id="98-索引库操作"><a class="anchor" href="#98-索引库操作">#</a> 9.8、索引库操作🌳</h3><ul><li>mapping 映射属性</li><li>索引库的 CRUD</li></ul><h4 id="981-mapping属性"><a class="anchor" href="#981-mapping属性">#</a> 9.8.1、mapping 属性🌲</h4><p>mapping 是对索引库中文档的<mark>约束</mark>，常见的 mapping 属性包括：</p><ul><li>type：字段数据类型，常见的简单类型有<ul><li>字符串：text (可分词的文本)，keyword (精确值，例如：品牌，国家，ip 地址)</li><li>数值：long，integer，short，byte，double，float</li><li>布尔：boolean</li><li>日期：date</li><li>对象：object</li></ul></li><li>在 elasticsearch 中是没有数组这种类型的，但是它允许某一个字段有多个值</li><li>index：是否创建倒排索引，默认为 true (全创建倒排索引)</li><li>analyzer：使用哪种分词器 (结合 text 使用除了 text 以外其它都不需要用)<ul><li>值：分词器名称：ik_smart 或者 ik_max_word</li></ul></li><li>properties：该字段的子字段<ul><li>name 有两个子字段可以使用 properties 来指定子字段了</li></ul></li></ul><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310120907321.png" alt="image-20231012090710123"></p><blockquote><p><strong>总结</strong>：</p><p>mapping 常见属性有哪些？</p><ul><li>type：数据类型</li><li>index：是否索引</li><li>analyzer：分词器</li><li>properties：子字段</li></ul><p>type 常见的有哪些？</p><ul><li>字符串：text，keyword</li><li>数字：long，integer，short，byte，double，float</li><li>布尔：boolean</li><li>日期：date</li><li>对象 object</li></ul></blockquote><h4 id="982-创建索引库"><a class="anchor" href="#982-创建索引库">#</a> 9.8.2、创建索引库🌲</h4><p>ES 中通过 Restful 请求操作索引库，文档。请求内容用 DSL 语句来表示。创建索引库和 mapping 的 DSL 语法如下：</p><p>PUT 添加索引</p><p>info 用户信息内容很长所以是可分词的 text，分词器是 ik_smart。email 邮箱 没有分词的必要，因为它作为一个整体才有意义所以使用 keyword 不进行分词，因此不进行分词也就不需要 analyzer 了，使用 index=false 表示这个字段不参与创建倒排索引。name 名称，带有嵌套，它有指定的 properties，里面还有一个 firstName。</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310120918101.png" alt="image-20231012091855829"></p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre>PUT /dkx</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>      <span class="token property">"info"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"ik_smart"</span></pre></td></tr><tr><td data-num="8"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token property">"email"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token property">"index"</span><span class="token operator">:</span> <span class="token boolean">false</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"object"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>          <span class="token property">"firstName"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span></pre></td></tr><tr><td data-num="18"></td><td><pre>          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>          <span class="token property">"lastName"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span></pre></td></tr><tr><td data-num="21"></td><td><pre>          <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>运行结果：</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token property">"acknowledged"</span> <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token property">"shards_acknowledged"</span> <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token property">"index"</span> <span class="token operator">:</span> <span class="token string">"dkx"</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>创建成功！</p><h4 id="983-查看删除索引库"><a class="anchor" href="#983-查看删除索引库">#</a> 9.8.3、查看，删除索引库🌲</h4><p>查看索引库语法：</p><pre><code>GET /索引库名
</code></pre><p>示例：</p><pre><code>GET /dkx
</code></pre><p>删除索引库的语法：</p><pre><code>DELETE /索引库名
</code></pre><p>示例：</p><pre><code>DELETE /dkx
</code></pre><h4 id="984-修改索引库"><a class="anchor" href="#984-修改索引库">#</a> 9.8.4、修改索引库🌲</h4><p>事实上在 ES 中索引库是不允许修改的</p><p>因为索引库创建完了以后它的数据结构也就是 mapping 映射都已经定义好了。ES 会基于这些 mapping 去创建倒排索引，如果去修改某一个字段就会导致整体倒排索引彻底失效，这样带来的影响是非常大的。</p><p>所以在 ES 中是禁止修改索引库的！</p><p>索引库和 mapping 一旦创建无法修改，但是可以添加新的字段，语法如下：</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre>PUT /索引库名/_mapping</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>   <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>      <span class="token comment">// 这里必须是新的字段名不能和存在的重复否则它以为你要修改就报错</span></pre></td></tr><tr><td data-num="5"></td><td><pre>      <span class="token property">"新字段名"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>         <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"integer"</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>示例：</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre>PUT /dkx/_mapping</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>   <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>      <span class="token property">"age"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>         type<span class="token operator">:</span> <span class="token string">"integer"</span></pre></td></tr><tr><td data-num="6"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>案例演示图：</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310121021571.gif" alt="test"></p><blockquote><p><strong>总结</strong>：</p><p>索引库操作有哪些？</p><ul><li>创建索引库：PUT / 索引库名</li><li>查询索引库：GET / 索引库名</li><li>删除索引库： DELETE / 索引库名</li><li>添加字段：PUT / 索引库名 /_mapping</li></ul></blockquote><h4 id="985-文档操作"><a class="anchor" href="#985-文档操作">#</a> 9.8.5、文档操作🌲</h4><ul><li>新增文档</li><li>查询文档</li><li>删除文档</li><li>修改文档</li></ul><h5 id="9851-添加文档"><a class="anchor" href="#9851-添加文档">#</a> 9.8.5.1、添加文档🌴</h5><p>新增文档的 DSL 语法如下：</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre>POST /索引库名/_doc/文档id</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>   <span class="token property">"字段1"</span><span class="token operator">:</span> <span class="token string">"值1"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token property">"字段2"</span><span class="token operator">:</span> <span class="token string">"值2"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>   <span class="token property">"字段3"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>      <span class="token property">"子属性1"</span><span class="token operator">:</span> <span class="token string">"值3"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token property">"子属性2"</span><span class="token operator">:</span> <span class="token string">"值4"</span></pre></td></tr><tr><td data-num="8"></td><td><pre>   <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>   <span class="token comment">// ...</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310121028570.png" alt="image-20231012102808294"></p><h5 id="9852-查看删除文档"><a class="anchor" href="#9852-查看删除文档">#</a> 9.8.5.2、查看，删除文档🌴</h5><p>查看文档语法：</p><pre><code>GET /索引库名/_doc/文档id
</code></pre><p>示例：</p><pre><code>GET /dkx/_doc/1
</code></pre><p>删除文档的语法：</p><pre><code>DELETE /索引库名/_doc/文档id
</code></pre><p>示例：</p><pre><code>DELETE /dkx/_doc/1
</code></pre><h5 id="9853-修改文档"><a class="anchor" href="#9853-修改文档">#</a> 9.8.5.3、修改文档🌴</h5><p>方式一：全量修改，会删除旧文档，添加新文档，如果没有旧文档就是新增</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre>PUT /索引库名/_doc/文档id</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>   <span class="token property">"字段1"</span><span class="token operator">:</span> <span class="token string">"值1"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token property">"字段2"</span><span class="token operator">:</span> <span class="token string">"值2"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>   <span class="token comment">//... 略</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310121039009.png" alt="image-20231012103906432"></p><p>方式二：增量修改，修改指定字段值</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre>POST /索引库名/_update/文档id</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>   <span class="token property">"doc"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>      <span class="token property">"字段名"</span><span class="token operator">:</span> <span class="token string">"新的值"</span></pre></td></tr><tr><td data-num="5"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310121042126.png" alt="image-20231012104219010"></p><blockquote><p><strong>总结</strong>：</p><p>文档操作有哪些？</p><ul><li json文档="">创建文档：POST / 索引库名 /_cod/ 文档 id</li><li>查询文档：GET / 索引库名 /_doc/ 文档 id</li><li>删除文档：DELETE / 索引库名 /_doc/ 文档 id</li><li>修改文档：<ul><li json文档="">全量修改：PUT / 索引库名 /_doc/ 文档 id</li><li>增量修改：POST / 索引库名 /_update/ 文档 id {“doc”: {字段}}</li></ul></li></ul></blockquote><h4 id="986-restclient操作索引库"><a class="anchor" href="#986-restclient操作索引库">#</a> 9.8.6、RestClient 操作索引库🌲</h4><ul><li>创建索引库</li><li>删除索引库</li><li>判断索引库是否存在</li></ul><h5 id="9861-什么是restclient"><a class="anchor" href="#9861-什么是restclient">#</a> 9.8.6.1、什么是 RestClient🌴</h5><p>ES 官方提供了各种不同语言的客户端，用来操作 ES。这些客户端的本质就是组装 DSL 语句，通过 http 请求发送给 ES。官方文档地址：<span class="exturl" data-url="aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9ndWlkZS9lbi9lbGFzdGljc2VhcmNoL2NsaWVudC9pbmRleC5odG1s">https://www.elastic.co/guide/en/elasticsearch/client/index.html</span></p><h5 id="9862-案例利用javarestclient实现创建删除索引库判断索引库是否存在"><a class="anchor" href="#9862-案例利用javarestclient实现创建删除索引库判断索引库是否存在">#</a> 9.8.6.2、案例，利用 JavaRestClient 实现创建，删除索引库，判断索引库是否存在🌴</h5><p>根据 sql 文件数据创建索引库<a href="./Elasearch/%E6%A1%88%E4%BE%8Bsql.md"> sql 文件</a>。索引库名为 hotel，mapping 属性根据数据库结构定义。</p><p>基本步骤如下：</p><p>1、idea 中导入 hotel-demo 项目，项目地址：<span class="exturl" data-url="aHR0cHM6Ly9naXRlZS5jb20vZG91a2FpeGluL3R5cG9yYS5naXQ=">https://gitee.com/doukaixin/typora.git</span></p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310121121088.png" alt="image-20231012112156928"></p><p>2、分析数据结构，定义 mapping 属性</p><p>mapping 要考虑的问题：</p><p>字段名，数据类型，是否参与搜索，是否分词，如果分词，分词器是什么？</p><p>其中，字段名和数据类型可以基于表结构一目了然，是否参与搜索与是否分词就比较特殊了，它们与业务强相关的。比如说我们当前的酒店业务，酒店名称就一定是要参与搜索功能的它也要分词因为内容比较长，而分词器我们肯定会使用 ik_max_word 尽可能多的分词搜索范围大一些。</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310121124067.png" alt="image-20231012112427548"></p><p>根据上述分析去创建对应的索引库</p><blockquote><p>小提示：</p><p>ES 中支持两种地理坐标数据类型：</p><ul><li><p>geo_point：由纬度 (latitude) 和径度 (longitude) 确定的一个点。例如：</p><p>“32.82342343，120.3153263”</p></li><li><p>geo_shape：有多个 geo_point 组成的复杂几何图形。例如一条直线，</p><p>“LINESTRING(-77.12312312，-77.1235343 38.2323234)”</p></li></ul></blockquote><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre>PUT /dkx</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>      <span class="token property">"id"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"ik_max_word"</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token property">"address"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token property">"index"</span><span class="token operator">:</span> <span class="token boolean">false</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token property">"price"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"integer"</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      <span class="token property">"score"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"integer"</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="22"></td><td><pre>      <span class="token property">"brand"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span></pre></td></tr><tr><td data-num="24"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="25"></td><td><pre>      <span class="token property">"city"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span></pre></td></tr><tr><td data-num="27"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="28"></td><td><pre>      <span class="token property">"starName"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span></pre></td></tr><tr><td data-num="30"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="31"></td><td><pre>      <span class="token property">"business"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span></pre></td></tr><tr><td data-num="33"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="34"></td><td><pre>       # 酒店在地图上用一个点来表示所以使用geo_point，而上图的sql中酒店是两个字段一个经度一个纬度，而在ES中一个geo_point代表了经纬度，所以使用一个字段来包裹geo_point</pre></td></tr><tr><td data-num="35"></td><td><pre>      <span class="token property">"location"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"geo_point"</span></pre></td></tr><tr><td data-num="37"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="38"></td><td><pre>      <span class="token property">"pic"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token property">"index"</span><span class="token operator">:</span> <span class="token boolean">false</span></pre></td></tr><tr><td data-num="41"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>虽然定义完了酒店的所有字段了但是有一个小的问题。那我们的 name，brand，businne 等字段这些都要参与搜索，那这些将来都要参与搜索也就意味着将来用户输入关键字我可能要根据多个字段搜索，也就是查询条件不是一个值而是多个值。那根据一个字段搜效率高，还是根据多个字段搜效率高呢？显然是一个字段搜。但是需求是希望用户输入名称能搜到，输入品牌也能搜到，输入商圈也能搜到，多个搜索条件而我又想性能好该怎么办？</p><p>ES 提供了一个功能可以解决这个问题，如下小提示</p><blockquote><p><strong>小提示</strong>：</p><p>字段拷贝可以使用 copy_to 属性将当前字段拷贝到指定字段。示例：</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token property">"all"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>   <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>   <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"ik_max_word"</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>   <span class="token property">"brand"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>      <span class="token property">"copy_to"</span><span class="token operator">:</span> <span class="token string">"all"</span></pre></td></tr><tr><td data-num="9"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure></blockquote><p>完整的索引库如下：</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre>PUT /dkx</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>      <span class="token property">"id"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"ik_max_word"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token property">"copy_to"</span><span class="token operator">:</span> <span class="token string">"all"</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token property">"address"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token property">"index"</span><span class="token operator">:</span> <span class="token boolean">false</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token property">"price"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"integer"</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token property">"score"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"integer"</span></pre></td></tr><tr><td data-num="22"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="23"></td><td><pre>      <span class="token property">"brand"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token property">"copy_to"</span><span class="token operator">:</span> <span class="token string">"all"</span></pre></td></tr><tr><td data-num="26"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="27"></td><td><pre>      <span class="token property">"city"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span></pre></td></tr><tr><td data-num="29"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="30"></td><td><pre>      <span class="token property">"starName"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span></pre></td></tr><tr><td data-num="32"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="33"></td><td><pre>      <span class="token property">"business"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token property">"copy_to"</span><span class="token operator">:</span> <span class="token string">"all"</span></pre></td></tr><tr><td data-num="36"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="37"></td><td><pre>      <span class="token property">"location"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"geo_point"</span></pre></td></tr><tr><td data-num="39"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="40"></td><td><pre>      <span class="token property">"pic"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token property">"index"</span><span class="token operator">:</span> <span class="token boolean">false</span></pre></td></tr><tr><td data-num="43"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="44"></td><td><pre>      <span class="token property">"all"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"ik_max_word"</span></pre></td></tr><tr><td data-num="47"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>3、初始化 JavaRestClient</p><p>3.1、引入 es 的 RestHighLevelClient 依赖：</p><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.elasticsearch.client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>elasticsearch-rest-high-level-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token comment">&lt;!-- 在 properties 中声明了版本在这里可以不加版本 --></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><p>3.2、因为 SpringBoot 默认的 ES 版本是 7.6.2、所以我们需要覆盖默认的 ES 版本：</p><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">></span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>   <span class="token comment">&lt;!-- 使用 elasticsearch 必须在 properties 中强制声明版本号 --></span></pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token comment">&lt;!-- 统一控制 elasticsearch 版本号，是因为依赖内部的版本不统一 --></span></pre></td></tr><tr><td data-num="5"></td><td><pre>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>elasticsearch.version</span><span class="token punctuation">></span></span>7.12.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>elasticsearch.version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><p>3.3、初始化 RestHighLevelClient：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@BeforeEach</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">void</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">this</span><span class="token punctuation">.</span>client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RestHighLevelClient</span><span class="token punctuation">(</span><span class="token class-name">RestClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token class-name">HttpHost</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"http:/192.168.249.128:9200"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">/*</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    微服务集群可以写多个</pre></td></tr><tr><td data-num="8"></td><td><pre>    HttpHost.create ("http:/192.168.249.128:9200"),</pre></td></tr><tr><td data-num="9"></td><td><pre>    HttpHost.create ("http:/192.168.249.128:9200"),</pre></td></tr><tr><td data-num="10"></td><td><pre>    HttpHost.create ("http:/192.168.249.128:9200")</pre></td></tr><tr><td data-num="11"></td><td><pre>    */</pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>4、利用 JavaRestClient 创建索引库</p><p>需要注意：dkx 这个索引库已经创建过了再创建就会报错如下：</p><p>需要先将其删除后再进行测试</p><pre><code>[dkx/CGJFBdUgTFCV46PbgurYiA] ElasticsearchStatusException[Elasticsearch exception [type=resource_already_exists_exception, reason=index [dkx/CGJFBdUgTFCV46PbgurYiA] already exists]
]
</code></pre><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310121425282.png" alt="image-20231012142539675"></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Test</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">void</span> <span class="token function">createHotelIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token comment">// 1. 创建 Request 对象</span></pre></td></tr><tr><td data-num="5"></td><td><pre>   <span class="token class-name">CreateIndexRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CreateIndexRequest</span><span class="token punctuation">(</span><span class="token string">"dkx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>   <span class="token comment">// 2. 准备请求的参数：DSL 语句</span></pre></td></tr><tr><td data-num="7"></td><td><pre>   <span class="token class-name">String</span> msg<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>   <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token comment">// 通过类路径来获取 hote.json 配置文件的绝对路径</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token class-name">String</span> path <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContextClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token string">"hote.json"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token comment">// 如果获取绝对路径中含有中文可能会乱码所以需要进行编码处理</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      path <span class="token operator">=</span> <span class="token class-name">URLDecoder</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token comment">// 通过字符输入流来读取指定位置的 json 文件内容</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token class-name">FileReader</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      msg <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>         <span class="token comment">// 将读取到的内容拼接到一个字符串中</span></pre></td></tr><tr><td data-num="20"></td><td><pre>         msg <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span>i<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>      <span class="token comment">//msg 是读取的 json 文件里面是创建索引库的 DSL 语句</span></pre></td></tr><tr><td data-num="23"></td><td><pre>      request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span><span class="token constant">JSON</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>   <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>   <span class="token comment">// 3. 发送请求</span></pre></td></tr><tr><td data-num="28"></td><td><pre>   <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>      client<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>   <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>hote.json</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>      <span class="token property">"id"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span></pre></td></tr><tr><td data-num="6"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"ik_max_word"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token property">"copy_to"</span><span class="token operator">:</span> <span class="token string">"all"</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token property">"address"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token property">"index"</span><span class="token operator">:</span> <span class="token boolean">false</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token property">"price"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"integer"</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      <span class="token property">"score"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"integer"</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="22"></td><td><pre>      <span class="token property">"brand"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token property">"copy_to"</span><span class="token operator">:</span> <span class="token string">"all"</span></pre></td></tr><tr><td data-num="25"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="26"></td><td><pre>      <span class="token property">"city"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span></pre></td></tr><tr><td data-num="28"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="29"></td><td><pre>      <span class="token property">"starName"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span></pre></td></tr><tr><td data-num="31"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="32"></td><td><pre>      <span class="token property">"business"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token property">"copy_to"</span><span class="token operator">:</span> <span class="token string">"all"</span></pre></td></tr><tr><td data-num="35"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="36"></td><td><pre>      <span class="token property">"location"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"geo_point"</span></pre></td></tr><tr><td data-num="38"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="39"></td><td><pre>      <span class="token property">"pic"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token property">"index"</span><span class="token operator">:</span> <span class="token boolean">false</span></pre></td></tr><tr><td data-num="42"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="43"></td><td><pre>      <span class="token property">"all"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"ik_max_word"</span></pre></td></tr><tr><td data-num="46"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在 kibana 中执行 GET 请求，请求 /dkx 索引库查看是否存在</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310121533685.png" alt="image-20231012153324541"></p><p>5、利用 JavaRestClient 删除索引库</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Test</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteHoteIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token comment">// 1. 创建 Request 对象</span></pre></td></tr><tr><td data-num="5"></td><td><pre>   <span class="token class-name">DeleteIndexRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DeleteIndexRequest</span><span class="token punctuation">(</span><span class="token string">"dkx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>   <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token comment">// 2. 发送请求</span></pre></td></tr><tr><td data-num="8"></td><td><pre>      client<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>   <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>6、利用 JavaRestClient 判断索引库是否存在</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Test</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exitHoteIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token comment">// 1. 创建 Request 请求</span></pre></td></tr><tr><td data-num="5"></td><td><pre>   <span class="token class-name">GetIndexRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetIndexRequest</span><span class="token punctuation">(</span><span class="token string">"dkx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>   <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token comment">// 2. 发送请求</span></pre></td></tr><tr><td data-num="8"></td><td><pre>      <span class="token keyword">boolean</span> exists <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>exists <span class="token operator">?</span> <span class="token string">"存在"</span> <span class="token operator">:</span> <span class="token string">"不存在"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>   <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p><strong>总结</strong>:</p><p>索引库操作的基本步骤：</p><ul><li>初始化 RestHighLevelClient</li><li>创建 XxxIndexRequest。Xxx 是 CREATE，Get，Delete</li><li>准备 DSL (CREATE 时需要)</li><li>发送请求。调用 RestHighLevelClient#indices ().xxx () 方法，xxx 是 create，exists，delete</li></ul></blockquote><h4 id="987-restclient操作文档"><a class="anchor" href="#987-restclient操作文档">#</a> 9.8.7、RestClient 操作文档🌲</h4><ul><li>新增文档</li><li>查询文档</li><li>删除文档</li><li>修改文档</li><li>批量导入文档</li></ul><h5 id="9871-案例利用javarestclient实现文档的crud"><a class="anchor" href="#9871-案例利用javarestclient实现文档的crud">#</a> 9.8.7.1、案例，利用 JavaRestClient 实现文档的 CRUD🌴</h5><p>去数据库查询酒店数据，导入到 dkx 索引库，实现酒店数据的 CRUD</p><p><strong>基本步骤如下</strong>：</p><p>1、初始化 JavaRestClient</p><p>新建一个测试类，实现文档相关操作，并且完成 JavaRestClient 的初始化</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@SpringBootTest</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HoteIndexTest1</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">RestHighLevelClient</span> client<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>   </pre></td></tr><tr><td data-num="5"></td><td><pre> 	 <span class="token annotation punctuation">@BeforeEach</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">void</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RestHighLevelClient</span><span class="token punctuation">(</span><span class="token class-name">RestClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="9"></td><td><pre>                <span class="token class-name">HttpHost</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"http://192.168.249.128:9200"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token annotation punctuation">@AfterEach</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">void</span> <span class="token function">tearDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>2、利用 JavaRestClient 新增酒店数据</p><p>先通过 mysql 查询酒店数据，然后给这条数据创建倒排索引，即可完成添加：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">private</span> <span class="token class-name">IHotelService</span> iHotelService<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token annotation punctuation">@Test</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testAddDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>   <span class="token comment">// 根据 id 查询酒店数据</span></pre></td></tr><tr><td data-num="8"></td><td><pre>   <span class="token class-name">Hotel</span> byId <span class="token operator">=</span> iHotelService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span><span class="token number">36934L</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>   <span class="token comment">// 转换为文档类型</span></pre></td></tr><tr><td data-num="10"></td><td><pre>   <span class="token class-name">HotelDoc</span> hotelDoc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">(</span>byId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>   <span class="token comment">// 1. 准备 Request 对象</span></pre></td></tr><tr><td data-num="12"></td><td><pre>   <span class="token class-name">IndexRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexRequest</span><span class="token punctuation">(</span><span class="token string">"dkx"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>hotelDoc<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>   <span class="token comment">// 2. 准备 JSON 文档</span></pre></td></tr><tr><td data-num="14"></td><td><pre>   request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>hotelDoc<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span><span class="token constant">JSON</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>   <span class="token comment">// 3. 发送请求</span></pre></td></tr><tr><td data-num="16"></td><td><pre>   <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      client<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>   <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310121557188.png" alt="image-20231012155720876"></p><p>到 kibana 中通过命令：GET /dkx/_doc/36934 查看是否成功添加了</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310121638859.png" alt="image-20231012163857506"></p><p>3、利用 JavaRestClient 根据 id 查询酒店数据</p><p>根据 id 查询到的文档数据是 json，需要反序列化为 java 对象：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Test</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testGetDocumentById</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token comment">// 1. 准备 Request</span></pre></td></tr><tr><td data-num="5"></td><td><pre>   <span class="token class-name">GetRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetRequest</span><span class="token punctuation">(</span><span class="token string">"dkx"</span><span class="token punctuation">,</span> <span class="token string">"36934"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>   <span class="token comment">// 2. 发送请求，得到响应</span></pre></td></tr><tr><td data-num="7"></td><td><pre>   <span class="token class-name">GetResponse</span> documentFields<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>   <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      documentFields <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>   <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>   <span class="token comment">// 3. 解析响应结果</span></pre></td></tr><tr><td data-num="14"></td><td><pre>   <span class="token class-name">String</span> json <span class="token operator">=</span> documentFields<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>   <span class="token comment">// 通过 JSON.parseObject 将 json 数据解析为指定的对象</span></pre></td></tr><tr><td data-num="16"></td><td><pre>   <span class="token class-name">HotelDoc</span> hotelDoc <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>   <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hotelDoc<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment">//--------------------- 打印结果 ---------------------</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token class-name">HotelDoc</span><span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">36934</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token number">7</span>天连锁酒店<span class="token punctuation">(</span>上海宝山路地铁站店<span class="token punctuation">)</span><span class="token punctuation">,</span> address<span class="token operator">=</span>静安交通路<span class="token number">40</span>号<span class="token punctuation">,</span> price<span class="token operator">=</span><span class="token number">336</span><span class="token punctuation">,</span> score<span class="token operator">=</span><span class="token number">37</span><span class="token punctuation">,</span> brand<span class="token operator">=</span><span class="token number">7</span>天酒店<span class="token punctuation">,</span> city<span class="token operator">=</span>上海<span class="token punctuation">,</span> starName<span class="token operator">=</span>二钻<span class="token punctuation">,</span> business<span class="token operator">=</span>四川北路商业区<span class="token punctuation">,</span> location<span class="token operator">=</span><span class="token number">31.251433</span><span class="token punctuation">,</span> <span class="token number">121.47522</span><span class="token punctuation">,</span> pic<span class="token operator">=</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>m<span class="token punctuation">.</span>tuniucdn<span class="token punctuation">.</span>com<span class="token operator">/</span>fb2<span class="token operator">/</span>t1<span class="token operator">/</span><span class="token constant">G1</span><span class="token operator">/</span><span class="token constant">M00</span><span class="token operator">/</span><span class="token number">3</span>E<span class="token operator">/</span><span class="token number">40</span><span class="token operator">/</span><span class="token class-name">Cii9EVkyLrKIXo1vAAHgrxo_pUcAALcKQLD688AAeDH564_w200_h200_c1_t0</span><span class="token punctuation">.</span>jpg<span class="token punctuation">)</span></pre></td></tr></table></figure><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310121629666.png" alt="image-20231012162936320"></p><p>4、利用 JavaRestClient 删除酒店数据</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Test</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testDeleteDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token comment">// 1. 准备 Request</span></pre></td></tr><tr><td data-num="5"></td><td><pre>   <span class="token class-name">DeleteRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DeleteRequest</span><span class="token punctuation">(</span><span class="token string">"dkx"</span><span class="token punctuation">,</span> <span class="token string">"36934"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>   <span class="token comment">// 2. 发送请求</span></pre></td></tr><tr><td data-num="7"></td><td><pre>   <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>      client<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>   <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310121659241.png" alt="image-20231012165946036"></p><p>如果删除后再去通过 java 代码去查询返回结果就是 null</p><p>5、利用 JavaRestClient 修改酒店数据</p><p>修改文档数据有两种方式：</p><p>方式一：全量更新。再次写入 id 一样的文档，就会删除旧文档，添加新文档，它的 java 代码和添加没有区别</p><p>方式二：局部更新。只更新部分字段，我们演示方式二</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Test</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testUpdateDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token comment">// 1. 准备 Request</span></pre></td></tr><tr><td data-num="5"></td><td><pre>   <span class="token class-name">UpdateRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UpdateRequest</span><span class="token punctuation">(</span><span class="token string">"dkx"</span><span class="token punctuation">,</span> <span class="token string">"36934"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>   <span class="token comment">// 2. 准备请求参数</span></pre></td></tr><tr><td data-num="7"></td><td><pre>   request<span class="token punctuation">.</span><span class="token function">doc</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="8"></td><td><pre>      <span class="token comment">// 使用 逗号隔开 两个一对</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token string">"price"</span><span class="token punctuation">,</span> <span class="token string">"952"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token string">"starName"</span><span class="token punctuation">,</span> <span class="token string">"五钻"</span></pre></td></tr><tr><td data-num="11"></td><td><pre>   <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>   <span class="token comment">// 3. 发送请求</span></pre></td></tr><tr><td data-num="13"></td><td><pre>   <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      client<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>   <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310121643267.png" alt="image-20231012164318114"></p><p>修改前通过 id 获取数据</p><pre><code>HotelDoc(id=36934, name=7天连锁酒店(上海宝山路地铁站店), address=静安交通路40号, price=336, score=37, brand=7天酒店, city=上海, starName=二钻, business=四川北路商业区, location=31.251433, 121.47522, pic=https://m.tuniucdn.com/fb2/t1/G1/M00/3E/40/Cii9EVkyLrKIXo1vAAHgrxo_pUcAALcKQLD688AAeDH564_w200_h200_c1_t0.jpg)
</code></pre><p>修改后通过 id 获取数据</p><pre><code>HotelDoc(id=36934, name=7天连锁酒店(上海宝山路地铁站店), address=静安交通路40号, price=952, score=37, brand=7天酒店, city=上海, starName=五钻, business=四川北路商业区, location=31.251433, 121.47522, pic=https://m.tuniucdn.com/fb2/t1/G1/M00/3E/40/Cii9EVkyLrKIXo1vAAHgrxo_pUcAALcKQLD688AAeDH564_w200_h200_c1_t0.jpg)
</code></pre><blockquote><p><strong>总结</strong>：</p><p>文档操作的基本步骤：</p><ul><li>初始化 RestHighLevelClient</li><li>创建 XxxRequest。XXX 是 Index，Get，Update，Delete</li><li>准备参数 (Index 和 Update 时需要)</li><li>发送请求。调用 RestHighLevelClient#.xxx () 方法，xxx 是 Index，Get，Update，Delete</li><li>解析结果 (Get 时需要)</li></ul></blockquote><h4 id="988-案例利用javarestclient批量导入酒店数据到es"><a class="anchor" href="#988-案例利用javarestclient批量导入酒店数据到es">#</a> 9.8.8、案例，利用 JavaRestClient 批量导入酒店数据到 ES🌲</h4><p>需求：批量查询酒店数据，然后批量导入索引库中</p><p>思路：</p><p>1、利用 mybatis-plus 查询酒店数据</p><p>2、将查询到的酒店数据 (Hotel) 转换为 文档类型数据 (HotelDoc)</p><p>3、利用 JavaRestClient 中的 Bulk 批处理，实现批量新增文档，示例代码如下</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@SpringBootTest</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HoteIndexTest1</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">RestHighLevelClient</span> client<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">IHotelService</span> iHotelService<span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="7"></td><td><pre>	 <span class="token annotation punctuation">@Test</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testBulkRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token comment">// 批量查询酒店数据</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Hotel</span><span class="token punctuation">></span></span> hotels <span class="token operator">=</span> iHotelService<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token comment">// 1. 创建 Request</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token class-name">BulkRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BulkRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token comment">// 2. 准备参数，添加多个新增的 Request</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token comment">// 2.1 对查询出的酒店数据进行遍历</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Hotel</span> hotel<span class="token operator">:</span> hotels<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token comment">// 转换为文档类型 HotelDoc</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token class-name">HotelDoc</span> hotelDoc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">(</span>hotel<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            <span class="token comment">// 创建新增文档的 Request 对象</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            request<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IndexRequest</span><span class="token punctuation">(</span><span class="token string">"dkx"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre>                    <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>hotel<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre>                    <span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>hotelDoc<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span><span class="token constant">JSON</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token comment">// 3. 发送请求</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            client<span class="token punctuation">.</span><span class="token function">bulk</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token punctuation">&#125;</span>   </pre></td></tr><tr><td data-num="32"></td><td><pre>	<span class="token annotation punctuation">@BeforeEach</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token keyword">void</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RestHighLevelClient</span><span class="token punctuation">(</span><span class="token class-name">RestClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="36"></td><td><pre>                <span class="token class-name">HttpHost</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"http://192.168.249.128:9200"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token annotation punctuation">@AfterEach</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token keyword">void</span> <span class="token function">tearDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>            <span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>到 kibana 页面通过命令：GET /dkx/_search 查看结果</p><p>可以看到查询出了 201 条数据</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310121723744.png" alt="image-20231012172343307"></p><h3 id="99-dsl查询文档"><a class="anchor" href="#99-dsl查询文档">#</a> 9.9、DSL 查询文档🌳</h3><ul><li>DSL 查询分类</li><li>全文检索查询</li><li>精准查询</li><li>地理坐标查询</li><li>组合查询</li></ul><h4 id="991-dsl-query的分类"><a class="anchor" href="#991-dsl-query的分类">#</a> 9.9.1、DSL Query 的分类🌲</h4><p>Elasticsearch 提供了基于 JSON 的 DSL (Domain Specific Language) 来定义查询。常见的查询类型包括：</p><ul><li>查询所有：查询出所有数据，一般测试用。例如：match_all</li><li>全文检索 (full text) 查询：利用分词器对用户输入内容分词，然后去倒排索引库中匹配。例如：<ul><li>match_query</li><li>multi_match_query</li></ul></li><li>精确查询：根据精确词条值查找数据，一般是查找 keyword，数值，日期，boolean 等类型字段。例如：<ul><li>ids</li><li>range</li><li>term</li></ul></li><li>地理 (geo) 查询：根据经纬度查询。例如：<ul><li>geo_distance</li><li>geo_bounding_box</li></ul></li><li>复合 (compound) 查询：复合查询可以将上述各种查询条件组合起来，合并查询条件。例如：<ul><li>bool</li><li>function_score</li></ul></li></ul><h5 id="9911-dsl-query基本语法"><a class="anchor" href="#9911-dsl-query基本语法">#</a> 9.9.1.1、DSL Query 基本语法🌴</h5><p>查询的基本语法如下：</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre>GET /indexName/_search</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>   <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>      <span class="token property">"查询类型"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>         <span class="token property">"查询条件"</span><span class="token operator">:</span> <span class="token string">"条件值"</span></pre></td></tr><tr><td data-num="6"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310121738538.png" alt="image-20231012173803886"></p><blockquote><p>总结：</p><p>查询 DSL 的基本语法是什么？</p><ul><li>GET / 索引库名 /_search</li><li>{“query”: {“查询类型”:{“FIELD”:”TEXT”}}}</li></ul></blockquote><h4 id="992-全文检索查询"><a class="anchor" href="#992-全文检索查询">#</a> 9.9.2、全文检索查询🌲</h4><p>match 查询：全文检索查询的一种，会对用户输入内容分词，然后去倒排索引检索，语法：</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre>GET /indexName/_search</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>   <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>      <span class="token property">"match"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>         <span class="token property">"FIELD"</span><span class="token operator">:</span> <span class="token string">"TEXT"</span></pre></td></tr><tr><td data-num="6"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310121802836.png" alt="image-20231012180230588"></p><p>multi_match：与 match 查询类似，只不过允许同时查询多个字段，语法：</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre>GET /indexName/_search</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>   <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>      <span class="token property">"multi_match"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>         <span class="token property">"query"</span><span class="token operator">:</span> <span class="token string">"TEXT"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>         <span class="token property">"fields"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"FIELD1"</span><span class="token punctuation">,</span> <span class="token string">"FIELD12"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310121933446.png" alt="image-20231012193303357"></p><blockquote><p><strong>总结</strong>：</p><p>match 和 muliti_match 的区别是什么？</p><ul><li>match：根据一个字段查询</li><li>multi_match：根据多个字段查询，参与查询字段越多，查询性能越差</li></ul></blockquote><h4 id="993-精确查询"><a class="anchor" href="#993-精确查询">#</a> 9.9.3、精确查询🌲</h4><p>精确查询一般是查找 keyword，数值，日期，boolean 等类型字段。所以<mark>不会</mark>对搜索条件分词。常见的有：</p><ul><li>term：根据词条精确值查询</li><li>range：根据值的范围查询</li></ul><h5 id="9931-精确查询-语法"><a class="anchor" href="#9931-精确查询-语法">#</a> 9.9.3.1、精确查询 - 语法🌴</h5><p>精确查询一般是根据 id，数值，keyword 类型，或布尔字段来查询。语法如下：</p><p>term 查询：</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//term 查询</span></pre></td></tr><tr><td data-num="2"></td><td><pre>GET /indexName/_search</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>      <span class="token property">"term"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>         <span class="token property">"FIELD"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"VLAUE"</span></pre></td></tr><tr><td data-num="8"></td><td><pre>         <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310121959434.png" alt="image-20231012195904980"></p><p>range 查询：</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//range 查询</span></pre></td></tr><tr><td data-num="2"></td><td><pre>GET /indexName/_search</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>      <span class="token property">"range"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>         <span class="token property">"FIELD"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>           <span class="token property">"gte"</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>           <span class="token property">"lte"</span><span class="token operator">:</span> <span class="token number">20</span></pre></td></tr><tr><td data-num="9"></td><td><pre>         <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310122000353.png" alt="image-20231012200031386"></p><blockquote><p><strong>总结</strong>：</p><p>精确查询常见的有哪些？</p><ul><li>term 查询：根据词条精确匹配，一般搜索 keyword 类型，数值类型，布尔类型，日期类型字段</li><li>range 查询：根据数值范围查询，可以是数值，日期的范围</li></ul></blockquote><h4 id="994-地理查询"><a class="anchor" href="#994-地理查询">#</a> 9.9.4、地理查询🌲</h4><p>根据经纬度查询。常见的使用场景包括：</p><ul><li>携程：搜索我附近的酒店</li><li>滴滴：搜索我附近的出租车</li><li>微信：搜索我附近的人</li></ul><p>根据经纬度查询，例如：</p><ul><li>geo_bounding_box：查询 geo_point 值落在某个矩形范围的所有文档</li></ul><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//geo_bounding_box 查询</span></pre></td></tr><tr><td data-num="2"></td><td><pre>GET /indexName/_search</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>      <span class="token property">"geo_bounding_box"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>         <span class="token property">"FIELD"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            <span class="token property">"top_left"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>               <span class="token property">"lat"</span><span class="token operator">:</span> <span class="token number">31.1</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>           		<span class="token property">"lon"</span><span class="token operator">:</span> <span class="token number">121.5</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token property">"bottom_right"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>               <span class="token property">"lat"</span><span class="token operator">:</span> <span class="token number">30.9</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>               <span class="token property">"lon"</span><span class="token operator">:</span> <span class="token number">121.7</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>         <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在搜索的时候根据 “top_left” 和 “bottom_right” 两个点分别画一个横线和竖线 的 经纬度进行相交形成的一个矩形范围</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310122020535.png" alt="image-20231012202007403"></p><p>根据经纬度查询，例如：</p><ul><li>geo_distance：查询到指定中心点小于某个距离值的所有文档</li></ul><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//geo_distance 查询</span></pre></td></tr><tr><td data-num="2"></td><td><pre>GET /indexName/_search</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>      <span class="token property">"geo_distance"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>         <span class="token property">"distance"</span><span class="token operator">:</span> <span class="token string">"15km"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>         <span class="token property">"FIELD"</span><span class="token operator">:</span> <span class="token string">"31.21,121.5"</span></pre></td></tr><tr><td data-num="8"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310131024931.png" alt="image-20231013102411621"></p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310122027316.png" alt="image-20231012202733050"></p><h4 id="995-复合查询"><a class="anchor" href="#995-复合查询">#</a> 9.9.5、复合查询🌲</h4><p>复合 (compound) 查询：复合查询可以将其它简单查询组合起来，实现更复杂的搜索逻辑，例如：</p><ul><li>fuction score：算分函数查询，可以控制文档相关性算分，控制文档排名。例如百度竞价</li></ul><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310130800939.png" alt="image-20231013080014517"></p><p>例如，我们搜索 “虹桥如家” ，结果如下：</p><p>这个词在第一条文档中出现了一次，而这个文档中词条的总数是：5</p><p>所以词条频率就是 1 / 5 = 0.2 分。词条出现的频率越多得分越高</p><p>证明你跟这个词相关性也越高</p><p>但是有个问题：</p><p>如家这个词在这几篇文档中都有出现，那再去吧这个 “如家” 进行累加还有意义吗？。没有意义</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310130801156.png" alt="image-20231013080054602"></p><p>所以我们就引入一个新的算法：TFIDF 算法</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310130807792.png" alt="image-20231013080723131"></p><p>我们以如家为例，那么包含如家的文档有三个，而文档总数也是三那 3 /3 = 1 那 Log/1 = 0 。那代表如家这个权重就是 0 。那相反虹桥这个词支出现在一个文档中，所以分母就是 1 ，而文档总数是 3 所以结果就是 3</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310130812773.png" alt="image-20231013081248428"></p><p>这个算法也是去做累加只不过它在做 tf 和 idf 的时候算法上面会更加复杂一点，为什么要演变一种新的算法呢？</p><p>是因为这种算法它不会受词频影响较大</p><p>在传统的 tf 算法中词频越高，将来得分会无限增加。会越来越高，但是 BM25 算法呢，最终的分会趋于一个水平，也就是它不会无限增长。所以相对来讲这种算法会更好一点得分会更平和一点。因此在 ES 高版本中都会采用默认都会采用 BM25 算法</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310130817842.png" alt="image-20231013081755494"></p><blockquote><p><strong>总结</strong>：</p><p>elasticsearch 中的相关性打分算法是什么？</p><ul><li>TF-IDF：在 elasticsearch5.0 之前，会随着词频增加而越来越大</li><li>BM25：在 elasticsearch5.0 之后，会随着词频增加而增大，但增长曲线会趋于水平</li></ul></blockquote><h5 id="9961-function-score-query"><a class="anchor" href="#9961-function-score-query">#</a> 9.9.6.1、Function Score Query🌴</h5><p>使用 fucntion score query ，可以修改文档的相关性算分 (query score) ，根据新得到的算分排序。</p><blockquote><p>我们知道 ES 在搜索文档的时候会对文档做相关性的一个打分，文档与搜索关键字的相关度越高那么打分就自然就越高。排名也会越靠前。不过有些时候我们希望人为的去控制文档的排名，比如说有部分文档人家掏钱了我就让它排名靠前一点，算分高一点那么这个时候就要用到 Function Score Query 了。这个查询可以在原始的相关性算法的基础上加以修改得到一个想要的算分从而去影响文档的排名</p></blockquote><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310130933092.png" alt="image-20231013093343922"></p><h6 id="99611-案例给-如家-这个品牌的酒店排名靠前一些"><a class="anchor" href="#99611-案例给-如家-这个品牌的酒店排名靠前一些">#</a> 9.9.6.1.1、案例，给 “如家” 这个品牌的酒店排名靠前一些🎋</h6><p>把这个问题翻译一下，function score 需要的三要素：</p><p>1、哪些文档需要算分加权？</p><ul><li>品牌为如家的酒店</li></ul><p>2、算分函数是什么？</p><ul><li>weight 就可以</li></ul><p>3、加权模式是什么？</p><ul><li>求和</li></ul><p>先正常的进行查询查看结果</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre>GET /dkx/_search</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token property">"function_score"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>      <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token property">"match"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>          <span class="token property">"all"</span><span class="token operator">:</span> <span class="token string">"外滩"</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>结果</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token property">"took"</span> <span class="token operator">:</span> <span class="token number">61</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token property">"timed_out"</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token property">"_shards"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token property">"total"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token property">"successful"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token property">"skipped"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token property">"failed"</span> <span class="token operator">:</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token property">"hits"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token property">"total"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token property">"value"</span> <span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token property">"relation"</span> <span class="token operator">:</span> <span class="token string">"eq"</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token property">"max_score"</span> <span class="token operator">:</span> <span class="token number">6.024319</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token property">"hits"</span> <span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token property">"_index"</span> <span class="token operator">:</span> <span class="token string">"dkx"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token property">"_type"</span> <span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token property">"_id"</span> <span class="token operator">:</span> <span class="token string">"60487"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token property">"_score"</span> <span class="token operator">:</span> <span class="token number">6.024319</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token property">"_source"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>          <span class="token property">"address"</span> <span class="token operator">:</span> <span class="token string">"黄浦路199号"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="24"></td><td><pre>          <span class="token property">"brand"</span> <span class="token operator">:</span> <span class="token string">"君悦"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="25"></td><td><pre>          <span class="token property">"business"</span> <span class="token operator">:</span> <span class="token string">"外滩地区"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="26"></td><td><pre>          <span class="token property">"city"</span> <span class="token operator">:</span> <span class="token string">"上海"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="27"></td><td><pre>          <span class="token property">"id"</span> <span class="token operator">:</span> <span class="token number">60487</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="28"></td><td><pre>          <span class="token property">"latitude"</span> <span class="token operator">:</span> <span class="token string">"31.245409"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="29"></td><td><pre>          <span class="token property">"longitude"</span> <span class="token operator">:</span> <span class="token string">"121.492969"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="30"></td><td><pre>          <span class="token property">"name"</span> <span class="token operator">:</span> <span class="token string">"上海外滩茂悦大酒店"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="31"></td><td><pre>          <span class="token property">"pic"</span> <span class="token operator">:</span> <span class="token string">"https://m.tuniucdn.com/fb3/s1/2n9c/2Swp2h1fdj9zCUKsk63BQvVgKLTo_w200_h200_c1_t0.jpg"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="32"></td><td><pre>          <span class="token property">"price"</span> <span class="token operator">:</span> <span class="token number">689</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="33"></td><td><pre>          <span class="token property">"score"</span> <span class="token operator">:</span> <span class="token number">44</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="34"></td><td><pre>          <span class="token property">"starName"</span> <span class="token operator">:</span> <span class="token string">"五星级"</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="37"></td><td><pre>      <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token property">"_index"</span> <span class="token operator">:</span> <span class="token string">"dkx"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token property">"_type"</span> <span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token property">"_id"</span> <span class="token operator">:</span> <span class="token string">"432335"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token property">"_score"</span> <span class="token operator">:</span> <span class="token number">4.849986</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token property">"_source"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>          <span class="token property">"address"</span> <span class="token operator">:</span> <span class="token string">"唐山路145号"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="44"></td><td><pre>          <span class="token property">"brand"</span> <span class="token operator">:</span> <span class="token string">"7天酒店"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="45"></td><td><pre>          <span class="token property">"business"</span> <span class="token operator">:</span> <span class="token string">"北外滩地区"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="46"></td><td><pre>          <span class="token property">"city"</span> <span class="token operator">:</span> <span class="token string">"上海"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="47"></td><td><pre>          <span class="token property">"id"</span> <span class="token operator">:</span> <span class="token number">432335</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="48"></td><td><pre>          <span class="token property">"latitude"</span> <span class="token operator">:</span> <span class="token string">"31.252585"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="49"></td><td><pre>          <span class="token property">"longitude"</span> <span class="token operator">:</span> <span class="token string">"121.498753"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="50"></td><td><pre>          <span class="token property">"name"</span> <span class="token operator">:</span> <span class="token string">"7天连锁酒店(上海北外滩国际客运中心地铁站店)"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="51"></td><td><pre>          <span class="token property">"pic"</span> <span class="token operator">:</span> <span class="token string">"https://m2.tuniucdn.com/filebroker/cdn/res/c1/ba/c1baf64418437c56617f89840c6411ef_w200_h200_c1_t0.jpg"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="52"></td><td><pre>          <span class="token property">"price"</span> <span class="token operator">:</span> <span class="token number">249</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="53"></td><td><pre>          <span class="token property">"score"</span> <span class="token operator">:</span> <span class="token number">35</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="54"></td><td><pre>          <span class="token property">"starName"</span> <span class="token operator">:</span> <span class="token string">"二钻"</span></pre></td></tr><tr><td data-num="55"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="57"></td><td><pre>      <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>        <span class="token property">"_index"</span> <span class="token operator">:</span> <span class="token string">"dkx"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="59"></td><td><pre>        <span class="token property">"_type"</span> <span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="60"></td><td><pre>        <span class="token property">"_id"</span> <span class="token operator">:</span> <span class="token string">"434082"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="61"></td><td><pre>        <span class="token property">"_score"</span> <span class="token operator">:</span> <span class="token number">3.8909411</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="62"></td><td><pre>        <span class="token property">"_source"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>          <span class="token property">"address"</span> <span class="token operator">:</span> <span class="token string">"复兴东路260号"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="64"></td><td><pre>          <span class="token property">"brand"</span> <span class="token operator">:</span> <span class="token string">"如家"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="65"></td><td><pre>          <span class="token property">"business"</span> <span class="token operator">:</span> <span class="token string">"豫园地区"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="66"></td><td><pre>          <span class="token property">"city"</span> <span class="token operator">:</span> <span class="token string">"上海"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="67"></td><td><pre>          <span class="token property">"id"</span> <span class="token operator">:</span> <span class="token number">434082</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="68"></td><td><pre>          <span class="token property">"latitude"</span> <span class="token operator">:</span> <span class="token string">"31.220706"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="69"></td><td><pre>          <span class="token property">"longitude"</span> <span class="token operator">:</span> <span class="token string">"121.498769"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="70"></td><td><pre>          <span class="token property">"name"</span> <span class="token operator">:</span> <span class="token string">"如家酒店·neo(上海外滩城隍庙小南门地铁站店)"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="71"></td><td><pre>          <span class="token property">"pic"</span> <span class="token operator">:</span> <span class="token string">"https://m.tuniucdn.com/fb2/t1/G6/M00/52/B6/Cii-U13eXLGIdHFzAAIG-5cEwDEAAGRfQNNIV0AAgcT627_w200_h200_c1_t0.jpg"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="72"></td><td><pre>          <span class="token property">"price"</span> <span class="token operator">:</span> <span class="token number">392</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="73"></td><td><pre>          <span class="token property">"score"</span> <span class="token operator">:</span> <span class="token number">44</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="74"></td><td><pre>          <span class="token property">"starName"</span> <span class="token operator">:</span> <span class="token string">"二钻"</span></pre></td></tr><tr><td data-num="75"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>    <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="78"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="79"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>可以看到 “如家酒店” 排在最后一个我们通过下面的代码让其排名为第一</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre>GET /dkx/_search</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token property">"function_score"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>      <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token property">"match"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>          <span class="token property">"all"</span><span class="token operator">:</span> <span class="token string">"外滩"</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token property">"functions"</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token comment">// 算分函数</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>          <span class="token property">"filter"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 满足的条件，品牌必须是如家</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token property">"term"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>              <span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"如家"</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>          <span class="token property">"weight"</span><span class="token operator">:</span> <span class="token number">10</span> <span class="token comment">// 算分权重为 10</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      <span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token property">"boost_mode"</span><span class="token operator">:</span> <span class="token string">"sum"</span> <span class="token comment">// 算分模式使用 fucntion_score 与 query_score 相除的方式算分</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>结果：</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token property">"took"</span> <span class="token operator">:</span> <span class="token number">72</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token property">"timed_out"</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token property">"_shards"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token property">"total"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token property">"successful"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token property">"skipped"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token property">"failed"</span> <span class="token operator">:</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token property">"hits"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token property">"total"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token property">"value"</span> <span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token property">"relation"</span> <span class="token operator">:</span> <span class="token string">"eq"</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token property">"max_score"</span> <span class="token operator">:</span> <span class="token number">13.890942</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token property">"hits"</span> <span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token property">"_index"</span> <span class="token operator">:</span> <span class="token string">"dkx"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token property">"_type"</span> <span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token property">"_id"</span> <span class="token operator">:</span> <span class="token string">"434082"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token property">"_score"</span> <span class="token operator">:</span> <span class="token number">13.890942</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token property">"_source"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>          <span class="token property">"address"</span> <span class="token operator">:</span> <span class="token string">"复兴东路260号"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="24"></td><td><pre>          <span class="token property">"brand"</span> <span class="token operator">:</span> <span class="token string">"如家"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="25"></td><td><pre>          <span class="token property">"business"</span> <span class="token operator">:</span> <span class="token string">"豫园地区"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="26"></td><td><pre>          <span class="token property">"city"</span> <span class="token operator">:</span> <span class="token string">"上海"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="27"></td><td><pre>          <span class="token property">"id"</span> <span class="token operator">:</span> <span class="token number">434082</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="28"></td><td><pre>          <span class="token property">"latitude"</span> <span class="token operator">:</span> <span class="token string">"31.220706"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="29"></td><td><pre>          <span class="token property">"longitude"</span> <span class="token operator">:</span> <span class="token string">"121.498769"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="30"></td><td><pre>          <span class="token property">"name"</span> <span class="token operator">:</span> <span class="token string">"如家酒店·neo(上海外滩城隍庙小南门地铁站店)"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="31"></td><td><pre>          <span class="token property">"pic"</span> <span class="token operator">:</span> <span class="token string">"https://m.tuniucdn.com/fb2/t1/G6/M00/52/B6/Cii-U13eXLGIdHFzAAIG-5cEwDEAAGRfQNNIV0AAgcT627_w200_h200_c1_t0.jpg"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="32"></td><td><pre>          <span class="token property">"price"</span> <span class="token operator">:</span> <span class="token number">392</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="33"></td><td><pre>          <span class="token property">"score"</span> <span class="token operator">:</span> <span class="token number">44</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="34"></td><td><pre>          <span class="token property">"starName"</span> <span class="token operator">:</span> <span class="token string">"二钻"</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="37"></td><td><pre>      <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token property">"_index"</span> <span class="token operator">:</span> <span class="token string">"dkx"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token property">"_type"</span> <span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token property">"_id"</span> <span class="token operator">:</span> <span class="token string">"60487"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token property">"_score"</span> <span class="token operator">:</span> <span class="token number">7.024319</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token property">"_source"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>          <span class="token property">"address"</span> <span class="token operator">:</span> <span class="token string">"黄浦路199号"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="44"></td><td><pre>          <span class="token property">"brand"</span> <span class="token operator">:</span> <span class="token string">"君悦"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="45"></td><td><pre>          <span class="token property">"business"</span> <span class="token operator">:</span> <span class="token string">"外滩地区"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="46"></td><td><pre>          <span class="token property">"city"</span> <span class="token operator">:</span> <span class="token string">"上海"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="47"></td><td><pre>          <span class="token property">"id"</span> <span class="token operator">:</span> <span class="token number">60487</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="48"></td><td><pre>          <span class="token property">"latitude"</span> <span class="token operator">:</span> <span class="token string">"31.245409"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="49"></td><td><pre>          <span class="token property">"longitude"</span> <span class="token operator">:</span> <span class="token string">"121.492969"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="50"></td><td><pre>          <span class="token property">"name"</span> <span class="token operator">:</span> <span class="token string">"上海外滩茂悦大酒店"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="51"></td><td><pre>          <span class="token property">"pic"</span> <span class="token operator">:</span> <span class="token string">"https://m.tuniucdn.com/fb3/s1/2n9c/2Swp2h1fdj9zCUKsk63BQvVgKLTo_w200_h200_c1_t0.jpg"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="52"></td><td><pre>          <span class="token property">"price"</span> <span class="token operator">:</span> <span class="token number">689</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="53"></td><td><pre>          <span class="token property">"score"</span> <span class="token operator">:</span> <span class="token number">44</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="54"></td><td><pre>          <span class="token property">"starName"</span> <span class="token operator">:</span> <span class="token string">"五星级"</span></pre></td></tr><tr><td data-num="55"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="57"></td><td><pre>      <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>        <span class="token property">"_index"</span> <span class="token operator">:</span> <span class="token string">"dkx"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="59"></td><td><pre>        <span class="token property">"_type"</span> <span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="60"></td><td><pre>        <span class="token property">"_id"</span> <span class="token operator">:</span> <span class="token string">"432335"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="61"></td><td><pre>        <span class="token property">"_score"</span> <span class="token operator">:</span> <span class="token number">5.849986</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="62"></td><td><pre>        <span class="token property">"_source"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>          <span class="token property">"address"</span> <span class="token operator">:</span> <span class="token string">"唐山路145号"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="64"></td><td><pre>          <span class="token property">"brand"</span> <span class="token operator">:</span> <span class="token string">"7天酒店"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="65"></td><td><pre>          <span class="token property">"business"</span> <span class="token operator">:</span> <span class="token string">"北外滩地区"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="66"></td><td><pre>          <span class="token property">"city"</span> <span class="token operator">:</span> <span class="token string">"上海"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="67"></td><td><pre>          <span class="token property">"id"</span> <span class="token operator">:</span> <span class="token number">432335</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="68"></td><td><pre>          <span class="token property">"latitude"</span> <span class="token operator">:</span> <span class="token string">"31.252585"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="69"></td><td><pre>          <span class="token property">"longitude"</span> <span class="token operator">:</span> <span class="token string">"121.498753"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="70"></td><td><pre>          <span class="token property">"name"</span> <span class="token operator">:</span> <span class="token string">"7天连锁酒店(上海北外滩国际客运中心地铁站店)"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="71"></td><td><pre>          <span class="token property">"pic"</span> <span class="token operator">:</span> <span class="token string">"https://m2.tuniucdn.com/filebroker/cdn/res/c1/ba/c1baf64418437c56617f89840c6411ef_w200_h200_c1_t0.jpg"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="72"></td><td><pre>          <span class="token property">"price"</span> <span class="token operator">:</span> <span class="token number">249</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="73"></td><td><pre>          <span class="token property">"score"</span> <span class="token operator">:</span> <span class="token number">35</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="74"></td><td><pre>          <span class="token property">"starName"</span> <span class="token operator">:</span> <span class="token string">"二钻"</span></pre></td></tr><tr><td data-num="75"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>    <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="78"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="79"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p><strong>总结</strong>:</p><p>function score query 定义的三要素是什么？</p><ul><li>过滤条件：哪些文档要加分</li><li>算分函数：如何计算 function score</li><li>加权方式：function score 与 query score 如何运算</li></ul></blockquote><h5 id="9962-boolean-query"><a class="anchor" href="#9962-boolean-query">#</a> 9.9.6.2、Boolean Query🌴</h5><p>布尔查询是一个或多个查询子句的组合。子查询的组合方式有：</p><ul><li>must：必须匹配每个子查询，类似 “与”</li><li>should：选择性匹配子查询，类似 “或”</li><li>must_not：必须不匹配，不参与算分，类似 “非”</li><li>filter：必须匹配，不参与算分</li></ul><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre>GET /indexName/_seach</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>   <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>      <span class="token property">"bool"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>         <span class="token comment">//must 里面是一个数组也就是说可以定义多个查询条件</span></pre></td></tr><tr><td data-num="6"></td><td><pre>         <span class="token property">"must"</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token comment">// 要求查询的城市必须 是 "上海"</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            <span class="token punctuation">&#123;</span><span class="token property">"term"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token property">"city"</span><span class="token operator">:</span> <span class="token string">"上海"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>         <span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>         <span class="token property">"should"</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token comment">// 两个品牌中的任意一个都可以因为是 "或" 的关系 一个有表示为 true</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token punctuation">&#123;</span><span class="token property">"term"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"皇冠假日"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token punctuation">&#123;</span><span class="token property">"term"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"华美达"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>         <span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>         <span class="token property">"must_not"</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token comment">// 取反，lte 是小于等于，由于取反操作 所以是查询价格 大于等于 500 的</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token punctuation">&#123;</span><span class="token property">"range"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token property">"price"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token property">"lte"</span><span class="token operator">:</span> <span class="token number">500</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>         <span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="16"></td><td><pre>         <span class="token property">"filter"</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token comment">// 过滤，查询用户评价分大于 45 分的</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token punctuation">&#123;</span><span class="token property">"range"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token property">"score"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token property">"gte"</span><span class="token operator">:</span> <span class="token number">45</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>         <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h6 id="99621-利用bool查询实现功能"><a class="anchor" href="#99621-利用bool查询实现功能">#</a> 9.9.6.2.1、利用 bool 查询实现功能🎋</h6><p><strong>需求</strong>：搜索名字包含 “如家” ， 价格不高于 400，在坐标 31.21，121.5 周围 10km 范围内的酒店。</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre>GET /dkx/_search <span class="token comment">// GET 请求 / 索引库名 / 查询全部文档</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token comment">// </span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token property">"bool"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>      <span class="token property">"must"</span><span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>          <span class="token property">"match"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"如家"</span></pre></td></tr><tr><td data-num="9"></td><td><pre>          <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token property">"must_not"</span><span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>          <span class="token property">"range"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token property">"price"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>              <span class="token property">"gt"</span><span class="token operator">:</span> <span class="token number">400</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>          <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      <span class="token property">"filter"</span><span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>          <span class="token property">"geo_distance"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            <span class="token property">"distance"</span><span class="token operator">:</span> <span class="token string">"10km"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token property">"location"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>              <span class="token property">"lat"</span><span class="token operator">:</span> <span class="token number">31.21</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="27"></td><td><pre>              <span class="token property">"lon"</span><span class="token operator">:</span> <span class="token number">121.5</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>          <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>      <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>结果：</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token property">"took"</span> <span class="token operator">:</span> <span class="token number">173</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token property">"timed_out"</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token property">"_shards"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token property">"total"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token property">"successful"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token property">"skipped"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token property">"failed"</span> <span class="token operator">:</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token property">"hits"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token property">"total"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token property">"value"</span> <span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token property">"relation"</span> <span class="token operator">:</span> <span class="token string">"eq"</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token property">"max_score"</span> <span class="token operator">:</span> <span class="token number">1.716119</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token property">"hits"</span> <span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token property">"_index"</span> <span class="token operator">:</span> <span class="token string">"dkx"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token property">"_type"</span> <span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token property">"_id"</span> <span class="token operator">:</span> <span class="token string">"433576"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token property">"_score"</span> <span class="token operator">:</span> <span class="token number">1.716119</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token property">"_source"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>          <span class="token property">"address"</span> <span class="token operator">:</span> <span class="token string">"南京东路480号保安坊内"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="24"></td><td><pre>          <span class="token property">"brand"</span> <span class="token operator">:</span> <span class="token string">"如家"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="25"></td><td><pre>          <span class="token property">"business"</span> <span class="token operator">:</span> <span class="token string">"人民广场地区"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="26"></td><td><pre>          <span class="token property">"city"</span> <span class="token operator">:</span> <span class="token string">"上海"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="27"></td><td><pre>          <span class="token property">"id"</span> <span class="token operator">:</span> <span class="token number">433576</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="28"></td><td><pre>          <span class="token property">"location"</span> <span class="token operator">:</span> <span class="token string">"31.236454, 121.480948"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="29"></td><td><pre>          <span class="token property">"name"</span> <span class="token operator">:</span> <span class="token string">"如家酒店(上海南京路步行街店)"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="30"></td><td><pre>          <span class="token property">"pic"</span> <span class="token operator">:</span> <span class="token string">"https://m.tuniucdn.com/fb2/t1/G6/M00/52/BA/Cii-U13eXVaIQmdaAAWxgzdXXxEAAGRrgNIOkoABbGb143_w200_h200_c1_t0.jpg"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="31"></td><td><pre>          <span class="token property">"price"</span> <span class="token operator">:</span> <span class="token number">379</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="32"></td><td><pre>          <span class="token property">"score"</span> <span class="token operator">:</span> <span class="token number">44</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="33"></td><td><pre>          <span class="token property">"starName"</span> <span class="token operator">:</span> <span class="token string">"二钻"</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="36"></td><td><pre>      <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token property">"_index"</span> <span class="token operator">:</span> <span class="token string">"dkx"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token property">"_type"</span> <span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token property">"_id"</span> <span class="token operator">:</span> <span class="token string">"434082"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token property">"_score"</span> <span class="token operator">:</span> <span class="token number">1.5234909</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token property">"_source"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>          <span class="token property">"address"</span> <span class="token operator">:</span> <span class="token string">"复兴东路260号"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="43"></td><td><pre>          <span class="token property">"brand"</span> <span class="token operator">:</span> <span class="token string">"如家"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="44"></td><td><pre>          <span class="token property">"business"</span> <span class="token operator">:</span> <span class="token string">"豫园地区"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="45"></td><td><pre>          <span class="token property">"city"</span> <span class="token operator">:</span> <span class="token string">"上海"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="46"></td><td><pre>          <span class="token property">"id"</span> <span class="token operator">:</span> <span class="token number">434082</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="47"></td><td><pre>          <span class="token property">"location"</span> <span class="token operator">:</span> <span class="token string">"31.220706, 121.498769"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="48"></td><td><pre>          <span class="token property">"name"</span> <span class="token operator">:</span> <span class="token string">"如家酒店·neo(上海外滩城隍庙小南门地铁站店)"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="49"></td><td><pre>          <span class="token property">"pic"</span> <span class="token operator">:</span> <span class="token string">"https://m.tuniucdn.com/fb2/t1/G6/M00/52/B6/Cii-U13eXLGIdHFzAAIG-5cEwDEAAGRfQNNIV0AAgcT627_w200_h200_c1_t0.jpg"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="50"></td><td><pre>          <span class="token property">"price"</span> <span class="token operator">:</span> <span class="token number">392</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="51"></td><td><pre>          <span class="token property">"score"</span> <span class="token operator">:</span> <span class="token number">44</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="52"></td><td><pre>          <span class="token property">"starName"</span> <span class="token operator">:</span> <span class="token string">"二钻"</span></pre></td></tr><tr><td data-num="53"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="55"></td><td><pre>      <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>        <span class="token property">"_index"</span> <span class="token operator">:</span> <span class="token string">"dkx"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="57"></td><td><pre>        <span class="token property">"_type"</span> <span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="58"></td><td><pre>        <span class="token property">"_id"</span> <span class="token operator">:</span> <span class="token string">"1584362548"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="59"></td><td><pre>        <span class="token property">"_score"</span> <span class="token operator">:</span> <span class="token number">1.4174237</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="60"></td><td><pre>        <span class="token property">"_source"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>          <span class="token property">"address"</span> <span class="token operator">:</span> <span class="token string">"御青路315-317号"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="62"></td><td><pre>          <span class="token property">"brand"</span> <span class="token operator">:</span> <span class="token string">"如家"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="63"></td><td><pre>          <span class="token property">"business"</span> <span class="token operator">:</span> <span class="token string">"周浦康桥地区"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="64"></td><td><pre>          <span class="token property">"city"</span> <span class="token operator">:</span> <span class="token string">"上海"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="65"></td><td><pre>          <span class="token property">"id"</span> <span class="token operator">:</span> <span class="token number">1584362548</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="66"></td><td><pre>          <span class="token property">"location"</span> <span class="token operator">:</span> <span class="token string">"31.15719, 121.572392"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="67"></td><td><pre>          <span class="token property">"name"</span> <span class="token operator">:</span> <span class="token string">"如家酒店(上海浦东国际旅游度假区御桥地铁站店)"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="68"></td><td><pre>          <span class="token property">"pic"</span> <span class="token operator">:</span> <span class="token string">"https://m.tuniucdn.com/fb3/s1/2n9c/2ybd3wqdoBtBeKcPxmyso9y1hNXa_w200_h200_c1_t0.jpg"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="69"></td><td><pre>          <span class="token property">"price"</span> <span class="token operator">:</span> <span class="token number">339</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="70"></td><td><pre>          <span class="token property">"score"</span> <span class="token operator">:</span> <span class="token number">44</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="71"></td><td><pre>          <span class="token property">"starName"</span> <span class="token operator">:</span> <span class="token string">"二钻"</span></pre></td></tr><tr><td data-num="72"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>    <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="75"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="76"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p><strong>总结</strong>：</p><p>bool 查询有几种逻辑关系？</p><ul><li>must：必须匹配的条件，可以理解为 “与”</li><li>should：选择性匹配的条件，可以理解为 “或”</li><li>must_not：必须不匹配的条件，不参与打分</li><li>filter：必须匹配的条件，不参与打分</li></ul></blockquote><h4 id="996-搜索结果处理"><a class="anchor" href="#996-搜索结果处理">#</a> 9.9.6、搜索结果处理🌲</h4><ul><li>排序</li><li>分页</li><li>高亮</li></ul><h5 id="9961-排序"><a class="anchor" href="#9961-排序">#</a> 9.9.6.1、排序🌴</h5><p>elasticsearch 支持对搜索结果排序，默认是根据相关度算分 (_score) 来排序。可以排序字段类型有：keyword 类型，数值类型，地理坐标类型，日期类型等。</p><p><strong>&lt;font color='red'&gt; 注意 &lt;/font&gt;.</strong>：一旦进行排序 score 就会放弃打分，因为打分就没有意义了</p><p>字段</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre>GET /indexName/_search</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>   <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>      <span class="token property">"match_all"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>   <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>   <span class="token property">"sort"</span><span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>         <span class="token property">"FIELD"</span><span class="token operator">:</span> <span class="token string">"desc"</span> <span class="token comment">// 排序字段和排序方式 ASC , DESC</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>   <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>地理坐标</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre>GET /indexName/_search</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>   <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>      <span class="token property">"match_all"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>   <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>   <span class="token property">"sort"</span><span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>         <span class="token property">"_geo_distance"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token property">"FIELD"</span><span class="token operator">:</span> <span class="token string">"纬度，经度"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token property">"order"</span><span class="token operator">:</span> <span class="token string">"asc"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token property">"unit"</span><span class="token operator">:</span> <span class="token string">"km"</span></pre></td></tr><tr><td data-num="12"></td><td><pre>         <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>   <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h6 id="99611-案例对酒店数据按照用户评价降序排序评价相同的按照价格升序排序"><a class="anchor" href="#99611-案例对酒店数据按照用户评价降序排序评价相同的按照价格升序排序">#</a> 9.9.6.1.1、案例，对酒店数据按照用户评价降序排序，评价相同的按照价格升序排序🎋</h6><p>评价是 score 字段，价格是 price 字段，按照顺序添加两个排序规则即可。</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre>GET /dkx/_search</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token property">"match_all"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token property">"sort"</span><span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>      <span class="token property">"score"</span><span class="token operator">:</span> <span class="token string">"desc"</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token property">"price"</span><span class="token operator">:</span> <span class="token string">"asc"</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h6 id="99612-案例实现对酒店数据按照到你的位置坐标距离升序排序"><a class="anchor" href="#99612-案例实现对酒店数据按照到你的位置坐标距离升序排序">#</a> 9.9.6.1.2、案例，实现对酒店数据按照到你的位置坐标距离升序排序🎋</h6><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre># 找到 <span class="token number">31.034661</span><span class="token punctuation">,</span> <span class="token number">121.612282</span> 周围的酒店，距离升序排序</pre></td></tr><tr><td data-num="2"></td><td><pre>GET /dkx/_search</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token property">"match_all"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token property">"sort"</span><span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token property">"_geo_distance"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        # location的两种写法都可以</pre></td></tr><tr><td data-num="11"></td><td><pre>        # <span class="token property">"location"</span><span class="token operator">:</span> <span class="token string">"31.034661, 121.612282"</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token property">"location"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>          <span class="token property">"lat"</span><span class="token operator">:</span> <span class="token number">31.034661</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>          <span class="token property">"lon"</span><span class="token operator">:</span> <span class="token number">121.612282</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token property">"order"</span><span class="token operator">:</span> <span class="token string">"desc"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token property">"unit"</span><span class="token operator">:</span> <span class="token string">"km"</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h5 id="9962-分页"><a class="anchor" href="#9962-分页">#</a> 9.9.6.2、分页🌴</h5><p>elasticsearch 默认情况下只返回 top 10 的数据。而如果要查询更多数据就需要修改分页参数了。</p><p>elasticsearch 中通过修改 from，size 参数来控制要返回的分页结果：</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre>GET /indexName/_search</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>   <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>      <span class="token property">"match_all"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>   <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>   <span class="token property">"from"</span><span class="token operator">:</span> <span class="token number">990</span><span class="token punctuation">,</span> <span class="token comment">// 分页开始的位置，默认为 0</span></pre></td></tr><tr><td data-num="7"></td><td><pre>   <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token comment">// 期望获取的文档总数</span></pre></td></tr><tr><td data-num="8"></td><td><pre>   <span class="token property">"sort"</span><span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>         <span class="token property">"price"</span><span class="token operator">:</span> <span class="token string">"dsc"</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>   <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><mark>计算公式</mark>：from - 1 * size = 当前页数</p><p>虽然 ES 的分页查询与 mysql 很像但是其底层原理有很大差别。ES 底层采用的是倒排索引，它的结构其实是不利于做分页的，所以 ES 采用的是逻辑上的一种分页，比方说要查 <code>990~1000</code> 这是条数据。对于 ES 来说它只能查出从 <code>0~1000</code> 个所有的数据，然后去截取 <code>990~1000</code> 的一部分数据</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310131132651.png" alt="image-20231013113208351"></p><p>这种情况在单点查询的时候没什么问题，但是如果是集群 ES 就会把数据进行拆分，放到不同的机器上。拆分的每一份称为分片，也就是每一片上的数据都不一样</p><h6 id="99621-深度分页问题"><a class="anchor" href="#99621-深度分页问题">#</a> 9.9.6.2.1、深度分页问题🎋</h6><p>ES 是分布式的，所以会面临深度分页问题。例如按 price 排序后，获取 from=990，size=10 的数据</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310131135634.png" alt="image-20231013113540176"></p><p>1、首先在每个数据分片上都排序并查询到 1000 条文档</p><p>2、然后将所有节点的结果聚合，在内存中重新排序选出前 1000 条文档</p><p>3、最后从这 1000 条中，选取从 990 开始的 10 条文档</p><p>如果搜索页数过深，或者结果集 (from + size) 越大，对内存和 CPU 的消耗也越高。因此 ES 设定结果集查询的上限是 10000</p><p>如下演示超出 10000 条会怎么样</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre>GET /dkx/_search</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token property">"match_all"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token property">"from"</span><span class="token operator">:</span> <span class="token number">9990</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token property">"sort"</span><span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token property">"price"</span><span class="token operator">:</span> <span class="token string">"asc"</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment">//----------------------- 查询结果 -----------------------</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token property">"took"</span> <span class="token operator">:</span> <span class="token number">33</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token property">"timed_out"</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token property">"_shards"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token property">"total"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token property">"successful"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token property">"skipped"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token property">"failed"</span> <span class="token operator">:</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token property">"hits"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token property">"total"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>      <span class="token property">"value"</span> <span class="token operator">:</span> <span class="token number">201</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="27"></td><td><pre>      <span class="token property">"relation"</span> <span class="token operator">:</span> <span class="token string">"eq"</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token property">"max_score"</span> <span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token property">"hits"</span> <span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="31"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>9990 - 1 * 10 也就是刚好 10000 条数据，但是如果加 1</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre>GET /dkx/_search</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token property">"match_all"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token property">"from"</span><span class="token operator">:</span> <span class="token number">9991</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token property">"sort"</span><span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token property">"price"</span><span class="token operator">:</span> <span class="token string">"asc"</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310131143199.png" alt="image-20231013114259949"></p><p>查询报错了</p><h6 id="99622-深度分页解决方案"><a class="anchor" href="#99622-深度分页解决方案">#</a> 9.9.6.2.2、深度分页解决方案🎋</h6><p>针对深度分页，ES 提供了两种解决方案</p><ul><li>search after：分页时需要排序，原理是从上一次的排序值开始，查询下一页数据。官方推荐使用的方式。</li><li>scroll：原理将排序数据形成快照，保存在内存。官方已经不推荐使用。</li></ul><blockquote><p><strong>总结</strong>：</p><p>from + size</p><ul><li>优点：支持随机翻页</li><li>缺点：深度分页问题，默认查询上限 (from + size) 是 10000</li><li>场景：百度，京东，谷歌，淘宝这样的随机翻页搜索</li></ul><p>after search：</p><ul><li>优点：没有查询上限 (单次查询的 size 不超过 10000)</li><li>缺点：只能向后逐页查询，不支持随机翻页</li><li>场景：没有随机翻页需求的搜索，例如手机向下滚动翻页</li></ul><p>scroll：</p><ul><li>优点：没有查询上限 (单次查询的 size 不超过 10000)</li><li>缺点：会有额外内存消耗，并且搜索结果是非实时的</li><li>场景：海量数据的获取和迁移。从 ES7.1 开始不推荐，建议使用 after search 方案。</li></ul></blockquote><h5 id="9963-高亮"><a class="anchor" href="#9963-高亮">#</a> 9.9.6.3、高亮🌴</h5><p><strong>高亮</strong>：就是在搜索结果中把搜索关键字突出显示。</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310131156938.png" alt="image-20231013115559310"></p><p>原理是这样的：</p><ul><li>将搜索结果中的关键字用标签标记出来</li><li>在页面中给标签添加 css 样式</li></ul><p>语法：</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre>GET /indexName/_search</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>   <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>      <span class="token property">"match"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>         <span class="token property">"FIELD"</span><span class="token operator">:</span> <span class="token string">"TEXT"</span></pre></td></tr><tr><td data-num="6"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>   <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>   <span class="token property">"highlight"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token property">"fields"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 指定要高亮的字段</span></pre></td></tr><tr><td data-num="10"></td><td><pre>         <span class="token property">"FIELD"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token property">"pre_tags"</span><span class="token operator">:</span> <span class="token string">"&lt;em>"</span><span class="token punctuation">,</span> <span class="token comment">// 用来标记高亮字段的前置标签</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token property">"post_tags"</span><span class="token operator">:</span> <span class="token string">"&lt;/em>"</span> <span class="token comment">// 用来标记高亮字段的后置标签</span></pre></td></tr><tr><td data-num="13"></td><td><pre>         <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>代码演示：</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre># 高亮查询，默认情况下，ES搜索字段必须与高亮字段一致，否则不会高亮</pre></td></tr><tr><td data-num="2"></td><td><pre>GET /dkx/_search</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token property">"match"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>      <span class="token property">"all"</span><span class="token operator">:</span> <span class="token string">"如家"</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token property">"highlight"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token property">"fields"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        </pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">//------------------- 结果 -------------------</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token property">"_index"</span> <span class="token operator">:</span> <span class="token string">"dkx"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token property">"_type"</span> <span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token property">"_id"</span> <span class="token operator">:</span> <span class="token string">"339952837"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token property">"_score"</span> <span class="token operator">:</span> <span class="token number">2.7569861</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token property">"_source"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>          <span class="token property">"address"</span> <span class="token operator">:</span> <span class="token string">"良乡西路7号"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="25"></td><td><pre>          <span class="token property">"brand"</span> <span class="token operator">:</span> <span class="token string">"如家"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="26"></td><td><pre>          <span class="token property">"business"</span> <span class="token operator">:</span> <span class="token string">"房山风景区"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="27"></td><td><pre>          <span class="token property">"city"</span> <span class="token operator">:</span> <span class="token string">"北京"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="28"></td><td><pre>          <span class="token property">"id"</span> <span class="token operator">:</span> <span class="token number">339952837</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="29"></td><td><pre>          <span class="token property">"location"</span> <span class="token operator">:</span> <span class="token string">"39.73167, 116.132482"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="30"></td><td><pre>          <span class="token property">"name"</span> <span class="token operator">:</span> <span class="token string">"如家酒店(北京良乡西路店)"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="31"></td><td><pre>          <span class="token property">"pic"</span> <span class="token operator">:</span> <span class="token string">"https://m.tuniucdn.com/fb3/s1/2n9c/3Dpgf5RTTzrxpeN5y3RLnRVtxMEA_w200_h200_c1_t0.jpg"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="32"></td><td><pre>          <span class="token property">"price"</span> <span class="token operator">:</span> <span class="token number">159</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="33"></td><td><pre>          <span class="token property">"score"</span> <span class="token operator">:</span> <span class="token number">46</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="34"></td><td><pre>          <span class="token property">"starName"</span> <span class="token operator">:</span> <span class="token string">"二钻"</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>&lt;font color='red'&gt; 注意 &lt;/font&gt;：高亮查询，默认情况下，ES 搜索字段必须与高亮字段一致，否则不会高亮</p><p>演示代码：</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre># 高亮查询，默认情况下，ES搜索字段必须与高亮字段一致，否则不会高亮</pre></td></tr><tr><td data-num="2"></td><td><pre>GET /dkx/_search</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token property">"match"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"如家"</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token property">"highlight"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token property">"fields"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        </pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">//----------------------------- 结果 -----------------------------</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token property">"name"</span> <span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="19"></td><td><pre>   <span class="token string">"&lt;em>如家&lt;/em>酒店(北京良乡西路店)"</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">]</span></pre></td></tr></table></figure><p>可以看到 name 字段加上了高亮标签了，但是 。我不希望在查询中指定 name 字段因为 all 搜索到的更多</p><p>解决办法如下：</p><p>&quot;require_field_match&quot;: &quot;true&quot; ：是否需要字段高亮匹配，默认是 true 需要高亮字段与查询字段匹配</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre># 高亮查询，默认情况下，ES搜索字段必须与高亮字段一致，否则不会高亮</pre></td></tr><tr><td data-num="2"></td><td><pre>GET /dkx/_search</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token property">"match"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>      <span class="token property">"all"</span><span class="token operator">:</span> <span class="token string">"如家"</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token property">"highlight"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token property">"fields"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>         <span class="token comment">// 修改为 false 让其不与查询字段匹配就可以高亮了	</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token property">"require_field_match"</span><span class="token operator">:</span> <span class="token string">"false"</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p><strong>总结</strong>：</p><p>搜索结果处理整体语法：</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre>GET /dkx/_search</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token property">"match"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>       <span class="token property">"all"</span><span class="token operator">:</span> <span class="token string">"如家"</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>   <span class="token property">"from"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 分页开始的位置</span></pre></td></tr><tr><td data-num="9"></td><td><pre>   <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token comment">// 期望获取的文档总数</span></pre></td></tr><tr><td data-num="10"></td><td><pre>   <span class="token property">"sort"</span><span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>         <span class="token property">"price"</span><span class="token operator">:</span> <span class="token string">"asc"</span> <span class="token comment">// 普通排序</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>         <span class="token property">"_geo_distance"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 距离排序</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token property">"location"</span><span class="token operator">:</span> <span class="token string">"31.040699,121.618075"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token property">"order"</span><span class="token operator">:</span> <span class="token string">"asc"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token property">"unit"</span><span class="token operator">:</span> <span class="token string">"km"</span></pre></td></tr><tr><td data-num="19"></td><td><pre>         <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>   <span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="22"></td><td><pre>   <span class="token property">"highlight"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>      <span class="token property">"fields"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 高亮字段</span></pre></td></tr><tr><td data-num="24"></td><td><pre>         <span class="token property">"name"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token property">"pre_tags"</span><span class="token operator">:</span> <span class="token string">"&lt;em>"</span><span class="token punctuation">,</span> <span class="token comment">// 用来标记高亮字段的前置标签</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token property">"post_tags"</span><span class="token operator">:</span> <span class="token string">"&lt;/em>"</span><span class="token punctuation">,</span> <span class="token comment">// 用来标记高亮字段的后置标签</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token property">"require_field_match"</span><span class="token operator">:</span> <span class="token string">"false"</span></pre></td></tr><tr><td data-num="28"></td><td><pre>         <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure></blockquote><h4 id="997-restclient查询文档"><a class="anchor" href="#997-restclient查询文档">#</a> 9.9.7、RestClient 查询文档🌲</h4><ul><li>快速入门</li><li>match 查询</li><li>精确查询</li><li>复合查询</li><li>排序，分页，高亮</li></ul><h5 id="9971-快速入门"><a class="anchor" href="#9971-快速入门">#</a> 9.9.7.1、快速入门🌴</h5><p>我们通过 match_all 来演示下基本的 API，先看请求 DSL 的组织：</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310131223853.png" alt="image-20231013122353640"></p><p>核心的 API：</p><p>request.source()：</p><p>里面封装了：排序，分页，高亮等所有功能。</p><p>QueryBuilders：</p><p>里面有各种各样的查询 matchQuery，matchAllQuery，boolQuery 等等。</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310131947096.png" alt="image-20231013194730970"></p><p>代码演示：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Test</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testMatchAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token comment">// 1. 准备 Request</span></pre></td></tr><tr><td data-num="5"></td><td><pre>   <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">"dkx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>   <span class="token comment">// 2. 准备 DSL</span></pre></td></tr><tr><td data-num="7"></td><td><pre>   request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchAllQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>   <span class="token comment">// 3. 发送请求</span></pre></td></tr><tr><td data-num="9"></td><td><pre>   <span class="token class-name">SearchResponse</span> search<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>   <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      search <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>   <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>   <span class="token comment">// 4. 解析响应</span></pre></td></tr><tr><td data-num="16"></td><td><pre>   <span class="token class-name">SearchHits</span> hits <span class="token operator">=</span> search<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>   <span class="token comment">// 4.1. 获取总数</span></pre></td></tr><tr><td data-num="18"></td><td><pre>   <span class="token keyword">long</span> value <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>   <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"共搜索到"</span> <span class="token operator">+</span> value <span class="token operator">+</span> <span class="token string">"条数据"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>   <span class="token comment">// 4.2. 文档数组</span></pre></td></tr><tr><td data-num="21"></td><td><pre>   <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hits1 <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>   <span class="token comment">// 4.3. 遍历文档数组</span></pre></td></tr><tr><td data-num="23"></td><td><pre>   <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> hits1<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre>   <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>      <span class="token comment">// 4.4. 获取文档 source</span></pre></td></tr><tr><td data-num="26"></td><td><pre>      <span class="token class-name">String</span> json <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>      <span class="token comment">// 4.5. 反序列化为 HotelDoc 对象</span></pre></td></tr><tr><td data-num="28"></td><td><pre>      <span class="token class-name">HotelDoc</span> hotelDoc <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"HotelDoc: "</span> <span class="token operator">+</span> hotelDoc<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token comment">//----------------------- 打印结果 -----------------------</span></pre></td></tr><tr><td data-num="33"></td><td><pre>共搜索到<span class="token number">201</span>条数据</pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token class-name">HotelDoc</span><span class="token operator">:</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">36934</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token number">7</span>天连锁酒店<span class="token punctuation">(</span>上海宝山路地铁站店<span class="token punctuation">)</span><span class="token punctuation">,</span> address<span class="token operator">=</span>静安交通路<span class="token number">40</span>号<span class="token punctuation">,</span> price<span class="token operator">=</span><span class="token number">336</span><span class="token punctuation">,</span> score<span class="token operator">=</span><span class="token number">37</span><span class="token punctuation">,</span> brand<span class="token operator">=</span><span class="token number">7</span>天酒店<span class="token punctuation">,</span> city<span class="token operator">=</span>上海<span class="token punctuation">,</span> starName<span class="token operator">=</span>二钻<span class="token punctuation">,</span> business<span class="token operator">=</span>四川北路商业区<span class="token punctuation">,</span> location<span class="token operator">=</span><span class="token number">31.251433</span><span class="token punctuation">,</span> <span class="token number">121.47522</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="35"></td><td><pre>                   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr></table></figure><p>RestAPI 中其中构建 DSL 是通过 HighLevelRestClient 中的 resource () 来实现的，其中包含了查询，排序，分页，高亮等所有功能：</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310131954682.png" alt="image-20231013194937001"></p><p>RestAPI 中其中构建查询条件的核心部分是由一名为 QueryBuilders 的工具类提供的，其中包含了各种查询方法：</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310131954893.png" alt="image-20231013195054455"></p><blockquote><p><strong>总结</strong>：</p><p>查询的基本步骤是：</p><ol><li>创建 SearchRequest 对象</li><li>准备 Request.source ()，也就是 DSL。<ol><li>QueryBuilders 来构建查询条件</li><li>传入 Request.source () 的 query () 方法</li></ol></li><li>发送请求，得到结果</li><li>解析结果 (参考 JSON 结果，从外到内，逐层解析)</li></ol></blockquote><h5 id="9972-全文检索查询"><a class="anchor" href="#9972-全文检索查询">#</a> 9.9.7.2、全文检索查询🌴</h5><p>全文检索的 match 和 multi_match 查询与 match_all 的 API 基本一致。差别是查询条件，也就是 query 的部分。</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310132252478.png" alt="image-20231013225059138"></p><p>同样是利用 QueryBuilders 提供的方法：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Test</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testMatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token comment">// 1. 准备 request</span></pre></td></tr><tr><td data-num="5"></td><td><pre>   <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">"dkx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>   <span class="token comment">// 2. 准备 DSL</span></pre></td></tr><tr><td data-num="7"></td><td><pre>   request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token string">"all"</span><span class="token punctuation">,</span> <span class="token string">"如家"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>   <span class="token comment">// 3. 发送请求</span></pre></td></tr><tr><td data-num="9"></td><td><pre>   <span class="token class-name">SearchResponse</span> search<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>   <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      search <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>   <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>   <span class="token comment">// 4. 解析响应</span></pre></td></tr><tr><td data-num="16"></td><td><pre>   <span class="token class-name">SearchHits</span> hits <span class="token operator">=</span> search<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>   <span class="token keyword">long</span> value <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>   <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"共搜索到"</span> <span class="token operator">+</span> value <span class="token operator">+</span> <span class="token string">"条数据"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>   <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hits1 <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>   <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> hits1<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre>   <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>      <span class="token class-name">String</span> json <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>      <span class="token class-name">HotelDoc</span> hotelDoc <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hotelDoc: "</span> <span class="token operator">+</span> hotelDoc<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token comment">//-------------------- 打印结果 --------------------</span></pre></td></tr><tr><td data-num="28"></td><td><pre>共搜索到<span class="token number">30</span>条数据</pre></td></tr><tr><td data-num="29"></td><td><pre>hotelDoc<span class="token operator">:</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">339952837</span><span class="token punctuation">,</span> name<span class="token operator">=</span>如家酒店<span class="token punctuation">(</span>北京良乡西路店<span class="token punctuation">)</span><span class="token punctuation">,</span> address<span class="token operator">=</span>良乡西路<span class="token number">7</span>号<span class="token punctuation">,</span> price<span class="token operator">=</span><span class="token number">159</span><span class="token punctuation">,</span> score<span class="token operator">=</span><span class="token number">46</span><span class="token punctuation">,</span> brand<span class="token operator">=</span>如家<span class="token punctuation">,</span> city<span class="token operator">=</span>北京<span class="token punctuation">,</span> starName<span class="token operator">=</span>二钻<span class="token punctuation">,</span> business<span class="token operator">=</span>房山风景区<span class="token punctuation">,</span> location<span class="token operator">=</span><span class="token number">39.73167</span><span class="token punctuation">,</span> <span class="token number">116.132482</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="30"></td><td><pre>                   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr></table></figure><p>方法的抽取</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Test</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testMatchAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token comment">// 1. 准备 Request</span></pre></td></tr><tr><td data-num="5"></td><td><pre>   <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">"dkx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>   <span class="token comment">// 2. 准备 DSL</span></pre></td></tr><tr><td data-num="7"></td><td><pre>   request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchAllQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>   <span class="token comment">// 3. 发送请求</span></pre></td></tr><tr><td data-num="9"></td><td><pre>   <span class="token class-name">SearchResponse</span> search<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>   <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      search <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>   <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>   <span class="token comment">// 4. 调用解析响应函数</span></pre></td></tr><tr><td data-num="16"></td><td><pre>   <span class="token function">handle</span><span class="token punctuation">(</span>search<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token annotation punctuation">@Test</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testMatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>   <span class="token comment">// 1. 准备 request</span></pre></td></tr><tr><td data-num="23"></td><td><pre>   <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">"dkx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>   <span class="token comment">// 2. 准备 DSL</span></pre></td></tr><tr><td data-num="25"></td><td><pre>   request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token string">"all"</span><span class="token punctuation">,</span> <span class="token string">"如家"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>   <span class="token comment">// 3. 发送请求</span></pre></td></tr><tr><td data-num="27"></td><td><pre>   <span class="token class-name">SearchResponse</span> search<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>   <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>      search <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>   <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>   <span class="token comment">// 4. 调用解析响应函数</span></pre></td></tr><tr><td data-num="34"></td><td><pre>   <span class="token function">handle</span><span class="token punctuation">(</span>search<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">SearchResponse</span> search<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>   <span class="token comment">// 4. 解析响应</span></pre></td></tr><tr><td data-num="40"></td><td><pre>   <span class="token class-name">SearchHits</span> hits <span class="token operator">=</span> search<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>   <span class="token keyword">long</span> value <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>   <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"共搜索到"</span> <span class="token operator">+</span> value <span class="token operator">+</span> <span class="token string">"条数据"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>   <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hits1 <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>   <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> hits1<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="45"></td><td><pre>   <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>      <span class="token class-name">String</span> json <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>      <span class="token class-name">HotelDoc</span> hotelDoc <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hotelDoc: "</span> <span class="token operator">+</span> hotelDoc<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h5 id="9973-精确查询"><a class="anchor" href="#9973-精确查询">#</a> 9.9.7.3、精确查询🌴</h5><p>精确查询常见的有 term 查询和 range 查询，同样利用 QueryBuilder 实现：</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310132252500.png" alt="image-20231013210337545"></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Test</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testJingque</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>   <span class="token comment">// 1. 准备 Request</span></pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">"dkx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>   <span class="token comment">// 2. 准备 DSL</span></pre></td></tr><tr><td data-num="6"></td><td><pre>   <span class="token comment">// 2.1 词条查询</span></pre></td></tr><tr><td data-num="7"></td><td><pre>   request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">"city"</span><span class="token punctuation">,</span> <span class="token string">"深圳"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>   <span class="token comment">// 2.2 范围查询</span></pre></td></tr><tr><td data-num="9"></td><td><pre>   request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">rangeQuery</span><span class="token punctuation">(</span><span class="token string">"price"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">gte</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lte</span><span class="token punctuation">(</span><span class="token number">150</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>   <span class="token comment">// 3. 发送请求</span></pre></td></tr><tr><td data-num="11"></td><td><pre>   <span class="token class-name">SearchResponse</span> search<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>   <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      search <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>   <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>   <span class="token function">handle</span><span class="token punctuation">(</span>search<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">SearchResponse</span> search<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>   <span class="token comment">// 4. 解析响应</span></pre></td></tr><tr><td data-num="22"></td><td><pre>   <span class="token class-name">SearchHits</span> hits <span class="token operator">=</span> search<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>   <span class="token keyword">long</span> value <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>   <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"共搜索到"</span> <span class="token operator">+</span> value <span class="token operator">+</span> <span class="token string">"条数据"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>   <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hits1 <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> hits1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>      <span class="token class-name">String</span> json <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>      <span class="token class-name">HotelDoc</span> hotelDoc <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hotelDoc: "</span> <span class="token operator">+</span> hotelDoc<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token comment">//----------------- 打印结果 -----------------</span></pre></td></tr><tr><td data-num="33"></td><td><pre>共搜索到<span class="token number">5</span>条数据</pre></td></tr><tr><td data-num="34"></td><td><pre>hotelDoc<span class="token operator">:</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">541619</span><span class="token punctuation">,</span> name<span class="token operator">=</span>如家酒店<span class="token punctuation">(</span>上海莘庄地铁站龙之梦商业广场店<span class="token punctuation">)</span><span class="token punctuation">,</span> address<span class="token operator">=</span>莘庄镇莘浜路<span class="token number">172</span>号<span class="token punctuation">,</span> price<span class="token operator">=</span><span class="token number">149</span><span class="token punctuation">,</span> score<span class="token operator">=</span><span class="token number">44</span><span class="token punctuation">,</span> brand<span class="token operator">=</span>如家<span class="token punctuation">,</span> city<span class="token operator">=</span>上海<span class="token punctuation">,</span> starName<span class="token operator">=</span>二钻<span class="token punctuation">,</span> business<span class="token operator">=</span>莘庄工业区<span class="token punctuation">,</span> location<span class="token operator">=</span><span class="token number">31.105797</span><span class="token punctuation">,</span> <span class="token number">121.37755</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="35"></td><td><pre>                   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr></table></figure><h5 id="9974-复合查询-boolean-query"><a class="anchor" href="#9974-复合查询-boolean-query">#</a> 9.9.7.4、复合查询 - boolean query🌴</h5><p>精确查询常见的有 term 查询和 range 查询，同样利用 QueryBuilders 实现：</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310141059562.png" alt="image-20231014105919882"></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Test</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testBooleanQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token comment">// 1. 准备 Request</span></pre></td></tr><tr><td data-num="5"></td><td><pre>   <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">"dkx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>   <span class="token comment">// 2. 准备 DSL</span></pre></td></tr><tr><td data-num="7"></td><td><pre>   <span class="token comment">// 2.1. 准备 BoolQuery</span></pre></td></tr><tr><td data-num="8"></td><td><pre>   <span class="token class-name">BoolQueryBuilder</span> boolQuery <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">boolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>   <span class="token comment">// 2.2. 添加 term</span></pre></td></tr><tr><td data-num="10"></td><td><pre>   boolQuery<span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">"city"</span><span class="token punctuation">,</span> <span class="token string">"深圳"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>   <span class="token comment">// 2.3. 添加 range</span></pre></td></tr><tr><td data-num="12"></td><td><pre>   boolQuery<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">rangeQuery</span><span class="token punctuation">(</span><span class="token string">"price"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lte</span><span class="token punctuation">(</span><span class="token number">250</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>   <span class="token comment">// 2.4. 将条件添加到 发送请求中</span></pre></td></tr><tr><td data-num="14"></td><td><pre>   request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>boolQuery<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>   <span class="token comment">// 3. 发送请求</span></pre></td></tr><tr><td data-num="16"></td><td><pre>   <span class="token class-name">SearchResponse</span> search<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>   <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      search <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>   <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>   <span class="token function">handle</span><span class="token punctuation">(</span>search<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">SearchResponse</span> search<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>   <span class="token comment">// 4. 解析响应</span></pre></td></tr><tr><td data-num="27"></td><td><pre>   <span class="token class-name">SearchHits</span> hits <span class="token operator">=</span> search<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>   <span class="token keyword">long</span> value <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>   <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"共搜索到"</span> <span class="token operator">+</span> value <span class="token operator">+</span> <span class="token string">"条数据"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>   <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hits1 <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> hits1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>      <span class="token class-name">String</span> json <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>      <span class="token class-name">HotelDoc</span> hotelDoc <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hotelDoc: "</span> <span class="token operator">+</span> hotelDoc<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token comment">//-------------------- 打印结果 --------------------</span></pre></td></tr><tr><td data-num="38"></td><td><pre>共搜索到<span class="token number">18</span>条数据</pre></td></tr><tr><td data-num="39"></td><td><pre>hotelDoc<span class="token operator">:</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">517915</span><span class="token punctuation">,</span> name<span class="token operator">=</span>如家酒店·<span class="token function">neo</span><span class="token punctuation">(</span>深圳草埔地铁站店<span class="token punctuation">)</span><span class="token punctuation">,</span> address<span class="token operator">=</span>布吉路<span class="token number">1036</span>号<span class="token punctuation">,</span> price<span class="token operator">=</span><span class="token number">159</span><span class="token punctuation">,</span> score<span class="token operator">=</span><span class="token number">44</span><span class="token punctuation">,</span> brand<span class="token operator">=</span>如家<span class="token punctuation">,</span> city<span class="token operator">=</span>深圳<span class="token punctuation">,</span> starName<span class="token operator">=</span>二钻<span class="token punctuation">,</span> business<span class="token operator">=</span>田贝<span class="token operator">/</span>水贝珠宝城<span class="token punctuation">,</span> location<span class="token operator">=</span><span class="token number">22.583191</span><span class="token punctuation">,</span> <span class="token number">114.118499</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="40"></td><td><pre>                   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr></table></figure><blockquote><p><strong>总结</strong>：</p><p>要构建查询条件，只要记住一个类：QueryBuilders</p></blockquote><h5 id="9975-搜索结果处理"><a class="anchor" href="#9975-搜索结果处理">#</a> 9.9.7.5、搜索结果处理🌴</h5><h6 id="99751-排序和分页"><a class="anchor" href="#99751-排序和分页">#</a> 9.9.7.5.1、排序和分页🎋</h6><p>搜索结果的排序和分页是与 query 同级的参数，对应的 API 如下：</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310141103708.png" alt="image-20231014110315292"></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Test</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testPageAndSort</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token comment">// 页码，每页大小</span></pre></td></tr><tr><td data-num="5"></td><td><pre>   <span class="token keyword">int</span> page <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>size <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>   <span class="token comment">// 1. 准备 Request</span></pre></td></tr><tr><td data-num="7"></td><td><pre>   <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">"dkx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>   <span class="token comment">// 2. 准备 DSL</span></pre></td></tr><tr><td data-num="9"></td><td><pre>   request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchAllQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>   <span class="token comment">// 2.1. 排序 sort</span></pre></td></tr><tr><td data-num="11"></td><td><pre>   request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token string">"price"</span><span class="token punctuation">,</span> <span class="token class-name">SortOrder</span><span class="token punctuation">.</span><span class="token constant">ASC</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>   <span class="token comment">// 2.2. 分页 from size</span></pre></td></tr><tr><td data-num="13"></td><td><pre>   request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token punctuation">(</span>page <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> size<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>   <span class="token comment">// 3. 发送请求</span></pre></td></tr><tr><td data-num="15"></td><td><pre>   <span class="token class-name">SearchResponse</span> search<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>   <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      search <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>   <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>   <span class="token function">handle</span><span class="token punctuation">(</span>search<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">SearchResponse</span> search<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>   <span class="token comment">// 4. 解析响应</span></pre></td></tr><tr><td data-num="26"></td><td><pre>   <span class="token class-name">SearchHits</span> hits <span class="token operator">=</span> search<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>   <span class="token keyword">long</span> value <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>   <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"共搜索到"</span> <span class="token operator">+</span> value <span class="token operator">+</span> <span class="token string">"条数据"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>   <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hits1 <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> hits1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>      <span class="token class-name">String</span> json <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>      <span class="token class-name">HotelDoc</span> hotelDoc <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hotelDoc: "</span> <span class="token operator">+</span> hotelDoc<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token comment">//----------------------- 打印结果 -----------------------</span></pre></td></tr><tr><td data-num="37"></td><td><pre>共搜索到<span class="token number">201</span>条数据</pre></td></tr><tr><td data-num="38"></td><td><pre>hotelDoc<span class="token operator">:</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">197837109</span><span class="token punctuation">,</span> name<span class="token operator">=</span>如家酒店·<span class="token function">neo</span><span class="token punctuation">(</span>深圳龙岗大道布吉地铁站店<span class="token punctuation">)</span><span class="token punctuation">,</span> address<span class="token operator">=</span>布吉镇深惠路龙珠商城<span class="token punctuation">,</span> price<span class="token operator">=</span><span class="token number">127</span><span class="token punctuation">,</span> score<span class="token operator">=</span><span class="token number">43</span><span class="token punctuation">,</span> brand<span class="token operator">=</span>如家<span class="token punctuation">,</span> city<span class="token operator">=</span>深圳<span class="token punctuation">,</span> starName<span class="token operator">=</span>二钻<span class="token punctuation">,</span> business<span class="token operator">=</span>布吉<span class="token operator">/</span>深圳东站<span class="token punctuation">,</span> location<span class="token operator">=</span><span class="token number">22.602482</span><span class="token punctuation">,</span> <span class="token number">114.123284</span><span class="token punctuation">,</span> pic<span class="token operator">=</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>m<span class="token punctuation">.</span>tuniucdn<span class="token punctuation">.</span>com<span class="token operator">/</span>fb2<span class="token operator">/</span>t1<span class="token operator">/</span><span class="token constant">G6</span><span class="token operator">/</span><span class="token constant">M00</span><span class="token operator">/</span><span class="token number">25</span><span class="token operator">/</span><span class="token number">58</span><span class="token operator">/</span><span class="token class-name">Cii</span><span class="token operator">-</span><span class="token class-name">TF3PFZOIA7jwAAKInGFN4xgAAEVbAGeP4AAAoi0485_w200_h200_c1_t0</span><span class="token punctuation">.</span>jpg<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="39"></td><td><pre>hotelDoc<span class="token operator">:</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">2316304</span><span class="token punctuation">,</span> name<span class="token operator">=</span>如家酒店<span class="token punctuation">(</span>深圳双龙地铁站店<span class="token punctuation">)</span><span class="token punctuation">,</span> address<span class="token operator">=</span>龙岗街道龙岗墟社区龙平东路<span class="token number">62</span>号<span class="token punctuation">,</span> price<span class="token operator">=</span><span class="token number">135</span><span class="token punctuation">,</span> score<span class="token operator">=</span><span class="token number">45</span><span class="token punctuation">,</span> brand<span class="token operator">=</span>如家<span class="token punctuation">,</span> city<span class="token operator">=</span>深圳<span class="token punctuation">,</span> starName<span class="token operator">=</span>二钻<span class="token punctuation">,</span> business<span class="token operator">=</span>龙岗中心区<span class="token operator">/</span>大运新城<span class="token punctuation">,</span> location<span class="token operator">=</span><span class="token number">22.730828</span><span class="token punctuation">,</span> <span class="token number">114.278337</span><span class="token punctuation">,</span> pic<span class="token operator">=</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>m<span class="token punctuation">.</span>tuniucdn<span class="token punctuation">.</span>com<span class="token operator">/</span>fb3<span class="token operator">/</span>s1<span class="token operator">/</span><span class="token number">2</span>n9c<span class="token operator">/</span><span class="token number">4</span>AzEoQ44awd1D2g95a6XDtJf3dkw_w200_h200_c1_t0<span class="token punctuation">.</span>jpg<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="40"></td><td><pre>hotelDoc<span class="token operator">:</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">1630005459</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token number">7</span>天连锁酒店（深圳地王大厦红桂路店）（原红桂路店）<span class="token punctuation">,</span> address<span class="token operator">=</span>罗湖区宝安南路<span class="token number">2078</span>号深港豪苑（与红桂路交汇处）<span class="token punctuation">,</span> price<span class="token operator">=</span><span class="token number">143</span><span class="token punctuation">,</span> score<span class="token operator">=</span><span class="token number">39</span><span class="token punctuation">,</span> brand<span class="token operator">=</span><span class="token number">7</span>天酒店<span class="token punctuation">,</span> city<span class="token operator">=</span>深圳<span class="token punctuation">,</span> starName<span class="token operator">=</span>二钻<span class="token punctuation">,</span> business<span class="token operator">=</span><span class="token punctuation">,</span> location<span class="token operator">=</span><span class="token number">22.550341</span><span class="token punctuation">,</span> <span class="token number">114.10965</span><span class="token punctuation">,</span> pic<span class="token operator">=</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>m<span class="token punctuation">.</span>tuniucdn<span class="token punctuation">.</span>com<span class="token operator">/</span>fb2<span class="token operator">/</span>t1<span class="token operator">/</span><span class="token constant">G2</span><span class="token operator">/</span><span class="token constant">M00</span><span class="token operator">/</span><span class="token constant">EA</span><span class="token operator">/</span><span class="token number">18</span><span class="token operator">/</span><span class="token class-name">Cii</span><span class="token operator">-</span><span class="token class-name">T1k1KaGIIkQVAAD4fD_T3FcAALTtABiCJ8AAPiU164_w200_h200_c1_t0</span><span class="token punctuation">.</span>jpg<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="41"></td><td><pre>hotelDoc<span class="token operator">:</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">541619</span><span class="token punctuation">,</span> name<span class="token operator">=</span>如家酒店<span class="token punctuation">(</span>上海莘庄地铁站龙之梦商业广场店<span class="token punctuation">)</span><span class="token punctuation">,</span> address<span class="token operator">=</span>莘庄镇莘浜路<span class="token number">172</span>号<span class="token punctuation">,</span> price<span class="token operator">=</span><span class="token number">149</span><span class="token punctuation">,</span> score<span class="token operator">=</span><span class="token number">44</span><span class="token punctuation">,</span> brand<span class="token operator">=</span>如家<span class="token punctuation">,</span> city<span class="token operator">=</span>上海<span class="token punctuation">,</span> starName<span class="token operator">=</span>二钻<span class="token punctuation">,</span> business<span class="token operator">=</span>莘庄工业区<span class="token punctuation">,</span> location<span class="token operator">=</span><span class="token number">31.105797</span><span class="token punctuation">,</span> <span class="token number">121.37755</span><span class="token punctuation">,</span> pic<span class="token operator">=</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>m<span class="token punctuation">.</span>tuniucdn<span class="token punctuation">.</span>com<span class="token operator">/</span>fb3<span class="token operator">/</span>s1<span class="token operator">/</span><span class="token number">2</span>n9c<span class="token operator">/</span><span class="token number">3</span>mKs3jETvJDj3dDdkRB9UyLLvPna_w200_h200_c1_t0<span class="token punctuation">.</span>jpg<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="42"></td><td><pre>hotelDoc<span class="token operator">:</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">1400304687</span><span class="token punctuation">,</span> name<span class="token operator">=</span>如家酒店<span class="token punctuation">(</span>深圳横岗地铁站新马商贸城店<span class="token punctuation">)</span><span class="token punctuation">,</span> address<span class="token operator">=</span>龙岗大道横岗段<span class="token number">4004</span>号<span class="token punctuation">,</span> price<span class="token operator">=</span><span class="token number">149</span><span class="token punctuation">,</span> score<span class="token operator">=</span><span class="token number">43</span><span class="token punctuation">,</span> brand<span class="token operator">=</span>如家<span class="token punctuation">,</span> city<span class="token operator">=</span>深圳<span class="token punctuation">,</span> starName<span class="token operator">=</span>二钻<span class="token punctuation">,</span> business<span class="token operator">=</span>龙岗中心区<span class="token operator">/</span>大运新城<span class="token punctuation">,</span> location<span class="token operator">=</span><span class="token number">22.642629</span><span class="token punctuation">,</span> <span class="token number">114.202799</span><span class="token punctuation">,</span> pic<span class="token operator">=</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>m<span class="token punctuation">.</span>tuniucdn<span class="token punctuation">.</span>com<span class="token operator">/</span>fb2<span class="token operator">/</span>t1<span class="token operator">/</span><span class="token constant">G6</span><span class="token operator">/</span><span class="token constant">M00</span><span class="token operator">/</span><span class="token number">25</span><span class="token operator">/</span><span class="token number">5</span>A<span class="token operator">/</span><span class="token class-name">Cii</span><span class="token operator">-</span><span class="token class-name">TF3PFkiIb27dAAEqdDcKl3YAAEViQGVWY0AASqM960_w200_h200_c1_t0</span><span class="token punctuation">.</span>jpg<span class="token punctuation">)</span></pre></td></tr></table></figure><h6 id="99752-高亮"><a class="anchor" href="#99752-高亮">#</a> 9.9.7.5.2、高亮🎋</h6><p>高亮 API 包括请求 DSL 构建和结果解析两部分。我们先看请求的 DSL 构建：</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310141251993.png" alt="image-20231014125137358"></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Test</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testHighlight</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token comment">// 1. 准备 Request</span></pre></td></tr><tr><td data-num="5"></td><td><pre>   <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">"dkx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>   <span class="token comment">// 2. 准备 DSL</span></pre></td></tr><tr><td data-num="7"></td><td><pre>   <span class="token comment">// 2.1.query 查询</span></pre></td></tr><tr><td data-num="8"></td><td><pre>   request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token string">"all"</span><span class="token punctuation">,</span> <span class="token string">"如家"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>   <span class="token comment">// 2.2. 高亮</span></pre></td></tr><tr><td data-num="10"></td><td><pre>   request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">highlighter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HighlightBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                                <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                                <span class="token punctuation">.</span><span class="token function">requireFieldMatch</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                               <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>   <span class="token comment">// 3. 发送请求</span></pre></td></tr><tr><td data-num="15"></td><td><pre>   <span class="token class-name">SearchResponse</span> search<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>   <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      search <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>   <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>   <span class="token function">handle</span><span class="token punctuation">(</span>search<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">SearchResponse</span> search<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>   <span class="token comment">// 4. 解析响应</span></pre></td></tr><tr><td data-num="26"></td><td><pre>   <span class="token class-name">SearchHits</span> hits <span class="token operator">=</span> search<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>   <span class="token keyword">long</span> value <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>   <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"共搜索到"</span> <span class="token operator">+</span> value <span class="token operator">+</span> <span class="token string">"条数据"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>   <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hits1 <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> hits1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>      <span class="token class-name">String</span> json <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>      <span class="token class-name">HotelDoc</span> hotelDoc <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hotelDoc: "</span> <span class="token operator">+</span> hotelDoc<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token comment">//--------------------- 打印结果 ---------------------</span></pre></td></tr><tr><td data-num="37"></td><td><pre>共搜索到<span class="token number">30</span>条数据</pre></td></tr><tr><td data-num="38"></td><td><pre>hotelDoc<span class="token operator">:</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">339952837</span><span class="token punctuation">,</span> name<span class="token operator">=</span>如家酒店<span class="token punctuation">(</span>北京良乡西路店<span class="token punctuation">)</span><span class="token punctuation">,</span> address<span class="token operator">=</span>良乡西路<span class="token number">7</span>号<span class="token punctuation">,</span> price<span class="token operator">=</span><span class="token number">159</span><span class="token punctuation">,</span> score<span class="token operator">=</span><span class="token number">46</span><span class="token punctuation">,</span> brand<span class="token operator">=</span>如家<span class="token punctuation">,</span> city<span class="token operator">=</span>北京<span class="token punctuation">,</span> starName<span class="token operator">=</span>二钻<span class="token punctuation">,</span> business<span class="token operator">=</span>房山风景区<span class="token punctuation">,</span> location<span class="token operator">=</span><span class="token number">39.73167</span><span class="token punctuation">,</span> <span class="token number">116.132482</span><span class="token punctuation">,</span> pic<span class="token operator">=</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>m<span class="token punctuation">.</span>tuniucdn<span class="token punctuation">.</span>com<span class="token operator">/</span>fb3<span class="token operator">/</span>s1<span class="token operator">/</span><span class="token number">2</span>n9c<span class="token operator">/</span><span class="token number">3D</span>pgf5RTTzrxpeN5y3RLnRVtxMEA_w200_h200_c1_t0<span class="token punctuation">.</span>jpg<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="39"></td><td><pre>hotelDoc<span class="token operator">:</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">1455383931</span><span class="token punctuation">,</span> name<span class="token operator">=</span>如家酒店<span class="token punctuation">(</span>深圳宝安客运中心站店<span class="token punctuation">)</span><span class="token punctuation">,</span> address<span class="token operator">=</span>西乡河西金雅新苑<span class="token number">34</span>栋<span class="token punctuation">,</span> price<span class="token operator">=</span><span class="token number">169</span><span class="token punctuation">,</span> score<span class="token operator">=</span><span class="token number">45</span><span class="token punctuation">,</span> brand<span class="token operator">=</span>如家<span class="token punctuation">,</span> city<span class="token operator">=</span>深圳<span class="token punctuation">,</span> starName<span class="token operator">=</span>二钻<span class="token punctuation">,</span> business<span class="token operator">=</span>宝安商业区<span class="token punctuation">,</span> location<span class="token operator">=</span><span class="token number">22.590272</span><span class="token punctuation">,</span> <span class="token number">113.881933</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="40"></td><td><pre>                   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr></table></figure><p>从上面的打印结果中可以看到并没有找到高亮的部分啊。这是因为打印的是 source 的部分</p><p>高亮的部分在另一个部分中如下图所示：</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310141305411.png" alt="image-20231014130537007"></p><h6 id="997521-高亮结果解析"><a class="anchor" href="#997521-高亮结果解析">#</a> 9.9.7.5.2.1、高亮结果解析：</h6><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Test</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testHighlight</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token comment">// 1. 准备 Request</span></pre></td></tr><tr><td data-num="5"></td><td><pre>   <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">"dkx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>   <span class="token comment">// 2. 准备 DSL</span></pre></td></tr><tr><td data-num="7"></td><td><pre>   <span class="token comment">// 2.1.query 查询</span></pre></td></tr><tr><td data-num="8"></td><td><pre>   request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token string">"all"</span><span class="token punctuation">,</span> <span class="token string">"如家"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>   <span class="token comment">// 2.2. 高亮</span></pre></td></tr><tr><td data-num="10"></td><td><pre>   request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">highlighter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HighlightBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                                <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                                <span class="token punctuation">.</span><span class="token function">requireFieldMatch</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                               <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>   <span class="token comment">// 3. 发送请求</span></pre></td></tr><tr><td data-num="15"></td><td><pre>   <span class="token class-name">SearchResponse</span> search<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>   <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      search <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>   <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>   <span class="token function">handle</span><span class="token punctuation">(</span>search<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">SearchResponse</span> search<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>   <span class="token comment">// 4. 解析响应</span></pre></td></tr><tr><td data-num="26"></td><td><pre>   <span class="token class-name">SearchHits</span> hits <span class="token operator">=</span> search<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>   <span class="token keyword">long</span> value <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>   <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"共搜索到"</span> <span class="token operator">+</span> value <span class="token operator">+</span> <span class="token string">"条数据"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>   <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hits1 <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> hits1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>      <span class="token class-name">String</span> json <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>      <span class="token class-name">HotelDoc</span> hotelDoc <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>      <span class="token comment">// 获取高亮结果</span></pre></td></tr><tr><td data-num="34"></td><td><pre>      <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">HighlightField</span><span class="token punctuation">></span></span> highlightFields <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getHighlightFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>      <span class="token comment">// CollectionUtils：Spring 提供的工具类 isEmpty 判断 Map 集合是否为空</span></pre></td></tr><tr><td data-num="36"></td><td><pre>      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span> <span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>highlightFields<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="37"></td><td><pre>      <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>         <span class="token comment">// 根据字段名获取高亮结果</span></pre></td></tr><tr><td data-num="39"></td><td><pre>         <span class="token class-name">HighlightField</span> name <span class="token operator">=</span> highlightFields<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>         <span class="token comment">// 判断根据字段获取的内容是否为 null</span></pre></td></tr><tr><td data-num="41"></td><td><pre>         <span class="token keyword">if</span><span class="token punctuation">(</span>name <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="42"></td><td><pre>         <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>            <span class="token comment">// 获取高亮值</span></pre></td></tr><tr><td data-num="44"></td><td><pre>            <span class="token class-name">String</span> content <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">getFragments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>            <span class="token comment">// 覆盖非高亮结果</span></pre></td></tr><tr><td data-num="46"></td><td><pre>            hotelDoc<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>         <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hotelDoc: "</span> <span class="token operator">+</span> hotelDoc<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token comment">//----------------- 打印结果 -----------------</span></pre></td></tr><tr><td data-num="53"></td><td><pre>共搜索到<span class="token number">30</span>条数据</pre></td></tr><tr><td data-num="54"></td><td><pre>hotelDoc<span class="token operator">:</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">339952837</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token generics"><span class="token punctuation">&lt;</span>em<span class="token punctuation">></span></span>如家<span class="token operator">&lt;</span><span class="token operator">/</span>em<span class="token operator">></span>酒店<span class="token punctuation">(</span>北京良乡西路店<span class="token punctuation">)</span><span class="token punctuation">,</span> address<span class="token operator">=</span>良乡西路<span class="token number">7</span>号<span class="token punctuation">,</span> price<span class="token operator">=</span><span class="token number">159</span><span class="token punctuation">,</span> score<span class="token operator">=</span><span class="token number">46</span><span class="token punctuation">,</span> brand<span class="token operator">=</span>如家<span class="token punctuation">,</span> city<span class="token operator">=</span>北京<span class="token punctuation">,</span> starName<span class="token operator">=</span>二钻<span class="token punctuation">,</span> business<span class="token operator">=</span>房山风景区<span class="token punctuation">,</span> location<span class="token operator">=</span><span class="token number">39.73167</span><span class="token punctuation">,</span> <span class="token number">116.132482</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="55"></td><td><pre>                   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr></table></figure><blockquote><p><strong>总结</strong>：</p><ul><li><p>所有搜索 DSL 的构建，记住一个 API：</p><p>SearchRequest 的 source () 方法</p></li><li><p>高亮结果解析是参考 JSON 结果，逐层解析</p></li></ul></blockquote><h6 id="99753-距离排序"><a class="anchor" href="#99753-距离排序">#</a> 9.9.7.5.3、距离排序🎋</h6><p>距离排序与普通字段排序有所差异，API 如下：</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310141655675.png" alt="image-20231014165529717"></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Test</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testJvliSort</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token comment">// 1. 准备 Request</span></pre></td></tr><tr><td data-num="5"></td><td><pre>   <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">"dkx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>   <span class="token comment">// 2.3. 排序</span></pre></td></tr><tr><td data-num="7"></td><td><pre>   <span class="token class-name">String</span> location <span class="token operator">=</span> <span class="token string">"31.251433, 121.47522"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>   <span class="token keyword">if</span><span class="token punctuation">(</span>location <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token string">""</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>   <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token comment">// 2.4. 根据距离进行排序</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token class-name">SortBuilders</span><span class="token punctuation">.</span><span class="token function">geoDistanceSort</span><span class="token punctuation">(</span><span class="token string">"location"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                                                         <span class="token keyword">new</span> <span class="token class-name">GeoPoint</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                                                        <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                            <span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token class-name">SortOrder</span><span class="token punctuation">.</span><span class="token constant">ASC</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                            <span class="token punctuation">.</span><span class="token function">unit</span><span class="token punctuation">(</span><span class="token class-name">DistanceUnit</span><span class="token punctuation">.</span><span class="token constant">KILOMETERS</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                           <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>   <span class="token comment">// 3. 发送请求</span></pre></td></tr><tr><td data-num="19"></td><td><pre>   <span class="token class-name">SearchResponse</span> search<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>   <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      search <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>   <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>   <span class="token comment">// 4. 解析响应结果</span></pre></td></tr><tr><td data-num="26"></td><td><pre>   <span class="token function">handle</span><span class="token punctuation">(</span>search<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">SearchResponse</span> search<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>   <span class="token comment">// 4. 解析响应</span></pre></td></tr><tr><td data-num="31"></td><td><pre>   <span class="token class-name">SearchHits</span> hits <span class="token operator">=</span> search<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>   <span class="token keyword">long</span> value <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>   <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"共搜索到"</span> <span class="token operator">+</span> value <span class="token operator">+</span> <span class="token string">"条数据"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>   <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hits1 <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> hits1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>      <span class="token class-name">String</span> json <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>      <span class="token class-name">HotelDoc</span> hotelDoc <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>      <span class="token comment">// 获取高亮结果</span></pre></td></tr><tr><td data-num="39"></td><td><pre>      <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">HighlightField</span><span class="token punctuation">></span></span> highlightFields <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getHighlightFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>      <span class="token comment">// CollectionUtils：Spring 提供的工具类 isEmpty 判断 Map 集合是否为空</span></pre></td></tr><tr><td data-num="41"></td><td><pre>      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span> <span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>highlightFields<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="42"></td><td><pre>      <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>         <span class="token comment">// 根据字段名获取高亮结果</span></pre></td></tr><tr><td data-num="44"></td><td><pre>         <span class="token class-name">HighlightField</span> name <span class="token operator">=</span> highlightFields<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>         <span class="token comment">// 判断根据字段获取的内容是否为 null</span></pre></td></tr><tr><td data-num="46"></td><td><pre>         <span class="token keyword">if</span><span class="token punctuation">(</span>name <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="47"></td><td><pre>         <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>            <span class="token comment">// 获取高亮值</span></pre></td></tr><tr><td data-num="49"></td><td><pre>            <span class="token class-name">String</span> content <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">getFragments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>            <span class="token comment">// 覆盖非高亮结果</span></pre></td></tr><tr><td data-num="51"></td><td><pre>            hotelDoc<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>         <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hotelDoc: "</span> <span class="token operator">+</span> hotelDoc<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="57"></td><td><pre><span class="token comment">//-------------------- 打印结果 --------------------</span></pre></td></tr><tr><td data-num="58"></td><td><pre>共搜索到<span class="token number">201</span>条数据</pre></td></tr><tr><td data-num="59"></td><td><pre>hotelDoc<span class="token operator">:</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">36934</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token number">7</span>天连锁酒店<span class="token punctuation">(</span>上海宝山路地铁站店<span class="token punctuation">)</span><span class="token punctuation">,</span> address<span class="token operator">=</span>静安交通路<span class="token number">40</span>号<span class="token punctuation">,</span> price<span class="token operator">=</span><span class="token number">336</span><span class="token punctuation">,</span> score<span class="token operator">=</span><span class="token number">37</span><span class="token punctuation">,</span> brand<span class="token operator">=</span><span class="token number">7</span>天酒店<span class="token punctuation">,</span> city<span class="token operator">=</span>上海<span class="token punctuation">,</span> starName<span class="token operator">=</span>二钻<span class="token punctuation">,</span> business<span class="token operator">=</span>四川北路商业区<span class="token punctuation">,</span> location<span class="token operator">=</span><span class="token number">31.251433</span><span class="token punctuation">,</span> <span class="token number">121.47522</span><span class="token punctuation">,</span> pic<span class="token operator">=</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>m<span class="token punctuation">.</span>tuniucdn<span class="token punctuation">.</span>com<span class="token operator">/</span>fb2<span class="token operator">/</span>t1<span class="token operator">/</span><span class="token constant">G1</span><span class="token operator">/</span><span class="token constant">M00</span><span class="token operator">/</span><span class="token number">3</span>E<span class="token operator">/</span><span class="token number">40</span><span class="token operator">/</span><span class="token class-name">Cii9EVkyLrKIXo1vAAHgrxo_pUcAALcKQLD688AAeDH564_w200_h200_c1_t0</span><span class="token punctuation">.</span>jpg<span class="token punctuation">,</span> distance<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> isAD<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="60"></td><td><pre>hotelDoc<span class="token operator">:</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">60935</span><span class="token punctuation">,</span> name<span class="token operator">=</span>上海虹口三至喜来登酒店<span class="token punctuation">,</span> address<span class="token operator">=</span>四平路<span class="token number">59</span>号<span class="token punctuation">,</span> price<span class="token operator">=</span><span class="token number">1899</span><span class="token punctuation">,</span> score<span class="token operator">=</span><span class="token number">46</span><span class="token punctuation">,</span> brand<span class="token operator">=</span>喜来登<span class="token punctuation">,</span> city<span class="token operator">=</span>上海<span class="token punctuation">,</span> starName<span class="token operator">=</span>五星级<span class="token punctuation">,</span> business<span class="token operator">=</span>四川北路商业区<span class="token punctuation">,</span> location<span class="token operator">=</span><span class="token number">31.2579</span><span class="token punctuation">,</span> <span class="token number">121.487954</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="61"></td><td><pre>                   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr></table></figure><h6 id="99754-组合查询-function-score"><a class="anchor" href="#99754-组合查询-function-score">#</a> 9.9.7.5.4、组合查询 - function score🎋</h6><p>Function Score 查询可以控制文档的相关性算分，使用方式如下：</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310141739473.png" alt="image-20231014173905116"></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Test</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testFunctionScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token comment">// 1. 准备 Request</span></pre></td></tr><tr><td data-num="5"></td><td><pre>   <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">"dkx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>   <span class="token comment">// 2. 准备 DSL</span></pre></td></tr><tr><td data-num="7"></td><td><pre>   <span class="token comment">// 算分控制</span></pre></td></tr><tr><td data-num="8"></td><td><pre>   <span class="token class-name">FunctionScoreQueryBuilder</span> functionScoreQueryBuilder <span class="token operator">=</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">functionScoreQuery</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token comment">// 查询 name = 外滩</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"外滩"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token keyword">new</span> <span class="token class-name">FunctionScoreQueryBuilder<span class="token punctuation">.</span>FilterFunctionBuilder</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>         <span class="token keyword">new</span> <span class="token class-name">FunctionScoreQueryBuilder<span class="token punctuation">.</span>FilterFunctionBuilder</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token comment">// 过滤字段</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">"brand"</span><span class="token punctuation">,</span> <span class="token string">"如家"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token comment">// 加权</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token class-name">ScoreFunctionBuilders</span><span class="token punctuation">.</span><span class="token function">weightFactorFunction</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>         <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>   <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>   request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>functionScoreQueryBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>   <span class="token comment">// 3. 发送请求</span></pre></td></tr><tr><td data-num="23"></td><td><pre>   <span class="token class-name">SearchResponse</span> search<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>   <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>      search <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>   <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>   <span class="token function">handle</span><span class="token punctuation">(</span>search<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">SearchResponse</span> search<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>   <span class="token comment">// 4. 解析响应</span></pre></td></tr><tr><td data-num="34"></td><td><pre>   <span class="token class-name">SearchHits</span> hits <span class="token operator">=</span> search<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>   <span class="token keyword">long</span> value <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>   <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"共搜索到"</span> <span class="token operator">+</span> value <span class="token operator">+</span> <span class="token string">"条数据"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>   <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hits1 <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> hits1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>      <span class="token class-name">String</span> json <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>      <span class="token class-name">HotelDoc</span> hotelDoc <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>      <span class="token comment">// 获取高亮结果</span></pre></td></tr><tr><td data-num="42"></td><td><pre>      <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">HighlightField</span><span class="token punctuation">></span></span> highlightFields <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getHighlightFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>      <span class="token comment">// CollectionUtils：Spring 提供的工具类 isEmpty 判断 Map 集合是否为空</span></pre></td></tr><tr><td data-num="44"></td><td><pre>      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span> <span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>highlightFields<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="45"></td><td><pre>      <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>         <span class="token comment">// 根据字段名获取高亮结果</span></pre></td></tr><tr><td data-num="47"></td><td><pre>         <span class="token class-name">HighlightField</span> name <span class="token operator">=</span> highlightFields<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>         <span class="token comment">// 判断根据字段获取的内容是否为 null</span></pre></td></tr><tr><td data-num="49"></td><td><pre>         <span class="token keyword">if</span><span class="token punctuation">(</span>name <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="50"></td><td><pre>         <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>            <span class="token comment">// 获取高亮值</span></pre></td></tr><tr><td data-num="52"></td><td><pre>            <span class="token class-name">String</span> content <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">getFragments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>            <span class="token comment">// 覆盖非高亮结果</span></pre></td></tr><tr><td data-num="54"></td><td><pre>            hotelDoc<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>         <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hotelDoc: "</span> <span class="token operator">+</span> hotelDoc<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="59"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="60"></td><td><pre><span class="token comment">//--------------------- 打印结果 ---------------------</span></pre></td></tr><tr><td data-num="61"></td><td><pre>共搜索到<span class="token number">3</span>条数据</pre></td></tr><tr><td data-num="62"></td><td><pre>hotelDoc<span class="token operator">:</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">434082</span><span class="token punctuation">,</span> name<span class="token operator">=</span>如家酒店·<span class="token function">neo</span><span class="token punctuation">(</span>上海外滩城隍庙小南门地铁站店<span class="token punctuation">)</span><span class="token punctuation">,</span> address<span class="token operator">=</span>复兴东路<span class="token number">260</span>号<span class="token punctuation">,</span> price<span class="token operator">=</span><span class="token number">392</span><span class="token punctuation">,</span> score<span class="token operator">=</span><span class="token number">44</span><span class="token punctuation">,</span> brand<span class="token operator">=</span>如家<span class="token punctuation">,</span> city<span class="token operator">=</span>上海<span class="token punctuation">,</span> starName<span class="token operator">=</span>二钻<span class="token punctuation">,</span> business<span class="token operator">=</span>豫园地区<span class="token punctuation">,</span> location<span class="token operator">=</span><span class="token number">31.220706</span><span class="token punctuation">,</span> <span class="token number">121.498769</span><span class="token punctuation">,</span> pic<span class="token operator">=</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>m<span class="token punctuation">.</span>tuniucdn<span class="token punctuation">.</span>com<span class="token operator">/</span>fb2<span class="token operator">/</span>t1<span class="token operator">/</span><span class="token constant">G6</span><span class="token operator">/</span><span class="token constant">M00</span><span class="token operator">/</span><span class="token number">52</span><span class="token operator">/</span><span class="token constant">B6</span><span class="token operator">/</span><span class="token class-name">Cii</span><span class="token operator">-</span><span class="token class-name">U13eXLGIdHFzAAIG</span><span class="token operator">-</span><span class="token number">5</span>cEwDEAAGRfQNNIV0AAgcT627_w200_h200_c1_t0<span class="token punctuation">.</span>jpg<span class="token punctuation">,</span> distance<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> isAD<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="63"></td><td><pre>hotelDoc<span class="token operator">:</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">60487</span><span class="token punctuation">,</span> name<span class="token operator">=</span>上海外滩茂悦大酒店<span class="token punctuation">,</span> address<span class="token operator">=</span>黄浦路<span class="token number">199</span>号<span class="token punctuation">,</span> price<span class="token operator">=</span><span class="token number">689</span><span class="token punctuation">,</span> score<span class="token operator">=</span><span class="token number">44</span><span class="token punctuation">,</span> brand<span class="token operator">=</span>君悦<span class="token punctuation">,</span> city<span class="token operator">=</span>上海<span class="token punctuation">,</span> starName<span class="token operator">=</span>五星级<span class="token punctuation">,</span> business<span class="token operator">=</span>外滩地区<span class="token punctuation">,</span> location<span class="token operator">=</span><span class="token number">31.245409</span><span class="token punctuation">,</span> <span class="token number">121.492969</span><span class="token punctuation">,</span> pic<span class="token operator">=</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>m<span class="token punctuation">.</span>tuniucdn<span class="token punctuation">.</span>com<span class="token operator">/</span>fb3<span class="token operator">/</span>s1<span class="token operator">/</span><span class="token number">2</span>n9c<span class="token operator">/</span><span class="token number">2</span>Swp2h1fdj9zCUKsk63BQvVgKLTo_w200_h200_c1_t0<span class="token punctuation">.</span>jpg<span class="token punctuation">,</span> distance<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> isAD<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="64"></td><td><pre>hotelDoc<span class="token operator">:</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">432335</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token number">7</span>天连锁酒店<span class="token punctuation">(</span>上海北外滩国际客运中心地铁站店<span class="token punctuation">)</span><span class="token punctuation">,</span> address<span class="token operator">=</span>唐山路<span class="token number">145</span>号<span class="token punctuation">,</span> price<span class="token operator">=</span><span class="token number">249</span><span class="token punctuation">,</span> score<span class="token operator">=</span><span class="token number">35</span><span class="token punctuation">,</span> brand<span class="token operator">=</span><span class="token number">7</span>天酒店<span class="token punctuation">,</span> city<span class="token operator">=</span>上海<span class="token punctuation">,</span> starName<span class="token operator">=</span>二钻<span class="token punctuation">,</span> business<span class="token operator">=</span>北外滩地区<span class="token punctuation">,</span> location<span class="token operator">=</span><span class="token number">31.252585</span><span class="token punctuation">,</span> <span class="token number">121.498753</span><span class="token punctuation">,</span> pic<span class="token operator">=</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>m2<span class="token punctuation">.</span>tuniucdn<span class="token punctuation">.</span>com<span class="token operator">/</span>filebroker<span class="token operator">/</span>cdn<span class="token operator">/</span>res<span class="token operator">/</span>c1<span class="token operator">/</span>ba<span class="token operator">/</span>c1baf64418437c56617f89840c6411ef_w200_h200_c1_t0<span class="token punctuation">.</span>jpg<span class="token punctuation">,</span> distance<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> isAD<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">)</span></pre></td></tr></table></figure><h6 id="es-restclient黑马旅游案例项目地址httpsgiteecomdoukaixintyporagit"><a class="anchor" href="#es-restclient黑马旅游案例项目地址httpsgiteecomdoukaixintyporagit">#</a> ES-RestClient 黑马旅游案例，项目地址：<span class="exturl" data-url="aHR0cHM6Ly9naXRlZS5jb20vZG91a2FpeGluL3R5cG9yYS5naXQ=">https://gitee.com/doukaixin/typora.git</span></h6><h3 id="910-深入elasticsearch"><a class="anchor" href="#910-深入elasticsearch">#</a> 9.10、深入 elasticsearch🌳</h3><ul><li>数据聚合</li><li>自动补全</li><li>数据同步</li><li>集群</li></ul><h4 id="9101-数据聚合"><a class="anchor" href="#9101-数据聚合">#</a> 9.10.1、数据聚合🌲</h4><ul><li>聚合的种类</li><li>DSL 实现聚合</li><li>RestAPI 实现聚合</li></ul><h5 id="91011-聚合的分类"><a class="anchor" href="#91011-聚合的分类">#</a> 9.10.1.1、聚合的分类🌴</h5><p>聚合 (aggregations) 可以实现对文档数据的统计，分析，运算。聚合常见的有三类：</p><p>&lt;font color='red'&gt; 注意 &lt;/font&gt;：聚合的字段一定是不分词的。可以是 keyword，日期，数值，布尔，但绝对不可以是 text 类型的</p><ul><li>桶 (Bucket) 聚合：用来对文档做分组<ul><li>TermAggregation：按照文档字段值分组</li><li>Date Histogram：按照日期阶梯分组，例如 一周为一组，或者 一月为一组</li></ul></li><li>度量 (Metric) 聚合：用以计算一些值，比如：最大值，最小值，平均值等<ul><li>Avg：求平均值</li><li>Max：求最大值</li><li>Min：求最小值</li><li>Stats：同时求 max，min，avg，sum 等</li></ul></li><li>管道 (pipeline) 聚合：对其它聚合的结果为基础做聚合</li></ul><blockquote><p><strong>总结</strong>：</p><p>什么是聚合？</p><ul><li>聚合是对文档数据的统计，分析，计算</li></ul><p>聚合的常见种类有哪些？</p><ul><li>Bucket：对文档数据分组，并统计每组数量</li><li>Metric：对文档数据做计算，例如 avg</li><li>Pipeline：基于其它聚合结果再做聚合</li></ul><p>参与聚合的字段类型必须是：</p><ul><li>keyword</li><li>数值</li><li>日期</li><li>布尔</li></ul></blockquote><h6 id="910111-dsl实现bucket聚合"><a class="anchor" href="#910111-dsl实现bucket聚合">#</a> 9.10.1.1.1、DSL 实现 Bucket 聚合🎋</h6><p>现在，我们要统计所有数据中的酒店品牌有几种，此时可以根据酒店品牌的名称做聚合。</p><p>类型为 term 类型，DSL 示例：</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre>GET /indexName/_search</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>   <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 设置 size 为 0, 结果中不包含文档，只包含聚合结果</span></pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 定义聚合</span></pre></td></tr><tr><td data-num="5"></td><td><pre>      <span class="token property">"brandAgg"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 给聚合起个名字</span></pre></td></tr><tr><td data-num="6"></td><td><pre>         <span class="token property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 聚合的类型，按照品牌值聚合，所以选择 term</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"brand"</span><span class="token punctuation">,</span> <span class="token comment">// 参与聚合的字段</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">20</span> <span class="token comment">// 希望获取的聚合结果数量</span></pre></td></tr><tr><td data-num="9"></td><td><pre>         <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>代码演示：</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre># 聚合功能</pre></td></tr><tr><td data-num="2"></td><td><pre>GET /dkx/_search</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token property">"brandAgg"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"brand"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">10</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment">//----------------- 查询结果 -----------------</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token property">"buckets"</span> <span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>          <span class="token property">"key"</span> <span class="token operator">:</span> <span class="token string">"7天酒店"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre>          <span class="token property">"doc_count"</span> <span class="token operator">:</span> <span class="token number">30</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>          <span class="token property">"key"</span> <span class="token operator">:</span> <span class="token string">"如家"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="22"></td><td><pre>          <span class="token property">"doc_count"</span> <span class="token operator">:</span> <span class="token number">30</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>          <span class="token property">"key"</span> <span class="token operator">:</span> <span class="token string">"皇冠假日"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="26"></td><td><pre>          <span class="token property">"doc_count"</span> <span class="token operator">:</span> <span class="token number">17</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>          <span class="token property">"key"</span> <span class="token operator">:</span> <span class="token string">"速8"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="30"></td><td><pre>          <span class="token property">"doc_count"</span> <span class="token operator">:</span> <span class="token number">15</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="32"></td><td><pre>   ...</pre></td></tr></table></figure><p>默认是倒序排序值越大的越靠前，排序的规则是可以进行修改的</p><h6 id="910112-bucket聚合-聚合结果排序"><a class="anchor" href="#910112-bucket聚合-聚合结果排序">#</a> 9.10.1.1.2、Bucket 聚合 - 聚合结果排序🎋</h6><p>默认情况下，Bucket 聚合会统计 Bucket 内的文档数量，记为 <code>_count</code> ，并按照 <code>_count</code> 降序排序。</p><p>我们可以修改结果排序方式：</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre>GET /indexName/_search</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>   <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>      <span class="token property">"brandAgg"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>         <span class="token property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"brand"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token property">"order"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>               <span class="token property">"_count"</span><span class="token operator">:</span> <span class="token string">"asc"</span> <span class="token comment">// 按照_count 升序排列</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">20</span></pre></td></tr><tr><td data-num="12"></td><td><pre>         <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>代码演示：</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre># 聚合功能</pre></td></tr><tr><td data-num="2"></td><td><pre>GET /dkx/_search</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token property">"brandAgg"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"brand"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token property">"order"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>          <span class="token property">"_count"</span><span class="token operator">:</span> <span class="token string">"asc"</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">//-------------- 打印结果 --------------</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token property">"brandAgg"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      <span class="token property">"doc_count_error_upper_bound"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token property">"sum_other_doc_count"</span> <span class="token operator">:</span> <span class="token number">130</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      <span class="token property">"buckets"</span> <span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>          <span class="token property">"key"</span> <span class="token operator">:</span> <span class="token string">"万丽"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="24"></td><td><pre>          <span class="token property">"doc_count"</span> <span class="token operator">:</span> <span class="token number">2</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>          <span class="token property">"key"</span> <span class="token operator">:</span> <span class="token string">"丽笙"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="28"></td><td><pre>          <span class="token property">"doc_count"</span> <span class="token operator">:</span> <span class="token number">2</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>          <span class="token property">"key"</span> <span class="token operator">:</span> <span class="token string">"君悦"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="32"></td><td><pre>          <span class="token property">"doc_count"</span> <span class="token operator">:</span> <span class="token number">4</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="34"></td><td><pre>         ...</pre></td></tr></table></figure><h6 id="910113-bucket聚合-限定聚合范围"><a class="anchor" href="#910113-bucket聚合-限定聚合范围">#</a> 9.10.1.1.3、Bucket 聚合 - 限定聚合范围🎋</h6><p>默认情况下，Bucket 聚合是对索引库的所有文档做聚合，我们可以限定要聚合的文档范围，只要添加 query 条件即可。</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre>GET /indexName/_search</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>   <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>      <span class="token property">"range"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>         <span class="token property">"price"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>            <span class="token property">"lte"</span><span class="token operator">:</span> <span class="token number">200</span> <span class="token comment">// 只对 200 元以下的文档聚合</span></pre></td></tr><tr><td data-num="7"></td><td><pre>         <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>   <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>   <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>   <span class="token property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token property">"brandAgg"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>         <span class="token property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"brand"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="16"></td><td><pre>         <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>代码演示：</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre># 聚合功能，限定聚合范围</pre></td></tr><tr><td data-num="2"></td><td><pre>GET /dkx/_search</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token property">"range"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>      <span class="token property">"price"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token property">"lte"</span><span class="token operator">:</span> <span class="token number">200</span></pre></td></tr><tr><td data-num="8"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token property">"brandAgg"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"brand"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token property">"order"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>          <span class="token property">"_count"</span><span class="token operator">:</span> <span class="token string">"asc"</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment">//---------------- 打印结果 ----------------</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token property">"buckets"</span> <span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>          <span class="token property">"key"</span> <span class="token operator">:</span> <span class="token string">"7天酒店"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="28"></td><td><pre>          <span class="token property">"doc_count"</span> <span class="token operator">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>          <span class="token property">"key"</span> <span class="token operator">:</span> <span class="token string">"汉庭"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="32"></td><td><pre>          <span class="token property">"doc_count"</span> <span class="token operator">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>          <span class="token property">"key"</span> <span class="token operator">:</span> <span class="token string">"速8"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="36"></td><td><pre>          <span class="token property">"doc_count"</span> <span class="token operator">:</span> <span class="token number">2</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>          <span class="token property">"key"</span> <span class="token operator">:</span> <span class="token string">"如家"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="40"></td><td><pre>          <span class="token property">"doc_count"</span> <span class="token operator">:</span> <span class="token number">13</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>      <span class="token punctuation">]</span></pre></td></tr></table></figure><blockquote><p><strong>总结</strong>：</p><p>aggs 代表聚合，与 query 同级，此时 query 的作用是？</p><ul><li>限定聚合的文档范围</li></ul><p>聚合必须得三要素：</p><ul><li>聚合名称</li><li>聚合类型</li><li>聚合字段</li></ul><p>聚合可配置属性有：</p><ul><li>size：指定聚合结果数量</li><li>order：指定聚合结果排序方式</li><li>field：指定聚合字段</li></ul></blockquote><h6 id="910114-dsl实现metrics聚合"><a class="anchor" href="#910114-dsl实现metrics聚合">#</a> 9.10.1.1.4、DSL 实现 Metrics 聚合🎋</h6><p>例如，我们要求获取每个品牌的用户评分的 min，max，avg 等值。</p><p>我们可以利用 stats 聚合：</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre>GET /indexName/_search</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>   <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>      <span class="token property">"brandAgg"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>         <span class="token property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"brand"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">20</span></pre></td></tr><tr><td data-num="9"></td><td><pre>         <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>         <span class="token property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 是 brands 聚合的子聚合，也就是分组后每组分别计算</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token property">"score_stats"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 聚合名称</span></pre></td></tr><tr><td data-num="12"></td><td><pre>               <span class="token property">"stats"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 聚合类型，这里 stats 可以计算 min，max，avg 等</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                  <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"score"</span> <span class="token comment">// 聚合字段，这里是 score</span></pre></td></tr><tr><td data-num="14"></td><td><pre>               <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>         <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>代码演示：</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre># 嵌套聚合metrics</pre></td></tr><tr><td data-num="2"></td><td><pre>GET /dkx/_search</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token property">"brandAgg"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"brand"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">20</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token property">"score_stats"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>          <span class="token property">"stats"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"score"</span></pre></td></tr><tr><td data-num="15"></td><td><pre>          <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment">//------------------------- 打印结果 -------------------------</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token property">"buckets"</span> <span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>          <span class="token property">"key"</span> <span class="token operator">:</span> <span class="token string">"7天酒店"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="25"></td><td><pre>          <span class="token property">"doc_count"</span> <span class="token operator">:</span> <span class="token number">30</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="26"></td><td><pre>          <span class="token property">"score_stats"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token property">"count"</span> <span class="token operator">:</span> <span class="token number">30</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token property">"min"</span> <span class="token operator">:</span> <span class="token number">35.0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="29"></td><td><pre>            <span class="token property">"max"</span> <span class="token operator">:</span> <span class="token number">43.0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token property">"avg"</span> <span class="token operator">:</span> <span class="token number">37.86666666666667</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="31"></td><td><pre>            <span class="token property">"sum"</span> <span class="token operator">:</span> <span class="token number">1136.0</span></pre></td></tr><tr><td data-num="32"></td><td><pre>          <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>          <span class="token property">"key"</span> <span class="token operator">:</span> <span class="token string">"如家"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="36"></td><td><pre>          <span class="token property">"doc_count"</span> <span class="token operator">:</span> <span class="token number">30</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="37"></td><td><pre>          <span class="token property">"score_stats"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>            <span class="token property">"count"</span> <span class="token operator">:</span> <span class="token number">30</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="39"></td><td><pre>            <span class="token property">"min"</span> <span class="token operator">:</span> <span class="token number">43.0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="40"></td><td><pre>            <span class="token property">"max"</span> <span class="token operator">:</span> <span class="token number">47.0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="41"></td><td><pre>            <span class="token property">"avg"</span> <span class="token operator">:</span> <span class="token number">44.833333333333336</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="42"></td><td><pre>            <span class="token property">"sum"</span> <span class="token operator">:</span> <span class="token number">1345.0</span></pre></td></tr><tr><td data-num="43"></td><td><pre>          <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="45"></td><td><pre>   ...</pre></td></tr></table></figure><p>对 score_stats 中的 avg 做一个排序</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre># 嵌套聚合metrics</pre></td></tr><tr><td data-num="2"></td><td><pre>GET /dkx/_search</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token property">"brandAgg"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"brand"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token property">"order"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>          <span class="token property">"score_stats.avg"</span><span class="token operator">:</span> <span class="token string">"desc"</span> <span class="token comment">// 对 score_stats 中的 avg 进行降序排序</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token property">"score_stats"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>          <span class="token property">"stats"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"score"</span></pre></td></tr><tr><td data-num="18"></td><td><pre>          <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment">//---------------------- 打印结果 ----------------------</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token property">"buckets"</span> <span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>          <span class="token property">"key"</span> <span class="token operator">:</span> <span class="token string">"万丽"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="28"></td><td><pre>          <span class="token property">"doc_count"</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="29"></td><td><pre>          <span class="token property">"score_stats"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token property">"count"</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="31"></td><td><pre>            <span class="token property">"min"</span> <span class="token operator">:</span> <span class="token number">46.0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="32"></td><td><pre>            <span class="token property">"max"</span> <span class="token operator">:</span> <span class="token number">47.0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="33"></td><td><pre>            <span class="token property">"avg"</span> <span class="token operator">:</span> <span class="token number">46.5</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="34"></td><td><pre>            <span class="token property">"sum"</span> <span class="token operator">:</span> <span class="token number">93.0</span></pre></td></tr><tr><td data-num="35"></td><td><pre>          <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>          <span class="token property">"key"</span> <span class="token operator">:</span> <span class="token string">"凯悦"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="39"></td><td><pre>          <span class="token property">"doc_count"</span> <span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="40"></td><td><pre>          <span class="token property">"score_stats"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>            <span class="token property">"count"</span> <span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="42"></td><td><pre>            <span class="token property">"min"</span> <span class="token operator">:</span> <span class="token number">45.0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="43"></td><td><pre>            <span class="token property">"max"</span> <span class="token operator">:</span> <span class="token number">47.0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="44"></td><td><pre>            <span class="token property">"avg"</span> <span class="token operator">:</span> <span class="token number">46.25</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="45"></td><td><pre>            <span class="token property">"sum"</span> <span class="token operator">:</span> <span class="token number">370.0</span></pre></td></tr><tr><td data-num="46"></td><td><pre>          <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="48"></td><td><pre>   ...</pre></td></tr></table></figure><h5 id="91012-restapi实现聚合"><a class="anchor" href="#91012-restapi实现聚合">#</a> 9.10.1.2、RestAPI 实现聚合🌴</h5><p>我们以品牌聚合为例，演示下 Java 的 RestClient 使用，先看请求组装：</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310142115151.png" alt="image-20231014211458877"></p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre>@Test</pre></td></tr><tr><td data-num="2"></td><td><pre>public void testAggreation()</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token comment">// 1. 准备 Request</span></pre></td></tr><tr><td data-num="5"></td><td><pre>   SearchRequest request = new SearchRequest(<span class="token string">"dkx"</span>);</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">// 2. 准备 DSL</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">// 2.1. 设置 size 去掉文档数据</span></pre></td></tr><tr><td data-num="8"></td><td><pre>request.source().size(<span class="token number">0</span>);</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">// 2.2. 聚合</span></pre></td></tr><tr><td data-num="10"></td><td><pre>request.source().aggregation(AggregationBuilders</pre></td></tr><tr><td data-num="11"></td><td><pre>                             .terms(<span class="token string">"brandAgg"</span>)</pre></td></tr><tr><td data-num="12"></td><td><pre>                             .field(<span class="token string">"brand"</span>)</pre></td></tr><tr><td data-num="13"></td><td><pre>                             .size(<span class="token number">10</span>)</pre></td></tr><tr><td data-num="14"></td><td><pre>                            );</pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment">// 3. 发送请求</span></pre></td></tr><tr><td data-num="16"></td><td><pre>SearchResponse search;</pre></td></tr><tr><td data-num="17"></td><td><pre>try <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>   search = client.search(request<span class="token punctuation">,</span> RequestOptions.DEFAULT);</pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span> catch (IOException e) <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>   throw new RuntimeException(e);</pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>System.out.println(search);</pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment">//-------------------- 打印结果 --------------------</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">&#123;</span><span class="token property">"took"</span><span class="token operator">:</span><span class="token number">83</span><span class="token punctuation">,</span><span class="token property">"timed_out"</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">"_shards"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"total"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"successful"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"skipped"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">"failed"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token property">"hits"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"total"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"value"</span><span class="token operator">:</span><span class="token number">201</span><span class="token punctuation">,</span><span class="token property">"relation"</span><span class="token operator">:</span><span class="token string">"eq"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token property">"max_score"</span><span class="token operator">:</span><span class="token null keyword">null</span><span class="token punctuation">,</span><span class="token property">"hits"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token property">"aggregations"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"sterms#brandAgg"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"doc_count_error_upper_bound"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">"sum_other_doc_count"</span><span class="token operator">:</span><span class="token number">39</span><span class="token punctuation">,</span><span class="token property">"buckets"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">&#123;</span><span class="token property">"key"</span><span class="token operator">:</span><span class="token string">"7天酒店"</span><span class="token punctuation">,</span><span class="token property">"doc_count"</span><span class="token operator">:</span><span class="token number">30</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token property">"key"</span><span class="token operator">:</span><span class="token string">"如家"</span><span class="token punctuation">,</span><span class="token property">"doc_count"</span><span class="token operator">:</span><span class="token number">30</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token property">"key"</span><span class="token operator">:</span><span class="token string">"皇冠假日"</span><span class="token punctuation">,</span><span class="token property">"doc_count"</span><span class="token operator">:</span><span class="token number">17</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token property">"key"</span><span class="token operator">:</span><span class="token string">"速8"</span><span class="token punctuation">,</span><span class="token property">"doc_count"</span><span class="token operator">:</span><span class="token number">15</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token property">"key"</span><span class="token operator">:</span><span class="token string">"万怡"</span><span class="token punctuation">,</span><span class="token property">"doc_count"</span><span class="token operator">:</span><span class="token number">13</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token property">"key"</span><span class="token operator">:</span><span class="token string">"华美达"</span><span class="token punctuation">,</span><span class="token property">"doc_count"</span><span class="token operator">:</span><span class="token number">13</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token property">"key"</span><span class="token operator">:</span><span class="token string">"和颐"</span><span class="token punctuation">,</span><span class="token property">"doc_count"</span><span class="token operator">:</span><span class="token number">12</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token property">"key"</span><span class="token operator">:</span><span class="token string">"万豪"</span><span class="token punctuation">,</span><span class="token property">"doc_count"</span><span class="token operator">:</span><span class="token number">11</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token property">"key"</span><span class="token operator">:</span><span class="token string">"喜来登"</span><span class="token punctuation">,</span><span class="token property">"doc_count"</span><span class="token operator">:</span><span class="token number">11</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token property">"key"</span><span class="token operator">:</span><span class="token string">"希尔顿"</span><span class="token punctuation">,</span><span class="token property">"doc_count"</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h6 id="910121-聚合结果解析"><a class="anchor" href="#910121-聚合结果解析">#</a> 9.10.1.2.1、聚合结果解析🌴</h6><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310142127780.png" alt="image-20231014212710555"></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Test</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testAggreation</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token comment">// 1. 准备 Request</span></pre></td></tr><tr><td data-num="5"></td><td><pre>   <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">"dkx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>   <span class="token comment">// 2. 准备 DSL</span></pre></td></tr><tr><td data-num="7"></td><td><pre>   <span class="token comment">// 2.1. 设置 size 去掉文档数据</span></pre></td></tr><tr><td data-num="8"></td><td><pre>   request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>   <span class="token comment">// 2.2. 聚合</span></pre></td></tr><tr><td data-num="10"></td><td><pre>   request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">aggregation</span><span class="token punctuation">(</span><span class="token class-name">AggregationBuilders</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                                <span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">"brandAgg"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                                <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"brand"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                                <span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                               <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>   <span class="token comment">// 3. 发送请求</span></pre></td></tr><tr><td data-num="16"></td><td><pre>   <span class="token class-name">SearchResponse</span> search<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>   <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      search <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>   <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>   <span class="token comment">// 4. 调用函数解析响应结果</span></pre></td></tr><tr><td data-num="23"></td><td><pre>   <span class="token function">handleAgg</span><span class="token punctuation">(</span>search<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleAgg</span><span class="token punctuation">(</span><span class="token class-name">SearchResponse</span> search<span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>   <span class="token class-name">Aggregations</span> aggregations <span class="token operator">=</span> search<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>   <span class="token comment">// 4.1. 根据聚合名称获取聚合结果</span></pre></td></tr><tr><td data-num="30"></td><td><pre>   <span class="token class-name">Terms</span> brandTerms <span class="token operator">=</span> aggregations<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"brandAgg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>   <span class="token comment">// 4.2. 获取 Buckets</span></pre></td></tr><tr><td data-num="32"></td><td><pre>   <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Terms<span class="token punctuation">.</span>Bucket</span><span class="token punctuation">></span></span> buckets <span class="token operator">=</span> brandTerms<span class="token punctuation">.</span><span class="token function">getBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>   <span class="token comment">// 4.3. 遍历桶</span></pre></td></tr><tr><td data-num="34"></td><td><pre>   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Terms<span class="token punctuation">.</span>Bucket</span> bucket <span class="token operator">:</span> buckets<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>      <span class="token comment">// 4.4. 获取 key</span></pre></td></tr><tr><td data-num="36"></td><td><pre>      <span class="token class-name">String</span> keyAsString <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">getKeyAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>keyAsString<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token comment">//------------------- 打印结果 -------------------</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token number">7</span>天酒店</pre></td></tr><tr><td data-num="42"></td><td><pre>如家</pre></td></tr><tr><td data-num="43"></td><td><pre>皇冠假日</pre></td></tr><tr><td data-num="44"></td><td><pre>速<span class="token number">8</span></pre></td></tr><tr><td data-num="45"></td><td><pre>万怡</pre></td></tr><tr><td data-num="46"></td><td><pre>华美达</pre></td></tr><tr><td data-num="47"></td><td><pre>和颐</pre></td></tr><tr><td data-num="48"></td><td><pre>万豪</pre></td></tr><tr><td data-num="49"></td><td><pre>喜来登</pre></td></tr><tr><td data-num="50"></td><td><pre>希尔顿</pre></td></tr></table></figure><h4 id="9102-自动补全"><a class="anchor" href="#9102-自动补全">#</a> 9.10.2、自动补全🌲</h4><ul><li>拼音分词器</li><li>自定义分词器</li><li>自动补全查询</li><li>实现酒店搜索框自动补全</li></ul><h5 id="91021-自动补全需求说明"><a class="anchor" href="#91021-自动补全需求说明">#</a> 9.10.2.1、自动补全需求说明🌴</h5><p>当用户在搜索框输入字符时，我们应该提示出与该字符有关的搜索项，如图：</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310142231178.png" alt="image-20231014223100805"></p><h5 id="91022-使用拼音分词"><a class="anchor" href="#91022-使用拼音分词">#</a> 9.10.2.2、使用拼音分词🌴</h5><p>要实现根据字母做不全，就必须对文档按照拼音分词。在 GitHub 上恰好有 elasticsearch 的拼音分词插件。地址：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL21lZGNsL2VsYXN0aWNzZWFyY2gtYW5hbHlzaXMtcGlueWluL3JlbGVhc2Vz">https://github.com/medcl/elasticsearch-analysis-pinyin/releases</span></p><p>安装方式与 IK 分词器一样，分三步：</p><p>1、解压</p><p>2、上传到虚拟机中，elasticsearch 的 plugin 目录</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310142242869.png" alt="image-20231014224223983"></p><p>3、重启 elasticsearch</p><figure class="highlight sh"><figcaption data-lang="sh"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@192 _data<span class="token punctuation">]</span><span class="token comment"># docker restart es</span></pre></td></tr><tr><td data-num="2"></td><td><pre>es</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>root@192 _data<span class="token punctuation">]</span><span class="token comment">#</span></pre></td></tr></table></figure><p>4、测试</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310142248099.png" alt="image-20231014224855664"></p><h5 id="91023-自定义分词器"><a class="anchor" href="#91023-自定义分词器">#</a> 9.10.2.3、自定义分词器🌴</h5><p>elasticsearch 中分词器 (analyzer) 的组成包含三部分：</p><ul><li>character filters：在 tokenizer 之前对本文进行处理。例如删除字符，替换字符</li><li>tokenizer：将文本按照一定的规则切割成词条 (term)。例如 keyword，就是不分词；还有 ik_smart</li><li>tokenizer filter：将 tokenizer 输出的词条做进一步处理。例如大小写转换，同义词处理，拼音处理等</li></ul><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310151109094.png" alt="image-20231015110900632"></p><p>我们可以在创建索引库时，通过 settings 来配置自定义的 analyzer (分词器)：</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310151115651.png" alt="image-20231015111515104"></p><p>代码演示：</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre># 自定义分词器</pre></td></tr><tr><td data-num="2"></td><td><pre>PUT /test</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token property">"settings"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token property">"analysis"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>      <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token property">"my_analzer"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>          <span class="token property">"tokenizer"</span><span class="token operator">:</span> <span class="token string">"ik_max_word"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>          <span class="token property">"filter"</span><span class="token operator">:</span> <span class="token string">"py"</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token property">"filter"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token property">"py"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"pinyin"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>          <span class="token property">"keep_full_pinyin"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="16"></td><td><pre>          <span class="token property">"keep_joined_full_pinyin"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>          <span class="token property">"keep_original"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre>          <span class="token property">"limit_first_letter_length"</span><span class="token operator">:</span> <span class="token number">16</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>          <span class="token property">"remove_duplicated_term"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>          <span class="token property">"none_chinese_pinyin_tokenize"</span><span class="token operator">:</span> <span class="token boolean">false</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"my_analzer"</span></pre></td></tr><tr><td data-num="30"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>测试</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre>POST /test/_analyze <span class="token comment">// 使用 my_analzer 自定义分词器需要带上 test 索引库名</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token property">"text"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"如家酒店还不错嘛"</span><span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"my_analzer"</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">//------------------ 查询结果 ------------------</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token property">"tokens"</span> <span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token property">"token"</span> <span class="token operator">:</span> <span class="token string">"如家"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token property">"start_offset"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token property">"end_offset"</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token property">"type"</span> <span class="token operator">:</span> <span class="token string">"CN_WORD"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token property">"position"</span> <span class="token operator">:</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token property">"token"</span> <span class="token operator">:</span> <span class="token string">"rujia"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token property">"start_offset"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      <span class="token property">"end_offset"</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      <span class="token property">"type"</span> <span class="token operator">:</span> <span class="token string">"CN_WORD"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token property">"position"</span> <span class="token operator">:</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>      <span class="token property">"token"</span> <span class="token operator">:</span> <span class="token string">"rj"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="24"></td><td><pre>      <span class="token property">"start_offset"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="25"></td><td><pre>      <span class="token property">"end_offset"</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="26"></td><td><pre>      <span class="token property">"type"</span> <span class="token operator">:</span> <span class="token string">"CN_WORD"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="27"></td><td><pre>      <span class="token property">"position"</span> <span class="token operator">:</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>      <span class="token property">"token"</span> <span class="token operator">:</span> <span class="token string">"酒店"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="31"></td><td><pre>      <span class="token property">"start_offset"</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="32"></td><td><pre>      <span class="token property">"end_offset"</span> <span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="33"></td><td><pre>      <span class="token property">"type"</span> <span class="token operator">:</span> <span class="token string">"CN_WORD"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="34"></td><td><pre>      <span class="token property">"position"</span> <span class="token operator">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>      <span class="token property">"token"</span> <span class="token operator">:</span> <span class="token string">"jiudian"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="38"></td><td><pre>      <span class="token property">"start_offset"</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="39"></td><td><pre>      <span class="token property">"end_offset"</span> <span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="40"></td><td><pre>      <span class="token property">"type"</span> <span class="token operator">:</span> <span class="token string">"CN_WORD"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="41"></td><td><pre>      <span class="token property">"position"</span> <span class="token operator">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>      <span class="token property">"token"</span> <span class="token operator">:</span> <span class="token string">"jd"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="45"></td><td><pre>      <span class="token property">"start_offset"</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="46"></td><td><pre>      <span class="token property">"end_offset"</span> <span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="47"></td><td><pre>      <span class="token property">"type"</span> <span class="token operator">:</span> <span class="token string">"CN_WORD"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="48"></td><td><pre>      <span class="token property">"position"</span> <span class="token operator">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="50"></td><td><pre>   ...</pre></td></tr></table></figure><p>添加两个 name 字段然后再通过拼音测试是否能查询到</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre>POST /test/_doc/<span class="token number">1</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"狮子"</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>POST /test/_doc/<span class="token number">2</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"柿子"</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>查询测试：</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre>GET /test/_search</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token property">"match"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"shizi"</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">//---------------------- 查询结果 ----------------------</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token property">"hits"</span> <span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token property">"_index"</span> <span class="token operator">:</span> <span class="token string">"test"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token property">"_type"</span> <span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token property">"_id"</span> <span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token property">"_score"</span> <span class="token operator">:</span> <span class="token number">0.25069216</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token property">"_source"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>          <span class="token property">"id"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre>          <span class="token property">"name"</span> <span class="token operator">:</span> <span class="token string">"狮子"</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token property">"_index"</span> <span class="token operator">:</span> <span class="token string">"test"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token property">"_type"</span> <span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token property">"_id"</span> <span class="token operator">:</span> <span class="token string">"2"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token property">"_score"</span> <span class="token operator">:</span> <span class="token number">0.25069216</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token property">"_source"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>          <span class="token property">"id"</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="28"></td><td><pre>          <span class="token property">"name"</span> <span class="token operator">:</span> <span class="token string">"柿子"</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token punctuation">]</span></pre></td></tr></table></figure><p>但是有个问题，如果查询的是中文的 “狮子” 也就查询出同音的结果测试如下：</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre>GET /test/_search</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token property">"match"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"掉入狮子笼"</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">//-------------------- 查询结果 --------------------</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token property">"hits"</span> <span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token property">"_index"</span> <span class="token operator">:</span> <span class="token string">"test"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token property">"_type"</span> <span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token property">"_id"</span> <span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token property">"_score"</span> <span class="token operator">:</span> <span class="token number">0.33425623</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token property">"_source"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>          <span class="token property">"id"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre>          <span class="token property">"name"</span> <span class="token operator">:</span> <span class="token string">"狮子"</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token property">"_index"</span> <span class="token operator">:</span> <span class="token string">"test"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token property">"_type"</span> <span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token property">"_id"</span> <span class="token operator">:</span> <span class="token string">"2"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token property">"_score"</span> <span class="token operator">:</span> <span class="token number">0.3085442</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token property">"_source"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>          <span class="token property">"id"</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="28"></td><td><pre>          <span class="token property">"name"</span> <span class="token operator">:</span> <span class="token string">"柿子"</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token punctuation">]</span></pre></td></tr></table></figure><p>拼音分词器合适在创建倒排索引的时候使用，但不能在搜索的时候使用。</p><p>创建倒排索引时：</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310151144762.png" alt="image-20231015114300456"></p><p>我们要分开，创建时和搜索时使用不同的分词器</p><p>因此字段在创建倒排索引时应该用 <code>my_analyer</code> 分词器，字段在搜索时应该使用 <code>ik_smart</code> 分词器；</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre># 自定义分词器</pre></td></tr><tr><td data-num="2"></td><td><pre>PUT /test</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token property">"settings"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token property">"analysis"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>      <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token property">"my_analzer"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>          <span class="token property">"tokenizer"</span><span class="token operator">:</span> <span class="token string">"ik_max_word"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>          <span class="token property">"filter"</span><span class="token operator">:</span> <span class="token string">"py"</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token property">"filter"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token property">"py"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>          ...</pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"my_analzer"</span><span class="token punctuation">,</span> <span class="token comment">// 创建索引时使用的分词器</span></pre></td></tr><tr><td data-num="24"></td><td><pre>         <span class="token property">"search_analyzer"</span><span class="token operator">:</span> <span class="token string">"ik_smart"</span> <span class="token comment">// 搜索时使用的分词器</span></pre></td></tr><tr><td data-num="25"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>代码演示：</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre># 自定义分词器</pre></td></tr><tr><td data-num="2"></td><td><pre>PUT /test</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token property">"settings"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token property">"analysis"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>      <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token property">"my_analzer"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>          <span class="token property">"tokenizer"</span><span class="token operator">:</span> <span class="token string">"ik_max_word"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>          <span class="token property">"filter"</span><span class="token operator">:</span> <span class="token string">"py"</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token property">"filter"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token property">"py"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"pinyin"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>          <span class="token property">"keep_full_pinyin"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="16"></td><td><pre>          <span class="token property">"keep_joined_full_pinyin"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>          <span class="token property">"keep_original"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre>          <span class="token property">"limit_first_letter_length"</span><span class="token operator">:</span> <span class="token number">16</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>          <span class="token property">"remove_duplicated_term"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>          <span class="token property">"none_chinese_pinyin_tokenize"</span><span class="token operator">:</span> <span class="token boolean">false</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"my_analzer"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token property">"search_analyzer"</span><span class="token operator">:</span> <span class="token string">"ik_smart"</span></pre></td></tr><tr><td data-num="31"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>POST /test/_doc/<span class="token number">1</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>  <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="39"></td><td><pre>  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"狮子"</span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>POST /test/_doc/<span class="token number">2</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>  <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="45"></td><td><pre>  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"柿子"</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>测试查询结果：</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre>GET /test/_search</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token property">"match"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"掉入狮子笼"</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">//--------------------- 查询结果 ---------------------</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token property">"hits"</span> <span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token property">"_index"</span> <span class="token operator">:</span> <span class="token string">"test"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token property">"_type"</span> <span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token property">"_id"</span> <span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token property">"_score"</span> <span class="token operator">:</span> <span class="token number">0.9530773</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token property">"_source"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>          <span class="token property">"id"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre>          <span class="token property">"name"</span> <span class="token operator">:</span> <span class="token string">"狮子"</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">]</span></pre></td></tr></table></figure><blockquote><p>总结：</p><p>如何使用拼音分词器？</p><ol><li>下载 pinyin 分词器</li><li>解压并放到 elasticsearch 的 plugin 目录</li><li>重启即可</li></ol><p>如何自定义分词器？</p><ol><li>创建索引库时，在 settings 中配置，可以包含三部分</li><li>character filter</li><li>tokenizer</li><li>filter</li></ol><p>拼音分词器注意事项？</p><ul><li>为了避免搜索到同音字，搜索时不要使用拼音分词器</li></ul></blockquote><h5 id="91024-completion-suggester查询"><a class="anchor" href="#91024-completion-suggester查询">#</a> 9.10.2.4、completion suggester 查询🌴</h5><p>elasticsearch 提供了 Completion Suggester 查询来实现自动补全功能。这个查询会匹配以用户输入内容开头的词条并返回。为了提高补全查询的效率，对于文档中字段的类型有一些约束</p><ul><li>参与补全查询的字段必须是 completion 类型。</li><li>字段的内容一般是用来补全的多个词条形成的数组。</li></ul><p>文档中 title：[“Sony”, “WH-1000XM3”] 。字段值是一个数组，“品牌”, “产品”。它是形成了两个词条而不是一个词条为什么要分开呢？</p><p>原因：自动补全是根据词条做自动补全的，如果将两个信息何为一个字符串将来做自动补全时就只能通过 S 来补全了，而输入 W 时是不会补全产品名称的，分成数组就是两个词。用户输入 S 时能补全 “Sony”，用户输入 W 时能补全 “WH-1000XM3”，我们尽量吧词语分成一个一个词条放到数组中</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310151210270.png" alt="image-20231015121026947"></p><p>查询语法如下：</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 自动补全查询</span></pre></td></tr><tr><td data-num="2"></td><td><pre>GET /test/_search</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token property">"suggest"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>      <span class="token property">"title_suggest"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>         <span class="token property">"text"</span><span class="token operator">:</span> <span class="token string">"s"</span><span class="token punctuation">,</span> <span class="token comment">// 关键字</span></pre></td></tr><tr><td data-num="7"></td><td><pre>         <span class="token property">"completion"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"title"</span><span class="token punctuation">,</span> <span class="token comment">// 补全查询的字段</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token property">"skip_duplicates"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 跳过重复的</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">10</span> <span class="token comment">// 获取前 10 条结果</span></pre></td></tr><tr><td data-num="11"></td><td><pre>         <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>代码演示：</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre># 自动补全的索引库</pre></td></tr><tr><td data-num="2"></td><td><pre>PUT /test1</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>      <span class="token property">"title"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"completion"</span></pre></td></tr><tr><td data-num="8"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre># 添加示例数据</pre></td></tr><tr><td data-num="14"></td><td><pre>POST /test1/_doc</pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token property">"title"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"Sony"</span><span class="token punctuation">,</span> <span class="token string">"WH-1000XM3"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>POST /test1/_doc</pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token property">"title"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"SK-II"</span><span class="token punctuation">,</span> <span class="token string">"PITERA"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>POST /test1/_doc</pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>  <span class="token property">"title"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"Nintendo"</span><span class="token punctuation">,</span> <span class="token string">"switch"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>测试查询补全结果：</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre># 自动补全查询</pre></td></tr><tr><td data-num="2"></td><td><pre>GET /test1/_search</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token property">"suggest"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token property">"titleSuggest"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>      <span class="token property">"text"</span><span class="token operator">:</span> <span class="token string">"so"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token property">"completion"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"title"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token property">"skip_duplicates"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">10</span> </pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment">//------------------- 查询结果 -------------------</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token property">"options"</span> <span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="17"></td><td><pre>          <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token property">"text"</span> <span class="token operator">:</span> <span class="token string">"Sony"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token property">"_index"</span> <span class="token operator">:</span> <span class="token string">"test1"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            <span class="token property">"_type"</span> <span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token property">"_id"</span> <span class="token operator">:</span> <span class="token string">"reCRMYsBNslGvgguxrYc"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            <span class="token property">"_score"</span> <span class="token operator">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token property">"_source"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>              <span class="token property">"title"</span> <span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="25"></td><td><pre>                <span class="token string">"Sony"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="26"></td><td><pre>                <span class="token string">"WH-1000XM3"</span></pre></td></tr><tr><td data-num="27"></td><td><pre>              <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>          <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token punctuation">]</span></pre></td></tr></table></figure><blockquote><p><strong>总结</strong>：</p><p>自动补全对字段的要求：</p><ul><li>类型是 completion 类型</li><li>字段值是多次词条的数组</li></ul></blockquote><h5 id="91025-restapi实现自动补全"><a class="anchor" href="#91025-restapi实现自动补全">#</a> 9.10.2.5、RestAPI 实现自动补全🌴</h5><p>先看请求参数构造的 API：</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310151435297.png" alt="image-20231015143537333"></p><p>代码演示：</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre>@Test</pre></td></tr><tr><td data-num="2"></td><td><pre>public void testSuggest()</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// 1. 准备 Request</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    SearchRequest request = new SearchRequest(<span class="token string">"dkx"</span>);</pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">// 2. 准备 DSL</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    request.source().suggest(new SuggestBuilder()</pre></td></tr><tr><td data-num="8"></td><td><pre>            .addSuggestion(</pre></td></tr><tr><td data-num="9"></td><td><pre>                    <span class="token string">"mySuggestion"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>                    SuggestBuilders</pre></td></tr><tr><td data-num="11"></td><td><pre>                            .completionSuggestion(<span class="token string">"suggestion"</span>)</pre></td></tr><tr><td data-num="12"></td><td><pre>                            .prefix(<span class="token string">"so"</span>)</pre></td></tr><tr><td data-num="13"></td><td><pre>                            .size(<span class="token number">10</span>)</pre></td></tr><tr><td data-num="14"></td><td><pre>            ));</pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token comment">// 3. 发送请求</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    SearchResponse search;</pre></td></tr><tr><td data-num="17"></td><td><pre>    try <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>         search = client.search(request<span class="token punctuation">,</span> RequestOptions.DEFAULT);</pre></td></tr><tr><td data-num="19"></td><td><pre>     <span class="token punctuation">&#125;</span> catch (IOException e) <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>         throw new RuntimeException(e);</pre></td></tr><tr><td data-num="21"></td><td><pre>     <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>     System.out.println(search);</pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment">//---------------------- 打印结果 ----------------------</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token property">"suggest"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"mySuggestion"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">&#123;</span><span class="token property">"text"</span><span class="token operator">:</span><span class="token string">"so"</span><span class="token punctuation">,</span><span class="token property">"offset"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">"length"</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token property">"options"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">&#123;</span><span class="token property">"text"</span><span class="token operator">:</span><span class="token string">"松岗商业中心区"</span><span class="token punctuation">,</span><span class="token property">"_index"</span><span class="token operator">:</span><span class="token string">"dkx"</span><span class="token punctuation">,</span><span class="token property">"_type"</span><span class="token operator">:</span><span class="token string">"_doc"</span><span class="token punctuation">,</span><span class="token property">"_id"</span><span class="token operator">:</span><span class="token string">"1393017952"</span><span class="token punctuation">,</span><span class="token property">"_score"</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token property">"_source"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"address"</span><span class="token operator">:</span><span class="token string">"松岗镇河滨北路12号盛华大厦"</span><span class="token punctuation">,</span><span class="token property">"brand"</span><span class="token operator">:</span><span class="token string">"汉庭"</span><span class="token punctuation">,</span><span class="token property">"business"</span><span class="token operator">:</span><span class="token string">"松岗商业中心区"</span><span class="token punctuation">,</span><span class="token property">"city"</span><span class="token operator">:</span><span class="token string">"深圳"</span><span class="token punctuation">,</span><span class="token property">"id"</span><span class="token operator">:</span><span class="token number">1393017952</span><span class="token punctuation">,</span><span class="token property">"location"</span><span class="token operator">:</span><span class="token string">"22.768912, 113.83325"</span><span class="token punctuation">,</span><span class="token property">"name"</span><span class="token operator">:</span><span class="token string">"汉庭酒店(深圳宝安松岗地铁站店)"</span><span class="token punctuation">,</span></pre></td></tr></table></figure><h6 id="910251-结果解析"><a class="anchor" href="#910251-结果解析">#</a> 9.10.2.5.1、结果解析🎋</h6><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310151448335.png" alt="image-20231015144817860"></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Test</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testSuggest</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token comment">// 1. 准备 Request</span></pre></td></tr><tr><td data-num="5"></td><td><pre>   <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">"dkx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>   <span class="token comment">// 2. 准备 DSL</span></pre></td></tr><tr><td data-num="7"></td><td><pre>   request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">suggest</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SuggestBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>                            <span class="token punctuation">.</span><span class="token function">addSuggestion</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="9"></td><td><pre>                               <span class="token string">"suggestions"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>                               <span class="token class-name">SuggestBuilders</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                               <span class="token punctuation">.</span><span class="token function">completionSuggestion</span><span class="token punctuation">(</span><span class="token string">"suggestion"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                               <span class="token punctuation">.</span><span class="token function">prefix</span><span class="token punctuation">(</span><span class="token string">"so"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                               <span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                            <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>   <span class="token comment">// 3. 发送请求</span></pre></td></tr><tr><td data-num="16"></td><td><pre>   <span class="token class-name">SearchResponse</span> search<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>   <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      search <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>   <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>   <span class="token comment">// 4. 解析结果</span></pre></td></tr><tr><td data-num="23"></td><td><pre>   <span class="token function">handleSuggestion</span><span class="token punctuation">(</span>search<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleSuggestion</span><span class="token punctuation">(</span><span class="token class-name">SearchResponse</span> search<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>   <span class="token class-name">Suggest</span> suggest <span class="token operator">=</span> search<span class="token punctuation">.</span><span class="token function">getSuggest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>   <span class="token comment">// 4.1. 根据补全查询名称，获取补全结果</span></pre></td></tr><tr><td data-num="29"></td><td><pre>   <span class="token class-name">CompletionSuggestion</span> suggestion <span class="token operator">=</span> suggest<span class="token punctuation">.</span><span class="token function">getSuggestion</span><span class="token punctuation">(</span><span class="token string">"suggestions"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>   <span class="token comment">// 4.2. 获取 options</span></pre></td></tr><tr><td data-num="31"></td><td><pre>   <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CompletionSuggestion<span class="token punctuation">.</span>Entry<span class="token punctuation">.</span>Option</span><span class="token punctuation">></span></span> options <span class="token operator">=</span> suggestion<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>   <span class="token comment">// 4.3. 遍历结果</span></pre></td></tr><tr><td data-num="33"></td><td><pre>   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">CompletionSuggestion<span class="token punctuation">.</span>Entry<span class="token punctuation">.</span>Option</span> option <span class="token operator">:</span> options<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>      <span class="token comment">// 4.4. 获取 text 的值</span></pre></td></tr><tr><td data-num="35"></td><td><pre>      <span class="token class-name">String</span> content <span class="token operator">=</span> option<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token comment">//-------------------- 打印结果 --------------------</span></pre></td></tr><tr><td data-num="40"></td><td><pre>松岗商业中心区</pre></td></tr><tr><td data-num="41"></td><td><pre>松岗商业中心区</pre></td></tr><tr><td data-num="42"></td><td><pre>松江大学城</pre></td></tr><tr><td data-num="43"></td><td><pre>松江大学城</pre></td></tr><tr><td data-num="44"></td><td><pre>松江大学城</pre></td></tr></table></figure><h4 id="9103-数据同步"><a class="anchor" href="#9103-数据同步">#</a> 9.10.3、数据同步🌲</h4><ul><li>数据同步思路分析</li><li>实现 elasticsearch 与数据库数据同步</li></ul><h5 id="91031-数据同步问题分析"><a class="anchor" href="#91031-数据同步问题分析">#</a> 9.10.3.1、数据同步问题分析🌴</h5><p>elasticsearch 中的酒店数据来自于 mysql 数据库，因此 mysql 数据发生改变时，elasticsearch 也必须跟着改变，这个就是 elasticsearch 与 mysql 之间的<mark>数据同步</mark>。</p><h6 id="910311-方案一同步调用"><a class="anchor" href="#910311-方案一同步调用">#</a> 9.10.3.1.1、方案一：同步调用🎋</h6><p>缺点：业务耦合</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310151525267.png" alt="image-20231015152527620"></p><h6 id="910312-方案二异步通知"><a class="anchor" href="#910312-方案二异步通知">#</a> 9.10.3.1.2、方案二：异步通知🎋</h6><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310151528971.png" alt="image-20231015152813104"></p><h6 id="910313-方案三监听binlog"><a class="anchor" href="#910313-方案三监听binlog">#</a> 9.10.3.1.3、方案三：监听 binlog🎋</h6><p>在 mysql 中 binlog 默认是关闭的，但是开启了 binlog 在 mysql 里做 CRUD 时都会将相应的操作记录在 binlog 中。也就是说 mysql 变化了 binlog 就会变化，而我们可以利用 Canal 这样的中间件去监听 binlog。一旦 binlog 发生变化就去通知微服务更新 es 数据</p><p>缺点：增加了 mysql 的压力</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310151529543.png" alt="image-20231015152942969"></p><blockquote><p><strong>总结</strong>:</p><p>方式一：同步调用</p><ul><li>优点：实现简单，粗暴</li><li>缺点：业务耦合度太高</li></ul><p>方式二：异步通知</p><ul><li>优点：低耦合，实现难度一般</li><li>缺点：依赖 mq 的可靠性</li></ul><p>方式三：监听 binlog</p><ul><li>优点：完全解除服务间耦合</li><li>缺点：开启 binlog 增加数据库负担，实现复杂度高</li></ul></blockquote><h5 id="91032-利用mq实现mysql与elasticsearch数据同步"><a class="anchor" href="#91032-利用mq实现mysql与elasticsearch数据同步">#</a> 9.10.3.2、利用 MQ 实现 mysql 与 elasticsearch 数据同步🌴</h5><p>利用课前资料提供的 hotel-admin 项目作为酒店管理的微服务。当数据库发生 CRUD 时，要求对 elasticsearch 中数据也要完成相同操作。</p><p>步骤：</p><ul><li>导入 hotel-admin 项目 (项目地址：<span class="exturl" data-url="aHR0cHM6Ly9naXRlZS5jb20vZG91a2FpeGluL3R5cG9yYS5naXQ=">https://gitee.com/doukaixin/typora.git</span>)，启动并测试酒店数据的 CRUD</li><li>声明 exchange，queue，Routingkey</li><li>在 hotel-admin 中的增，删，改业务中完成消息发送</li><li>在 hotel-demo (项目地址：<span class="exturl" data-url="aHR0cHM6Ly9naXRlZS5jb20vZG91a2FpeGluL3R5cG9yYS5naXQ=">https://gitee.com/doukaixin/typora.git</span>) 中完成消息监听，并更新 elasticsearch 中数据</li><li>启动并测试数据同步功能</li></ul><p>1、导入 hotel-admin 项目，启动并测试酒店数据的 CRUD</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310151942076.png" alt="image-20231015194242526"></p><p>2、声明 exchange，queue，Routingkey</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310151945245.png" alt="image-20231015194554807"></p><p>2.1、创建 MqConstans 类记录队列名称和 Routingkey</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MqConstans</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token comment">// 交换机</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">HOTEL_EXCHANGE</span> <span class="token operator">=</span> <span class="token string">"hotel.topic"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// 监听新增和修改的队里</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">HOTEL_INSERT_QUEUE</span> <span class="token operator">=</span> <span class="token string">"hotel.insert.queue"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">// 监听删除的队列</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">HOTEL_DELETE_QUEUE</span> <span class="token operator">=</span> <span class="token string">"hotel.delete.queue"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">// 新增或修改的 RoutingKey</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">HOTEL_INSERT_KEY</span> <span class="token operator">=</span> <span class="token string">"hotel.insert"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">// 删除的 RoutingKey</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">HOTEL_DELETE_KEY</span> <span class="token operator">=</span> <span class="token string">"hotel.delete"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>2.2、创建 MqConfig 配置类，配置队列与交换机的关系绑定</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Configuration</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MqConfig</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">// 定义交换机 Bean</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token annotation punctuation">@Bean</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">TopicExchange</span> <span class="token function">topicExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token comment">//name：交换机名称 ，durable：是否持久化，autoDelete：是否自动解除绑定关系</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TopicExchange</span><span class="token punctuation">(</span><span class="token class-name">MqConstans</span><span class="token punctuation">.</span><span class="token constant">HOTEL_EXCHANGE</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">// 定义队列</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token annotation punctuation">@Bean</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">insertQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token comment">//name：队列名称，durable：是否持久化</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token class-name">MqConstans</span><span class="token punctuation">.</span><span class="token constant">HOTEL_INSERT_QUEUE</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token comment">// 定义队列</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token annotation punctuation">@Bean</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">deleteQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token comment">//name：队列名称，durable：是否持久化</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token class-name">MqConstans</span><span class="token punctuation">.</span><span class="token constant">HOTEL_DELETE_QUEUE</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token annotation punctuation">@Bean</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token comment">// 绑定关系</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">insertQueueBinding</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token comment">// 将 insertQueue 队列绑定到交换机上，并绑定 Routingkey</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token function">insertQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="33"></td><td><pre>                <span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token function">topicExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token class-name">MqConstans</span><span class="token punctuation">.</span><span class="token constant">HOTEL_INSERT_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token annotation punctuation">@Bean</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">deleteQueueBinding</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token comment">// 将 insertQueue 队列绑定到交换机上，并绑定 Routingkey</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token function">insertQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="41"></td><td><pre>                <span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token function">topicExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token class-name">MqConstans</span><span class="token punctuation">.</span><span class="token constant">HOTEL_DELETE_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>3、在 hotel-admin 中的增，删，改业务中完成消息发送</p><p>3.1、在 hotel-admin 项目中也添加 constans/MqConstans 类方便调用</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MqConstans</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token comment">// 交换机</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">HOTEL_EXCHANGE</span> <span class="token operator">=</span> <span class="token string">"hotel.topic"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// 监听新增和修改的队里</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">HOTEL_INSERT_QUEUE</span> <span class="token operator">=</span> <span class="token string">"hotel.insert.queue"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">// 监听删除的队列</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">HOTEL_DELETE_QUEUE</span> <span class="token operator">=</span> <span class="token string">"hotel.delete.queue"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">// 新增或修改的 RoutingKey</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">HOTEL_INSERT_KEY</span> <span class="token operator">=</span> <span class="token string">"hotel.insert"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">// 删除的 RoutingKey</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">HOTEL_DELETE_KEY</span> <span class="token operator">=</span> <span class="token string">"hotel.delete"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>3.2、配置 RabbitMQ 的 yml 并导入依赖</p><p>3.3、在 Controller 中编写发生消息的代码</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@RestController</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HotelController</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">IHotelService</span> hotelService<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/&#123;id&#125;"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Hotel</span> <span class="token function">queryById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token keyword">return</span> hotelService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/list"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">PageResult</span> <span class="token function">hotelList</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"page"</span><span class="token punctuation">,</span> defaultValue <span class="token operator">=</span> <span class="token string">"1"</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> page<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"size"</span><span class="token punctuation">,</span> defaultValue <span class="token operator">=</span> <span class="token string">"1"</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> size</pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Hotel</span><span class="token punctuation">></span></span> result <span class="token operator">=</span> hotelService<span class="token punctuation">.</span><span class="token function">page</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PageResult</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span><span class="token function">getRecords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token annotation punctuation">@PostMapping</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveHotel</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Hotel</span> hotel<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        hotelService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>hotel<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token class-name">MqConstans</span><span class="token punctuation">.</span><span class="token constant">HOTEL_EXCHANGE</span><span class="token punctuation">,</span> <span class="token class-name">MqConstans</span><span class="token punctuation">.</span><span class="token constant">HOTEL_INSERT_KEY</span><span class="token punctuation">,</span> hotel<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token annotation punctuation">@PutMapping</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Hotel</span> hotel<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>hotel<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidParameterException</span><span class="token punctuation">(</span><span class="token string">"id不能为空"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        hotelService<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>hotel<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token class-name">MqConstans</span><span class="token punctuation">.</span><span class="token constant">HOTEL_EXCHANGE</span><span class="token punctuation">,</span> <span class="token class-name">MqConstans</span><span class="token punctuation">.</span><span class="token constant">HOTEL_INSERT_KEY</span><span class="token punctuation">,</span> hotel<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token annotation punctuation">@DeleteMapping</span><span class="token punctuation">(</span><span class="token string">"/&#123;id&#125;"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        hotelService<span class="token punctuation">.</span><span class="token function">removeById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token class-name">MqConstans</span><span class="token punctuation">.</span><span class="token constant">HOTEL_EXCHANGE</span><span class="token punctuation">,</span> <span class="token class-name">MqConstans</span><span class="token punctuation">.</span><span class="token constant">HOTEL_DELETE_KEY</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>4、在 hotel-demo 中完成消息监听，并更新 elasticsearch 中数据</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">insertOrupdateByid</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>   <span class="token class-name">Hotel</span> hotel <span class="token operator">=</span> <span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token class-name">HotelDoc</span> hotelDoc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">(</span>hotel<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>   <span class="token comment">// 1. 准备 Request</span></pre></td></tr><tr><td data-num="6"></td><td><pre>   <span class="token class-name">IndexRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexRequest</span><span class="token punctuation">(</span><span class="token string">"dkx"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>hotel<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>   <span class="token comment">// 2. 准备 DSL</span></pre></td></tr><tr><td data-num="8"></td><td><pre>   request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>hotelDoc<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span><span class="token constant">JSON</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>   <span class="token comment">// 3. 发送请求</span></pre></td></tr><tr><td data-num="10"></td><td><pre>   <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      client<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>   <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>   <span class="token comment">// 1. 准备 Request</span></pre></td></tr><tr><td data-num="20"></td><td><pre>   <span class="token class-name">DeleteRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DeleteRequest</span><span class="token punctuation">(</span><span class="token string">"dkx"</span><span class="token punctuation">,</span> id<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>   <span class="token comment">// 2. 准备 DSL</span></pre></td></tr><tr><td data-num="22"></td><td><pre>   <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>      client<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>   <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>5、启动并测试数据同步功能</p><p>&lt;font color='red'&gt; 注意 &lt;/font&gt;：要启动 RabbitMQ 否则链接就会报错</p><p>启动两个项目后查看 队列 情况</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310152133072.png" alt="image-20231015213307513"></p><p>再看一下交换机</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310152133845.png" alt="image-20231015213344108"></p><p>证明 队列和交换机创建成功了。</p><p>查看它们的绑定关系</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310152134821.png" alt="image-20231015213451830"></p><p>两个 BindingKey 分别绑定了 Routingkey</p><p>接下来进行修改测试，比如说先修改这个广告位的价格看下，找到它的 id</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310160743271.png" alt="image-20231016074258159"></p><p>然后在酒店管理中找到这个对应的 id 信息，对其进行修改</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310160744989.png" alt="image-20231016074402893"></p><p>现在的价格是 589，修改为 1058</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310160745904.png" alt="image-20231016074503675"></p><p>然后去查看网页的价格是否更新了</p><p>可以看到价格被改变了，说明数据同步成功了。</p><p>但是这里有个问题就是 每次修改后广告就没了，自然权重也就下降看不到它是第一个了，这里需要做持久化否则每次更新 isAD 的状态就消息了</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310160812307.png" alt="image-20231016081236685"></p><p>测试删除，删除如下选中的酒店信息</p><p>找到对应的 id，然后去管理页面进行删除操作</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310160925485.png" alt="image-20231016092546878"></p><p>在酒店管理页面找到对应信息进行删除操作。</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310160926330.png" alt="image-20231016092628220"></p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310160926213.png" alt="image-20231016092649279"></p><p>删除后查看酒店信息网页，可以看到少了一条信息也就证明了那条信息被删除了</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310160930574.png" alt="image-20231016092713820"></p><h4 id="9104-elasticsearch集群"><a class="anchor" href="#9104-elasticsearch集群">#</a> 9.10.4、elasticsearch 集群🌲</h4><ul><li>搭建 ES 集群</li><li>集群脑裂问题</li><li>集群故障转移</li><li>集群分布式存储</li><li>集群分布式查询</li></ul><h5 id="91041-es集群结构"><a class="anchor" href="#91041-es集群结构">#</a> 9.10.4.1、ES 集群结构🌴</h5><p>单击的 elasticsearch 做数据存储，必然面临两个问题：海量数据存储问题，单点故障问题。</p><ul><li>海量数据存储问题：将索引库从逻辑上拆分为 N 个分片 (shard) ，存储到多个节点</li><li>单点故障问题：将分片数据在不同节点备份 (replica)</li></ul><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310161025488.png" alt="image-20231016102545479"></p><h5 id="91042-搭建es集群"><a class="anchor" href="#91042-搭建es集群">#</a> 9.10.4.2、搭建 ES 集群🌴</h5><p>我们计划利用 3 个 docker 容器模拟 3 个 es 的节点。具体步骤参考 elasticsearch 文章：<a href="./Elasearch/%E5%AE%89%E8%A3%85elasticsearch.md">查看</a>.</p><h5 id="91043-es集群的节点角色"><a class="anchor" href="#91043-es集群的节点角色">#</a> 9.10.4.3、ES 集群的节点角色🌴</h5><p>elasticsearch 中集群节点有不同的职责划分：</p><table><thead><tr><th>节点类型</th><th>配置参数</th><th>默认值</th><th>节点职责</th></tr></thead><tbody><tr><td>master eligible</td><td>node.master</td><td>true</td><td>备选主节点：主节点可以管理和记录集群状态，决定 &lt;br /&gt; 分片在哪个节点，处理创建和删除索引库的请求</td></tr><tr><td>data</td><td>node.data</td><td>true</td><td>数据节点：存储数据，搜索，聚合，CRUD</td></tr><tr><td>ingest</td><td>node.ingest</td><td>true</td><td>数据存储之前的预处理</td></tr><tr><td>coordinating</td><td>上面 3 个参数都为 false&lt;br /&gt; 则为 coordinating 节点</td><td>无</td><td>路由请求到其它节点 &lt;br /&gt; 合并其它节点处理的结果，返回给用户</td></tr></tbody></table><h5 id="91044-es集群的分布式查询"><a class="anchor" href="#91044-es集群的分布式查询">#</a> 9.10.4.4、ES 集群的分布式查询🌴</h5><p>elasticsearch 中的每个节点角色都有自己不用的职责，因此建议集群部署时，每个节点都有独立的角色。</p><p>下图中，有三个 coordinating 节点 (协调节点) 还有 n 个数据节点 和 三个候选主节点。将来有一个节点挂了就可以从三个候选主节点中选取一个出来。LB 为负载均衡器，对协调节点做负载均衡</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310161339823.png" alt="image-20231016133909366"></p><p>缺点：</p><p>候选主节点结构会有一个脑裂问题</p><h5 id="91045-es集群的脑裂"><a class="anchor" href="#91045-es集群的脑裂">#</a> 9.10.4.5、ES 集群的脑裂🌴</h5><p>默认情况下，每个节点都是 mster gligible 节点，因此一旦 master 节点宕机，其它候选节点会选举一个成为主节点。当主节点与其它节点网络故障时，可能发生脑裂问题。</p><p>什么是脑裂呢？</p><p>比方说，有三个候选主节点，第一个节点现在当选为主节点。剩下两个是候选节点</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310161346747.png" alt="image-20231016134608313"></p><p>现在假设说发生了网络故障</p><p>不是宕机了，是因为网络的原因导致，node2 和 node3 跟 node1 连接不上了，但是 node1 跟其它部分数据节点还是可以连同的。node2 和 node3 和一些数据节点也是可以连同的。这个时候就等于集群被分开了。</p><p>当 node2 和 node3 连不上 node1 的时候它会认为 node1 挂了，就会在 node2 和 node3 中又选举出一个老大</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310161347107.png" alt="image-20231016134716821"></p><p>比方说选举的老大为 node3</p><p>这是集群里面就等于出现了两个老大</p><p>现在就出问题了，因为有两个老大，一部分数据节点跟 node1 结合将来做 CRUD 的时候由 node1 来控制</p><p>还有另一部分由 node3 来控制，它们各自去处理各自的集群。一旦网络恢复，当用户来访问时就会出现两边数据不一致的情况。这可就出大事儿了，这就是脑裂问题。</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310161350808.png" alt="image-20231016135040891"></p><p>为了避免脑裂，需要要求选票超过 (eligible 节点数量 + 1) / 2 才能当选为主，因此 eligible 节点数量最好是奇数。对应配置项是 discovery.zen.minimun_master_nodes，在 es7.0 以后，已经成为默认配置，因此一般不会发生脑裂问题。</p><blockquote><p><strong>总结</strong>：</p><p>master eligible 节点的作用是什么？</p><ul><li>参与集群选主</li><li>主节点可以管理集群状态，管理分片信息，处理创建和删除索引库的请求</li></ul><p>data 节点的作用是什么？</p><ul><li>数据的 CRUD</li></ul><p>coordinator 节点的作用是什么？</p><ul><li>路由请求到其它节点</li><li>合并查询到的结果，返回给用户</li></ul></blockquote><h5 id="91046-测试引出问题"><a class="anchor" href="#91046-测试引出问题">#</a> 9.10.4.6、测试引出问题🌴</h5><p>当新增文档时，应该保存到不同分片，保证数据均衡，那么 coordinating node 如何确定数据该存储到哪个分片呢？</p><p>这里由于虚拟机中没有启动 kibana 所以使用 postman，api 接口测试工具来进行添加文档数据</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310161409037.png" alt="image-20231016140915224"></p><p>进行查询文档的数据情况</p><p>三条数据就查询出来了</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310161413380.png" alt="image-20231016141318310"></p><p>查询端口为 9201 为 es02 的数据情况</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310161414897.png" alt="image-20231016141452636"></p><p>查询端口为 9202 为 es03 的数据情况</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310161415226.png" alt="image-20231016141537985"></p><p>可以看到都是同样的结果，我是在 9200 插入的文档数据结果在每一个节点都可以查到。那问题来了这些数据到底是存到哪个分片上了呢？</p><p>我们可以通过 “explain” 命令，这个命令可以让我们看到查询的结果到底在哪里</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token property">"explain"</span> <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token property">"match_all"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>查询的结果：</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token property">"hits"</span><span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="2"></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                <span class="token property">"_shard"</span><span class="token operator">:</span> <span class="token string">"[itcast][0]"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>                <span class="token property">"_node"</span><span class="token operator">:</span> <span class="token string">"tzSKl2laTTKoDwMz4AfkAQ"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>                <span class="token property">"_index"</span><span class="token operator">:</span> <span class="token string">"itcast"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>                <span class="token property">"_type"</span><span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>                <span class="token property">"_id"</span><span class="token operator">:</span> <span class="token string">"5"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>                <span class="token property">"_score"</span><span class="token operator">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>                <span class="token property">"_source"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>                    <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"试着插入一条 id = 1"</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                <span class="token property">"_explanation"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                    <span class="token property">"value"</span><span class="token operator">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                    <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"*:*"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                    <span class="token property">"details"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                <span class="token property">"_shard"</span><span class="token operator">:</span> <span class="token string">"[itcast][1]"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                <span class="token property">"_node"</span><span class="token operator">:</span> <span class="token string">"tzSKl2laTTKoDwMz4AfkAQ"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                <span class="token property">"_index"</span><span class="token operator">:</span> <span class="token string">"itcast"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="22"></td><td><pre>                <span class="token property">"_type"</span><span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="23"></td><td><pre>                <span class="token property">"_id"</span><span class="token operator">:</span> <span class="token string">"3"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="24"></td><td><pre>                <span class="token property">"_score"</span><span class="token operator">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="25"></td><td><pre>                <span class="token property">"_source"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>                    <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"试着插入一条 id = 1"</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="28"></td><td><pre>                <span class="token property">"_explanation"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>                    <span class="token property">"value"</span><span class="token operator">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="30"></td><td><pre>                    <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"*:*"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                    <span class="token property">"details"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="32"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="34"></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>                <span class="token property">"_shard"</span><span class="token operator">:</span> <span class="token string">"[itcast][2]"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="36"></td><td><pre>                <span class="token property">"_node"</span><span class="token operator">:</span> <span class="token string">"nrhAcc9RQX2XXJoxYWFYPg"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="37"></td><td><pre>                <span class="token property">"_index"</span><span class="token operator">:</span> <span class="token string">"itcast"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="38"></td><td><pre>                <span class="token property">"_type"</span><span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="39"></td><td><pre>                <span class="token property">"_id"</span><span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="40"></td><td><pre>                <span class="token property">"_score"</span><span class="token operator">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="41"></td><td><pre>                <span class="token property">"_source"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>                    <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"试着插入一条 id = 1"</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="44"></td><td><pre>                <span class="token property">"_explanation"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>                    <span class="token property">"value"</span><span class="token operator">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="46"></td><td><pre>                    <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"*:*"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="47"></td><td><pre>                    <span class="token property">"details"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="48"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        <span class="token punctuation">]</span></pre></td></tr></table></figure><p>可以看到 id 为 5 的在 0 号分片，id 为 3 的在 1 号分片，id 为 1 的在 2 号分片</p><p>刚好这三条数据在每个分片上都有一个，那么问题来了，我明明是在 9200 插入的数据怎么会出现在三台机器上呢，这说明 协调节点 确实是工作了。那问题是它是怎么工作的呢？</p><p>elasticsearch 会通过 hash 算法来计算文档应该存储到哪个分片：</p><pre><code>shard = hash(_routing) % number_of_shards
</code></pre><p>用 hash 计算的结果去对 number_of_shards 进行取余，只要_routing 值变化那么计算出的结果也会随着变化</p><p>说明：</p><ul><li>_routing 默认是文档 id</li><li>算法与分片数量有关，因此索引库一旦创建，分片数量不能修改 (如果改了数据就找不到了)！</li></ul><h5 id="91047-通过案例进行分析"><a class="anchor" href="#91047-通过案例进行分析">#</a> 9.10.4.7、通过案例进行分析🌴</h5><p>比方说现在来做新增</p><p>新增文档流程：</p><p>如下有集群三个节点，分别是 node1，node2，node3。在这个集群的每个节点上都会有一些分片。其中深蓝色叫 primarisha 主分片，p-0，p-1，p-2 分别就是 0 号主分片，1 号主分片，2 号主分片。每个分片都要有副本，浅蓝色就是副本 r-0 就是 0 号分片的副本分片</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310161431150.png" alt="image-20231016143113264"></p><p>如果说我现在要插入一条文档，文档的 id 为 1 。请求到达了 node1。这是 node1 就充当了协调节点的角色</p><p>协调角色要用上述的哈希运算了，假设说文档 id 为 1 哈希运算结果为 2，那就意味着它要存储到 2 号分片</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310161435085.png" alt="image-20231016143543105"></p><p>于是就把请求路由到 node3 节点了</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310161437775.png" alt="image-20231016143719016"></p><p>然后就把数据写入到 2 号分片了，写入后发现自己是老大还是主分片，所以它就要把主分片数据同步给从分片。从分片的副本分片在 1 号分片中 于是请求就同步过去了</p><p>这样主分片和副本分片就都保存了这个数据了</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310161440114.png" alt="image-20231016144022919"></p><p>最终把相应结果返回给协调节点，然后再返回给用户</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310161442717.png" alt="image-20231016144216794"></p><p>如果是 id 去查询也是相同的道理，删除，修改都是如此。所以凡是根据 id 操作都是这个流程</p><p>但是上面代码中进行查询的时候我们使用的是如下代码：</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token property">"explain"</span> <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token property">"match_all"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>当发送请求时，并不知道要查询的数据在哪个分片上，没有 id 啊，那这种情况下协调节点又是怎么工作的呢？</p><p>那这就是分布式查询的过程了：</p><p>elasticsearch 的查询分成两个阶段：</p><ul><li><p>scatter phase：分散阶段，coordinating node 会把请求发到每一个分片</p><p>每个分片都查询了后进入聚集阶段</p></li><li><p>gather phase：聚集阶段，coordinating node 汇总 data node 的搜索结果，并处理为最终结果集返回给用户</p></li></ul><p>协调节点为虚线，表示这里的协调节点可以是三个节点中任意一个，因为默认情况下每个节点都是协调节点</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310161447068.png" alt="image-20231016144743512"></p><blockquote><p><strong>总结</strong>：</p><p>分布式新增如何确定分片？</p><ul><li>coordinating node 根据 id 做 hash 运算，得到结果 shard 数量取余，余数就是对应的分片</li></ul><p>分布式查询：</p><ul><li>分散阶段：coordinating node 将查询请求分发给不同分配</li><li>收集阶段：将查询结果汇总到 coordinating node，整理并返回给用户</li></ul></blockquote><h5 id="91048-es集群的故障转移"><a class="anchor" href="#91048-es集群的故障转移">#</a> 9.10.4.8、ES 集群的故障转移🌲</h5><p>集群的 master 节点会监控集群中的节点状态，如果发现有节点宕机，会立即将宕机节点的分片数据迁移到其它节点，确保数据安全，这个叫做故障转移。</p><p>比方说，有集群三个节点 node1，node2，node3 每个节点上都有分片目前主节点是 node1。</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310161457402.png" alt="image-20231016145745390"></p><p>现在假设说其中一个节点出现了故障，比如说 node1 主节点挂了。此时两个候选节点就会选出一个主节点</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310161500046.png" alt="image-20231016150004147"></p><p>比方说选中了 node2，这时集群就有主了，主节点就要发挥自己的工作了。它要查看下集群的健康状态了，分片状态。</p><p>它一看这不行啊，因为 p-1 有主分片，但是没有副本分片。p-2 有主分片有副本分片。p-0 只有副本分片，没有主分片。</p><p>那也就是说 1 号 分片 和 0 号分片的数据是不安全的，因为只有一份一旦挂了就完了。</p><p>这时集群的状态就不是健康的了，而是处于危险的边缘</p><p>这时主节点就会做个措施。它会检查挂掉的节点它上面有什么分片，然后把它迁移到健康的节点上。确保任何一个分片都至少有两份，也就是一个主分片，一个副本分片。</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310161507621.png" alt="image-20231016150711670"></p><p>我们看下控制台</p><p>现在 es01 是主节点，集群状态是健康的，我们把 es01 给它停掉</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310161510371.png" alt="image-20231016151046860"></p><p>通过命令： <code>docker-compose stop es01</code> 这样主节点就被停掉了</p><figure class="highlight sh"><figcaption data-lang="sh"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># docker-compose stop es01</span></pre></td></tr><tr><td data-num="2"></td><td><pre>Stopping es01 <span class="token punctuation">..</span>. <span class="token keyword">done</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment">#</span></pre></td></tr></table></figure><p>我们再去看控制台，发现主变成了 es02，并且把数据进行了迁移</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310161514231.png" alt="image-20231016151445895"></p><p>那么数据有没有丢失呢，我们搜索查看一下：</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token property">"match_all"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>查询结果：</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token property">"took"</span><span class="token operator">:</span> <span class="token number">27</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token property">"timed_out"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token property">"_shards"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token property">"total"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token property">"successful"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token property">"skipped"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token property">"failed"</span><span class="token operator">:</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token property">"hits"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token property">"total"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token property">"value"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token property">"relation"</span><span class="token operator">:</span> <span class="token string">"eq"</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token property">"max_score"</span><span class="token operator">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token property">"hits"</span><span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                <span class="token property">"_index"</span><span class="token operator">:</span> <span class="token string">"itcast"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                <span class="token property">"_type"</span><span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                <span class="token property">"_id"</span><span class="token operator">:</span> <span class="token string">"5"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                <span class="token property">"_score"</span><span class="token operator">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="22"></td><td><pre>                <span class="token property">"_source"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>                    <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"试着插入一条 id = 1"</span></pre></td></tr><tr><td data-num="24"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                <span class="token property">"_index"</span><span class="token operator">:</span> <span class="token string">"itcast"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="28"></td><td><pre>                <span class="token property">"_type"</span><span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="29"></td><td><pre>                <span class="token property">"_id"</span><span class="token operator">:</span> <span class="token string">"3"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="30"></td><td><pre>                <span class="token property">"_score"</span><span class="token operator">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                <span class="token property">"_source"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>                    <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"试着插入一条 id = 1"</span></pre></td></tr><tr><td data-num="33"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="35"></td><td><pre>            <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>                <span class="token property">"_index"</span><span class="token operator">:</span> <span class="token string">"itcast"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="37"></td><td><pre>                <span class="token property">"_type"</span><span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="38"></td><td><pre>                <span class="token property">"_id"</span><span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="39"></td><td><pre>                <span class="token property">"_score"</span><span class="token operator">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="40"></td><td><pre>                <span class="token property">"_source"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>                    <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"试着插入一条 id = 1"</span></pre></td></tr><tr><td data-num="42"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>数据没有丢失</p><p>如果我再重启 es01 节点，执行命令： <code>docker-compose start es01</code></p><figure class="highlight sh"><figcaption data-lang="sh"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># docker-compose start es01</span></pre></td></tr><tr><td data-num="2"></td><td><pre>Starting es01 <span class="token punctuation">..</span>. <span class="token keyword">done</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment">#</span></pre></td></tr></table></figure><p>再切回到控制台看下情况</p><p>我们发现 es01 又回来了，但是不是主了。但是现在的主节点又把数据给迁移回去了</p><p>确保 每一个分片上都会有数据，确保数据是均衡的</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310161519914.png" alt="image-20231016151901158"></p><blockquote><p><strong>总结</strong>:</p><p>故障转移：</p><ul><li>master 宕机后，EligibleMaster 选举为新的主节点。</li><li>master 节点监控分片，节点状态，将故障节点上的分片转移到正常节点，确保数据安全</li></ul></blockquote><div class="tags"><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%AD%A6%E7%A7%91/" rel="tag"><i class="ic i-tag"></i> 计算机学科</a> <a href="/tags/springcloud/" rel="tag"><i class="ic i-tag"></i> springcloud</a> <a href="/tags/Elasticsearch/" rel="tag"><i class="ic i-tag"></i> Elasticsearch</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2024-01-06 10:31:02" itemprop="dateModified" datetime="2024-01-06T10:31:02+08:00">2024-01-06</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="Dkx 微信支付"><p>微信支付</p></div><div><img data-src="/images/alipay.png" alt="Dkx 支付宝"><p>支付宝</p></div><div><img data-src="/images/paypal.png" alt="Dkx 贝宝"><p>贝宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>Dkx： </strong>Dkx <i class="ic i-at"><em>@</em></i>Dkx の Java 小窝</li><li class="link"><strong>本文链接：</strong> <a href="https://pigpigletsgo.github.io/computer-science/java/spring/springcloud/Elasticsearch/springcloud-elasticsearch/" title="九、分布式搜索">https://pigpigletsgo.github.io/computer-science/java/spring/springcloud/Elasticsearch/springcloud-elasticsearch/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/computer-science/java/spring/springcloud/Docker/springcloud-docker/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;img.timelessq.com&#x2F;images&#x2F;2022&#x2F;07&#x2F;26&#x2F;5da180f23a92b4141ea87338ac84c765.jpg" title="七、Docker"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> Docker</span><h3>七、Docker</h3></a></div><div class="item right"><a href="/computer-science/java/spring/springcloud/Elasticsearch/%E5%AE%89%E8%A3%85elasticsearch/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;img.timelessq.com&#x2F;images&#x2F;2022&#x2F;07&#x2F;26&#x2F;5651daf17bf5de77514e658264d7cccc.jpg" title="安装elasticsearch"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> Elasticsearch</span><h3>安装elasticsearch</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B9%9D-%E5%88%86%E5%B8%83%E5%BC%8F%E6%90%9C%E7%B4%A2"><span class="toc-number">1.</span> <span class="toc-text">九、分布式搜索🎄</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#91-%E5%88%9D%E5%A7%8Belasticsearch"><span class="toc-number">1.1.</span> <span class="toc-text">9.1、初始 elasticsearch🌳</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#911-%E4%BB%80%E4%B9%88%E6%98%AFelasticsearch"><span class="toc-number">1.1.1.</span> <span class="toc-text">9.1.1、什么是 elasticsearch🌲</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#92-%E6%AD%A3%E5%90%91%E7%B4%A2%E5%BC%95%E5%92%8C%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95"><span class="toc-number">1.2.</span> <span class="toc-text">9.2、正向索引和倒排索引🌳</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#93-%E6%96%87%E6%A1%A3"><span class="toc-number">1.3.</span> <span class="toc-text">9.3、文档🌳</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#94-%E7%B4%A2%E5%BC%95-index"><span class="toc-number">1.4.</span> <span class="toc-text">9.4、索引 (index)🌳</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#95-%E6%A6%82%E5%BF%B5%E5%AF%B9%E6%AF%94"><span class="toc-number">1.5.</span> <span class="toc-text">9.5、概念对比🌳</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#95-%E6%9E%B6%E6%9E%84"><span class="toc-number">1.6.</span> <span class="toc-text">9.5、架构🌳</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#96-%E5%AE%89%E8%A3%85%E5%92%8C%E9%83%A8%E7%BD%B2"><span class="toc-number">1.7.</span> <span class="toc-text">9.6、安装和部署🌳</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#97-%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-number">1.8.</span> <span class="toc-text">9.7、分词器🌳</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#98-%E7%B4%A2%E5%BC%95%E5%BA%93%E6%93%8D%E4%BD%9C"><span class="toc-number">1.9.</span> <span class="toc-text">9.8、索引库操作🌳</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#981-mapping%E5%B1%9E%E6%80%A7"><span class="toc-number">1.9.1.</span> <span class="toc-text">9.8.1、mapping 属性🌲</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#982-%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95%E5%BA%93"><span class="toc-number">1.9.2.</span> <span class="toc-text">9.8.2、创建索引库🌲</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#983-%E6%9F%A5%E7%9C%8B%E5%88%A0%E9%99%A4%E7%B4%A2%E5%BC%95%E5%BA%93"><span class="toc-number">1.9.3.</span> <span class="toc-text">9.8.3、查看，删除索引库🌲</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#984-%E4%BF%AE%E6%94%B9%E7%B4%A2%E5%BC%95%E5%BA%93"><span class="toc-number">1.9.4.</span> <span class="toc-text">9.8.4、修改索引库🌲</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#985-%E6%96%87%E6%A1%A3%E6%93%8D%E4%BD%9C"><span class="toc-number">1.9.5.</span> <span class="toc-text">9.8.5、文档操作🌲</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#9851-%E6%B7%BB%E5%8A%A0%E6%96%87%E6%A1%A3"><span class="toc-number">1.9.5.1.</span> <span class="toc-text">9.8.5.1、添加文档🌴</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#9852-%E6%9F%A5%E7%9C%8B%E5%88%A0%E9%99%A4%E6%96%87%E6%A1%A3"><span class="toc-number">1.9.5.2.</span> <span class="toc-text">9.8.5.2、查看，删除文档🌴</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#9853-%E4%BF%AE%E6%94%B9%E6%96%87%E6%A1%A3"><span class="toc-number">1.9.5.3.</span> <span class="toc-text">9.8.5.3、修改文档🌴</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#986-restclient%E6%93%8D%E4%BD%9C%E7%B4%A2%E5%BC%95%E5%BA%93"><span class="toc-number">1.9.6.</span> <span class="toc-text">9.8.6、RestClient 操作索引库🌲</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#9861-%E4%BB%80%E4%B9%88%E6%98%AFrestclient"><span class="toc-number">1.9.6.1.</span> <span class="toc-text">9.8.6.1、什么是 RestClient🌴</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#9862-%E6%A1%88%E4%BE%8B%E5%88%A9%E7%94%A8javarestclient%E5%AE%9E%E7%8E%B0%E5%88%9B%E5%BB%BA%E5%88%A0%E9%99%A4%E7%B4%A2%E5%BC%95%E5%BA%93%E5%88%A4%E6%96%AD%E7%B4%A2%E5%BC%95%E5%BA%93%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8"><span class="toc-number">1.9.6.2.</span> <span class="toc-text">9.8.6.2、案例，利用 JavaRestClient 实现创建，删除索引库，判断索引库是否存在🌴</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#987-restclient%E6%93%8D%E4%BD%9C%E6%96%87%E6%A1%A3"><span class="toc-number">1.9.7.</span> <span class="toc-text">9.8.7、RestClient 操作文档🌲</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#9871-%E6%A1%88%E4%BE%8B%E5%88%A9%E7%94%A8javarestclient%E5%AE%9E%E7%8E%B0%E6%96%87%E6%A1%A3%E7%9A%84crud"><span class="toc-number">1.9.7.1.</span> <span class="toc-text">9.8.7.1、案例，利用 JavaRestClient 实现文档的 CRUD🌴</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#988-%E6%A1%88%E4%BE%8B%E5%88%A9%E7%94%A8javarestclient%E6%89%B9%E9%87%8F%E5%AF%BC%E5%85%A5%E9%85%92%E5%BA%97%E6%95%B0%E6%8D%AE%E5%88%B0es"><span class="toc-number">1.9.8.</span> <span class="toc-text">9.8.8、案例，利用 JavaRestClient 批量导入酒店数据到 ES🌲</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#99-dsl%E6%9F%A5%E8%AF%A2%E6%96%87%E6%A1%A3"><span class="toc-number">1.10.</span> <span class="toc-text">9.9、DSL 查询文档🌳</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#991-dsl-query%E7%9A%84%E5%88%86%E7%B1%BB"><span class="toc-number">1.10.1.</span> <span class="toc-text">9.9.1、DSL Query 的分类🌲</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#9911-dsl-query%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95"><span class="toc-number">1.10.1.1.</span> <span class="toc-text">9.9.1.1、DSL Query 基本语法🌴</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#992-%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.10.2.</span> <span class="toc-text">9.9.2、全文检索查询🌲</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#993-%E7%B2%BE%E7%A1%AE%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.10.3.</span> <span class="toc-text">9.9.3、精确查询🌲</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#9931-%E7%B2%BE%E7%A1%AE%E6%9F%A5%E8%AF%A2-%E8%AF%AD%E6%B3%95"><span class="toc-number">1.10.3.1.</span> <span class="toc-text">9.9.3.1、精确查询 - 语法🌴</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#994-%E5%9C%B0%E7%90%86%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.10.4.</span> <span class="toc-text">9.9.4、地理查询🌲</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#995-%E5%A4%8D%E5%90%88%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.10.5.</span> <span class="toc-text">9.9.5、复合查询🌲</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#9961-function-score-query"><span class="toc-number">1.10.5.1.</span> <span class="toc-text">9.9.6.1、Function Score Query🌴</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#99611-%E6%A1%88%E4%BE%8B%E7%BB%99-%E5%A6%82%E5%AE%B6-%E8%BF%99%E4%B8%AA%E5%93%81%E7%89%8C%E7%9A%84%E9%85%92%E5%BA%97%E6%8E%92%E5%90%8D%E9%9D%A0%E5%89%8D%E4%B8%80%E4%BA%9B"><span class="toc-number">1.10.5.1.1.</span> <span class="toc-text">9.9.6.1.1、案例，给 “如家” 这个品牌的酒店排名靠前一些🎋</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#9962-boolean-query"><span class="toc-number">1.10.5.2.</span> <span class="toc-text">9.9.6.2、Boolean Query🌴</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#99621-%E5%88%A9%E7%94%A8bool%E6%9F%A5%E8%AF%A2%E5%AE%9E%E7%8E%B0%E5%8A%9F%E8%83%BD"><span class="toc-number">1.10.5.2.1.</span> <span class="toc-text">9.9.6.2.1、利用 bool 查询实现功能🎋</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#996-%E6%90%9C%E7%B4%A2%E7%BB%93%E6%9E%9C%E5%A4%84%E7%90%86"><span class="toc-number">1.10.6.</span> <span class="toc-text">9.9.6、搜索结果处理🌲</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#9961-%E6%8E%92%E5%BA%8F"><span class="toc-number">1.10.6.1.</span> <span class="toc-text">9.9.6.1、排序🌴</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#99611-%E6%A1%88%E4%BE%8B%E5%AF%B9%E9%85%92%E5%BA%97%E6%95%B0%E6%8D%AE%E6%8C%89%E7%85%A7%E7%94%A8%E6%88%B7%E8%AF%84%E4%BB%B7%E9%99%8D%E5%BA%8F%E6%8E%92%E5%BA%8F%E8%AF%84%E4%BB%B7%E7%9B%B8%E5%90%8C%E7%9A%84%E6%8C%89%E7%85%A7%E4%BB%B7%E6%A0%BC%E5%8D%87%E5%BA%8F%E6%8E%92%E5%BA%8F"><span class="toc-number">1.10.6.1.1.</span> <span class="toc-text">9.9.6.1.1、案例，对酒店数据按照用户评价降序排序，评价相同的按照价格升序排序🎋</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#99612-%E6%A1%88%E4%BE%8B%E5%AE%9E%E7%8E%B0%E5%AF%B9%E9%85%92%E5%BA%97%E6%95%B0%E6%8D%AE%E6%8C%89%E7%85%A7%E5%88%B0%E4%BD%A0%E7%9A%84%E4%BD%8D%E7%BD%AE%E5%9D%90%E6%A0%87%E8%B7%9D%E7%A6%BB%E5%8D%87%E5%BA%8F%E6%8E%92%E5%BA%8F"><span class="toc-number">1.10.6.1.2.</span> <span class="toc-text">9.9.6.1.2、案例，实现对酒店数据按照到你的位置坐标距离升序排序🎋</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#9962-%E5%88%86%E9%A1%B5"><span class="toc-number">1.10.6.2.</span> <span class="toc-text">9.9.6.2、分页🌴</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#99621-%E6%B7%B1%E5%BA%A6%E5%88%86%E9%A1%B5%E9%97%AE%E9%A2%98"><span class="toc-number">1.10.6.2.1.</span> <span class="toc-text">9.9.6.2.1、深度分页问题🎋</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#99622-%E6%B7%B1%E5%BA%A6%E5%88%86%E9%A1%B5%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">1.10.6.2.2.</span> <span class="toc-text">9.9.6.2.2、深度分页解决方案🎋</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#9963-%E9%AB%98%E4%BA%AE"><span class="toc-number">1.10.6.3.</span> <span class="toc-text">9.9.6.3、高亮🌴</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#997-restclient%E6%9F%A5%E8%AF%A2%E6%96%87%E6%A1%A3"><span class="toc-number">1.10.7.</span> <span class="toc-text">9.9.7、RestClient 查询文档🌲</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#9971-%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8"><span class="toc-number">1.10.7.1.</span> <span class="toc-text">9.9.7.1、快速入门🌴</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#9972-%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.10.7.2.</span> <span class="toc-text">9.9.7.2、全文检索查询🌴</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#9973-%E7%B2%BE%E7%A1%AE%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.10.7.3.</span> <span class="toc-text">9.9.7.3、精确查询🌴</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#9974-%E5%A4%8D%E5%90%88%E6%9F%A5%E8%AF%A2-boolean-query"><span class="toc-number">1.10.7.4.</span> <span class="toc-text">9.9.7.4、复合查询 - boolean query🌴</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#9975-%E6%90%9C%E7%B4%A2%E7%BB%93%E6%9E%9C%E5%A4%84%E7%90%86"><span class="toc-number">1.10.7.5.</span> <span class="toc-text">9.9.7.5、搜索结果处理🌴</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#99751-%E6%8E%92%E5%BA%8F%E5%92%8C%E5%88%86%E9%A1%B5"><span class="toc-number">1.10.7.5.1.</span> <span class="toc-text">9.9.7.5.1、排序和分页🎋</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#99752-%E9%AB%98%E4%BA%AE"><span class="toc-number">1.10.7.5.2.</span> <span class="toc-text">9.9.7.5.2、高亮🎋</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#997521-%E9%AB%98%E4%BA%AE%E7%BB%93%E6%9E%9C%E8%A7%A3%E6%9E%90"><span class="toc-number">1.10.7.5.3.</span> <span class="toc-text">9.9.7.5.2.1、高亮结果解析：</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#99753-%E8%B7%9D%E7%A6%BB%E6%8E%92%E5%BA%8F"><span class="toc-number">1.10.7.5.4.</span> <span class="toc-text">9.9.7.5.3、距离排序🎋</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#99754-%E7%BB%84%E5%90%88%E6%9F%A5%E8%AF%A2-function-score"><span class="toc-number">1.10.7.5.5.</span> <span class="toc-text">9.9.7.5.4、组合查询 - function score🎋</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#es-restclient%E9%BB%91%E9%A9%AC%E6%97%85%E6%B8%B8%E6%A1%88%E4%BE%8B%E9%A1%B9%E7%9B%AE%E5%9C%B0%E5%9D%80httpsgiteecomdoukaixintyporagit"><span class="toc-number">1.10.7.5.6.</span> <span class="toc-text">ES-RestClient 黑马旅游案例，项目地址：https:&#x2F;&#x2F;gitee.com&#x2F;doukaixin&#x2F;typora.git</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#910-%E6%B7%B1%E5%85%A5elasticsearch"><span class="toc-number">1.11.</span> <span class="toc-text">9.10、深入 elasticsearch🌳</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#9101-%E6%95%B0%E6%8D%AE%E8%81%9A%E5%90%88"><span class="toc-number">1.11.1.</span> <span class="toc-text">9.10.1、数据聚合🌲</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#91011-%E8%81%9A%E5%90%88%E7%9A%84%E5%88%86%E7%B1%BB"><span class="toc-number">1.11.1.1.</span> <span class="toc-text">9.10.1.1、聚合的分类🌴</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#910111-dsl%E5%AE%9E%E7%8E%B0bucket%E8%81%9A%E5%90%88"><span class="toc-number">1.11.1.1.1.</span> <span class="toc-text">9.10.1.1.1、DSL 实现 Bucket 聚合🎋</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#910112-bucket%E8%81%9A%E5%90%88-%E8%81%9A%E5%90%88%E7%BB%93%E6%9E%9C%E6%8E%92%E5%BA%8F"><span class="toc-number">1.11.1.1.2.</span> <span class="toc-text">9.10.1.1.2、Bucket 聚合 - 聚合结果排序🎋</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#910113-bucket%E8%81%9A%E5%90%88-%E9%99%90%E5%AE%9A%E8%81%9A%E5%90%88%E8%8C%83%E5%9B%B4"><span class="toc-number">1.11.1.1.3.</span> <span class="toc-text">9.10.1.1.3、Bucket 聚合 - 限定聚合范围🎋</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#910114-dsl%E5%AE%9E%E7%8E%B0metrics%E8%81%9A%E5%90%88"><span class="toc-number">1.11.1.1.4.</span> <span class="toc-text">9.10.1.1.4、DSL 实现 Metrics 聚合🎋</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#91012-restapi%E5%AE%9E%E7%8E%B0%E8%81%9A%E5%90%88"><span class="toc-number">1.11.1.2.</span> <span class="toc-text">9.10.1.2、RestAPI 实现聚合🌴</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#910121-%E8%81%9A%E5%90%88%E7%BB%93%E6%9E%9C%E8%A7%A3%E6%9E%90"><span class="toc-number">1.11.1.2.1.</span> <span class="toc-text">9.10.1.2.1、聚合结果解析🌴</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#9102-%E8%87%AA%E5%8A%A8%E8%A1%A5%E5%85%A8"><span class="toc-number">1.11.2.</span> <span class="toc-text">9.10.2、自动补全🌲</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#91021-%E8%87%AA%E5%8A%A8%E8%A1%A5%E5%85%A8%E9%9C%80%E6%B1%82%E8%AF%B4%E6%98%8E"><span class="toc-number">1.11.2.1.</span> <span class="toc-text">9.10.2.1、自动补全需求说明🌴</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#91022-%E4%BD%BF%E7%94%A8%E6%8B%BC%E9%9F%B3%E5%88%86%E8%AF%8D"><span class="toc-number">1.11.2.2.</span> <span class="toc-text">9.10.2.2、使用拼音分词🌴</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#91023-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-number">1.11.2.3.</span> <span class="toc-text">9.10.2.3、自定义分词器🌴</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#91024-completion-suggester%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.11.2.4.</span> <span class="toc-text">9.10.2.4、completion suggester 查询🌴</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#91025-restapi%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%8A%A8%E8%A1%A5%E5%85%A8"><span class="toc-number">1.11.2.5.</span> <span class="toc-text">9.10.2.5、RestAPI 实现自动补全🌴</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#910251-%E7%BB%93%E6%9E%9C%E8%A7%A3%E6%9E%90"><span class="toc-number">1.11.2.5.1.</span> <span class="toc-text">9.10.2.5.1、结果解析🎋</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#9103-%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5"><span class="toc-number">1.11.3.</span> <span class="toc-text">9.10.3、数据同步🌲</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#91031-%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90"><span class="toc-number">1.11.3.1.</span> <span class="toc-text">9.10.3.1、数据同步问题分析🌴</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#910311-%E6%96%B9%E6%A1%88%E4%B8%80%E5%90%8C%E6%AD%A5%E8%B0%83%E7%94%A8"><span class="toc-number">1.11.3.1.1.</span> <span class="toc-text">9.10.3.1.1、方案一：同步调用🎋</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#910312-%E6%96%B9%E6%A1%88%E4%BA%8C%E5%BC%82%E6%AD%A5%E9%80%9A%E7%9F%A5"><span class="toc-number">1.11.3.1.2.</span> <span class="toc-text">9.10.3.1.2、方案二：异步通知🎋</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#910313-%E6%96%B9%E6%A1%88%E4%B8%89%E7%9B%91%E5%90%ACbinlog"><span class="toc-number">1.11.3.1.3.</span> <span class="toc-text">9.10.3.1.3、方案三：监听 binlog🎋</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#91032-%E5%88%A9%E7%94%A8mq%E5%AE%9E%E7%8E%B0mysql%E4%B8%8Eelasticsearch%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5"><span class="toc-number">1.11.3.2.</span> <span class="toc-text">9.10.3.2、利用 MQ 实现 mysql 与 elasticsearch 数据同步🌴</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#9104-elasticsearch%E9%9B%86%E7%BE%A4"><span class="toc-number">1.11.4.</span> <span class="toc-text">9.10.4、elasticsearch 集群🌲</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#91041-es%E9%9B%86%E7%BE%A4%E7%BB%93%E6%9E%84"><span class="toc-number">1.11.4.1.</span> <span class="toc-text">9.10.4.1、ES 集群结构🌴</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#91042-%E6%90%AD%E5%BB%BAes%E9%9B%86%E7%BE%A4"><span class="toc-number">1.11.4.2.</span> <span class="toc-text">9.10.4.2、搭建 ES 集群🌴</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#91043-es%E9%9B%86%E7%BE%A4%E7%9A%84%E8%8A%82%E7%82%B9%E8%A7%92%E8%89%B2"><span class="toc-number">1.11.4.3.</span> <span class="toc-text">9.10.4.3、ES 集群的节点角色🌴</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#91044-es%E9%9B%86%E7%BE%A4%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.11.4.4.</span> <span class="toc-text">9.10.4.4、ES 集群的分布式查询🌴</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#91045-es%E9%9B%86%E7%BE%A4%E7%9A%84%E8%84%91%E8%A3%82"><span class="toc-number">1.11.4.5.</span> <span class="toc-text">9.10.4.5、ES 集群的脑裂🌴</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#91046-%E6%B5%8B%E8%AF%95%E5%BC%95%E5%87%BA%E9%97%AE%E9%A2%98"><span class="toc-number">1.11.4.6.</span> <span class="toc-text">9.10.4.6、测试引出问题🌴</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#91047-%E9%80%9A%E8%BF%87%E6%A1%88%E4%BE%8B%E8%BF%9B%E8%A1%8C%E5%88%86%E6%9E%90"><span class="toc-number">1.11.4.7.</span> <span class="toc-text">9.10.4.7、通过案例进行分析🌴</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#91048-es%E9%9B%86%E7%BE%A4%E7%9A%84%E6%95%85%E9%9A%9C%E8%BD%AC%E7%A7%BB"><span class="toc-number">1.11.4.8.</span> <span class="toc-text">9.10.4.8、ES 集群的故障转移🌲</span></a></li></ol></li></ol></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li class="active"><a href="/computer-science/java/spring/springcloud/Elasticsearch/springcloud-elasticsearch/" rel="bookmark" title="九、分布式搜索">九、分布式搜索</a></li><li><a href="/computer-science/java/spring/springcloud/Elasticsearch/%E5%AE%89%E8%A3%85elasticsearch/" rel="bookmark" title="安装elasticsearch">安装elasticsearch</a></li><li><a href="/computer-science/java/spring/springcloud/Elasticsearch/%E6%A1%88%E4%BE%8Bsql/" rel="bookmark" title="es案例">es案例</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="Dkx" data-src="/images/avatar.jpg"><p class="name" itemprop="name">Dkx</p><div class="description" itemprop="description">欢迎来我的博客空间</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">192</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">69</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">118</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL1BpZ1BpZ0xldHNHbw==" title="https:&#x2F;&#x2F;github.com&#x2F;PigPigLetsGo"><i class="ic i-github"></i></span> <span class="exturl item twitter" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS9Ea3gxMjE5" title="https:&#x2F;&#x2F;twitter.com&#x2F;Dkx1219"><i class="ic i-twitter"></i></span> <span class="exturl item zhihu" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3Blb3BsZS96dWktaG91LXllLWJlaS1sdWUtc2hh" title="https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;zui-hou-ye-bei-lue-sha"><i class="ic i-zhihu"></i></span> <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPTU3NjUxMDQ1OQ==" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;576510459"><i class="ic i-cloud-music"></i></span> <span class="exturl item weibo" data-url="aHR0cHM6Ly93d3cud2VpYm8uY29tL3UvNTk5OTU0OTg0MQ==" title="https:&#x2F;&#x2F;www.weibo.com&#x2F;u&#x2F;5999549841"><i class="ic i-weibo"></i></span> <span class="exturl item facebook" data-url="aHR0cHM6Ly93d3cuZmFjZWJvb2suY29tL3Byb2ZpbGUucGhwP2lkPTEwMDA5NDA4Nzc0ODIwMQ==" title="https:&#x2F;&#x2F;www.facebook.com&#x2F;profile.php?id&#x3D;100094087748201"><i class="ic i-facebook"></i></span> <span class="exturl item stackoverflow" data-url="aHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS91c2Vycy8xOTQwNjAyOS9kLWt4" title="https:&#x2F;&#x2F;stackoverflow.com&#x2F;users&#x2F;19406029&#x2F;d-kx"><i class="ic i-stack-overflow"></i></span> <span class="exturl item youtube" data-url="aHR0cHM6Ly93d3cueW91dHViZS5jb20vQERreC12djdsbQ==" title="https:&#x2F;&#x2F;www.youtube.com&#x2F;@Dkx-vv7lm"><i class="ic i-youtube"></i></span> <span class="exturl item instagram" data-url="aHR0cHM6Ly93d3cuaW5zdGFncmFtLmNvbS9kb3Vka3g/aWdzaD1PR1E1WkRjMk9EazJaQSUzRCUzRCZ1dG1fc291cmNlPXFy" title="https:&#x2F;&#x2F;www.instagram.com&#x2F;doudkx?igsh&#x3D;OGQ5ZDc2ODk2ZA%3D%3D&amp;utm_source&#x3D;qr"><i class="ic i-instagram"></i></span> <span class="exturl item telegram" data-url="aHR0cHM6Ly90Lm1lL2RvdTAxMDg=" title="https:&#x2F;&#x2F;t.me&#x2F;dou0108"><i class="ic i-twitter"></i></span> <span class="exturl item skype" data-url="aHR0cHM6Ly9qb2luLnNreXBlLmNvbS9UN25TSWhvbmMxcWQ=" title="https:&#x2F;&#x2F;join.skype.com&#x2F;T7nSIhonc1qd"><i class="ic i-skype"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>友達</a></li><li class="item"><a href="/links/" rel="section"><i class="ic i-magic"></i>链接</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/computer-science/java/spring/springcloud/Docker/springcloud-docker/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/computer-science/java/spring/springcloud/Elasticsearch/%E5%AE%89%E8%A3%85elasticsearch/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于 计算机学科">计算机学科</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/web/" title="分类于 web">web</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/web/%E5%89%8D%E5%90%8E%E7%AB%AF%E4%BA%A4%E4%BA%92/" title="分类于 前后端交互">前后端交互</a></div><span><a href="/computer-science/web/%E5%89%8D%E5%90%8E%E7%AB%AF%E4%BA%A4%E4%BA%92/Fetch/" title="Fetch">Fetch</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于 计算机学科">计算机学科</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/" title="分类于 java">java</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/programming-questions/" title="分类于 编程题">编程题</a></div><span><a href="/computer-science/java/programming-questions/%E4%BA%8C%E5%8F%89%E6%A0%91%E6%9C%80%E5%A4%A7%E6%B7%B1%E5%BA%A6-%E4%BD%BF%E7%94%A8%E5%B1%82%E5%BA%8F%E9%81%8D%E5%8E%86/" title="二叉树最大深度-使用层序遍历">二叉树最大深度-使用层序遍历</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于 计算机学科">计算机学科</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/web/" title="分类于 web">web</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/web/vue/" title="分类于 vue">vue</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/web/vue/vue3/" title="分类于 vue3">vue3</a></div><span><a href="/computer-science/web/vue/vue3/Vue3.3%E6%96%B0%E7%89%B9%E6%80%A7/" title="vue3-新特性">vue3-新特性</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于 计算机学科">计算机学科</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/" title="分类于 java">java</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/spring/" title="分类于 spring">spring</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/spring/springcloud/" title="分类于 springcloud">springcloud</a></div><span><a href="/computer-science/java/spring/springcloud/springcloud-Ribbon%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/" title="三、Ribbon负载均衡">三、Ribbon负载均衡</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于 计算机学科">计算机学科</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/" title="分类于 java">java</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/spring/" title="分类于 spring">spring</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/spring/springcloud/" title="分类于 springcloud">springcloud</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/spring/springcloud/Elasticsearch/" title="分类于 Elasticsearch">Elasticsearch</a></div><span><a href="/computer-science/java/spring/springcloud/Elasticsearch/%E5%AE%89%E8%A3%85elasticsearch/" title="安装elasticsearch">安装elasticsearch</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于 计算机学科">计算机学科</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/web/" title="分类于 web">web</a></div><span><a href="/computer-science/web/CSS3/" title="CSS3">CSS3</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于 计算机学科">计算机学科</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/" title="分类于 java">java</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/programming-questions/" title="分类于 编程题">编程题</a></div><span><a href="/computer-science/java/programming-questions/%E5%88%A0%E9%99%A4%E6%8E%92%E5%BA%8F%E9%93%BE%E8%A1%A8%E4%B8%AD%E7%9A%84%E9%87%8D%E5%A4%8D%E5%85%83%E7%B4%A0-83/" title="删除排序链表中的重复元素-83">删除排序链表中的重复元素-83</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于 计算机学科">计算机学科</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/" title="分类于 java">java</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/spring/" title="分类于 spring">spring</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/spring/springcloud/" title="分类于 springcloud">springcloud</a></div><span><a href="/computer-science/java/spring/springcloud/SpringCloud%E5%85%A5%E9%97%A8/" title="零、SpringCloud入门|介绍">零、SpringCloud入门|介绍</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于 计算机学科">计算机学科</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/web/" title="分类于 web">web</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/web/vue/" title="分类于 vue">vue</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/web/vue/vue3/" title="分类于 vue3">vue3</a></div><span><a href="/computer-science/web/vue/vue3/%E7%BB%84%E5%90%88%E5%BC%8FAPI/" title="vue3-组合式API">vue3-组合式API</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/video/" title="分类于 video">video</a> <i class="ic i-angle-right"></i> <a href="/categories/video/movie/" title="分类于 movie">movie</a> <i class="ic i-angle-right"></i> <a href="/categories/video/movie/animation/" title="分类于 animation">animation</a></div><span><a href="/video/movie/animation/%E7%90%A6%E5%AE%AB%E5%A5%87%E9%AA%8F-%E5%8D%83%E4%B8%8E%E5%8D%83%E5%AF%BB/" title="琦宫奇骏-千与千寻">琦宫奇骏-千与千寻</a></span></li></ul></div></div><div class="status"><div class="copyright">&copy; 2010 – <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">Dkx @ Dou的个人博客</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">2.2m 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">33:13</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"computer-science/java/spring/springcloud/Elasticsearch/springcloud-elasticsearch/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="https://cdn.jsdelivr.net/gh/PigPigLetsGo/live2d-widget@latest/autoload.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html>