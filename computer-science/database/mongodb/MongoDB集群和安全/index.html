<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="D の Java" href="https://pigpigletsgo.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" title="D の Java" href="https://pigpigletsgo.github.io/atom.xml"><link rel="alternate" type="application/json" title="D の Java" href="https://pigpigletsgo.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="计算机学科,database,mongodb"><link rel="canonical" href="https://pigpigletsgo.github.io/computer-science/database/mongodb/MongoDB%E9%9B%86%E7%BE%A4%E5%92%8C%E5%AE%89%E5%85%A8/"><title>MongoDB 集群和安全 - mongodb - database - 计算机学科 | D & PersonalBlog = D の Java = 别怕路长梦远</title><meta name="generator" content="Hexo 5.4.2"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">MongoDB 集群和安全</h1><div class="meta"><span class="item" title="创建时间：2024-01-07 08:35:50"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2024-01-07T08:35:50+08:00">2024-01-07</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>87k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>1:20</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">D & PersonalBlog</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/ae23eaf87c243eca94d1200ec5cbee87.jpg"></li><li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/1406d3cdecfa0dd6e62f13a601eb9230.jpg"></li><li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/46d0371c19c0586fb0629e97bac23133.jpg"></li><li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/0a8c679b59d7b4a6f86d891282323a50.jpg"></li><li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/8fe50780c15461b629c9aeab5a7f2acd.jpg"></li><li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/ecce74bba1d6312552d0156083825749.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/computer-science/" itemprop="item" rel="index" title="分类于 计算机学科"><span itemprop="name">计算机学科</span></a><meta itemprop="position" content="1"></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/computer-science/databse/" itemprop="item" rel="index" title="分类于 database"><span itemprop="name">database</span></a><meta itemprop="position" content="2"></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/computer-science/databse/mongodb/" itemprop="item" rel="index" title="分类于 mongodb"><span itemprop="name">mongodb</span></a><meta itemprop="position" content="3"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://pigpigletsgo.github.io/computer-science/database/mongodb/MongoDB%E9%9B%86%E7%BE%A4%E5%92%8C%E5%AE%89%E5%85%A8/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="D"><meta itemprop="description" content="别怕路长梦远, 欢迎来我的博客空间"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="D の Java"></span><div class="body md" itemprop="articleBody"><h1 id="mongodb集群和安全"><a class="anchor" href="#mongodb集群和安全">#</a> MongoDB 集群和安全</h1><p>学习目标：</p><ul><li>MongoDB 的副本集：操作，主要概念，故障转移，选举规则</li><li>MongoDB 的分片集群：概念，有点，操作，分片策略，故障转移</li><li>MongoDB 的安全认证</li></ul><h2 id="副本集-replica-sets"><a class="anchor" href="#副本集-replica-sets">#</a> 副本集 - Replica Sets</h2><h3 id="简介"><a class="anchor" href="#简介">#</a> 简介</h3><p>MongoDB 中的副本集 (Replica Set) 是一组维护相同数据集的 mongod 服务，副本集可提供冗余和高可用性，是所有生产部署的基础。</p><p>也可以说，副本集类似于有自动故障恢复功能的主从集群，通俗的讲就是多台机器进行同一数据的异步同步，从而使多台机器拥有同一数据的多个副本，并且当主库宕掉时在不需要用户干预的情况下自动切换其它备份服务器做主库，而且还可以利用副本服务器做只读服务器，实现读写分离，提高负载</p><p>1. 冗余和数据可用性</p><p>复制提供冗余并提高数据可用性，通过在不同数据库服务器上提供多个数据副本，复制可提供一定级别的容错功能，以防丢失单个数据库服务器。</p><p>在某些情况下，复制可以提供增加的读取性能，因为客户端可以将读取操作发送到不同的服务上，在不同数据中心维护数据副本可以增加分布式应用程序的数据位置和可用性，您还可以为专用目的维护其它副本，例如灾难恢复，报告或备份。</p><p>2.MongoDB 中的复制</p><p>副本集是一组维护相同数据集的 mongod 实例，副本集包含了多个数据承载节点和可选的一个仲载节点，在承载数据节点中，一个且仅一个成员被视为主节点，而其它节点被视为次要（从）节点。<br>主节点接受所有写操作，副本集只能有一个主要能够确认具有 {w:&quot;most&quot;} 写入关注的写入；虽然在某些情况下，另一个 mongod 实例可能暂时认为自己也是主要的，主要记录其操作日志中的数据集的所有更改，即 oplog。</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031657901.png" alt="image-20230605120258300"></p><p>辅助 (副本) 节点复制主节点的 oplog 并将操作应用于其数据集，以使辅助节点的数据集反射主节点的数据集，如果主要人员不在，则符合条件的中学将举行选举以选出新的主要人员</p><p>3. 主从复制和副本集区别</p><p>主从集群和副本集最大的区别就是副本集没有固定的 &quot;主节点&quot;；整个集群会选出一个 &quot;主节点&quot;，当其挂掉后，又在剩下的从节点中选中其它节点为 &quot;主节点&quot;，副本集总有一个活跃点 (主，primary) 和一个或多个备份节点 (从，secondary)。</p><h2 id="副本集的三个角色"><a class="anchor" href="#副本集的三个角色">#</a> 副本集的三个角色</h2><p>副本集有两种类型三种角色</p><p>两种类型：</p><ul><li>主节点 (primary) 类型：数据操作的主要连接点，可读写。</li><li>次要 (辅助，从) 节点 (Secondaries) 类型：数据冗余备份节点，可以读或选举</li></ul><p>三种角色</p><p>主要成员 (Primary)：主要接受所有写操作，就是主节点</p><p>副本成员 (Replicate)：从主节点通过复制操作以维护相同的数据集，即备份数据，不可写操作，但可以读操作 (但需要配置)。是默认的一种从节点类型</p><p>仲裁者 (Arbiter)：不保留任何数据的副本，只具有投票选举作用，当然也可以将仲载服务器维护为副本集的一部分，即副本成员同时也是仲载者，也是一种从节点类型</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031656412.png" alt="image-20230605121334168"></p><p>一<mark>主</mark>一<mark>副</mark>一<mark>仲载</mark></p><h2 id="副本集的创建"><a class="anchor" href="#副本集的创建">#</a> 副本集的创建</h2><h3 id="第一步创建主节点"><a class="anchor" href="#第一步创建主节点">#</a> 第一步创建主节点</h3><p>建立存放数据和日志的目录</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#----------myrs</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">#主节点</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /mongodb/replica_sets/myrs_27017/log <span class="token punctuation">\</span> <span class="token operator">&amp;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /mongodb/replica_sets/myrs_27017/data/db</pre></td></tr></table></figure><p>新建或修改配置文件：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">vim</span> /mongodb/replica_sets/myrs_27017/mongod.conf</pre></td></tr></table></figure><p>往配置文件中写入配置信息</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">systemLog</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token comment">#MongoDB 发送所有日志输出的目标指定为文件</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token comment">#The path of the log file to which mongod or mongos should send all diagnostic logging information</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token key atrule">destination</span><span class="token punctuation">:</span> file</pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token comment">#mongod 或 mongos 应向其发送所有诊断日志记录信息的日志文件的路径</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">"/mongodb/replica_sets/myrs_27017/log/mongod.log"</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token comment">#当 mongos 或 mongod 实例重新启动时，mongos 或 mongod 会将新条目附加到现有日志文件的末尾。</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token key atrule">logAppend</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token key atrule">storage</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token comment">#mongod 实例存储其数据的目录。storage.dbPath 设置仅适用于 mongod。</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token comment">#The directory where the mongod instance stores its data.Defaul value is "/data/db"</span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token key atrule">dbPath</span><span class="token punctuation">:</span> <span class="token string">"/mongodb/replica_sets/myrs_27017/data/db"</span></pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token key atrule">journal</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token comment">#启用或禁用持久性日志以确保数据文件保持有效和可恢复</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token key atrule">processManagement</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token comment">#启用在后台运行 mongos 或 mongod 进程的守护进程模式。</span></pre></td></tr><tr><td data-num="18"></td><td><pre> <span class="token key atrule">fork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="19"></td><td><pre> <span class="token comment">#指定用于保存 mongos 或 mongod 进程的进行 ID 的文件位置，其中 mongos 或 mongod 将写入其 PID</span></pre></td></tr><tr><td data-num="20"></td><td><pre> <span class="token key atrule">pidFilePath</span><span class="token punctuation">:</span> <span class="token string">"/mongodb/replica_sets/myrs_27017/log/mongod.pid"</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token key atrule">net</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token comment">#服务实例绑定 IP，默认是 localhost</span></pre></td></tr><tr><td data-num="23"></td><td><pre> <span class="token key atrule">bindIp</span><span class="token punctuation">:</span> localhost<span class="token punctuation">,</span>192.168.244.142</pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token comment">#bindIp</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token comment">#绑定的端口，默认是 27017</span></pre></td></tr><tr><td data-num="26"></td><td><pre> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">27017</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token key atrule">replication</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="28"></td><td><pre> <span class="token comment">#副本集的名称</span></pre></td></tr><tr><td data-num="29"></td><td><pre> <span class="token key atrule">replSetName</span><span class="token punctuation">:</span> myrs</pre></td></tr></table></figure><h3 id="第二步创建副本节点"><a class="anchor" href="#第二步创建副本节点">#</a> 第二步：创建副本节点</h3><p>建立存放目录</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#----------myrs</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">#主节点</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /mongodb/replica_sets/myrs_27018/log <span class="token punctuation">\</span> <span class="token operator">&amp;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /mongodb/replica_sets/myrs_27018/data/db</pre></td></tr></table></figure><p>新建或修改配置文件:</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">vim</span> /mongodb/replica_sets/myrs_27018/mongod.conf</pre></td></tr></table></figure><p>往配置文件中写入配置信息</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">systemLog</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token comment">#MongoDB 发送所有日志输出的目标指定为文件</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token comment">#The path of the log file to which mongod or mongos should send all diagnostic logging information</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token key atrule">destination</span><span class="token punctuation">:</span> file</pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token comment">#mongod 或 mongos 应向其发送所有诊断日志记录信息的日志文件的路径</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">"/mongodb/replica_sets/myrs_27018/log/mongod.log"</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token comment">#当 mongos 或 mongod 实例重新启动时，mongos 或 mongod 会将新条目附加到现有日志文件的末尾。</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token key atrule">logAppend</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token key atrule">storage</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token comment">#mongod 实例存储其数据的目录。storage.dbPath 设置仅适用于 mongod。</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token comment">#The directory where the mongod instance stores its data.Defaul value is "/data/db"</span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token key atrule">dbPath</span><span class="token punctuation">:</span> <span class="token string">"/mongodb/replica_sets/myrs_27018/data/db"</span></pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token key atrule">journal</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token comment">#启用或禁用持久性日志以确保数据文件保持有效和可恢复</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token key atrule">processManagement</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token comment">#启用在后台运行 mongos 或 mongod 进程的守护进程模式。</span></pre></td></tr><tr><td data-num="18"></td><td><pre> <span class="token key atrule">fork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="19"></td><td><pre> <span class="token comment">#指定用于保存 mongos 或 mongod 进程的进行 ID 的文件位置，其中 mongos 或 mongod 将写入其 PID</span></pre></td></tr><tr><td data-num="20"></td><td><pre> <span class="token key atrule">pidFilePath</span><span class="token punctuation">:</span> <span class="token string">"/mongodb/replica_sets/myrs_27018/log/mongod.pid"</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token key atrule">net</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token comment">#服务实例绑定 IP，默认是 localhost</span></pre></td></tr><tr><td data-num="23"></td><td><pre> <span class="token key atrule">bindIp</span><span class="token punctuation">:</span> localhost<span class="token punctuation">,</span>192.168.244.142</pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token comment">#bindIp</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token comment">#绑定的端口，默认是 27017</span></pre></td></tr><tr><td data-num="26"></td><td><pre> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">27018</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token key atrule">replication</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="28"></td><td><pre> <span class="token comment">#副本集的名称</span></pre></td></tr><tr><td data-num="29"></td><td><pre> <span class="token key atrule">replSetName</span><span class="token punctuation">:</span> myrs</pre></td></tr></table></figure><h3 id="第三步创建仲载节点"><a class="anchor" href="#第三步创建仲载节点">#</a> 第三步：创建仲载节点</h3><p>建立存放目录</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#----------myrs</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">#主节点</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /mongodb/replica_sets/myrs_27019/log <span class="token punctuation">\</span> <span class="token operator">&amp;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /mongodb/replica_sets/myrs_27019/data/db</pre></td></tr></table></figure><p>新建或修改配置文件</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">vim</span> /mongodb/replica_sets/myrs_27019/mongod.conf</pre></td></tr></table></figure><p>往配置中写入配置信息</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">systemLog</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token comment">#MongoDB 发送所有日志输出的目标指定为文件</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token comment">#The path of the log file to which mongod or mongos should send all diagnostic logging information</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token key atrule">destination</span><span class="token punctuation">:</span> file</pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token comment">#mongod 或 mongos 应向其发送所有诊断日志记录信息的日志文件的路径</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">"/mongodb/replica_sets/myrs_27019/log/mongod.log"</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token comment">#当 mongos 或 mongod 实例重新启动时，mongos 或 mongod 会将新条目附加到现有日志文件的末尾。</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token key atrule">logAppend</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token key atrule">storage</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token comment">#mongod 实例存储其数据的目录。storage.dbPath 设置仅适用于 mongod。</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token comment">#The directory where the mongod instance stores its data.Defaul value is "/data/db"</span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token key atrule">dbPath</span><span class="token punctuation">:</span> <span class="token string">"/mongodb/replica_sets/myrs_27019/data/db"</span></pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token key atrule">journal</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token comment">#启用或禁用持久性日志以确保数据文件保持有效和可恢复</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token key atrule">processManagement</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token comment">#启用在后台运行 mongos 或 mongod 进程的守护进程模式。</span></pre></td></tr><tr><td data-num="18"></td><td><pre> <span class="token key atrule">fork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="19"></td><td><pre> <span class="token comment">#指定用于保存 mongos 或 mongod 进程的进行 ID 的文件位置，其中 mongos 或 mongod 将写入其 PID</span></pre></td></tr><tr><td data-num="20"></td><td><pre> <span class="token key atrule">pidFilePath</span><span class="token punctuation">:</span> <span class="token string">"/mongodb/replica_sets/myrs_27019/log/mongod.pid"</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token key atrule">net</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token comment">#服务实例绑定 IP，默认是 localhost</span></pre></td></tr><tr><td data-num="23"></td><td><pre> <span class="token key atrule">bindIp</span><span class="token punctuation">:</span> localhost<span class="token punctuation">,</span>192.168.244.142</pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token comment">#bindIp</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token comment">#绑定的端口，默认是 27017</span></pre></td></tr><tr><td data-num="26"></td><td><pre> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">27019</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token key atrule">replication</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="28"></td><td><pre> <span class="token comment">#副本集的名称</span></pre></td></tr><tr><td data-num="29"></td><td><pre> <span class="token key atrule">replSetName</span><span class="token punctuation">:</span> myrs</pre></td></tr></table></figure><p>启动节点</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>dkx0@192<span class="token punctuation">]</span>~% /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/replica_sets/myrs_27017/log/mongod.conf </pre></td></tr><tr><td data-num="2"></td><td><pre>about to fork child process, waiting <span class="token keyword">until</span> server is ready <span class="token keyword">for</span> connections.</pre></td></tr><tr><td data-num="3"></td><td><pre>forked process: <span class="token number">5300</span></pre></td></tr><tr><td data-num="4"></td><td><pre>child process started successfully, parent exiting</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">[</span>dkx0@192<span class="token punctuation">]</span>~% /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/replica_sets/myrs_27018/log/mongod.conf </pre></td></tr><tr><td data-num="6"></td><td><pre>about to fork child process, waiting <span class="token keyword">until</span> server is ready <span class="token keyword">for</span> connections.</pre></td></tr><tr><td data-num="7"></td><td><pre>forked process: <span class="token number">5367</span></pre></td></tr><tr><td data-num="8"></td><td><pre>child process started successfully, parent exiting</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">[</span>dkx0@192<span class="token punctuation">]</span>~% /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/replica_sets/myrs_27019/log/mongod.conf </pre></td></tr><tr><td data-num="10"></td><td><pre>about to fork child process, waiting <span class="token keyword">until</span> server is ready <span class="token keyword">for</span> connections.</pre></td></tr><tr><td data-num="11"></td><td><pre>forked process: <span class="token number">5434</span></pre></td></tr><tr><td data-num="12"></td><td><pre>child process started successfully, parent exiting</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">[</span>dkx0@192<span class="token punctuation">]</span>~%</pre></td></tr></table></figure><p>查看 mongod 进程</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>dkx0@192<span class="token punctuation">]</span>~% <span class="token function">ps</span> -ef<span class="token operator">|</span><span class="token function">grep</span> mongod<span class="token operator">|</span><span class="token function">grep</span> <span class="token parameter variable">-v</span> <span class="token function">grep</span></pre></td></tr><tr><td data-num="2"></td><td><pre>dkx0       <span class="token number">5300</span>      <span class="token number">1</span>  <span class="token number">4</span> 03:05 ?        00:00:04 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/replica_sets/myrs_27017/log/mongod.conf</pre></td></tr><tr><td data-num="3"></td><td><pre>dkx0       <span class="token number">5367</span>      <span class="token number">1</span>  <span class="token number">5</span> 03:05 ?        00:00:04 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/replica_sets/myrs_27018/log/mongod.conf</pre></td></tr><tr><td data-num="4"></td><td><pre>dkx0       <span class="token number">5434</span>      <span class="token number">1</span>  <span class="token number">8</span> 03:05 ?        00:00:05 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/replica_sets/myrs_27019/log/mongod.conf</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">[</span>dkx0@192<span class="token punctuation">]</span>~%</pre></td></tr></table></figure><h3 id="第四步初始化配置副本集和主节点"><a class="anchor" href="#第四步初始化配置副本集和主节点">#</a> 第四步：初始化配置副本集和主节点</h3><p>使用客户端命令连接任意一个节点，但这里尽量要连接主节点 (27017 节点)：</p><p>在 mongodb 的 bin 目录下执行命令：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>mongo <span class="token parameter variable">--host</span><span class="token operator">=</span>Linux主机地址 <span class="token parameter variable">--port</span><span class="token operator">=</span><span class="token number">27017</span></pre></td></tr></table></figure><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>E:<span class="token punctuation">\</span>MongoDB<span class="token punctuation">\</span>mongodb-win32-x86_64-windows-5.0.17<span class="token punctuation">\</span>bin<span class="token operator">></span>mongo <span class="token parameter variable">--host</span><span class="token operator">=</span><span class="token number">192.168</span>.244.142 <span class="token parameter variable">--port</span><span class="token operator">=</span><span class="token number">27017</span></pre></td></tr><tr><td data-num="2"></td><td><pre>MongoDB shell version v5.0.17</pre></td></tr><tr><td data-num="3"></td><td><pre>connecting to: mongodb://192.168.244.142:27017/?compressors<span class="token operator">=</span>disabled<span class="token operator">&amp;</span><span class="token assign-left variable">gssapiServiceName</span><span class="token operator">=</span>mongodb</pre></td></tr><tr><td data-num="4"></td><td><pre>Implicit session: session <span class="token punctuation">&#123;</span> <span class="token string">"id"</span> <span class="token builtin class-name">:</span> UUID<span class="token punctuation">(</span><span class="token string">"7149483c-b50d-4e69-8086-b2c913d293e3"</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>MongoDB server version: <span class="token number">5.0</span>.18</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span></pre></td></tr><tr><td data-num="7"></td><td><pre>Warning: the <span class="token string">"mongo"</span> shell has been superseded by <span class="token string">"mongosh"</span>,</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token function">which</span> delivers improved usability and compatibility.The <span class="token string">"mongo"</span> shell has been deprecated and will be removed <span class="token keyword">in</span></pre></td></tr><tr><td data-num="9"></td><td><pre>an upcoming release.</pre></td></tr><tr><td data-num="10"></td><td><pre>For installation instructions, see</pre></td></tr><tr><td data-num="11"></td><td><pre>https://docs.mongodb.com/mongodb-shell/install/</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span></pre></td></tr><tr><td data-num="13"></td><td><pre>---</pre></td></tr><tr><td data-num="14"></td><td><pre>The server generated these startup warnings when booting:</pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token number">2023</span>-06-06T03:05:22.021-04:00: Access control is not enabled <span class="token keyword">for</span> the database. Read and <span class="token function">write</span> access to data and configuration is unrestricted</pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token number">2023</span>-06-06T03:05:22.021-04:00: /sys/kernel/mm/transparent_hugepage/enabled is <span class="token string">'always'</span><span class="token builtin class-name">.</span> We suggest setting it to <span class="token string">'never'</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token number">2023</span>-06-06T03:05:22.021-04:00: /sys/kernel/mm/transparent_hugepage/defrag is <span class="token string">'always'</span><span class="token builtin class-name">.</span> We suggest setting it to <span class="token string">'never'</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token number">2023</span>-06-06T03:05:22.021-04:00: Soft rlimits <span class="token keyword">for</span> <span class="token function">open</span> <span class="token function">file</span> descriptors too low</pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token number">2023</span>-06-06T03:05:22.021-04:00:         currentValue: <span class="token number">1024</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token number">2023</span>-06-06T03:05:22.021-04:00:         recommendedMinimum: <span class="token number">64000</span></pre></td></tr><tr><td data-num="21"></td><td><pre>---</pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token operator">></span> show dbs</pre></td></tr><tr><td data-num="23"></td><td><pre>uncaught exception: Error: listDatabases failed:<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token string">"topologyVersion"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>                <span class="token string">"processId"</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">"647edab0454f9ab55a0c8f43"</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="26"></td><td><pre>                <span class="token string">"counter"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token string">"ok"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>,</pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token string">"errmsg"</span> <span class="token builtin class-name">:</span> <span class="token string">"not master and slaveOk=false"</span>,</pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token string">"code"</span> <span class="token builtin class-name">:</span> <span class="token number">13435</span>,</pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token string">"codeName"</span> <span class="token builtin class-name">:</span> <span class="token string">"NotPrimaryNoSecondaryOk"</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token punctuation">&#125;</span> <span class="token builtin class-name">:</span></pre></td></tr><tr><td data-num="33"></td><td><pre>_getErrorWithCode@src/mongo/shell/utils.js:25:13</pre></td></tr><tr><td data-num="34"></td><td><pre>Mongo.prototype.getDBs/<span class="token operator">&lt;</span>@src/mongo/shell/mongo.js:145:19</pre></td></tr><tr><td data-num="35"></td><td><pre>Mongo.prototype.getDBs@src/mongo/shell/mongo.js:97:12</pre></td></tr><tr><td data-num="36"></td><td><pre>shellHelper.show@src/mongo/shell/utils.js:956:13</pre></td></tr><tr><td data-num="37"></td><td><pre>shellHelper@src/mongo/shell/utils.js:838:15</pre></td></tr><tr><td data-num="38"></td><td><pre>@<span class="token punctuation">(</span>shellhelp2<span class="token punctuation">)</span>:1:1</pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token operator">></span> show tables</pre></td></tr><tr><td data-num="40"></td><td><pre>uncaught exception: Error: listCollections failed: <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token string">"topologyVersion"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>                <span class="token string">"processId"</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">"647edab0454f9ab55a0c8f43"</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="43"></td><td><pre>                <span class="token string">"counter"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token string">"ok"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>,</pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token string">"errmsg"</span> <span class="token builtin class-name">:</span> <span class="token string">"not master and slaveOk=false"</span>,</pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token string">"code"</span> <span class="token builtin class-name">:</span> <span class="token number">13435</span>,</pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token string">"codeName"</span> <span class="token builtin class-name">:</span> <span class="token string">"NotPrimaryNoSecondaryOk"</span></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token punctuation">&#125;</span> <span class="token builtin class-name">:</span></pre></td></tr><tr><td data-num="50"></td><td><pre>_getErrorWithCode@src/mongo/shell/utils.js:25:13</pre></td></tr><tr><td data-num="51"></td><td><pre>DB.prototype._getCollectionInfosCommand@src/mongo/shell/db.js:723:15</pre></td></tr><tr><td data-num="52"></td><td><pre>DB.prototype.getCollectionInfos@src/mongo/shell/db.js:771:16</pre></td></tr><tr><td data-num="53"></td><td><pre>shellHelper.show@src/mongo/shell/utils.js:943:9</pre></td></tr><tr><td data-num="54"></td><td><pre>shellHelper@src/mongo/shell/utils.js:838:15</pre></td></tr><tr><td data-num="55"></td><td><pre>@<span class="token punctuation">(</span>shellhelp2<span class="token punctuation">)</span>:1:1</pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token operator">></span></pre></td></tr></table></figure><p>结果，连接上之后，很多命令无法使用，比如 <code>show dbs，show tables</code> 等，必须初始化副本集才行</p><p>准备初始化新的副本集：</p><p>语法：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>rs.initiate<span class="token punctuation">(</span>configuration<span class="token punctuation">)</span></pre></td></tr></table></figure><p>选项：</p><table><caption style="caption-side:bottom">示例</caption><thead><tr><th>Parameter</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td>configuration</td><td>document</td><td>Optional.A document that specifiles configuration for the new replicaset. if a configuration is not specifiled,MongoDB uses a default replicaset configuration</td></tr></tbody></table><p>使用默认的配置来初始化副本集：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>rs.initiate<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>执行结果：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">></span> rs.<span class="token function-name function">initiate</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token string">"info2"</span> <span class="token builtin class-name">:</span> <span class="token string">"no configuration specified. Using a default configuration for the set"</span>,</pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token string">"me"</span> <span class="token builtin class-name">:</span> <span class="token string">"192.168.244.142:27017"</span>,</pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token string">"ok"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>myrs:SECONDARY<span class="token operator">></span></pre></td></tr><tr><td data-num="8"></td><td><pre>myrs:PRIMARY<span class="token operator">></span></pre></td></tr></table></figure><p>提示：</p><ol><li>&quot;ok&quot; 的值为 1，说明创建成功</li><li>命令行提示符发生变化，变成了一个从节点角色，此时默认不能读写，稍等片刻，回车，变成主节点。</li></ol><h3 id="第五步查看副本集的配置内容"><a class="anchor" href="#第五步查看副本集的配置内容">#</a> 第五步：查看副本集的配置内容</h3><p>说明：</p><p>返回包含当前副本集配置的文档</p><p>语法：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>rs.conf<span class="token punctuation">(</span>configuration<span class="token punctuation">)</span></pre></td></tr></table></figure><p>提示：</p><p><code>rs.config()</code> 是该方法的别名</p><p>configuration：可选，如果没有位置，则使用默认主节点配置</p><p>[示例]</p><p>在 27017 上执行副本集中当前节点的默认节点配置</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>myrs:PRIMARY<span class="token operator">></span> rs.<span class="token function-name function">conf</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"myrs"</span>,</pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token string">"version"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token string">"term"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token string">"members"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="7"></td><td><pre>                <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>                        <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>,</pre></td></tr><tr><td data-num="9"></td><td><pre>                        <span class="token string">"host"</span> <span class="token builtin class-name">:</span> <span class="token string">"192.168.244.142:27017"</span>,</pre></td></tr><tr><td data-num="10"></td><td><pre>                        <span class="token string">"arbiterOnly"</span> <span class="token builtin class-name">:</span> false,</pre></td></tr><tr><td data-num="11"></td><td><pre>                        <span class="token string">"buildIndexes"</span> <span class="token builtin class-name">:</span> true,</pre></td></tr><tr><td data-num="12"></td><td><pre>                        <span class="token string">"hidden"</span> <span class="token builtin class-name">:</span> false,</pre></td></tr><tr><td data-num="13"></td><td><pre>                        <span class="token string">"priority"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="14"></td><td><pre>                        <span class="token string">"tags"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>                        <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="17"></td><td><pre>                        <span class="token string">"secondaryDelaySecs"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="18"></td><td><pre>                        <span class="token string">"votes"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token punctuation">]</span>,</pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token string">"protocolVersion"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token string">"writeConcernMajorityJournalDefault"</span> <span class="token builtin class-name">:</span> true,</pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token string">"settings"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>                <span class="token string">"chainingAllowed"</span> <span class="token builtin class-name">:</span> true,</pre></td></tr><tr><td data-num="25"></td><td><pre>                <span class="token string">"heartbeatIntervalMillis"</span> <span class="token builtin class-name">:</span> <span class="token number">2000</span>,</pre></td></tr><tr><td data-num="26"></td><td><pre>                <span class="token string">"heartbeatTimeoutSecs"</span> <span class="token builtin class-name">:</span> <span class="token number">10</span>,</pre></td></tr><tr><td data-num="27"></td><td><pre>                <span class="token string">"electionTimeoutMillis"</span> <span class="token builtin class-name">:</span> <span class="token number">10000</span>,</pre></td></tr><tr><td data-num="28"></td><td><pre>                <span class="token string">"catchUpTimeoutMillis"</span> <span class="token builtin class-name">:</span> -1,</pre></td></tr><tr><td data-num="29"></td><td><pre>                <span class="token string">"catchUpTakeoverDelayMillis"</span> <span class="token builtin class-name">:</span> <span class="token number">30000</span>,</pre></td></tr><tr><td data-num="30"></td><td><pre>                <span class="token string">"getLastErrorModes"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>                <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="33"></td><td><pre>                <span class="token string">"getLastErrorDefaults"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>                        <span class="token string">"w"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="35"></td><td><pre>                        <span class="token string">"wtimeout"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="36"></td><td><pre>                <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="37"></td><td><pre>                <span class="token string">"replicaSetId"</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">"647edd5c454f9ab55a0c8fbf"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>myrs:PRIMARY<span class="token operator">></span></pre></td></tr></table></figure><p>说明：</p><ol><li><code>&quot;_id&quot;:&quot;myrs&quot;</code> ：副本集的配置数据存储的主键值，默认就是副本集的名字</li><li><code>&quot;members&quot;</code> ：副本集成员数组，此时只有一个： <code>&quot;host&quot;:&quot;180.76.159.126:27017&quot;</code> ，该成员不是仲载节点 <code>&quot;arbiterOnly&quot;:false</code> ，优先级 (权重值)： <code>&quot;priority&quot;:1</code></li><li><code>&quot;settings&quot;</code> ：副本集的参数配置。</li></ol><p>提示：副本集配置的查看命令，本质是查询的是 <code>system.replset</code> 的表中的数据</p><h3 id="第六步查看副本集状态"><a class="anchor" href="#第六步查看副本集状态">#</a> 第六步：查看副本集状态</h3><p>检查副本集状态</p><p>说明：</p><p>返回包含状态信息的文档 ，此输出使用从副本集的其它成员发送的心跳包中获得的数据反映副本集的当前状态。</p><p>语法：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>rs.status<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>[示例]</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>myrs:PRIMARY<span class="token operator">></span> rs.<span class="token function-name function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token string">"set"</span> <span class="token builtin class-name">:</span> <span class="token string">"myrs"</span>,</pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token string">"date"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2023-06-06T07:27:48.740Z"</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token string">"myState"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token string">"term"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token string">"syncSourceHost"</span> <span class="token builtin class-name">:</span> <span class="token string">""</span>,</pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token string">"syncSourceId"</span> <span class="token builtin class-name">:</span> -1,</pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token string">"heartbeatIntervalMillis"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token string">"majorityVoteCount"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token string">"writeMajorityCount"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token string">"votingMembersCount"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token string">"writableVotingMembersCount"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token string">"optimes"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                <span class="token string">"lastCommittedOpTime"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                        <span class="token string">"ts"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686036465</span>, <span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="17"></td><td><pre>                        <span class="token string">"t"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="19"></td><td><pre>                <span class="token string">"lastCommittedWallTime"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2023-06-06T07:27:45.336Z"</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="20"></td><td><pre>                <span class="token string">"readConcernMajorityOpTime"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                        <span class="token string">"ts"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686036465</span>, <span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="22"></td><td><pre>                        <span class="token string">"t"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre>                <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="24"></td><td><pre>                <span class="token string">"appliedOpTime"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>                        <span class="token string">"ts"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686036465</span>, <span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="26"></td><td><pre>                        <span class="token string">"t"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="28"></td><td><pre>                <span class="token string">"durableOpTime"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>                        <span class="token string">"ts"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686036465</span>, <span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="30"></td><td><pre>                        <span class="token string">"t"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="32"></td><td><pre>                <span class="token string">"lastAppliedWallTime"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2023-06-06T07:27:45.336Z"</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="33"></td><td><pre>                <span class="token string">"lastDurableWallTime"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2023-06-06T07:27:45.336Z"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token string">"lastStableRecoveryTimestamp"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686036455</span>, <span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token string">"electionCandidateMetrics"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>                <span class="token string">"lastElectionReason"</span> <span class="token builtin class-name">:</span> <span class="token string">"electionTimeout"</span>,</pre></td></tr><tr><td data-num="38"></td><td><pre>                <span class="token string">"lastElectionDate"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2023-06-06T07:16:45.057Z"</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="39"></td><td><pre>                <span class="token string">"electionTerm"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="40"></td><td><pre>                <span class="token string">"lastCommittedOpTimeAtElection"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>                        <span class="token string">"ts"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686035805</span>, <span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="42"></td><td><pre>                        <span class="token string">"t"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span>-1<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="44"></td><td><pre>                <span class="token string">"lastSeenOpTimeAtElection"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>                        <span class="token string">"ts"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686035805</span>, <span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="46"></td><td><pre>                        <span class="token string">"t"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span>-1<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="47"></td><td><pre>                <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="48"></td><td><pre>                <span class="token string">"numVotesNeeded"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="49"></td><td><pre>                <span class="token string">"priorityAtElection"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="50"></td><td><pre>                <span class="token string">"electionTimeoutMillis"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="51"></td><td><pre>                <span class="token string">"newTermStartDate"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2023-06-06T07:16:45.091Z"</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="52"></td><td><pre>                <span class="token string">"wMajorityWriteAvailabilityDate"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2023-06-06T07:16:45.106Z"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="53"></td><td><pre>        <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="54"></td><td><pre>        <span class="token string">"members"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="55"></td><td><pre>                <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>                        <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>,</pre></td></tr><tr><td data-num="57"></td><td><pre>                        <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"192.168.244.142:27017"</span>,</pre></td></tr><tr><td data-num="58"></td><td><pre>                        <span class="token string">"health"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="59"></td><td><pre>                        <span class="token string">"state"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="60"></td><td><pre>                        <span class="token string">"stateStr"</span> <span class="token builtin class-name">:</span> <span class="token string">"PRIMARY"</span>,</pre></td></tr><tr><td data-num="61"></td><td><pre>                        <span class="token string">"uptime"</span> <span class="token builtin class-name">:</span> <span class="token number">1348</span>,</pre></td></tr><tr><td data-num="62"></td><td><pre>                        <span class="token string">"optime"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>                                <span class="token string">"ts"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686036465</span>, <span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="64"></td><td><pre>                                <span class="token string">"t"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="65"></td><td><pre>                        <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="66"></td><td><pre>                        <span class="token string">"optimeDate"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2023-06-06T07:27:45Z"</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="67"></td><td><pre>                        <span class="token string">"lastAppliedWallTime"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2023-06-06T07:27:45.336Z"</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="68"></td><td><pre>                        <span class="token string">"lastDurableWallTime"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2023-06-06T07:27:45.336Z"</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="69"></td><td><pre>                        <span class="token string">"syncSourceHost"</span> <span class="token builtin class-name">:</span> <span class="token string">""</span>,</pre></td></tr><tr><td data-num="70"></td><td><pre>                        <span class="token string">"syncSourceId"</span> <span class="token builtin class-name">:</span> -1,</pre></td></tr><tr><td data-num="71"></td><td><pre>                        <span class="token string">"infoMessage"</span> <span class="token builtin class-name">:</span> <span class="token string">""</span>,</pre></td></tr><tr><td data-num="72"></td><td><pre>                        <span class="token string">"electionTime"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686035805</span>, <span class="token number">2</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="73"></td><td><pre>                        <span class="token string">"electionDate"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2023-06-06T07:16:45Z"</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="74"></td><td><pre>                        <span class="token string">"configVersion"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="75"></td><td><pre>                        <span class="token string">"configTerm"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="76"></td><td><pre>                        <span class="token string">"self"</span> <span class="token builtin class-name">:</span> true,</pre></td></tr><tr><td data-num="77"></td><td><pre>                        <span class="token string">"lastHeartbeatMessage"</span> <span class="token builtin class-name">:</span> <span class="token string">""</span></pre></td></tr><tr><td data-num="78"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>        <span class="token punctuation">]</span>,</pre></td></tr><tr><td data-num="80"></td><td><pre>        <span class="token string">"ok"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="81"></td><td><pre>        <span class="token string">"<span class="token variable">$clusterTime</span>"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>                <span class="token string">"clusterTime"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686036465</span>, <span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="83"></td><td><pre>                <span class="token string">"signature"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>                        <span class="token string">"hash"</span> <span class="token builtin class-name">:</span> BinData<span class="token punctuation">(</span><span class="token number">0</span>,<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAA="</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="85"></td><td><pre>                        <span class="token string">"keyId"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="86"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>        <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="88"></td><td><pre>        <span class="token string">"operationTime"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686036465</span>, <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="89"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>myrs:PRIMARY<span class="token operator">></span></pre></td></tr></table></figure><p>说明：</p><ol><li><code>&quot;set&quot;:&quot;myrs&quot;</code> ：副本集的名字</li><li><code>&quot;myState&quot;:1</code> ：说明状态正常</li><li><code>&quot;members&quot;</code> ：副本集成员数组，此时只有一个： <code>&quot;name&quot;:192.168.244.142:27017</code> ，该成员的角色是 <code>&quot;stateStr&quot;:&quot;PRIMARY&quot;</code> ，该节点是健康的： <code>&quot;health&quot;:1</code></li></ol><h3 id="第七步添加副本从节点"><a class="anchor" href="#第七步添加副本从节点">#</a> 第七步：添加副本从节点</h3><p>在主节点添加从节点，将其它成员加入到副本集</p><p>语法：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>rs.add<span class="token punctuation">(</span>host,arbiterOnly<span class="token punctuation">)</span></pre></td></tr></table></figure><p>选项：</p><table><thead><tr><th>Paraemter</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td>host</td><td>string or document</td><td>要添加到副本集的新成员，指定为字符串或配置文档。1. 如果是一个字符串，则需要指定新成员的主机名和可选的端口号。2. 如果是一个文档，请指定在 members 数组中找到的副本集成员配置文档，您必须在成员配置文档中指定主机字段，有关文档配置字段的说明，详见下方文档：&quot;主机成员的配置文档&quot;</td></tr><tr><td>arbiterOnly</td><td>boolean</td><td>可选的。仅在 &lt;host&gt; 值为字符串时适用。如果为 true，则添加的主机是仲载者</td></tr></tbody></table><p>主机成员的配置文档：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	_id: <span class="token operator">&lt;</span>int<span class="token operator">></span>,</pre></td></tr><tr><td data-num="3"></td><td><pre>	host: <span class="token operator">&lt;</span>String<span class="token operator">></span>,		//required</pre></td></tr><tr><td data-num="4"></td><td><pre>	arbiterOnly: <span class="token operator">&lt;</span>boolean<span class="token operator">></span>,</pre></td></tr><tr><td data-num="5"></td><td><pre>	buildIndexes: <span class="token operator">&lt;</span>boolean<span class="token operator">></span>,</pre></td></tr><tr><td data-num="6"></td><td><pre>	hidden: <span class="token operator">&lt;</span>boolean<span class="token operator">></span>,</pre></td></tr><tr><td data-num="7"></td><td><pre>	priority: <span class="token operator">&lt;</span>number<span class="token operator">></span>,</pre></td></tr><tr><td data-num="8"></td><td><pre>	tags: <span class="token operator">&lt;</span>document<span class="token operator">></span>,</pre></td></tr><tr><td data-num="9"></td><td><pre>	slaveDelay: <span class="token operator">&lt;</span>int<span class="token operator">></span>,</pre></td></tr><tr><td data-num="10"></td><td><pre>	votes: <span class="token operator">&lt;</span>number<span class="token operator">></span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>[示例]</p><p>将 27018 的副本节点添加到副本集中：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>myrs:PRIMARY<span class="token operator">></span> rs.add<span class="token punctuation">(</span><span class="token string">"192.168.244.142:27018"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token string">"ok"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token string">"<span class="token variable">$clusterTime</span>"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>                <span class="token string">"clusterTime"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686037410</span>, <span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="6"></td><td><pre>                <span class="token string">"signature"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>                        <span class="token string">"hash"</span> <span class="token builtin class-name">:</span> BinData<span class="token punctuation">(</span><span class="token number">0</span>,<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAA="</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="8"></td><td><pre>                        <span class="token string">"keyId"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token string">"operationTime"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686037410</span>, <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>myrs:PRIMARY<span class="token operator">></span></pre></td></tr></table></figure><p>说明：</p><ol><li><code>&quot;ok&quot;:1</code> ：说明添加成功。</li></ol><p>查看副本集状态：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>myrs:PRIMARY<span class="token operator">></span> rs.<span class="token function-name function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token string">"set"</span> <span class="token builtin class-name">:</span> <span class="token string">"myrs"</span>,</pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token string">"date"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2023-06-06T07:47:19.794Z"</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token string">"myState"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token string">"term"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token string">"syncSourceHost"</span> <span class="token builtin class-name">:</span> <span class="token string">""</span>,</pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token string">"syncSourceId"</span> <span class="token builtin class-name">:</span> -1,</pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token string">"heartbeatIntervalMillis"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token string">"majorityVoteCount"</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>,</pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token string">"writeMajorityCount"</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>,</pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token string">"votingMembersCount"</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>,</pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token string">"writableVotingMembersCount"</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>,</pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token string">"optimes"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                <span class="token string">"lastCommittedOpTime"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                        <span class="token string">"ts"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686037635</span>, <span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="17"></td><td><pre>                        <span class="token string">"t"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="19"></td><td><pre>                <span class="token string">"lastCommittedWallTime"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2023-06-06T07:47:15.489Z"</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="20"></td><td><pre>                <span class="token string">"readConcernMajorityOpTime"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                        <span class="token string">"ts"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686037635</span>, <span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="22"></td><td><pre>                        <span class="token string">"t"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre>                <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="24"></td><td><pre>                <span class="token string">"appliedOpTime"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>                        <span class="token string">"ts"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686037635</span>, <span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="26"></td><td><pre>                        <span class="token string">"t"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="28"></td><td><pre>                <span class="token string">"durableOpTime"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>                        <span class="token string">"ts"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686037635</span>, <span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="30"></td><td><pre>                        <span class="token string">"t"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="32"></td><td><pre>                <span class="token string">"lastAppliedWallTime"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2023-06-06T07:47:15.489Z"</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="33"></td><td><pre>                <span class="token string">"lastDurableWallTime"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2023-06-06T07:47:15.489Z"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token string">"lastStableRecoveryTimestamp"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686037605</span>, <span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token string">"electionCandidateMetrics"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>                <span class="token string">"lastElectionReason"</span> <span class="token builtin class-name">:</span> <span class="token string">"electionTimeout"</span>,</pre></td></tr><tr><td data-num="38"></td><td><pre>                <span class="token string">"lastElectionDate"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2023-06-06T07:16:45.057Z"</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="39"></td><td><pre>                <span class="token string">"electionTerm"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="40"></td><td><pre>                <span class="token string">"lastCommittedOpTimeAtElection"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>                        <span class="token string">"ts"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686035805</span>, <span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="42"></td><td><pre>                        <span class="token string">"t"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span>-1<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="44"></td><td><pre>                <span class="token string">"lastSeenOpTimeAtElection"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>                        <span class="token string">"ts"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686035805</span>, <span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="46"></td><td><pre>                        <span class="token string">"t"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span>-1<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="47"></td><td><pre>                <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="48"></td><td><pre>                <span class="token string">"numVotesNeeded"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="49"></td><td><pre>                <span class="token string">"priorityAtElection"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="50"></td><td><pre>                <span class="token string">"electionTimeoutMillis"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="51"></td><td><pre>                <span class="token string">"newTermStartDate"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2023-06-06T07:16:45.091Z"</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="52"></td><td><pre>                <span class="token string">"wMajorityWriteAvailabilityDate"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2023-06-06T07:16:45.106Z"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="53"></td><td><pre>        <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="54"></td><td><pre>        <span class="token string">"members"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="55"></td><td><pre>                <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>                        <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>,</pre></td></tr><tr><td data-num="57"></td><td><pre>                        <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"192.168.244.142:27017"</span>,</pre></td></tr><tr><td data-num="58"></td><td><pre>                        <span class="token string">"health"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="59"></td><td><pre>                        <span class="token string">"state"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="60"></td><td><pre>                        <span class="token string">"stateStr"</span> <span class="token builtin class-name">:</span> <span class="token string">"PRIMARY"</span>,</pre></td></tr><tr><td data-num="61"></td><td><pre>                        <span class="token string">"uptime"</span> <span class="token builtin class-name">:</span> <span class="token number">2519</span>,</pre></td></tr><tr><td data-num="62"></td><td><pre>                        <span class="token string">"optime"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>                                <span class="token string">"ts"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686037635</span>, <span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="64"></td><td><pre>                                <span class="token string">"t"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="65"></td><td><pre>                        <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="66"></td><td><pre>                        <span class="token string">"optimeDate"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2023-06-06T07:47:15Z"</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="67"></td><td><pre>                        <span class="token string">"lastAppliedWallTime"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2023-06-06T07:47:15.489Z"</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="68"></td><td><pre>                        <span class="token string">"lastDurableWallTime"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2023-06-06T07:47:15.489Z"</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="69"></td><td><pre>                        <span class="token string">"syncSourceHost"</span> <span class="token builtin class-name">:</span> <span class="token string">""</span>,</pre></td></tr><tr><td data-num="70"></td><td><pre>                        <span class="token string">"syncSourceId"</span> <span class="token builtin class-name">:</span> -1,</pre></td></tr><tr><td data-num="71"></td><td><pre>                        <span class="token string">"infoMessage"</span> <span class="token builtin class-name">:</span> <span class="token string">""</span>,</pre></td></tr><tr><td data-num="72"></td><td><pre>                        <span class="token string">"electionTime"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686035805</span>, <span class="token number">2</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="73"></td><td><pre>                        <span class="token string">"electionDate"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2023-06-06T07:16:45Z"</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="74"></td><td><pre>                        <span class="token string">"configVersion"</span> <span class="token builtin class-name">:</span> <span class="token number">3</span>,</pre></td></tr><tr><td data-num="75"></td><td><pre>                        <span class="token string">"configTerm"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="76"></td><td><pre>                        <span class="token string">"self"</span> <span class="token builtin class-name">:</span> true,</pre></td></tr><tr><td data-num="77"></td><td><pre>                        <span class="token string">"lastHeartbeatMessage"</span> <span class="token builtin class-name">:</span> <span class="token string">""</span></pre></td></tr><tr><td data-num="78"></td><td><pre>                <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="79"></td><td><pre>                <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>                        <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="81"></td><td><pre>                        <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"192.168.244.142:27018"</span>,</pre></td></tr><tr><td data-num="82"></td><td><pre>                        <span class="token string">"health"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="83"></td><td><pre>                        <span class="token string">"state"</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>,</pre></td></tr><tr><td data-num="84"></td><td><pre>                        <span class="token string">"stateStr"</span> <span class="token builtin class-name">:</span> <span class="token string">"SECONDARY"</span>,</pre></td></tr><tr><td data-num="85"></td><td><pre>                        <span class="token string">"uptime"</span> <span class="token builtin class-name">:</span> <span class="token number">229</span>,</pre></td></tr><tr><td data-num="86"></td><td><pre>                        <span class="token string">"optime"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>                                <span class="token string">"ts"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686037635</span>, <span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="88"></td><td><pre>                                <span class="token string">"t"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="89"></td><td><pre>                        <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="90"></td><td><pre>                        <span class="token string">"optimeDurable"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>                                <span class="token string">"ts"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686037635</span>, <span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="92"></td><td><pre>                                <span class="token string">"t"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="93"></td><td><pre>                        <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="94"></td><td><pre>                        <span class="token string">"optimeDate"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2023-06-06T07:47:15Z"</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="95"></td><td><pre>                        <span class="token string">"optimeDurableDate"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2023-06-06T07:47:15Z"</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="96"></td><td><pre>                        <span class="token string">"lastAppliedWallTime"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2023-06-06T07:47:15.489Z"</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="97"></td><td><pre>                        <span class="token string">"lastDurableWallTime"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2023-06-06T07:47:15.489Z"</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="98"></td><td><pre>                        <span class="token string">"lastHeartbeat"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2023-06-06T07:47:18.948Z"</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="99"></td><td><pre>                        <span class="token string">"lastHeartbeatRecv"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2023-06-06T07:47:19.436Z"</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="100"></td><td><pre>                        <span class="token string">"pingMs"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="101"></td><td><pre>                        <span class="token string">"lastHeartbeatMessage"</span> <span class="token builtin class-name">:</span> <span class="token string">""</span>,</pre></td></tr><tr><td data-num="102"></td><td><pre>                        <span class="token string">"syncSourceHost"</span> <span class="token builtin class-name">:</span> <span class="token string">"192.168.244.142:27017"</span>,</pre></td></tr><tr><td data-num="103"></td><td><pre>                        <span class="token string">"syncSourceId"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>,</pre></td></tr><tr><td data-num="104"></td><td><pre>                        <span class="token string">"infoMessage"</span> <span class="token builtin class-name">:</span> <span class="token string">""</span>,</pre></td></tr><tr><td data-num="105"></td><td><pre>                        <span class="token string">"configVersion"</span> <span class="token builtin class-name">:</span> <span class="token number">3</span>,</pre></td></tr><tr><td data-num="106"></td><td><pre>                        <span class="token string">"configTerm"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="107"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="108"></td><td><pre>        <span class="token punctuation">]</span>,</pre></td></tr><tr><td data-num="109"></td><td><pre>        <span class="token string">"ok"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="110"></td><td><pre>        <span class="token string">"<span class="token variable">$clusterTime</span>"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="111"></td><td><pre>                <span class="token string">"clusterTime"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686037635</span>, <span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="112"></td><td><pre>                <span class="token string">"signature"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="113"></td><td><pre>                        <span class="token string">"hash"</span> <span class="token builtin class-name">:</span> BinData<span class="token punctuation">(</span><span class="token number">0</span>,<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAA="</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="114"></td><td><pre>                        <span class="token string">"keyId"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="115"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="116"></td><td><pre>        <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="117"></td><td><pre>        <span class="token string">"operationTime"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686037635</span>, <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="118"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="119"></td><td><pre>myrs:PRIMARY<span class="token operator">></span></pre></td></tr></table></figure><h3 id="第八步添加仲载从节点"><a class="anchor" href="#第八步添加仲载从节点">#</a> 第八步：添加仲载从节点</h3><p>添加一个仲载节点到副本集</p><p>语法：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>rs.addArb<span class="token punctuation">(</span>host<span class="token punctuation">)</span></pre></td></tr></table></figure><p>将 27019 的仲载节点添加到副本集中：</p><p>如果执行命令后没有反应解决办法如下：在主节点中:mys:PRIMARY 执行命令</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">></span> db.adminCommand<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"setDefaultRWConcern"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,<span class="token string">"defaultWriteConcern"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span><span class="token string">"w"</span> <span class="token builtin class-name">:</span> <span class="token number">2</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr></table></figure><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>myrs:PRIMARY<span class="token operator">></span> rs.addArb<span class="token punctuation">(</span><span class="token string">"192.168.244.142:27019"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token string">"ok"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token string">"<span class="token variable">$clusterTime</span>"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>                <span class="token string">"clusterTime"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686038253</span>, <span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="6"></td><td><pre>                <span class="token string">"signature"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>                        <span class="token string">"hash"</span> <span class="token builtin class-name">:</span> BinData<span class="token punctuation">(</span><span class="token number">0</span>,<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAA="</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="8"></td><td><pre>                        <span class="token string">"keyId"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token string">"operationTime"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686038253</span>, <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>myrs:PRIMARY<span class="token operator">></span></pre></td></tr></table></figure><p>说明：</p><ol><li><code>&quot;ok&quot;:1</code> ：说明添加成功</li></ol><p>查看副本集情况：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>myrs:PRIMARY<span class="token operator">></span> rs.<span class="token function-name function">conf</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"myrs"</span>,</pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token string">"version"</span> <span class="token builtin class-name">:</span> <span class="token number">4</span>,</pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token string">"term"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token string">"members"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="7"></td><td><pre>                <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>                        <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>,</pre></td></tr><tr><td data-num="9"></td><td><pre>                        <span class="token string">"host"</span> <span class="token builtin class-name">:</span> <span class="token string">"192.168.244.142:27017"</span>,</pre></td></tr><tr><td data-num="10"></td><td><pre>                        <span class="token string">"arbiterOnly"</span> <span class="token builtin class-name">:</span> false,</pre></td></tr><tr><td data-num="11"></td><td><pre>                        <span class="token string">"buildIndexes"</span> <span class="token builtin class-name">:</span> true,</pre></td></tr><tr><td data-num="12"></td><td><pre>                        <span class="token string">"hidden"</span> <span class="token builtin class-name">:</span> false,</pre></td></tr><tr><td data-num="13"></td><td><pre>                        <span class="token string">"priority"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="14"></td><td><pre>                        <span class="token string">"tags"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>                        <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="17"></td><td><pre>                        <span class="token string">"secondaryDelaySecs"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="18"></td><td><pre>                        <span class="token string">"votes"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="20"></td><td><pre>                <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                        <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="22"></td><td><pre>                        <span class="token string">"host"</span> <span class="token builtin class-name">:</span> <span class="token string">"192.168.244.142:27018"</span>,</pre></td></tr><tr><td data-num="23"></td><td><pre>                        <span class="token string">"arbiterOnly"</span> <span class="token builtin class-name">:</span> false,</pre></td></tr><tr><td data-num="24"></td><td><pre>                        <span class="token string">"buildIndexes"</span> <span class="token builtin class-name">:</span> true,</pre></td></tr><tr><td data-num="25"></td><td><pre>                        <span class="token string">"hidden"</span> <span class="token builtin class-name">:</span> false,</pre></td></tr><tr><td data-num="26"></td><td><pre>                        <span class="token string">"priority"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="27"></td><td><pre>                        <span class="token string">"tags"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>                        <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="30"></td><td><pre>                        <span class="token string">"secondaryDelaySecs"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="31"></td><td><pre>                        <span class="token string">"votes"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="32"></td><td><pre>                <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="33"></td><td><pre>                <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>                        <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>,</pre></td></tr><tr><td data-num="35"></td><td><pre>                        <span class="token string">"host"</span> <span class="token builtin class-name">:</span> <span class="token string">"192.168.244.142:27019"</span>,</pre></td></tr><tr><td data-num="36"></td><td><pre>                        <span class="token string">"arbiterOnly"</span> <span class="token builtin class-name">:</span> true,</pre></td></tr><tr><td data-num="37"></td><td><pre>                        <span class="token string">"buildIndexes"</span> <span class="token builtin class-name">:</span> true,</pre></td></tr><tr><td data-num="38"></td><td><pre>                        <span class="token string">"hidden"</span> <span class="token builtin class-name">:</span> false,</pre></td></tr><tr><td data-num="39"></td><td><pre>                        <span class="token string">"priority"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>,</pre></td></tr><tr><td data-num="40"></td><td><pre>                        <span class="token string">"tags"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>                        <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="43"></td><td><pre>                        <span class="token string">"secondaryDelaySecs"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="44"></td><td><pre>                        <span class="token string">"votes"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="45"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token punctuation">]</span>,</pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token string">"protocolVersion"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token string">"writeConcernMajorityJournalDefault"</span> <span class="token builtin class-name">:</span> true,</pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token string">"settings"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>                <span class="token string">"chainingAllowed"</span> <span class="token builtin class-name">:</span> true,</pre></td></tr><tr><td data-num="51"></td><td><pre>                <span class="token string">"heartbeatIntervalMillis"</span> <span class="token builtin class-name">:</span> <span class="token number">2000</span>,</pre></td></tr><tr><td data-num="52"></td><td><pre>                <span class="token string">"heartbeatTimeoutSecs"</span> <span class="token builtin class-name">:</span> <span class="token number">10</span>,</pre></td></tr><tr><td data-num="53"></td><td><pre>                <span class="token string">"electionTimeoutMillis"</span> <span class="token builtin class-name">:</span> <span class="token number">10000</span>,</pre></td></tr><tr><td data-num="54"></td><td><pre>                <span class="token string">"catchUpTimeoutMillis"</span> <span class="token builtin class-name">:</span> -1,</pre></td></tr><tr><td data-num="55"></td><td><pre>                <span class="token string">"catchUpTakeoverDelayMillis"</span> <span class="token builtin class-name">:</span> <span class="token number">30000</span>,</pre></td></tr><tr><td data-num="56"></td><td><pre>                <span class="token string">"getLastErrorModes"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="57"></td><td><pre></pre></td></tr><tr><td data-num="58"></td><td><pre>                <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="59"></td><td><pre>                <span class="token string">"getLastErrorDefaults"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>                        <span class="token string">"w"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="61"></td><td><pre>                        <span class="token string">"wtimeout"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="62"></td><td><pre>                <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="63"></td><td><pre>                <span class="token string">"replicaSetId"</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">"647edd5c454f9ab55a0c8fbf"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="64"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="65"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>myrs:PRIMARY<span class="token operator">></span></pre></td></tr></table></figure><p>&quot;arbiterOnly&quot; : true, 说明是仲载节点</p><p>查看状态：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>myrs:PRIMARY<span class="token operator">></span> rs.<span class="token function-name function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token string">"set"</span> <span class="token builtin class-name">:</span> <span class="token string">"myrs"</span>,</pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token string">"date"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2023-06-06T08:04:25.601Z"</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token string">"myState"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token string">"term"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token string">"syncSourceHost"</span> <span class="token builtin class-name">:</span> <span class="token string">""</span>,</pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token string">"syncSourceId"</span> <span class="token builtin class-name">:</span> -1,</pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token string">"heartbeatIntervalMillis"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token string">"majorityVoteCount"</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>,</pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token string">"writeMajorityCount"</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>,</pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token string">"votingMembersCount"</span> <span class="token builtin class-name">:</span> <span class="token number">3</span>,</pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token string">"writableVotingMembersCount"</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>,</pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token string">"optimes"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                <span class="token string">"lastCommittedOpTime"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                        <span class="token string">"ts"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686038655</span>, <span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="17"></td><td><pre>                        <span class="token string">"t"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="19"></td><td><pre>                <span class="token string">"lastCommittedWallTime"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2023-06-06T08:04:15.625Z"</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="20"></td><td><pre>                <span class="token string">"readConcernMajorityOpTime"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                        <span class="token string">"ts"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686038655</span>, <span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="22"></td><td><pre>                        <span class="token string">"t"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre>                <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="24"></td><td><pre>                <span class="token string">"appliedOpTime"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>                        <span class="token string">"ts"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686038655</span>, <span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="26"></td><td><pre>                        <span class="token string">"t"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="28"></td><td><pre>                <span class="token string">"durableOpTime"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>                        <span class="token string">"ts"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686038655</span>, <span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="30"></td><td><pre>                        <span class="token string">"t"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="32"></td><td><pre>                <span class="token string">"lastAppliedWallTime"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2023-06-06T08:04:15.625Z"</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="33"></td><td><pre>                <span class="token string">"lastDurableWallTime"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2023-06-06T08:04:15.625Z"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token string">"lastStableRecoveryTimestamp"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686038625</span>, <span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token string">"electionCandidateMetrics"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>                <span class="token string">"lastElectionReason"</span> <span class="token builtin class-name">:</span> <span class="token string">"electionTimeout"</span>,</pre></td></tr><tr><td data-num="38"></td><td><pre>                <span class="token string">"lastElectionDate"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2023-06-06T07:16:45.057Z"</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="39"></td><td><pre>                <span class="token string">"electionTerm"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="40"></td><td><pre>                <span class="token string">"lastCommittedOpTimeAtElection"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>                        <span class="token string">"ts"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686035805</span>, <span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="42"></td><td><pre>                        <span class="token string">"t"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span>-1<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="44"></td><td><pre>                <span class="token string">"lastSeenOpTimeAtElection"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>                        <span class="token string">"ts"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686035805</span>, <span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="46"></td><td><pre>                        <span class="token string">"t"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span>-1<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="47"></td><td><pre>                <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="48"></td><td><pre>                <span class="token string">"numVotesNeeded"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="49"></td><td><pre>                <span class="token string">"priorityAtElection"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="50"></td><td><pre>                <span class="token string">"electionTimeoutMillis"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="51"></td><td><pre>                <span class="token string">"newTermStartDate"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2023-06-06T07:16:45.091Z"</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="52"></td><td><pre>                <span class="token string">"wMajorityWriteAvailabilityDate"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2023-06-06T07:16:45.106Z"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="53"></td><td><pre>        <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="54"></td><td><pre>        <span class="token string">"members"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="55"></td><td><pre>                <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>                        <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>,</pre></td></tr><tr><td data-num="57"></td><td><pre>                        <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"192.168.244.142:27017"</span>,</pre></td></tr><tr><td data-num="58"></td><td><pre>                        <span class="token string">"health"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="59"></td><td><pre>                        <span class="token string">"state"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="60"></td><td><pre>                        <span class="token string">"stateStr"</span> <span class="token builtin class-name">:</span> <span class="token string">"PRIMARY"</span>,</pre></td></tr><tr><td data-num="61"></td><td><pre>                        <span class="token string">"uptime"</span> <span class="token builtin class-name">:</span> <span class="token number">3545</span>,</pre></td></tr><tr><td data-num="62"></td><td><pre>                        <span class="token string">"optime"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>                                <span class="token string">"ts"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686038655</span>, <span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="64"></td><td><pre>                                <span class="token string">"t"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="65"></td><td><pre>                        <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="66"></td><td><pre>                        <span class="token string">"optimeDate"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2023-06-06T08:04:15Z"</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="67"></td><td><pre>                        <span class="token string">"lastAppliedWallTime"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2023-06-06T08:04:15.625Z"</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="68"></td><td><pre>                        <span class="token string">"lastDurableWallTime"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2023-06-06T08:04:15.625Z"</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="69"></td><td><pre>                        <span class="token string">"syncSourceHost"</span> <span class="token builtin class-name">:</span> <span class="token string">""</span>,</pre></td></tr><tr><td data-num="70"></td><td><pre>                        <span class="token string">"syncSourceId"</span> <span class="token builtin class-name">:</span> -1,</pre></td></tr><tr><td data-num="71"></td><td><pre>                        <span class="token string">"infoMessage"</span> <span class="token builtin class-name">:</span> <span class="token string">""</span>,</pre></td></tr><tr><td data-num="72"></td><td><pre>                        <span class="token string">"electionTime"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686035805</span>, <span class="token number">2</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="73"></td><td><pre>                        <span class="token string">"electionDate"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2023-06-06T07:16:45Z"</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="74"></td><td><pre>                        <span class="token string">"configVersion"</span> <span class="token builtin class-name">:</span> <span class="token number">4</span>,</pre></td></tr><tr><td data-num="75"></td><td><pre>                        <span class="token string">"configTerm"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="76"></td><td><pre>                        <span class="token string">"self"</span> <span class="token builtin class-name">:</span> true,</pre></td></tr><tr><td data-num="77"></td><td><pre>                        <span class="token string">"lastHeartbeatMessage"</span> <span class="token builtin class-name">:</span> <span class="token string">""</span></pre></td></tr><tr><td data-num="78"></td><td><pre>                <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="79"></td><td><pre>                <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>                        <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="81"></td><td><pre>                        <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"192.168.244.142:27018"</span>,</pre></td></tr><tr><td data-num="82"></td><td><pre>                        <span class="token string">"health"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="83"></td><td><pre>                        <span class="token string">"state"</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>,</pre></td></tr><tr><td data-num="84"></td><td><pre>                        <span class="token string">"stateStr"</span> <span class="token builtin class-name">:</span> <span class="token string">"SECONDARY"</span>,</pre></td></tr><tr><td data-num="85"></td><td><pre>                        <span class="token string">"uptime"</span> <span class="token builtin class-name">:</span> <span class="token number">1254</span>,</pre></td></tr><tr><td data-num="86"></td><td><pre>                        <span class="token string">"optime"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>                                <span class="token string">"ts"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686038655</span>, <span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="88"></td><td><pre>                                <span class="token string">"t"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="89"></td><td><pre>                        <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="90"></td><td><pre>                        <span class="token string">"optimeDurable"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>                                <span class="token string">"ts"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686038655</span>, <span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="92"></td><td><pre>                                <span class="token string">"t"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="93"></td><td><pre>                        <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="94"></td><td><pre>                        <span class="token string">"optimeDate"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2023-06-06T08:04:15Z"</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="95"></td><td><pre>                        <span class="token string">"optimeDurableDate"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2023-06-06T08:04:15Z"</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="96"></td><td><pre>                        <span class="token string">"lastAppliedWallTime"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2023-06-06T08:04:15.625Z"</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="97"></td><td><pre>                        <span class="token string">"lastDurableWallTime"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2023-06-06T08:04:15.625Z"</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="98"></td><td><pre>                        <span class="token string">"lastHeartbeat"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2023-06-06T08:04:24.037Z"</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="99"></td><td><pre>                        <span class="token string">"lastHeartbeatRecv"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2023-06-06T08:04:24.064Z"</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="100"></td><td><pre>                        <span class="token string">"pingMs"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="101"></td><td><pre>                        <span class="token string">"lastHeartbeatMessage"</span> <span class="token builtin class-name">:</span> <span class="token string">""</span>,</pre></td></tr><tr><td data-num="102"></td><td><pre>                        <span class="token string">"syncSourceHost"</span> <span class="token builtin class-name">:</span> <span class="token string">"192.168.244.142:27017"</span>,</pre></td></tr><tr><td data-num="103"></td><td><pre>                        <span class="token string">"syncSourceId"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>,</pre></td></tr><tr><td data-num="104"></td><td><pre>                        <span class="token string">"infoMessage"</span> <span class="token builtin class-name">:</span> <span class="token string">""</span>,</pre></td></tr><tr><td data-num="105"></td><td><pre>                        <span class="token string">"configVersion"</span> <span class="token builtin class-name">:</span> <span class="token number">4</span>,</pre></td></tr><tr><td data-num="106"></td><td><pre>                        <span class="token string">"configTerm"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="107"></td><td><pre>                <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="108"></td><td><pre>                <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="109"></td><td><pre>                        <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>,</pre></td></tr><tr><td data-num="110"></td><td><pre>                        <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"192.168.244.142:27019"</span>,</pre></td></tr><tr><td data-num="111"></td><td><pre>                        <span class="token string">"health"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="112"></td><td><pre>                        <span class="token string">"state"</span> <span class="token builtin class-name">:</span> <span class="token number">7</span>,</pre></td></tr><tr><td data-num="113"></td><td><pre>                        <span class="token string">"stateStr"</span> <span class="token builtin class-name">:</span> <span class="token string">"ARBITER"</span>,</pre></td></tr><tr><td data-num="114"></td><td><pre>                        <span class="token string">"uptime"</span> <span class="token builtin class-name">:</span> <span class="token number">412</span>,</pre></td></tr><tr><td data-num="115"></td><td><pre>                        <span class="token string">"lastHeartbeat"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2023-06-06T08:04:24.012Z"</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="116"></td><td><pre>                        <span class="token string">"lastHeartbeatRecv"</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2023-06-06T08:04:24.055Z"</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="117"></td><td><pre>                        <span class="token string">"pingMs"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="118"></td><td><pre>                        <span class="token string">"lastHeartbeatMessage"</span> <span class="token builtin class-name">:</span> <span class="token string">""</span>,</pre></td></tr><tr><td data-num="119"></td><td><pre>                        <span class="token string">"syncSourceHost"</span> <span class="token builtin class-name">:</span> <span class="token string">""</span>,</pre></td></tr><tr><td data-num="120"></td><td><pre>                        <span class="token string">"syncSourceId"</span> <span class="token builtin class-name">:</span> -1,</pre></td></tr><tr><td data-num="121"></td><td><pre>                        <span class="token string">"infoMessage"</span> <span class="token builtin class-name">:</span> <span class="token string">""</span>,</pre></td></tr><tr><td data-num="122"></td><td><pre>                        <span class="token string">"configVersion"</span> <span class="token builtin class-name">:</span> <span class="token number">4</span>,</pre></td></tr><tr><td data-num="123"></td><td><pre>                        <span class="token string">"configTerm"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="124"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="125"></td><td><pre>        <span class="token punctuation">]</span>,</pre></td></tr><tr><td data-num="126"></td><td><pre>        <span class="token string">"ok"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="127"></td><td><pre>        <span class="token string">"<span class="token variable">$clusterTime</span>"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="128"></td><td><pre>                <span class="token string">"clusterTime"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686038655</span>, <span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="129"></td><td><pre>                <span class="token string">"signature"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="130"></td><td><pre>                        <span class="token string">"hash"</span> <span class="token builtin class-name">:</span> BinData<span class="token punctuation">(</span><span class="token number">0</span>,<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAA="</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="131"></td><td><pre>                        <span class="token string">"keyId"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="132"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="133"></td><td><pre>        <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="134"></td><td><pre>        <span class="token string">"operationTime"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686038655</span>, <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="135"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="136"></td><td><pre>myrs:PRIMARY<span class="token operator">></span></pre></td></tr></table></figure><p>PRIMARY：主节点，SECONDARY：从节点，ARBITER：仲载节点</p><h2 id="副本集的数据读写操作"><a class="anchor" href="#副本集的数据读写操作">#</a> 副本集的数据读写操作</h2><p>目标：测试三个不同角色的节点的数据读写情况</p><p>登录主节点 27017，写入和读取数据：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>myrs:PRIMARY<span class="token operator">></span> show dbs</pre></td></tr><tr><td data-num="2"></td><td><pre>admin   <span class="token number">0</span>.000GB</pre></td></tr><tr><td data-num="3"></td><td><pre>config  <span class="token number">0</span>.000GB</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token builtin class-name">local</span>   <span class="token number">0</span>.000GB</pre></td></tr><tr><td data-num="5"></td><td><pre>myrs:PRIMARY<span class="token operator">></span> use articledb</pre></td></tr><tr><td data-num="6"></td><td><pre>switched to db articledb</pre></td></tr><tr><td data-num="7"></td><td><pre>myrs:PRIMARY<span class="token operator">></span> db</pre></td></tr><tr><td data-num="8"></td><td><pre>articledb</pre></td></tr><tr><td data-num="9"></td><td><pre>myrs:PRIMARY<span class="token operator">></span> try<span class="token punctuation">&#123;</span>db.comment.insert<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"张三"</span>,<span class="token string">"age"</span><span class="token builtin class-name">:</span><span class="token string">"18"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>catch<span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>print<span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>WriteResult<span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token string">"nInserted"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>myrs:PRIMARY<span class="token operator">></span> db.comment.<span class="token function-name function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#123;</span> <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">"647ee966333697b12ce7258a"</span><span class="token punctuation">)</span>, <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"张三"</span>, <span class="token string">"age"</span> <span class="token builtin class-name">:</span> <span class="token string">"18"</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>myrs:PRIMARY<span class="token operator">></span></pre></td></tr></table></figure><p>登录从节点 27018</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>myrs:SECONDARY<span class="token operator">></span> show dbs</pre></td></tr><tr><td data-num="2"></td><td><pre>uncaught exception: Error: listDatabases failed:<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token string">"topologyVersion"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>                <span class="token string">"processId"</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">"647edabd93b3e543a0258e7d"</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="5"></td><td><pre>                <span class="token string">"counter"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token string">"ok"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>,</pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token string">"errmsg"</span> <span class="token builtin class-name">:</span> <span class="token string">"not master and slaveOk=false"</span>,</pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token string">"code"</span> <span class="token builtin class-name">:</span> <span class="token number">13435</span>,</pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token string">"codeName"</span> <span class="token builtin class-name">:</span> <span class="token string">"NotPrimaryNoSecondaryOk"</span>,</pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token string">"<span class="token variable">$clusterTime</span>"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                <span class="token string">"clusterTime"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686039005</span>, <span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="13"></td><td><pre>                <span class="token string">"signature"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                        <span class="token string">"hash"</span> <span class="token builtin class-name">:</span> BinData<span class="token punctuation">(</span><span class="token number">0</span>,<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAA="</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="15"></td><td><pre>                        <span class="token string">"keyId"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token string">"operationTime"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686039005</span>, <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span> <span class="token builtin class-name">:</span></pre></td></tr><tr><td data-num="20"></td><td><pre>_getErrorWithCode@src/mongo/shell/utils.js:25:13</pre></td></tr><tr><td data-num="21"></td><td><pre>Mongo.prototype.getDBs/<span class="token operator">&lt;</span>@src/mongo/shell/mongo.js:145:19</pre></td></tr><tr><td data-num="22"></td><td><pre>Mongo.prototype.getDBs@src/mongo/shell/mongo.js:97:12</pre></td></tr><tr><td data-num="23"></td><td><pre>shellHelper.show@src/mongo/shell/utils.js:956:13</pre></td></tr><tr><td data-num="24"></td><td><pre>shellHelper@src/mongo/shell/utils.js:838:15</pre></td></tr><tr><td data-num="25"></td><td><pre>@<span class="token punctuation">(</span>shellhelp2<span class="token punctuation">)</span>:1:1</pre></td></tr><tr><td data-num="26"></td><td><pre>myrs:SECONDARY<span class="token operator">></span></pre></td></tr></table></figure><p>发现，不能读取集合的数据。当前从节点只是一个备份，不是奴隶节点，无法读取数据，写当然更不行，因为默认情况下，从节点是没有读写权限的，可以增加读的权限，但需要进行设置。</p><p>设置读操作权限：</p><p>说明：</p><p>设置为奴隶节点，允许在从成员上运行读的操作</p><p>语法：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">></span> rs.slaveOk<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">#或</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token operator">></span> rs.slaveOk<span class="token punctuation">(</span>true<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">#新版本中上面命令可能被弃用了，使用下面命令即可</span></pre></td></tr><tr><td data-num="5"></td><td><pre>rs.secondaryOk<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>提示：</p><p>该命令是 db.getMongo ().setSlaveOk () 的简化命令。</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>myrs:SECONDARY<span class="token operator">></span> rs.secondaryOk<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>myrs:SECONDARY<span class="token operator">></span> show dbs</pre></td></tr><tr><td data-num="3"></td><td><pre>admin      <span class="token number">0</span>.000GB</pre></td></tr><tr><td data-num="4"></td><td><pre>articledb  <span class="token number">0</span>.000GB</pre></td></tr><tr><td data-num="5"></td><td><pre>config     <span class="token number">0</span>.000GB</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token builtin class-name">local</span>      <span class="token number">0</span>.000GB</pre></td></tr><tr><td data-num="7"></td><td><pre>myrs:SECONDARY<span class="token operator">></span></pre></td></tr><tr><td data-num="8"></td><td><pre>myrs:SECONDARY<span class="token operator">></span> use articledb</pre></td></tr><tr><td data-num="9"></td><td><pre>switched to db articledb</pre></td></tr><tr><td data-num="10"></td><td><pre>myrs:SECONDARY<span class="token operator">></span> db.comment.<span class="token function-name function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#123;</span> <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">"647ee966333697b12ce7258a"</span><span class="token punctuation">)</span>, <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"张三"</span>, <span class="token string">"age"</span> <span class="token builtin class-name">:</span> <span class="token string">"18"</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>myrs:SECONDARY<span class="token operator">></span></pre></td></tr></table></figure><p>可以看到可以将主节点插入的数据同步过来</p><p>但仍然不允许插入 <code>&quot;errmsg&quot; : &quot;not master&quot;</code></p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>myrs:SECONDARY<span class="token operator">></span> try<span class="token punctuation">&#123;</span>db.comment.insert<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"李四"</span>,<span class="token string">"age"</span><span class="token builtin class-name">:</span><span class="token string">"20"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>catch<span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>print<span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>WriteCommandError<span class="token punctuation">(</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token string">"topologyVersion"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>                <span class="token string">"processId"</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">"647edabd93b3e543a0258e7d"</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="5"></td><td><pre>                <span class="token string">"counter"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token string">"ok"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>,</pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token string">"errmsg"</span> <span class="token builtin class-name">:</span> <span class="token string">"not master"</span>,</pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token string">"code"</span> <span class="token builtin class-name">:</span> <span class="token number">10107</span>,</pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token string">"codeName"</span> <span class="token builtin class-name">:</span> <span class="token string">"NotWritablePrimary"</span>,</pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token string">"<span class="token variable">$clusterTime</span>"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                <span class="token string">"clusterTime"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686039875</span>, <span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="13"></td><td><pre>                <span class="token string">"signature"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                        <span class="token string">"hash"</span> <span class="token builtin class-name">:</span> BinData<span class="token punctuation">(</span><span class="token number">0</span>,<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAA="</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="15"></td><td><pre>                        <span class="token string">"keyId"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token string">"operationTime"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686039875</span>, <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre>myrs:SECONDARY<span class="token operator">></span></pre></td></tr></table></figure><p>现在可实现了读写分离，让主插入数据，让从来读取数据</p><p>如果要取消奴隶节点的读取权限：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">></span> rs.secondaryOk<span class="token punctuation">(</span>false<span class="token punctuation">)</span></pre></td></tr></table></figure><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>myrs:SECONDARY<span class="token operator">></span> rs.secondaryOk<span class="token punctuation">(</span>false<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>myrs:SECONDARY<span class="token operator">></span> show dbs</pre></td></tr><tr><td data-num="3"></td><td><pre>uncaught exception: Error: listDatabases failed:<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token string">"topologyVersion"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>                <span class="token string">"processId"</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">"647edabd93b3e543a0258e7d"</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="6"></td><td><pre>                <span class="token string">"counter"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token string">"ok"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>,</pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token string">"errmsg"</span> <span class="token builtin class-name">:</span> <span class="token string">"not master and slaveOk=false"</span>,</pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token string">"code"</span> <span class="token builtin class-name">:</span> <span class="token number">13435</span>,</pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token string">"codeName"</span> <span class="token builtin class-name">:</span> <span class="token string">"NotPrimaryNoSecondaryOk"</span>,</pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token string">"<span class="token variable">$clusterTime</span>"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                <span class="token string">"clusterTime"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686039975</span>, <span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="14"></td><td><pre>                <span class="token string">"signature"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                        <span class="token string">"hash"</span> <span class="token builtin class-name">:</span> BinData<span class="token punctuation">(</span><span class="token number">0</span>,<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAA="</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="16"></td><td><pre>                        <span class="token string">"keyId"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token string">"operationTime"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686039975</span>, <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span> <span class="token builtin class-name">:</span></pre></td></tr><tr><td data-num="21"></td><td><pre>_getErrorWithCode@src/mongo/shell/utils.js:25:13</pre></td></tr><tr><td data-num="22"></td><td><pre>Mongo.prototype.getDBs/<span class="token operator">&lt;</span>@src/mongo/shell/mongo.js:145:19</pre></td></tr><tr><td data-num="23"></td><td><pre>Mongo.prototype.getDBs@src/mongo/shell/mongo.js:97:12</pre></td></tr><tr><td data-num="24"></td><td><pre>shellHelper.show@src/mongo/shell/utils.js:956:13</pre></td></tr><tr><td data-num="25"></td><td><pre>shellHelper@src/mongo/shell/utils.js:838:15</pre></td></tr><tr><td data-num="26"></td><td><pre>@<span class="token punctuation">(</span>shellhelp2<span class="token punctuation">)</span>:1:1</pre></td></tr><tr><td data-num="27"></td><td><pre>myrs:SECONDARY<span class="token operator">></span></pre></td></tr></table></figure><p>仲载者节点，不存放任何业务数据的 (存放的是一些配置信息)，可以登录查看，就算设置了 <code>rs.secondaryOk()</code> 同样还是看不到数据</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>myrs:ARBITER<span class="token operator">></span> show dbs</pre></td></tr><tr><td data-num="2"></td><td><pre>uncaught exception: Error: listDatabases failed:<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token string">"topologyVersion"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>                <span class="token string">"processId"</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">"647edaca021ba0c72e879407"</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="5"></td><td><pre>                <span class="token string">"counter"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token string">"ok"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>,</pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token string">"errmsg"</span> <span class="token builtin class-name">:</span> <span class="token string">"not master and slaveOk=false"</span>,</pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token string">"code"</span> <span class="token builtin class-name">:</span> <span class="token number">13435</span>,</pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token string">"codeName"</span> <span class="token builtin class-name">:</span> <span class="token string">"NotPrimaryNoSecondaryOk"</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span> <span class="token builtin class-name">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>_getErrorWithCode@src/mongo/shell/utils.js:25:13</pre></td></tr><tr><td data-num="13"></td><td><pre>Mongo.prototype.getDBs/<span class="token operator">&lt;</span>@src/mongo/shell/mongo.js:145:19</pre></td></tr><tr><td data-num="14"></td><td><pre>Mongo.prototype.getDBs@src/mongo/shell/mongo.js:97:12</pre></td></tr><tr><td data-num="15"></td><td><pre>shellHelper.show@src/mongo/shell/utils.js:956:13</pre></td></tr><tr><td data-num="16"></td><td><pre>shellHelper@src/mongo/shell/utils.js:838:15</pre></td></tr><tr><td data-num="17"></td><td><pre>@<span class="token punctuation">(</span>shellhelp2<span class="token punctuation">)</span>:1:1</pre></td></tr><tr><td data-num="18"></td><td><pre>myrs:ARBITER<span class="token operator">></span></pre></td></tr></table></figure><p>我们想要查看的话就会提示不是 slaveOk 不能读取，但是我们设置仲载可读呢</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>myrs:ARBITER<span class="token operator">></span> rs.secondaryOk<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>myrs:ARBITER<span class="token operator">></span> show dbs</pre></td></tr><tr><td data-num="3"></td><td><pre>uncaught exception: Error: listDatabases failed:<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token string">"topologyVersion"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>                <span class="token string">"processId"</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">"647edaca021ba0c72e879407"</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="6"></td><td><pre>                <span class="token string">"counter"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token string">"ok"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>,</pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token string">"errmsg"</span> <span class="token builtin class-name">:</span> <span class="token string">"node is not in primary or recovering state"</span>,</pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token string">"code"</span> <span class="token builtin class-name">:</span> <span class="token number">13436</span>,</pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token string">"codeName"</span> <span class="token builtin class-name">:</span> <span class="token string">"NotPrimaryOrSecondary"</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span> <span class="token builtin class-name">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>_getErrorWithCode@src/mongo/shell/utils.js:25:13</pre></td></tr><tr><td data-num="14"></td><td><pre>Mongo.prototype.getDBs/<span class="token operator">&lt;</span>@src/mongo/shell/mongo.js:145:19</pre></td></tr><tr><td data-num="15"></td><td><pre>Mongo.prototype.getDBs@src/mongo/shell/mongo.js:97:12</pre></td></tr><tr><td data-num="16"></td><td><pre>shellHelper.show@src/mongo/shell/utils.js:956:13</pre></td></tr><tr><td data-num="17"></td><td><pre>shellHelper@src/mongo/shell/utils.js:838:15</pre></td></tr><tr><td data-num="18"></td><td><pre>@<span class="token punctuation">(</span>shellhelp2<span class="token punctuation">)</span>:1:1</pre></td></tr><tr><td data-num="19"></td><td><pre>myrs:ARBITER<span class="token operator">></span></pre></td></tr></table></figure><p>报错提示翻译：节点未处于主状态或正在恢复状态</p><h2 id="主节点的选举原则"><a class="anchor" href="#主节点的选举原则">#</a> 主节点的选举原则</h2><p>MongoDB 在副本集中，会自动进行主节点的选举，主节点选举的触发条件：</p><ol><li>节点故障</li><li>主节点网络不可达 (默认心跳信息为 10 秒)</li><li>人工干预 (rs.stepDown (600))</li></ol><p>一旦触发选举，就要根据一定规则来选主节点</p><p>选举规则是根据票数来决定谁获胜：</p><ul><li><p>票数最高，且获得了 &quot;大多数&quot; 成员的投票支持的节点获胜</p><p>&quot;大多数&quot; 的定义为：假设复制集内投票成员数量为 N，则大多数为 N/2 + 1，例如：3 个投票成员，则大多数的值是 2，当复制集内存活成员数量不足大多数时，整个复制集将无法选举出 Primary，复制集将无法提供写服务，处于只读状态</p></li><li><p>若投票数相同，且都获得了 &quot;大多数&quot; 成员的投票支持的，数据新的节点获胜。</p><p>数据的新旧是通过操作日志 oplog 来对比的</p></li></ul><p>在获得票数的时候，优先级 (priority) 参数影响重大。</p><p>可以通过设置优先级 (priority) 来设置额外票数，优先级即权重，取值为 0~1000，相当于可额外增加 0 <code>~</code> 1000 的票数，优先级的值越大，就越可能获得多数成员的投票 (votes) 数。指定较高的值可使成员更有资格成员主要成员，更低的值可使成员更不符合条件</p><p>默认情况下，优先级的值是 1</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>myrs:SECONDARY<span class="token operator">></span> rs.<span class="token function-name function">conf</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"myrs"</span>,</pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token string">"version"</span> <span class="token builtin class-name">:</span> <span class="token number">4</span>,</pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token string">"term"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token string">"members"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="7"></td><td><pre>                <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>                        <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>,</pre></td></tr><tr><td data-num="9"></td><td><pre>                        <span class="token string">"host"</span> <span class="token builtin class-name">:</span> <span class="token string">"192.168.244.142:27017"</span>,</pre></td></tr><tr><td data-num="10"></td><td><pre>                        <span class="token string">"arbiterOnly"</span> <span class="token builtin class-name">:</span> false,</pre></td></tr><tr><td data-num="11"></td><td><pre>                        <span class="token string">"buildIndexes"</span> <span class="token builtin class-name">:</span> true,</pre></td></tr><tr><td data-num="12"></td><td><pre>                        <span class="token string">"hidden"</span> <span class="token builtin class-name">:</span> false,</pre></td></tr><tr><td data-num="13"></td><td><pre>                        <span class="token string">"priority"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="14"></td><td><pre>                        <span class="token string">"tags"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>                        <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="17"></td><td><pre>                        <span class="token string">"secondaryDelaySecs"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="18"></td><td><pre>                        <span class="token string">"votes"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="20"></td><td><pre>                <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                        <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="22"></td><td><pre>                        <span class="token string">"host"</span> <span class="token builtin class-name">:</span> <span class="token string">"192.168.244.142:27018"</span>,</pre></td></tr><tr><td data-num="23"></td><td><pre>                        <span class="token string">"arbiterOnly"</span> <span class="token builtin class-name">:</span> false,</pre></td></tr><tr><td data-num="24"></td><td><pre>                        <span class="token string">"buildIndexes"</span> <span class="token builtin class-name">:</span> true,</pre></td></tr><tr><td data-num="25"></td><td><pre>                        <span class="token string">"hidden"</span> <span class="token builtin class-name">:</span> false,</pre></td></tr><tr><td data-num="26"></td><td><pre>                        <span class="token string">"priority"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="27"></td><td><pre>                        <span class="token string">"tags"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>                        <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="30"></td><td><pre>                        <span class="token string">"secondaryDelaySecs"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="31"></td><td><pre>                        <span class="token string">"votes"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="32"></td><td><pre>                <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="33"></td><td><pre>                <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>                        <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>,</pre></td></tr><tr><td data-num="35"></td><td><pre>                        <span class="token string">"host"</span> <span class="token builtin class-name">:</span> <span class="token string">"192.168.244.142:27019"</span>,</pre></td></tr><tr><td data-num="36"></td><td><pre>                        <span class="token string">"arbiterOnly"</span> <span class="token builtin class-name">:</span> true,</pre></td></tr><tr><td data-num="37"></td><td><pre>                        <span class="token string">"buildIndexes"</span> <span class="token builtin class-name">:</span> true,</pre></td></tr><tr><td data-num="38"></td><td><pre>                        <span class="token string">"hidden"</span> <span class="token builtin class-name">:</span> false,</pre></td></tr><tr><td data-num="39"></td><td><pre>                        <span class="token string">"priority"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>,</pre></td></tr><tr><td data-num="40"></td><td><pre>                        <span class="token string">"tags"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>                        <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="43"></td><td><pre>                        <span class="token string">"secondaryDelaySecs"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="44"></td><td><pre>                        <span class="token string">"votes"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="45"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token punctuation">]</span>,</pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token string">"protocolVersion"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token string">"writeConcernMajorityJournalDefault"</span> <span class="token builtin class-name">:</span> true,</pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token string">"settings"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>                <span class="token string">"chainingAllowed"</span> <span class="token builtin class-name">:</span> true,</pre></td></tr><tr><td data-num="51"></td><td><pre>                <span class="token string">"heartbeatIntervalMillis"</span> <span class="token builtin class-name">:</span> <span class="token number">2000</span>,</pre></td></tr><tr><td data-num="52"></td><td><pre>                <span class="token string">"heartbeatTimeoutSecs"</span> <span class="token builtin class-name">:</span> <span class="token number">10</span>,</pre></td></tr><tr><td data-num="53"></td><td><pre>                <span class="token string">"electionTimeoutMillis"</span> <span class="token builtin class-name">:</span> <span class="token number">10000</span>,</pre></td></tr><tr><td data-num="54"></td><td><pre>                <span class="token string">"catchUpTimeoutMillis"</span> <span class="token builtin class-name">:</span> -1,</pre></td></tr><tr><td data-num="55"></td><td><pre>                <span class="token string">"catchUpTakeoverDelayMillis"</span> <span class="token builtin class-name">:</span> <span class="token number">30000</span>,</pre></td></tr><tr><td data-num="56"></td><td><pre>                <span class="token string">"getLastErrorModes"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="57"></td><td><pre></pre></td></tr><tr><td data-num="58"></td><td><pre>                <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="59"></td><td><pre>                <span class="token string">"getLastErrorDefaults"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>                        <span class="token string">"w"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="61"></td><td><pre>                        <span class="token string">"wtimeout"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="62"></td><td><pre>                <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="63"></td><td><pre>                <span class="token string">"replicaSetId"</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">"647edd5c454f9ab55a0c8fbf"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="64"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="65"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>myrs:SECONDARY<span class="token operator">></span></pre></td></tr></table></figure><p>除了仲载节点其它 priority (优先级) 都是 1，仲载不能读写数据它只是一个参与投票的人，仲载不可能为王</p><p>(要注意是，官方说了，仲载节点的优先级必须是 0，不能是别的值，即不具备选举权，但具有投票权)</p><h3 id="修改优先级"><a class="anchor" href="#修改优先级">#</a> 修改优先级</h3><p>比如，下面提升从节点的优先级：</p><ol><li><p>先将配置导入 cfg 变量</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>myrs:SECONDARY<span class="token operator">></span> <span class="token assign-left variable">cfg</span><span class="token operator">=</span>rs.conf<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></table></figure></li><li><p>然后修改值 (ID 号默认从 0 开始)</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>myrs:SECONDARY<span class="token operator">></span> cfg.members<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>.priority<span class="token operator">=</span><span class="token number">2</span></pre></td></tr></table></figure><p>稍等片刻会重新开始选举</p></li></ol><h2 id="故障测试"><a class="anchor" href="#故障测试">#</a> 故障测试</h2><h3 id="副本节点故障测试"><a class="anchor" href="#副本节点故障测试">#</a> 副本节点故障测试</h3><p>关闭 27018 副本节点：</p><p>发现，主节点和仲载节点对 27018 的心跳失败。因为主节点还在，因此，没有触发投票选举。</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>dkx0@192<span class="token punctuation">]</span>~% <span class="token function">ps</span> -ef<span class="token operator">|</span><span class="token function">grep</span> mongod<span class="token operator">|</span><span class="token function">grep</span> <span class="token parameter variable">-v</span> <span class="token function">grep</span></pre></td></tr><tr><td data-num="2"></td><td><pre>dkx0       <span class="token number">5300</span>      <span class="token number">1</span>  <span class="token number">1</span> 03:05 ?        00:07:30 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/replica_sets/myrs_27017/log/mongod.conf</pre></td></tr><tr><td data-num="3"></td><td><pre>dkx0       <span class="token number">5367</span>      <span class="token number">1</span>  <span class="token number">1</span> 03:05 ?        00:07:57 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/replica_sets/myrs_27018/log/mongod.conf</pre></td></tr><tr><td data-num="4"></td><td><pre>dkx0       <span class="token number">5434</span>      <span class="token number">1</span>  <span class="token number">1</span> 03:05 ?        00:06:20 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/replica_sets/myrs_27019/log/mongod.conf</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">[</span>dkx0@192<span class="token punctuation">]</span>~% <span class="token function">kill</span> <span class="token parameter variable">-2</span> <span class="token number">5367</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">[</span>dkx0@192<span class="token punctuation">]</span>~% <span class="token function">ps</span> -ef<span class="token operator">|</span><span class="token function">grep</span> mongod<span class="token operator">|</span><span class="token function">grep</span> <span class="token parameter variable">-v</span> <span class="token function">grep</span></pre></td></tr><tr><td data-num="7"></td><td><pre>dkx0       <span class="token number">5300</span>      <span class="token number">1</span>  <span class="token number">1</span> 03:05 ?        00:07:31 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/replica_sets/myrs_27017/log/mongod.conf</pre></td></tr><tr><td data-num="8"></td><td><pre>dkx0       <span class="token number">5367</span>      <span class="token number">1</span>  <span class="token number">1</span> 03:05 ?        00:07:58 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/replica_sets/myrs_27018/log/mongod.conf</pre></td></tr><tr><td data-num="9"></td><td><pre>dkx0       <span class="token number">5434</span>      <span class="token number">1</span>  <span class="token number">1</span> 03:05 ?        00:06:20 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/replica_sets/myrs_27019/log/mongod.conf</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">[</span>dkx0@192<span class="token punctuation">]</span>~% <span class="token function">ps</span> -ef<span class="token operator">|</span><span class="token function">grep</span> mongod<span class="token operator">|</span><span class="token function">grep</span> <span class="token parameter variable">-v</span> <span class="token function">grep</span></pre></td></tr><tr><td data-num="11"></td><td><pre>dkx0       <span class="token number">5300</span>      <span class="token number">1</span>  <span class="token number">1</span> 03:05 ?        00:07:31 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/replica_sets/myrs_27017/log/mongod.conf</pre></td></tr><tr><td data-num="12"></td><td><pre>dkx0       <span class="token number">5434</span>      <span class="token number">1</span>  <span class="token number">1</span> 03:05 ?        00:06:21 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/replica_sets/myrs_27019/log/mongod.conf</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">[</span>dkx0@192<span class="token punctuation">]</span>~%</pre></td></tr></table></figure><p>kill -2 没有及时杀掉，证明了 - 2 是等待任务完成自动杀掉而不是暴力杀掉的。</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>myrs:SECONDARY<span class="token operator">></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token operator">></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token operator">></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token operator">></span></pre></td></tr></table></figure><p>从节点被杀掉后按几下回车看下反应，已经没反应了。</p><p>如果此时，在主节点写入数据。</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>myrs:PRIMARY<span class="token operator">></span> db.comment.insert<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"_id"</span><span class="token builtin class-name">:</span><span class="token string">"3"</span>,<span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"马保国"</span>,<span class="token string">"age"</span><span class="token builtin class-name">:</span><span class="token string">"22"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>再启动从节点并赋予可读权限，会发现，主节点写入的数据，会自动同步给从节点。</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>myrs:SECONDARY<span class="token operator">></span> rs.secondaryOk<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>myrs:SECONDARY<span class="token operator">></span> use articledb</pre></td></tr><tr><td data-num="3"></td><td><pre>switched to db articledb</pre></td></tr><tr><td data-num="4"></td><td><pre>myrs:SECONDARY<span class="token operator">></span> db.comment.<span class="token function-name function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span> <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">"647ee966333697b12ce7258a"</span><span class="token punctuation">)</span>, <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"张三"</span>, <span class="token string">"age"</span> <span class="token builtin class-name">:</span> <span class="token string">"18"</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#123;</span> <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"3"</span>, <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"马保国"</span>, <span class="token string">"age"</span> <span class="token builtin class-name">:</span> <span class="token string">"22"</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#123;</span> <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">"647f48485710428bcfbf9dbf"</span><span class="token punctuation">)</span>, <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"李四"</span>, <span class="token string">"age"</span> <span class="token builtin class-name">:</span> <span class="token string">"23"</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#123;</span> <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"2"</span>, <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"123"</span>, <span class="token string">"age"</span> <span class="token builtin class-name">:</span> <span class="token string">"23"</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>myrs:SECONDARY<span class="token operator">></span></pre></td></tr></table></figure><p>可以看到数据同步过来了 &quot;马保国&quot;</p><h3 id="主节点故障测试"><a class="anchor" href="#主节点故障测试">#</a> 主节点故障测试</h3><p>关闭 27017 节点</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>dkx0@192<span class="token punctuation">]</span>~% <span class="token function">kill</span> <span class="token parameter variable">-2</span> <span class="token number">5300</span>                   </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span>dkx0@192<span class="token punctuation">]</span>~% <span class="token function">ps</span> -ef<span class="token operator">|</span><span class="token function">grep</span> mongod<span class="token operator">|</span><span class="token function">grep</span> <span class="token parameter variable">-v</span> <span class="token function">grep</span></pre></td></tr><tr><td data-num="3"></td><td><pre>dkx0       <span class="token number">5434</span>      <span class="token number">1</span>  <span class="token number">1</span> 03:05 ?        00:06:34 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/replica_sets/myrs_27019/log/mongod.conf</pre></td></tr><tr><td data-num="4"></td><td><pre>dkx0      <span class="token number">29707</span>      <span class="token number">1</span>  <span class="token number">3</span> <span class="token number">11</span>:01 ?        00:00:06 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/replica_sets/myrs_27018/log/mongod.conf</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">[</span>dkx0@192<span class="token punctuation">]</span>~%</pre></td></tr></table></figure><p>发现，从节点和仲载节点对 27017 的心跳失败，当失败超过 10 秒，此时因为没有了主节点，会自动发起投票。</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>myrs:PRIMARY<span class="token operator">></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token operator">></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token operator">></span></pre></td></tr></table></figure><p>27017 节点已挂</p><p>而副本节点只有 27018，因此，候选人只有一个就是 27018，开始投票。</p><p>27019 向 27018 投了一票，27018 本身自带一票，因此共两票，超过了 &quot;大多数&quot;</p><p>27019 是仲载节点，没有选举权，27018 不向其投票，其票数是 0.</p><p>最终结果，27018 成为主节点，具备读写功能。</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>myrs:SECONDARY<span class="token operator">></span></pre></td></tr><tr><td data-num="2"></td><td><pre>myrs:PRIMARY<span class="token operator">></span></pre></td></tr></table></figure><p>回车刷新状态</p><p>在 27018 写入数据查看。</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>myrs:PRIMARY<span class="token operator">></span> db.comment.insert<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"_id"</span><span class="token builtin class-name">:</span><span class="token string">"4"</span>,<span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"弟中之弟"</span>,<span class="token string">"age"</span><span class="token builtin class-name">:</span><span class="token string">"123"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>myrs:PRIMARY<span class="token operator">></span> db.comment.<span class="token function-name function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span> <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">"647ee966333697b12ce7258a"</span><span class="token punctuation">)</span>, <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"张三"</span>, <span class="token string">"age"</span> <span class="token builtin class-name">:</span> <span class="token string">"18"</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#123;</span> <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"3"</span>, <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"马保国"</span>, <span class="token string">"age"</span> <span class="token builtin class-name">:</span> <span class="token string">"22"</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span> <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">"647f48485710428bcfbf9dbf"</span><span class="token punctuation">)</span>, <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"李四"</span>, <span class="token string">"age"</span> <span class="token builtin class-name">:</span> <span class="token string">"23"</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#123;</span> <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"2"</span>, <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"123"</span>, <span class="token string">"age"</span> <span class="token builtin class-name">:</span> <span class="token string">"23"</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#123;</span> <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"4"</span>, <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"弟中之弟"</span>, <span class="token string">"age"</span> <span class="token builtin class-name">:</span> <span class="token string">"123"</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>myrs:PRIMARY<span class="token operator">></span></pre></td></tr></table></figure><p>再启动 27017 节点，发现 27017 变成了从节点，27018 仍保持主节点。</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>dkx0@192<span class="token punctuation">]</span>~% /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/replica_sets/myrs_27017/log/mongod.conf </pre></td></tr><tr><td data-num="2"></td><td><pre>about to fork child process, waiting <span class="token keyword">until</span> server is ready <span class="token keyword">for</span> connections.</pre></td></tr><tr><td data-num="3"></td><td><pre>forked process: <span class="token number">30161</span></pre></td></tr><tr><td data-num="4"></td><td><pre>child process started successfully, parent exiting</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">[</span>dkx0@192<span class="token punctuation">]</span>~%</pre></td></tr></table></figure><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>E:<span class="token punctuation">\</span>MongoDB<span class="token punctuation">\</span>mongodb-win32-x86_64-windows-5.0.17<span class="token punctuation">\</span>bin<span class="token operator">></span>mongo <span class="token parameter variable">--host</span><span class="token operator">=</span><span class="token number">192.168</span>.244.142 <span class="token parameter variable">--port</span><span class="token operator">=</span><span class="token number">27017</span></pre></td></tr><tr><td data-num="2"></td><td><pre>MongoDB server version: <span class="token number">5.0</span>.18</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span></pre></td></tr><tr><td data-num="4"></td><td><pre>Warning: the <span class="token string">"mongo"</span> shell has been superseded by <span class="token string">"mongosh"</span>,</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token function">which</span> delivers improved usability and compatibility.The <span class="token string">"mongo"</span> shell has been deprecated and will be removed <span class="token keyword">in</span></pre></td></tr><tr><td data-num="6"></td><td><pre>an upcoming release.</pre></td></tr><tr><td data-num="7"></td><td><pre>For installation instructions, see</pre></td></tr><tr><td data-num="8"></td><td><pre>https://docs.mongodb.com/mongodb-shell/install/</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span></pre></td></tr><tr><td data-num="10"></td><td><pre>---</pre></td></tr><tr><td data-num="11"></td><td><pre>The server generated these startup warnings when booting:</pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token number">2023</span>-06-06T11:07:33.780-04:00: Access control is not enabled <span class="token keyword">for</span> the database. Read and <span class="token function">write</span> access to data and configuration is unrestricted</pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token number">2023</span>-06-06T11:07:33.781-04:00: /sys/kernel/mm/transparent_hugepage/enabled is <span class="token string">'always'</span><span class="token builtin class-name">.</span> We suggest setting it to <span class="token string">'never'</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token number">2023</span>-06-06T11:07:33.781-04:00: /sys/kernel/mm/transparent_hugepage/defrag is <span class="token string">'always'</span><span class="token builtin class-name">.</span> We suggest setting it to <span class="token string">'never'</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token number">2023</span>-06-06T11:07:33.781-04:00: Soft rlimits <span class="token keyword">for</span> <span class="token function">open</span> <span class="token function">file</span> descriptors too low</pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token number">2023</span>-06-06T11:07:33.781-04:00:         currentValue: <span class="token number">1024</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token number">2023</span>-06-06T11:07:33.781-04:00:         recommendedMinimum: <span class="token number">64000</span></pre></td></tr><tr><td data-num="18"></td><td><pre>---</pre></td></tr><tr><td data-num="19"></td><td><pre>myrs:SECONDARY<span class="token operator">></span></pre></td></tr></table></figure><p>登录 27017 节点，发现是从节点了需要赋予可读权限，数据自动从 27018 同步。</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>myrs:SECONDARY<span class="token operator">></span> use articledb</pre></td></tr><tr><td data-num="2"></td><td><pre>switched to db articledb</pre></td></tr><tr><td data-num="3"></td><td><pre>myrs:SECONDARY<span class="token operator">></span> db.comment.find<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>Error: error: <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token string">"topologyVersion"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>                <span class="token string">"processId"</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">"647f4bb2f95feeec6c69242c"</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="7"></td><td><pre>                <span class="token string">"counter"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token string">"ok"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>,</pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token string">"errmsg"</span> <span class="token builtin class-name">:</span> <span class="token string">"not master and slaveOk=false"</span>,</pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token string">"code"</span> <span class="token builtin class-name">:</span> <span class="token number">13435</span>,</pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token string">"codeName"</span> <span class="token builtin class-name">:</span> <span class="token string">"NotPrimaryNoSecondaryOk"</span>,</pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token string">"<span class="token variable">$clusterTime</span>"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                <span class="token string">"clusterTime"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686064102</span>, <span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="15"></td><td><pre>                <span class="token string">"signature"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                        <span class="token string">"hash"</span> <span class="token builtin class-name">:</span> BinData<span class="token punctuation">(</span><span class="token number">0</span>,<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAA="</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="17"></td><td><pre>                        <span class="token string">"keyId"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token string">"operationTime"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686064102</span>, <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>myrs:SECONDARY<span class="token operator">></span> rs.secondaryOk<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre>myrs:SECONDARY<span class="token operator">></span> db.comment.<span class="token function-name function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">&#123;</span> <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">"647ee966333697b12ce7258a"</span><span class="token punctuation">)</span>, <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"张三"</span>, <span class="token string">"age"</span> <span class="token builtin class-name">:</span> <span class="token string">"18"</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">&#123;</span> <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">"647f48485710428bcfbf9dbf"</span><span class="token punctuation">)</span>, <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"李四"</span>, <span class="token string">"age"</span> <span class="token builtin class-name">:</span> <span class="token string">"23"</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">&#123;</span> <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"2"</span>, <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"123"</span>, <span class="token string">"age"</span> <span class="token builtin class-name">:</span> <span class="token string">"23"</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">&#123;</span> <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"3"</span>, <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"马保国"</span>, <span class="token string">"age"</span> <span class="token builtin class-name">:</span> <span class="token string">"22"</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">&#123;</span> <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"4"</span>, <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"弟中之弟"</span>, <span class="token string">"age"</span> <span class="token builtin class-name">:</span> <span class="token string">"123"</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>myrs:SECONDARY<span class="token operator">></span></pre></td></tr></table></figure><p>从而实现了高可用。</p><h3 id="仲载节点和主节点故障"><a class="anchor" href="#仲载节点和主节点故障">#</a> 仲载节点和主节点故障</h3><p>先关掉仲载节点 27019</p><p>关掉现在的主节点 27018</p><p>登录 27017 后，发现，27017 仍然是从节点，副本集中没有主节点了，导致此时，副本集是只读状态，无法写入</p><p>为啥不选举了？因为 27017 的票数，没有获得大多数，既没有大于等于 2，它只有默认的一票 (优先级是 1)</p><p>如果要出发选举，随便加入一个成员即可。</p><ul><li>如果只加入 27019 仲载节点，则主节点一定是 27017，因为没得选了，仲载节点不参与选举，但参与投票</li><li>如果只加入 27018，会发起选举，因为 27017 和 27018 都是两票，按照谁数据新，谁当主节点。</li></ul><h3 id="仲载节点和从节点故障"><a class="anchor" href="#仲载节点和从节点故障">#</a> 仲载节点和从节点故障</h3><p>先关掉仲载节点 27019</p><p>关掉现在的副本节点 27018</p><p>10 秒后，27017 主节点自动降级为副本节点 (服务降级)</p><p>副本集不可写数据了，已经故障了。</p><h2 id="compass连接副本集"><a class="anchor" href="#compass连接副本集">#</a> Compass 连接副本集</h2><p>如果使用云服务器需要修改配置中的主节点 IP</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>var config <span class="token operator">=</span> rs.config<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> config.members<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>.host<span class="token operator">=</span><span class="token string">"192.168.244.142:27017"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> rs.reconfig<span class="token punctuation">(</span>config<span class="token punctuation">)</span></pre></td></tr></table></figure><p>compass 连接：</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031658537.png" alt="image-20230606234834193"></p><p>输入后直接连接即可。</p><p>注意：</p><p>但是在 Compass 中即便连接的是 secondary 从节点但是还是可以插入数据的。</p><h2 id="springdatamongodb连接副本集"><a class="anchor" href="#springdatamongodb连接副本集">#</a> SpringDataMongoDB 连接副本集</h2><p>副本集语法：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>mongodb://host1,host2,host3/?connect<span class="token operator">=</span>replicaSet<span class="token operator">&amp;</span><span class="token assign-left variable">secondaryOk</span><span class="token operator">=</span>true<span class="token operator">&amp;</span><span class="token assign-left variable">replicaSet</span><span class="token operator">=</span>副本集名字</pre></td></tr></table></figure><p>其中：</p><ul><li>secondaryOk=true：开启副本节点读的功能，实现读写分离。</li><li>connect=replicaSet：自动到副本集中选择读写的主机，如果 secondaryOk 是打开的，则实现了读写分离</li></ul><p>[示例]</p><p>连接 replica set 三台服务器 (端口 27017，27018，和 27019)，直接连接第一个服务器，无论是 replica set 一部分或者主服务器或者从服务器，写入操作应用在主服务器并且分布查询到从服务器。</p><p>修改配置文件：application.yml</p><p>连接副本集的时候就只能使用 uri 的格式了</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">spring</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token comment">#数据源配置</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token key atrule">data</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token key atrule">mongodb</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>      <span class="token comment">#主机地址</span></pre></td></tr><tr><td data-num="6"></td><td><pre>      <span class="token comment">#host: 192.168.244.142</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token comment">#数据库</span></pre></td></tr><tr><td data-num="8"></td><td><pre>      <span class="token comment">#database: articledb</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token comment">#端口号</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token comment">#port: 27017</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token comment">#也可以使用 uri 连接</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token comment">#uri: mongodb://192.168.244.142:27017/articledb</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token comment">#副本集的连接字符串</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token key atrule">uri</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        mongodb<span class="token punctuation">:</span>//192.168.244.142<span class="token punctuation">:</span><span class="token number">27017</span><span class="token punctuation">,</span>192.168.244.142<span class="token punctuation">:</span><span class="token number">27018</span><span class="token punctuation">,</span>192.168.244.142<span class="token punctuation">:</span>27019/articledb<span class="token punctuation">?</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        connect=replicaSet<span class="token important">&amp;secondaryOk=true&amp;replicaSet=myrs</span></pre></td></tr></table></figure><p>测试是否可用：查询全部数据</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Test</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>   <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Comment</span><span class="token punctuation">></span></span> list <span class="token operator">=</span> commentService<span class="token punctuation">.</span><span class="token function">findCommentList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Comment</span> i<span class="token operator">:</span>list<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token constant">RUN</span> <span class="token class-name">Result</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token class-name">Comment</span><span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">647</span>ee966333697b12ce7258a<span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> publishtime<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> userid<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> nickname<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> createdatatim<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> likenum<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> replynum<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> state<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> parentid<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> articleid<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token class-name">Comment</span><span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> publishtime<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> userid<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> nickname<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> createdatatim<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> likenum<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> replynum<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> state<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> parentid<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> articleid<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token class-name">Comment</span><span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">647f</span><span class="token number">48485710428</span>bcfbf9dbf<span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> publishtime<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> userid<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> nickname<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> createdatatim<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> likenum<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> replynum<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> state<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> parentid<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> articleid<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token class-name">Comment</span><span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> publishtime<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> userid<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> nickname<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> createdatatim<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> likenum<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> replynum<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> state<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> parentid<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> articleid<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token class-name">Comment</span><span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> publishtime<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> userid<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> nickname<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> createdatatim<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> likenum<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> replynum<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> state<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> parentid<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> articleid<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token class-name">Comment</span><span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">647f</span><span class="token number">5445f</span><span class="token number">81</span>b0775f8f31924<span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> publishtime<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> userid<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> nickname<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> createdatatim<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> likenum<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> replynum<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> state<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> parentid<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> articleid<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token class-name">Comment</span><span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">647f</span><span class="token number">54</span>b24cf08bc145fd6995<span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> publishtime<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> userid<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> nickname<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> createdatatim<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> likenum<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> replynum<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> state<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> parentid<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> articleid<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>id 能查出来就证明可用，其它为 null 是因为实体类与表结构</p><p>注意：</p><p>主机必须是副本集中所有的主机，包括主节点，副本节点，仲载节点。</p><h2 id="分片集群-sharded-cluster"><a class="anchor" href="#分片集群-sharded-cluster">#</a> 分片集群 - Sharded Cluster</h2><h3 id="分片概念"><a class="anchor" href="#分片概念">#</a> 分片概念</h3><p>分片 (sharding) 是一种跨多台机器分布数据的方法，MongoDB 使用分片来支持具有非常大的数据集和高吞吐量操作的部署。</p><p>换句话说：分片 (sharding) 是指将数据拆分，将其分散存在不同的机器上的过程，有时也用分区 (partitioning) 来表示这个概念，将数据分散道不同的机器上，不需要功能强大的大型计算机就可以存储更多的数据，处理更多的负载。</p><p>具有大型数据集或吞吐量应用程序的数据库系统可以会挑战单个服务器的容量，例如，高查询率会耗尽服务器的 CPU 容量，工作集大小大于系统的 RAM 会强调磁盘驱动的 I/O 容量</p><p>有两种解决系统增长的办法：垂直扩展和水平扩展。</p><p>垂直扩展意味着增加单个服务器的容量，例如使用更强大的 CPU，添加更多 RAM 或增加存储空间量。可用技术的局限性可能会限制单个机器对于给定工作负载而言而言足够强大，此外，基于云 的提供商基于可用的硬件配置具有硬性上限，结果，垂直缩放有实际的最大值</p><p>水平扩展意味着划分系统数据集并加载多个服务器，添加其他服务器以根据需要增加容量，虽然单个机器的总题速度或容量可能不高，但每台机器处理整个工作负载的子集，可能提供比单个高速大容量服务器更高的效率，扩展部署容量只需要根据需要添加额外的服务器，这可能比单个机器的高端硬件的总体成本更低，权衡是基础架构和部署维护的复杂性增加。</p><p>MongoDB 支持通过分片进行水平扩展。</p><h3 id="分片集群包含的组件"><a class="anchor" href="#分片集群包含的组件">#</a> 分片集群包含的组件</h3><p>MongoDB 分片集群包含以下组件：</p><ul><li>分片 (存储)：每个分片包含分片数据的子集，每个分片都可以部署为副本集</li><li>mongos (路由)：mongos 充当查询路由器，在客户端应用程序和分片集群之间提供接口</li><li>config server (&quot;调度&quot; 的配置)：配置服务器存储群集的元数据和配置设置，从 MongoDB3.4 开始，必须将配置服务器部署为副本集 (CSRS)</li></ul><p>下图描述了分片集群中组件的交互：</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031659686.png" alt="image-20230607171021552"></p><p>MongoDB 在集合级别对数据库进行分片，将集合数据分布在集群中的分片上</p><p>27018 if mongod is a shared member</p><p>27019 if mongod is a config server member</p><h3 id="分片集群架构目标"><a class="anchor" href="#分片集群架构目标">#</a> 分片集群架构目标</h3><p>两个分片节点副本集 (3+3) + 一个配置节点副本集 (3) + 两个路由节点 (2) ，共 11 个服务节点。</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031659822.png" alt="image-20230607171256122"></p><h3 id="分片存储节点副本集的创建"><a class="anchor" href="#分片存储节点副本集的创建">#</a> 分片 (存储) 节点副本集的创建</h3><p>所有的配置文件都直接放到 sharded_cluster 的相应的子目录下，默认配置文件名字：mongod.conf</p><h3 id="第一套副本集"><a class="anchor" href="#第一套副本集">#</a> 第一套副本集</h3><p>准备存放数据和日志的目录</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /mongodb/sharded_cluster/myshardrs01_27018/log <span class="token punctuation">\</span> <span class="token operator">&amp;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /mongodb/sharded_cluster/myshardrs01_27018/data/db <span class="token punctuation">\</span> <span class="token operator">&amp;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /mongodb/sharded_cluster/myshardrs01_27118/log <span class="token punctuation">\</span> <span class="token operator">&amp;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /mongodb/sharded_cluster/myshardrs01_27118/data/db <span class="token punctuation">\</span> <span class="token operator">&amp;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /mongodb/sharded_cluster/myshardrs01_27218/log <span class="token punctuation">\</span> <span class="token operator">&amp;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /mongodb/sharded_cluster/myshardrs01_27218/data/db</pre></td></tr></table></figure><p><mark>第一个服务</mark></p><p>新建或修改配置文件：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">vim</span> /mongodb/sharded_cluster/myshardrs01_27018/mongod.conf</pre></td></tr></table></figure><p>配置文件内容：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>systemLog:</pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token comment">#MongoDB 发送所有日志输出的目标指定为文件</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token comment">#The path of the log file to which mongod or mongos should send all diagnostic logging information</span></pre></td></tr><tr><td data-num="4"></td><td><pre> destination: <span class="token function">file</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token comment">#mongod 或 mongos 应向其发送所有诊断日志记录信息的日志文件的路径</span></pre></td></tr><tr><td data-num="6"></td><td><pre> path: <span class="token string">"/mongodb/sharded_cluster/myshardrs01_27018/log/mongod.log"</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token comment">#当 mongos 或 mongod 实例重新启动时，mongos 或 mongod 会将新条目附加到现有日志文件的末尾。</span></pre></td></tr><tr><td data-num="8"></td><td><pre> logAppend: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="9"></td><td><pre>storage:</pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token comment">#mongod 实例存储其数据的目录。storage.dbPath 设置仅适用于 mongod。</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token comment">#The directory where the mongod instance stores its data.Defaul value is "/data/db"</span></pre></td></tr><tr><td data-num="12"></td><td><pre> dbPath: <span class="token string">"/mongodb/sharded_cluster/myshardrs01_27018/data/db"</span></pre></td></tr><tr><td data-num="13"></td><td><pre> journal:</pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token comment">#启用或禁用持久性日志以确保数据文件保持有效和可恢复</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  enabled: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="16"></td><td><pre>processManagement:</pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token comment">#启用在后台运行 mongos 或 mongod 进程的守护进程模式。</span></pre></td></tr><tr><td data-num="18"></td><td><pre> fork: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="19"></td><td><pre> <span class="token comment">#指定用于保存 mongos 或 mongod 进程的进行 ID 的文件位置，其中 mongos 或 mongod 将写入其 PID</span></pre></td></tr><tr><td data-num="20"></td><td><pre> pidFilePath: <span class="token string">"/mongodb/sharded_cluster/myshardrs01_27018/log/mongod.pid"</span></pre></td></tr><tr><td data-num="21"></td><td><pre>net:</pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token comment">#服务实例绑定 IP，默认是 localhost</span></pre></td></tr><tr><td data-num="23"></td><td><pre> bindIp: localhost,192.168.244.142</pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token comment">#bindIp</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token comment">#绑定的端口，默认是 27017</span></pre></td></tr><tr><td data-num="26"></td><td><pre> port: <span class="token number">27017</span></pre></td></tr><tr><td data-num="27"></td><td><pre>replication:</pre></td></tr><tr><td data-num="28"></td><td><pre> <span class="token comment">#副本集的名称</span></pre></td></tr><tr><td data-num="29"></td><td><pre> replSetName: myshardrs01</pre></td></tr><tr><td data-num="30"></td><td><pre>sharding:</pre></td></tr><tr><td data-num="31"></td><td><pre> <span class="token comment">#分片角色</span></pre></td></tr><tr><td data-num="32"></td><td><pre> clusterRole: shardsvr</pre></td></tr></table></figure><p>sharding.clusterRole：</p><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td>configsvr</td><td>Start this instance as a config server. The instance starts on port 27019 by default</td></tr><tr><td>shardsvr</td><td>Start this instance as a shard. The instance starts on port 27018 by default</td></tr></tbody></table><p>注意：</p><p>设置 sharding.clusterRole 需要 mongod 实例运行复制，要将实例部署为副本即成员，请使用 replSetName 设置并制定副本集的名称。</p><p><mark>第二个服务</mark></p><p>新建或修改配置文件：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">vim</span> /mongodb/sharded_cluster/myshardrs01_27118/mongod.conf</pre></td></tr></table></figure><p>配置文件内容：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>systemLog:</pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token comment">#MongoDB 发送所有日志输出的目标指定为文件</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token comment">#The path of the log file to which mongod or mongos should send all diagnostic logging information</span></pre></td></tr><tr><td data-num="4"></td><td><pre> destination: <span class="token function">file</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token comment">#mongod 或 mongos 应向其发送所有诊断日志记录信息的日志文件的路径</span></pre></td></tr><tr><td data-num="6"></td><td><pre> path: <span class="token string">"/mongodb/sharded_cluster/myshardrs01_27118/log/mongod.log"</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token comment">#当 mongos 或 mongod 实例重新启动时，mongos 或 mongod 会将新条目附加到现有日志文件的末尾。</span></pre></td></tr><tr><td data-num="8"></td><td><pre> logAppend: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="9"></td><td><pre>storage:</pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token comment">#mongod 实例存储其数据的目录。storage.dbPath 设置仅适用于 mongod。</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token comment">#The directory where the mongod instance stores its data.Defaul value is "/data/db"</span></pre></td></tr><tr><td data-num="12"></td><td><pre> dbPath: <span class="token string">"/mongodb/sharded_cluster/myshardrs01_27118/data/db"</span></pre></td></tr><tr><td data-num="13"></td><td><pre> journal:</pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token comment">#启用或禁用持久性日志以确保数据文件保持有效和可恢复</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  enabled: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="16"></td><td><pre>processManagement:</pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token comment">#启用在后台运行 mongos 或 mongod 进程的守护进程模式。</span></pre></td></tr><tr><td data-num="18"></td><td><pre> fork: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="19"></td><td><pre> <span class="token comment">#指定用于保存 mongos 或 mongod 进程的进行 ID 的文件位置，其中 mongos 或 mongod 将写入其 PID</span></pre></td></tr><tr><td data-num="20"></td><td><pre> pidFilePath: <span class="token string">"/mongodb/sharded_cluster/myshardrs01_27118/log/mongod.pid"</span></pre></td></tr><tr><td data-num="21"></td><td><pre>net:</pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token comment">#服务实例绑定 IP，默认是 localhost</span></pre></td></tr><tr><td data-num="23"></td><td><pre> bindIp: localhost,192.168.244.142</pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token comment">#bindIp</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token comment">#绑定的端口，默认是 27017</span></pre></td></tr><tr><td data-num="26"></td><td><pre> port: <span class="token number">27118</span></pre></td></tr><tr><td data-num="27"></td><td><pre>replication:</pre></td></tr><tr><td data-num="28"></td><td><pre> <span class="token comment">#副本集的名称</span></pre></td></tr><tr><td data-num="29"></td><td><pre> replSetName: myshardrs01</pre></td></tr><tr><td data-num="30"></td><td><pre>sharding:</pre></td></tr><tr><td data-num="31"></td><td><pre> <span class="token comment">#分片角色</span></pre></td></tr><tr><td data-num="32"></td><td><pre> clusterRole: shardsvr</pre></td></tr></table></figure><p><mark>第三个服务</mark></p><p>新建或修改配置文件：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">vim</span> /mongodb/sharded_cluster/myshardrs01_27218/mongod.conf</pre></td></tr></table></figure><p>配置文件内容：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>systemLog:</pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token comment">#MongoDB 发送所有日志输出的目标指定为文件</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token comment">#The path of the log file to which mongod or mongos should send all diagnostic logging information</span></pre></td></tr><tr><td data-num="4"></td><td><pre> destination: <span class="token function">file</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token comment">#mongod 或 mongos 应向其发送所有诊断日志记录信息的日志文件的路径</span></pre></td></tr><tr><td data-num="6"></td><td><pre> path: <span class="token string">"/mongodb/sharded_cluster/myshardrs01_27218/log/mongod.log"</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token comment">#当 mongos 或 mongod 实例重新启动时，mongos 或 mongod 会将新条目附加到现有日志文件的末尾。</span></pre></td></tr><tr><td data-num="8"></td><td><pre> logAppend: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="9"></td><td><pre>storage:</pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token comment">#mongod 实例存储其数据的目录。storage.dbPath 设置仅适用于 mongod。</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token comment">#The directory where the mongod instance stores its data.Defaul value is "/data/db"</span></pre></td></tr><tr><td data-num="12"></td><td><pre> dbPath: <span class="token string">"/mongodb/sharded_cluster/myshardrs01_27218/data/db"</span></pre></td></tr><tr><td data-num="13"></td><td><pre> journal:</pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token comment">#启用或禁用持久性日志以确保数据文件保持有效和可恢复</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  enabled: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="16"></td><td><pre>processManagement:</pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token comment">#启用在后台运行 mongos 或 mongod 进程的守护进程模式。</span></pre></td></tr><tr><td data-num="18"></td><td><pre> fork: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="19"></td><td><pre> <span class="token comment">#指定用于保存 mongos 或 mongod 进程的进行 ID 的文件位置，其中 mongos 或 mongod 将写入其 PID</span></pre></td></tr><tr><td data-num="20"></td><td><pre> pidFilePath: <span class="token string">"/mongodb/sharded_cluster/myshardrs01_27218/log/mongod.pid"</span></pre></td></tr><tr><td data-num="21"></td><td><pre>net:</pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token comment">#服务实例绑定 IP，默认是 localhost</span></pre></td></tr><tr><td data-num="23"></td><td><pre> bindIp: localhost,192.168.244.142</pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token comment">#bindIp</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token comment">#绑定的端口，默认是 27017</span></pre></td></tr><tr><td data-num="26"></td><td><pre> port: <span class="token number">27218</span></pre></td></tr><tr><td data-num="27"></td><td><pre>replication:</pre></td></tr><tr><td data-num="28"></td><td><pre> <span class="token comment">#副本集的名称</span></pre></td></tr><tr><td data-num="29"></td><td><pre> replSetName: myshardrs01</pre></td></tr><tr><td data-num="30"></td><td><pre>sharding:</pre></td></tr><tr><td data-num="31"></td><td><pre> <span class="token comment">#分片角色</span></pre></td></tr><tr><td data-num="32"></td><td><pre> clusterRole: shardsvr</pre></td></tr></table></figure><p>启动第一套副本集：一主一副一仲载</p><p>依次启动三个 mongod 服务：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>➜  / /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/sharded_cluster/myshardrs01_27018/mongod.conf </pre></td></tr><tr><td data-num="2"></td><td><pre>about to fork child process, waiting <span class="token keyword">until</span> server is ready <span class="token keyword">for</span> connections.</pre></td></tr><tr><td data-num="3"></td><td><pre>forked process: <span class="token number">2821</span></pre></td></tr><tr><td data-num="4"></td><td><pre>child process started successfully, parent exiting</pre></td></tr><tr><td data-num="5"></td><td><pre>➜  / /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/sharded_cluster/myshardrs01_27118/mongod.conf </pre></td></tr><tr><td data-num="6"></td><td><pre>about to fork child process, waiting <span class="token keyword">until</span> server is ready <span class="token keyword">for</span> connections.</pre></td></tr><tr><td data-num="7"></td><td><pre>forked process: <span class="token number">2894</span></pre></td></tr><tr><td data-num="8"></td><td><pre>child process started successfully, parent exiting</pre></td></tr><tr><td data-num="9"></td><td><pre>➜  / /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/sharded_cluster/myshardrs01_27218/mongod.conf </pre></td></tr><tr><td data-num="10"></td><td><pre>about to fork child process, waiting <span class="token keyword">until</span> server is ready <span class="token keyword">for</span> connections.</pre></td></tr><tr><td data-num="11"></td><td><pre>forked process: <span class="token number">2963</span></pre></td></tr><tr><td data-num="12"></td><td><pre>child process started successfully, parent exiting</pre></td></tr><tr><td data-num="13"></td><td><pre>➜  /</pre></td></tr></table></figure><p>查看启动进程情况：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>➜  / <span class="token function">ps</span> -ef<span class="token operator">|</span><span class="token function">grep</span> mongod<span class="token operator">|</span><span class="token function">grep</span> <span class="token parameter variable">-v</span> <span class="token function">grep</span></pre></td></tr><tr><td data-num="2"></td><td><pre>dkx0       <span class="token number">2821</span>      <span class="token number">1</span>  <span class="token number">7</span> 06:55 ?        00:00:03 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/sharded_cluster/myshardrs01_27018/mongod.conf</pre></td></tr><tr><td data-num="3"></td><td><pre>dkx0       <span class="token number">2894</span>      <span class="token number">1</span> <span class="token number">10</span> 06:55 ?        00:00:02 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/sharded_cluster/myshardrs01_27118/mongod.conf</pre></td></tr><tr><td data-num="4"></td><td><pre>dkx0       <span class="token number">2963</span>      <span class="token number">1</span> <span class="token number">16</span> 06:56 ?        00:00:02 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/sharded_cluster/myshardrs01_27218/mongod.conf</pre></td></tr><tr><td data-num="5"></td><td><pre>➜  /</pre></td></tr></table></figure><p>1. 初始化副本集和创建主节点：</p><p>使用客户端命令连接任意一个节点，但这里尽量要连接主节点：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>➜  ~ /usr/local/mongodb/bin/mongo  <span class="token parameter variable">--host</span><span class="token operator">=</span><span class="token number">192.168</span>.244.142 <span class="token parameter variable">--port</span><span class="token operator">=</span><span class="token number">27018</span></pre></td></tr></table></figure><p>执行初始化副本集命令：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">></span> rs.<span class="token function-name function">initiate</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token string">"info2"</span> <span class="token builtin class-name">:</span> <span class="token string">"no configuration specified. Using a default configuration for the set"</span>,</pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token string">"me"</span> <span class="token builtin class-name">:</span> <span class="token string">"192.168.244.142:27018"</span>,</pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token string">"ok"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>myshardrs01:SECONDARY<span class="token operator">></span> </pre></td></tr><tr><td data-num="8"></td><td><pre>myshardrs01:PRIMARY<span class="token operator">></span></pre></td></tr></table></figure><p>添加从节点和仲载节点：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>myshardrs01:PRIMARY<span class="token operator">></span> rs.add<span class="token punctuation">(</span><span class="token string">"192.168.244.142:27118"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>myshardrs01:PRIMARY<span class="token operator">></span> rs.add<span class="token punctuation">(</span><span class="token string">"192.168.244.142:27218"</span>,true<span class="token punctuation">)</span></pre></td></tr></table></figure><p>查看副本集的配置情况：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>myshardrs01:PRIMARY<span class="token operator">></span> rs.<span class="token function-name function">conf</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"myshardrs01"</span>,</pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token string">"version"</span> <span class="token builtin class-name">:</span> <span class="token number">3</span>,</pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token string">"term"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token string">"members"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="7"></td><td><pre>		<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>			<span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>,</pre></td></tr><tr><td data-num="9"></td><td><pre>			<span class="token string">"host"</span> <span class="token builtin class-name">:</span> <span class="token string">"192.168.244.142:27018"</span>,</pre></td></tr><tr><td data-num="10"></td><td><pre>			<span class="token string">"arbiterOnly"</span> <span class="token builtin class-name">:</span> false,</pre></td></tr><tr><td data-num="11"></td><td><pre>			<span class="token string">"buildIndexes"</span> <span class="token builtin class-name">:</span> true,</pre></td></tr><tr><td data-num="12"></td><td><pre>			<span class="token string">"hidden"</span> <span class="token builtin class-name">:</span> false,</pre></td></tr><tr><td data-num="13"></td><td><pre>			<span class="token string">"priority"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="14"></td><td><pre>			<span class="token string">"tags"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>				</pre></td></tr><tr><td data-num="16"></td><td><pre>			<span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="17"></td><td><pre>			<span class="token string">"slaveDelay"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="18"></td><td><pre>			<span class="token string">"votes"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="19"></td><td><pre>		<span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="20"></td><td><pre>		<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>			<span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="22"></td><td><pre>			<span class="token string">"host"</span> <span class="token builtin class-name">:</span> <span class="token string">"192.168.244.142:27118"</span>,</pre></td></tr><tr><td data-num="23"></td><td><pre>			<span class="token string">"arbiterOnly"</span> <span class="token builtin class-name">:</span> false,</pre></td></tr><tr><td data-num="24"></td><td><pre>			<span class="token string">"buildIndexes"</span> <span class="token builtin class-name">:</span> true,</pre></td></tr><tr><td data-num="25"></td><td><pre>			<span class="token string">"hidden"</span> <span class="token builtin class-name">:</span> false,</pre></td></tr><tr><td data-num="26"></td><td><pre>			<span class="token string">"priority"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="27"></td><td><pre>			<span class="token string">"tags"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>				</pre></td></tr><tr><td data-num="29"></td><td><pre>			<span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="30"></td><td><pre>			<span class="token string">"slaveDelay"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="31"></td><td><pre>			<span class="token string">"votes"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="32"></td><td><pre>		<span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="33"></td><td><pre>		<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>			<span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>,</pre></td></tr><tr><td data-num="35"></td><td><pre>			<span class="token string">"host"</span> <span class="token builtin class-name">:</span> <span class="token string">"192.168.244.142:27218"</span>,</pre></td></tr><tr><td data-num="36"></td><td><pre>			<span class="token string">"arbiterOnly"</span> <span class="token builtin class-name">:</span> true,</pre></td></tr><tr><td data-num="37"></td><td><pre>			<span class="token string">"buildIndexes"</span> <span class="token builtin class-name">:</span> true,</pre></td></tr><tr><td data-num="38"></td><td><pre>			<span class="token string">"hidden"</span> <span class="token builtin class-name">:</span> false,</pre></td></tr><tr><td data-num="39"></td><td><pre>			<span class="token string">"priority"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>,</pre></td></tr><tr><td data-num="40"></td><td><pre>			<span class="token string">"tags"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>				</pre></td></tr><tr><td data-num="42"></td><td><pre>			<span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="43"></td><td><pre>			<span class="token string">"slaveDelay"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="44"></td><td><pre>			<span class="token string">"votes"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="45"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>	<span class="token punctuation">]</span>,</pre></td></tr><tr><td data-num="47"></td><td><pre>	<span class="token string">"protocolVersion"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="48"></td><td><pre>	<span class="token string">"writeConcernMajorityJournalDefault"</span> <span class="token builtin class-name">:</span> true,</pre></td></tr><tr><td data-num="49"></td><td><pre>	<span class="token string">"settings"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>		<span class="token string">"chainingAllowed"</span> <span class="token builtin class-name">:</span> true,</pre></td></tr><tr><td data-num="51"></td><td><pre>		<span class="token string">"heartbeatIntervalMillis"</span> <span class="token builtin class-name">:</span> <span class="token number">2000</span>,</pre></td></tr><tr><td data-num="52"></td><td><pre>		<span class="token string">"heartbeatTimeoutSecs"</span> <span class="token builtin class-name">:</span> <span class="token number">10</span>,</pre></td></tr><tr><td data-num="53"></td><td><pre>		<span class="token string">"electionTimeoutMillis"</span> <span class="token builtin class-name">:</span> <span class="token number">10000</span>,</pre></td></tr><tr><td data-num="54"></td><td><pre>		<span class="token string">"catchUpTimeoutMillis"</span> <span class="token builtin class-name">:</span> -1,</pre></td></tr><tr><td data-num="55"></td><td><pre>		<span class="token string">"catchUpTakeoverDelayMillis"</span> <span class="token builtin class-name">:</span> <span class="token number">30000</span>,</pre></td></tr><tr><td data-num="56"></td><td><pre>		<span class="token string">"getLastErrorModes"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>			</pre></td></tr><tr><td data-num="58"></td><td><pre>		<span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="59"></td><td><pre>		<span class="token string">"getLastErrorDefaults"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>			<span class="token string">"w"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="61"></td><td><pre>			<span class="token string">"wtimeout"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="62"></td><td><pre>		<span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="63"></td><td><pre>		<span class="token string">"replicaSetId"</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">"648128e18751ababd297a5f4"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="64"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="65"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>myshardrs01:PRIMARY<span class="token operator">></span></pre></td></tr></table></figure><h3 id="第二套副本集"><a class="anchor" href="#第二套副本集">#</a> 第二套副本集</h3><p>创建存放数据和日志的目录：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /mongodb/sharded_cluster/myshardrs01_27318/log <span class="token punctuation">\</span> <span class="token operator">&amp;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /mongodb/sharded_cluster/myshardrs01_27318/data/db <span class="token punctuation">\</span> <span class="token operator">&amp;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /mongodb/sharded_cluster/myshardrs01_27418/log <span class="token punctuation">\</span> <span class="token operator">&amp;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /mongodb/sharded_cluster/myshardrs01_27418/data/db <span class="token punctuation">\</span> <span class="token operator">&amp;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /mongodb/sharded_cluster/myshardrs01_27518/log <span class="token punctuation">\</span> <span class="token operator">&amp;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /mongodb/sharded_cluster/myshardrs01_27518/data/db</pre></td></tr></table></figure><p><mark>第一个服务</mark></p><p>新建或修改配置文件：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>➜  ~ <span class="token function">vim</span> /mongodb/sharded_cluster/myshardrs01_27318/mongod.conf</pre></td></tr></table></figure><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>systemLog:</pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token comment">#MongoDB 发送所有日志输出的目标指定为文件</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token comment">#The path of the log file to which mongod or mongos should send all diagnostic logging information</span></pre></td></tr><tr><td data-num="4"></td><td><pre> destination: <span class="token function">file</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token comment">#mongod 或 mongos 应向其发送所有诊断日志记录信息的日志文件的路径</span></pre></td></tr><tr><td data-num="6"></td><td><pre> path: <span class="token string">"/mongodb/sharded_cluster/myshardrs01_27318/log/mongod.log"</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token comment">#当 mongos 或 mongod 实例重新启动时，mongos 或 mongod 会将新条目附加到现有日志文件的末尾。</span></pre></td></tr><tr><td data-num="8"></td><td><pre> logAppend: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="9"></td><td><pre>storage:</pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token comment">#mongod 实例存储其数据的目录。storage.dbPath 设置仅适用于 mongod。</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token comment">#The directory where the mongod instance stores its data.Defaul value is "/data/db"</span></pre></td></tr><tr><td data-num="12"></td><td><pre> dbPath: <span class="token string">"/mongodb/sharded_cluster/myshardrs01_27318/data/db"</span></pre></td></tr><tr><td data-num="13"></td><td><pre> journal:</pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token comment">#启用或禁用持久性日志以确保数据文件保持有效和可恢复</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  enabled: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="16"></td><td><pre>processManagement:</pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token comment">#启用在后台运行 mongos 或 mongod 进程的守护进程模式。</span></pre></td></tr><tr><td data-num="18"></td><td><pre> fork: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="19"></td><td><pre> <span class="token comment">#指定用于保存 mongos 或 mongod 进程的进行 ID 的文件位置，其中 mongos 或 mongod 将写入其 PID</span></pre></td></tr><tr><td data-num="20"></td><td><pre> pidFilePath: <span class="token string">"/mongodb/sharded_cluster/myshardrs01_27318/log/mongod.pid"</span></pre></td></tr><tr><td data-num="21"></td><td><pre>net:</pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token comment">#服务实例绑定 IP，默认是 localhost</span></pre></td></tr><tr><td data-num="23"></td><td><pre> bindIp: localhost,192.168.244.142</pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token comment">#bindIp</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token comment">#绑定的端口，默认是 27017</span></pre></td></tr><tr><td data-num="26"></td><td><pre> port: <span class="token number">27318</span></pre></td></tr><tr><td data-num="27"></td><td><pre>replication:</pre></td></tr><tr><td data-num="28"></td><td><pre> <span class="token comment">#副本集的名称</span></pre></td></tr><tr><td data-num="29"></td><td><pre> replSetName: myshardrs02</pre></td></tr><tr><td data-num="30"></td><td><pre>sharding:</pre></td></tr><tr><td data-num="31"></td><td><pre> <span class="token comment">#分片角色</span></pre></td></tr><tr><td data-num="32"></td><td><pre> clusterRole: shardsvr</pre></td></tr></table></figure><p><mark>第二个服务</mark></p><p>新建或修改配置文件：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>➜  ~ <span class="token function">vim</span> /mongodb/sharded_cluster/myshardrs01_27418/mongod.conf</pre></td></tr></table></figure><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>systemLog:</pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token comment">#MongoDB 发送所有日志输出的目标指定为文件</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token comment">#The path of the log file to which mongod or mongos should send all diagnostic logging information</span></pre></td></tr><tr><td data-num="4"></td><td><pre> destination: <span class="token function">file</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token comment">#mongod 或 mongos 应向其发送所有诊断日志记录信息的日志文件的路径</span></pre></td></tr><tr><td data-num="6"></td><td><pre> path: <span class="token string">"/mongodb/sharded_cluster/myshardrs01_27418/log/mongod.log"</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token comment">#当 mongos 或 mongod 实例重新启动时，mongos 或 mongod 会将新条目附加到现有日志文件的末尾。</span></pre></td></tr><tr><td data-num="8"></td><td><pre> logAppend: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="9"></td><td><pre>storage:</pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token comment">#mongod 实例存储其数据的目录。storage.dbPath 设置仅适用于 mongod。</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token comment">#The directory where the mongod instance stores its data.Defaul value is "/data/db"</span></pre></td></tr><tr><td data-num="12"></td><td><pre> dbPath: <span class="token string">"/mongodb/sharded_cluster/myshardrs01_27418/data/db"</span></pre></td></tr><tr><td data-num="13"></td><td><pre> journal:</pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token comment">#启用或禁用持久性日志以确保数据文件保持有效和可恢复</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  enabled: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="16"></td><td><pre>processManagement:</pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token comment">#启用在后台运行 mongos 或 mongod 进程的守护进程模式。</span></pre></td></tr><tr><td data-num="18"></td><td><pre> fork: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="19"></td><td><pre> <span class="token comment">#指定用于保存 mongos 或 mongod 进程的进行 ID 的文件位置，其中 mongos 或 mongod 将写入其 PID</span></pre></td></tr><tr><td data-num="20"></td><td><pre> pidFilePath: <span class="token string">"/mongodb/sharded_cluster/myshardrs01_27418/log/mongod.pid"</span></pre></td></tr><tr><td data-num="21"></td><td><pre>net:</pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token comment">#服务实例绑定 IP，默认是 localhost</span></pre></td></tr><tr><td data-num="23"></td><td><pre> bindIp: localhost,192.168.244.142</pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token comment">#bindIp</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token comment">#绑定的端口，默认是 27017</span></pre></td></tr><tr><td data-num="26"></td><td><pre> port: <span class="token number">27418</span></pre></td></tr><tr><td data-num="27"></td><td><pre>replication:</pre></td></tr><tr><td data-num="28"></td><td><pre> <span class="token comment">#副本集的名称</span></pre></td></tr><tr><td data-num="29"></td><td><pre> replSetName: myshardrs02</pre></td></tr><tr><td data-num="30"></td><td><pre>sharding:</pre></td></tr><tr><td data-num="31"></td><td><pre> <span class="token comment">#分片角色</span></pre></td></tr><tr><td data-num="32"></td><td><pre> clusterRole: shardsvr</pre></td></tr></table></figure><p><mark>第三个服务</mark></p><p>新建或修改配置文件：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>➜  ~ <span class="token function">vim</span> /mongodb/sharded_cluster/myshardrs01_27518/mongod.conf</pre></td></tr></table></figure><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>systemLog:</pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token comment">#MongoDB 发送所有日志输出的目标指定为文件</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token comment">#The path of the log file to which mongod or mongos should send all diagnostic logging information</span></pre></td></tr><tr><td data-num="4"></td><td><pre> destination: <span class="token function">file</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token comment">#mongod 或 mongos 应向其发送所有诊断日志记录信息的日志文件的路径</span></pre></td></tr><tr><td data-num="6"></td><td><pre> path: <span class="token string">"/mongodb/sharded_cluster/myshardrs01_27518/log/mongod.log"</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token comment">#当 mongos 或 mongod 实例重新启动时，mongos 或 mongod 会将新条目附加到现有日志文件的末尾。</span></pre></td></tr><tr><td data-num="8"></td><td><pre> logAppend: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="9"></td><td><pre>storage:</pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token comment">#mongod 实例存储其数据的目录。storage.dbPath 设置仅适用于 mongod。</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token comment">#The directory where the mongod instance stores its data.Defaul value is "/data/db"</span></pre></td></tr><tr><td data-num="12"></td><td><pre> dbPath: <span class="token string">"/mongodb/sharded_cluster/myshardrs01_27518/data/db"</span></pre></td></tr><tr><td data-num="13"></td><td><pre> journal:</pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token comment">#启用或禁用持久性日志以确保数据文件保持有效和可恢复</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  enabled: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="16"></td><td><pre>processManagement:</pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token comment">#启用在后台运行 mongos 或 mongod 进程的守护进程模式。</span></pre></td></tr><tr><td data-num="18"></td><td><pre> fork: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="19"></td><td><pre> <span class="token comment">#指定用于保存 mongos 或 mongod 进程的进行 ID 的文件位置，其中 mongos 或 mongod 将写入其 PID</span></pre></td></tr><tr><td data-num="20"></td><td><pre> pidFilePath: <span class="token string">"/mongodb/sharded_cluster/myshardrs01_27518/log/mongod.pid"</span></pre></td></tr><tr><td data-num="21"></td><td><pre>net:</pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token comment">#服务实例绑定 IP，默认是 localhost</span></pre></td></tr><tr><td data-num="23"></td><td><pre> bindIp: localhost,192.168.244.142</pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token comment">#bindIp</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token comment">#绑定的端口，默认是 27017</span></pre></td></tr><tr><td data-num="26"></td><td><pre> port: <span class="token number">27518</span></pre></td></tr><tr><td data-num="27"></td><td><pre>replication:</pre></td></tr><tr><td data-num="28"></td><td><pre> <span class="token comment">#副本集的名称</span></pre></td></tr><tr><td data-num="29"></td><td><pre> replSetName: myshardrs02</pre></td></tr><tr><td data-num="30"></td><td><pre>sharding:</pre></td></tr><tr><td data-num="31"></td><td><pre> <span class="token comment">#分片角色</span></pre></td></tr><tr><td data-num="32"></td><td><pre> clusterRole: shardsvr</pre></td></tr></table></figure><p>启动服务：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>➜  ~ /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/sharded_cluster/myshardrs01_27318/mongod.conf </pre></td></tr><tr><td data-num="2"></td><td><pre>about to fork child process, waiting <span class="token keyword">until</span> server is ready <span class="token keyword">for</span> connections.</pre></td></tr><tr><td data-num="3"></td><td><pre>forked process: <span class="token number">5200</span></pre></td></tr><tr><td data-num="4"></td><td><pre>child process started successfully, parent exiting</pre></td></tr><tr><td data-num="5"></td><td><pre>➜  ~ /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/sharded_cluster/myshardrs01_27418/mongod.conf </pre></td></tr><tr><td data-num="6"></td><td><pre>about to fork child process, waiting <span class="token keyword">until</span> server is ready <span class="token keyword">for</span> connections.</pre></td></tr><tr><td data-num="7"></td><td><pre>forked process: <span class="token number">5268</span></pre></td></tr><tr><td data-num="8"></td><td><pre>child process started successfully, parent exiting</pre></td></tr><tr><td data-num="9"></td><td><pre>➜  ~ /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/sharded_cluster/myshardrs01_27518/mongod.conf </pre></td></tr><tr><td data-num="10"></td><td><pre>about to fork child process, waiting <span class="token keyword">until</span> server is ready <span class="token keyword">for</span> connections.</pre></td></tr><tr><td data-num="11"></td><td><pre>forked process: <span class="token number">5337</span></pre></td></tr><tr><td data-num="12"></td><td><pre>child process started successfully, parent exiting</pre></td></tr><tr><td data-num="13"></td><td><pre>➜  ~</pre></td></tr></table></figure><p>查看进程：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>➜  ~ <span class="token function">ps</span> -ef<span class="token operator">|</span><span class="token function">grep</span> mongod<span class="token operator">|</span><span class="token function">grep</span> <span class="token parameter variable">-v</span> <span class="token function">grep</span></pre></td></tr><tr><td data-num="2"></td><td><pre>dkx0       <span class="token number">2291</span>      <span class="token number">1</span>  <span class="token number">1</span> <span class="token number">20</span>:57 ?        00:00:52 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/sharded_cluster/myshardrs01_27018/mongod.conf</pre></td></tr><tr><td data-num="3"></td><td><pre>dkx0       <span class="token number">2368</span>      <span class="token number">1</span>  <span class="token number">2</span> <span class="token number">20</span>:57 ?        00:01:11 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/sharded_cluster/myshardrs01_27118/mongod.conf</pre></td></tr><tr><td data-num="4"></td><td><pre>dkx0       <span class="token number">2443</span>      <span class="token number">1</span>  <span class="token number">2</span> <span class="token number">20</span>:57 ?        00:01:08 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/sharded_cluster/myshardrs01_27218/mongod.conf</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>dkx0       <span class="token number">5200</span>      <span class="token number">1</span>  <span class="token number">4</span> <span class="token number">21</span>:42 ?        00:00:03 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/sharded_cluster/myshardrs01_27318/mongod.conf</pre></td></tr><tr><td data-num="7"></td><td><pre>dkx0       <span class="token number">5268</span>      <span class="token number">1</span>  <span class="token number">5</span> <span class="token number">21</span>:42 ?        00:00:03 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/sharded_cluster/myshardrs01_27418/mongod.conf</pre></td></tr><tr><td data-num="8"></td><td><pre>dkx0       <span class="token number">5337</span>      <span class="token number">1</span>  <span class="token number">5</span> <span class="token number">21</span>:43 ?        00:00:02 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/sharded_cluster/myshardrs01_27518/mongod.conf</pre></td></tr><tr><td data-num="9"></td><td><pre>➜  ~</pre></td></tr></table></figure><p>初始化副本集和创建主节点：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>➜  ~ /usr/local/mongodb/bin/mongo <span class="token parameter variable">--host</span><span class="token operator">=</span><span class="token number">192.168</span>.244.142 <span class="token parameter variable">--port</span><span class="token operator">=</span><span class="token number">27318</span></pre></td></tr></table></figure><p>初始化副本集：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">></span> rs.<span class="token function-name function">initiate</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token string">"info2"</span> <span class="token builtin class-name">:</span> <span class="token string">"no configuration specified. Using a default configuration for the set"</span>,</pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token string">"me"</span> <span class="token builtin class-name">:</span> <span class="token string">"192.168.244.142:27318"</span>,</pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token string">"ok"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>myshardrs02:SECONDARY<span class="token operator">></span> </pre></td></tr><tr><td data-num="8"></td><td><pre>myshardrs02:PRIMARY<span class="token operator">></span></pre></td></tr></table></figure><p>添加从节点和仲载节点：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>myshardrs02:PRIMARY<span class="token operator">></span> rs.add<span class="token punctuation">(</span><span class="token string">"192.168.244.142:27418"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>myshardrs02:PRIMARY<span class="token operator">></span> rs.add<span class="token punctuation">(</span><span class="token string">"192.168.244.142:27518"</span>,true<span class="token punctuation">)</span></pre></td></tr></table></figure><p>查看状态：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>myshardrs02:PRIMARY<span class="token operator">></span> rs.<span class="token function-name function">conf</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"myshardrs02"</span>,</pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token string">"version"</span> <span class="token builtin class-name">:</span> <span class="token number">3</span>,</pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token string">"term"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token string">"members"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="7"></td><td><pre>		<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>			<span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>,</pre></td></tr><tr><td data-num="9"></td><td><pre>			<span class="token string">"host"</span> <span class="token builtin class-name">:</span> <span class="token string">"192.168.244.142:27318"</span>,</pre></td></tr><tr><td data-num="10"></td><td><pre>			<span class="token string">"arbiterOnly"</span> <span class="token builtin class-name">:</span> false,</pre></td></tr><tr><td data-num="11"></td><td><pre>			<span class="token string">"buildIndexes"</span> <span class="token builtin class-name">:</span> true,</pre></td></tr><tr><td data-num="12"></td><td><pre>			<span class="token string">"hidden"</span> <span class="token builtin class-name">:</span> false,</pre></td></tr><tr><td data-num="13"></td><td><pre>			<span class="token string">"priority"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="14"></td><td><pre>			<span class="token string">"tags"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>				</pre></td></tr><tr><td data-num="16"></td><td><pre>			<span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="17"></td><td><pre>			<span class="token string">"slaveDelay"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="18"></td><td><pre>			<span class="token string">"votes"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="19"></td><td><pre>		<span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="20"></td><td><pre>		<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>			<span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="22"></td><td><pre>			<span class="token string">"host"</span> <span class="token builtin class-name">:</span> <span class="token string">"192.168.244.142:27418"</span>,</pre></td></tr><tr><td data-num="23"></td><td><pre>			<span class="token string">"arbiterOnly"</span> <span class="token builtin class-name">:</span> false,</pre></td></tr><tr><td data-num="24"></td><td><pre>			<span class="token string">"buildIndexes"</span> <span class="token builtin class-name">:</span> true,</pre></td></tr><tr><td data-num="25"></td><td><pre>			<span class="token string">"hidden"</span> <span class="token builtin class-name">:</span> false,</pre></td></tr><tr><td data-num="26"></td><td><pre>			<span class="token string">"priority"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="27"></td><td><pre>			<span class="token string">"tags"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>				</pre></td></tr><tr><td data-num="29"></td><td><pre>			<span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="30"></td><td><pre>			<span class="token string">"slaveDelay"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="31"></td><td><pre>			<span class="token string">"votes"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="32"></td><td><pre>		<span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="33"></td><td><pre>		<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>			<span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>,</pre></td></tr><tr><td data-num="35"></td><td><pre>			<span class="token string">"host"</span> <span class="token builtin class-name">:</span> <span class="token string">"192.168.244.142:27518"</span>,</pre></td></tr><tr><td data-num="36"></td><td><pre>			<span class="token string">"arbiterOnly"</span> <span class="token builtin class-name">:</span> true,</pre></td></tr><tr><td data-num="37"></td><td><pre>			<span class="token string">"buildIndexes"</span> <span class="token builtin class-name">:</span> true,</pre></td></tr><tr><td data-num="38"></td><td><pre>			<span class="token string">"hidden"</span> <span class="token builtin class-name">:</span> false,</pre></td></tr><tr><td data-num="39"></td><td><pre>			<span class="token string">"priority"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>,</pre></td></tr><tr><td data-num="40"></td><td><pre>			<span class="token string">"tags"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>				</pre></td></tr><tr><td data-num="42"></td><td><pre>			<span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="43"></td><td><pre>			<span class="token string">"slaveDelay"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="44"></td><td><pre>			<span class="token string">"votes"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="45"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>	<span class="token punctuation">]</span>,</pre></td></tr><tr><td data-num="47"></td><td><pre>	<span class="token string">"protocolVersion"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="48"></td><td><pre>	<span class="token string">"writeConcernMajorityJournalDefault"</span> <span class="token builtin class-name">:</span> true,</pre></td></tr><tr><td data-num="49"></td><td><pre>	<span class="token string">"settings"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>		<span class="token string">"chainingAllowed"</span> <span class="token builtin class-name">:</span> true,</pre></td></tr><tr><td data-num="51"></td><td><pre>		<span class="token string">"heartbeatIntervalMillis"</span> <span class="token builtin class-name">:</span> <span class="token number">2000</span>,</pre></td></tr><tr><td data-num="52"></td><td><pre>		<span class="token string">"heartbeatTimeoutSecs"</span> <span class="token builtin class-name">:</span> <span class="token number">10</span>,</pre></td></tr><tr><td data-num="53"></td><td><pre>		<span class="token string">"electionTimeoutMillis"</span> <span class="token builtin class-name">:</span> <span class="token number">10000</span>,</pre></td></tr><tr><td data-num="54"></td><td><pre>		<span class="token string">"catchUpTimeoutMillis"</span> <span class="token builtin class-name">:</span> -1,</pre></td></tr><tr><td data-num="55"></td><td><pre>		<span class="token string">"catchUpTakeoverDelayMillis"</span> <span class="token builtin class-name">:</span> <span class="token number">30000</span>,</pre></td></tr><tr><td data-num="56"></td><td><pre>		<span class="token string">"getLastErrorModes"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>			</pre></td></tr><tr><td data-num="58"></td><td><pre>		<span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="59"></td><td><pre>		<span class="token string">"getLastErrorDefaults"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>			<span class="token string">"w"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="61"></td><td><pre>			<span class="token string">"wtimeout"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="62"></td><td><pre>		<span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="63"></td><td><pre>		<span class="token string">"replicaSetId"</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">"648132fed44efefc463628be"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="64"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="65"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>myshardrs02:PRIMARY<span class="token operator">></span></pre></td></tr></table></figure><p>到此两个分片副本集就搭建完成了</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031659810.png" alt="image-20230608095125494"></p><p>下面搭建配置服务</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031659497.png" alt="image-20230608095211835"></p><h3 id="配置节点副本集的创建"><a class="anchor" href="#配置节点副本集的创建">#</a> 配置节点副本集的创建</h3><p>创建存放数据和日志的目录：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /mongodb/sharded_cluster/myshardrs01_27019/log <span class="token punctuation">\</span> <span class="token operator">&amp;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /mongodb/sharded_cluster/myshardrs01_27019/data/db <span class="token punctuation">\</span> <span class="token operator">&amp;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /mongodb/sharded_cluster/myshardrs01_27119/log <span class="token punctuation">\</span> <span class="token operator">&amp;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /mongodb/sharded_cluster/myshardrs01_27119/data/db <span class="token punctuation">\</span> <span class="token operator">&amp;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /mongodb/sharded_cluster/myshardrs01_27219/log <span class="token punctuation">\</span> <span class="token operator">&amp;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /mongodb/sharded_cluster/myshardrs01_27219/data/db</pre></td></tr></table></figure><p><mark>第一个服务</mark></p><p>新建或修改配置文件：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>➜  ~ <span class="token function">vim</span> /mongodb/sharded_cluster/myshardrs01_27019/mongod.conf</pre></td></tr></table></figure><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>systemLog:</pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token comment">#MongoDB 发送所有日志输出的目标指定为文件</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token comment">#The path of the log file to which mongod or mongos should send all diagnostic logging information</span></pre></td></tr><tr><td data-num="4"></td><td><pre> destination: <span class="token function">file</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token comment">#mongod 或 mongos 应向其发送所有诊断日志记录信息的日志文件的路径</span></pre></td></tr><tr><td data-num="6"></td><td><pre> path: <span class="token string">"/mongodb/sharded_cluster/myshardrs01_27019/log/mongod.log"</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token comment">#当 mongos 或 mongod 实例重新启动时，mongos 或 mongod 会将新条目附加到现有日志文件的末尾。</span></pre></td></tr><tr><td data-num="8"></td><td><pre> logAppend: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="9"></td><td><pre>storage:</pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token comment">#mongod 实例存储其数据的目录。storage.dbPath 设置仅适用于 mongod。</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token comment">#The directory where the mongod instance stores its data.Defaul value is "/data/db"</span></pre></td></tr><tr><td data-num="12"></td><td><pre> dbPath: <span class="token string">"/mongodb/sharded_cluster/myshardrs01_27019/data/db"</span></pre></td></tr><tr><td data-num="13"></td><td><pre> journal:</pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token comment">#启用或禁用持久性日志以确保数据文件保持有效和可恢复</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  enabled: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="16"></td><td><pre>processManagement:</pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token comment">#启用在后台运行 mongos 或 mongod 进程的守护进程模式。</span></pre></td></tr><tr><td data-num="18"></td><td><pre> fork: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="19"></td><td><pre> <span class="token comment">#指定用于保存 mongos 或 mongod 进程的进行 ID 的文件位置，其中 mongos 或 mongod 将写入其 PID</span></pre></td></tr><tr><td data-num="20"></td><td><pre> pidFilePath: <span class="token string">"/mongodb/sharded_cluster/myshardrs01_27019/log/mongod.pid"</span></pre></td></tr><tr><td data-num="21"></td><td><pre>net:</pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token comment">#服务实例绑定 IP，默认是 localhost</span></pre></td></tr><tr><td data-num="23"></td><td><pre> bindIp: localhost,192.168.244.142</pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token comment">#bindIp</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token comment">#绑定的端口，默认是 27017</span></pre></td></tr><tr><td data-num="26"></td><td><pre> port: <span class="token number">27019</span></pre></td></tr><tr><td data-num="27"></td><td><pre>replication:</pre></td></tr><tr><td data-num="28"></td><td><pre> <span class="token comment">#副本集的名称</span></pre></td></tr><tr><td data-num="29"></td><td><pre> replSetName: myshardrs</pre></td></tr><tr><td data-num="30"></td><td><pre>sharding:</pre></td></tr><tr><td data-num="31"></td><td><pre> <span class="token comment">#分片角色</span></pre></td></tr><tr><td data-num="32"></td><td><pre> clusterRole: configsvr</pre></td></tr></table></figure><p><mark>第二个服务</mark></p><p>新建或修改配置文件：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>➜  ~ <span class="token function">vim</span> /mongodb/sharded_cluster/myshardrs01_27119/mongod.conf</pre></td></tr></table></figure><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>systemLog:</pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token comment">#MongoDB 发送所有日志输出的目标指定为文件</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token comment">#The path of the log file to which mongod or mongos should send all diagnostic logging information</span></pre></td></tr><tr><td data-num="4"></td><td><pre> destination: <span class="token function">file</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token comment">#mongod 或 mongos 应向其发送所有诊断日志记录信息的日志文件的路径</span></pre></td></tr><tr><td data-num="6"></td><td><pre> path: <span class="token string">"/mongodb/sharded_cluster/myshardrs01_27119/log/mongod.log"</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token comment">#当 mongos 或 mongod 实例重新启动时，mongos 或 mongod 会将新条目附加到现有日志文件的末尾。</span></pre></td></tr><tr><td data-num="8"></td><td><pre> logAppend: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="9"></td><td><pre>storage:</pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token comment">#mongod 实例存储其数据的目录。storage.dbPath 设置仅适用于 mongod。</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token comment">#The directory where the mongod instance stores its data.Defaul value is "/data/db"</span></pre></td></tr><tr><td data-num="12"></td><td><pre> dbPath: <span class="token string">"/mongodb/sharded_cluster/myshardrs01_27119/data/db"</span></pre></td></tr><tr><td data-num="13"></td><td><pre> journal:</pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token comment">#启用或禁用持久性日志以确保数据文件保持有效和可恢复</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  enabled: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="16"></td><td><pre>processManagement:</pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token comment">#启用在后台运行 mongos 或 mongod 进程的守护进程模式。</span></pre></td></tr><tr><td data-num="18"></td><td><pre> fork: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="19"></td><td><pre> <span class="token comment">#指定用于保存 mongos 或 mongod 进程的进行 ID 的文件位置，其中 mongos 或 mongod 将写入其 PID</span></pre></td></tr><tr><td data-num="20"></td><td><pre> pidFilePath: <span class="token string">"/mongodb/sharded_cluster/myshardrs01_27119/log/mongod.pid"</span></pre></td></tr><tr><td data-num="21"></td><td><pre>net:</pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token comment">#服务实例绑定 IP，默认是 localhost</span></pre></td></tr><tr><td data-num="23"></td><td><pre> bindIp: localhost,192.168.244.142</pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token comment">#bindIp</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token comment">#绑定的端口，默认是 27017</span></pre></td></tr><tr><td data-num="26"></td><td><pre> port: <span class="token number">27119</span></pre></td></tr><tr><td data-num="27"></td><td><pre>replication:</pre></td></tr><tr><td data-num="28"></td><td><pre> <span class="token comment">#副本集的名称</span></pre></td></tr><tr><td data-num="29"></td><td><pre> replSetName: myshardrs</pre></td></tr><tr><td data-num="30"></td><td><pre>sharding:</pre></td></tr><tr><td data-num="31"></td><td><pre> <span class="token comment">#分片角色</span></pre></td></tr><tr><td data-num="32"></td><td><pre> clusterRole: configsvr</pre></td></tr></table></figure><p><mark>第三个服务</mark></p><p>新建或修改配置文件：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>➜  ~ <span class="token function">vim</span> /mongodb/sharded_cluster/myshardrs01_27219/mongod.conf</pre></td></tr></table></figure><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>systemLog:</pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token comment">#MongoDB 发送所有日志输出的目标指定为文件</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token comment">#The path of the log file to which mongod or mongos should send all diagnostic logging information</span></pre></td></tr><tr><td data-num="4"></td><td><pre> destination: <span class="token function">file</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token comment">#mongod 或 mongos 应向其发送所有诊断日志记录信息的日志文件的路径</span></pre></td></tr><tr><td data-num="6"></td><td><pre> path: <span class="token string">"/mongodb/sharded_cluster/myshardrs01_27219/log/mongod.log"</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token comment">#当 mongos 或 mongod 实例重新启动时，mongos 或 mongod 会将新条目附加到现有日志文件的末尾。</span></pre></td></tr><tr><td data-num="8"></td><td><pre> logAppend: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="9"></td><td><pre>storage:</pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token comment">#mongod 实例存储其数据的目录。storage.dbPath 设置仅适用于 mongod。</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token comment">#The directory where the mongod instance stores its data.Defaul value is "/data/db"</span></pre></td></tr><tr><td data-num="12"></td><td><pre> dbPath: <span class="token string">"/mongodb/sharded_cluster/myshardrs01_27219/data/db"</span></pre></td></tr><tr><td data-num="13"></td><td><pre> journal:</pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token comment">#启用或禁用持久性日志以确保数据文件保持有效和可恢复</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  enabled: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="16"></td><td><pre>processManagement:</pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token comment">#启用在后台运行 mongos 或 mongod 进程的守护进程模式。</span></pre></td></tr><tr><td data-num="18"></td><td><pre> fork: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="19"></td><td><pre> <span class="token comment">#指定用于保存 mongos 或 mongod 进程的进行 ID 的文件位置，其中 mongos 或 mongod 将写入其 PID</span></pre></td></tr><tr><td data-num="20"></td><td><pre> pidFilePath: <span class="token string">"/mongodb/sharded_cluster/myshardrs01_27219/log/mongod.pid"</span></pre></td></tr><tr><td data-num="21"></td><td><pre>net:</pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token comment">#服务实例绑定 IP，默认是 localhost</span></pre></td></tr><tr><td data-num="23"></td><td><pre> bindIp: localhost,192.168.244.142</pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token comment">#bindIp</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token comment">#绑定的端口，默认是 27017</span></pre></td></tr><tr><td data-num="26"></td><td><pre> port: <span class="token number">27219</span></pre></td></tr><tr><td data-num="27"></td><td><pre>replication:</pre></td></tr><tr><td data-num="28"></td><td><pre> <span class="token comment">#副本集的名称</span></pre></td></tr><tr><td data-num="29"></td><td><pre> replSetName: myshardrs</pre></td></tr><tr><td data-num="30"></td><td><pre>sharding:</pre></td></tr><tr><td data-num="31"></td><td><pre> <span class="token comment">#分片角色</span></pre></td></tr><tr><td data-num="32"></td><td><pre> clusterRole: configsvr</pre></td></tr></table></figure><p>启动服务：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>➜  ~ /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/sharded_cluster/myshardrs01_27019/mongod.conf </pre></td></tr><tr><td data-num="2"></td><td><pre>about to fork child process, waiting <span class="token keyword">until</span> server is ready <span class="token keyword">for</span> connections.</pre></td></tr><tr><td data-num="3"></td><td><pre>forked process: <span class="token number">7659</span></pre></td></tr><tr><td data-num="4"></td><td><pre>child process started successfully, parent exiting</pre></td></tr><tr><td data-num="5"></td><td><pre>➜  ~ /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/sharded_cluster/myshardrs01_27119/mongod.conf </pre></td></tr><tr><td data-num="6"></td><td><pre>about to fork child process, waiting <span class="token keyword">until</span> server is ready <span class="token keyword">for</span> connections.</pre></td></tr><tr><td data-num="7"></td><td><pre>forked process: <span class="token number">7736</span></pre></td></tr><tr><td data-num="8"></td><td><pre>child process started successfully, parent exiting</pre></td></tr><tr><td data-num="9"></td><td><pre>➜  ~ /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/sharded_cluster/myshardrs01_27219/mongod.conf </pre></td></tr><tr><td data-num="10"></td><td><pre>about to fork child process, waiting <span class="token keyword">until</span> server is ready <span class="token keyword">for</span> connections.</pre></td></tr><tr><td data-num="11"></td><td><pre>forked process: <span class="token number">7808</span></pre></td></tr><tr><td data-num="12"></td><td><pre>child process started successfully, parent exiting</pre></td></tr><tr><td data-num="13"></td><td><pre>➜  ~</pre></td></tr></table></figure><p>查看进程：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>➜  ~ <span class="token function">ps</span> -ef<span class="token operator">|</span><span class="token function">grep</span> mongod<span class="token operator">|</span><span class="token function">grep</span> <span class="token parameter variable">-v</span> <span class="token function">grep</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">#分片副本集</span></pre></td></tr><tr><td data-num="3"></td><td><pre>dkx0       <span class="token number">2291</span>      <span class="token number">1</span>  <span class="token number">1</span> <span class="token number">20</span>:57 ?        00:01:36 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/sharded_cluster/myshardrs01_27018/mongod.conf</pre></td></tr><tr><td data-num="4"></td><td><pre>dkx0       <span class="token number">2368</span>      <span class="token number">1</span>  <span class="token number">2</span> <span class="token number">20</span>:57 ?        00:01:55 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/sharded_cluster/myshardrs01_27118/mongod.conf</pre></td></tr><tr><td data-num="5"></td><td><pre>dkx0       <span class="token number">2443</span>      <span class="token number">1</span>  <span class="token number">1</span> <span class="token number">20</span>:57 ?        00:01:40 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/sharded_cluster/myshardrs01_27218/mongod.conf</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>dkx0       <span class="token number">5200</span>      <span class="token number">1</span>  <span class="token number">1</span> <span class="token number">21</span>:42 ?        00:00:48 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/sharded_cluster/myshardrs01_27318/mongod.conf</pre></td></tr><tr><td data-num="8"></td><td><pre>dkx0       <span class="token number">5268</span>      <span class="token number">1</span>  <span class="token number">2</span> <span class="token number">21</span>:42 ?        00:00:49 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/sharded_cluster/myshardrs01_27418/mongod.conf</pre></td></tr><tr><td data-num="9"></td><td><pre>dkx0       <span class="token number">5337</span>      <span class="token number">1</span>  <span class="token number">1</span> <span class="token number">21</span>:43 ?        00:00:38 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/sharded_cluster/myshardrs01_27518/mongod.conf</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">#配置副本集</span></pre></td></tr><tr><td data-num="11"></td><td><pre>dkx0       <span class="token number">7659</span>      <span class="token number">1</span>  <span class="token number">3</span> <span class="token number">22</span>:19 ?        00:00:08 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/sharded_cluster/myshardrs01_27019/mongod.conf</pre></td></tr><tr><td data-num="12"></td><td><pre>dkx0       <span class="token number">7736</span>      <span class="token number">1</span>  <span class="token number">3</span> <span class="token number">22</span>:19 ?        00:00:07 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/sharded_cluster/myshardrs01_27119/mongod.conf</pre></td></tr><tr><td data-num="13"></td><td><pre>dkx0       <span class="token number">7808</span>      <span class="token number">1</span>  <span class="token number">3</span> <span class="token number">22</span>:19 ?        00:00:07 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/sharded_cluster/myshardrs01_27219/mongod.conf</pre></td></tr><tr><td data-num="14"></td><td><pre>➜  ~</pre></td></tr></table></figure><p>初始化配置服务：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">></span> rs.<span class="token function-name function">initiate</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token string">"info2"</span> <span class="token builtin class-name">:</span> <span class="token string">"no configuration specified. Using a default configuration for the set"</span>,</pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token string">"me"</span> <span class="token builtin class-name">:</span> <span class="token string">"192.168.244.142:27019"</span>,</pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token string">"ok"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token string">"<span class="token variable">$gleStats</span>"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>		<span class="token string">"lastOpTime"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686191196</span>, <span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="8"></td><td><pre>		<span class="token string">"electionId"</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">"000000000000000000000000"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	<span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="10"></td><td><pre>	<span class="token string">"lastCommittedOpTime"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686191196</span>, <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>myshardrs:SECONDARY<span class="token operator">></span> </pre></td></tr><tr><td data-num="13"></td><td><pre>myshardrs:PRIMARY<span class="token operator">></span></pre></td></tr></table></figure><p>添加从节点，配置服务中没有仲载节点：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>myshardrs:PRIMARY<span class="token operator">></span> rs.add<span class="token punctuation">(</span><span class="token string">"192.168.244.142:27119"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>myshardrs:PRIMARY<span class="token operator">></span> rs.add<span class="token punctuation">(</span><span class="token string">"192.168.244.142:27219"</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>查看状态：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>myshardrs:PRIMARY<span class="token operator">></span> rs.<span class="token function-name function">conf</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"myshardrs"</span>,</pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token string">"version"</span> <span class="token builtin class-name">:</span> <span class="token number">5</span>,</pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token string">"term"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token string">"members"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="7"></td><td><pre>		<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>			<span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>,</pre></td></tr><tr><td data-num="9"></td><td><pre>			<span class="token string">"host"</span> <span class="token builtin class-name">:</span> <span class="token string">"192.168.244.142:27019"</span>,</pre></td></tr><tr><td data-num="10"></td><td><pre>			<span class="token string">"arbiterOnly"</span> <span class="token builtin class-name">:</span> false,</pre></td></tr><tr><td data-num="11"></td><td><pre>			<span class="token string">"buildIndexes"</span> <span class="token builtin class-name">:</span> true,</pre></td></tr><tr><td data-num="12"></td><td><pre>			<span class="token string">"hidden"</span> <span class="token builtin class-name">:</span> false,</pre></td></tr><tr><td data-num="13"></td><td><pre>			<span class="token string">"priority"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="14"></td><td><pre>			<span class="token string">"tags"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>				</pre></td></tr><tr><td data-num="16"></td><td><pre>			<span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="17"></td><td><pre>			<span class="token string">"secondaryDelaySecs"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="18"></td><td><pre>			<span class="token string">"votes"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="19"></td><td><pre>		<span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="20"></td><td><pre>		<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>			<span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="22"></td><td><pre>			<span class="token string">"host"</span> <span class="token builtin class-name">:</span> <span class="token string">"192.168.244.142:27119"</span>,</pre></td></tr><tr><td data-num="23"></td><td><pre>			<span class="token string">"arbiterOnly"</span> <span class="token builtin class-name">:</span> false,</pre></td></tr><tr><td data-num="24"></td><td><pre>			<span class="token string">"buildIndexes"</span> <span class="token builtin class-name">:</span> true,</pre></td></tr><tr><td data-num="25"></td><td><pre>			<span class="token string">"hidden"</span> <span class="token builtin class-name">:</span> false,</pre></td></tr><tr><td data-num="26"></td><td><pre>			<span class="token string">"priority"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="27"></td><td><pre>			<span class="token string">"tags"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>				</pre></td></tr><tr><td data-num="29"></td><td><pre>			<span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="30"></td><td><pre>			<span class="token string">"secondaryDelaySecs"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="31"></td><td><pre>			<span class="token string">"votes"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="32"></td><td><pre>		<span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="33"></td><td><pre>		<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>			<span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>,</pre></td></tr><tr><td data-num="35"></td><td><pre>			<span class="token string">"host"</span> <span class="token builtin class-name">:</span> <span class="token string">"192.168.244.142:27219"</span>,</pre></td></tr><tr><td data-num="36"></td><td><pre>			<span class="token string">"arbiterOnly"</span> <span class="token builtin class-name">:</span> false,</pre></td></tr><tr><td data-num="37"></td><td><pre>			<span class="token string">"buildIndexes"</span> <span class="token builtin class-name">:</span> true,</pre></td></tr><tr><td data-num="38"></td><td><pre>			<span class="token string">"hidden"</span> <span class="token builtin class-name">:</span> false,</pre></td></tr><tr><td data-num="39"></td><td><pre>			<span class="token string">"priority"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="40"></td><td><pre>			<span class="token string">"tags"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>				</pre></td></tr><tr><td data-num="42"></td><td><pre>			<span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="43"></td><td><pre>			<span class="token string">"secondaryDelaySecs"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="44"></td><td><pre>			<span class="token string">"votes"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="45"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>	<span class="token punctuation">]</span>,</pre></td></tr><tr><td data-num="47"></td><td><pre>	<span class="token string">"configsvr"</span> <span class="token builtin class-name">:</span> true,</pre></td></tr><tr><td data-num="48"></td><td><pre>	<span class="token string">"protocolVersion"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="49"></td><td><pre>	<span class="token string">"writeConcernMajorityJournalDefault"</span> <span class="token builtin class-name">:</span> true,</pre></td></tr><tr><td data-num="50"></td><td><pre>	<span class="token string">"settings"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>		<span class="token string">"chainingAllowed"</span> <span class="token builtin class-name">:</span> true,</pre></td></tr><tr><td data-num="52"></td><td><pre>		<span class="token string">"heartbeatIntervalMillis"</span> <span class="token builtin class-name">:</span> <span class="token number">2000</span>,</pre></td></tr><tr><td data-num="53"></td><td><pre>		<span class="token string">"heartbeatTimeoutSecs"</span> <span class="token builtin class-name">:</span> <span class="token number">10</span>,</pre></td></tr><tr><td data-num="54"></td><td><pre>		<span class="token string">"electionTimeoutMillis"</span> <span class="token builtin class-name">:</span> <span class="token number">10000</span>,</pre></td></tr><tr><td data-num="55"></td><td><pre>		<span class="token string">"catchUpTimeoutMillis"</span> <span class="token builtin class-name">:</span> -1,</pre></td></tr><tr><td data-num="56"></td><td><pre>		<span class="token string">"catchUpTakeoverDelayMillis"</span> <span class="token builtin class-name">:</span> <span class="token number">30000</span>,</pre></td></tr><tr><td data-num="57"></td><td><pre>		<span class="token string">"getLastErrorModes"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>			</pre></td></tr><tr><td data-num="59"></td><td><pre>		<span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="60"></td><td><pre>		<span class="token string">"getLastErrorDefaults"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>			<span class="token string">"w"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="62"></td><td><pre>			<span class="token string">"wtimeout"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="63"></td><td><pre>		<span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="64"></td><td><pre>		<span class="token string">"replicaSetId"</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">"64813c5c4c6469e9d2fe9264"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="65"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="66"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>myshardrs:PRIMARY<span class="token operator">></span></pre></td></tr></table></figure><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031700512.png" alt="image-20230608102950142"></p><p>配置服务搭建完成！</p><p>分片和配置副本集服务都搭建完成了下面搭建路由节点服务，注意它使用的不是 mongod 服务了而是 mongos 服务</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031700137.png" alt="image-20230608103603425"></p><h3 id="路由节点的创建和操作"><a class="anchor" href="#路由节点的创建和操作">#</a> 路由节点的创建和操作</h3><h4 id="第一个路由节点的创建和连接"><a class="anchor" href="#第一个路由节点的创建和连接">#</a> 第一个路由节点的创建和连接</h4><p>路由的主要作用就是分发不会存储具体的数据，所以不需要 data 目录</p><p>创建存放数据和日志的目录：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>➜ ~ <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /mongodb/sharded_cluster/myshardrs_27017/log</pre></td></tr></table></figure><p>新建或修改配置文件：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>➜  ~ <span class="token function">vim</span> /mongodb/sharded_cluster/myshardrs_27017/mongos.conf</pre></td></tr></table></figure><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>systemLog:</pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token comment">#MongoDB 发送所有日志输出的目标指定为文件</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token comment">#The path of the log file to which mongod or mongos should send all diagnostic logging information</span></pre></td></tr><tr><td data-num="4"></td><td><pre> destination: <span class="token function">file</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token comment">#mongod 或 mongos 应向其发送所有诊断日志记录信息的日志文件的路径</span></pre></td></tr><tr><td data-num="6"></td><td><pre> path: <span class="token string">"/mongodb/sharded_cluster/myshardrs_27017/log/mongod.log"</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token comment">#当 mongos 或 mongod 实例重新启动时，mongos 或 mongod 会将新条目附加到现有日志文件的末尾。</span></pre></td></tr><tr><td data-num="8"></td><td><pre> logAppend: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="9"></td><td><pre>processManagement:</pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token comment">#启用在后台运行 mongos 或 mongod 进程的守护进程模式。</span></pre></td></tr><tr><td data-num="11"></td><td><pre> fork: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token comment">#指定用于保存 mongos 或 mongod 进程的进行 ID 的文件位置，其中 mongos 或 mongod 将写入其 PID</span></pre></td></tr><tr><td data-num="13"></td><td><pre> pidFilePath: <span class="token string">"/mongodb/sharded_cluster/myshardrs_27017/log/mongod.pid"</span></pre></td></tr><tr><td data-num="14"></td><td><pre>net:</pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token comment">#服务实例绑定 IP，默认是 localhost</span></pre></td></tr><tr><td data-num="16"></td><td><pre> bindIp: localhost,192.168.244.142</pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token comment">#bindIp</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token comment">#绑定的端口，默认是 27017</span></pre></td></tr><tr><td data-num="19"></td><td><pre> port: <span class="token number">27017</span></pre></td></tr><tr><td data-num="20"></td><td><pre>sharding:</pre></td></tr><tr><td data-num="21"></td><td><pre> <span class="token comment">#指定配置节点副本集</span></pre></td></tr><tr><td data-num="22"></td><td><pre> <span class="token comment">#        副本集名称 / 主机地址与端口号</span></pre></td></tr><tr><td data-num="23"></td><td><pre> configDB: myconfigrs/192.168.244.142:27019,192.168.244.142:27119,192.168.244.142:27219</pre></td></tr></table></figure><p>启动服务：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>➜  ~ /usr/local/mongodb/bin/mongos <span class="token parameter variable">-f</span> /mongodb/sharded_cluster/myshardrs_27017/mongos.conf </pre></td></tr><tr><td data-num="2"></td><td><pre>about to fork child process, waiting <span class="token keyword">until</span> server is ready <span class="token keyword">for</span> connections.</pre></td></tr><tr><td data-num="3"></td><td><pre>forked process: <span class="token number">10092</span></pre></td></tr><tr><td data-num="4"></td><td><pre>child process started successfully, parent exiting</pre></td></tr><tr><td data-num="5"></td><td><pre>➜  ~</pre></td></tr></table></figure><p>查看进程：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#分片副本集</span></pre></td></tr><tr><td data-num="2"></td><td><pre>➜  ~ <span class="token function">ps</span> -ef<span class="token operator">|</span><span class="token function">grep</span> mongod<span class="token operator">|</span><span class="token function">grep</span> <span class="token parameter variable">-v</span> <span class="token function">grep</span></pre></td></tr><tr><td data-num="3"></td><td><pre>dkx0       <span class="token number">2291</span>      <span class="token number">1</span>  <span class="token number">1</span> <span class="token number">20</span>:57 ?        00:02:07 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/sharded_cluster/myshardrs01_27018/mongod.conf</pre></td></tr><tr><td data-num="4"></td><td><pre>dkx0       <span class="token number">2368</span>      <span class="token number">1</span>  <span class="token number">2</span> <span class="token number">20</span>:57 ?        00:02:26 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/sharded_cluster/myshardrs01_27118/mongod.conf</pre></td></tr><tr><td data-num="5"></td><td><pre>dkx0       <span class="token number">2443</span>      <span class="token number">1</span>  <span class="token number">1</span> <span class="token number">20</span>:57 ?        00:02:02 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/sharded_cluster/myshardrs01_27218/mongod.conf</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>dkx0       <span class="token number">5200</span>      <span class="token number">1</span>  <span class="token number">1</span> <span class="token number">21</span>:42 ?        00:01:19 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/sharded_cluster/myshardrs01_27318/mongod.conf</pre></td></tr><tr><td data-num="8"></td><td><pre>dkx0       <span class="token number">5268</span>      <span class="token number">1</span>  <span class="token number">1</span> <span class="token number">21</span>:42 ?        00:01:19 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/sharded_cluster/myshardrs01_27418/mongod.conf</pre></td></tr><tr><td data-num="9"></td><td><pre>dkx0       <span class="token number">5337</span>      <span class="token number">1</span>  <span class="token number">1</span> <span class="token number">21</span>:43 ?        00:01:00 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/sharded_cluster/myshardrs01_27518/mongod.conf</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">#配置服务副本集</span></pre></td></tr><tr><td data-num="11"></td><td><pre>dkx0       <span class="token number">7659</span>      <span class="token number">1</span>  <span class="token number">2</span> <span class="token number">22</span>:19 ?        00:00:53 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/sharded_cluster/myshardrs01_27019/mongod.conf</pre></td></tr><tr><td data-num="12"></td><td><pre>dkx0       <span class="token number">7736</span>      <span class="token number">1</span>  <span class="token number">2</span> <span class="token number">22</span>:19 ?        00:00:54 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/sharded_cluster/myshardrs01_27119/mongod.conf</pre></td></tr><tr><td data-num="13"></td><td><pre>dkx0       <span class="token number">7808</span>      <span class="token number">1</span>  <span class="token number">2</span> <span class="token number">22</span>:19 ?        00:00:53 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/sharded_cluster/myshardrs01_27219/mongod.conf</pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment">#路由副本集</span></pre></td></tr><tr><td data-num="15"></td><td><pre>dkx0      <span class="token number">10092</span>      <span class="token number">1</span>  <span class="token number">0</span> <span class="token number">22</span>:53 ?        00:00:00 /usr/local/mongodb/bin/mongos <span class="token parameter variable">-f</span> /mongodb/sharded_cluster/myshardrs_27017/mongos.conf</pre></td></tr><tr><td data-num="16"></td><td><pre>➜  ~</pre></td></tr></table></figure><p>连接客户端：还是同样的操作，但是命令符提示为：mongos</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>➜  ~ /usr/local/mongodb/bin/mongo <span class="token parameter variable">--host</span><span class="token operator">=</span><span class="token number">192.168</span>.244.142 <span class="token parameter variable">--port</span><span class="token operator">=</span><span class="token number">27017</span></pre></td></tr><tr><td data-num="2"></td><td><pre>MongoDB shell version v5.0.18</pre></td></tr><tr><td data-num="3"></td><td><pre>connecting to: mongodb://192.168.244.142:27017/?compressors<span class="token operator">=</span>disabled<span class="token operator">&amp;</span><span class="token assign-left variable">gssapiServiceName</span><span class="token operator">=</span>mongodb</pre></td></tr><tr><td data-num="4"></td><td><pre>Implicit session: session <span class="token punctuation">&#123;</span> <span class="token string">"id"</span> <span class="token builtin class-name">:</span> UUID<span class="token punctuation">(</span><span class="token string">"f9216227-99d6-4270-bb3e-b47ab59e205b"</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>MongoDB server version: <span class="token number">5.0</span>.18</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span></pre></td></tr><tr><td data-num="7"></td><td><pre>Warning: the <span class="token string">"mongo"</span> shell has been superseded by <span class="token string">"mongosh"</span>,</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token function">which</span> delivers improved usability and compatibility.The <span class="token string">"mongo"</span> shell has been deprecated and will be removed <span class="token keyword">in</span></pre></td></tr><tr><td data-num="9"></td><td><pre>an upcoming release.</pre></td></tr><tr><td data-num="10"></td><td><pre>For installation instructions, see</pre></td></tr><tr><td data-num="11"></td><td><pre>https://docs.mongodb.com/mongodb-shell/install/</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span></pre></td></tr><tr><td data-num="13"></td><td><pre>---</pre></td></tr><tr><td data-num="14"></td><td><pre>The server generated these startup warnings when booting: </pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token number">2023</span>-06-07T22:53:18.509-04:00: Access control is not enabled <span class="token keyword">for</span> the database. Read and <span class="token function">write</span> access to data and configuration is unrestricted</pre></td></tr><tr><td data-num="16"></td><td><pre>---</pre></td></tr><tr><td data-num="17"></td><td><pre>mongos<span class="token operator">></span></pre></td></tr></table></figure><p>此时，能查看数据库，但是不能写入数据否则报错：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>mongos<span class="token operator">></span> show dbs</pre></td></tr><tr><td data-num="2"></td><td><pre>admin   <span class="token number">0</span>.000GB</pre></td></tr><tr><td data-num="3"></td><td><pre>config  <span class="token number">0</span>.000GB</pre></td></tr><tr><td data-num="4"></td><td><pre>mongos<span class="token operator">></span> use aabb</pre></td></tr><tr><td data-num="5"></td><td><pre>switched to db aabb</pre></td></tr><tr><td data-num="6"></td><td><pre>mongos<span class="token operator">></span> db</pre></td></tr><tr><td data-num="7"></td><td><pre>aabb</pre></td></tr><tr><td data-num="8"></td><td><pre>mongos<span class="token operator">></span> db.aa.insert<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"刘桑"</span>,<span class="token string">"age"</span><span class="token builtin class-name">:</span><span class="token string">"22"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>WriteCommandError<span class="token punctuation">(</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>	<span class="token string">"ok"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>,</pre></td></tr><tr><td data-num="11"></td><td><pre>	<span class="token string">"errmsg"</span> <span class="token builtin class-name">:</span> <span class="token string">"Database aabb could not be created :: caused by :: No shards found"</span>,</pre></td></tr><tr><td data-num="12"></td><td><pre>	<span class="token string">"code"</span> <span class="token builtin class-name">:</span> <span class="token number">70</span>,</pre></td></tr><tr><td data-num="13"></td><td><pre>	<span class="token string">"codeName"</span> <span class="token builtin class-name">:</span> <span class="token string">"ShardNotFound"</span>,</pre></td></tr><tr><td data-num="14"></td><td><pre>	<span class="token string">"<span class="token variable">$clusterTime</span>"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>		<span class="token string">"clusterTime"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686193139</span>, <span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="16"></td><td><pre>		<span class="token string">"signature"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>			<span class="token string">"hash"</span> <span class="token builtin class-name">:</span> BinData<span class="token punctuation">(</span><span class="token number">0</span>,<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAA="</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="18"></td><td><pre>			<span class="token string">"keyId"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>	<span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="21"></td><td><pre>	<span class="token string">"operationTime"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686193139</span>, <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre>mongos<span class="token operator">></span></pre></td></tr></table></figure><p>报错信息：Database aabb could not be created :: caused by :: No shards found</p><p>翻译：无法创建数据库 aabb ：： 由 ：： 未找到分片</p><p>解释：</p><blockquote><p>我们新建路由节点的时候配置文件中只指定了配置服务副本集如下：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>sharding:</pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token comment">#指定配置节点副本集</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token comment">#        副本集名称 / 主机地址与端口号</span></pre></td></tr><tr><td data-num="4"></td><td><pre> configDB: myconfigrs/192.168.244.142:27019,192.168.244.142:27119,192.168.244.142:27219</pre></td></tr></table></figure><p>mongos 启动的时候指定了副本集代表路由和配置服务是联通的，但是没有分片不能存储数据，因为最终存储数据是分片</p></blockquote><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031700965.png" alt="image-20230608110542590"></p><h4 id="在路由节点上进行分片配置操作"><a class="anchor" href="#在路由节点上进行分片配置操作">#</a> 在路由节点上进行分片配置操作</h4><p>使用命令添加分片：</p><p>1. 添加分片：</p><p>语法：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>sh.addShard<span class="token punctuation">(</span><span class="token string">"IP:Port"</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>将第一套分片副本集添加进来：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>mongos<span class="token operator">></span> sh.addShard<span class="token punctuation">(</span><span class="token string">"myshardrs01/192.168.244.142:27018,192.168.244.142:27118,192.168.244.142:27218"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token string">"shardAdded"</span> <span class="token builtin class-name">:</span> <span class="token string">"myshardrs01"</span>,</pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token string">"ok"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token string">"<span class="token variable">$clusterTime</span>"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>		<span class="token string">"clusterTime"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686193852</span>, <span class="token number">1</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="7"></td><td><pre>		<span class="token string">"signature"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>			<span class="token string">"hash"</span> <span class="token builtin class-name">:</span> BinData<span class="token punctuation">(</span><span class="token number">0</span>,<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAA="</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="9"></td><td><pre>			<span class="token string">"keyId"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>	<span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="12"></td><td><pre>	<span class="token string">"operationTime"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686193852</span>, <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>mongos<span class="token operator">></span></pre></td></tr></table></figure><p>继续将第二套分片副本集添加进来：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>mongos<span class="token operator">></span> sh.addShard<span class="token punctuation">(</span><span class="token string">"myshardrs02/192.168.244.142:27318,192.168.244.142:27418,192.168.244.142:27518"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token string">"shardAdded"</span> <span class="token builtin class-name">:</span> <span class="token string">"myshardrs02"</span>,</pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token string">"ok"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token string">"<span class="token variable">$clusterTime</span>"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>		<span class="token string">"clusterTime"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686194172</span>, <span class="token number">3</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="7"></td><td><pre>		<span class="token string">"signature"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>			<span class="token string">"hash"</span> <span class="token builtin class-name">:</span> BinData<span class="token punctuation">(</span><span class="token number">0</span>,<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAA="</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="9"></td><td><pre>			<span class="token string">"keyId"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>	<span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="12"></td><td><pre>	<span class="token string">"operationTime"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686194172</span>, <span class="token number">3</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>mongos<span class="token operator">></span></pre></td></tr></table></figure><p>查看状态：可以看到 shards 中有两个分片副本集了</p><p>&quot;host&quot; : &quot;myshardrs01/192.168.244.142:27018,192.168.244.142:27118&quot; 没有把仲载节点加进来</p><p>因为仲载不存储数据所以分片的时候没必要知道它，但是使用 sh.addShard 的时候还是必须带上的</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>mongos<span class="token operator">></span> sh.status<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>--- Sharding Status --- </pre></td></tr><tr><td data-num="3"></td><td><pre>  sharding version: <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  	<span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="5"></td><td><pre>  	<span class="token string">"minCompatibleVersion"</span> <span class="token builtin class-name">:</span> <span class="token number">5</span>,</pre></td></tr><tr><td data-num="6"></td><td><pre>  	<span class="token string">"currentVersion"</span> <span class="token builtin class-name">:</span> <span class="token number">6</span>,</pre></td></tr><tr><td data-num="7"></td><td><pre>  	<span class="token string">"clusterId"</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">"64813c5c4c6469e9d2fe9269"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  shards:</pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token punctuation">&#123;</span>  <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"myshardrs01"</span>,  <span class="token string">"host"</span> <span class="token builtin class-name">:</span> <span class="token string">"myshardrs01/192.168.244.142:27018,192.168.244.142:27118"</span>,  <span class="token string">"state"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,  <span class="token string">"topologyTime"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686193851</span>, <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token punctuation">&#123;</span>  <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"myshardrs02"</span>,  <span class="token string">"host"</span> <span class="token builtin class-name">:</span> <span class="token string">"myshardrs02/192.168.244.142:27318,192.168.244.142:27418"</span>,  <span class="token string">"state"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,  <span class="token string">"topologyTime"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686194172</span>, <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  active mongoses:</pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token string">"5.0.18"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  autosplit:</pre></td></tr><tr><td data-num="15"></td><td><pre>        Currently enabled: <span class="token function">yes</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  balancer:</pre></td></tr><tr><td data-num="17"></td><td><pre>        Currently enabled: <span class="token function">yes</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        Currently running: <span class="token function">yes</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        Failed balancer rounds <span class="token keyword">in</span> last <span class="token number">5</span> attempts: <span class="token number">0</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        Migration results <span class="token keyword">for</span> the last <span class="token number">24</span> hours: </pre></td></tr><tr><td data-num="21"></td><td><pre>                <span class="token number">55</span> <span class="token builtin class-name">:</span> Success</pre></td></tr><tr><td data-num="22"></td><td><pre>  databases:</pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token punctuation">&#123;</span>  <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"articledb"</span>,  <span class="token string">"primary"</span> <span class="token builtin class-name">:</span> <span class="token string">"myshardrs01"</span>,  <span class="token string">"partitioned"</span> <span class="token builtin class-name">:</span> false,  <span class="token string">"version"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>  <span class="token string">"uuid"</span> <span class="token builtin class-name">:</span> UUID<span class="token punctuation">(</span><span class="token string">"b94e53c7-d498-49b8-8965-1aafcab2df18"</span><span class="token punctuation">)</span>,  <span class="token string">"timestamp"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686193851</span>, <span class="token number">3</span><span class="token punctuation">)</span>,  <span class="token string">"lastMod"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token punctuation">&#123;</span>  <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"config"</span>,  <span class="token string">"primary"</span> <span class="token builtin class-name">:</span> <span class="token string">"config"</span>,  <span class="token string">"partitioned"</span> <span class="token builtin class-name">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>                config.system.sessions</pre></td></tr><tr><td data-num="26"></td><td><pre>                        shard key: <span class="token punctuation">&#123;</span> <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                        unique: <span class="token boolean">false</span></pre></td></tr><tr><td data-num="28"></td><td><pre>                        balancing: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="29"></td><td><pre>                        chunks:</pre></td></tr><tr><td data-num="30"></td><td><pre>                                myshardrs01	<span class="token number">969</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                                myshardrs02	<span class="token number">55</span></pre></td></tr><tr><td data-num="32"></td><td><pre>                        too many chunks to print, use verbose <span class="token keyword">if</span> you want to force print</pre></td></tr><tr><td data-num="33"></td><td><pre>mongos<span class="token operator">></span></pre></td></tr></table></figure><p>提示：</p><p>如果添加分片失败，需要先手动移除分片，检查添加分片的信息正确性后，再次添加分片</p><p>移除分片参考：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>use admin</pre></td></tr><tr><td data-num="2"></td><td><pre>db.runcommand<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>removeShard:<span class="token string">"myshardrs02"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>注意： 如果只剩下最后一个 shard，是无法删除的</p><p>移除时会自动转移分片数据，需要一个时间过程</p><p>完成后，再次执行删除分片命令才能真正删除</p><p>2. 开启分片功能：sh.enableSharding (&quot;库名&quot;)，sh.shardCollection (&quot;库名。集合名&quot;,{&quot;key&quot;:1}&quot;)</p><p>在 mongos 上的 articledb 数据库配置 sharding:</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>mongos<span class="token operator">></span> sh.enableSharding<span class="token punctuation">(</span><span class="token string">"articledb"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token string">"ok"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token string">"<span class="token variable">$clusterTime</span>"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>		<span class="token string">"clusterTime"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686194695</span>, <span class="token number">38</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="6"></td><td><pre>		<span class="token string">"signature"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>			<span class="token string">"hash"</span> <span class="token builtin class-name">:</span> BinData<span class="token punctuation">(</span><span class="token number">0</span>,<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAA="</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="8"></td><td><pre>			<span class="token string">"keyId"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>	<span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="11"></td><td><pre>	<span class="token string">"operationTime"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686194695</span>, <span class="token number">38</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>mongos<span class="token operator">></span></pre></td></tr></table></figure><p>查看分片状态：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>mongos<span class="token operator">></span> sh.status<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>--- Sharding Status --- </pre></td></tr><tr><td data-num="3"></td><td><pre>  sharding version: <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  	<span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="5"></td><td><pre>  	<span class="token string">"minCompatibleVersion"</span> <span class="token builtin class-name">:</span> <span class="token number">5</span>,</pre></td></tr><tr><td data-num="6"></td><td><pre>  	<span class="token string">"currentVersion"</span> <span class="token builtin class-name">:</span> <span class="token number">6</span>,</pre></td></tr><tr><td data-num="7"></td><td><pre>  	<span class="token string">"clusterId"</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">"64813c5c4c6469e9d2fe9269"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  shards:</pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token punctuation">&#123;</span>  <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"myshardrs01"</span>,  <span class="token string">"host"</span> <span class="token builtin class-name">:</span> <span class="token string">"myshardrs01/192.168.244.142:27018,192.168.244.142:27118"</span>,  <span class="token string">"state"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,  <span class="token string">"topologyTime"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686193851</span>, <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token punctuation">&#123;</span>  <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"myshardrs02"</span>,  <span class="token string">"host"</span> <span class="token builtin class-name">:</span> <span class="token string">"myshardrs02/192.168.244.142:27318,192.168.244.142:27418"</span>,  <span class="token string">"state"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,  <span class="token string">"topologyTime"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686194172</span>, <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  active mongoses:</pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token string">"5.0.18"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  autosplit:</pre></td></tr><tr><td data-num="15"></td><td><pre>        Currently enabled: <span class="token function">yes</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  balancer:</pre></td></tr><tr><td data-num="17"></td><td><pre>        Currently enabled: <span class="token function">yes</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        Currently running: no</pre></td></tr><tr><td data-num="19"></td><td><pre>        Failed balancer rounds <span class="token keyword">in</span> last <span class="token number">5</span> attempts: <span class="token number">0</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        Migration results <span class="token keyword">for</span> the last <span class="token number">24</span> hours: </pre></td></tr><tr><td data-num="21"></td><td><pre>                <span class="token number">480</span> <span class="token builtin class-name">:</span> Success</pre></td></tr><tr><td data-num="22"></td><td><pre>  databases:</pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token punctuation">&#123;</span>  <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"articledb"</span>,  <span class="token string">"primary"</span> <span class="token builtin class-name">:</span> <span class="token string">"myshardrs01"</span>,  <span class="token string">"partitioned"</span> <span class="token builtin class-name">:</span> true,  <span class="token string">"version"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>  <span class="token string">"uuid"</span> <span class="token builtin class-name">:</span> UUID<span class="token punctuation">(</span><span class="token string">"b94e53c7-d498-49b8-8965-1aafcab2df18"</span><span class="token punctuation">)</span>,  <span class="token string">"timestamp"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686193851</span>, <span class="token number">3</span><span class="token punctuation">)</span>,  <span class="token string">"lastMod"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token punctuation">&#123;</span>  <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"config"</span>,  <span class="token string">"primary"</span> <span class="token builtin class-name">:</span> <span class="token string">"config"</span>,  <span class="token string">"partitioned"</span> <span class="token builtin class-name">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>                config.system.sessions</pre></td></tr><tr><td data-num="26"></td><td><pre>                        shard key: <span class="token punctuation">&#123;</span> <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                        unique: <span class="token boolean">false</span></pre></td></tr><tr><td data-num="28"></td><td><pre>                        balancing: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="29"></td><td><pre>                        chunks:</pre></td></tr><tr><td data-num="30"></td><td><pre>                                myshardrs01	<span class="token number">544</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                                myshardrs02	<span class="token number">480</span></pre></td></tr><tr><td data-num="32"></td><td><pre>                        too many chunks to print, use verbose <span class="token keyword">if</span> you want to force print</pre></td></tr><tr><td data-num="33"></td><td><pre>mongos<span class="token operator">></span></pre></td></tr></table></figure><p>3. 集合分片</p><p>对集合分片，你必须使用 sh.shardCollection () 方法指定集合的分片键。</p><p>语法：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>sh.shardCollection<span class="token punctuation">(</span>namespace,key,unique<span class="token punctuation">)</span></pre></td></tr></table></figure><p>参数：</p><table><thead><tr><th>Parameter</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td>namespace</td><td>string</td><td>要 (分片) 共享的目标集合的命名空间，格式：&lt;database&gt;.&lt;collection&gt;</td></tr><tr><td>key</td><td>document</td><td>用作分片键的索引规范文档，shard 键决定 MongoDB 如何在 shard 之间分发文档，除非集合为空，否则索引必须在 shard collection 命令之前存在，如果集合为空，则 MongoDB 在对集合进行分片之前创建索引，前提是支持分片键的索引不存在，简单的说：由包含字段和该字段的索引遍历方向的文档组成</td></tr><tr><td>unique</td><td>boolean</td><td>当值为 true 情况下，片键字段上会限制为确保是唯一索引，哈希策略片键不支持唯一索引，默认是 false</td></tr></tbody></table><p>对集合进行分片时，你需要选择一个片键 (Shard key),shard key 是每条记录都必须包含的，且建立了索引的单个字段或复合字段，MongoDB 按照片键将数据划分到不同的数据块中，并将数据块 均衡的分不到所有分片中，为了按照片键划分数据库 MongoDB 使用基于哈希的分片方式 (随机平均分配) 或者基于范围的分片方式 (数值大小分配)</p><p>用什么字段当片键都可以，如：nickname 作为片键，但一定是必填字段</p><p><mark>注意</mark>：MongoDB 只能通过一个字段给某个集合分片不能说一个集合即按哈希有按范围分片</p><p>分片规则一：哈希策略</p><p>对于基于哈希的分片，MongoDB 计算一个字段的哈希值，并用这个哈希值来创建数据块</p><p>在使用基于哈希分片的系统中，拥有 &quot;相近&quot; 片键的文档，很可能不会存储在同一个数据块中，因此数据的分离性更好一些。</p><p>使用 nickname 作为片键，根据其值的哈希值进行数据分片</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>mongos<span class="token operator">></span> sh.shardCollection<span class="token punctuation">(</span><span class="token string">"articledb.comment"</span>,<span class="token punctuation">&#123;</span><span class="token string">"nickname"</span><span class="token builtin class-name">:</span><span class="token string">"hashed"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token string">"collectionsharded"</span> <span class="token builtin class-name">:</span> <span class="token string">"articledb.comment"</span>,</pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token string">"ok"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token string">"<span class="token variable">$clusterTime</span>"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>		<span class="token string">"clusterTime"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686196321</span>, <span class="token number">36</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="7"></td><td><pre>		<span class="token string">"signature"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>			<span class="token string">"hash"</span> <span class="token builtin class-name">:</span> BinData<span class="token punctuation">(</span><span class="token number">0</span>,<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAA="</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="9"></td><td><pre>			<span class="token string">"keyId"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>	<span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="12"></td><td><pre>	<span class="token string">"operationTime"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686196321</span>, <span class="token number">32</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>mongos<span class="token operator">></span></pre></td></tr></table></figure><p>查看状态：</p><p>shard key: {&quot;nickname&quot; : &quot;hashed&quot;} 分片策略哈希</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>mongos<span class="token operator">></span> sh.status<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>--- Sharding Status --- </pre></td></tr><tr><td data-num="3"></td><td><pre>  sharding version: <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  	<span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="5"></td><td><pre>  	<span class="token string">"minCompatibleVersion"</span> <span class="token builtin class-name">:</span> <span class="token number">5</span>,</pre></td></tr><tr><td data-num="6"></td><td><pre>  	<span class="token string">"currentVersion"</span> <span class="token builtin class-name">:</span> <span class="token number">6</span>,</pre></td></tr><tr><td data-num="7"></td><td><pre>  	<span class="token string">"clusterId"</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">"64813c5c4c6469e9d2fe9269"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  shards:</pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token punctuation">&#123;</span>  <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"myshardrs01"</span>,  <span class="token string">"host"</span> <span class="token builtin class-name">:</span> <span class="token string">"myshardrs01/192.168.244.142:27018,192.168.244.142:27118"</span>,  <span class="token string">"state"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,  <span class="token string">"topologyTime"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686193851</span>, <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token punctuation">&#123;</span>  <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"myshardrs02"</span>,  <span class="token string">"host"</span> <span class="token builtin class-name">:</span> <span class="token string">"myshardrs02/192.168.244.142:27318,192.168.244.142:27418"</span>,  <span class="token string">"state"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,  <span class="token string">"topologyTime"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686194172</span>, <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  active mongoses:</pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token string">"5.0.18"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  autosplit:</pre></td></tr><tr><td data-num="15"></td><td><pre>        Currently enabled: <span class="token function">yes</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  balancer:</pre></td></tr><tr><td data-num="17"></td><td><pre>        Currently enabled: <span class="token function">yes</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        Currently running: no</pre></td></tr><tr><td data-num="19"></td><td><pre>        Failed balancer rounds <span class="token keyword">in</span> last <span class="token number">5</span> attempts: <span class="token number">0</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        Migration results <span class="token keyword">for</span> the last <span class="token number">24</span> hours: </pre></td></tr><tr><td data-num="21"></td><td><pre>                <span class="token number">512</span> <span class="token builtin class-name">:</span> Success</pre></td></tr><tr><td data-num="22"></td><td><pre>  databases:</pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token punctuation">&#123;</span>  <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"articledb"</span>,  <span class="token string">"primary"</span> <span class="token builtin class-name">:</span> <span class="token string">"myshardrs01"</span>,  <span class="token string">"partitioned"</span> <span class="token builtin class-name">:</span> true,  <span class="token string">"version"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>  <span class="token string">"uuid"</span> <span class="token builtin class-name">:</span> UUID<span class="token punctuation">(</span><span class="token string">"b94e53c7-d498-49b8-8965-1aafcab2df18"</span><span class="token punctuation">)</span>,  <span class="token string">"timestamp"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686193851</span>, <span class="token number">3</span><span class="token punctuation">)</span>,  <span class="token string">"lastMod"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>                articledb.comment</pre></td></tr><tr><td data-num="25"></td><td><pre>                        shard key: <span class="token punctuation">&#123;</span> <span class="token string">"nickname"</span> <span class="token builtin class-name">:</span> <span class="token string">"hashed"</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>                        unique: <span class="token boolean">false</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                        balancing: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="28"></td><td><pre>                        chunks:</pre></td></tr><tr><td data-num="29"></td><td><pre>                                myshardrs01	<span class="token number">2</span></pre></td></tr><tr><td data-num="30"></td><td><pre>                                myshardrs02	<span class="token number">2</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                        <span class="token punctuation">&#123;</span> <span class="token string">"nickname"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"<span class="token variable">$minKey</span>"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span> --<span class="token operator">>></span> <span class="token punctuation">&#123;</span> <span class="token string">"nickname"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token string">"-4611686018427387902"</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span> on <span class="token builtin class-name">:</span> myshardrs01 Timestamp<span class="token punctuation">(</span><span class="token number">1</span>, <span class="token number">0</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="32"></td><td><pre>                        <span class="token punctuation">&#123;</span> <span class="token string">"nickname"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token string">"-4611686018427387902"</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span> --<span class="token operator">>></span> <span class="token punctuation">&#123;</span> <span class="token string">"nickname"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span> on <span class="token builtin class-name">:</span> myshardrs01 Timestamp<span class="token punctuation">(</span><span class="token number">1</span>, <span class="token number">1</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="33"></td><td><pre>                        <span class="token punctuation">&#123;</span> <span class="token string">"nickname"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span> --<span class="token operator">>></span> <span class="token punctuation">&#123;</span> <span class="token string">"nickname"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token string">"4611686018427387902"</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span> on <span class="token builtin class-name">:</span> myshardrs02 Timestamp<span class="token punctuation">(</span><span class="token number">1</span>, <span class="token number">2</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="34"></td><td><pre>                        <span class="token punctuation">&#123;</span> <span class="token string">"nickname"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token string">"4611686018427387902"</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span> --<span class="token operator">>></span> <span class="token punctuation">&#123;</span> <span class="token string">"nickname"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"<span class="token variable">$maxKey</span>"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span> on <span class="token builtin class-name">:</span> myshardrs02 Timestamp<span class="token punctuation">(</span><span class="token number">1</span>, <span class="token number">3</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token punctuation">&#123;</span>  <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"config"</span>,  <span class="token string">"primary"</span> <span class="token builtin class-name">:</span> <span class="token string">"config"</span>,  <span class="token string">"partitioned"</span> <span class="token builtin class-name">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>                config.system.sessions</pre></td></tr><tr><td data-num="37"></td><td><pre>                        shard key: <span class="token punctuation">&#123;</span> <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>                        unique: <span class="token boolean">false</span></pre></td></tr><tr><td data-num="39"></td><td><pre>                        balancing: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="40"></td><td><pre>                        chunks:</pre></td></tr><tr><td data-num="41"></td><td><pre>                                myshardrs01	<span class="token number">512</span></pre></td></tr><tr><td data-num="42"></td><td><pre>                                myshardrs02	<span class="token number">512</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                        too many chunks to print, use verbose <span class="token keyword">if</span> you want to force print</pre></td></tr><tr><td data-num="44"></td><td><pre>mongos<span class="token operator">></span></pre></td></tr></table></figure><p>提示：</p><p>报错：please create an index that starts with the shard key before sharding</p><p>解决方式：判断分支是查找是否有可用的索引存在，当无可用的索引，并且表不为空时，就会出现这个错误信息。</p><p>分片规则二：值范围策略</p><p>对于基于范围的分片，MongoDB 按照片键的范围把数据分成不同部分，假设有一个数字的片键：想象一个从负无穷到正无穷的直线，每一个片键的值都在直线上画了一个点。MongoDB 把这条直线划分为更短的不重叠的片段，并称之为数据块，每个数据块包含了片键在一定范围内的数据。</p><p>在使用片键做范围划分的系统中，拥有 &quot;相近&quot; 片键的文档很可能存储在同一个数据块中，因此也会存储在同一个分片中。</p><p>如果使用作者年龄字段作为片键，按照点赞数的值进行分片：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>mongos<span class="token operator">></span> sh.shardCollection<span class="token punctuation">(</span><span class="token string">"articledb.author"</span>,<span class="token punctuation">&#123;</span><span class="token string">"age"</span>:1<span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token string">"collectionsharded"</span> <span class="token builtin class-name">:</span> <span class="token string">"articledb.author"</span>,</pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token string">"ok"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token string">"<span class="token variable">$clusterTime</span>"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>		<span class="token string">"clusterTime"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686196802</span>, <span class="token number">6</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="7"></td><td><pre>		<span class="token string">"signature"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>			<span class="token string">"hash"</span> <span class="token builtin class-name">:</span> BinData<span class="token punctuation">(</span><span class="token number">0</span>,<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAA="</span><span class="token punctuation">)</span>,</pre></td></tr><tr><td data-num="9"></td><td><pre>			<span class="token string">"keyId"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>	<span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="12"></td><td><pre>	<span class="token string">"operationTime"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686196802</span>, <span class="token number">2</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>mongos<span class="token operator">></span></pre></td></tr></table></figure><p>查看状态：</p><p age:1="">shard key:</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>mongos<span class="token operator">></span> sh.status<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>--- Sharding Status --- </pre></td></tr><tr><td data-num="3"></td><td><pre>  sharding version: <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  	<span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="5"></td><td><pre>  	<span class="token string">"minCompatibleVersion"</span> <span class="token builtin class-name">:</span> <span class="token number">5</span>,</pre></td></tr><tr><td data-num="6"></td><td><pre>  	<span class="token string">"currentVersion"</span> <span class="token builtin class-name">:</span> <span class="token number">6</span>,</pre></td></tr><tr><td data-num="7"></td><td><pre>  	<span class="token string">"clusterId"</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">"64813c5c4c6469e9d2fe9269"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  shards:</pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token punctuation">&#123;</span>  <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"myshardrs01"</span>,  <span class="token string">"host"</span> <span class="token builtin class-name">:</span> <span class="token string">"myshardrs01/192.168.244.142:27018,192.168.244.142:27118"</span>,  <span class="token string">"state"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,  <span class="token string">"topologyTime"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686193851</span>, <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token punctuation">&#123;</span>  <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"myshardrs02"</span>,  <span class="token string">"host"</span> <span class="token builtin class-name">:</span> <span class="token string">"myshardrs02/192.168.244.142:27318,192.168.244.142:27418"</span>,  <span class="token string">"state"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,  <span class="token string">"topologyTime"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686194172</span>, <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  active mongoses:</pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token string">"5.0.18"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  autosplit:</pre></td></tr><tr><td data-num="15"></td><td><pre>        Currently enabled: <span class="token function">yes</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  balancer:</pre></td></tr><tr><td data-num="17"></td><td><pre>        Currently enabled: <span class="token function">yes</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        Currently running: no</pre></td></tr><tr><td data-num="19"></td><td><pre>        Failed balancer rounds <span class="token keyword">in</span> last <span class="token number">5</span> attempts: <span class="token number">0</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        Migration results <span class="token keyword">for</span> the last <span class="token number">24</span> hours: </pre></td></tr><tr><td data-num="21"></td><td><pre>                <span class="token number">512</span> <span class="token builtin class-name">:</span> Success</pre></td></tr><tr><td data-num="22"></td><td><pre>  databases:</pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token punctuation">&#123;</span>  <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"articledb"</span>,  <span class="token string">"primary"</span> <span class="token builtin class-name">:</span> <span class="token string">"myshardrs01"</span>,  <span class="token string">"partitioned"</span> <span class="token builtin class-name">:</span> true,  <span class="token string">"version"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>  <span class="token string">"uuid"</span> <span class="token builtin class-name">:</span> UUID<span class="token punctuation">(</span><span class="token string">"b94e53c7-d498-49b8-8965-1aafcab2df18"</span><span class="token punctuation">)</span>,  <span class="token string">"timestamp"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686193851</span>, <span class="token number">3</span><span class="token punctuation">)</span>,  <span class="token string">"lastMod"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>                articledb.author</pre></td></tr><tr><td data-num="25"></td><td><pre>                        shard key: <span class="token punctuation">&#123;</span> <span class="token string">"age"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>                        unique: <span class="token boolean">false</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                        balancing: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="28"></td><td><pre>                        chunks:</pre></td></tr><tr><td data-num="29"></td><td><pre>                                myshardrs01	<span class="token number">1</span></pre></td></tr><tr><td data-num="30"></td><td><pre>                        <span class="token punctuation">&#123;</span> <span class="token string">"age"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"<span class="token variable">$minKey</span>"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span> --<span class="token operator">>></span> <span class="token punctuation">&#123;</span> <span class="token string">"age"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"<span class="token variable">$maxKey</span>"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span> on <span class="token builtin class-name">:</span> myshardrs01 Timestamp<span class="token punctuation">(</span><span class="token number">1</span>, <span class="token number">0</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="31"></td><td><pre>                articledb.comment</pre></td></tr><tr><td data-num="32"></td><td><pre>                        shard key: <span class="token punctuation">&#123;</span> <span class="token string">"nickname"</span> <span class="token builtin class-name">:</span> <span class="token string">"hashed"</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>                        unique: <span class="token boolean">false</span></pre></td></tr><tr><td data-num="34"></td><td><pre>                        balancing: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="35"></td><td><pre>                        chunks:</pre></td></tr><tr><td data-num="36"></td><td><pre>                                myshardrs01	<span class="token number">2</span></pre></td></tr><tr><td data-num="37"></td><td><pre>                                myshardrs02	<span class="token number">2</span></pre></td></tr><tr><td data-num="38"></td><td><pre>                        <span class="token punctuation">&#123;</span> <span class="token string">"nickname"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"<span class="token variable">$minKey</span>"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span> --<span class="token operator">>></span> <span class="token punctuation">&#123;</span> <span class="token string">"nickname"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token string">"-4611686018427387902"</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span> on <span class="token builtin class-name">:</span> myshardrs01 Timestamp<span class="token punctuation">(</span><span class="token number">1</span>, <span class="token number">0</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="39"></td><td><pre>                        <span class="token punctuation">&#123;</span> <span class="token string">"nickname"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token string">"-4611686018427387902"</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span> --<span class="token operator">>></span> <span class="token punctuation">&#123;</span> <span class="token string">"nickname"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span> on <span class="token builtin class-name">:</span> myshardrs01 Timestamp<span class="token punctuation">(</span><span class="token number">1</span>, <span class="token number">1</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="40"></td><td><pre>                        <span class="token punctuation">&#123;</span> <span class="token string">"nickname"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span> --<span class="token operator">>></span> <span class="token punctuation">&#123;</span> <span class="token string">"nickname"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token string">"4611686018427387902"</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span> on <span class="token builtin class-name">:</span> myshardrs02 Timestamp<span class="token punctuation">(</span><span class="token number">1</span>, <span class="token number">2</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="41"></td><td><pre>                        <span class="token punctuation">&#123;</span> <span class="token string">"nickname"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token string">"4611686018427387902"</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span> --<span class="token operator">>></span> <span class="token punctuation">&#123;</span> <span class="token string">"nickname"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"<span class="token variable">$maxKey</span>"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span> on <span class="token builtin class-name">:</span> myshardrs02 Timestamp<span class="token punctuation">(</span><span class="token number">1</span>, <span class="token number">3</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token punctuation">&#123;</span>  <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"config"</span>,  <span class="token string">"primary"</span> <span class="token builtin class-name">:</span> <span class="token string">"config"</span>,  <span class="token string">"partitioned"</span> <span class="token builtin class-name">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                config.system.sessions</pre></td></tr><tr><td data-num="44"></td><td><pre>                        shard key: <span class="token punctuation">&#123;</span> <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>                        unique: <span class="token boolean">false</span></pre></td></tr><tr><td data-num="46"></td><td><pre>                        balancing: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="47"></td><td><pre>                        chunks:</pre></td></tr><tr><td data-num="48"></td><td><pre>                                myshardrs01	<span class="token number">512</span></pre></td></tr><tr><td data-num="49"></td><td><pre>                                myshardrs02	<span class="token number">512</span></pre></td></tr><tr><td data-num="50"></td><td><pre>                        too many chunks to print, use verbose <span class="token keyword">if</span> you want to force print</pre></td></tr><tr><td data-num="51"></td><td><pre>mongos<span class="token operator">></span></pre></td></tr></table></figure><p>注意的是：</p><ol><li>一个集合只能指定一个片键，否则报错</li><li>一旦对一个集合分片，分片键和分片值就不可改变，如：不能给集合选择不同的分片键，不能更新分片键的值</li><li>根据 age 索引进行分配数据</li></ol><p>基于范围的分片方式与基于哈希的分片方式性能对比：</p><p>基于范围的分片方式提供了更高效的范围查询，给定一个片键的范围，分发路由可以很简单的确定哪个数据块存储了请求需要的数据，并将请求转发到相应的分片中</p><p>不过，基于范围的分片会导致数据在不同分片上的不均衡，有时候，带来的消极作用会大于查询性能的积极作用，比如，如果片键所在的字段是线性增长的，一定时间内的所有请求都会落到某个固定的数据块中，最终导致分布在同一个分片中，在这种情况下，一小部分分片承载了集群大部分的数据，系统并不能很好的进行扩展</p><p>与此相比，基于哈希的分片方式已范围查询性能的损失为代价，保证了集群中数据的均衡，哈希值的随机性使数据随机分布在每个数据块中，因此也随机分布在不同分片中，但是也正由于随机性，一个范围查询很难确定应该请求哪些分片，通常为了返回需要的结果，需要请求所有分片</p><p>如无特殊情况，一般推荐使用 Hash Sharding。</p><p>而使用_id 作为片键是一个不错的选择，因为它是必有得，你可以使用数据文档 <code>_id</code> 的哈希作为片键。</p><p>这个方案能够使读和写都能够平均分布，并且它能够保证每个文档都有不同的片键所以数据块能够很精细</p><p>似乎还是不够完美，因为这样的话对多个文档的查询必将命中所有的分片，虽说如此，这也是一种比较好的方案了。</p><p>理想化的 shard key 可以让 document 均匀的在集群分布：</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031700375.png" alt="image-20230608121323081"></p><p>显示集群的详细信息：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>mongos<span class="token operator">></span> db.printShardingStatus<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></table></figure><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>mongos<span class="token operator">></span> db.printShardingStatus<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>--- Sharding Status --- </pre></td></tr><tr><td data-num="3"></td><td><pre>  sharding version: <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  	<span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,</pre></td></tr><tr><td data-num="5"></td><td><pre>  	<span class="token string">"minCompatibleVersion"</span> <span class="token builtin class-name">:</span> <span class="token number">5</span>,</pre></td></tr><tr><td data-num="6"></td><td><pre>  	<span class="token string">"currentVersion"</span> <span class="token builtin class-name">:</span> <span class="token number">6</span>,</pre></td></tr><tr><td data-num="7"></td><td><pre>  	<span class="token string">"clusterId"</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">"64813c5c4c6469e9d2fe9269"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  shards:</pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token punctuation">&#123;</span>  <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"myshardrs01"</span>,  <span class="token string">"host"</span> <span class="token builtin class-name">:</span> <span class="token string">"myshardrs01/192.168.244.142:27018,192.168.244.142:27118"</span>,  <span class="token string">"state"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,  <span class="token string">"topologyTime"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686193851</span>, <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token punctuation">&#123;</span>  <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"myshardrs02"</span>,  <span class="token string">"host"</span> <span class="token builtin class-name">:</span> <span class="token string">"myshardrs02/192.168.244.142:27318,192.168.244.142:27418"</span>,  <span class="token string">"state"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,  <span class="token string">"topologyTime"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686194172</span>, <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  active mongoses:</pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token string">"5.0.18"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  autosplit:</pre></td></tr><tr><td data-num="15"></td><td><pre>        Currently enabled: <span class="token function">yes</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  balancer:</pre></td></tr><tr><td data-num="17"></td><td><pre>        Currently enabled: <span class="token function">yes</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        Currently running: no</pre></td></tr><tr><td data-num="19"></td><td><pre>        Failed balancer rounds <span class="token keyword">in</span> last <span class="token number">5</span> attempts: <span class="token number">0</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        Migration results <span class="token keyword">for</span> the last <span class="token number">24</span> hours: </pre></td></tr><tr><td data-num="21"></td><td><pre>                <span class="token number">512</span> <span class="token builtin class-name">:</span> Success</pre></td></tr><tr><td data-num="22"></td><td><pre>  databases:</pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token punctuation">&#123;</span>  <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"articledb"</span>,  <span class="token string">"primary"</span> <span class="token builtin class-name">:</span> <span class="token string">"myshardrs01"</span>,  <span class="token string">"partitioned"</span> <span class="token builtin class-name">:</span> true,  <span class="token string">"version"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>  <span class="token string">"uuid"</span> <span class="token builtin class-name">:</span> UUID<span class="token punctuation">(</span><span class="token string">"b94e53c7-d498-49b8-8965-1aafcab2df18"</span><span class="token punctuation">)</span>,  <span class="token string">"timestamp"</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1686193851</span>, <span class="token number">3</span><span class="token punctuation">)</span>,  <span class="token string">"lastMod"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>                articledb.author</pre></td></tr><tr><td data-num="25"></td><td><pre>                        shard key: <span class="token punctuation">&#123;</span> <span class="token string">"age"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>                        unique: <span class="token boolean">false</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                        balancing: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="28"></td><td><pre>                        chunks:</pre></td></tr><tr><td data-num="29"></td><td><pre>                                myshardrs01	<span class="token number">1</span></pre></td></tr><tr><td data-num="30"></td><td><pre>                        <span class="token punctuation">&#123;</span> <span class="token string">"age"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"<span class="token variable">$minKey</span>"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span> --<span class="token operator">>></span> <span class="token punctuation">&#123;</span> <span class="token string">"age"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"<span class="token variable">$maxKey</span>"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span> on <span class="token builtin class-name">:</span> myshardrs01 Timestamp<span class="token punctuation">(</span><span class="token number">1</span>, <span class="token number">0</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="31"></td><td><pre>                articledb.comment</pre></td></tr><tr><td data-num="32"></td><td><pre>                        shard key: <span class="token punctuation">&#123;</span> <span class="token string">"nickname"</span> <span class="token builtin class-name">:</span> <span class="token string">"hashed"</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>                        unique: <span class="token boolean">false</span></pre></td></tr><tr><td data-num="34"></td><td><pre>                        balancing: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="35"></td><td><pre>                        chunks:</pre></td></tr><tr><td data-num="36"></td><td><pre>                                myshardrs01	<span class="token number">2</span></pre></td></tr><tr><td data-num="37"></td><td><pre>                                myshardrs02	<span class="token number">2</span></pre></td></tr><tr><td data-num="38"></td><td><pre>                        <span class="token punctuation">&#123;</span> <span class="token string">"nickname"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"<span class="token variable">$minKey</span>"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span> --<span class="token operator">>></span> <span class="token punctuation">&#123;</span> <span class="token string">"nickname"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token string">"-4611686018427387902"</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span> on <span class="token builtin class-name">:</span> myshardrs01 Timestamp<span class="token punctuation">(</span><span class="token number">1</span>, <span class="token number">0</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="39"></td><td><pre>                        <span class="token punctuation">&#123;</span> <span class="token string">"nickname"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token string">"-4611686018427387902"</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span> --<span class="token operator">>></span> <span class="token punctuation">&#123;</span> <span class="token string">"nickname"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span> on <span class="token builtin class-name">:</span> myshardrs01 Timestamp<span class="token punctuation">(</span><span class="token number">1</span>, <span class="token number">1</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="40"></td><td><pre>                        <span class="token punctuation">&#123;</span> <span class="token string">"nickname"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span> --<span class="token operator">>></span> <span class="token punctuation">&#123;</span> <span class="token string">"nickname"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token string">"4611686018427387902"</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span> on <span class="token builtin class-name">:</span> myshardrs02 Timestamp<span class="token punctuation">(</span><span class="token number">1</span>, <span class="token number">2</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="41"></td><td><pre>                        <span class="token punctuation">&#123;</span> <span class="token string">"nickname"</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token string">"4611686018427387902"</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span> --<span class="token operator">>></span> <span class="token punctuation">&#123;</span> <span class="token string">"nickname"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"<span class="token variable">$maxKey</span>"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span> on <span class="token builtin class-name">:</span> myshardrs02 Timestamp<span class="token punctuation">(</span><span class="token number">1</span>, <span class="token number">3</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token punctuation">&#123;</span>  <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"config"</span>,  <span class="token string">"primary"</span> <span class="token builtin class-name">:</span> <span class="token string">"config"</span>,  <span class="token string">"partitioned"</span> <span class="token builtin class-name">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                config.system.sessions</pre></td></tr><tr><td data-num="44"></td><td><pre>                        shard key: <span class="token punctuation">&#123;</span> <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>                        unique: <span class="token boolean">false</span></pre></td></tr><tr><td data-num="46"></td><td><pre>                        balancing: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="47"></td><td><pre>                        chunks:</pre></td></tr><tr><td data-num="48"></td><td><pre>                                myshardrs01	<span class="token number">512</span></pre></td></tr><tr><td data-num="49"></td><td><pre>                                myshardrs02	<span class="token number">512</span></pre></td></tr><tr><td data-num="50"></td><td><pre>                        too many chunks to print, use verbose <span class="token keyword">if</span> you want to force print</pre></td></tr><tr><td data-num="51"></td><td><pre>mongos<span class="token operator">></span></pre></td></tr></table></figure><p>查看均衡器是否工作 (需要重新均衡时系统才会自动启动，不用管它)：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>mongos<span class="token operator">></span> sh.isBalancerRunning<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token boolean">false</span></pre></td></tr><tr><td data-num="3"></td><td><pre>mongos<span class="token operator">></span></pre></td></tr></table></figure><p>查看当前 Balancer 状态：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>mongos<span class="token operator">></span> sh.getBalancerState<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token boolean">true</span></pre></td></tr><tr><td data-num="3"></td><td><pre>mongos<span class="token operator">></span></pre></td></tr></table></figure><h3 id="分片后插入数据测试"><a class="anchor" href="#分片后插入数据测试">#</a> 分片后插入数据测试</h3><p>测试一 (哈希规则)：登录 mongos 后，向 comment 循环插入 1000 条数据做测试：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>mongos<span class="token operator">></span> use articledb</pre></td></tr><tr><td data-num="2"></td><td><pre>switched to db articledb</pre></td></tr><tr><td data-num="3"></td><td><pre>mongos<span class="token operator">></span> db</pre></td></tr><tr><td data-num="4"></td><td><pre>articledb</pre></td></tr><tr><td data-num="5"></td><td><pre>mongos<span class="token operator">></span> for<span class="token punctuation">(</span>let <span class="token assign-left variable">i</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;=</span><span class="token number">1000</span><span class="token punctuation">;</span>i++<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>db.comment.insert<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"_id"</span>:i+<span class="token string">""</span>,<span class="token string">"nickname"</span><span class="token builtin class-name">:</span><span class="token string">"BoBo"</span>+i<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>WriteResult<span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token string">"nInserted"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>mongos<span class="token operator">></span> db.comment.count<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token number">1000</span></pre></td></tr><tr><td data-num="9"></td><td><pre>mongos<span class="token operator">></span></pre></td></tr></table></figure><p>提示：js 的语法，因为 mongo 的 shell 是一个 javaScript 的 shell</p><p>注意：从路由上插入的数据，必须包含片键，否则无法插入</p><p>分别登陆两个片的主节点，统计文档数量</p><p>第一个分片副本集：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>myshardrs01:PRIMARY<span class="token operator">></span> db</pre></td></tr><tr><td data-num="2"></td><td><pre>articledb</pre></td></tr><tr><td data-num="3"></td><td><pre>myshardrs01:PRIMARY<span class="token operator">></span> db.comment.count<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">507</span></pre></td></tr><tr><td data-num="5"></td><td><pre>myshardrs01:PRIMARY<span class="token operator">></span></pre></td></tr></table></figure><p>第二个分片副本集：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>myshardrs02:PRIMARY<span class="token operator">></span> use articledb</pre></td></tr><tr><td data-num="2"></td><td><pre>switched to db articledb</pre></td></tr><tr><td data-num="3"></td><td><pre>myshardrs02:PRIMARY<span class="token operator">></span> db</pre></td></tr><tr><td data-num="4"></td><td><pre>articledb</pre></td></tr><tr><td data-num="5"></td><td><pre>myshardrs02:PRIMARY<span class="token operator">></span> db.comment.count<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token number">493</span></pre></td></tr><tr><td data-num="7"></td><td><pre>myshardrs02:PRIMARY<span class="token operator">></span></pre></td></tr></table></figure><p>可以看到，1000 条数据近似均匀的分不到了 2 个 shard 上，是根据片键的哈希值分配的。</p><p>这种分配方式非常易于水平扩展：一旦数据存储需要更大空间，可以直接再增加分片即可，同时提升了性能使用 db.comment.stats () 查看单个集合的完整情况，mongos 执行该命令可以查看该集合的数据分片的情况。</p><p>使用 sh.status () 查看本库内所有集合的分片信息。</p><hr><p>测试二 (值范围规则)：登录 mongos 后，向 comment 循环插入 1000 条数据做测试：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>mongos<span class="token operator">></span> db</pre></td></tr><tr><td data-num="2"></td><td><pre>articledb</pre></td></tr><tr><td data-num="3"></td><td><pre>mongos<span class="token operator">></span> for<span class="token punctuation">(</span>let <span class="token assign-left variable">i</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;=</span><span class="token number">2000</span><span class="token punctuation">;</span>i++<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>db.author.save<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"BoBoBo"</span>+i,<span class="token string">"age"</span>:NumberInt<span class="token punctuation">(</span>i%120<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>WriteResult<span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token string">"nInserted"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>mongos<span class="token operator">></span> db.author.count<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token number">2000</span></pre></td></tr><tr><td data-num="7"></td><td><pre>mongos<span class="token operator">></span></pre></td></tr></table></figure><p>插入成功后，仍然要分别查看两个分片副本集的数据情况。</p><p>分片效果：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>articledb.author</pre></td></tr><tr><td data-num="2"></td><td><pre>                        shard key: <span class="token punctuation">&#123;</span> <span class="token string">"age"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                        unique: <span class="token boolean">false</span></pre></td></tr><tr><td data-num="4"></td><td><pre>                        balancing: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="5"></td><td><pre>                        chunks:</pre></td></tr><tr><td data-num="6"></td><td><pre>                                myshardrs01	<span class="token number">1</span></pre></td></tr><tr><td data-num="7"></td><td><pre>                        <span class="token punctuation">&#123;</span> <span class="token string">"age"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"<span class="token variable">$minKey</span>"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span> --<span class="token operator">>></span> <span class="token punctuation">&#123;</span> <span class="token string">"age"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"<span class="token variable">$maxKey</span>"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span> on <span class="token builtin class-name">:</span> myshardrs01 Timestamp<span class="token punctuation">(</span><span class="token number">1</span>, <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>提示：</p><p>如果查看状态发现没有分片，则可能是由于以下原因造成了：</p><ol><li><p>系统繁忙，正在分片中。</p></li><li><p>数据块 (chunk) 没有填满，默认的数据块尺寸 (chunksize) 是 64M，填满后才会考虑向其它片的数据块填充数据，因此，为了测试，可以将其改小，这里改为 1M，操作如下：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>mongos<span class="token operator">></span> use config</pre></td></tr><tr><td data-num="2"></td><td><pre>switched to db config</pre></td></tr><tr><td data-num="3"></td><td><pre>mongos<span class="token operator">></span> db</pre></td></tr><tr><td data-num="4"></td><td><pre>config</pre></td></tr><tr><td data-num="5"></td><td><pre>mongos<span class="token operator">></span> db.settings.save<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>_id:<span class="token string">"chunksize"</span>,value:1<span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>WriteResult<span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token string">"nMatched"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>, <span class="token string">"nUpserted"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>, <span class="token string">"nModified"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>, <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"chunksize"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>mongos<span class="token operator">></span></pre></td></tr></table></figure><p>测试完改回来：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>mongos<span class="token operator">></span> db.settings.save<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>_id:<span class="token string">"chunksize"</span>,value:64<span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>注意：要先改小，再设置分片，为了测试，可以先删除集合，重新建立集合的分片策略，再插入数据测试即可。</p></li></ol><h3 id="再增加一个路由节点"><a class="anchor" href="#再增加一个路由节点">#</a> 再增加一个路由节点</h3><p>目录:</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>➜  ~ <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /mongodb/sharded_cluster/myshardrs_27117/log</pre></td></tr></table></figure><p>新建或修改配置文件：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>➜  ~ <span class="token function">vim</span> /mongodb/sharded_cluster/myshardrs_27117/mongos.conf</pre></td></tr></table></figure><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>systemLog:</pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token comment">#MongoDB 发送所有日志输出的目标指定为文件</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token comment">#The path of the log file to which mongod or mongos should send all diagnostic logging information</span></pre></td></tr><tr><td data-num="4"></td><td><pre> destination: <span class="token function">file</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token comment">#mongod 或 mongos 应向其发送所有诊断日志记录信息的日志文件的路径</span></pre></td></tr><tr><td data-num="6"></td><td><pre> path: <span class="token string">"/mongodb/sharded_cluster/myshardrs_27117/log/mongod.log"</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token comment">#当 mongos 或 mongod 实例重新启动时，mongos 或 mongod 会将新条目附加到现有日志文件的末尾。</span></pre></td></tr><tr><td data-num="8"></td><td><pre> logAppend: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="9"></td><td><pre>processManagement:</pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token comment">#启用在后台运行 mongos 或 mongod 进程的守护进程模式。</span></pre></td></tr><tr><td data-num="11"></td><td><pre> fork: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token comment">#指定用于保存 mongos 或 mongod 进程的进行 ID 的文件位置，其中 mongos 或 mongod 将写入其 PID</span></pre></td></tr><tr><td data-num="13"></td><td><pre> pidFilePath: <span class="token string">"/mongodb/sharded_cluster/myshardrs_27117/log/mongod.pid"</span></pre></td></tr><tr><td data-num="14"></td><td><pre>net:</pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token comment">#服务实例绑定 IP，默认是 localhost</span></pre></td></tr><tr><td data-num="16"></td><td><pre> bindIp: localhost,192.168.244.142</pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token comment">#bindIp</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token comment">#绑定的端口，默认是 27017</span></pre></td></tr><tr><td data-num="19"></td><td><pre> port: <span class="token number">27117</span></pre></td></tr><tr><td data-num="20"></td><td><pre>sharding:</pre></td></tr><tr><td data-num="21"></td><td><pre> <span class="token comment">#指定配置节点副本集</span></pre></td></tr><tr><td data-num="22"></td><td><pre> <span class="token comment">#        副本集名称 / 主机地址与端口号</span></pre></td></tr><tr><td data-num="23"></td><td><pre> configDB: myconfigrs/192.168.244.142:27019,192.168.244.142:27119,192.168.244.142:27219</pre></td></tr></table></figure><p>启动 mongos2：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>➜  ~ /usr/local/mongodb/bin/mongos <span class="token parameter variable">-f</span> /mongodb/sharded_cluster/myshardrs_27117/mongos.conf </pre></td></tr><tr><td data-num="2"></td><td><pre>about to fork child process, waiting <span class="token keyword">until</span> server is ready <span class="token keyword">for</span> connections.</pre></td></tr><tr><td data-num="3"></td><td><pre>forked process: <span class="token number">27750</span></pre></td></tr><tr><td data-num="4"></td><td><pre>child process started successfully, parent exiting</pre></td></tr><tr><td data-num="5"></td><td><pre>➜  ~</pre></td></tr></table></figure><p>使用 Mongo 客户端登录 27117，发现，第二个路由无需配置，因为分片配置都保存到了配置服务器中了</p><h2 id="compass连接分片集群"><a class="anchor" href="#compass连接分片集群">#</a> Compass 连接分片集群</h2><p>直接连接路由</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031700753.png" alt="image-20230608143006151"></p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031700972.png" alt="image-20230608143031512"></p><h2 id="springdatamongodb连接分片集群"><a class="anchor" href="#springdatamongodb连接分片集群">#</a> SpringDataMongoDB 连接分片集群</h2><p>Java 客户端常用的是 SpringDataMongoDB，其连接的是 mongos 路由，配置和单机 mongod 的配置是一样的。</p><p>多个路由的时候的 SpringDataMongoDB 的客户端配置参考如下：</p><p>直接连接路由节点即可</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">server</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">spring</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token comment">#数据源配置</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">data</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token key atrule">mongodb</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token comment">#主机地址</span></pre></td></tr><tr><td data-num="8"></td><td><pre>      <span class="token comment">#host: 192.168.244.142</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token comment">#数据库</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token comment">#database: articledb</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token comment">#端口号</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token comment">#port: 27017</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token comment">#也可以使用 uri 连接</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token comment">#uri: mongodb://192.168.244.142:27017/articledb</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token comment">#副本集的连接字符串</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token comment">#uri:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token comment">#mongodb://192.168.244.142:27017,192.168.244.142:27018,192.168.244.142:27019/articledb?</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token comment">#connect=replicaSet&amp;secondaryOk=true&amp;replicaSet=myrs</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      <span class="token comment">#连接路由字符串</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token key atrule">uri</span><span class="token punctuation">:</span> mongodb<span class="token punctuation">:</span>//192.168.244.142<span class="token punctuation">:</span><span class="token number">27017</span><span class="token punctuation">,</span>192.168.244.142<span class="token punctuation">:</span>27117/articledb</pre></td></tr></table></figure><p>通过日志发现，写入数据的时候，会选择一个路由写入：</p><h2 id="安全认证"><a class="anchor" href="#安全认证">#</a> 安全认证</h2><h3 id="mongodb的用户和角色权限简介"><a class="anchor" href="#mongodb的用户和角色权限简介">#</a> MongoDB 的用户和角色权限简介</h3><p>默认情况下，MongoDB 实例启动运行时是没有启用用户访问权限控制的，也就是说，在实例本机服务器上都可以随意连接到实例进行各种操作，MongoDB 不会对连接客户端进行用户验证，这是非常危险的。</p><p>mongoDB 官网上说，为了能保障 mongodb 的安全可以做以下几个步骤：</p><ol><li>使用新的端口，默认的 27017 端口如果一旦知道了 ip 就能连接上，不太安全</li><li>设置 mongodb 的网络环境，最好将 mongodb 部署到公司服务器内网，这样外网是访问不到的，公司内部访问使用 vpn 等</li><li>开启安全认证，认证要同时设置服务器之间的内部认证方式，同时要设置客户端连接到集群的账号密码认证方式</li></ol><p>为了强制开启用户访问控制 (用户验证)，则需要在 MongoDB 实例启动时使用选项 --auth 或在指定启动配置文件中添加选项 auth=true</p><p>在开始之前需要了解一下概念</p><ol><li>启用访问控制：</li></ol><p>MongoDB 使用的是基于角色的访问控制 (Role-Based Access Control,RBAC) 来管理用户対实例的访问，通过对用户授予一个或多个角色来控制用户访问数据库资源的权限和数据库操作的权限，在对用户分配角色之前，用户无法访问实例。</p><p>在实例启动时添加选项 --auth 或指定启动配置文件中添加选项 auth=true</p><ol start="2"><li>角色：</li></ol><p>在 MongoDB 中通过角色对用户授予相应数据库资源的操作权限，每个角色当中的权限可以显式指定，也可以通过继承其它角色的权限，或者两都存在的权限</p><ol start="3"><li>权限：</li></ol><p>权限由指定的数据库资源 (resource) 以及允许在指定资源上进行的操作 (action) 组成。</p><ol><li>资源 (resource) 包括：数据库，集合，部分集合和集群；</li><li>操作 (action) 包括：对资源进行的增，删，改，查 (CRUD) 操作。</li></ol><p>在角色定义时可以包含一个或多个已存在的角色，新创建的角色会继承包含的角色所有的权限，在同一个数据库中，新创建角色可以继承其它角色的权限，在 admin 数据库中创建的角色可以继承在其它任意数据库中角色的权限。</p><p>关于角色权限的查看，可以通过如下命令查询：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#查询所有角色权限 (仅用户自定义角色)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token operator">></span> db.runCommand<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>rolesInfo:1<span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">#查询所有用户角色权限 (包含内置角色)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token operator">></span> db.runCommand<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>rolesInfo:1,showBuiltinRoles:true<span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">#查询当前数据库中的某角色的权限</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token operator">></span> db.runCommand<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>rolesInfo:<span class="token string">"&lt;rolename>"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">#查询其它数据库中指定的角色权限</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token operator">></span> db.runCommand<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>rolesInfo:<span class="token punctuation">&#123;</span>role:<span class="token string">"&lt;rolename>"</span>,db:<span class="token string">"&lt;database>"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">#查询多个角色权限</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token operator">></span> db.runCommand<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>rolesInfo:<span class="token punctuation">[</span><span class="token string">"rolename"</span>,<span class="token punctuation">&#123;</span>role:<span class="token string">"&lt;rolename>"</span>,db:<span class="token string">"database"</span><span class="token punctuation">&#125;</span>,<span class="token punctuation">..</span>.<span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>常用的内置角色：</p><ul><li>数据库用户角色：read，readWrite；</li><li>所有数据库用户角色：readAnyDatabase，readWriteAnyDatabase，userAdminAnyDatabase，dbAdminAnyDatabase</li><li>数据库管理角色：dbAdmin，dbOwner，userAdmin；</li><li>集群管理角色：clusterAdmin，clusterManager，clusterMonitor，hostManager；</li><li>备份恢复角色：backup，restore；</li><li>超级用户角色：root</li><li>内部角色：system</li></ul><p>角色说明：</p><table><thead><tr><th>角色</th><th>权限描述</th></tr></thead><tbody><tr><td>read</td><td>可以读取指定数据库中任何数据</td></tr><tr><td>readWrite</td><td>可以读写指定数据库中任何数据，包括创建，重命名，删除集合</td></tr><tr><td>readAnyDatabase</td><td>可以读取所有数据库中任何数据 (除了数据库 config 和 loacl 之外)</td></tr><tr><td>readWriteAnyDatabase</td><td>可以读写所有数据库中任何数据 (除了数据库 config 和 local 之外)</td></tr><tr><td>userAdminAnyDatabase</td><td>可以在指定数据库创建和修改用户 (除了数据库 config 和 local 之外)</td></tr><tr><td>dbAdminAnyDatabase</td><td>可以读取任何数据库以及对数据库进行清理，修改，压缩，获取统计信息，执行检查等操作 (除了数据库 config 和 local 之外)</td></tr><tr><td>dbAdmin</td><td>可以读取指定数据库以及对数据库进行清理，修怪，压缩，获取统计信息，执行检查等操作。</td></tr><tr><td>userAdmin</td><td>可以在指定数据库创建和修改用户</td></tr><tr><td>clusterAdmin</td><td>可以对整个集群或数据库系统进行管理操作</td></tr><tr><td>backup</td><td>备份 MongoDB 数据最小的权限</td></tr><tr><td>restore</td><td>从备份文件中还原恢复 MongoDB 数据 (除了 system.profile 集合) 的权限。</td></tr><tr><td>root</td><td>超级账号，超级权限</td></tr></tbody></table><h2 id="单实例环境"><a class="anchor" href="#单实例环境">#</a> 单实例环境</h2><p>目标：对单实例的 MongoDB 服务开启安全认证，这里的单实例指定是未开启副本集或分片的 MongoDB 实例。</p><h3 id="关闭已开启的服务可选"><a class="anchor" href="#关闭已开启的服务可选">#</a> 关闭已开启的服务 (可选)</h3><p>增加 mongod 的单实例的安全认证功能，可以在服务搭建的时候直接添加，也可以在之前搭建好的服务上添加。</p><p>本文使用之前搭建好的服务，因此，先停止之前的服务</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>➜  ~ <span class="token function">ps</span> -ef<span class="token operator">|</span><span class="token function">grep</span> mongod<span class="token operator">|</span><span class="token function">grep</span> <span class="token parameter variable">-v</span> <span class="token function">grep</span></pre></td></tr><tr><td data-num="2"></td><td><pre>dkx0       <span class="token number">2291</span>      <span class="token number">1</span>  <span class="token number">2</span> Jun07 ?        00:09:22 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/sharded_cluster/myshardrs01_27018/mongod.conf</pre></td></tr><tr><td data-num="3"></td><td><pre>dkx0       <span class="token number">2368</span>      <span class="token number">1</span>  <span class="token number">2</span> Jun07 ?        00:09:19 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/sharded_cluster/myshardrs01_27118/mongod.conf</pre></td></tr><tr><td data-num="4"></td><td><pre>dkx0       <span class="token number">2443</span>      <span class="token number">1</span>  <span class="token number">1</span> Jun07 ?        00:05:27 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/sharded_cluster/myshardrs01_27218/mongod.conf</pre></td></tr><tr><td data-num="5"></td><td><pre>dkx0       <span class="token number">5200</span>      <span class="token number">1</span>  <span class="token number">2</span> Jun07 ?        00:07:06 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/sharded_cluster/myshardrs01_27318/mongod.conf</pre></td></tr><tr><td data-num="6"></td><td><pre>dkx0       <span class="token number">5268</span>      <span class="token number">1</span>  <span class="token number">1</span> Jun07 ?        00:06:37 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/sharded_cluster/myshardrs01_27418/mongod.conf</pre></td></tr><tr><td data-num="7"></td><td><pre>dkx0       <span class="token number">5337</span>      <span class="token number">1</span>  <span class="token number">1</span> Jun07 ?        00:04:25 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/sharded_cluster/myshardrs01_27518/mongod.conf</pre></td></tr><tr><td data-num="8"></td><td><pre>dkx0       <span class="token number">7659</span>      <span class="token number">1</span>  <span class="token number">3</span> Jun07 ?        00:09:26 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/sharded_cluster/myshardrs01_27019/mongod.conf</pre></td></tr><tr><td data-num="9"></td><td><pre>dkx0       <span class="token number">7736</span>      <span class="token number">1</span>  <span class="token number">2</span> Jun07 ?        00:08:15 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/sharded_cluster/myshardrs01_27119/mongod.conf</pre></td></tr><tr><td data-num="10"></td><td><pre>dkx0       <span class="token number">7808</span>      <span class="token number">1</span>  <span class="token number">2</span> Jun07 ?        00:08:11 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/sharded_cluster/myshardrs01_27219/mongod.conf</pre></td></tr><tr><td data-num="11"></td><td><pre>dkx0      <span class="token number">10092</span>      <span class="token number">1</span>  <span class="token number">0</span> Jun07 ?        00:02:23 /usr/local/mongodb/bin/mongos <span class="token parameter variable">-f</span> /mongodb/sharded_cluster/myshardrs_27017/mongos.conf</pre></td></tr><tr><td data-num="12"></td><td><pre>dkx0      <span class="token number">27750</span>      <span class="token number">1</span>  <span class="token number">0</span> 02:22 ?        00:00:31 /usr/local/mongodb/bin/mongos <span class="token parameter variable">-f</span> /mongodb/sharded_cluster/myshardrs_27117/mongos.conf</pre></td></tr><tr><td data-num="13"></td><td><pre>➜  ~</pre></td></tr></table></figure><p>停止服务的方式有两种：快速关闭和标准关闭，下面依次说明：</p><ol><li>快速关闭方式 (快速，简单，数据可能会出错)</li></ol><p>目标：通过系统的 kill 命令直接杀死进程：</p><p>杀完要检查一下，避免有的没有杀掉。</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#通过进程编号关闭节点</span></pre></td></tr><tr><td data-num="2"></td><td><pre>➜  ~ <span class="token function">kill</span> <span class="token parameter variable">-2</span> <span class="token number">2291</span> <span class="token number">2368</span> <span class="token number">2443</span> <span class="token number">5200</span> <span class="token number">5268</span> <span class="token number">5337</span> <span class="token number">7659</span> <span class="token number">7736</span> <span class="token number">7808</span> <span class="token number">10092</span> <span class="token number">27750</span></pre></td></tr><tr><td data-num="3"></td><td><pre>➜  ~ <span class="token function">ps</span> -ef<span class="token operator">|</span><span class="token function">grep</span> mongod<span class="token operator">|</span><span class="token function">grep</span> <span class="token parameter variable">-v</span> <span class="token function">grep</span></pre></td></tr><tr><td data-num="4"></td><td><pre>➜  ~</pre></td></tr></table></figure><p>[补充]</p><p>如果一旦是因为数据损坏，则需要进行如下操作：</p><ol><li><p>删除 lock 文件：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">rm</span> <span class="token parameter variable">-f</span> /mongodb/single/data/db/*.lock</pre></td></tr></table></figure></li><li><p>修复数据：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>/usr/local/mongodb/bin/mongod <span class="token parameter variable">--repair</span> <span class="token parameter variable">--dbpath</span><span class="token operator">=</span>/mongodb/single/data/db</pre></td></tr></table></figure><p>2. 标准的关闭方法 (数据不容易出错，但是麻烦)</p><p>目标：通过 mongo 客户端中的 shutdownServer 命令来关闭服务</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">></span> db.shutdownServer<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></table></figure></li></ol><h3 id="添加用户和权限"><a class="anchor" href="#添加用户和权限">#</a> 添加用户和权限</h3><p>​ 1. 先按照普通无授权认证的配置，来配置服务端的配置文件 /mongodb/single/mongod.conf：(参考，复用之前的)</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>systemLog:</pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token comment">#MongoDB 发送所有日志输出的目标指定为文件</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token comment">#The path of the log file to which mongod or mongos should send all diagnostic logging information</span></pre></td></tr><tr><td data-num="4"></td><td><pre> destination: <span class="token function">file</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token comment">#mongod 或 mongos 应向其发送所有诊断日志记录信息的日志文件的路径</span></pre></td></tr><tr><td data-num="6"></td><td><pre> path: <span class="token string">"/mongodb/single/log/mongod.log"</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token comment">#当 mongos 或 mongod 实例重新启动时，mongos 或 mongod 会将新条目附加到现有日志文件的末尾。</span></pre></td></tr><tr><td data-num="8"></td><td><pre> logAppend: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="9"></td><td><pre>storage:</pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token comment">#mongod 实例存储其数据的目录。storage.dbPath 设置仅适用于 mongod。</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token comment">#The directory where the mongod instance stores its data.Defaul value is "/data/db"</span></pre></td></tr><tr><td data-num="12"></td><td><pre> dbPath: <span class="token string">"/mongodb/single/data/db"</span></pre></td></tr><tr><td data-num="13"></td><td><pre> journal:</pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token comment">#启用或禁用持久性日志以确保数据文件保持有效和可恢复</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  enabled: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="16"></td><td><pre>processManagement:</pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token comment">#启用在后台运行 mongos 或 mongod 进程的守护进程模式。</span></pre></td></tr><tr><td data-num="18"></td><td><pre> fork: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="19"></td><td><pre>net:</pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token comment">#服务实例绑定 IP，默认是 localhost</span></pre></td></tr><tr><td data-num="21"></td><td><pre> bindIp: localhost,192.168.244.142</pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token comment">#bindIp</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token comment">#绑定的端口，默认是 27017</span></pre></td></tr><tr><td data-num="24"></td><td><pre> port: <span class="token number">27017</span></pre></td></tr></table></figure><p>2. 按之前为开启认证的方式 (不添加 --auth 参数) 来启动 MongoDB 服务：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>➜  ~ /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/single/log/mongod.conf </pre></td></tr><tr><td data-num="2"></td><td><pre>about to fork child process, waiting <span class="token keyword">until</span> server is ready <span class="token keyword">for</span> connections.</pre></td></tr><tr><td data-num="3"></td><td><pre>forked process: <span class="token number">34342</span></pre></td></tr><tr><td data-num="4"></td><td><pre>child process started successfully, parent exiting</pre></td></tr><tr><td data-num="5"></td><td><pre>➜  ~</pre></td></tr></table></figure><p>提示：</p><p>在操作用户时，启动 mongod 服务时尽量不要开启授权</p><p>3. 使用 Mongo 客户端登录：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>➜  ~ /usr/local/mongodb/bin/mongo <span class="token parameter variable">--host</span><span class="token operator">=</span><span class="token number">192.168</span>.244.142 <span class="token parameter variable">--port</span><span class="token operator">=</span><span class="token number">27017</span></pre></td></tr></table></figure><p>4. 创建两个管理员用户，一个是系统的超级管理员 myroot，一个是 admin 库的管理用户 myadmin：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#切换到 admin 库</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token operator">></span> use admin</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">#创建系统超级用户 myroot，设置密码 123456，设置角色 root</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token operator">></span> db.createUser<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>user:<span class="token string">"myroot"</span>,pwd:<span class="token string">"123456"</span>,roles:<span class="token punctuation">[</span><span class="token punctuation">&#123;</span><span class="token string">"role"</span><span class="token builtin class-name">:</span><span class="token string">"root"</span>,<span class="token string">"db"</span><span class="token builtin class-name">:</span><span class="token string">"admin"</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">#或 上面指定了集合下面默认是当前所在集合都是 admin</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token operator">></span> db.createUser<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>user:<span class="token string">"myroot"</span>,pwd:<span class="token string">"123456"</span>,roles:<span class="token punctuation">[</span><span class="token string">"root"</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>Successfully added user: <span class="token punctuation">&#123;</span> <span class="token string">"user"</span> <span class="token builtin class-name">:</span> <span class="token string">"myroot"</span>, <span class="token string">"roles"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span> <span class="token string">"root"</span> <span class="token punctuation">]</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment">#创建专门用来管理 admin 库的账号 myadmin，只用来作为用户权限的管理</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token operator">></span> db.createUser<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>user:<span class="token string">"myadmin"</span>,pwd:<span class="token string">"123456"</span>,roles:<span class="token punctuation">[</span><span class="token punctuation">&#123;</span>role:<span class="token string">"userAdminAnyDatabase"</span>,db:<span class="token string">"admin"</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>Successfully added user: <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>	<span class="token string">"user"</span> <span class="token builtin class-name">:</span> <span class="token string">"myadmin"</span>,</pre></td></tr><tr><td data-num="12"></td><td><pre>	<span class="token string">"roles"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="13"></td><td><pre>		<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>			<span class="token string">"role"</span> <span class="token builtin class-name">:</span> <span class="token string">"userAdminAnyDatabase"</span>,</pre></td></tr><tr><td data-num="15"></td><td><pre>			<span class="token string">"db"</span> <span class="token builtin class-name">:</span> <span class="token string">"admin"</span></pre></td></tr><tr><td data-num="16"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>	<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token operator">></span> </pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment">#查看已经创建了的用户的情况：</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token operator">></span> db.system.users.<span class="token function-name function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">&#123;</span> <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"admin.myroot"</span>, <span class="token string">"userId"</span> <span class="token builtin class-name">:</span> UUID<span class="token punctuation">(</span><span class="token string">"9ecafd01-cef1-43a4-85ad-4ec21e905f81"</span><span class="token punctuation">)</span>, <span class="token string">"user"</span> <span class="token builtin class-name">:</span> <span class="token string">"myroot"</span>, <span class="token string">"db"</span> <span class="token builtin class-name">:</span> <span class="token string">"admin"</span>, <span class="token string">"credentials"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"SCRAM-SHA-1"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"iterationCount"</span> <span class="token builtin class-name">:</span> <span class="token number">10000</span>, <span class="token string">"salt"</span> <span class="token builtin class-name">:</span> <span class="token string">"LefHopC8WY3knLfOVz56iw=="</span>, <span class="token string">"storedKey"</span> <span class="token builtin class-name">:</span> <span class="token string">"fFDpj6y1AZCw60aOTM8fBXzUwBc="</span>, <span class="token string">"serverKey"</span> <span class="token builtin class-name">:</span> <span class="token string">"YvTH+hyBHN1XThjYnrotc57/hgs="</span> <span class="token punctuation">&#125;</span>, <span class="token string">"SCRAM-SHA-256"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"iterationCount"</span> <span class="token builtin class-name">:</span> <span class="token number">15000</span>, <span class="token string">"salt"</span> <span class="token builtin class-name">:</span> <span class="token string">"35I31t2xZ5NIK0wrw0LZajRGtnY8B8YLwjHfgg=="</span>, <span class="token string">"storedKey"</span> <span class="token builtin class-name">:</span> <span class="token string">"iy3/8WvkxrNDcKPJmFQ7rTAXxNvzDtjK7uMxzUkhgJ4="</span>, <span class="token string">"serverKey"</span> <span class="token builtin class-name">:</span> <span class="token string">"V8Nhn6pBt50M5UsUNBNDGfaOU23f+CLYcYLnxBRTRy0="</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>, <span class="token string">"roles"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span> <span class="token punctuation">&#123;</span> <span class="token string">"role"</span> <span class="token builtin class-name">:</span> <span class="token string">"root"</span>, <span class="token string">"db"</span> <span class="token builtin class-name">:</span> <span class="token string">"admin"</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">]</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">&#123;</span> <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"admin.myadmin"</span>, <span class="token string">"userId"</span> <span class="token builtin class-name">:</span> UUID<span class="token punctuation">(</span><span class="token string">"c8145c3a-b1a1-4be2-a226-39e067cbe9b0"</span><span class="token punctuation">)</span>, <span class="token string">"user"</span> <span class="token builtin class-name">:</span> <span class="token string">"myadmin"</span>, <span class="token string">"db"</span> <span class="token builtin class-name">:</span> <span class="token string">"admin"</span>, <span class="token string">"credentials"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"SCRAM-SHA-1"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"iterationCount"</span> <span class="token builtin class-name">:</span> <span class="token number">10000</span>, <span class="token string">"salt"</span> <span class="token builtin class-name">:</span> <span class="token string">"Gc9gasfekYv2F9njhAd/Sg=="</span>, <span class="token string">"storedKey"</span> <span class="token builtin class-name">:</span> <span class="token string">"vy3mzY/oer2ONiUO8nV0DRrLwUg="</span>, <span class="token string">"serverKey"</span> <span class="token builtin class-name">:</span> <span class="token string">"oVgCRHfLt/HW4PslM3QCghvVHZ4="</span> <span class="token punctuation">&#125;</span>, <span class="token string">"SCRAM-SHA-256"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"iterationCount"</span> <span class="token builtin class-name">:</span> <span class="token number">15000</span>, <span class="token string">"salt"</span> <span class="token builtin class-name">:</span> <span class="token string">"vXE6XCPtMv2ErDmXM/21KlbiTlEQEQ89rmcIgQ=="</span>, <span class="token string">"storedKey"</span> <span class="token builtin class-name">:</span> <span class="token string">"MexKD1eAYxvws8ANYtvNPdDZajNTAjfJphlIDtvPn80="</span>, <span class="token string">"serverKey"</span> <span class="token builtin class-name">:</span> <span class="token string">"Zzp84uYSusKlbNoMmTi/rPvskHl531RQDjQIjcdDGkY="</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>, <span class="token string">"roles"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span> <span class="token punctuation">&#123;</span> <span class="token string">"role"</span> <span class="token builtin class-name">:</span> <span class="token string">"userAdminAnyDatabase"</span>, <span class="token string">"db"</span> <span class="token builtin class-name">:</span> <span class="token string">"admin"</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">]</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token operator">></span> </pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment">#删除用户</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token operator">></span> db.dropUser<span class="token punctuation">(</span><span class="token string">"myadmin"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token boolean">true</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token operator">></span> db.system.users.<span class="token function-name function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token punctuation">&#123;</span> <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"admin.myroot"</span>, <span class="token string">"userId"</span> <span class="token builtin class-name">:</span> UUID<span class="token punctuation">(</span><span class="token string">"9ecafd01-cef1-43a4-85ad-4ec21e905f81"</span><span class="token punctuation">)</span>, <span class="token string">"user"</span> <span class="token builtin class-name">:</span> <span class="token string">"myroot"</span>, <span class="token string">"db"</span> <span class="token builtin class-name">:</span> <span class="token string">"admin"</span>, <span class="token string">"credentials"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"SCRAM-SHA-1"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"iterationCount"</span> <span class="token builtin class-name">:</span> <span class="token number">10000</span>, <span class="token string">"salt"</span> <span class="token builtin class-name">:</span> <span class="token string">"LefHopC8WY3knLfOVz56iw=="</span>, <span class="token string">"storedKey"</span> <span class="token builtin class-name">:</span> <span class="token string">"fFDpj6y1AZCw60aOTM8fBXzUwBc="</span>, <span class="token string">"serverKey"</span> <span class="token builtin class-name">:</span> <span class="token string">"YvTH+hyBHN1XThjYnrotc57/hgs="</span> <span class="token punctuation">&#125;</span>, <span class="token string">"SCRAM-SHA-256"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"iterationCount"</span> <span class="token builtin class-name">:</span> <span class="token number">15000</span>, <span class="token string">"salt"</span> <span class="token builtin class-name">:</span> <span class="token string">"35I31t2xZ5NIK0wrw0LZajRGtnY8B8YLwjHfgg=="</span>, <span class="token string">"storedKey"</span> <span class="token builtin class-name">:</span> <span class="token string">"iy3/8WvkxrNDcKPJmFQ7rTAXxNvzDtjK7uMxzUkhgJ4="</span>, <span class="token string">"serverKey"</span> <span class="token builtin class-name">:</span> <span class="token string">"V8Nhn6pBt50M5UsUNBNDGfaOU23f+CLYcYLnxBRTRy0="</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>, <span class="token string">"roles"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span> <span class="token punctuation">&#123;</span> <span class="token string">"role"</span> <span class="token builtin class-name">:</span> <span class="token string">"root"</span>, <span class="token string">"db"</span> <span class="token builtin class-name">:</span> <span class="token string">"admin"</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">]</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token operator">></span> </pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token comment">#修改密码</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token operator">></span> db.changeUserPassword<span class="token punctuation">(</span><span class="token string">"myroot"</span>,<span class="token string">"123456"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token operator">></span></pre></td></tr></table></figure><p>提示：</p><ol><li>本案例创建了两个用户，分别对应超管和专门用来管理用户的角色，事实上，你只需要一个用户即可。如果你对安全要求很高，防止超管泄露，则不要创建超管用户。</li><li>和其它数据库 (MySQL) 一样，权限的管理都差不多一样，也是将用户和权限信息保存到数据库对应的表中。MongoDB 存储所有的用户信息在 admin 数据库的集合 system.users 中，保存用户名，密码和数据库信息。</li><li role:useradminanydatabase,db:="">如果不指定数据库，则创建的指定的权限的用户在所有的数据库上有效，如</li></ol><p>认证测试：</p><p>测试添加的用户是否正确：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">></span> use admin</pre></td></tr><tr><td data-num="2"></td><td><pre>switched to db admin</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">#输入错误密码</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token operator">></span> db.auth<span class="token punctuation">(</span><span class="token string">"myroot"</span>,<span class="token string">"1234"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>Error: Authentication failed.</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token number">0</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">#输入正确密码</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token operator">></span> db.auth<span class="token punctuation">(</span><span class="token string">"myroot"</span>,<span class="token string">"123456"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token number">1</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token operator">></span></pre></td></tr></table></figure><p>创建普通用户</p><p>创建普通用户可以在没有开启认证的时候添加，也可以在开启认证之后添加，但开启认证之后，必须使用有操作 admin 库的用户登录认证后才能操作，底层都是将用户信息保存在了 admin 数据库的集合 system.users 中。</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">></span> use articledb</pre></td></tr><tr><td data-num="2"></td><td><pre>switched to db articledb</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token operator">></span> db</pre></td></tr><tr><td data-num="4"></td><td><pre>articledb</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">#创建用户，拥有 articledb 数据库的读写权限 readWrite，密码是 123456</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token operator">></span> db.createUser<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>user:<span class="token string">"bobo"</span>,pwd:<span class="token string">"123456"</span>,roles:<span class="token punctuation">[</span><span class="token punctuation">&#123;</span>role:<span class="token string">"readWrite"</span>,<span class="token string">"db"</span><span class="token builtin class-name">:</span><span class="token string">"articledb"</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>Successfully added user: <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	<span class="token string">"user"</span> <span class="token builtin class-name">:</span> <span class="token string">"bobo"</span>,</pre></td></tr><tr><td data-num="9"></td><td><pre>	<span class="token string">"roles"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="10"></td><td><pre>		<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>			<span class="token string">"role"</span> <span class="token builtin class-name">:</span> <span class="token string">"readWrite"</span>,</pre></td></tr><tr><td data-num="12"></td><td><pre>			<span class="token string">"db"</span> <span class="token builtin class-name">:</span> <span class="token string">"articledb"</span></pre></td></tr><tr><td data-num="13"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>	<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment">#测试是否可用</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token operator">></span> db.auth<span class="token punctuation">(</span><span class="token string">"bobo"</span>,<span class="token string">"123456"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token number">1</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token operator">></span></pre></td></tr></table></figure><p>提示：</p><p>如果开启了认证后，登录的客户端的用户必须使用 admin 库的角色，如拥有 root 角色的 myadmin 用户，再通过 myadmin 用户去创建其它角色的用户</p><h3 id="服务端开启认证和客户端连接登录"><a class="anchor" href="#服务端开启认证和客户端连接登录">#</a> 服务端开启认证和客户端连接登录</h3><ol><li><p>关闭已经启动的服务</p></li><li><p>使用 linux 命令杀死进程：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>➜  ~ <span class="token function">ps</span> -ef<span class="token operator">|</span><span class="token function">grep</span> mongod<span class="token operator">|</span><span class="token function">grep</span> <span class="token parameter variable">-v</span> <span class="token function">grep</span></pre></td></tr><tr><td data-num="2"></td><td><pre>dkx0      <span class="token number">34342</span>      <span class="token number">1</span>  <span class="token number">1</span> 03:53 ?        00:00:29 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/single/log/mongod.conf</pre></td></tr><tr><td data-num="3"></td><td><pre>dkx0      <span class="token number">34546</span>  <span class="token number">34416</span>  <span class="token number">0</span> 03:55 pts/1    00:00:00 /usr/local/mongodb/bin/mongo <span class="token parameter variable">--host</span><span class="token operator">=</span><span class="token number">192.168</span>.244.142 <span class="token parameter variable">--port</span><span class="token operator">=</span><span class="token number">27017</span></pre></td></tr><tr><td data-num="4"></td><td><pre>➜  ~ <span class="token function">kill</span> <span class="token parameter variable">-2</span> <span class="token number">34342</span></pre></td></tr><tr><td data-num="5"></td><td><pre>➜  ~</pre></td></tr></table></figure></li><li><p>在 mongo 客户端中使用 shutdownServer 命令来关闭</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">></span> db.shutdownServer<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">shutdown</span> <span class="token builtin class-name">command</span> only works with the admin database<span class="token punctuation">;</span> try <span class="token string">'use admin'</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token operator">></span> use admin</pre></td></tr><tr><td data-num="4"></td><td><pre>switched to db admin</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token operator">></span> db.shutdownServer<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>server should be down<span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token operator">></span></pre></td></tr></table></figure><p>需要几个条件：</p><ul><li>必须是在 admin 库下执行该关闭命令</li><li>如果没有认证，必须是从 localhost 登录的，才能执行关闭服务命令</li><li>非 localhost 得，通过远程登录，必须有登录且必须登录用户有对 admin 操作权限才可以。</li></ul><p>2. 以开启认证的方式启动服务</p><p>有两种方式开启权限认证启动服务：一种是参数方式，一种是配置文件方式 (推荐)。</p><p>1. 参数方式</p><p>在启动时指定参数 --auth，如：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>➜  ~ /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/single/log/mongod.conf <span class="token parameter variable">--auth</span></pre></td></tr></table></figure><p>2. 配置文件方式</p><p>在 single/mongod.conf 配置文件中加入:</p><figure class="highlight shell"><figcaption data-lang="Bash"><span>l</span></figcaption><table><tr><td data-num="1"></td><td><pre>security:</pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token comment">#开启授权认证</span></pre></td></tr><tr><td data-num="3"></td><td><pre> authorization: enabled</pre></td></tr></table></figure><p>启动时可不加 --auth 参数该方式避免忘记加 --auth 导致不安全问题发生：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>➜  ~ /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/single/log/mongod.conf</pre></td></tr></table></figure><p>启动服务并连接客户端查看效果：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>➜  ~ /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/single/log/mongod.conf </pre></td></tr><tr><td data-num="2"></td><td><pre>about to fork child process, waiting <span class="token keyword">until</span> server is ready <span class="token keyword">for</span> connections.</pre></td></tr><tr><td data-num="3"></td><td><pre>forked process: <span class="token number">36759</span></pre></td></tr><tr><td data-num="4"></td><td><pre>child process started successfully, parent exiting</pre></td></tr><tr><td data-num="5"></td><td><pre>➜  ~ </pre></td></tr><tr><td data-num="6"></td><td><pre>➜  ~ /usr/local/mongodb/bin/mongo <span class="token parameter variable">--host</span><span class="token operator">=</span><span class="token number">192.168</span>.244.142 <span class="token parameter variable">--port</span><span class="token operator">=</span><span class="token number">27017</span></pre></td></tr><tr><td data-num="7"></td><td><pre>MongoDB shell version v5.0.18</pre></td></tr><tr><td data-num="8"></td><td><pre>connecting to: mongodb://192.168.244.142:27017/?compressors<span class="token operator">=</span>disabled<span class="token operator">&amp;</span><span class="token assign-left variable">gssapiServiceName</span><span class="token operator">=</span>mongodb</pre></td></tr><tr><td data-num="9"></td><td><pre>Implicit session: session <span class="token punctuation">&#123;</span> <span class="token string">"id"</span> <span class="token builtin class-name">:</span> UUID<span class="token punctuation">(</span><span class="token string">"ea29ccf7-9d79-4fc5-9615-b26267842fd8"</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>MongoDB server version: <span class="token number">5.0</span>.18</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span></pre></td></tr><tr><td data-num="12"></td><td><pre>Warning: the <span class="token string">"mongo"</span> shell has been superseded by <span class="token string">"mongosh"</span>,</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token function">which</span> delivers improved usability and compatibility.The <span class="token string">"mongo"</span> shell has been deprecated and will be removed <span class="token keyword">in</span></pre></td></tr><tr><td data-num="14"></td><td><pre>an upcoming release.</pre></td></tr><tr><td data-num="15"></td><td><pre>For installation instructions, see</pre></td></tr><tr><td data-num="16"></td><td><pre>https://docs.mongodb.com/mongodb-shell/install/</pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token operator">></span> show dbs</pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token operator">></span> use articledb</pre></td></tr><tr><td data-num="20"></td><td><pre>switched to db articledb</pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token operator">></span> show tables</pre></td></tr><tr><td data-num="22"></td><td><pre>Warning: unable to run listCollections, attempting to approximate collection names by parsing connectionStatus</pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token operator">></span></pre></td></tr></table></figure><p>可以看到不能访问任何数据</p></li></ol><p>登录 myroot 用户：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">></span> use admin</pre></td></tr><tr><td data-num="2"></td><td><pre>switched to db admin</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token operator">></span> db.auth<span class="token punctuation">(</span><span class="token string">"myroot"</span>,<span class="token string">"123456"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">1</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token operator">></span> show dbs</pre></td></tr><tr><td data-num="6"></td><td><pre>admin      <span class="token number">0</span>.000GB</pre></td></tr><tr><td data-num="7"></td><td><pre>articledb  <span class="token number">0</span>.000GB</pre></td></tr><tr><td data-num="8"></td><td><pre>config     <span class="token number">0</span>.000GB</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token builtin class-name">local</span>      <span class="token number">0</span>.000GB</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token operator">></span></pre></td></tr></table></figure><p>登录 bobo 普通用户：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">></span> show dbs</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token operator">></span> db.auth<span class="token punctuation">(</span><span class="token string">"bobo"</span>,<span class="token string">"123456"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>Error: Authentication failed.</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">0</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token operator">></span> use articledb</pre></td></tr><tr><td data-num="6"></td><td><pre>switched to db articledb</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token operator">></span> db.auth<span class="token punctuation">(</span><span class="token string">"bobo"</span>,<span class="token string">"123456"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token number">1</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token operator">></span> show dbs</pre></td></tr><tr><td data-num="10"></td><td><pre>articledb  <span class="token number">0</span>.000GB</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token operator">></span> show tables</pre></td></tr><tr><td data-num="12"></td><td><pre>comment</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token operator">></span></pre></td></tr></table></figure><p><mark>注意</mark>：哪个用户权限属于哪个集合就需要 use 到该集合中执行 db.auth 命令才行</p><h3 id="springdatamongodb连接认证"><a class="anchor" href="#springdatamongodb连接认证">#</a> SpringDataMongoDB 连接认证</h3><p>使用用户名和密码连接到 MongoDB 服务器，你必须使用 <code>username:password@hostname/dbname</code> 格式， <code>username</code> 为用户名， <code>password</code> 为密码</p><p>目标：使用用户 bobo 使用密码 123456 连接到 MongoDB 服务上。</p><p>application.yml</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">spring</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	<span class="token comment">#数据源配置</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token key atrule">data</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>		<span class="token key atrule">mongodb</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>			<span class="token comment">#主机地址</span></pre></td></tr><tr><td data-num="6"></td><td><pre>			<span class="token comment">#host: 192.168.244.142</span></pre></td></tr><tr><td data-num="7"></td><td><pre>			<span class="token comment">#数据库</span></pre></td></tr><tr><td data-num="8"></td><td><pre>			<span class="token comment">#database: articledb</span></pre></td></tr><tr><td data-num="9"></td><td><pre>			<span class="token comment">#默认端口号</span></pre></td></tr><tr><td data-num="10"></td><td><pre>			<span class="token comment">#port: 27017</span></pre></td></tr><tr><td data-num="11"></td><td><pre>			<span class="token comment">#账号</span></pre></td></tr><tr><td data-num="12"></td><td><pre>			<span class="token comment">#username: bobo</span></pre></td></tr><tr><td data-num="13"></td><td><pre>			<span class="token comment">#密码</span></pre></td></tr><tr><td data-num="14"></td><td><pre>			<span class="token comment">#password: 123456</span></pre></td></tr><tr><td data-num="15"></td><td><pre>			<span class="token comment">#单机有认证的情况下，也是用字符串连接</span></pre></td></tr><tr><td data-num="16"></td><td><pre>			<span class="token key atrule">uri</span><span class="token punctuation">:</span> mongodb<span class="token punctuation">:</span>//bobo<span class="token punctuation">:</span>123456@192.168.244.142<span class="token punctuation">:</span>27017/articledb</pre></td></tr></table></figure><p>提示：</p><p>分别测试用户名密码正确以及不正确的情况.</p><p>Compass 连接需要指定用户名和密码否则连接不上</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031701928.png" alt="image-20230608165514763"></p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031701801.png" alt="image-20230608165613122"></p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031701100.png" alt="image-20230608165629084"></p><h2 id="副本集环境"><a class="anchor" href="#副本集环境">#</a> 副本集环境</h2><h3 id="前言"><a class="anchor" href="#前言">#</a> 前言</h3><p>对于搭建好的 mongodb 副本集，为了安全，启动安全认证，使用账号密码登。</p><p>副本集环境使用之前搭建好的，架构如下：</p><p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031701536.png" alt="image-20230608165821185"></p><h3 id="关闭已开启的副本集服务"><a class="anchor" href="#关闭已开启的副本集服务">#</a> 关闭已开启的副本集服务</h3><h3 id="通过主节点添加一个管理员账号"><a class="anchor" href="#通过主节点添加一个管理员账号">#</a> 通过主节点添加一个管理员账号</h3><p>只需要在主节点上添加用户，副本集会自动同步</p><p>开启认证之前，创建超管用户：myroot，密码：123456</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>myrs:PRIMARY<span class="token operator">></span> use admin</pre></td></tr><tr><td data-num="2"></td><td><pre>myrs:PRIMARY<span class="token operator">></span> db.createUser<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>user:<span class="token string">"myroot"</span>,pwd:<span class="token string">"123456"</span>,roles:<span class="token punctuation">[</span><span class="token string">"root"</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>详细操作见单实例环境的 <code>添加用户和权限</code> 的相关操作。</p><p>提示：</p><p>该步骤也可以在开启认证之后，但需要通过 localhost 登录才允许添加用户，用户数据也会自动同步到副本集，后续再创建其它用户，都可以使用该超管用户创建。</p><h3 id="创建副本集认证的key文件"><a class="anchor" href="#创建副本集认证的key文件">#</a> 创建副本集认证的 key 文件</h3><p>第一步：生成一个 key 文件当当前文件夹中</p><p>可以使用任何方法生成密钥文件，例如：以下操作使用 openssl 生成密码文件，然后使用 chmod 来 更改文件权限，仅为文件所有者提供读取权限</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>➜  ~ openssl rand <span class="token parameter variable">-base64</span> <span class="token number">90</span> <span class="token parameter variable">-out</span> ./mongo.keyfile</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token operator">></span> <span class="token function">chmod</span> <span class="token number">400</span> ./mongo.keyfile</pre></td></tr></table></figure><p>提示：</p><p>所有副本集节点都必须要用同一份 keyfile，一般是在一台机器上生成，然后拷贝到其它机器上，且必须有读的权限，否则将来会报错：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>permissions on /mongodb/replica_sets/myrs_27017/mongo.keyfile are too</pre></td></tr></table></figure><p>一定要保证密钥文件一致，文件位置随便，但是为了方便查找，建议每台机器都放到一个固定位置，都放到和配置文件一起的目录中</p><p>这里将该文件分别拷贝到多个目录中：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">></span> <span class="token function">cp</span> mongo.keyfile /mongodb/replica_sets/myrs_27017</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token operator">></span> <span class="token function">cp</span> mongo.keyfile /mongodb/replica_sets/myrs_27018</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token operator">></span> <span class="token function">cp</span> mongo.keyfile /mongodb/replica_sets/myrs_27019</pre></td></tr></table></figure><h3 id="修改配置文件指定keyfile"><a class="anchor" href="#修改配置文件指定keyfile">#</a> 修改配置文件指定 keyfile</h3><p>分别编辑几个服务的 mongod.conf 文件，添加相关内容：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">security</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	<span class="token comment">#keyfile 签权文件</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token key atrule">keyFile</span><span class="token punctuation">:</span> /mongodb/replica_sets/myrs_27017/mongo.keyfile</pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token comment">#开启认证方式运行</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token key atrule">authorization</span><span class="token punctuation">:</span> enabled</pre></td></tr></table></figure><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">security</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	<span class="token comment">#keyfile 签权文件</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token key atrule">keyFile</span><span class="token punctuation">:</span> /mongodb/replica_sets/myrs_27018/mongo.keyfile</pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token comment">#开启认证方式运行</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token key atrule">authorization</span><span class="token punctuation">:</span> enabled</pre></td></tr></table></figure><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">security</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	<span class="token comment">#keyfile 签权文件</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token key atrule">keyFile</span><span class="token punctuation">:</span> /mongodb/replica_sets/myrs_27019/mongo.keyfile</pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token comment">#开启认证方式运行</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token key atrule">authorization</span><span class="token punctuation">:</span> enabled</pre></td></tr></table></figure><h3 id="重新启动副本集"><a class="anchor" href="#重新启动副本集">#</a> 重新启动副本集</h3><p>如果副本集是开启状态，则先分别关闭副本集中的每个 mongod，从次节点开始，直到副本集的所有成员都离线，包括任何仲载者，主节点必须是最后一个成员关闭以避免潜在的回滚。</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>➜  ~ <span class="token function">kill</span> <span class="token parameter variable">-2</span> <span class="token number">2453</span> <span class="token number">2224</span> <span class="token number">2110</span> <span class="token number">2013</span></pre></td></tr></table></figure><p>分别启动副本集节点：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>➜  ~ /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/replica_sets/myrs_27017/log/mongod.conf </pre></td></tr><tr><td data-num="2"></td><td><pre>about to fork child process, waiting <span class="token keyword">until</span> server is ready <span class="token keyword">for</span> connections.</pre></td></tr><tr><td data-num="3"></td><td><pre>forked process: <span class="token number">3960</span></pre></td></tr><tr><td data-num="4"></td><td><pre>child process started successfully, parent exiting</pre></td></tr><tr><td data-num="5"></td><td><pre>➜  ~ /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/replica_sets/myrs_27018/log/mongod.conf</pre></td></tr><tr><td data-num="6"></td><td><pre>about to fork child process, waiting <span class="token keyword">until</span> server is ready <span class="token keyword">for</span> connections.</pre></td></tr><tr><td data-num="7"></td><td><pre>forked process: <span class="token number">4043</span></pre></td></tr><tr><td data-num="8"></td><td><pre>child process started successfully, parent exiting</pre></td></tr><tr><td data-num="9"></td><td><pre>➜  ~ /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/replica_sets/myrs_27019/log/mongod.conf</pre></td></tr><tr><td data-num="10"></td><td><pre>about to fork child process, waiting <span class="token keyword">until</span> server is ready <span class="token keyword">for</span> connections.</pre></td></tr><tr><td data-num="11"></td><td><pre>forked process: <span class="token number">4144</span></pre></td></tr><tr><td data-num="12"></td><td><pre>child process started successfully, parent exiting</pre></td></tr><tr><td data-num="13"></td><td><pre>➜  ~</pre></td></tr></table></figure><p>查看进程：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>➜  ~ <span class="token function">ps</span> -ef<span class="token operator">|</span><span class="token function">grep</span> mongod<span class="token operator">|</span><span class="token function">grep</span> <span class="token parameter variable">-v</span> <span class="token function">grep</span></pre></td></tr><tr><td data-num="2"></td><td><pre>dkx0       <span class="token number">3960</span>      <span class="token number">1</span>  <span class="token number">9</span> <span class="token number">22</span>:44 ?        00:00:03 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/replica_sets/myrs_27017/log/mongod.conf</pre></td></tr><tr><td data-num="3"></td><td><pre>dkx0       <span class="token number">4043</span>      <span class="token number">1</span> <span class="token number">10</span> <span class="token number">22</span>:44 ?        00:00:03 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/replica_sets/myrs_27018/log/mongod.conf</pre></td></tr><tr><td data-num="4"></td><td><pre>dkx0       <span class="token number">4144</span>      <span class="token number">1</span> <span class="token number">11</span> <span class="token number">22</span>:44 ?        00:00:02 /usr/local/mongodb/bin/mongod <span class="token parameter variable">-f</span> /mongodb/replica_sets/myrs_27019/log/mongod.conf</pre></td></tr><tr><td data-num="5"></td><td><pre>➜  ~</pre></td></tr></table></figure><p>登录 myroot 用户查看</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>myrs:PRIMARY<span class="token operator">></span> show dbs</pre></td></tr><tr><td data-num="2"></td><td><pre>myrs:PRIMARY<span class="token operator">></span> use admin</pre></td></tr><tr><td data-num="3"></td><td><pre>switched to db admin</pre></td></tr><tr><td data-num="4"></td><td><pre>myrs:PRIMARY<span class="token operator">></span> db.auth<span class="token punctuation">(</span><span class="token string">"myroot"</span>,<span class="token string">"123456"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">1</span></pre></td></tr><tr><td data-num="6"></td><td><pre>myrs:PRIMARY<span class="token operator">></span> show dbs</pre></td></tr><tr><td data-num="7"></td><td><pre>admin      <span class="token number">0</span>.000GB</pre></td></tr><tr><td data-num="8"></td><td><pre>articledb  <span class="token number">0</span>.000GB</pre></td></tr><tr><td data-num="9"></td><td><pre>config     <span class="token number">0</span>.000GB</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token builtin class-name">local</span>      <span class="token number">0</span>.001GB</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token builtin class-name">test</span>       <span class="token number">0</span>.000GB</pre></td></tr><tr><td data-num="12"></td><td><pre>myrs:PRIMARY<span class="token operator">></span></pre></td></tr></table></figure><h3 id="在主节点上添加普通账号"><a class="anchor" href="#在主节点上添加普通账号">#</a> 在主节点上添加普通账号</h3><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#添加普通用户管理 articledb 集合</span></pre></td></tr><tr><td data-num="2"></td><td><pre>myrs:PRIMARY<span class="token operator">></span> db.createUser<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>user:<span class="token string">"bobo"</span>,pwd:<span class="token string">"123456"</span>,roles:<span class="token punctuation">[</span><span class="token punctuation">&#123;</span>role:<span class="token string">"readWrite"</span>,db:<span class="token string">"articledb"</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>Successfully added user: <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token string">"user"</span> <span class="token builtin class-name">:</span> <span class="token string">"bobo"</span>,</pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token string">"roles"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="6"></td><td><pre>		<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>			<span class="token string">"role"</span> <span class="token builtin class-name">:</span> <span class="token string">"readWrite"</span>,</pre></td></tr><tr><td data-num="8"></td><td><pre>			<span class="token string">"db"</span> <span class="token builtin class-name">:</span> <span class="token string">"articledb"</span></pre></td></tr><tr><td data-num="9"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>	<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>myrs:PRIMARY<span class="token operator">></span></pre></td></tr></table></figure><p>重新连接，使用普通用户 bobo 重新登录，查看数据</p><p>注意：也要使用 rs.status () 命令查看副本集是否健康</p><h3 id="springdatamongodb连接副本集-2"><a class="anchor" href="#springdatamongodb连接副本集-2">#</a> SpringDataMongoDB 连接副本集</h3><p>使用用户名和密码连接到 MongoDB 服务器，必须使用 <code>username:password@hostname/dbname</code> 格式</p><p>目标：使用用户 bobo 使用密码 123456 连接到 mongoDB 服务上</p><p>application.yml</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">server</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">spring</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token comment">#数据源配置</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">data</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token key atrule">mongodb</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token comment">#主机地址</span></pre></td></tr><tr><td data-num="8"></td><td><pre>      <span class="token comment">#host: 192.168.244.142</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token comment">#数据库</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token comment">#database: articledb</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token comment">#端口号</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token comment">#port: 27017</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token comment">#也可以使用 uri 连接</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token comment">#uri: mongodb://192.168.244.142:27017/articledb</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token comment">#副本集的连接字符串</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token key atrule">uri</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        mongodb<span class="token punctuation">:</span>//bobo<span class="token punctuation">:</span>123456@192.168.244.142<span class="token punctuation">:</span><span class="token number">27017</span><span class="token punctuation">,</span>192.168.244.142<span class="token punctuation">:</span><span class="token number">27018</span><span class="token punctuation">,</span>192.168.244.142<span class="token punctuation">:</span>27019/articledb<span class="token punctuation">?</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        connect=replicaSet<span class="token important">&amp;secondaryOk=true&amp;replicaSet=myrs</span></pre></td></tr></table></figure><h3 id="分片集群环境扩展"><a class="anchor" href="#分片集群环境扩展">#</a> 分片集群环境 (扩展)</h3><h4 id="关闭已开启的集群服务"><a class="anchor" href="#关闭已开启的集群服务">#</a> 关闭已开启的集群服务</h4><p>分片集群环境下的安全认证和副本集环境下基本上一样。</p><p>但分片集群的服务器环境和架构较为复杂，建议在搭建分片集群的时候，直接加入安全认证和服务器间的签权，如果之前有数据，可先将之前的数据备份出来，再还原回去</p><p>本文使用之前搭建好的集群服务，因此，先停止之前的集群服务</p><p>依次杀死 mongod 路由，配置副本集服务，分片副本服务，从次节点开始，直到所有成员都离线，副本集杀的时候，建议先杀仲载者，再杀副本节点，最后是主节点，以避免潜在的回滚，杀完检查一下</p><div class="tags"><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%AD%A6%E7%A7%91/" rel="tag"><i class="ic i-tag"></i> 计算机学科</a> <a href="/tags/database/" rel="tag"><i class="ic i-tag"></i> database</a> <a href="/tags/mongodb/" rel="tag"><i class="ic i-tag"></i> mongodb</a></div></div><footer><div class="meta"><span id="computer-science/database/mongodb/MongoDB集群和安全/" class="item leancloud_visitors" data-flag-title="MongoDB 集群和安全" title="阅读次数"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">阅读次数</span> <span class="leancloud-visitors-count"></span> <span class="text">次</span></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="D 微信支付"><p>微信支付</p></div><div><img data-src="/images/alipay.png" alt="D 支付宝"><p>支付宝</p></div><div><img data-src="/images/paypal.png" alt="D 贝宝"><p>贝宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>Dkx： </strong>D <i class="ic i-at"><em>@</em></i>D の Java</li><li class="link"><strong>本文链接：</strong> <a href="https://pigpigletsgo.github.io/computer-science/database/mongodb/MongoDB%E9%9B%86%E7%BE%A4%E5%92%8C%E5%AE%89%E5%85%A8/" title="MongoDB 集群和安全">https://pigpigletsgo.github.io/computer-science/database/mongodb/MongoDB集群和安全/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/computer-science/database/redis/Redis%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;img.timelessq.com&#x2F;images&#x2F;2022&#x2F;07&#x2F;26&#x2F;4c481240fd5e6e7b076ca8fe50da6e52.jpg" title="redis-主从复制"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> redis</span><h3>redis-主从复制</h3></a></div><div class="item right"><a href="/computer-science/database/JDBC/JDBC%E6%A8%A1%E5%BC%8F%E5%AE%9E%E7%8E%B0/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;img.timelessq.com&#x2F;images&#x2F;2022&#x2F;07&#x2F;26&#x2F;0a8c679b59d7b4a6f86d891282323a50.jpg" title="JDBC模式实现"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> JDBC</span><h3>JDBC模式实现</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#mongodb%E9%9B%86%E7%BE%A4%E5%92%8C%E5%AE%89%E5%85%A8"><span class="toc-number">1.</span> <span class="toc-text">MongoDB 集群和安全</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%AF%E6%9C%AC%E9%9B%86-replica-sets"><span class="toc-number">1.1.</span> <span class="toc-text">副本集 - Replica Sets</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">1.1.1.</span> <span class="toc-text">简介</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%AF%E6%9C%AC%E9%9B%86%E7%9A%84%E4%B8%89%E4%B8%AA%E8%A7%92%E8%89%B2"><span class="toc-number">1.2.</span> <span class="toc-text">副本集的三个角色</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%AF%E6%9C%AC%E9%9B%86%E7%9A%84%E5%88%9B%E5%BB%BA"><span class="toc-number">1.3.</span> <span class="toc-text">副本集的创建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%E5%88%9B%E5%BB%BA%E4%B8%BB%E8%8A%82%E7%82%B9"><span class="toc-number">1.3.1.</span> <span class="toc-text">第一步创建主节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5%E5%88%9B%E5%BB%BA%E5%89%AF%E6%9C%AC%E8%8A%82%E7%82%B9"><span class="toc-number">1.3.2.</span> <span class="toc-text">第二步：创建副本节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%AD%A5%E5%88%9B%E5%BB%BA%E4%BB%B2%E8%BD%BD%E8%8A%82%E7%82%B9"><span class="toc-number">1.3.3.</span> <span class="toc-text">第三步：创建仲载节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E6%AD%A5%E5%88%9D%E5%A7%8B%E5%8C%96%E9%85%8D%E7%BD%AE%E5%89%AF%E6%9C%AC%E9%9B%86%E5%92%8C%E4%B8%BB%E8%8A%82%E7%82%B9"><span class="toc-number">1.3.4.</span> <span class="toc-text">第四步：初始化配置副本集和主节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%BA%94%E6%AD%A5%E6%9F%A5%E7%9C%8B%E5%89%AF%E6%9C%AC%E9%9B%86%E7%9A%84%E9%85%8D%E7%BD%AE%E5%86%85%E5%AE%B9"><span class="toc-number">1.3.5.</span> <span class="toc-text">第五步：查看副本集的配置内容</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E5%85%AD%E6%AD%A5%E6%9F%A5%E7%9C%8B%E5%89%AF%E6%9C%AC%E9%9B%86%E7%8A%B6%E6%80%81"><span class="toc-number">1.3.6.</span> <span class="toc-text">第六步：查看副本集状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%83%E6%AD%A5%E6%B7%BB%E5%8A%A0%E5%89%AF%E6%9C%AC%E4%BB%8E%E8%8A%82%E7%82%B9"><span class="toc-number">1.3.7.</span> <span class="toc-text">第七步：添加副本从节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E5%85%AB%E6%AD%A5%E6%B7%BB%E5%8A%A0%E4%BB%B2%E8%BD%BD%E4%BB%8E%E8%8A%82%E7%82%B9"><span class="toc-number">1.3.8.</span> <span class="toc-text">第八步：添加仲载从节点</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%AF%E6%9C%AC%E9%9B%86%E7%9A%84%E6%95%B0%E6%8D%AE%E8%AF%BB%E5%86%99%E6%93%8D%E4%BD%9C"><span class="toc-number">1.4.</span> <span class="toc-text">副本集的数据读写操作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BB%E8%8A%82%E7%82%B9%E7%9A%84%E9%80%89%E4%B8%BE%E5%8E%9F%E5%88%99"><span class="toc-number">1.5.</span> <span class="toc-text">主节点的选举原则</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E4%BC%98%E5%85%88%E7%BA%A7"><span class="toc-number">1.5.1.</span> <span class="toc-text">修改优先级</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%85%E9%9A%9C%E6%B5%8B%E8%AF%95"><span class="toc-number">1.6.</span> <span class="toc-text">故障测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%AF%E6%9C%AC%E8%8A%82%E7%82%B9%E6%95%85%E9%9A%9C%E6%B5%8B%E8%AF%95"><span class="toc-number">1.6.1.</span> <span class="toc-text">副本节点故障测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E8%8A%82%E7%82%B9%E6%95%85%E9%9A%9C%E6%B5%8B%E8%AF%95"><span class="toc-number">1.6.2.</span> <span class="toc-text">主节点故障测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%B2%E8%BD%BD%E8%8A%82%E7%82%B9%E5%92%8C%E4%B8%BB%E8%8A%82%E7%82%B9%E6%95%85%E9%9A%9C"><span class="toc-number">1.6.3.</span> <span class="toc-text">仲载节点和主节点故障</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%B2%E8%BD%BD%E8%8A%82%E7%82%B9%E5%92%8C%E4%BB%8E%E8%8A%82%E7%82%B9%E6%95%85%E9%9A%9C"><span class="toc-number">1.6.4.</span> <span class="toc-text">仲载节点和从节点故障</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#compass%E8%BF%9E%E6%8E%A5%E5%89%AF%E6%9C%AC%E9%9B%86"><span class="toc-number">1.7.</span> <span class="toc-text">Compass 连接副本集</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#springdatamongodb%E8%BF%9E%E6%8E%A5%E5%89%AF%E6%9C%AC%E9%9B%86"><span class="toc-number">1.8.</span> <span class="toc-text">SpringDataMongoDB 连接副本集</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E7%89%87%E9%9B%86%E7%BE%A4-sharded-cluster"><span class="toc-number">1.9.</span> <span class="toc-text">分片集群 - Sharded Cluster</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E7%89%87%E6%A6%82%E5%BF%B5"><span class="toc-number">1.9.1.</span> <span class="toc-text">分片概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E7%89%87%E9%9B%86%E7%BE%A4%E5%8C%85%E5%90%AB%E7%9A%84%E7%BB%84%E4%BB%B6"><span class="toc-number">1.9.2.</span> <span class="toc-text">分片集群包含的组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E7%89%87%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84%E7%9B%AE%E6%A0%87"><span class="toc-number">1.9.3.</span> <span class="toc-text">分片集群架构目标</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E7%89%87%E5%AD%98%E5%82%A8%E8%8A%82%E7%82%B9%E5%89%AF%E6%9C%AC%E9%9B%86%E7%9A%84%E5%88%9B%E5%BB%BA"><span class="toc-number">1.9.4.</span> <span class="toc-text">分片 (存储) 节点副本集的创建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E5%A5%97%E5%89%AF%E6%9C%AC%E9%9B%86"><span class="toc-number">1.9.5.</span> <span class="toc-text">第一套副本集</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E5%A5%97%E5%89%AF%E6%9C%AC%E9%9B%86"><span class="toc-number">1.9.6.</span> <span class="toc-text">第二套副本集</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E8%8A%82%E7%82%B9%E5%89%AF%E6%9C%AC%E9%9B%86%E7%9A%84%E5%88%9B%E5%BB%BA"><span class="toc-number">1.9.7.</span> <span class="toc-text">配置节点副本集的创建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E8%8A%82%E7%82%B9%E7%9A%84%E5%88%9B%E5%BB%BA%E5%92%8C%E6%93%8D%E4%BD%9C"><span class="toc-number">1.9.8.</span> <span class="toc-text">路由节点的创建和操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E4%B8%AA%E8%B7%AF%E7%94%B1%E8%8A%82%E7%82%B9%E7%9A%84%E5%88%9B%E5%BB%BA%E5%92%8C%E8%BF%9E%E6%8E%A5"><span class="toc-number">1.9.8.1.</span> <span class="toc-text">第一个路由节点的创建和连接</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8%E8%B7%AF%E7%94%B1%E8%8A%82%E7%82%B9%E4%B8%8A%E8%BF%9B%E8%A1%8C%E5%88%86%E7%89%87%E9%85%8D%E7%BD%AE%E6%93%8D%E4%BD%9C"><span class="toc-number">1.9.8.2.</span> <span class="toc-text">在路由节点上进行分片配置操作</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E7%89%87%E5%90%8E%E6%8F%92%E5%85%A5%E6%95%B0%E6%8D%AE%E6%B5%8B%E8%AF%95"><span class="toc-number">1.9.9.</span> <span class="toc-text">分片后插入数据测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%8D%E5%A2%9E%E5%8A%A0%E4%B8%80%E4%B8%AA%E8%B7%AF%E7%94%B1%E8%8A%82%E7%82%B9"><span class="toc-number">1.9.10.</span> <span class="toc-text">再增加一个路由节点</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#compass%E8%BF%9E%E6%8E%A5%E5%88%86%E7%89%87%E9%9B%86%E7%BE%A4"><span class="toc-number">1.10.</span> <span class="toc-text">Compass 连接分片集群</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#springdatamongodb%E8%BF%9E%E6%8E%A5%E5%88%86%E7%89%87%E9%9B%86%E7%BE%A4"><span class="toc-number">1.11.</span> <span class="toc-text">SpringDataMongoDB 连接分片集群</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E8%AE%A4%E8%AF%81"><span class="toc-number">1.12.</span> <span class="toc-text">安全认证</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#mongodb%E7%9A%84%E7%94%A8%E6%88%B7%E5%92%8C%E8%A7%92%E8%89%B2%E6%9D%83%E9%99%90%E7%AE%80%E4%BB%8B"><span class="toc-number">1.12.1.</span> <span class="toc-text">MongoDB 的用户和角色权限简介</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%95%E5%AE%9E%E4%BE%8B%E7%8E%AF%E5%A2%83"><span class="toc-number">1.13.</span> <span class="toc-text">单实例环境</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E9%97%AD%E5%B7%B2%E5%BC%80%E5%90%AF%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%8F%AF%E9%80%89"><span class="toc-number">1.13.1.</span> <span class="toc-text">关闭已开启的服务 (可选)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E7%94%A8%E6%88%B7%E5%92%8C%E6%9D%83%E9%99%90"><span class="toc-number">1.13.2.</span> <span class="toc-text">添加用户和权限</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%BC%80%E5%90%AF%E8%AE%A4%E8%AF%81%E5%92%8C%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%BF%9E%E6%8E%A5%E7%99%BB%E5%BD%95"><span class="toc-number">1.13.3.</span> <span class="toc-text">服务端开启认证和客户端连接登录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#springdatamongodb%E8%BF%9E%E6%8E%A5%E8%AE%A4%E8%AF%81"><span class="toc-number">1.13.4.</span> <span class="toc-text">SpringDataMongoDB 连接认证</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%AF%E6%9C%AC%E9%9B%86%E7%8E%AF%E5%A2%83"><span class="toc-number">1.14.</span> <span class="toc-text">副本集环境</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.14.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E9%97%AD%E5%B7%B2%E5%BC%80%E5%90%AF%E7%9A%84%E5%89%AF%E6%9C%AC%E9%9B%86%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.14.2.</span> <span class="toc-text">关闭已开启的副本集服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E4%B8%BB%E8%8A%82%E7%82%B9%E6%B7%BB%E5%8A%A0%E4%B8%80%E4%B8%AA%E7%AE%A1%E7%90%86%E5%91%98%E8%B4%A6%E5%8F%B7"><span class="toc-number">1.14.3.</span> <span class="toc-text">通过主节点添加一个管理员账号</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%89%AF%E6%9C%AC%E9%9B%86%E8%AE%A4%E8%AF%81%E7%9A%84key%E6%96%87%E4%BB%B6"><span class="toc-number">1.14.4.</span> <span class="toc-text">创建副本集认证的 key 文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%8C%87%E5%AE%9Akeyfile"><span class="toc-number">1.14.5.</span> <span class="toc-text">修改配置文件指定 keyfile</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E6%96%B0%E5%90%AF%E5%8A%A8%E5%89%AF%E6%9C%AC%E9%9B%86"><span class="toc-number">1.14.6.</span> <span class="toc-text">重新启动副本集</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8%E4%B8%BB%E8%8A%82%E7%82%B9%E4%B8%8A%E6%B7%BB%E5%8A%A0%E6%99%AE%E9%80%9A%E8%B4%A6%E5%8F%B7"><span class="toc-number">1.14.7.</span> <span class="toc-text">在主节点上添加普通账号</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#springdatamongodb%E8%BF%9E%E6%8E%A5%E5%89%AF%E6%9C%AC%E9%9B%86-2"><span class="toc-number">1.14.8.</span> <span class="toc-text">SpringDataMongoDB 连接副本集</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E7%89%87%E9%9B%86%E7%BE%A4%E7%8E%AF%E5%A2%83%E6%89%A9%E5%B1%95"><span class="toc-number">1.14.9.</span> <span class="toc-text">分片集群环境 (扩展)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E9%97%AD%E5%B7%B2%E5%BC%80%E5%90%AF%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.14.9.1.</span> <span class="toc-text">关闭已开启的集群服务</span></a></li></ol></li></ol></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li class="active"><a href="/computer-science/database/mongodb/MongoDB%E9%9B%86%E7%BE%A4%E5%92%8C%E5%AE%89%E5%85%A8/" rel="bookmark" title="MongoDB集群和安全">MongoDB集群和安全</a></li><li><a href="/computer-science/database/mongodb/MongoDB%E5%85%A5%E9%97%A8/" rel="bookmark" title="MongoDB入门">MongoDB入门</a></li><li><a href="/computer-science/database/mongodb/MongoDB%E7%9A%84%E5%AE%89%E8%A3%85%E5%8F%8A%E5%90%AF%E7%94%A8/" rel="bookmark" title="MongoDB的安装及启用">MongoDB的安装及启用</a></li><li><a href="/computer-science/database/mongodb/%E6%A1%88%E4%BE%8BDemo/MongoDB%20%E5%88%86%E9%A1%B5/" rel="bookmark" title="MongoDB 分页">MongoDB 分页</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="D" data-src="/images/avatar.jpg"><p class="name" itemprop="name">D</p><div class="description" itemprop="description">欢迎来我的博客空间</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">513</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">132</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">163</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL1BpZ1BpZ0xldHNHbw==" title="https:&#x2F;&#x2F;github.com&#x2F;PigPigLetsGo"><i class="ic i-github"></i></span> <span class="exturl item twitter" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS9Ea3gxMjE5" title="https:&#x2F;&#x2F;twitter.com&#x2F;Dkx1219"><i class="ic i-twitter"></i></span> <span class="exturl item zhihu" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3Blb3BsZS96dWktaG91LXllLWJlaS1sdWUtc2hh" title="https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;zui-hou-ye-bei-lue-sha"><i class="ic i-zhihu"></i></span> <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPTU3NjUxMDQ1OQ==" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;576510459"><i class="ic i-cloud-music"></i></span> <span class="exturl item weibo" data-url="aHR0cHM6Ly93d3cud2VpYm8uY29tL3UvNTk5OTU0OTg0MQ==" title="https:&#x2F;&#x2F;www.weibo.com&#x2F;u&#x2F;5999549841"><i class="ic i-weibo"></i></span> <span class="exturl item facebook" data-url="aHR0cHM6Ly93d3cuZmFjZWJvb2suY29tL3Byb2ZpbGUucGhwP2lkPTEwMDA5NDA4Nzc0ODIwMQ==" title="https:&#x2F;&#x2F;www.facebook.com&#x2F;profile.php?id&#x3D;100094087748201"><i class="ic i-facebook"></i></span> <span class="exturl item stackoverflow" data-url="aHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS91c2Vycy8xOTQwNjAyOS9kLWt4" title="https:&#x2F;&#x2F;stackoverflow.com&#x2F;users&#x2F;19406029&#x2F;d-kx"><i class="ic i-stack-overflow"></i></span> <span class="exturl item youtube" data-url="aHR0cHM6Ly93d3cueW91dHViZS5jb20vQERreC12djdsbQ==" title="https:&#x2F;&#x2F;www.youtube.com&#x2F;@Dkx-vv7lm"><i class="ic i-youtube"></i></span> <span class="exturl item instagram" data-url="aHR0cHM6Ly93d3cuaW5zdGFncmFtLmNvbS9kb3Vka3g/aWdzaD1PR1E1WkRjMk9EazJaQSUzRCUzRCZ1dG1fc291cmNlPXFy" title="https:&#x2F;&#x2F;www.instagram.com&#x2F;doudkx?igsh&#x3D;OGQ5ZDc2ODk2ZA%3D%3D&amp;utm_source&#x3D;qr"><i class="ic i-instagram"></i></span> <span class="exturl item paper-plane" data-url="aHR0cHM6Ly90Lm1lL2RvdTAxMDg=" title="https:&#x2F;&#x2F;t.me&#x2F;dou0108"><i class="ic i-paper-plane"></i></span> <span class="exturl item skype" data-url="aHR0cHM6Ly9qb2luLnNreXBlLmNvbS9UN25TSWhvbmMxcWQ=" title="https:&#x2F;&#x2F;join.skype.com&#x2F;T7nSIhonc1qd"><i class="ic i-skype"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>友達</a></li><li class="item"><a href="/links/" rel="section"><i class="ic i-magic"></i>链接</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/computer-science/database/redis/Redis%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/computer-science/database/JDBC/JDBC%E6%A8%A1%E5%BC%8F%E5%AE%9E%E7%8E%B0/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于 计算机学科">计算机学科</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/" title="分类于 java">java</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/%E6%A1%88%E4%BE%8BDemo/" title="分类于 案例 Demo">案例 Demo</a></div><span><a href="/computer-science/java/%E6%A1%88%E4%BE%8BDemo/TCP+JFrame%E5%AE%9E%E7%8E%B0%E8%81%8A%E5%A4%A9/" title="TCP+JFrame实现聊天">TCP+JFrame实现聊天</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于 计算机学科">计算机学科</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/" title="分类于 java">java</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93/" title="分类于 第三方库">第三方库</a></div><span><a href="/computer-science/java/%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93/java%E5%9F%BA%E4%BA%8Egeotools%E5%AE%9E%E7%8E%B0%E7%9A%84%E5%87%A0%E4%BD%95%E5%9B%BE%E5%BD%A2%E5%9D%90%E6%A0%87%E7%B3%BB%E8%BD%AC%E6%8D%A2%E9%80%9A%E7%94%A8%E5%B7%A5%E5%85%B7%E7%B1%BBgeotools%E5%87%A0%E4%BD%95%E5%9D%90%E6%A0%87%E8%BD%AC%E6%8D%A2java%E5%87%A0%E4%BD%95%E5%9D%90%E6%A0%87%E8%BD%AC%E6%8D%A2/" title="java基于geotools实现的几何图形坐标系转换通用工具类geotools几何坐标转换java几何坐标转换">java基于geotools实现的几何图形坐标系转换通用工具类geotools几何坐标转换java几何坐标转换</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于 计算机学科">计算机学科</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/" title="分类于 java">java</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93/" title="分类于 第三方库">第三方库</a></div><span><a href="/computer-science/java/%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93/%E6%95%B0%E6%8D%AE%E8%84%B1%E6%95%8F/" title="Hutool-数据脱敏">Hutool-数据脱敏</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/tools/" title="分类于 tools">tools</a> <i class="ic i-angle-right"></i> <a href="/categories/tools/Interfacetesting/" title="分类于 Interfacetesting">Interfacetesting</a> <i class="ic i-angle-right"></i> <a href="/categories/tools/Interfacetesting/swaggerOrKnife4j/" title="分类于 swaggerOrKnife4j">swaggerOrKnife4j</a></div><span><a href="/tools/Interfacetesting/swaggerOrKnife4j/%E9%85%8D%E7%BD%AE%E6%8E%A5%E5%8F%A3%E6%96%87%E6%A1%A3Swagger%E5%92%8CKnife4j%E6%95%99%E7%A8%8B/" title="配置接口文档Swagger和Knife4j教程">配置接口文档Swagger和Knife4j教程</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于 计算机学科">计算机学科</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/" title="分类于 java">java</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/spring/" title="分类于 spring">spring</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/spring/%E4%BA%8B%E5%8A%A1/" title="分类于 事务">事务</a></div><span><a href="/computer-science/java/spring/%E4%BA%8B%E5%8A%A1/%E4%BA%8B%E5%8A%A1%E7%9B%B8%E5%85%B3%E9%85%8D%E7%BD%AE/" title="事务相关配置">事务相关配置</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于 计算机学科">计算机学科</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/" title="分类于 java">java</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/%E6%A1%88%E4%BE%8BDemo/" title="分类于 案例 Demo">案例 Demo</a></div><span><a href="/computer-science/java/%E6%A1%88%E4%BE%8BDemo/%E4%BA%8C%E7%BA%A7%E8%8F%9C%E5%8D%95%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" title="二级菜单数据结构">二级菜单数据结构</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于 计算机学科">计算机学科</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/" title="分类于 java">java</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/spring/" title="分类于 spring">spring</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/spring/%E6%95%B4%E5%90%88jar%E5%8C%85/" title="分类于 整合 jar 包">整合 jar 包</a></div><span><a href="/computer-science/java/spring/%E6%95%B4%E5%90%88jar%E5%8C%85/Spring%E6%95%B4%E5%90%88MyBatis/" title="Spring整合MyBatis">Spring整合MyBatis</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于 计算机学科">计算机学科</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/" title="分类于 java">java</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/%E7%9F%A5%E8%AF%86%E7%82%B9/" title="分类于 知识点">知识点</a></div><span><a href="/computer-science/java/%E7%9F%A5%E8%AF%86%E7%82%B9/%E6%96%B9%E6%B3%95%E5%BC%95%E7%94%A8/" title="方法引用">方法引用</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于 计算机学科">计算机学科</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/" title="分类于 java">java</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/spring/" title="分类于 spring">spring</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/spring/%E4%BB%A3%E7%A0%81%E6%A1%88%E4%BE%8B/" title="分类于 代码案例">代码案例</a></div><span><a href="/computer-science/java/spring/%E4%BB%A3%E7%A0%81%E6%A1%88%E4%BE%8B/2/" title="生命周期案例">生命周期案例</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于 计算机学科">计算机学科</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/nginx/" title="分类于 nginx">nginx</a></div><span><a href="/computer-science/nginx/%E5%AE%89%E8%A3%85Discuz%E4%B8%8E%E5%8D%8F%E8%AE%AE%E8%87%AA%E5%8A%A8%E8%B7%B3%E8%BD%AC/" title="安装Discuz与协议自动跳转">安装Discuz与协议自动跳转</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2023 – <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">D @ D & PersonalBlog</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">3.4m 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">51:54</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"computer-science/database/mongodb/MongoDB集群和安全/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="https://cdn.jsdelivr.net/gh/PigPigLetsGo/live2d-widget@latest/autoload.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html>