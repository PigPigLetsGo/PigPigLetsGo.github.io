{
    "version": "https://jsonfeed.org/version/1",
    "title": "homepage • All posts by \"持久化\" tag",
    "description": "欢迎来我的博客空间",
    "home_page_url": "https://pigpigletsgo.github.io/homepage",
    "items": [
        {
            "id": "https://pigpigletsgo.github.io/homepage/2024/01/24/computer-science/java/spring/springcloud/springcloud-%E9%AB%98%E7%BA%A7/sentinel/sentinel%E8%A7%84%E5%88%99%E6%8C%81%E4%B9%85%E5%8C%96/",
            "url": "https://pigpigletsgo.github.io/homepage/2024/01/24/computer-science/java/spring/springcloud/springcloud-%E9%AB%98%E7%BA%A7/sentinel/sentinel%E8%A7%84%E5%88%99%E6%8C%81%E4%B9%85%E5%8C%96/",
            "title": "Sentinel规则持久化",
            "date_published": "2024-01-24T10:48:46.308Z",
            "content_html": "<h1 id=\"sentinel-规则持久化\"><a class=\"anchor\" href=\"#sentinel-规则持久化\">#</a> Sentinel 规则持久化</h1>\n<h2 id=\"一-修改order-service服务\"><a class=\"anchor\" href=\"#一-修改order-service服务\">#</a> 一、修改 order-service 服务</h2>\n<p>修改 OrderService，让其监听 Nacos 中的 sentinel 规则配置。</p>\n<p>具体步骤如下：</p>\n<h3 id=\"1引入依赖\"><a class=\"anchor\" href=\"#1引入依赖\">#</a> 1. 引入依赖</h3>\n<p>在 order-service 中引入 sentinel 监听 nacos 的依赖：</p>\n<figure class=\"highlight xml\"><figcaption data-lang=\"XML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">></span></span>com.alibaba.csp<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">></span></span>sentinel-datasource-nacos<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">></span></span></pre></td></tr></table></figure><h3 id=\"2配置nacos地址\"><a class=\"anchor\" href=\"#2配置nacos地址\">#</a> 2. 配置 nacos 地址</h3>\n<p>在 order-service 中的 application.yml 文件配置 nacos 地址及监听的配置信息：</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">cloud</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token key atrule\">sentinel</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      <span class=\"token key atrule\">datasource</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token key atrule\">flow</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>          <span class=\"token key atrule\">nacos</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            <span class=\"token key atrule\">server-addr</span><span class=\"token punctuation\">:</span> localhost<span class=\"token punctuation\">:</span><span class=\"token number\">8848</span> <span class=\"token comment\"># nacos 地址</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token key atrule\">dataId</span><span class=\"token punctuation\">:</span> orderservice<span class=\"token punctuation\">-</span>flow<span class=\"token punctuation\">-</span>rules</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token key atrule\">groupId</span><span class=\"token punctuation\">:</span> SENTINEL_GROUP</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token key atrule\">rule-type</span><span class=\"token punctuation\">:</span> flow <span class=\"token comment\"># 还可以是：degrade、authority、param-flow</span></pre></td></tr></table></figure><h2 id=\"二-修改sentinel-dashboard源码\"><a class=\"anchor\" href=\"#二-修改sentinel-dashboard源码\">#</a> 二、修改 sentinel-dashboard 源码</h2>\n<p>SentinelDashboard 默认不支持 nacos 的持久化，需要修改源码。</p>\n<h3 id=\"1-解压\"><a class=\"anchor\" href=\"#1-解压\">#</a> 1. 解压</h3>\n<p>解压课前资料中的 sentinel 源码包：</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171644436.png\" alt=\"image-20210618201340086\" /></p>\n<p>然后并用 IDEA 打开这个项目，结构如下：</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171644159.png\" alt=\"image-20210618201412878\" /></p>\n<h3 id=\"2-修改nacos依赖\"><a class=\"anchor\" href=\"#2-修改nacos依赖\">#</a> 2. 修改 nacos 依赖</h3>\n<p>在 sentinel-dashboard 源码的 pom 文件中，nacos 的依赖默认的 scope 是 test，只能在测试时使用，这里要去除：</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171644823.png\" alt=\"image-20210618201607831\" /></p>\n<p>将 sentinel-datasource-nacos 依赖的 scope 去掉：</p>\n<figure class=\"highlight xml\"><figcaption data-lang=\"XML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">></span></span>com.alibaba.csp<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">></span></span>sentinel-datasource-nacos<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">></span></span></pre></td></tr></table></figure><h3 id=\"3-添加nacos支持\"><a class=\"anchor\" href=\"#3-添加nacos支持\">#</a> 3. 添加 nacos 支持</h3>\n<p>在 sentinel-dashboard 的 test 包下，已经编写了对 nacos 的支持，我们需要将其拷贝到 main 下。</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171644434.png\" alt=\"image-20210618201726280\" /></p>\n<h3 id=\"4-修改nacos地址\"><a class=\"anchor\" href=\"#4-修改nacos地址\">#</a> 4. 修改 nacos 地址</h3>\n<p>然后，还需要修改测试代码中的 NacosConfig 类：</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171644320.png\" alt=\"image-20210618201912078\" /></p>\n<p>修改其中的 nacos 地址，让其读取 application.properties 中的配置：</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171644820.png\" alt=\"image-20210618202047575\" /></p>\n<p>在 sentinel-dashboard 的 application.properties 中添加 nacos 地址配置：</p>\n<figure class=\"highlight properties\"><figcaption data-lang=\".properties\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key attr-name\">nacos.addr</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">localhost:8848</span></pre></td></tr></table></figure><h3 id=\"5-配置nacos数据源\"><a class=\"anchor\" href=\"#5-配置nacos数据源\">#</a> 5. 配置 nacos 数据源</h3>\n<p>另外，还需要修改 com.alibaba.csp.sentinel.dashboard.controller.v2 包下的 FlowControllerV2 类：</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171644684.png\" alt=\"w\" /></p>\n<p>让我们添加的 Nacos 数据源生效：</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171644334.png\" alt=\"image-20210618202334536\" /></p>\n<h3 id=\"6-修改前端页面\"><a class=\"anchor\" href=\"#6-修改前端页面\">#</a> 6. 修改前端页面</h3>\n<p>接下来，还要修改前端页面，添加一个支持 nacos 的菜单。</p>\n<p>修改 src/main/webapp/resources/app/scripts/directives/sidebar/ 目录下的 sidebar.html 文件：</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171644086.png\" alt=\"image-20210618202433356\" /></p>\n<p>将其中的这部分注释打开：</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171644031.png\" alt=\"image-20210618202449881\" /></p>\n<p>修改其中的文本：</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171644504.png\" alt=\"image-20210618202501928\" /></p>\n<h3 id=\"7-重新编译-打包项目\"><a class=\"anchor\" href=\"#7-重新编译-打包项目\">#</a> 7. 重新编译、打包项目</h3>\n<p>运行 IDEA 中的 maven 插件，编译和打包修改好的 Sentinel-Dashboard：</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171644941.png\" alt=\"image-20210618202701492\" /></p>\n<h3 id=\"8启动\"><a class=\"anchor\" href=\"#8启动\">#</a> 8. 启动</h3>\n<p>启动方式跟官方一样：</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">java</span> <span class=\"token parameter variable\">-jar</span> sentinel-dashboard.jar</pre></td></tr></table></figure><p>如果要修改 nacos 地址，需要添加参数：</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">java</span> <span class=\"token parameter variable\">-jar</span> <span class=\"token parameter variable\">-Dnacos.addr</span><span class=\"token operator\">=</span>localhost:8848 sentinel-dashboard.jar</pre></td></tr></table></figure>",
            "tags": [
                "计算机学科",
                "springcloud",
                "Sentinel",
                "持久化"
            ]
        }
    ]
}