{
    "version": "https://jsonfeed.org/version/1",
    "title": "homepage • All posts by \"nacos\" tag",
    "description": "欢迎来我的博客空间",
    "home_page_url": "https://pigpigletsgo.github.io/homepage",
    "items": [
        {
            "id": "https://pigpigletsgo.github.io/homepage/2024/03/24/computer-science/java/spring/springcloud/Nacos/%E6%A1%88%E4%BE%8B/%E6%8B%86%E5%88%86%E4%B8%8D%E5%90%8C%E9%85%8D%E7%BD%AE%E5%88%B0nacos%E5%B9%B6%E8%AF%BB%E5%8F%96%E4%B8%8D%E5%90%8C%E9%85%8D%E7%BD%AE%E5%88%B0%E9%A1%B9%E7%9B%AE/",
            "url": "https://pigpigletsgo.github.io/homepage/2024/03/24/computer-science/java/spring/springcloud/Nacos/%E6%A1%88%E4%BE%8B/%E6%8B%86%E5%88%86%E4%B8%8D%E5%90%8C%E9%85%8D%E7%BD%AE%E5%88%B0nacos%E5%B9%B6%E8%AF%BB%E5%8F%96%E4%B8%8D%E5%90%8C%E9%85%8D%E7%BD%AE%E5%88%B0%E9%A1%B9%E7%9B%AE/",
            "title": "拆分不同配置到nacos并读取不同配置到项目",
            "date_published": "2024-03-24T04:14:20.989Z",
            "content_html": "<h1 id=\"拆分不同配置到nacos并读取不同配置到项目\"><a class=\"anchor\" href=\"#拆分不同配置到nacos并读取不同配置到项目\">#</a> 拆分不同配置到 nacos 并读取不同配置到项目</h1>\n<p>先来看我们原先配置的内容：application.yml，服务名：gulimail-coupon</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">server</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">7000</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">datasource</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token key atrule\">driver-class-name</span><span class=\"token punctuation\">:</span> com.mysql.cj.jdbc.Driver</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token key atrule\">url</span><span class=\"token punctuation\">:</span> jdbc<span class=\"token punctuation\">:</span>mysql<span class=\"token punctuation\">:</span>//192.168.56.10<span class=\"token punctuation\">:</span>3306/gulimall_sms<span class=\"token punctuation\">?</span>characterEncoding=utf<span class=\"token punctuation\">-</span>8<span class=\"token important\">&amp;serverTimezone=UTC&amp;useUnicode=true</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token key atrule\">username</span><span class=\"token punctuation\">:</span> root</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token key atrule\">password</span><span class=\"token punctuation\">:</span> root</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token key atrule\">cloud</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token key atrule\">nacos</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token key atrule\">discovery</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token key atrule\">server-addr</span><span class=\"token punctuation\">:</span> 192.168.56.10<span class=\"token punctuation\">:</span><span class=\"token number\">8848</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token key atrule\">application</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> gulimail<span class=\"token punctuation\">-</span>coupon</pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token key atrule\">mybatis-plus</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token key atrule\">global-config</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token key atrule\">db-config</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      <span class=\"token key atrule\">id-type</span><span class=\"token punctuation\">:</span> auto</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token key atrule\">mapper-locations</span><span class=\"token punctuation\">:</span> classpath<span class=\"token punctuation\">:</span>/mapper/<span class=\"token important\">**/*.xml</span></pre></td></tr></table></figure><p>我们可以看到这个配置文件中，配置了数据源信息和 mybatis 还有其它的一些信息我们要将它们进行拆分分别配置到 nacos 中的同一个环境下不同的配置名称里面</p>\n<p>比如，如下：</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/image-20240324113845358.png\" alt=\"image-20240324113845358\" /></p>\n<p>我们将 数据源相关配置信息配置到如下中：</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/image-20240324113916733.png\" alt=\"image-20240324113916733\" /></p>\n<p>我们将 mybatis 相关配置信息配置到如下中：</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/image-20240324113916733.png\" alt=\"\" /></p>\n<p>我们将其它的配置信息配置到如下中：</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/image-20240324114009300.png\" alt=\"image-20240324114009300\" /></p>\n<p>我们把这些个配置信息都分开配置了，那我们如何在代码中进行获取呢？如下演示：</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">application</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> gulimail<span class=\"token punctuation\">-</span>coupon</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">cloud</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token key atrule\">nacos</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      <span class=\"token key atrule\">config</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token key atrule\">server-addr</span><span class=\"token punctuation\">:</span> 192.168.56.10<span class=\"token punctuation\">:</span><span class=\"token number\">8848</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token key atrule\">file-extension</span><span class=\"token punctuation\">:</span> yaml</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> 2d9e9ebf<span class=\"token punctuation\">-</span>1b0f<span class=\"token punctuation\">-</span>43d0<span class=\"token punctuation\">-</span>9fc8<span class=\"token punctuation\">-</span>d7d50057c193</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token key atrule\">ext-config</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">data-id</span><span class=\"token punctuation\">:</span> datasource.yaml</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            <span class=\"token key atrule\">group</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            <span class=\"token key atrule\">refresh</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">data-id</span><span class=\"token punctuation\">:</span> mybatis.yaml</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            <span class=\"token key atrule\">group</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            <span class=\"token key atrule\">refresh</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">data-id</span><span class=\"token punctuation\">:</span> other.yaml</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            <span class=\"token key atrule\">group</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            <span class=\"token key atrule\">refresh</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span></pre></td></tr></table></figure><p>我们可以通过 ext-config (扩展配置) 来进行读取 nacos 中不同的配置内容</p>\n",
            "tags": [
                "计算机学科",
                "项目",
                "案例Demo",
                "springcloud",
                "Nacos"
            ]
        },
        {
            "id": "https://pigpigletsgo.github.io/homepage/2024/01/24/computer-science/java/spring/springcloud/Nacos/springcloud-Nacos%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83/",
            "url": "https://pigpigletsgo.github.io/homepage/2024/01/24/computer-science/java/spring/springcloud/Nacos/springcloud-Nacos%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83/",
            "title": "四、Nacos注册中心",
            "date_published": "2024-01-24T10:48:46.208Z",
            "content_html": "<h2 id=\"四-nacos注册中心\"><a class=\"anchor\" href=\"#四-nacos注册中心\">#</a> 四、Nacos 注册中心🎄</h2>\n<ul>\n<li>认识和安装 Nacos</li>\n<li>Nacos 快速入门</li>\n<li>Nacos 服务分级存储模型</li>\n<li>Nacos 环境隔离</li>\n</ul>\n<h3 id=\"41-认识nacos\"><a class=\"anchor\" href=\"#41-认识nacos\">#</a> 4.1、认识 Nacos🌳</h3>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL25hY29zLmlvL3poLWNuLw==\">Nacos</span> 是阿里巴巴的产品，现在是<span class=\"exturl\" data-url=\"aHR0cHM6Ly9zcHJpbmcuaW8vcHJvamVjdHMvc3ByaW5nLWNsb3Vk\"> SpringCloud</span> 中的一个组件。相比<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL05ldGZsaXgvZXVyZWth\"> Eureka</span> 功能更加丰富，在国内受欢迎程度较高。</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051155062.png\" alt=\"image-20231005115513961\" /></p>\n<p><strong>安装和启动教程详细查看</strong>：<a href=\"Nacos/Nacos%E5%AE%89%E8%A3%85%E6%8C%87%E5%8D%97.md\">点击查看</a>.</p>\n<h3 id=\"42-服务注册到nacos\"><a class=\"anchor\" href=\"#42-服务注册到nacos\">#</a> 4.2、服务注册到 Nacos🌳</h3>\n<p>1、在 cloud-demo 父工程中添加 spring-cloud-alibaba 的管理依赖：</p>\n<figure class=\"highlight xml\"><figcaption data-lang=\"XML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">&lt;!--nacos 管理依赖 --></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">></span></span>com.alibaba.cloud<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">></span></span>spring-cloud-alibaba-dependencies<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>version</span><span class=\"token punctuation\">></span></span>2.2.5.RELEASE<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>version</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>type</span><span class=\"token punctuation\">></span></span>pom<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>type</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>scope</span><span class=\"token punctuation\">></span></span>import<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>scope</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">></span></span></pre></td></tr></table></figure><p>2、注释掉 order-service 和 user-service 中原有的 eureka 依赖。</p>\n<p>3、添加 nacos 的客户端依赖：</p>\n<figure class=\"highlight xml\"><figcaption data-lang=\"XML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">&lt;!-- nacos 客户端依赖包 --></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">></span></span>com.alibaba.cloud<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">></span></span>spring-cloud-starter-alibaba-nacos-discovery<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">></span></span></pre></td></tr></table></figure><p>4、修改 user-service &amp; order-service 中的 application.yml 文件，注释 eureka 地址，添加 nacos 地址：</p>\n<figure class=\"highlight yml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">cloud</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token key atrule\">nacos</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      <span class=\"token key atrule\">server-addr</span><span class=\"token punctuation\">:</span> localhost<span class=\"token punctuation\">:</span><span class=\"token number\">8848</span> <span class=\"token comment\"># nacos 服务地址</span></pre></td></tr></table></figure><p><mark>PS</mark>：在当前启动类中添加注解：@EnableDiscoveryClient (服务发现)</p>\n<p>5、启动并测试</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051308798.png\" alt=\"image-20231005130842602\" /></p>\n<blockquote>\n<p><strong>总结</strong>：</p>\n<ol>\n<li>Nacos 服务搭建\n<ol>\n<li>下载安装包</li>\n<li>解压</li>\n<li>在 bin 目录下运行指令：startup.cmd -m standalone</li>\n</ol>\n</li>\n<li>Nacos 服务注册或发现\n<ol>\n<li>引入 nacos.discovery 依赖</li>\n<li>配置 nacos 地址 spring.cloud.nacos.server-addr</li>\n<li>在当前启动类中添加 @EnableDiscoveryClient 注解，用于服务发现</li>\n</ol>\n</li>\n</ol>\n</blockquote>\n<h3 id=\"43-nacos服务分级存储模型\"><a class=\"anchor\" href=\"#43-nacos服务分级存储模型\">#</a> 4.3、Nacos 服务分级存储模型🌳</h3>\n<p><strong>服务</strong>：提供用户查询的 user service ，提供订单查询的 order-service 都叫<mark>服务</mark>.</p>\n<p>user-service 还部署了多个实例：8081，8082，8083</p>\n<p>所以我们之前是分为两层概念的：</p>\n<p>一层是服务，而第二层就是实例，一个服务可以包含多个实例</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051420619.png\" alt=\"image-20231005142022420\" /></p>\n<p>不过随着业务规模越来越扩大，那么我们就要考虑更多的问题了。</p>\n<blockquote>\n<p>比如说我们把所有的实例都部署到一个机房，这就像把所有的鸡蛋都放到一个篮子里一样，不小心将篮子打翻了那么里面所有的蛋也就全部都打了，如果是机房哪天天灾人祸出了事儿，那这整个服务不就完了。所以为了解决这个问题我们会将一个服务的多个实例部署到多个机房。</p>\n</blockquote>\n<p>特别像阿里巴巴，京东这样的大公司，给全国各地都整一个。这就像我们把鸡蛋分散开了，一个打了我还有好几篮子呢。</p>\n<p>这样就能做到一种叫 <strong>容灾</strong>.</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051425151.png\" alt=\"image-20231005142511407\" /></p>\n<p>而 Nacos 服务分级存储模型就是引入了这样一个机房的概念或者叫地域的概念。它把同在一个机房的多个实例称为一个集群</p>\n<p>比如说：杭州两个机房的 userService 实例就称之为杭州的 userService 集群</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051430517.png\" alt=\"image-20231005143046790\" /></p>\n<p>所以在 Nacos 服务分级存储模型中一级是服务往下是集群再往下就是实例</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051432046.png\" alt=\"image-20231005143242380\" /></p>\n<p><strong>为什么 Nacos 要引入这样的一个服务分级的模型呢？我原来直接用服务找实例不好吗？为什么要多加一个地域划分集群的一个概念？</strong></p>\n<h4 id=\"431-服务跨集群调用问题\"><a class=\"anchor\" href=\"#431-服务跨集群调用问题\">#</a> 4.3.1、服务跨集群调用问题🌲</h4>\n<p>我们设想这样一种情况：</p>\n<p>比方说 我有一个杭州的机房里面有 order-service 集群还有 user-service 的集群。还有还有一个上海的机房里面也是同样的配置</p>\n<p>现在，order-service 需要访问 user-service 那么有两种选择：一种是在自己本地局域网内访问，另一种是去外面机房访问</p>\n<p>局域网内访问速度比较快，延迟比较低</p>\n<blockquote>\n<p>服务调用尽可能选择本地集群的服务，跨集群调用延迟较高</p>\n<p>本地集群不可访问时，再去访问其它集群</p>\n</blockquote>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051442382.png\" alt=\"image-20231005144140180\" /></p>\n<p>但是现在我们还没有配置集群属性，看下 nacos 控制台</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051506788.png\" alt=\"image-20231005150616402\" /></p>\n<p>可以看到集群名称为：Default 默认，没有集群</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051507220.png\" alt=\"image-20231005150745644\" /></p>\n<h3 id=\"44-服务集群属性\"><a class=\"anchor\" href=\"#44-服务集群属性\">#</a> 4.4、服务集群属性🌳</h3>\n<p>1、修改 application.yml，添加如下内容：</p>\n<figure class=\"highlight yml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">cloud</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token key atrule\">nacos</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      <span class=\"token key atrule\">server-addr</span><span class=\"token punctuation\">:</span> localhost<span class=\"token punctuation\">:</span><span class=\"token number\">8848</span> <span class=\"token comment\"># nacos 服务端地址</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      <span class=\"token key atrule\">discovery</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token key atrule\">cluster-name</span><span class=\"token punctuation\">:</span> HZ <span class=\"token comment\"># 配置集群名称，也就是机房位置，这里 HZ 代指杭州</span></pre></td></tr></table></figure><p>2、我们创建两个服务来模拟演示集群三个分别代表不同的位置</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051510774.png\" alt=\"image-20231005151045217\" /></p>\n<p>具体的操作步骤看动图：</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051518637.gif\" alt=\"test\" /></p>\n<p>3、查看 nacos 的情况</p>\n<p>可以看到成功启动了三个集群</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051513016.png\" alt=\"image-20231005151355371\" /></p>\n<p>查看详细，别分是不同的位置的集群</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051515250.png\" alt=\"image-20231005151517180\" /></p>\n<blockquote>\n<p><strong>总结</strong>：</p>\n<ol>\n<li>Nacos 服务分级存储模型\n<ol>\n<li>一级是服务，例如 userservice</li>\n<li>二级是集群，例如杭州或上海</li>\n<li>三级是实例，例如杭州机房的某台部署了 userservice 的服务器</li>\n</ol>\n</li>\n<li>如何设置实例的集群属性\n<ol>\n<li>修改 application.yml 文件，添加 spring.cloud.nacos.discovery.cluster-name 属性即可</li>\n</ol>\n</li>\n</ol>\n</blockquote>\n<p>我们将 user-service 的 8081 服务和 8082 服务还有 8083 服务分别设置到了不同位置的集群但是我们最终想要实现的是 order-service 远程调用 user-service 时，优先选择本地集群。那因此呢我们还需要给 order-service 也配置一个集群属性</p>\n<h4 id=\"441-根据集群负载均衡\"><a class=\"anchor\" href=\"#441-根据集群负载均衡\">#</a> 4.4.1、根据集群负载均衡🌲</h4>\n<p>1、在 order-service 服务中的 application.yml 中进行配置</p>\n<figure class=\"highlight yml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">cloud</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token key atrule\">nacos</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      <span class=\"token key atrule\">server-addr</span><span class=\"token punctuation\">:</span> localhost<span class=\"token punctuation\">:</span><span class=\"token number\">8848</span> <span class=\"token comment\"># nacos 服务端地址</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      <span class=\"token key atrule\">discovery</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token key atrule\">cluster-name</span><span class=\"token punctuation\">:</span> HZ <span class=\"token comment\"># 配置集群名称，也就是机房位置，这里 HZ 代指杭州</span></pre></td></tr></table></figure><p>配置完成后启动 order-service 服务</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051531329.png\" alt=\"image-20231005153152984\" /></p>\n<p>查看 nacos 信息 order-service 是否与 user-service 处于 HZ 集群</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051533345.png\" alt=\"image-20231005153349541\" /></p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051534369.png\" alt=\"image-20231005153426289\" /></p>\n<p>2、然后在 order-service 中设置负载均衡的 IRule 为 NacosRule，这个规则优先会寻找与自己同集群的服务：</p>\n<figure class=\"highlight yml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 给指定的微服务进行集群负载均衡的配置</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">userservice</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token key atrule\">ribbon</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token key atrule\">NFLoadBalancerRuleClassName</span><span class=\"token punctuation\">:</span> com.alibaba.cloud.nacos.ribbon.NacosRule <span class=\"token comment\"># 负载均衡规则</span></pre></td></tr></table></figure><p>3、访问 order-service 服务 3 次查看轮询结果</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051630022.gif\" alt=\"test\" /></p>\n<p>访问第一次：</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>http://127.0.0.1:8080/order/101</pre></td></tr></table></figure><p>访问第二次：</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>http://127.0.0.1:8080/order/102</pre></td></tr></table></figure><p>访问第三次：</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>http://127.0.0.1:8080/order/103</pre></td></tr></table></figure><p>8081</p>\n<pre><code>Creating a new SqlSession\nSqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@20d32e8c] was not registered for synchronization because synchronization is not active\nJDBC Connection [HikariProxyConnection@773117158 wrapping com.mysql.cj.jdbc.ConnectionImpl@1a9c99e4] will not be managed by Spring\n==&gt;  Preparing: select * from tb_user where id = ? \n==&gt; Parameters: 1(Long)\n&lt;==    Columns: id, username, address\n&lt;==        Row: 1, 柳岩, 湖南省衡阳市\n&lt;==      Total: 1\nClosing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@20d32e8c]\nCreating a new SqlSession\nSqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@4c31c2cf] was not registered for synchronization because synchronization is not active\nJDBC Connection [HikariProxyConnection@1123427641 wrapping com.mysql.cj.jdbc.ConnectionImpl@1a9c99e4] will not be managed by Spring\n==&gt;  Preparing: select * from tb_user where id = ? \n==&gt; Parameters: 2(Long)\n&lt;==    Columns: id, username, address\n&lt;==        Row: 2, 文二狗, 陕西省西安市\n&lt;==      Total: 1\nClosing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@4c31c2cf]\nCreating a new SqlSession\nSqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@16810291] was not registered for synchronization because synchronization is not active\nJDBC Connection [HikariProxyConnection@407305777 wrapping com.mysql.cj.jdbc.ConnectionImpl@1a9c99e4] will not be managed by Spring\n==&gt;  Preparing: select * from tb_user where id = ? \n==&gt; Parameters: 3(Long)\n&lt;==    Columns: id, username, address\n&lt;==        Row: 3, 华沉鱼, 湖北省十堰市\n&lt;==      Total: 1\nClosing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@16810291]\n</code></pre>\n<p>8082</p>\n<pre><code></code></pre>\n<p>8083</p>\n<pre><code></code></pre>\n<p>可以看到优先选择的是本地集群的服务，但是也会有可能选择远程的集群。</p>\n<p>它并不是轮询调用本机集群或者远程集群而是一种没有规律的随机的调用方式</p>\n<p>如果说 user-service:8081 这个服务挂掉了呢？ 将 8081 关闭我们再次访问</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051635074.png\" alt=\"image-20231005163505936\" /></p>\n<p>此时 8083 就被请求了打印出了消息</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051635696.png\" alt=\"image-20231005163557083\" /></p>\n<p>但是在 order-service 中控制台中就会打印一个警告</p>\n<p>警告的意思就是：发生了一次跨集群的访问 order-service 访问 user-service 位置为 HZ 的集群但是却访问了 SH</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051637118.png\" alt=\"image-20231005163756874\" /></p>\n<p>通过这次测试我们得出 NacosRule 它其实优先访问的是本地，本地没有它才会进行跨集群访问，而跨集群就会发出一次警告</p>\n<p>3、注意将 user-service 的权重都设置为 1</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051641100.png\" alt=\"image-20231005164127314\" /></p>\n<blockquote>\n<p><strong>总结</strong>：</p>\n<ol>\n<li>NacosRule 负载均衡策略\n<ol>\n<li>优先选择同集群服务实例列表</li>\n<li>本地集群找不到提供者，才去其它集群寻找，并且会报警告</li>\n<li>确定了可用实例列表后，再采用随机负载均衡挑选实例</li>\n</ol>\n</li>\n</ol>\n</blockquote>\n<h4 id=\"442-根据权重负载均衡\"><a class=\"anchor\" href=\"#442-根据权重负载均衡\">#</a> 4.4.2、根据权重负载均衡🌲</h4>\n<blockquote>\n<p>上集，我们学习了 Nacos 的负载均衡的一种规则 NacosRule，它可以做到<mark>集群优先的负载均衡</mark>。不过我们部署的时候可能出现这样的情况，由于企业设备会更新迭代有些机器性能比较好，还有一些属于是祖传设备了性能非常差，可以说老弱病残。这时候我们肯定希望这些性能好的机器它承担更多的用户请求，而哪些性能差一点的自然承担少一点的用户请求。但是我们目前看来 NacosRule 做到的是集群优先而后做随机。当用户请求完了以后它可不会管你机器性能好还是差的拉过来就是一顿叫这时性能差的机器肯定就出问题了。</p>\n<p>那么我们要怎么去控制不同服务它请求的量呢？</p>\n<p>Nacos 给我们提供了一种权重的配置</p>\n</blockquote>\n<p><strong>实际部署中会出现这样的场景</strong>：</p>\n<ul>\n<li>服务器设备性能有差异，部分实例所在机器性能较好，另一些较差，我们希望性能好的机器承担更多的用户请求</li>\n</ul>\n<p>Nacos 提供了权重配置来控制访问频率，权重越大则访问频率越高</p>\n<h4 id=\"443-权重配置操作\"><a class=\"anchor\" href=\"#443-权重配置操作\">#</a> 4.4.3、权重配置操作：🌲</h4>\n<p>1、在 Nacos 控制台可以设置实例的权重值，首先选中实例后面的编辑按钮</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051655722.png\" alt=\"image-20231005165528544\" /></p>\n<p>2、将权重设置为 0.1，测试可以发现 8081 被访问到的频率大大降低</p>\n<p>权重值配置范围：0 ~ 1</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051656163.png\" alt=\"image-20231005165622001\" /></p>\n<p>查看下目前的集群情况</p>\n<p>order-service</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051659631.png\" alt=\"image-20231005165920414\" /></p>\n<p>user-service</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051700588.png\" alt=\"image-20231005170021931\" /></p>\n<p>在没有配置权重值都是相同的情况下访问 3 次 order-service 打印的信息如下</p>\n<p>user-service:8081 打印了全部的信息，8082,8083 都没有</p>\n<p>我们将 8081 这个集群的权重值设置为 0 在进行测试</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051940128.png\" alt=\"image-20231005194035918\" /></p>\n<p>访问 order-service 刷新页面 10 次打印的信息如下</p>\n<p>8081 没有信息，8082 有信息，8083 有信息</p>\n<blockquote>\n<p><strong>总结</strong>：</p>\n<ol>\n<li>实例的权重控制\n<ol>\n<li>Nacos 控制台可以设置实例的权重值，0 ~ 1 之间</li>\n<li>同集群内的多个实例，权重越高被访问的频率越高</li>\n<li>权重设置为 0 则完全不会被访问</li>\n</ol>\n</li>\n</ol>\n</blockquote>\n<h3 id=\"45-环境隔离-namespace\"><a class=\"anchor\" href=\"#45-环境隔离-namespace\">#</a> 4.5、环境隔离 - namespace🌳</h3>\n<p>Nacos 中服务存储和数据存储的最外层都是一个名为 namespace 的东西，用来做最外层隔离</p>\n<blockquote>\n<p>将来可以有多个 namespace 可以理解为多个蛋，相互之间是隔离开的，在 namespace 内部有一个 group 属性。也就是说同一个命名空间的多个东西我们将来还可以分组，组内就是具体的东西了。比如说服务，服务再往下就是集群，再往下就是实例。</p>\n</blockquote>\n<p>这里我们的环境隔离其实就是在对服务做隔离</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310052013655.png\" alt=\"image-20231005201313765\" /></p>\n<p>为什么需要隔离呢？</p>\n<p>服务划分，实例划分这是基于业务去做的划分或者是地域但事实上我们还会有开发环境，生产环境，测试环境的变化所以我们会基于这种环境变化去做隔离。</p>\n<p>我们可以吧业务相关度比较高的放在一组中</p>\n<p>1、在 Nacos 控制台可以创建 namespace，用来隔离不同环境</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310052024412.png\" alt=\"image-20231005202456034\" /></p>\n<p>2、然后填写一个新的命名空间信息</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310052025744.png\" alt=\"image-20231005202536537\" /></p>\n<p>3、保存后会在控制台看到这个命名空间的 id</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310052026832.png\" alt=\"image-20231005202632739\" /></p>\n<p>4、修改 order-service 的 application.yml，添加 namespace</p>\n<figure class=\"highlight yml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">datasource</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token key atrule\">url</span><span class=\"token punctuation\">:</span> jdbc<span class=\"token punctuation\">:</span>mysql<span class=\"token punctuation\">:</span>//localhost<span class=\"token punctuation\">:</span>3306/cloud_user<span class=\"token punctuation\">?</span>useSSL=false<span class=\"token important\">&amp;characterEncoding=utf-8&amp;serverTimezone=UTC</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token key atrule\">username</span><span class=\"token punctuation\">:</span> root</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token key atrule\">password</span><span class=\"token punctuation\">:</span> dkx.</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token key atrule\">driver-class-name</span><span class=\"token punctuation\">:</span> com.mysql.cj.jdbc.Driver</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token key atrule\">application</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> userservice</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token key atrule\">cloud</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token key atrule\">nacos</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token key atrule\">server-addr</span><span class=\"token punctuation\">:</span> localhost<span class=\"token punctuation\">:</span><span class=\"token number\">8848</span> <span class=\"token comment\"># nacos 服务端地址</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token key atrule\">discovery</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token key atrule\">cluster-name</span><span class=\"token punctuation\">:</span> TJ <span class=\"token comment\"># 集群名称，这里 HZ 代指杭州</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> ed32fa6f<span class=\"token punctuation\">-</span>e9e3<span class=\"token punctuation\">-</span>4483<span class=\"token punctuation\">-</span>b860<span class=\"token punctuation\">-</span>7bcd9731d0d9 <span class=\"token comment\"># 命名空间，填 ID</span></pre></td></tr></table></figure><p>5、刷新 nacos 页面</p>\n<p>order-service 就不在 public 中了</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310052032144.png\" alt=\"image-20231005203254198\" /></p>\n<p>而是到了 dev 中了，它们两个已经不是同一个位置的服务了</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310052033504.png\" alt=\"image-20231005203322946\" /></p>\n<p>我们访问的话就会报错：</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310052034062.png\" alt=\"image-20231005203400951\" /></p>\n<p><strong>idea 控制台报错提示为</strong>：&lt;font color='red'&gt; 找不到可用的实例 &lt;/font&gt;.</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310052034175.png\" alt=\"image-20231005203453936\" /></p>\n<p>所以要想让服务可以访问必须是同一个环境下</p>\n<blockquote>\n<p><strong>总结</strong>：</p>\n<ol>\n<li>Nacos 环境隔离\n<ol>\n<li>namespace 用来做环境隔离</li>\n<li>每个 namespace 都有唯一 id</li>\n<li>不同 namespace 下的服务不可见\n<ul>\n<li>如果想要两个服务可以访问必须把它们放到同一个 namespace 下</li>\n</ul>\n</li>\n</ol>\n</li>\n</ol>\n</blockquote>\n<h3 id=\"46-nacos注册中心细节分析\"><a class=\"anchor\" href=\"#46-nacos注册中心细节分析\">#</a> 4.6、nacos 注册中心细节分析🌳</h3>\n<p>服务提供者在启动时，都会把自己的信息提交给注册中心。而注册中心就会把这些信息保留下来</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310052039311.png\" alt=\"image-20231005203942965\" /></p>\n<p>当服务消费者要消费时它就可以去找注册中心拉取服务信息了。不过这个拉取的动作不是每一次都要做的它会将拉取到的服务信息缓存到一个列表中</p>\n<p>当然如果缓存一直不更新也是不行的万一服务提供者信息变化了呢，所以这个列表会每隔 30 秒重新拉取一次，进行一个更新</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310052042295.png\" alt=\"image-20231005204255542\" /></p>\n<p>消费者拿到服务列表以后再去负载均衡挑选一个发起远程调用就可以了</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310052045232.png\" alt=\"image-20231005204549665\" /></p>\n<p>但是 nacos 与 eureka 还是有一些差别，差别就在于服务提供者的健康检测</p>\n<p>nacos 会把<mark>服务提供者划分成</mark><strong>临时实例</strong>和<strong>非临时实例</strong>。</p>\n<p>在 nacos 页面中挑选一个服务查看 详情就可以看到 临时实例还是非临时实例了</p>\n<p>如下图，nacos 中默认就是临时实例，而临时实例与非临时实例在 nacos 中做健康监测是不一样的</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310052048533.png\" alt=\"image-20231005204834080\" /></p>\n<h4 id=\"461-临时实例\"><a class=\"anchor\" href=\"#461-临时实例\">#</a> 4.6.1、临时实例🌲</h4>\n<p>临时实例，听其名认为它是将来可能人为的把服务停掉的，所以它在 nacos 中做健康监测时采用的是心跳检测</p>\n<p>如果服务提供者心跳不跳了超过时间就会被 nacos 从服务列表中剔除</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310052051280.png\" alt=\"image-20231005205144644\" /></p>\n<h4 id=\"462-非临时实例\"><a class=\"anchor\" href=\"#462-非临时实例\">#</a> 4.6.2、非临时实例🌲</h4>\n<blockquote>\n<p>非临时实例中 nacos 不会去做心跳，那么这时健康监测是怎么监测的呢？</p>\n<p>是由 nacos 主动发请求去询问服务提供者：“诶！你还活着吗？”，如果它没回应 nacos 并不会将它从服务列表中剔除而是标记为不健康了，它们等着这个服务恢复健康</p>\n</blockquote>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310052056840.png\" alt=\"image-20231005205645566\" /></p>\n<p>这是一个 nacos 与 eureka 之间的差别，但是还有一个差别在于消费者</p>\n<p>eureka 采用的是定时拉取每隔 30 秒拉取一次，如果有服务提供者在 30 秒内挂掉了那消费者不知道吧，它不知道提供者挂了还直接去消费就会出问题了。</p>\n<p>所以 eureka 做服务定时拉取它服务列表更新的这个效率比较差 (更新不够及时)</p>\n<p>而 nacos 它做了一个叫推送消息。也就是 eureka 采用的是 pull，而 nacos 采用的是 pull+push 两者结合</p>\n<p>假设 nacos 发现服务提供者挂了，它就会立即发送一条消息推送给我们的服务消费者，然后服务消费者就赶紧更新</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310052101513.png\" alt=\"image-20231005210145076\" /></p>\n<p>这就是 eureka 与 nacos 之间的一些差别了！</p>\n<h4 id=\"463-临时实例和非临时实例\"><a class=\"anchor\" href=\"#463-临时实例和非临时实例\">#</a> 4.6.3、临时实例和非临时实例🌲</h4>\n<p>服务注册到 nacos 时，可以选择注册为临时实例或非临时实例，通过下面的配置来设置：</p>\n<figure class=\"highlight yml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">cloud</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token key atrule\">nacos</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      <span class=\"token key atrule\">server-addr</span><span class=\"token punctuation\">:</span> localhost<span class=\"token punctuation\">:</span><span class=\"token number\">8848</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      <span class=\"token key atrule\">discovery</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token key atrule\">ephemeral</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span> <span class=\"token comment\"># 设置是否为临时实例 设置为非临时实例</span></pre></td></tr></table></figure><p>临时实例宕机时，会从 nacos 的服务列表中剔除，而非临时实例则不会</p>\n<p>​\t在 order-service 中进行配置为非临时实例，再去 nacos 中查看 orderservice 的详情</p>\n<p>可以看到临时实例为 false，表示为非临时实例了</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310052131922.png\" alt=\"image-20231005213059792\" /></p>\n<p>这时我们将 order-service 服务停掉</p>\n<p>由于是非临时实例，就算服务提供者挂掉了 注册中心 也不会将其从服务列表中剔除掉，标红表示这个服务挂掉了</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310052132484.png\" alt=\"image-20231005213247819\" /></p>\n<p>如果改为临时实例</p>\n<figure class=\"highlight yml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">cloud</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token key atrule\">nacos</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      <span class=\"token key atrule\">server-addr</span><span class=\"token punctuation\">:</span> localhost<span class=\"token punctuation\">:</span><span class=\"token number\">8848</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      <span class=\"token key atrule\">discovery</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token key atrule\">ephemeral</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span> <span class=\"token comment\"># 设置是否为临时实例 设置为非临时实例</span></pre></td></tr></table></figure><p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310052134138.png\" alt=\"image-20231005213417852\" /></p>\n<p>我们再次将 order-service 服务停掉，然后再刷新页面或者返回到这个页面时发现关掉的服务被 注册中心 给剔除掉了不在服务列表中了。</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310052134361.png\" alt=\"image-20231005213452133\" /></p>\n<h5 id=\"4631-cap理论\"><a class=\"anchor\" href=\"#4631-cap理论\">#</a> 4.6.3.1、CAP 理论🌴</h5>\n<p>C 一致性，A 高可用，P 分区容错性</p>\n<ul>\n<li>\n<p>eureka 只支持 AP</p>\n</li>\n<li>\n<p>nacos 支持 CP 和 AP 两种</p>\n<p>nacos 是根据配置识别 CP 或 AP 模式，如果注册 Nacos 的 client 节点注册时是 ephemeral=true 即为临时节点，那么 Nacos 集群对这个 client 节点效果就是 AP，反之则是 CP，既不是临时节点</p>\n</li>\n</ul>\n<blockquote>\n<p><strong>总结</strong>：</p>\n<ol>\n<li>Nacos 与 eureka 的共同点\n<ol>\n<li>都支持服务注册和服务拉取</li>\n<li>都支持服务提供者心跳方式做健康检测</li>\n</ol>\n</li>\n<li>Nacos 与 Eureka 的区别\n<ol>\n<li>Nacos 支持服务端主动检测提供者状态：\n<ol>\n<li>临时实例采用心跳模式</li>\n<li>非临时实例采用主动检测模式</li>\n</ol>\n</li>\n<li>临时实例心跳不正常会被剔除，非临时实例则不会被剔除 (除非手动删除)</li>\n<li>Nacos 支持服务列表变更的消息推送模式，服务列表更新及时</li>\n<li>Nacos 集群默认采用 AP 方式，当集群中存在非临时实例时，采用 CP 模式；Eureka 采用 AP 方式</li>\n</ol>\n</li>\n</ol>\n</blockquote>\n<h3 id=\"47-nacos配置管理\"><a class=\"anchor\" href=\"#47-nacos配置管理\">#</a> 4.7、Nacos 配置管理🌳</h3>\n<ul>\n<li>统一配置管理</li>\n<li>配置热更新</li>\n<li>配置共享</li>\n<li>搭建 Naocs 集群</li>\n</ul>\n<h4 id=\"471-统一配置管理\"><a class=\"anchor\" href=\"#471-统一配置管理\">#</a> 4.7.1、统一配置管理🌲</h4>\n<p>上面学习我们搭建了两个微服务，每个服务里面的业务都需要完成数据库的查询，并且服务之间还会有一个相互调用。而完成相互调用我们的做法是让服务注册到注册中心，然后消费者就可以从注册中心完成服务的发现，实现服务获取和负载均衡。完成远程调用</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310060840065.png\" alt=\"image-20231006084042876\" /></p>\n<p>那么随着我们微服务越来越多，我们在生产环境中可能会达到数十上百甚至上千台服务器的情况，这时就有一个问题。</p>\n<p>&lt;font color='red'&gt;<strong> 问题一</strong> &lt;/font&gt;：如果我们修改一个配置文件而这个配置文件可能跟我数十上百个微服务都有关系，那这个时候我是不是要逐个微服务去调整配置呢？</p>\n<p>这样很麻烦。</p>\n<p>&lt;font color='red'&gt;<strong> 问题二</strong> &lt;/font&gt;：修改配置后这些关联的服务是不是都需要重启啊</p>\n<p>所以我们的需求就是可以将配置文件进行<mark>统一的管理</mark>.</p>\n<p><strong>统一管理</strong>：我不需要修改数十上百个微服务的配置文件而是只需要修改一个地方的配置文件就可以了。</p>\n<ul>\n<li>\n<p><strong>配置更改热更新</strong>.</p>\n<p>希望配置更改后不需要重启，而可以立马生效这就是 <mark>配置更改热更新</mark>.</p>\n</li>\n</ul>\n<p>而要实现 “配置更改热更新” 我们就需要一个 “配置管理服务”</p>\n<blockquote>\n<p><strong>配置管理服务的作用</strong>：</p>\n<p>会去记录微服务中的一些核心的配置，那么微服务启动的时候就可以去读取 <mark>配置管理服务</mark> 中的配置再和本地的配置结合作为完整配置去使用了。将来如果配置要发生修改我们不需要逐个服务修改，而是找到 <mark>配置管理服务</mark> 在它上面把需要修改的配置修改一下，<mark>配置管理服务</mark> 发现配置修改了以后它会立即<mark>通知微服务</mark>，微服务再去读取 <mark>配置管理服务</mark> 中修改后的配置文件并且不用重启进行热更新生效</p>\n</blockquote>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310060900914.png\" alt=\"image-20231006090015625\" /></p>\n<p>我们使用的是 nacos 的配置管理，而我们知道 nacos 已经有注册中心功能了。所以我们配置中心也好，注册中心也好，同时都是由 nacos 去实现的。</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310060902958.png\" alt=\"image-20231006090222743\" /></p>\n<p>1、在 Nacos 中添加配置信息：</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310060916710.png\" alt=\"image-20231006091626481\" /></p>\n<p>2、在弹出表单中填写配置信息：</p>\n<p>&lt;font color='red'&gt; 注意项 &lt;/font&gt;：</p>\n<ol>\n<li>DataId：需要具备唯一性</li>\n<li>配置内容：只需要配置有热更新需求的内容而不是将服务中配置文件的内容全拷贝进去</li>\n</ol>\n<p>填写完毕后，点击发布</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061049488.png\" alt=\"image-20231006104947319\" /></p>\n<p>3、发布完成后返回查看</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310060915386.png\" alt=\"image-20231006091517632\" /></p>\n<p>先看如下图 没有 Nacos 时服务如何获取配置，配置获取的步骤如下：</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310060921217.png\" alt=\"image-20231006092110607\" /></p>\n<p>上面流程中读取的是本地的配置文件，但现在我们多了一个东西就是 nacos 中的配置文件。</p>\n<p>将来我们的项目会把 nacos 的配置与本地配置做一个合并而后再去完成后续的容器创建 bean 的创建动作。</p>\n<p>所以 nacos 读取要加入到上面流程当中那么就会变成如下的步骤：</p>\n<p>项目启动先读取 nacos 配置文件再去读取本地配置文件两者合并最后创建 bean</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310060925392.png\" alt=\"image-20231006092504157\" /></p>\n<p>&lt;font color='red'&gt; 问题 &lt;/font&gt;：</p>\n<ul>\n<li><strong>第一</strong>：去哪读取</li>\n<li><strong>第二</strong>：读取谁</li>\n</ul>\n<p>我们读取 nacos 配置文件时需要提前知道 nacos 的地址，那么需要一个启动优先级高于 application.yml 的东西来存储 nacos 地址。</p>\n<p>此时，可以使用 “bootstrap.yml” 配置文件，这是 SpringBoot 中提供的。这个文件的优先级高于 application.yml</p>\n<p>当项目启动优先读取 “bootstrap.yml” 配置文件，我们只要把 nacos 地址，文件相关信息都配置进去那么它就可以完成 nacos 配置的读取了。而后再跟本地结合完成后续动作</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310060930844.png\" alt=\"image-20231006093027358\" /></p>\n<p><strong>那么就需要注意了</strong>：</p>\n<ul>\n<li><mark>与 nacos 地址和配置文件有关的所有信息都应该放到 “bootstrap.yml” 当中</mark>。</li>\n</ul>\n<h4 id=\"472-操作步骤\"><a class=\"anchor\" href=\"#472-操作步骤\">#</a> 4.7.2、操作步骤：🌲</h4>\n<p>1、引入 Nacos 的配置管理客户端依赖：</p>\n<figure class=\"highlight xml\"><figcaption data-lang=\"XML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">&lt;!--nacos 配置管理依赖 --></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">></span></span>com.alibaba.cloud<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">></span></span>spring-cloud-starter-alibaba-nacos-config<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">></span></span></pre></td></tr></table></figure><p>2、在 userservice 中的 resource 目录添加一个 &lt;font color='red'&gt;bootstrap.yml&lt;/font &gt; 文件，这个文件是引导文件，优先级高于 application.yml</p>\n<figure class=\"highlight yml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">application</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> userservice <span class=\"token comment\"># 服务名称</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">profiles</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token key atrule\">active</span><span class=\"token punctuation\">:</span> dev <span class=\"token comment\"># 环境</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token key atrule\">cloud</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token key atrule\">nacos</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      <span class=\"token key atrule\">server-addr</span><span class=\"token punctuation\">:</span> localhost<span class=\"token punctuation\">:</span><span class=\"token number\">8848</span> <span class=\"token comment\"># nacos 地址</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token key atrule\">config</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token key atrule\">file-extension</span><span class=\"token punctuation\">:</span> yaml <span class=\"token comment\"># 配置文件后缀名</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># 三要素：服务名称，环境，后缀名 而这三个决定了 DateId</span></pre></td></tr></table></figure><p>多环境配置和共享配置 不在本案例范围中，只是演示可以这样做</p>\n<p>多环境配置：</p>\n<figure class=\"highlight yml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">application</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> content<span class=\"token punctuation\">-</span>service</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">cloud</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token key atrule\">nacos</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      <span class=\"token key atrule\">server-addr</span><span class=\"token punctuation\">:</span> localhost<span class=\"token punctuation\">:</span><span class=\"token number\">8848</span> <span class=\"token comment\"># nacos 地址</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token key atrule\">config</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev <span class=\"token comment\"># 命名空间</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token key atrule\">group</span><span class=\"token punctuation\">:</span> xuecheng<span class=\"token punctuation\">-</span>plus<span class=\"token punctuation\">-</span>project <span class=\"token comment\"># 组名称</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token key atrule\">file-extension</span><span class=\"token punctuation\">:</span> yaml <span class=\"token comment\"># 文件后缀</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token key atrule\">refresh-enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span> <span class=\"token comment\"># 是否开启自动刷新值</span></pre></td></tr></table></figure><p>共享配置 / 扩展配置</p>\n<p>多个扩展配置的案例如下：</p>\n<p><a href=\"https://pigpigletsgo.github.io/computer-science/java/spring/springcloud/Nacos/%E6%A1%88%E4%BE%8B/%E6%8B%86%E5%88%86%E4%B8%8D%E5%90%8C%E9%85%8D%E7%BD%AE%E5%88%B0nacos%E5%B9%B6%E8%AF%BB%E5%8F%96%E4%B8%8D%E5%90%8C%E9%85%8D%E7%BD%AE%E5%88%B0%E9%A1%B9%E7%9B%AE/\">案例文章</a></p>\n<figure class=\"highlight yml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">application</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> content<span class=\"token punctuation\">-</span>api <span class=\"token comment\"># 服务名</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">cloud</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token key atrule\">nacos</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      <span class=\"token key atrule\">server-addr</span><span class=\"token punctuation\">:</span> 192.168.249.128<span class=\"token punctuation\">:</span><span class=\"token number\">8848</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token key atrule\">discovery</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token key atrule\">group</span><span class=\"token punctuation\">:</span> xuecheng<span class=\"token punctuation\">-</span>plus<span class=\"token punctuation\">-</span>project</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token key atrule\">config</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 配置文件相关信息</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> dev</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token key atrule\">group</span><span class=\"token punctuation\">:</span> xuecheng<span class=\"token punctuation\">-</span>plus<span class=\"token punctuation\">-</span>project</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token key atrule\">file-extension</span><span class=\"token punctuation\">:</span> yaml</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token key atrule\">refresh-enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token comment\"># 共享配置 / 扩展配置</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token key atrule\">extension-configs</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">data-id</span><span class=\"token punctuation\">:</span> content<span class=\"token punctuation\">-</span>service<span class=\"token punctuation\">-</span>$<span class=\"token punctuation\">&#123;</span>spring.profiles.active<span class=\"token punctuation\">&#125;</span>.yaml</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            <span class=\"token key atrule\">group</span><span class=\"token punctuation\">:</span> xuecheng<span class=\"token punctuation\">-</span>plus<span class=\"token punctuation\">-</span>project</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            <span class=\"token key atrule\">refresh</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token key atrule\">profiles</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token key atrule\">active</span><span class=\"token punctuation\">:</span> dev <span class=\"token comment\">#环境名</span></pre></td></tr></table></figure><p>3、我们在 user-service 中将 pattern.dateformat 这个属性注入到 UserController 中做测试：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Slf4j</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token annotation punctuation\">@RestController</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token annotation punctuation\">@RequestMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/user\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">UserController</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token comment\">// 注入 nacos 中的配置属性</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$&#123;pattern.dateformat&#125;\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> dateformat<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token comment\">// 编写 controller，通过日期格式化器来格式化现在时间并返回</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"now\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dateFormat = \"</span><span class=\"token operator\">+</span>dateformat<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token class-name\">LocalDateTime</span><span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">DateTimeFormatter</span><span class=\"token punctuation\">.</span><span class=\"token function\">ofPattern</span><span class=\"token punctuation\">(</span>dateformat<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>4、请求接口查看结果</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061054265.png\" alt=\"image-20231006105444087\" /></p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061056279.png\" alt=\"image-20231006105458931\" /></p>\n<blockquote>\n<p><strong>总结</strong>：</p>\n<p>将配置交给 nacos 管理的步骤</p>\n<ol>\n<li>在 nacos 中添加配置文件</li>\n<li>在微服务中引入 nacos 的 config 依赖</li>\n<li>在微服务中添加 bootstrap.yml，配置 nacos 地址，当前环境，服务名称，文件后缀名。这些决定了程序启动时去 nacos 读取哪个文件，写错一个就会报错！</li>\n</ol>\n</blockquote>\n<h4 id=\"473-配置自动刷新\"><a class=\"anchor\" href=\"#473-配置自动刷新\">#</a> 4.7.3、配置自动刷新🌲</h4>\n<p>我们改一下 nacos 中配置文件的信息，点击编辑进行修改指定的 nacos 配置文件信息</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061058197.png\" alt=\"image-20231006105819948\" /></p>\n<p>原来的</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061057556.png\" alt=\"image-20231006105744125\" /></p>\n<p>修改后的</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061059763.png\" alt=\"image-20231006105913419\" /></p>\n<p>修改完点击发布，然后再去请求获取日期格式化的接口</p>\n<p>可以看到没有变化</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061100940.png\" alt=\"image-20231006110004691\" /></p>\n<p>要想实现配置的自动更新我们需要如下操作：</p>\n<p>Nacos 中的配置文件变更后，微服务无需重启就可以感知。不过需要通过下面两种配置实现：</p>\n<h5 id=\"474-refreshscope\"><a class=\"anchor\" href=\"#474-refreshscope\">#</a> 4.7.4、@RefreshScope🌴</h5>\n<ul>\n<li>方式一：在 @Value 注入的变量所在类上添加注解 @RefreshScope</li>\n</ul>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061103130.png\" alt=\"image-20231006110317505\" /></p>\n<p>加上注解后重启服务，因为上次的更改没有生效这里又将 nacos 配置文件的信息改为原来的了。再次进行修改测试</p>\n<p>修改前</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061106769.png\" alt=\"image-20231006110621029\" /></p>\n<p>修改后</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061107482.png\" alt=\"image-20231006110720366\" /></p>\n<p>在没有重启服务的情况下刷新两下从 nacos 配置文件中获取的格式化日期就发生了改变，说明热更新生效了。</p>\n<h5 id=\"475-configurationproperties\"><a class=\"anchor\" href=\"#475-configurationproperties\">#</a> 4.7.5、@ConfigurationProperties🌴</h5>\n<ul>\n<li>方式二：使用 @ConfigurationProperties 注解</li>\n</ul>\n<p>通过 @ConfigurationProperties 注解读取一个前缀为 pattern 的配置信息 (约定大于配置)</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061113170.png\" alt=\"image-20231006111308948\" /></p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061120271.png\" alt=\"image-20231006112043132\" /></p>\n<p>重启服务，测试结果</p>\n<p>修改前</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061122192.png\" alt=\"image-20231006112226998\" /></p>\n<p>修改后</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061123665.png\" alt=\"image-20231006112303423\" /></p>\n<p>刷新页面</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061123281.png\" alt=\"image-20231006112317230\" /></p>\n<blockquote>\n<p><strong>总结</strong>：</p>\n<p>Nacos 配置更改后，微服务可以实现热更新，方式：</p>\n<ol>\n<li>通过 @Value 注解注入，结合 @RefreshScope 来刷新</li>\n<li>通过 @ConfigurationProperties 注入，自动刷新 (建议使用，因为方便)</li>\n</ol>\n<p>&lt;font color='red'&gt;<strong> 注意事项</strong> &lt;/font&gt;：</p>\n<ul>\n<li>不是所有的配置都适合放到配置中心，维护起来比较麻烦</li>\n<li>建议将一些关键参数，需要运行时调整的参数放到 nacos 配置中心，一般都是自定义配置</li>\n</ul>\n</blockquote>\n<h4 id=\"474-多环境配置共享\"><a class=\"anchor\" href=\"#474-多环境配置共享\">#</a> 4.7.4、多环境配置共享🌲</h4>\n<blockquote>\n<p>场景：</p>\n<p>有一个配置属性，它在开发，生产和测试等环境下的值都是一样的，那像这样的配置我在每个配置文件里都写一份。是不是有点浪费呀，而且将来如果要改动我还得在每个配置文件都去改这样很麻烦。我们想找一个地方我配置一次以后不管环境怎么变这个配置都能够被加载。那这就是多环境共享的需求了！</p>\n</blockquote>\n<p>微服务启动时会从 nacos 读取多个配置文件：</p>\n<p>第一个：它的构成有三部分</p>\n<ol>\n<li>服务名称</li>\n<li>环境</li>\n<li>后缀名</li>\n</ol>\n<ul>\n<li>[<span class=\"exturl\" data-url=\"aHR0cDovL3NwcmluZy5hcHBsaWNhdGlvbi5uYW1l\">spring.application.name</span>]-[spring.profiles.active].yaml，例如：userservice-dev.yaml</li>\n</ul>\n<p>第二个：它的构成有二部分，跟环境没有关系</p>\n<ol>\n<li>服务名称</li>\n<li>后缀名</li>\n</ol>\n<ul>\n<li>[<span class=\"exturl\" data-url=\"aHR0cDovL3NwcmluZy5hcHBsaWNhdGlvbi5uYW1l\">spring.application.name</span>].yaml，例如：userservice.yaml</li>\n</ul>\n<p>无论 profile 如何变化，[<span class=\"exturl\" data-url=\"aHR0cDovL3NwcmluZy5hcHBsaWNhdGlvbi5uYW1l\">spring.application.name</span>].yaml 这个文件一定会加载，因此多环境共享配置可以写入这个文件</p>\n<blockquote>\n<p>比如说如下图，有 dev.yaml 和 userservice.yaml 将来有测试环境在定义一个 userservice-test.yaml。但是不管是 dev 还是 userservice-test，userservice.yaml 一定会被共享</p>\n</blockquote>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061141107.png\" alt=\"image-20231006114137708\" /></p>\n<p>编写获取 envSharedValue 的代码：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Data</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token annotation punctuation\">@Component</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token annotation punctuation\">@ConfigurationProperties</span><span class=\"token punctuation\">(</span>prefix <span class=\"token operator\">=</span> <span class=\"token string\">\"pattern\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">PatternProperties</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> dateformat<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> envSharedValue<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Slf4j</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token annotation punctuation\">@RestController</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token annotation punctuation\">@RequestMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/user\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">UserController</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token annotation punctuation\">@Autowired</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">PatternProperties</span> patternProperties<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   </pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"prop\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">PatternProperties</span> <span class=\"token function\">patternProperties</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">return</span> patternProperties<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>启动 user-service 服务！</p>\n<p>但是需要注意当前服务的环境：</p>\n<p>当前处于 dev 开发环境下，所以既可以访问到 userservice 环境也可以访问到 dev 环境</p>\n<figure class=\"highlight yml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">application</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> userservice <span class=\"token comment\"># 服务名称</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">profiles</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token key atrule\">active</span><span class=\"token punctuation\">:</span> dev <span class=\"token comment\"># 环境</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token key atrule\">cloud</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token key atrule\">nacos</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      <span class=\"token key atrule\">server-addr</span><span class=\"token punctuation\">:</span> localhost<span class=\"token punctuation\">:</span><span class=\"token number\">8848</span> <span class=\"token comment\"># nacos 地址</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token key atrule\">config</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token key atrule\">file-extension</span><span class=\"token punctuation\">:</span> yaml <span class=\"token comment\"># 配置文件后缀名</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># 三要素：服务名称，环境，后缀名 而这三个决定了 DateId</span></pre></td></tr></table></figure><p>然后再启动一个 test 环境的服务这次不修改配置文件中的代码，而是在 idea 启动参数中设置 环境</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061210818.png\" alt=\"image-20231006121029595\" /></p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061211188.png\" alt=\"image-20231006121106691\" /></p>\n<p>两个服务启动完成后，进行请求 user-service 服务：</p>\n<p>访问：<span class=\"exturl\" data-url=\"aHR0cDovLzEyNy4wLjAuMTo4MDgxL3VzZXIvcHJvcA==\">http://127.0.0.1:8081/user/prop</span> 这是 dev 环境，可以看到显示了 格式化日期和 envSharedValue 信息</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061234508.png\" alt=\"image-20231006123404747\" /></p>\n<p>访问：<span class=\"exturl\" data-url=\"aHR0cDovLzEyNy4wLjAuMTo4MDgyL3VzZXIvcHJvcA==\">http://127.0.0.1:8082/user/prop</span> 这是 test 环境，可以看到依然可以获取到 userservice 环境的值，而 dev 环境的格式化日期的值获取不到了。</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061234043.png\" alt=\"image-20231006123455577\" /></p>\n<p>同上测试可以证明，8081：dev 环境，8082：test 环境。都均可以得到 userserivce 环境的值</p>\n<p>证明了 userservice.yaml 文件是被不同环境所共享的。</p>\n<h5 id=\"4741-测试配置文件优先级\"><a class=\"anchor\" href=\"#4741-测试配置文件优先级\">#</a> 4.7.4.1、测试配置文件优先级🌴</h5>\n<p>假如说 userservice 与 dev 配置文件中有相同的属性那它会以谁的为准呢？</p>\n<p>测试一、在本地和远端都配置相同的属性看看以谁的为准</p>\n<p>在本地配置文件中配置一个值</p>\n<figure class=\"highlight yml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> 本地环境local</pre></td></tr></table></figure><p>在 PatternProperties 类中也加上这个属性</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Data</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token annotation punctuation\">@Component</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token annotation punctuation\">@ConfigurationProperties</span><span class=\"token punctuation\">(</span>prefix <span class=\"token operator\">=</span> <span class=\"token string\">\"pattern\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">PatternProperties</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> dateformat<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> envSharedValue<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>再到 nacos 控制台中给 userservice 环境加上这个属性</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061245246.png\" alt=\"image-20231006124535158\" /></p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061245100.png\" alt=\"image-20231006124517976\" /></p>\n<p>重启 user-service 服务。请求 user-service 的 url：<span class=\"exturl\" data-url=\"aHR0cDovLzEyNy4wLjAuMTo4MDgxL3VzZXIvcHJvcA==\">http://127.0.0.1:8081/user/prop</span></p>\n<p>结果是 userservice 环境中的属性值。这就证明了 本地与远端，远端的优先级高！</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061247510.png\" alt=\"image-20231006124719747\" /></p>\n<p>我们再将 nacos 控制台中的 dev 环境也加上这个属性</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061249639.png\" alt=\"image-20231006124900533\" /></p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061249996.png\" alt=\"image-20231006124929760\" /></p>\n<p>再去请求 user-service 的 url：<span class=\"exturl\" data-url=\"aHR0cDovLzEyNy4wLjAuMTo4MDgxL3VzZXIvcHJvcA==\">http://127.0.0.1:8081/user/prop</span></p>\n<p>这次结果是自己的环境配置的属性值了</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061251197.png\" alt=\"image-20231006125141160\" /></p>\n<h5 id=\"4742-多种配置的优先级\"><a class=\"anchor\" href=\"#4742-多种配置的优先级\">#</a> 4.7.4.2、多种配置的优先级：🌴</h5>\n<ul>\n<li>服务名 - profile.yaml &gt; 服务名称.yaml &gt; 本地配置</li>\n</ul>\n<p>&lt;center&gt; 优先级关系图 &lt;/center&gt;</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061254076.png\" alt=\"image-20231006125407644\" /></p>\n<p>如果想让本地配置优先则配置如下内容：</p>\n<figure class=\"highlight yml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 配置本地优先</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> <span class=\"token key atrule\">cloud</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">config</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   <span class=\"token key atrule\">override-none</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span></pre></td></tr></table></figure><blockquote>\n<p><strong>总结</strong>：</p>\n<p>微服务会从 nacos 读取的配置文件：</p>\n<ol>\n<li>[服务名]-[spring.profile.active].yaml，环境配置</li>\n<li>[服务名].yaml，默认配置，多环境共享</li>\n</ol>\n<p>优先级：</p>\n<ul>\n<li>[服务名]-[环境].yaml &gt; [服务名].yaml &gt; 本地配置</li>\n</ul>\n</blockquote>\n<h4 id=\"475-nacos集群搭建\"><a class=\"anchor\" href=\"#475-nacos集群搭建\">#</a> 4.7.5、Nacos 集群搭建🌲</h4>\n<p>Nacos 生产环境下一定要部署为集群状态，部署方式参考课前资料中的文档：</p>\n<blockquote>\n<p>在前面的学习中我们学习到了 Nacos 的基本用法，不过之前我们一直使用的都是单点的 nacos。这种方式我们自己测试的时候玩玩可还行，如果是在企业生产环境下也这么搞。那可就要出大问题了。</p>\n<p>因为在企业当中我们更强调的是高可用所以 nacos 一定要做成一个集群，下面我们学习如何搭建 nacos 集群</p>\n</blockquote>\n<p>查看 nacos 配合 nginx 基本集群搭建：<a href=\"./Nacos/nacos%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA.md\">nacos 集群搭建文章</a>.</p>\n<blockquote>\n<p><strong>总结</strong>：</p>\n<p>集群搭建步骤：</p>\n<ol>\n<li>搭建 MySQL 集群并初始化数据库表</li>\n<li>下载解压 nacos</li>\n<li>修改集群配置 (节点信息)，数据库配置</li>\n<li>分别启动多个 nacos 节点</li>\n<li>nginx 反向代理</li>\n</ol>\n</blockquote>\n",
            "tags": [
                "计算机学科",
                "springcloud",
                "Nacos"
            ]
        },
        {
            "id": "https://pigpigletsgo.github.io/homepage/2024/01/24/computer-science/java/spring/springcloud/Nacos/nacos%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/",
            "url": "https://pigpigletsgo.github.io/homepage/2024/01/24/computer-science/java/spring/springcloud/Nacos/nacos%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/",
            "title": "Nacos集群搭建",
            "date_published": "2024-01-24T10:48:46.204Z",
            "content_html": "<h1 id=\"nacos集群搭建\"><a class=\"anchor\" href=\"#nacos集群搭建\">#</a> Nacos 集群搭建</h1>\n<p>1. 集群结构图</p>\n<p>官方给出的 Nacos 集群图：</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061439329.png\" alt=\"image-20210409210621117\" /></p>\n<p>其中包含 3 个 nacos 节点，然后一个负载均衡器代理 3 个 Nacos。这里负载均衡器可以使用 nginx。</p>\n<p>我们计划的集群结构：</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061439932.png\" alt=\"image-20210409211355037\" /></p>\n<p>三个 nacos 节点的地址：</p>\n<table>\n<thead>\n<tr>\n<th>节点</th>\n<th>ip</th>\n<th>port</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>nacos1</td>\n<td>192.168.150.1</td>\n<td>8845</td>\n</tr>\n<tr>\n<td>nacos2</td>\n<td>192.168.150.1</td>\n<td>8846</td>\n</tr>\n<tr>\n<td>nacos3</td>\n<td>192.168.150.1</td>\n<td>8847</td>\n</tr>\n</tbody>\n</table>\n<h1 id=\"2搭建集群\"><a class=\"anchor\" href=\"#2搭建集群\">#</a> 2. 搭建集群</h1>\n<p>搭建集群的基本步骤：</p>\n<ul>\n<li>搭建数据库，初始化数据库表结构</li>\n<li>下载 nacos 安装包</li>\n<li>配置 nacos</li>\n<li>启动 nacos 集群</li>\n<li>nginx 反向代理</li>\n</ul>\n<h2 id=\"21初始化数据库\"><a class=\"anchor\" href=\"#21初始化数据库\">#</a> 2.1. 初始化数据库</h2>\n<p>Nacos 默认数据存储在内嵌数据库 Derby 中，不属于生产可用的数据库。</p>\n<p>官方推荐的最佳实践是使用带有主从的高可用数据库集群，主从模式的高可用数据库可以参考<strong>传智教育</strong>的后续高手课程。</p>\n<p>这里我们以单点的数据库为例来讲解。</p>\n<p>首先新建一个数据库，命名为 nacos，而后导入下面的 SQL：</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>config_info<span class=\"token punctuation\">`</span></span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>id<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">bigint</span><span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">AUTO_INCREMENT</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'id'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>data_id<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'data_id'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>group_id<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>content<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">longtext</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'content'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>md5<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">32</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'md5'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>gmt_create<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">datetime</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">CURRENT_TIMESTAMP</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'创建时间'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>gmt_modified<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">datetime</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">CURRENT_TIMESTAMP</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'修改时间'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>src_user<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">text</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'source user'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>src_ip<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">50</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'source ip'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>app_name<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">128</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>tenant_id<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">128</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token string\">''</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'租户字段'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>c_desc<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">256</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>c_use<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">64</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>effect<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">64</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>type<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">64</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>c_schema<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">text</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span> <span class=\"token punctuation\">(</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>id<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token keyword\">UNIQUE</span> <span class=\"token keyword\">KEY</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>uk_configinfo_datagrouptenant<span class=\"token punctuation\">`</span></span> <span class=\"token punctuation\">(</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>data_id<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">,</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>group_id<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">,</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>tenant_id<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">)</span> <span class=\"token keyword\">ENGINE</span><span class=\"token operator\">=</span><span class=\"token keyword\">InnoDB</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">CHARSET</span><span class=\"token operator\">=</span>utf8 <span class=\"token keyword\">COLLATE</span><span class=\"token operator\">=</span>utf8_bin <span class=\"token keyword\">COMMENT</span><span class=\"token operator\">=</span><span class=\"token string\">'config_info'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\">/******************************************/</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\">/*   数据库全名 = nacos_config   */</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\">/*   表名称 = config_info_aggr   */</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token comment\">/******************************************/</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>config_info_aggr<span class=\"token punctuation\">`</span></span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>id<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">bigint</span><span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">AUTO_INCREMENT</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'id'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>data_id<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'data_id'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>group_id<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'group_id'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>datum_id<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'datum_id'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>content<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">longtext</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'内容'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>gmt_modified<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">datetime</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'修改时间'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>app_name<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">128</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>tenant_id<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">128</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token string\">''</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'租户字段'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span> <span class=\"token punctuation\">(</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>id<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  <span class=\"token keyword\">UNIQUE</span> <span class=\"token keyword\">KEY</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>uk_configinfoaggr_datagrouptenantdatum<span class=\"token punctuation\">`</span></span> <span class=\"token punctuation\">(</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>data_id<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">,</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>group_id<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">,</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>tenant_id<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">,</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>datum_id<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token punctuation\">)</span> <span class=\"token keyword\">ENGINE</span><span class=\"token operator\">=</span><span class=\"token keyword\">InnoDB</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">CHARSET</span><span class=\"token operator\">=</span>utf8 <span class=\"token keyword\">COLLATE</span><span class=\"token operator\">=</span>utf8_bin <span class=\"token keyword\">COMMENT</span><span class=\"token operator\">=</span><span class=\"token string\">'增加租户字段'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token comment\">/******************************************/</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token comment\">/*   数据库全名 = nacos_config   */</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token comment\">/*   表名称 = config_info_beta   */</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token comment\">/******************************************/</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>config_info_beta<span class=\"token punctuation\">`</span></span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>id<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">bigint</span><span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">AUTO_INCREMENT</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'id'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>data_id<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'data_id'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>group_id<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">128</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'group_id'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>app_name<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">128</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'app_name'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>content<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">longtext</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'content'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>beta_ips<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">1024</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'betaIps'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>md5<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">32</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'md5'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>gmt_create<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">datetime</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">CURRENT_TIMESTAMP</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'创建时间'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>gmt_modified<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">datetime</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">CURRENT_TIMESTAMP</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'修改时间'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>src_user<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">text</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'source user'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>src_ip<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">50</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'source ip'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>tenant_id<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">128</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token string\">''</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'租户字段'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>  <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span> <span class=\"token punctuation\">(</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>id<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>  <span class=\"token keyword\">UNIQUE</span> <span class=\"token keyword\">KEY</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>uk_configinfobeta_datagrouptenant<span class=\"token punctuation\">`</span></span> <span class=\"token punctuation\">(</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>data_id<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">,</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>group_id<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">,</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>tenant_id<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre><span class=\"token punctuation\">)</span> <span class=\"token keyword\">ENGINE</span><span class=\"token operator\">=</span><span class=\"token keyword\">InnoDB</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">CHARSET</span><span class=\"token operator\">=</span>utf8 <span class=\"token keyword\">COLLATE</span><span class=\"token operator\">=</span>utf8_bin <span class=\"token keyword\">COMMENT</span><span class=\"token operator\">=</span><span class=\"token string\">'config_info_beta'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre></pre></td></tr><tr><td data-num=\"61\"></td><td><pre><span class=\"token comment\">/******************************************/</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre><span class=\"token comment\">/*   数据库全名 = nacos_config   */</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre><span class=\"token comment\">/*   表名称 = config_info_tag   */</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre><span class=\"token comment\">/******************************************/</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>config_info_tag<span class=\"token punctuation\">`</span></span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>id<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">bigint</span><span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">AUTO_INCREMENT</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'id'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>data_id<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'data_id'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>group_id<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">128</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'group_id'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>tenant_id<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">128</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token string\">''</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'tenant_id'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>tag_id<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">128</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'tag_id'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>app_name<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">128</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'app_name'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>content<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">longtext</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'content'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>md5<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">32</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'md5'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>gmt_create<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">datetime</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">CURRENT_TIMESTAMP</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'创建时间'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>gmt_modified<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">datetime</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">CURRENT_TIMESTAMP</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'修改时间'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>src_user<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">text</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'source user'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>src_ip<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">50</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'source ip'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>  <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span> <span class=\"token punctuation\">(</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>id<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>  <span class=\"token keyword\">UNIQUE</span> <span class=\"token keyword\">KEY</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>uk_configinfotag_datagrouptenanttag<span class=\"token punctuation\">`</span></span> <span class=\"token punctuation\">(</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>data_id<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">,</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>group_id<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">,</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>tenant_id<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">,</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>tag_id<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre><span class=\"token punctuation\">)</span> <span class=\"token keyword\">ENGINE</span><span class=\"token operator\">=</span><span class=\"token keyword\">InnoDB</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">CHARSET</span><span class=\"token operator\">=</span>utf8 <span class=\"token keyword\">COLLATE</span><span class=\"token operator\">=</span>utf8_bin <span class=\"token keyword\">COMMENT</span><span class=\"token operator\">=</span><span class=\"token string\">'config_info_tag'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre></pre></td></tr><tr><td data-num=\"82\"></td><td><pre><span class=\"token comment\">/******************************************/</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre><span class=\"token comment\">/*   数据库全名 = nacos_config   */</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre><span class=\"token comment\">/*   表名称 = config_tags_relation   */</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre><span class=\"token comment\">/******************************************/</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>config_tags_relation<span class=\"token punctuation\">`</span></span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>id<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">bigint</span><span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'id'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>tag_name<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">128</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'tag_name'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>tag_type<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">64</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'tag_type'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>data_id<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'data_id'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>group_id<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">128</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'group_id'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>tenant_id<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">128</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token string\">''</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'tenant_id'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>nid<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">bigint</span><span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">AUTO_INCREMENT</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>  <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span> <span class=\"token punctuation\">(</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>nid<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>  <span class=\"token keyword\">UNIQUE</span> <span class=\"token keyword\">KEY</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>uk_configtagrelation_configidtag<span class=\"token punctuation\">`</span></span> <span class=\"token punctuation\">(</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>id<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">,</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>tag_name<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">,</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>tag_type<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>  <span class=\"token keyword\">KEY</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>idx_tenant_id<span class=\"token punctuation\">`</span></span> <span class=\"token punctuation\">(</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>tenant_id<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre><span class=\"token punctuation\">)</span> <span class=\"token keyword\">ENGINE</span><span class=\"token operator\">=</span><span class=\"token keyword\">InnoDB</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">CHARSET</span><span class=\"token operator\">=</span>utf8 <span class=\"token keyword\">COLLATE</span><span class=\"token operator\">=</span>utf8_bin <span class=\"token keyword\">COMMENT</span><span class=\"token operator\">=</span><span class=\"token string\">'config_tag_relation'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre></pre></td></tr><tr><td data-num=\"99\"></td><td><pre><span class=\"token comment\">/******************************************/</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre><span class=\"token comment\">/*   数据库全名 = nacos_config   */</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre><span class=\"token comment\">/*   表名称 = group_capacity   */</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre><span class=\"token comment\">/******************************************/</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>group_capacity<span class=\"token punctuation\">`</span></span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>id<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">bigint</span><span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">unsigned</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">AUTO_INCREMENT</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'主键ID'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>group_id<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">128</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token string\">''</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'Group ID，空字符表示整个集群'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>quota<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">unsigned</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token string\">'0'</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'配额，0表示使用默认值'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>usage<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">unsigned</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token string\">'0'</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'使用量'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>max_size<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">unsigned</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token string\">'0'</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'单个配置大小上限，单位为字节，0表示使用默认值'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>max_aggr_count<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">unsigned</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token string\">'0'</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'聚合子配置最大个数，，0表示使用默认值'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>max_aggr_size<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">unsigned</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token string\">'0'</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'单个聚合数据的子配置大小上限，单位为字节，0表示使用默认值'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>max_history_count<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">unsigned</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token string\">'0'</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'最大变更历史数量'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>gmt_create<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">datetime</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">CURRENT_TIMESTAMP</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'创建时间'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>gmt_modified<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">datetime</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">CURRENT_TIMESTAMP</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'修改时间'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>  <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span> <span class=\"token punctuation\">(</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>id<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>  <span class=\"token keyword\">UNIQUE</span> <span class=\"token keyword\">KEY</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>uk_group_id<span class=\"token punctuation\">`</span></span> <span class=\"token punctuation\">(</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>group_id<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre><span class=\"token punctuation\">)</span> <span class=\"token keyword\">ENGINE</span><span class=\"token operator\">=</span><span class=\"token keyword\">InnoDB</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">CHARSET</span><span class=\"token operator\">=</span>utf8 <span class=\"token keyword\">COLLATE</span><span class=\"token operator\">=</span>utf8_bin <span class=\"token keyword\">COMMENT</span><span class=\"token operator\">=</span><span class=\"token string\">'集群、各Group容量信息表'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre></pre></td></tr><tr><td data-num=\"118\"></td><td><pre><span class=\"token comment\">/******************************************/</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre><span class=\"token comment\">/*   数据库全名 = nacos_config   */</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre><span class=\"token comment\">/*   表名称 = his_config_info   */</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre><span class=\"token comment\">/******************************************/</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>his_config_info<span class=\"token punctuation\">`</span></span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>id<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">bigint</span><span class=\"token punctuation\">(</span><span class=\"token number\">64</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">unsigned</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>nid<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">bigint</span><span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">unsigned</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">AUTO_INCREMENT</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>data_id<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>group_id<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">128</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>app_name<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">128</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'app_name'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>content<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">longtext</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>md5<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">32</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>gmt_create<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">datetime</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">CURRENT_TIMESTAMP</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>gmt_modified<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">datetime</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">CURRENT_TIMESTAMP</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>src_user<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">text</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>src_ip<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">50</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>op_type<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">char</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>tenant_id<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">128</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token string\">''</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'租户字段'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>  <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span> <span class=\"token punctuation\">(</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>nid<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>  <span class=\"token keyword\">KEY</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>idx_gmt_create<span class=\"token punctuation\">`</span></span> <span class=\"token punctuation\">(</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>gmt_create<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>  <span class=\"token keyword\">KEY</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>idx_gmt_modified<span class=\"token punctuation\">`</span></span> <span class=\"token punctuation\">(</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>gmt_modified<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>  <span class=\"token keyword\">KEY</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>idx_did<span class=\"token punctuation\">`</span></span> <span class=\"token punctuation\">(</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>data_id<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre><span class=\"token punctuation\">)</span> <span class=\"token keyword\">ENGINE</span><span class=\"token operator\">=</span><span class=\"token keyword\">InnoDB</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">CHARSET</span><span class=\"token operator\">=</span>utf8 <span class=\"token keyword\">COLLATE</span><span class=\"token operator\">=</span>utf8_bin <span class=\"token keyword\">COMMENT</span><span class=\"token operator\">=</span><span class=\"token string\">'多租户改造'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre></pre></td></tr><tr><td data-num=\"142\"></td><td><pre></pre></td></tr><tr><td data-num=\"143\"></td><td><pre><span class=\"token comment\">/******************************************/</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre><span class=\"token comment\">/*   数据库全名 = nacos_config   */</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre><span class=\"token comment\">/*   表名称 = tenant_capacity   */</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre><span class=\"token comment\">/******************************************/</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>tenant_capacity<span class=\"token punctuation\">`</span></span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>id<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">bigint</span><span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">unsigned</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">AUTO_INCREMENT</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'主键ID'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>tenant_id<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">128</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token string\">''</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'Tenant ID'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>quota<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">unsigned</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token string\">'0'</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'配额，0表示使用默认值'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>usage<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">unsigned</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token string\">'0'</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'使用量'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>max_size<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">unsigned</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token string\">'0'</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'单个配置大小上限，单位为字节，0表示使用默认值'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"153\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>max_aggr_count<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">unsigned</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token string\">'0'</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'聚合子配置最大个数'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>max_aggr_size<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">unsigned</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token string\">'0'</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'单个聚合数据的子配置大小上限，单位为字节，0表示使用默认值'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>max_history_count<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">unsigned</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token string\">'0'</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'最大变更历史数量'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"156\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>gmt_create<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">datetime</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">CURRENT_TIMESTAMP</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'创建时间'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"157\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>gmt_modified<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">datetime</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">CURRENT_TIMESTAMP</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'修改时间'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>  <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span> <span class=\"token punctuation\">(</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>id<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre>  <span class=\"token keyword\">UNIQUE</span> <span class=\"token keyword\">KEY</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>uk_tenant_id<span class=\"token punctuation\">`</span></span> <span class=\"token punctuation\">(</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>tenant_id<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre><span class=\"token punctuation\">)</span> <span class=\"token keyword\">ENGINE</span><span class=\"token operator\">=</span><span class=\"token keyword\">InnoDB</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">CHARSET</span><span class=\"token operator\">=</span>utf8 <span class=\"token keyword\">COLLATE</span><span class=\"token operator\">=</span>utf8_bin <span class=\"token keyword\">COMMENT</span><span class=\"token operator\">=</span><span class=\"token string\">'租户容量信息表'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre></pre></td></tr><tr><td data-num=\"162\"></td><td><pre></pre></td></tr><tr><td data-num=\"163\"></td><td><pre><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>tenant_info<span class=\"token punctuation\">`</span></span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"164\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>id<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">bigint</span><span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">AUTO_INCREMENT</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'id'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"165\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>kp<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">128</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'kp'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"166\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>tenant_id<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">128</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">default</span> <span class=\"token string\">''</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'tenant_id'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"167\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>tenant_name<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">128</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">default</span> <span class=\"token string\">''</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'tenant_name'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"168\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>tenant_desc<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">256</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'tenant_desc'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"169\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>create_source<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">32</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'create_source'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"170\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>gmt_create<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">bigint</span><span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'创建时间'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"171\"></td><td><pre>  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>gmt_modified<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">bigint</span><span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'修改时间'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"172\"></td><td><pre>  <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span> <span class=\"token punctuation\">(</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>id<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"173\"></td><td><pre>  <span class=\"token keyword\">UNIQUE</span> <span class=\"token keyword\">KEY</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>uk_tenant_info_kptenantid<span class=\"token punctuation\">`</span></span> <span class=\"token punctuation\">(</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>kp<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">,</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>tenant_id<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"174\"></td><td><pre>  <span class=\"token keyword\">KEY</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>idx_tenant_id<span class=\"token punctuation\">`</span></span> <span class=\"token punctuation\">(</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>tenant_id<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"175\"></td><td><pre><span class=\"token punctuation\">)</span> <span class=\"token keyword\">ENGINE</span><span class=\"token operator\">=</span><span class=\"token keyword\">InnoDB</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">CHARSET</span><span class=\"token operator\">=</span>utf8 <span class=\"token keyword\">COLLATE</span><span class=\"token operator\">=</span>utf8_bin <span class=\"token keyword\">COMMENT</span><span class=\"token operator\">=</span><span class=\"token string\">'tenant_info'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"176\"></td><td><pre></pre></td></tr><tr><td data-num=\"177\"></td><td><pre><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>users<span class=\"token punctuation\">`</span></span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"178\"></td><td><pre>\t<span class=\"token identifier\"><span class=\"token punctuation\">`</span>username<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">50</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"179\"></td><td><pre>\t<span class=\"token identifier\"><span class=\"token punctuation\">`</span>password<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">500</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"180\"></td><td><pre>\t<span class=\"token identifier\"><span class=\"token punctuation\">`</span>enabled<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">boolean</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span></pre></td></tr><tr><td data-num=\"181\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"182\"></td><td><pre></pre></td></tr><tr><td data-num=\"183\"></td><td><pre><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>roles<span class=\"token punctuation\">`</span></span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"184\"></td><td><pre>\t<span class=\"token identifier\"><span class=\"token punctuation\">`</span>username<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">50</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"185\"></td><td><pre>\t<span class=\"token identifier\"><span class=\"token punctuation\">`</span>role<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">50</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"186\"></td><td><pre>\t<span class=\"token keyword\">UNIQUE</span> <span class=\"token keyword\">INDEX</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>idx_user_role<span class=\"token punctuation\">`</span></span> <span class=\"token punctuation\">(</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>username<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">ASC</span><span class=\"token punctuation\">,</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>role<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">ASC</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">USING</span> <span class=\"token keyword\">BTREE</span></pre></td></tr><tr><td data-num=\"187\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"188\"></td><td><pre></pre></td></tr><tr><td data-num=\"189\"></td><td><pre><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>permissions<span class=\"token punctuation\">`</span></span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"190\"></td><td><pre>    <span class=\"token identifier\"><span class=\"token punctuation\">`</span>role<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">50</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"191\"></td><td><pre>    <span class=\"token identifier\"><span class=\"token punctuation\">`</span>resource<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"192\"></td><td><pre>    <span class=\"token identifier\"><span class=\"token punctuation\">`</span>action<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"193\"></td><td><pre>    <span class=\"token keyword\">UNIQUE</span> <span class=\"token keyword\">INDEX</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>uk_role_permission<span class=\"token punctuation\">`</span></span> <span class=\"token punctuation\">(</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>role<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">,</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>resource<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">,</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>action<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">USING</span> <span class=\"token keyword\">BTREE</span></pre></td></tr><tr><td data-num=\"194\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"195\"></td><td><pre></pre></td></tr><tr><td data-num=\"196\"></td><td><pre><span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> users <span class=\"token punctuation\">(</span>username<span class=\"token punctuation\">,</span> password<span class=\"token punctuation\">,</span> enabled<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'nacos'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'$2a$10$EuWPZHzz32dJN7jexM34MOeYirDdFAZm2kuWj7VEOJhhZkDrxfvUu'</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"197\"></td><td><pre></pre></td></tr><tr><td data-num=\"198\"></td><td><pre><span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> roles <span class=\"token punctuation\">(</span>username<span class=\"token punctuation\">,</span> role<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'nacos'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'ROLE_ADMIN'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h2 id=\"22下载nacos\"><a class=\"anchor\" href=\"#22下载nacos\">#</a> 2.2. 下载 nacos</h2>\n<p>nacos 在 GitHub 上有下载地址：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2FsaWJhYmEvbmFjb3MvdGFncyVFRiVCQyU4QyVFNSU4RiVBRiVFNCVCQiVBNSVFOSU4MCU4OSVFNiU4QiVBOSVFNCVCQiVCQiVFNiU4NCU4RiVFNyU4OSU4OCVFNiU5QyVBQyVFNCVCOCU4QiVFOCVCRCVCRCVFMyU4MCU4Mg==\">https://github.com/alibaba/nacos/tags，可以选择任意版本下载。</span></p>\n<p>本例中才用 1.4.1 版本：</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061439539.png\" alt=\"image-20210409212119411\" /></p>\n<h2 id=\"23配置nacos\"><a class=\"anchor\" href=\"#23配置nacos\">#</a> 2.3. 配置 Nacos</h2>\n<p>将这个包解压到任意非中文目录下，如图：</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061439220.png\" alt=\"image-20210402161843337\" /></p>\n<p>目录说明：</p>\n<ul>\n<li>bin：启动脚本</li>\n<li>conf：配置文件</li>\n</ul>\n<p>进入 nacos 的 conf 目录，修改配置文件 cluster.conf.example，重命名为 cluster.conf：</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061440003.png\" alt=\"image-20210409212459292\" /></p>\n<p>然后添加内容：</p>\n<p>集群中每一个节点的信息</p>\n<p>如果是在生产环境下那下面三个都应该是真实机器的 ip 地址和端口号</p>\n<pre><code>127.0.0.1:8845\n127.0.0.1.8846\n127.0.0.1.8847\n</code></pre>\n<p>然后修改 application.properties 文件，添加数据库配置</p>\n<p>将配置文件中如下的配置的注释全部去掉也就是打开</p>\n<figure class=\"highlight properties\"><figcaption data-lang=\".properties\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key attr-name\">spring.datasource.platform</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">mysql</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key attr-name\">db.num</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">1</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token key attr-name\">db.url.0</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">jdbc:mysql://127.0.0.1:3306/nacos?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true&amp;useUnicode=true&amp;useSSL=false&amp;serverTimezone=UTC</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key attr-name\">db.user.0</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">root</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token key attr-name\">db.password.0</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">123</span></pre></td></tr></table></figure><p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061439107.png\" alt=\"image-20231006143926134\" /></p>\n<h2 id=\"24启动\"><a class=\"anchor\" href=\"#24启动\">#</a> 2.4. 启动</h2>\n<p>将 nacos 文件夹复制三份，分别命名为：nacos1、nacos2、nacos3</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061440201.png\" alt=\"image-20210409213335538\" /></p>\n<p>然后分别修改三个文件夹中的 application.properties，</p>\n<p>nacos1:</p>\n<figure class=\"highlight properties\"><figcaption data-lang=\".properties\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key attr-name\">server.port</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">8845</span></pre></td></tr></table></figure><p>nacos2:</p>\n<figure class=\"highlight properties\"><figcaption data-lang=\".properties\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key attr-name\">server.port</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">8846</span></pre></td></tr></table></figure><p>nacos3:</p>\n<figure class=\"highlight properties\"><figcaption data-lang=\".properties\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key attr-name\">server.port</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">8847</span></pre></td></tr></table></figure><p>然后分别启动三个 nacos 节点：</p>\n<p>&lt;font color='red'&gt; 注意 &lt;/font&gt;：此时启动不需要加参数了，直接启动即可。因为现在是集群启动 (默认)</p>\n<pre><code>startup.cmd\n</code></pre>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061454156.png\" alt=\"image-20231006145123931\" /></p>\n<p>然后依次访问一下 url 看看是否正常启动了</p>\n<p>正常启动了！</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061453370.png\" alt=\"image-20231006145253400\" /></p>\n<h2 id=\"25nginx反向代理\"><a class=\"anchor\" href=\"#25nginx反向代理\">#</a> 2.5.nginx 反向代理</h2>\n<p>找到课前资料提供的 nginx 安装包：</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061440828.png\" alt=\"image-20210410103253355\" /></p>\n<p>解压到任意非中文目录下：</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061440364.png\" alt=\"image-20210410103322874\" /></p>\n<p>修改 conf/nginx.conf 文件，配置如下：</p>\n<figure class=\"highlight nginx\"><figcaption data-lang=\"nginx\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token directive\"><span class=\"token keyword\">http</span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   <span class=\"token directive\"><span class=\"token keyword\">upstream</span> nacos-cluster</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    \t<span class=\"token directive\"><span class=\"token keyword\">server</span> 127.0.0.1:8845</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t\t<span class=\"token directive\"><span class=\"token keyword\">server</span> 127.0.0.1:8846</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\t<span class=\"token directive\"><span class=\"token keyword\">server</span> 127.0.0.1:8847</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token directive\"><span class=\"token keyword\">server</span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    \t<span class=\"token directive\"><span class=\"token keyword\">listen</span>       <span class=\"token number\">80</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    \t<span class=\"token directive\"><span class=\"token keyword\">server_name</span>  localhost</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    \t<span class=\"token directive\"><span class=\"token keyword\">location</span> /nacos</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token directive\"><span class=\"token keyword\">proxy_pass</span> http://nacos-cluster</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    \t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>完整的配置文件信息：</p>\n<pre><code>\n#user  nobody;\nworker_processes  1;\n\n#error_log  logs/error.log;\n#error_log  logs/error.log  notice;\n#error_log  logs/error.log  info;\n\n#pid        logs/nginx.pid;\n\n\nevents &#123;\n    worker_connections  1024;\n&#125;\n\n\nhttp &#123;\n    include       mime.types;\n    default_type  application/octet-stream;\n\n    #log_format  main  '$remote_addr - $remote_user [$time_local] &quot;$request&quot; '\n    #                  '$status $body_bytes_sent &quot;$http_referer&quot; '\n    #                  '&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;';\n\n    #access_log  logs/access.log  main;\n\n    sendfile        on;\n    #tcp_nopush     on;\n\n    #keepalive_timeout  0;\n    keepalive_timeout  65;\n\n    #gzip  on;\n\n    server &#123;\n        listen       88;\n        server_name  localhost;\n\n        location / &#123;\n            root   html;\n            index  index.html index.htm;\n        &#125;\n        error_page   500 502 503 504  /50x.html;\n        location = /50x.html &#123;\n            root   html;\n        &#125;\n    &#125;\n\tupstream nacos-cluster &#123;\n    \t\tserver 127.0.0.1:8845;\n\t\tserver 127.0.0.1:8846;\n\t\tserver 127.0.0.1:8847;\n\t&#125;\n\n\tserver &#123;\n    \t\tlisten       80;\n    \t\tserver_name  localhost;\n\n    \t\tlocation /nacos &#123;\n        \t\tproxy_pass http://nacos-cluster;\n    \t\t&#125;\n\t&#125;\n&#125;\n</code></pre>\n<p>配置完成后启动 nginx，执行命令：start nginx.exe</p>\n<p>访问：<span class=\"exturl\" data-url=\"aHR0cDovL2xvY2FsaG9zdDo4OC8lRTYlOUYlQTUlRTclOUMlOEIlRTYlOTglQUYlRTUlOTAlQTYlRTglODMlQkQlRTYlQUQlQTMlRTUlQjglQjglRTglQUUlQkYlRTklOTclQUU=\">http://localhost:88 / 查看是否能正常访问</span></p>\n<p>nginx 启动成功！</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061521543.png\" alt=\"image-20231006152139209\" /></p>\n<p>而后在浏览器访问：<span class=\"exturl\" data-url=\"aHR0cDovL2xvY2FsaG9zdC9uYWNvcyVFNSU4RCVCMyVFNSU4RiVBRiVFMyU4MCU4Mg==\">http://localhost/nacos 即可。</span></p>\n<p>到这儿！集群搭建就成功了。看着像是访问的一个 nacos，事实上它会在三个 nacos 之间做一个负载均衡</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061522455.png\" alt=\"image-20231006152205310\" /></p>\n<p>问题来了，java 代码该如何配呢，在 java 的 yml 配置文件中将 nacos 的服务地址改为对应的端口也就是 80 端口</p>\n<p>代码中 bootstrap.yml 文件配置如下：</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">application</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> userservice <span class=\"token comment\"># 服务名称</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">profiles</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token key atrule\">active</span><span class=\"token punctuation\">:</span> dev <span class=\"token comment\"># 环境</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token key atrule\">cloud</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token key atrule\">nacos</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      <span class=\"token key atrule\">server-addr</span><span class=\"token punctuation\">:</span> localhost<span class=\"token punctuation\">:</span><span class=\"token number\">80</span> <span class=\"token comment\"># nacos 地址，这里找的是 nginx 反向代理的地址它会根据负载均衡来启动 nacos</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token key atrule\">config</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token key atrule\">file-extension</span><span class=\"token punctuation\">:</span> yaml <span class=\"token comment\"># 配置文件后缀名</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># 三要素：服务名称，环境，后缀名 而这三个决定了 DateId</span></pre></td></tr></table></figure><p>启动 user-service 服务</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061528874.png\" alt=\"image-20231006152811433\" /></p>\n<p>我们查看 nacos 控制台中的服务列表。</p>\n<p>可以看到成功的注册进来了。</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061528168.png\" alt=\"image-20231006152847028\" /></p>\n<p>我们创建一个配置文件，点击发布</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061544827.png\" alt=\"image-20231006154304156\" /></p>\n<p>发布后查看数据库中的 config_info 表里面的信息，就可以看到多了一条信息就是创建的环境配置文件的信息</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061545446.png\" alt=\"image-20231006154339296\" /></p>\n<blockquote>\n<p><strong>总结</strong>：</p>\n<p>集群搭建步骤：</p>\n<ol>\n<li>搭建 MySQL 集群并初始化数据库表</li>\n<li>下载解压 nacos</li>\n<li>修改集群配置 (节点信息)，数据库配置</li>\n<li>分别启动多个 nacos 节点</li>\n<li>nginx 反向代理</li>\n</ol>\n</blockquote>\n<h2 id=\"26优化\"><a class=\"anchor\" href=\"#26优化\">#</a> 2.6. 优化</h2>\n<ul>\n<li>\n<p>实际部署时，需要给做反向代理的 nginx 服务器设置一个域名，这样后续如果有服务器迁移 nacos 的客户端也无需更改配置.</p>\n</li>\n<li>\n<p>Nacos 的各个节点应该部署到多个不同服务器，做好容灾和隔离</p>\n</li>\n</ul>\n",
            "tags": [
                "计算机学科",
                "集群",
                "springcloud",
                "Nacos"
            ]
        },
        {
            "id": "https://pigpigletsgo.github.io/homepage/2024/01/24/computer-science/java/spring/springcloud/Nacos/Nacos%E5%AE%89%E8%A3%85%E6%8C%87%E5%8D%97/",
            "url": "https://pigpigletsgo.github.io/homepage/2024/01/24/computer-science/java/spring/springcloud/Nacos/Nacos%E5%AE%89%E8%A3%85%E6%8C%87%E5%8D%97/",
            "title": "Nacos安装指南",
            "date_published": "2024-01-24T10:48:46.201Z",
            "content_html": "<h1 id=\"nacos安装指南\"><a class=\"anchor\" href=\"#nacos安装指南\">#</a> Nacos 安装指南</h1>\n<h1 id=\"1windows安装\"><a class=\"anchor\" href=\"#1windows安装\">#</a> 1.Windows 安装</h1>\n<p>开发阶段采用单机安装即可。</p>\n<h2 id=\"11下载安装包\"><a class=\"anchor\" href=\"#11下载安装包\">#</a> 1.1. 下载安装包</h2>\n<p>在 Nacos 的 GitHub 页面，提供有下载链接，可以下载编译好的 Nacos 服务端或者源代码：</p>\n<p>GitHub 主页：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2FsaWJhYmEvbmFjb3M=\">https://github.com/alibaba/nacos</span></p>\n<p>GitHub 的 Release 下载页：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2FsaWJhYmEvbmFjb3MvcmVsZWFzZXM=\">https://github.com/alibaba/nacos/releases</span></p>\n<p>如图：</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051218392.png\" alt=\"image-20210402161102887\" /></p>\n<p>本课程采用 1.4.1. 版本的 Nacos，课前资料已经准备了安装包：</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051218840.png\" alt=\"image-20210402161130261\" /></p>\n<p>windows 版本使用 <code>nacos-server-1.4.1.zip</code>  包即可。</p>\n<h2 id=\"12解压\"><a class=\"anchor\" href=\"#12解压\">#</a> 1.2. 解压</h2>\n<p>将这个包解压到任意非中文目录下，如图：</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051218669.png\" alt=\"image-20210402161843337\" /></p>\n<p>目录说明：</p>\n<ul>\n<li>bin：启动脚本</li>\n<li>conf：配置文件</li>\n</ul>\n<h2 id=\"13端口配置\"><a class=\"anchor\" href=\"#13端口配置\">#</a> 1.3. 端口配置</h2>\n<p>Nacos 的默认端口是 8848，如果你电脑上的其它进程占用了 8848 端口，请先尝试关闭该进程。</p>\n<p><strong>如果无法关闭占用 8848 端口的进程</strong>，也可以进入 nacos 的 conf 目录，修改配置文件中的端口：</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051218946.png\" alt=\"image-20210402162008280\" /></p>\n<p>修改其中的内容：</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051218758.png\" alt=\"image-20210402162251093\" /></p>\n<h2 id=\"14启动\"><a class=\"anchor\" href=\"#14启动\">#</a> 1.4. 启动</h2>\n<p>启动非常简单，进入 bin 目录，结构如下：</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051218561.png\" alt=\"image-20210402162350977\" /></p>\n<p>然后执行命令即可：</p>\n<ul>\n<li>\n<p>windows 命令：</p>\n<pre><code>startup.cmd -m standalone\n</code></pre>\n</li>\n</ul>\n<p>执行后的效果如图：</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051218179.png\" alt=\"image-20210402162526774\" /></p>\n<h2 id=\"15访问\"><a class=\"anchor\" href=\"#15访问\">#</a> 1.5. 访问</h2>\n<p>在浏览器输入地址：<span class=\"exturl\" data-url=\"aHR0cDovLzEyNy4wLjAuMTo4ODQ4L25hY29zJUU1JThEJUIzJUU1JThGJUFGJUVGJUJDJTlB\">http://127.0.0.1:8848/nacos 即可：</span></p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051218689.png\" alt=\"image-20210402162630427\" /></p>\n<p>默认的账号和密码都是 nacos，进入后：</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051218382.png\" alt=\"image-20210402162709515\" /></p>\n<h1 id=\"2linux安装\"><a class=\"anchor\" href=\"#2linux安装\">#</a> 2.Linux 安装</h1>\n<p>Linux 或者 Mac 安装方式与 Windows 类似。</p>\n<h2 id=\"21安装jdk\"><a class=\"anchor\" href=\"#21安装jdk\">#</a> 2.1. 安装 JDK</h2>\n<p>Nacos 依赖于 JDK 运行，所以 Linux 上也需要安装 JDK 才行。</p>\n<p>上传 jdk 安装包：</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051218243.png\" alt=\"image-20210402172334810\" /></p>\n<p>上传到某个目录，例如： <code>/usr/local/</code></p>\n<p>然后解压缩：</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">tar</span> <span class=\"token parameter variable\">-xvf</span> jdk-8u144-linux-x64.tar.gz</pre></td></tr></table></figure><p>然后重命名为 java</p>\n<p>配置环境变量：</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">JAVA_HOME</span><span class=\"token operator\">=</span>/usr/local/java</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\"><span class=\"token environment constant\">PATH</span></span><span class=\"token operator\">=</span><span class=\"token environment constant\">$PATH</span><span class=\"token builtin class-name\">:</span><span class=\"token variable\">$JAVA_HOME</span>/bin</pre></td></tr></table></figure><p>刷新环境变量：</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">source</span> /etc/profile</pre></td></tr></table></figure><h2 id=\"22上传安装包\"><a class=\"anchor\" href=\"#22上传安装包\">#</a> 2.2. 上传安装包</h2>\n<p>如图：</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051218879.png\" alt=\"image-20210402161102887\" /></p>\n<p>也可以直接使用课前资料中的 tar.gz：</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051218287.png\" alt=\"image-20210402161130261\" /></p>\n<p>上传到 Linux 服务器的某个目录，例如 <code>/usr/local/src</code>  目录下：</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051218025.png\" alt=\"image-20210402163715580\" /></p>\n<h2 id=\"23解压\"><a class=\"anchor\" href=\"#23解压\">#</a> 2.3. 解压</h2>\n<p>命令解压缩安装包：</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">tar</span> <span class=\"token parameter variable\">-xvf</span> nacos-server-1.4.1.tar.gz</pre></td></tr></table></figure><p>然后删除安装包：</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">rm</span> <span class=\"token parameter variable\">-rf</span> nacos-server-1.4.1.tar.gz</pre></td></tr></table></figure><p>目录中最终样式：</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051218677.png\" alt=\"image-20210402163858429\" /></p>\n<p>目录内部：</p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051218771.png\" alt=\"image-20210402164414827\" /></p>\n<h2 id=\"24端口配置\"><a class=\"anchor\" href=\"#24端口配置\">#</a> 2.4. 端口配置</h2>\n<p>与 windows 中类似</p>\n<h2 id=\"25启动\"><a class=\"anchor\" href=\"#25启动\">#</a> 2.5. 启动</h2>\n<p>在 nacos/bin 目录中，输入命令启动 Nacos：</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sh</span> startup.sh <span class=\"token parameter variable\">-m</span> standalone</pre></td></tr></table></figure><h1 id=\"3nacos的依赖\"><a class=\"anchor\" href=\"#3nacos的依赖\">#</a> 3.Nacos 的依赖</h1>\n<p>父工程：</p>\n<figure class=\"highlight xml\"><figcaption data-lang=\"XML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">></span></span>com.alibaba.cloud<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">></span></span>spring-cloud-alibaba-dependencies<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>version</span><span class=\"token punctuation\">></span></span>2.2.5.RELEASE<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>version</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>type</span><span class=\"token punctuation\">></span></span>pom<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>type</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>scope</span><span class=\"token punctuation\">></span></span>import<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>scope</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">></span></span></pre></td></tr></table></figure><p>客户端：</p>\n<figure class=\"highlight xml\"><figcaption data-lang=\"XML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">&lt;!-- nacos 客户端依赖包 --></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">></span></span>com.alibaba.cloud<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">></span></span>spring-cloud-starter-alibaba-nacos-discovery<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">></span></span></pre></td></tr></table></figure><h1 id=\"4-docker安装nacos\"><a class=\"anchor\" href=\"#4-docker安装nacos\">#</a> 4. Docker 安装 nacos</h1>\n<p>通过指定 Nacos 镜像的标签（tag）来选择特定版本。对于 Nacos 1.4.1 版本，你可以使用  <code>**1.4.1**</code>  标签。以下是在 Linux 的 Docker 中创建一个 Nacos 1.4.1 容器的步骤：</p>\n<ol>\n<li>\n<p><strong>拉取 Nacos 1.4.1 镜像</strong>:</p>\n<p>打开终端，执行以下命令拉取 Nacos 1.4.1 镜像：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">docker</span> pull nacos/nacos-server:1.4.1</pre></td></tr></table></figure><p>这将从 Docker Hub 上下载 Nacos 1.4.1 版本的官方镜像</p>\n</li>\n<li>\n<p>创建数据库我们到数据库中先创建一个数据库名为 nacos 或者随意都行</p>\n<p>sql 表 到官网的 github 中 copy 就行了然后创建即可：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2FsaWJhYmEvbmFjb3MvYmxvYi9tYXN0ZXIvY29uZmlnL3NyYy9tYWluL3Jlc291cmNlcy9NRVRBLUlORi9uYWNvcy1kYi5zcWw=\">https://github.com/alibaba/nacos/blob/master/config/src/main/resources/META-INF/nacos-db.sql</span></p>\n<p><img data-src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/image-20240322085318286.png\" alt=\"image-20240322085318286\" /></p>\n<p>2.1 创建挂在目录和配置文件如下</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /mydata/nacos/logs/                      <span class=\"token comment\">#新建 logs 目录</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /mydata/nacos/init.d/          </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">vim</span> /mydata/nacos/init.d/custom.properties        <span class=\"token comment\">#修改配置文件</span></pre></td></tr></table></figure><p>修改 custom.properties 配置文件：</p>\n<p>把下面的数据库连接配置修改为自己的</p>\n<figure class=\"highlight properties\"><figcaption data-lang=\".properties\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key attr-name\">server.contextPath</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">/nacos</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key attr-name\">server.servlet.contextPath</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">/nacos</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key attr-name\">server.port</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">8848</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token key attr-name\">spring.datasource.platform</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">mysql</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key attr-name\">db.num</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">1</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token key attr-name\">db.url.0</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">jdbc:mysql://xx.xx.xx.x:3306/nacos_config? characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true #这里需要修改端口</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token key attr-name\">db.user</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">user #用户名</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token key attr-name\">db.password</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">pass #密码</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token key attr-name\">nacos.cmdb.dumpTaskInterval</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">3600</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token key attr-name\">nacos.cmdb.eventTaskInterval</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">10</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token key attr-name\">nacos.cmdb.labelTaskInterval</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">300</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token key attr-name\">nacos.cmdb.loadDataAtStart</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">false</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token key attr-name\">management.metrics.export.elastic.enabled</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">false</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token key attr-name\">management.metrics.export.influx.enabled</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">false</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token key attr-name\">server.tomcat.accesslog.enabled</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">true</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token key attr-name\">server.tomcat.accesslog.pattern</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">%h %l %u %t \"%r\" %s %b %D %&#123;User-Agent&#125;i</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token key attr-name\">nacos.security.ignore.urls</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">/,/**/*.css,/**/*.js,/**/*.html,/**/*.map,/**/*.svg,/**/*.png,/**/*.ico,/console-fe/public/**,/v1/auth/login,/v1/console/health/**,/v1/cs/**,/v1/ns/**,/v1/cmdb/**,/actuator/**,/v1/console/server/**</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token key attr-name\">nacos.naming.distro.taskDispatchThreadCount</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">1</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token key attr-name\">nacos.naming.distro.taskDispatchPeriod</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">200</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token key attr-name\">nacos.naming.distro.batchSyncKeyCount</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">1000</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token key attr-name\">nacos.naming.distro.initDataRatio</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">0.9</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token key attr-name\">nacos.naming.distro.syncRetryDelay</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">5000</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token key attr-name\">nacos.naming.data.warmup</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">true</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token key attr-name\">nacos.naming.expireInstance</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">true</span></pre></td></tr></table></figure></li>\n<li>\n<p><strong>创建并运行 Nacos 容器</strong>:</p>\n<p>执行以下命令创建并运行 Nacos 容器：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">docker</span>  run <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token parameter variable\">--name</span> nacos <span class=\"token parameter variable\">-d</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token parameter variable\">-p</span> <span class=\"token number\">8848</span>:8848 <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token parameter variable\">--privileged</span><span class=\"token operator\">=</span>true <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token parameter variable\">--restart</span><span class=\"token operator\">=</span>always <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">JVM_XMS</span><span class=\"token operator\">=</span>256m <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">JVM_XMX</span><span class=\"token operator\">=</span>256m <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">MODE</span><span class=\"token operator\">=</span>standalone <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">PREFER_HOST_MODE</span><span class=\"token operator\">=</span>hostname <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token parameter variable\">-v</span> /mydata/nacos/logs:/home/nacos/logs <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token parameter variable\">-v</span> /mydata/nacos/init.d/custom.properties:/home/nacos/init.d/custom.properties <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>nacos/nacos-server</pre></td></tr></table></figure><p>可用设置：docker update --restart=always  nacos</p>\n<p>这将在后台运行一个名为  <code>**nacos-server**</code>  的容器，并将容器的 8848 端口映射到主机的 8848 端口。</p>\n<p>参数说明：</p>\n<ul>\n<li>-e MODE=standalone 单机启动</li>\n<li>--restart=always 启动 docker 时自动启动 nacos</li>\n</ul>\n</li>\n</ol>\n",
            "tags": [
                "计算机学科",
                "基础",
                "springcloud",
                "Nacos"
            ]
        }
    ]
}