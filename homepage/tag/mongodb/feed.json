{
    "version": "https://jsonfeed.org/version/1",
    "title": "homepage • All posts by \"mongodb\" tag",
    "description": "欢迎来我的博客空间",
    "home_page_url": "https://pigpigletsgo.github.io/homepage",
    "items": [
        {
            "id": "https://pigpigletsgo.github.io/homepage/2024/04/02/computer-science/database/mongodb/%E6%A1%88%E4%BE%8BDemo/MongoDB%20%E5%88%86%E9%A1%B5/",
            "url": "https://pigpigletsgo.github.io/homepage/2024/04/02/computer-science/database/mongodb/%E6%A1%88%E4%BE%8BDemo/MongoDB%20%E5%88%86%E9%A1%B5/",
            "title": "MongoDB 分页",
            "date_published": "2024-04-02T06:23:30.053Z",
            "content_html": "<h1 id=\"mongodb-分页\"><a class=\"markdownIt-Anchor\" href=\"#mongodb-分页\">#</a> MongoDB 分页</h1>\n<p>数据层：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Repository</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">ArticleRepository</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">MongoRepository</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Article</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>     * 分页</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>     * @param pageable</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>     * @return</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>     */</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token class-name\">Page</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Article</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findAllBy</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Pageable</span> pageable<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token comment\">// 按照条件查询并分页</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token comment\">// Page&lt;Article> findAllByState(String state, Pageable pageable);</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>业务层接口：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">EssayService</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token class-name\">R</span> <span class=\"token function\">getAll</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Pageable</span> pageable<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>业务层实现：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Service</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token annotation punctuation\">@AllArgsConstructor</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">EssayServiceImpl</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">EssayService</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token comment\">// 查询全部文章并分页</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">R</span> <span class=\"token function\">getAll</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Pageable</span> pageable<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token class-name\">R</span><span class=\"token punctuation\">.</span><span class=\"token function\">ok</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"data\"</span><span class=\"token punctuation\">,</span> repository<span class=\"token punctuation\">.</span><span class=\"token function\">findAllBy</span><span class=\"token punctuation\">(</span>pageable<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token comment\">// 第一个参数就是条件</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token comment\">// return R.ok().put(\"data\", repository.findAllByState(MongoDels.EX.getCode(), pageable));</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>视图层：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@RestController</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token annotation punctuation\">@RequestMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/essay\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token annotation punctuation\">@AllArgsConstructor</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">EssayController</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>     * 查询全部文章并分页</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>     * @return</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>     */</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"essayAll\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">R</span> <span class=\"token function\">getAll</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Pageable</span> pageable<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token keyword\">return</span> service<span class=\"token punctuation\">.</span><span class=\"token function\">getAll</span><span class=\"token punctuation\">(</span>pageable<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>请求结果：</p>\n<pre><code>&#123;\n    &quot;code&quot;: 200,\n    &quot;data&quot;: &#123;\n        &quot;content&quot;: [\n            &#123;\n                &quot;id&quot;: &quot;660666210c39a27771d075fb&quot;,\n                &quot;content&quot;: &quot;ullamco&quot;,\n                &quot;tags&quot;: [\n                    &quot;ea33&quot;\n                ],\n                &quot;publishtime&quot;: &quot;2024-03-29 14:56:33&quot;,\n                &quot;userid&quot;: &quot;1&quot;,\n                &quot;nickname&quot;: &quot;123&quot;,\n                &quot;createdatatime&quot;: &quot;2024-03-29 14:56:33&quot;,\n                &quot;likenum&quot;: 0,\n                &quot;state&quot;: &quot;0&quot;\n            &#125;\n        ],\n        &quot;pageable&quot;: &#123;\n            &quot;sort&quot;: &#123;\n                &quot;empty&quot;: true,\n                &quot;sorted&quot;: false,\n                &quot;unsorted&quot;: true\n            &#125;,\n            &quot;offset&quot;: 0,\n            &quot;pageSize&quot;: 1,\n            &quot;pageNumber&quot;: 0,\n            &quot;unpaged&quot;: false,\n            &quot;paged&quot;: true\n        &#125;,\n        &quot;last&quot;: true,\n        &quot;totalPages&quot;: 1,\n        &quot;totalElements&quot;: 1,\n        &quot;size&quot;: 1,\n        &quot;number&quot;: 0,\n        &quot;sort&quot;: &#123;\n            &quot;empty&quot;: true,\n            &quot;sorted&quot;: false,\n            &quot;unsorted&quot;: true\n        &#125;,\n        &quot;numberOfElements&quot;: 1,\n        &quot;first&quot;: true,\n        &quot;empty&quot;: false\n    &#125;\n&#125;\n</code></pre>\n",
            "tags": [
                "计算机学科",
                "案例Demo",
                "database",
                "mongodb"
            ]
        },
        {
            "id": "https://pigpigletsgo.github.io/homepage/2024/04/02/computer-science/database/mongodb/MongoDB%E9%9B%86%E7%BE%A4%E5%92%8C%E5%AE%89%E5%85%A8/",
            "url": "https://pigpigletsgo.github.io/homepage/2024/04/02/computer-science/database/mongodb/MongoDB%E9%9B%86%E7%BE%A4%E5%92%8C%E5%AE%89%E5%85%A8/",
            "title": "MongoDB集群和安全",
            "date_published": "2024-04-02T06:23:30.045Z",
            "content_html": "<h1 id=\"mongodb集群和安全\"><a class=\"markdownIt-Anchor\" href=\"#mongodb集群和安全\">#</a> MongoDB 集群和安全</h1>\n<p>学习目标：</p>\n<ul>\n<li>MongoDB 的副本集：操作，主要概念，故障转移，选举规则</li>\n<li>MongoDB 的分片集群：概念，有点，操作，分片策略，故障转移</li>\n<li>MongoDB 的安全认证</li>\n</ul>\n<h2 id=\"副本集-replica-sets\"><a class=\"markdownIt-Anchor\" href=\"#副本集-replica-sets\">#</a> 副本集 - Replica Sets</h2>\n<h3 id=\"简介\"><a class=\"markdownIt-Anchor\" href=\"#简介\">#</a> 简介</h3>\n<p>MongoDB 中的副本集 (Replica Set) 是一组维护相同数据集的 mongod 服务，副本集可提供冗余和高可用性，是所有生产部署的基础。</p>\n<p>也可以说，副本集类似于有自动故障恢复功能的主从集群，通俗的讲就是多台机器进行同一数据的异步同步，从而使多台机器拥有同一数据的多个副本，并且当主库宕掉时在不需要用户干预的情况下自动切换其它备份服务器做主库，而且还可以利用副本服务器做只读服务器，实现读写分离，提高负载</p>\n<p>1. 冗余和数据可用性</p>\n<p>复制提供冗余并提高数据可用性，通过在不同数据库服务器上提供多个数据副本，复制可提供一定级别的容错功能，以防丢失单个数据库服务器。</p>\n<p>在某些情况下，复制可以提供增加的读取性能，因为客户端可以将读取操作发送到不同的服务上，在不同数据中心维护数据副本可以增加分布式应用程序的数据位置和可用性，您还可以为专用目的维护其它副本，例如灾难恢复，报告或备份。</p>\n<p>2.MongoDB 中的复制</p>\n<p>副本集是一组维护相同数据集的 mongod 实例，副本集包含了多个数据承载节点和可选的一个仲载节点，在承载数据节点中，一个且仅一个成员被视为主节点，而其它节点被视为次要（从）节点。<br>\n主节点接受所有写操作，副本集只能有一个主要能够确认具有 {w:“most”} 写入关注的写入；虽然在某些情况下，另一个 mongod 实例可能暂时认为自己也是主要的，主要记录其操作日志中的数据集的所有更改，即 oplog。</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031657901.png\" alt=\"image-20230605120258300\"></p>\n<p>辅助 (副本) 节点复制主节点的 oplog 并将操作应用于其数据集，以使辅助节点的数据集反射主节点的数据集，如果主要人员不在，则符合条件的中学将举行选举以选出新的主要人员</p>\n<p>3. 主从复制和副本集区别</p>\n<p>主从集群和副本集最大的区别就是副本集没有固定的 &quot;主节点&quot;；整个集群会选出一个 &quot;主节点&quot;，当其挂掉后，又在剩下的从节点中选中其它节点为 &quot;主节点&quot;，副本集总有一个活跃点 (主，primary) 和一个或多个备份节点 (从，secondary)。</p>\n<h2 id=\"副本集的三个角色\"><a class=\"markdownIt-Anchor\" href=\"#副本集的三个角色\">#</a> 副本集的三个角色</h2>\n<p>副本集有两种类型三种角色</p>\n<p>两种类型：</p>\n<ul>\n<li>主节点 (primary) 类型：数据操作的主要连接点，可读写。</li>\n<li>次要 (辅助，从) 节点 (Secondaries) 类型：数据冗余备份节点，可以读或选举</li>\n</ul>\n<p>三种角色</p>\n<p>主要成员 (Primary)：主要接受所有写操作，就是主节点</p>\n<p>副本成员 (Replicate)：从主节点通过复制操作以维护相同的数据集，即备份数据，不可写操作，但可以读操作 (但需要配置)。是默认的一种从节点类型</p>\n<p>仲裁者 (Arbiter)：不保留任何数据的副本，只具有投票选举作用，当然也可以将仲载服务器维护为副本集的一部分，即副本成员同时也是仲载者，也是一种从节点类型</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031656412.png\" alt=\"image-20230605121334168\"></p>\n<p>一<mark>主</mark>一<mark>副</mark>一<mark>仲载</mark></p>\n<h2 id=\"副本集的创建\"><a class=\"markdownIt-Anchor\" href=\"#副本集的创建\">#</a> 副本集的创建</h2>\n<h3 id=\"第一步创建主节点\"><a class=\"markdownIt-Anchor\" href=\"#第一步创建主节点\">#</a> 第一步创建主节点</h3>\n<p>建立存放数据和日志的目录</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#----------myrs</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#主节点</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /mongodb/replica_sets/myrs_27017/log <span class=\"token punctuation\">\\</span> <span class=\"token operator\">&amp;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /mongodb/replica_sets/myrs_27017/data/db</pre></td></tr></table></figure><p>新建或修改配置文件：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">vim</span> /mongodb/replica_sets/myrs_27017/mongod.conf</pre></td></tr></table></figure><p>往配置文件中写入配置信息</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">systemLog</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token comment\">#MongoDB 发送所有日志输出的目标指定为文件</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> <span class=\"token comment\">#The path of the log file to which mongod or mongos should send all diagnostic logging information</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre> <span class=\"token key atrule\">destination</span><span class=\"token punctuation\">:</span> file</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> <span class=\"token comment\">#mongod 或 mongos 应向其发送所有诊断日志记录信息的日志文件的路径</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"/mongodb/replica_sets/myrs_27017/log/mongod.log\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre> <span class=\"token comment\">#当 mongos 或 mongod 实例重新启动时，mongos 或 mongod 会将新条目附加到现有日志文件的末尾。</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre> <span class=\"token key atrule\">logAppend</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token key atrule\">storage</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre> <span class=\"token comment\">#mongod 实例存储其数据的目录。storage.dbPath 设置仅适用于 mongod。</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre> <span class=\"token comment\">#The directory where the mongod instance stores its data.Defaul value is \"/data/db\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre> <span class=\"token key atrule\">dbPath</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"/mongodb/replica_sets/myrs_27017/data/db\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre> <span class=\"token key atrule\">journal</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token comment\">#启用或禁用持久性日志以确保数据文件保持有效和可恢复</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token key atrule\">processManagement</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token comment\">#启用在后台运行 mongos 或 mongod 进程的守护进程模式。</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre> <span class=\"token key atrule\">fork</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre> <span class=\"token comment\">#指定用于保存 mongos 或 mongod 进程的进行 ID 的文件位置，其中 mongos 或 mongod 将写入其 PID</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre> <span class=\"token key atrule\">pidFilePath</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"/mongodb/replica_sets/myrs_27017/log/mongod.pid\"</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token key atrule\">net</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token comment\">#服务实例绑定 IP，默认是 localhost</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre> <span class=\"token key atrule\">bindIp</span><span class=\"token punctuation\">:</span> localhost<span class=\"token punctuation\">,</span>192.168.244.142</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token comment\">#bindIp</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token comment\">#绑定的端口，默认是 27017</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre> <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">27017</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token key atrule\">replication</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre> <span class=\"token comment\">#副本集的名称</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre> <span class=\"token key atrule\">replSetName</span><span class=\"token punctuation\">:</span> myrs</pre></td></tr></table></figure><h3 id=\"第二步创建副本节点\"><a class=\"markdownIt-Anchor\" href=\"#第二步创建副本节点\">#</a> 第二步：创建副本节点</h3>\n<p>建立存放目录</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#----------myrs</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#主节点</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /mongodb/replica_sets/myrs_27018/log <span class=\"token punctuation\">\\</span> <span class=\"token operator\">&amp;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /mongodb/replica_sets/myrs_27018/data/db</pre></td></tr></table></figure><p>新建或修改配置文件:</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">vim</span> /mongodb/replica_sets/myrs_27018/mongod.conf</pre></td></tr></table></figure><p>往配置文件中写入配置信息</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">systemLog</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token comment\">#MongoDB 发送所有日志输出的目标指定为文件</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> <span class=\"token comment\">#The path of the log file to which mongod or mongos should send all diagnostic logging information</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre> <span class=\"token key atrule\">destination</span><span class=\"token punctuation\">:</span> file</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> <span class=\"token comment\">#mongod 或 mongos 应向其发送所有诊断日志记录信息的日志文件的路径</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"/mongodb/replica_sets/myrs_27018/log/mongod.log\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre> <span class=\"token comment\">#当 mongos 或 mongod 实例重新启动时，mongos 或 mongod 会将新条目附加到现有日志文件的末尾。</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre> <span class=\"token key atrule\">logAppend</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token key atrule\">storage</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre> <span class=\"token comment\">#mongod 实例存储其数据的目录。storage.dbPath 设置仅适用于 mongod。</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre> <span class=\"token comment\">#The directory where the mongod instance stores its data.Defaul value is \"/data/db\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre> <span class=\"token key atrule\">dbPath</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"/mongodb/replica_sets/myrs_27018/data/db\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre> <span class=\"token key atrule\">journal</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token comment\">#启用或禁用持久性日志以确保数据文件保持有效和可恢复</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token key atrule\">processManagement</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token comment\">#启用在后台运行 mongos 或 mongod 进程的守护进程模式。</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre> <span class=\"token key atrule\">fork</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre> <span class=\"token comment\">#指定用于保存 mongos 或 mongod 进程的进行 ID 的文件位置，其中 mongos 或 mongod 将写入其 PID</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre> <span class=\"token key atrule\">pidFilePath</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"/mongodb/replica_sets/myrs_27018/log/mongod.pid\"</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token key atrule\">net</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token comment\">#服务实例绑定 IP，默认是 localhost</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre> <span class=\"token key atrule\">bindIp</span><span class=\"token punctuation\">:</span> localhost<span class=\"token punctuation\">,</span>192.168.244.142</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token comment\">#bindIp</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token comment\">#绑定的端口，默认是 27017</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre> <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">27018</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token key atrule\">replication</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre> <span class=\"token comment\">#副本集的名称</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre> <span class=\"token key atrule\">replSetName</span><span class=\"token punctuation\">:</span> myrs</pre></td></tr></table></figure><h3 id=\"第三步创建仲载节点\"><a class=\"markdownIt-Anchor\" href=\"#第三步创建仲载节点\">#</a> 第三步：创建仲载节点</h3>\n<p>建立存放目录</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#----------myrs</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#主节点</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /mongodb/replica_sets/myrs_27019/log <span class=\"token punctuation\">\\</span> <span class=\"token operator\">&amp;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /mongodb/replica_sets/myrs_27019/data/db</pre></td></tr></table></figure><p>新建或修改配置文件</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">vim</span> /mongodb/replica_sets/myrs_27019/mongod.conf</pre></td></tr></table></figure><p>往配置中写入配置信息</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">systemLog</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token comment\">#MongoDB 发送所有日志输出的目标指定为文件</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> <span class=\"token comment\">#The path of the log file to which mongod or mongos should send all diagnostic logging information</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre> <span class=\"token key atrule\">destination</span><span class=\"token punctuation\">:</span> file</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> <span class=\"token comment\">#mongod 或 mongos 应向其发送所有诊断日志记录信息的日志文件的路径</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"/mongodb/replica_sets/myrs_27019/log/mongod.log\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre> <span class=\"token comment\">#当 mongos 或 mongod 实例重新启动时，mongos 或 mongod 会将新条目附加到现有日志文件的末尾。</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre> <span class=\"token key atrule\">logAppend</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token key atrule\">storage</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre> <span class=\"token comment\">#mongod 实例存储其数据的目录。storage.dbPath 设置仅适用于 mongod。</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre> <span class=\"token comment\">#The directory where the mongod instance stores its data.Defaul value is \"/data/db\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre> <span class=\"token key atrule\">dbPath</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"/mongodb/replica_sets/myrs_27019/data/db\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre> <span class=\"token key atrule\">journal</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token comment\">#启用或禁用持久性日志以确保数据文件保持有效和可恢复</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token key atrule\">processManagement</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token comment\">#启用在后台运行 mongos 或 mongod 进程的守护进程模式。</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre> <span class=\"token key atrule\">fork</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre> <span class=\"token comment\">#指定用于保存 mongos 或 mongod 进程的进行 ID 的文件位置，其中 mongos 或 mongod 将写入其 PID</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre> <span class=\"token key atrule\">pidFilePath</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"/mongodb/replica_sets/myrs_27019/log/mongod.pid\"</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token key atrule\">net</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token comment\">#服务实例绑定 IP，默认是 localhost</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre> <span class=\"token key atrule\">bindIp</span><span class=\"token punctuation\">:</span> localhost<span class=\"token punctuation\">,</span>192.168.244.142</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token comment\">#bindIp</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token comment\">#绑定的端口，默认是 27017</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre> <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">27019</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token key atrule\">replication</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre> <span class=\"token comment\">#副本集的名称</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre> <span class=\"token key atrule\">replSetName</span><span class=\"token punctuation\">:</span> myrs</pre></td></tr></table></figure><p>启动节点</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>dkx0@192<span class=\"token punctuation\">]</span>~% /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/replica_sets/myrs_27017/log/mongod.conf </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>about to fork child process, waiting <span class=\"token keyword\">until</span> server is ready <span class=\"token keyword\">for</span> connections.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>forked process: <span class=\"token number\">5300</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>child process started successfully, parent exiting</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>dkx0@192<span class=\"token punctuation\">]</span>~% /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/replica_sets/myrs_27018/log/mongod.conf </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>about to fork child process, waiting <span class=\"token keyword\">until</span> server is ready <span class=\"token keyword\">for</span> connections.</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>forked process: <span class=\"token number\">5367</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>child process started successfully, parent exiting</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>dkx0@192<span class=\"token punctuation\">]</span>~% /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/replica_sets/myrs_27019/log/mongod.conf </pre></td></tr><tr><td data-num=\"10\"></td><td><pre>about to fork child process, waiting <span class=\"token keyword\">until</span> server is ready <span class=\"token keyword\">for</span> connections.</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>forked process: <span class=\"token number\">5434</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>child process started successfully, parent exiting</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">[</span>dkx0@192<span class=\"token punctuation\">]</span>~%</pre></td></tr></table></figure><p>查看 mongod 进程</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>dkx0@192<span class=\"token punctuation\">]</span>~% <span class=\"token function\">ps</span> -ef<span class=\"token operator\">|</span><span class=\"token function\">grep</span> mongod<span class=\"token operator\">|</span><span class=\"token function\">grep</span> <span class=\"token parameter variable\">-v</span> <span class=\"token function\">grep</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>dkx0       <span class=\"token number\">5300</span>      <span class=\"token number\">1</span>  <span class=\"token number\">4</span> 03:05 ?        00:00:04 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/replica_sets/myrs_27017/log/mongod.conf</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>dkx0       <span class=\"token number\">5367</span>      <span class=\"token number\">1</span>  <span class=\"token number\">5</span> 03:05 ?        00:00:04 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/replica_sets/myrs_27018/log/mongod.conf</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>dkx0       <span class=\"token number\">5434</span>      <span class=\"token number\">1</span>  <span class=\"token number\">8</span> 03:05 ?        00:00:05 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/replica_sets/myrs_27019/log/mongod.conf</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>dkx0@192<span class=\"token punctuation\">]</span>~%</pre></td></tr></table></figure><h3 id=\"第四步初始化配置副本集和主节点\"><a class=\"markdownIt-Anchor\" href=\"#第四步初始化配置副本集和主节点\">#</a> 第四步：初始化配置副本集和主节点</h3>\n<p>使用客户端命令连接任意一个节点，但这里尽量要连接主节点 (27017 节点)：</p>\n<p>在 mongodb 的 bin 目录下执行命令：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>mongo <span class=\"token parameter variable\">--host</span><span class=\"token operator\">=</span>Linux主机地址 <span class=\"token parameter variable\">--port</span><span class=\"token operator\">=</span><span class=\"token number\">27017</span></pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>E:<span class=\"token punctuation\">\\</span>MongoDB<span class=\"token punctuation\">\\</span>mongodb-win32-x86_64-windows-5.0.17<span class=\"token punctuation\">\\</span>bin<span class=\"token operator\">></span>mongo <span class=\"token parameter variable\">--host</span><span class=\"token operator\">=</span><span class=\"token number\">192.168</span>.244.142 <span class=\"token parameter variable\">--port</span><span class=\"token operator\">=</span><span class=\"token number\">27017</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>MongoDB shell version v5.0.17</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>connecting to: mongodb://192.168.244.142:27017/?compressors<span class=\"token operator\">=</span>disabled<span class=\"token operator\">&amp;</span><span class=\"token assign-left variable\">gssapiServiceName</span><span class=\"token operator\">=</span>mongodb</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Implicit session: session <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"id\"</span> <span class=\"token builtin class-name\">:</span> UUID<span class=\"token punctuation\">(</span><span class=\"token string\">\"7149483c-b50d-4e69-8086-b2c913d293e3\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>MongoDB server version: <span class=\"token number\">5.0</span>.18</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>Warning: the <span class=\"token string\">\"mongo\"</span> shell has been superseded by <span class=\"token string\">\"mongosh\"</span>,</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token function\">which</span> delivers improved usability and compatibility.The <span class=\"token string\">\"mongo\"</span> shell has been deprecated and will be removed <span class=\"token keyword\">in</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>an upcoming release.</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>For installation instructions, see</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>https://docs.mongodb.com/mongodb-shell/install/</pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>The server generated these startup warnings when booting:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token number\">2023</span>-06-06T03:05:22.021-04:00: Access control is not enabled <span class=\"token keyword\">for</span> the database. Read and <span class=\"token function\">write</span> access to data and configuration is unrestricted</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token number\">2023</span>-06-06T03:05:22.021-04:00: /sys/kernel/mm/transparent_hugepage/enabled is <span class=\"token string\">'always'</span><span class=\"token builtin class-name\">.</span> We suggest setting it to <span class=\"token string\">'never'</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token number\">2023</span>-06-06T03:05:22.021-04:00: /sys/kernel/mm/transparent_hugepage/defrag is <span class=\"token string\">'always'</span><span class=\"token builtin class-name\">.</span> We suggest setting it to <span class=\"token string\">'never'</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token number\">2023</span>-06-06T03:05:22.021-04:00: Soft rlimits <span class=\"token keyword\">for</span> <span class=\"token function\">open</span> <span class=\"token function\">file</span> descriptors too low</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token number\">2023</span>-06-06T03:05:22.021-04:00:         currentValue: <span class=\"token number\">1024</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token number\">2023</span>-06-06T03:05:22.021-04:00:         recommendedMinimum: <span class=\"token number\">64000</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token operator\">></span> show dbs</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>uncaught exception: Error: listDatabases failed:<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token string\">\"topologyVersion\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                <span class=\"token string\">\"processId\"</span> <span class=\"token builtin class-name\">:</span> ObjectId<span class=\"token punctuation\">(</span><span class=\"token string\">\"647edab0454f9ab55a0c8f43\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                <span class=\"token string\">\"counter\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token string\">\"ok\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>,</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token string\">\"errmsg\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"not master and slaveOk=false\"</span>,</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        <span class=\"token string\">\"code\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">13435</span>,</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token string\">\"codeName\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"NotPrimaryNoSecondaryOk\"</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">&#125;</span> <span class=\"token builtin class-name\">:</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>_getErrorWithCode@src/mongo/shell/utils.js:25:13</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>Mongo.prototype.getDBs/<span class=\"token operator\">&lt;</span>@src/mongo/shell/mongo.js:145:19</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>Mongo.prototype.getDBs@src/mongo/shell/mongo.js:97:12</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>shellHelper.show@src/mongo/shell/utils.js:956:13</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>shellHelper@src/mongo/shell/utils.js:838:15</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>@<span class=\"token punctuation\">(</span>shellhelp2<span class=\"token punctuation\">)</span>:1:1</pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token operator\">></span> show tables</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>uncaught exception: Error: listCollections failed: <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        <span class=\"token string\">\"topologyVersion\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>                <span class=\"token string\">\"processId\"</span> <span class=\"token builtin class-name\">:</span> ObjectId<span class=\"token punctuation\">(</span><span class=\"token string\">\"647edab0454f9ab55a0c8f43\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>                <span class=\"token string\">\"counter\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        <span class=\"token string\">\"ok\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>,</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        <span class=\"token string\">\"errmsg\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"not master and slaveOk=false\"</span>,</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        <span class=\"token string\">\"code\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">13435</span>,</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        <span class=\"token string\">\"codeName\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"NotPrimaryNoSecondaryOk\"</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token punctuation\">&#125;</span> <span class=\"token builtin class-name\">:</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>_getErrorWithCode@src/mongo/shell/utils.js:25:13</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>DB.prototype._getCollectionInfosCommand@src/mongo/shell/db.js:723:15</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>DB.prototype.getCollectionInfos@src/mongo/shell/db.js:771:16</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>shellHelper.show@src/mongo/shell/utils.js:943:9</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>shellHelper@src/mongo/shell/utils.js:838:15</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>@<span class=\"token punctuation\">(</span>shellhelp2<span class=\"token punctuation\">)</span>:1:1</pre></td></tr><tr><td data-num=\"56\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr></table></figure><p>结果，连接上之后，很多命令无法使用，比如 <code>show dbs，show tables</code>  等，必须初始化副本集才行</p>\n<p>准备初始化新的副本集：</p>\n<p>语法：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>rs.initiate<span class=\"token punctuation\">(</span>configuration<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>选项：</p>\n<table>\n<caption id=\"\" style=\"caption-side: bottom\">示例</caption>\n<thead>\n<tr>\n<th>Parameter</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>configuration</td>\n<td>document</td>\n<td>Optional.A document that specifiles configuration for the new replicaset. if a configuration is not specifiled,MongoDB uses a default replicaset configuration</td>\n</tr>\n</tbody>\n</table>\n<p>使用默认的配置来初始化副本集：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>rs.initiate<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>执行结果：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> rs.<span class=\"token function-name function\">initiate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token string\">\"info2\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"no configuration specified. Using a default configuration for the set\"</span>,</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token string\">\"me\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"192.168.244.142:27017\"</span>,</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token string\">\"ok\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>myrs:SECONDARY<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>myrs:PRIMARY<span class=\"token operator\">></span></pre></td></tr></table></figure><p>提示：</p>\n<ol>\n<li>&quot;ok&quot; 的值为 1，说明创建成功</li>\n<li>命令行提示符发生变化，变成了一个从节点角色，此时默认不能读写，稍等片刻，回车，变成主节点。</li>\n</ol>\n<h3 id=\"第五步查看副本集的配置内容\"><a class=\"markdownIt-Anchor\" href=\"#第五步查看副本集的配置内容\">#</a> 第五步：查看副本集的配置内容</h3>\n<p>说明：</p>\n<p>返回包含当前副本集配置的文档</p>\n<p>语法：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>rs.conf<span class=\"token punctuation\">(</span>configuration<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>提示：</p>\n<p><code>rs.config()</code>  是该方法的别名</p>\n<p>configuration：可选，如果没有位置，则使用默认主节点配置</p>\n<p>[示例]</p>\n<p>在 27017 上执行副本集中当前节点的默认节点配置</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>myrs:PRIMARY<span class=\"token operator\">></span> rs.<span class=\"token function-name function\">conf</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"myrs\"</span>,</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token string\">\"version\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token string\">\"term\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token string\">\"members\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                        <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>,</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                        <span class=\"token string\">\"host\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"192.168.244.142:27017\"</span>,</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                        <span class=\"token string\">\"arbiterOnly\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                        <span class=\"token string\">\"buildIndexes\"</span> <span class=\"token builtin class-name\">:</span> true,</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                        <span class=\"token string\">\"hidden\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                        <span class=\"token string\">\"priority\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                        <span class=\"token string\">\"tags\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                        <span class=\"token string\">\"secondaryDelaySecs\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                        <span class=\"token string\">\"votes\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token punctuation\">]</span>,</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token string\">\"protocolVersion\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token string\">\"writeConcernMajorityJournalDefault\"</span> <span class=\"token builtin class-name\">:</span> true,</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token string\">\"settings\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                <span class=\"token string\">\"chainingAllowed\"</span> <span class=\"token builtin class-name\">:</span> true,</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                <span class=\"token string\">\"heartbeatIntervalMillis\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2000</span>,</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                <span class=\"token string\">\"heartbeatTimeoutSecs\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">10</span>,</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                <span class=\"token string\">\"electionTimeoutMillis\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">10000</span>,</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                <span class=\"token string\">\"catchUpTimeoutMillis\"</span> <span class=\"token builtin class-name\">:</span> -1,</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                <span class=\"token string\">\"catchUpTakeoverDelayMillis\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">30000</span>,</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                <span class=\"token string\">\"getLastErrorModes\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                <span class=\"token string\">\"getLastErrorDefaults\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                        <span class=\"token string\">\"w\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                        <span class=\"token string\">\"wtimeout\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                <span class=\"token string\">\"replicaSetId\"</span> <span class=\"token builtin class-name\">:</span> ObjectId<span class=\"token punctuation\">(</span><span class=\"token string\">\"647edd5c454f9ab55a0c8fbf\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>myrs:PRIMARY<span class=\"token operator\">></span></pre></td></tr></table></figure><p>说明：</p>\n<ol>\n<li><code>&quot;_id&quot;:&quot;myrs&quot;</code> ：副本集的配置数据存储的主键值，默认就是副本集的名字</li>\n<li><code>&quot;members&quot;</code> ：副本集成员数组，此时只有一个： <code>&quot;host&quot;:&quot;180.76.159.126:27017&quot;</code> ，该成员不是仲载节点 <code>&quot;arbiterOnly&quot;:false</code> ，优先级 (权重值)： <code>&quot;priority&quot;:1</code></li>\n<li><code>&quot;settings&quot;</code> ：副本集的参数配置。</li>\n</ol>\n<p>提示：副本集配置的查看命令，本质是查询的是 <code>system.replset</code>  的表中的数据</p>\n<h3 id=\"第六步查看副本集状态\"><a class=\"markdownIt-Anchor\" href=\"#第六步查看副本集状态\">#</a> 第六步：查看副本集状态</h3>\n<p>检查副本集状态</p>\n<p>说明：</p>\n<p>返回包含状态信息的文档 ，此输出使用从副本集的其它成员发送的心跳包中获得的数据反映副本集的当前状态。</p>\n<p>语法：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>rs.status<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>[示例]</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>myrs:PRIMARY<span class=\"token operator\">></span> rs.<span class=\"token function-name function\">status</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token string\">\"set\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"myrs\"</span>,</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token string\">\"date\"</span> <span class=\"token builtin class-name\">:</span> ISODate<span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-06T07:27:48.740Z\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token string\">\"myState\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token string\">\"term\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token string\">\"syncSourceHost\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"\"</span>,</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token string\">\"syncSourceId\"</span> <span class=\"token builtin class-name\">:</span> -1,</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token string\">\"heartbeatIntervalMillis\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">2000</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token string\">\"majorityVoteCount\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token string\">\"writeMajorityCount\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token string\">\"votingMembersCount\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token string\">\"writableVotingMembersCount\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token string\">\"optimes\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                <span class=\"token string\">\"lastCommittedOpTime\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                        <span class=\"token string\">\"ts\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686036465</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                        <span class=\"token string\">\"t\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                <span class=\"token string\">\"lastCommittedWallTime\"</span> <span class=\"token builtin class-name\">:</span> ISODate<span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-06T07:27:45.336Z\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                <span class=\"token string\">\"readConcernMajorityOpTime\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                        <span class=\"token string\">\"ts\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686036465</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                        <span class=\"token string\">\"t\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                <span class=\"token string\">\"appliedOpTime\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                        <span class=\"token string\">\"ts\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686036465</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                        <span class=\"token string\">\"t\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                <span class=\"token string\">\"durableOpTime\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                        <span class=\"token string\">\"ts\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686036465</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                        <span class=\"token string\">\"t\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                <span class=\"token string\">\"lastAppliedWallTime\"</span> <span class=\"token builtin class-name\">:</span> ISODate<span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-06T07:27:45.336Z\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                <span class=\"token string\">\"lastDurableWallTime\"</span> <span class=\"token builtin class-name\">:</span> ISODate<span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-06T07:27:45.336Z\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token string\">\"lastStableRecoveryTimestamp\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686036455</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        <span class=\"token string\">\"electionCandidateMetrics\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                <span class=\"token string\">\"lastElectionReason\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"electionTimeout\"</span>,</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>                <span class=\"token string\">\"lastElectionDate\"</span> <span class=\"token builtin class-name\">:</span> ISODate<span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-06T07:16:45.057Z\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>                <span class=\"token string\">\"electionTerm\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                <span class=\"token string\">\"lastCommittedOpTimeAtElection\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>                        <span class=\"token string\">\"ts\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686035805</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>                        <span class=\"token string\">\"t\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span>-1<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>                <span class=\"token string\">\"lastSeenOpTimeAtElection\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                        <span class=\"token string\">\"ts\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686035805</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                        <span class=\"token string\">\"t\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span>-1<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>                <span class=\"token string\">\"numVotesNeeded\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>                <span class=\"token string\">\"priorityAtElection\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>                <span class=\"token string\">\"electionTimeoutMillis\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">10000</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>                <span class=\"token string\">\"newTermStartDate\"</span> <span class=\"token builtin class-name\">:</span> ISODate<span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-06T07:16:45.091Z\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>                <span class=\"token string\">\"wMajorityWriteAvailabilityDate\"</span> <span class=\"token builtin class-name\">:</span> ISODate<span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-06T07:16:45.106Z\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        <span class=\"token string\">\"members\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>                <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>                        <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>,</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>                        <span class=\"token string\">\"name\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"192.168.244.142:27017\"</span>,</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>                        <span class=\"token string\">\"health\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>                        <span class=\"token string\">\"state\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>                        <span class=\"token string\">\"stateStr\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"PRIMARY\"</span>,</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>                        <span class=\"token string\">\"uptime\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1348</span>,</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>                        <span class=\"token string\">\"optime\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>                                <span class=\"token string\">\"ts\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686036465</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>                                <span class=\"token string\">\"t\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>                        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>                        <span class=\"token string\">\"optimeDate\"</span> <span class=\"token builtin class-name\">:</span> ISODate<span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-06T07:27:45Z\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>                        <span class=\"token string\">\"lastAppliedWallTime\"</span> <span class=\"token builtin class-name\">:</span> ISODate<span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-06T07:27:45.336Z\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>                        <span class=\"token string\">\"lastDurableWallTime\"</span> <span class=\"token builtin class-name\">:</span> ISODate<span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-06T07:27:45.336Z\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>                        <span class=\"token string\">\"syncSourceHost\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"\"</span>,</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>                        <span class=\"token string\">\"syncSourceId\"</span> <span class=\"token builtin class-name\">:</span> -1,</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>                        <span class=\"token string\">\"infoMessage\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"\"</span>,</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>                        <span class=\"token string\">\"electionTime\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686035805</span>, <span class=\"token number\">2</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>                        <span class=\"token string\">\"electionDate\"</span> <span class=\"token builtin class-name\">:</span> ISODate<span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-06T07:16:45Z\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>                        <span class=\"token string\">\"configVersion\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>                        <span class=\"token string\">\"configTerm\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>                        <span class=\"token string\">\"self\"</span> <span class=\"token builtin class-name\">:</span> true,</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>                        <span class=\"token string\">\"lastHeartbeatMessage\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>        <span class=\"token punctuation\">]</span>,</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>        <span class=\"token string\">\"ok\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>        <span class=\"token string\">\"<span class=\"token variable\">$clusterTime</span>\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>                <span class=\"token string\">\"clusterTime\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686036465</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>                <span class=\"token string\">\"signature\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>                        <span class=\"token string\">\"hash\"</span> <span class=\"token builtin class-name\">:</span> BinData<span class=\"token punctuation\">(</span><span class=\"token number\">0</span>,<span class=\"token string\">\"AAAAAAAAAAAAAAAAAAAAAAAAAAA=\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>                        <span class=\"token string\">\"keyId\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"88\"></td><td><pre>        <span class=\"token string\">\"operationTime\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686036465</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>myrs:PRIMARY<span class=\"token operator\">></span></pre></td></tr></table></figure><p>说明：</p>\n<ol>\n<li><code>&quot;set&quot;:&quot;myrs&quot;</code> ：副本集的名字</li>\n<li><code>&quot;myState&quot;:1</code> ：说明状态正常</li>\n<li><code>&quot;members&quot;</code> ：副本集成员数组，此时只有一个： <code>&quot;name&quot;:192.168.244.142:27017</code> ，该成员的角色是 <code>&quot;stateStr&quot;:&quot;PRIMARY&quot;</code> ，该节点是健康的： <code>&quot;health&quot;:1</code></li>\n</ol>\n<h3 id=\"第七步添加副本从节点\"><a class=\"markdownIt-Anchor\" href=\"#第七步添加副本从节点\">#</a> 第七步：添加副本从节点</h3>\n<p>在主节点添加从节点，将其它成员加入到副本集</p>\n<p>语法：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>rs.add<span class=\"token punctuation\">(</span>host,arbiterOnly<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>选项：</p>\n<table>\n<thead>\n<tr>\n<th>Paraemter</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>host</td>\n<td>string or document</td>\n<td>要添加到副本集的新成员，指定为字符串或配置文档。1. 如果是一个字符串，则需要指定新成员的主机名和可选的端口号。2. 如果是一个文档，请指定在 members 数组中找到的副本集成员配置文档，您必须在成员配置文档中指定主机字段，有关文档配置字段的说明，详见下方文档：“主机成员的配置文档”</td>\n</tr>\n<tr>\n<td>arbiterOnly</td>\n<td>boolean</td>\n<td>可选的。仅在<host>值为字符串时适用。如果为 true，则添加的主机是仲载者</td>\n</tr>\n</tbody>\n</table>\n<p>主机成员的配置文档：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\t_id: <span class=\"token operator\">&lt;</span>int<span class=\"token operator\">></span>,</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\thost: <span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span>,\t\t//required</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tarbiterOnly: <span class=\"token operator\">&lt;</span>boolean<span class=\"token operator\">></span>,</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tbuildIndexes: <span class=\"token operator\">&lt;</span>boolean<span class=\"token operator\">></span>,</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\thidden: <span class=\"token operator\">&lt;</span>boolean<span class=\"token operator\">></span>,</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tpriority: <span class=\"token operator\">&lt;</span>number<span class=\"token operator\">></span>,</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\ttags: <span class=\"token operator\">&lt;</span>document<span class=\"token operator\">></span>,</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tslaveDelay: <span class=\"token operator\">&lt;</span>int<span class=\"token operator\">></span>,</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tvotes: <span class=\"token operator\">&lt;</span>number<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>[示例]</p>\n<p>将 27018 的副本节点添加到副本集中：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>myrs:PRIMARY<span class=\"token operator\">></span> rs.add<span class=\"token punctuation\">(</span><span class=\"token string\">\"192.168.244.142:27018\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token string\">\"ok\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token string\">\"<span class=\"token variable\">$clusterTime</span>\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                <span class=\"token string\">\"clusterTime\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686037410</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                <span class=\"token string\">\"signature\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                        <span class=\"token string\">\"hash\"</span> <span class=\"token builtin class-name\">:</span> BinData<span class=\"token punctuation\">(</span><span class=\"token number\">0</span>,<span class=\"token string\">\"AAAAAAAAAAAAAAAAAAAAAAAAAAA=\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                        <span class=\"token string\">\"keyId\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token string\">\"operationTime\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686037410</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>myrs:PRIMARY<span class=\"token operator\">></span></pre></td></tr></table></figure><p>说明：</p>\n<ol>\n<li><code>&quot;ok&quot;:1</code> ：说明添加成功。</li>\n</ol>\n<p>查看副本集状态：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>myrs:PRIMARY<span class=\"token operator\">></span> rs.<span class=\"token function-name function\">status</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token string\">\"set\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"myrs\"</span>,</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token string\">\"date\"</span> <span class=\"token builtin class-name\">:</span> ISODate<span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-06T07:47:19.794Z\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token string\">\"myState\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token string\">\"term\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token string\">\"syncSourceHost\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"\"</span>,</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token string\">\"syncSourceId\"</span> <span class=\"token builtin class-name\">:</span> -1,</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token string\">\"heartbeatIntervalMillis\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">2000</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token string\">\"majorityVoteCount\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span>,</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token string\">\"writeMajorityCount\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span>,</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token string\">\"votingMembersCount\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span>,</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token string\">\"writableVotingMembersCount\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span>,</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token string\">\"optimes\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                <span class=\"token string\">\"lastCommittedOpTime\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                        <span class=\"token string\">\"ts\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686037635</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                        <span class=\"token string\">\"t\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                <span class=\"token string\">\"lastCommittedWallTime\"</span> <span class=\"token builtin class-name\">:</span> ISODate<span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-06T07:47:15.489Z\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                <span class=\"token string\">\"readConcernMajorityOpTime\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                        <span class=\"token string\">\"ts\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686037635</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                        <span class=\"token string\">\"t\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                <span class=\"token string\">\"appliedOpTime\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                        <span class=\"token string\">\"ts\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686037635</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                        <span class=\"token string\">\"t\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                <span class=\"token string\">\"durableOpTime\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                        <span class=\"token string\">\"ts\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686037635</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                        <span class=\"token string\">\"t\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                <span class=\"token string\">\"lastAppliedWallTime\"</span> <span class=\"token builtin class-name\">:</span> ISODate<span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-06T07:47:15.489Z\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                <span class=\"token string\">\"lastDurableWallTime\"</span> <span class=\"token builtin class-name\">:</span> ISODate<span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-06T07:47:15.489Z\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token string\">\"lastStableRecoveryTimestamp\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686037605</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        <span class=\"token string\">\"electionCandidateMetrics\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                <span class=\"token string\">\"lastElectionReason\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"electionTimeout\"</span>,</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>                <span class=\"token string\">\"lastElectionDate\"</span> <span class=\"token builtin class-name\">:</span> ISODate<span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-06T07:16:45.057Z\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>                <span class=\"token string\">\"electionTerm\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                <span class=\"token string\">\"lastCommittedOpTimeAtElection\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>                        <span class=\"token string\">\"ts\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686035805</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>                        <span class=\"token string\">\"t\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span>-1<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>                <span class=\"token string\">\"lastSeenOpTimeAtElection\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                        <span class=\"token string\">\"ts\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686035805</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                        <span class=\"token string\">\"t\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span>-1<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>                <span class=\"token string\">\"numVotesNeeded\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>                <span class=\"token string\">\"priorityAtElection\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>                <span class=\"token string\">\"electionTimeoutMillis\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">10000</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>                <span class=\"token string\">\"newTermStartDate\"</span> <span class=\"token builtin class-name\">:</span> ISODate<span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-06T07:16:45.091Z\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>                <span class=\"token string\">\"wMajorityWriteAvailabilityDate\"</span> <span class=\"token builtin class-name\">:</span> ISODate<span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-06T07:16:45.106Z\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        <span class=\"token string\">\"members\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>                <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>                        <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>,</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>                        <span class=\"token string\">\"name\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"192.168.244.142:27017\"</span>,</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>                        <span class=\"token string\">\"health\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>                        <span class=\"token string\">\"state\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>                        <span class=\"token string\">\"stateStr\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"PRIMARY\"</span>,</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>                        <span class=\"token string\">\"uptime\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2519</span>,</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>                        <span class=\"token string\">\"optime\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>                                <span class=\"token string\">\"ts\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686037635</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>                                <span class=\"token string\">\"t\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>                        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>                        <span class=\"token string\">\"optimeDate\"</span> <span class=\"token builtin class-name\">:</span> ISODate<span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-06T07:47:15Z\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>                        <span class=\"token string\">\"lastAppliedWallTime\"</span> <span class=\"token builtin class-name\">:</span> ISODate<span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-06T07:47:15.489Z\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>                        <span class=\"token string\">\"lastDurableWallTime\"</span> <span class=\"token builtin class-name\">:</span> ISODate<span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-06T07:47:15.489Z\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>                        <span class=\"token string\">\"syncSourceHost\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"\"</span>,</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>                        <span class=\"token string\">\"syncSourceId\"</span> <span class=\"token builtin class-name\">:</span> -1,</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>                        <span class=\"token string\">\"infoMessage\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"\"</span>,</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>                        <span class=\"token string\">\"electionTime\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686035805</span>, <span class=\"token number\">2</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>                        <span class=\"token string\">\"electionDate\"</span> <span class=\"token builtin class-name\">:</span> ISODate<span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-06T07:16:45Z\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>                        <span class=\"token string\">\"configVersion\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">3</span>,</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>                        <span class=\"token string\">\"configTerm\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>                        <span class=\"token string\">\"self\"</span> <span class=\"token builtin class-name\">:</span> true,</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>                        <span class=\"token string\">\"lastHeartbeatMessage\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>                <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>                        <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>                        <span class=\"token string\">\"name\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"192.168.244.142:27018\"</span>,</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>                        <span class=\"token string\">\"health\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>                        <span class=\"token string\">\"state\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span>,</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>                        <span class=\"token string\">\"stateStr\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"SECONDARY\"</span>,</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>                        <span class=\"token string\">\"uptime\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">229</span>,</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>                        <span class=\"token string\">\"optime\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>                                <span class=\"token string\">\"ts\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686037635</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"88\"></td><td><pre>                                <span class=\"token string\">\"t\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>                        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>                        <span class=\"token string\">\"optimeDurable\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>                                <span class=\"token string\">\"ts\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686037635</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"92\"></td><td><pre>                                <span class=\"token string\">\"t\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>                        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"94\"></td><td><pre>                        <span class=\"token string\">\"optimeDate\"</span> <span class=\"token builtin class-name\">:</span> ISODate<span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-06T07:47:15Z\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"95\"></td><td><pre>                        <span class=\"token string\">\"optimeDurableDate\"</span> <span class=\"token builtin class-name\">:</span> ISODate<span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-06T07:47:15Z\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"96\"></td><td><pre>                        <span class=\"token string\">\"lastAppliedWallTime\"</span> <span class=\"token builtin class-name\">:</span> ISODate<span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-06T07:47:15.489Z\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>                        <span class=\"token string\">\"lastDurableWallTime\"</span> <span class=\"token builtin class-name\">:</span> ISODate<span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-06T07:47:15.489Z\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"98\"></td><td><pre>                        <span class=\"token string\">\"lastHeartbeat\"</span> <span class=\"token builtin class-name\">:</span> ISODate<span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-06T07:47:18.948Z\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"99\"></td><td><pre>                        <span class=\"token string\">\"lastHeartbeatRecv\"</span> <span class=\"token builtin class-name\">:</span> ISODate<span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-06T07:47:19.436Z\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"100\"></td><td><pre>                        <span class=\"token string\">\"pingMs\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"101\"></td><td><pre>                        <span class=\"token string\">\"lastHeartbeatMessage\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"\"</span>,</pre></td></tr><tr><td data-num=\"102\"></td><td><pre>                        <span class=\"token string\">\"syncSourceHost\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"192.168.244.142:27017\"</span>,</pre></td></tr><tr><td data-num=\"103\"></td><td><pre>                        <span class=\"token string\">\"syncSourceId\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>,</pre></td></tr><tr><td data-num=\"104\"></td><td><pre>                        <span class=\"token string\">\"infoMessage\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"\"</span>,</pre></td></tr><tr><td data-num=\"105\"></td><td><pre>                        <span class=\"token string\">\"configVersion\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">3</span>,</pre></td></tr><tr><td data-num=\"106\"></td><td><pre>                        <span class=\"token string\">\"configTerm\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>        <span class=\"token punctuation\">]</span>,</pre></td></tr><tr><td data-num=\"109\"></td><td><pre>        <span class=\"token string\">\"ok\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"110\"></td><td><pre>        <span class=\"token string\">\"<span class=\"token variable\">$clusterTime</span>\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>                <span class=\"token string\">\"clusterTime\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686037635</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"112\"></td><td><pre>                <span class=\"token string\">\"signature\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>                        <span class=\"token string\">\"hash\"</span> <span class=\"token builtin class-name\">:</span> BinData<span class=\"token punctuation\">(</span><span class=\"token number\">0</span>,<span class=\"token string\">\"AAAAAAAAAAAAAAAAAAAAAAAAAAA=\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"114\"></td><td><pre>                        <span class=\"token string\">\"keyId\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"117\"></td><td><pre>        <span class=\"token string\">\"operationTime\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686037635</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>myrs:PRIMARY<span class=\"token operator\">></span></pre></td></tr></table></figure><h3 id=\"第八步添加仲载从节点\"><a class=\"markdownIt-Anchor\" href=\"#第八步添加仲载从节点\">#</a> 第八步：添加仲载从节点</h3>\n<p>添加一个仲载节点到副本集</p>\n<p>语法：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>rs.addArb<span class=\"token punctuation\">(</span>host<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>将 27019 的仲载节点添加到副本集中：</p>\n<p>如果执行命令后没有反应解决办法如下：在主节点中:mys:PRIMARY 执行命令</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.adminCommand<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"setDefaultRWConcern\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,<span class=\"token string\">\"defaultWriteConcern\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"w\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>myrs:PRIMARY<span class=\"token operator\">></span> rs.addArb<span class=\"token punctuation\">(</span><span class=\"token string\">\"192.168.244.142:27019\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token string\">\"ok\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token string\">\"<span class=\"token variable\">$clusterTime</span>\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                <span class=\"token string\">\"clusterTime\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686038253</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                <span class=\"token string\">\"signature\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                        <span class=\"token string\">\"hash\"</span> <span class=\"token builtin class-name\">:</span> BinData<span class=\"token punctuation\">(</span><span class=\"token number\">0</span>,<span class=\"token string\">\"AAAAAAAAAAAAAAAAAAAAAAAAAAA=\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                        <span class=\"token string\">\"keyId\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token string\">\"operationTime\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686038253</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>myrs:PRIMARY<span class=\"token operator\">></span></pre></td></tr></table></figure><p>说明：</p>\n<ol>\n<li><code>&quot;ok&quot;:1</code> ：说明添加成功</li>\n</ol>\n<p>查看副本集情况：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>myrs:PRIMARY<span class=\"token operator\">></span> rs.<span class=\"token function-name function\">conf</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"myrs\"</span>,</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token string\">\"version\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">4</span>,</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token string\">\"term\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token string\">\"members\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                        <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>,</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                        <span class=\"token string\">\"host\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"192.168.244.142:27017\"</span>,</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                        <span class=\"token string\">\"arbiterOnly\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                        <span class=\"token string\">\"buildIndexes\"</span> <span class=\"token builtin class-name\">:</span> true,</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                        <span class=\"token string\">\"hidden\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                        <span class=\"token string\">\"priority\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                        <span class=\"token string\">\"tags\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                        <span class=\"token string\">\"secondaryDelaySecs\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                        <span class=\"token string\">\"votes\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                        <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                        <span class=\"token string\">\"host\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"192.168.244.142:27018\"</span>,</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                        <span class=\"token string\">\"arbiterOnly\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                        <span class=\"token string\">\"buildIndexes\"</span> <span class=\"token builtin class-name\">:</span> true,</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                        <span class=\"token string\">\"hidden\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                        <span class=\"token string\">\"priority\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                        <span class=\"token string\">\"tags\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                        <span class=\"token string\">\"secondaryDelaySecs\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                        <span class=\"token string\">\"votes\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                        <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span>,</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                        <span class=\"token string\">\"host\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"192.168.244.142:27019\"</span>,</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                        <span class=\"token string\">\"arbiterOnly\"</span> <span class=\"token builtin class-name\">:</span> true,</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                        <span class=\"token string\">\"buildIndexes\"</span> <span class=\"token builtin class-name\">:</span> true,</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>                        <span class=\"token string\">\"hidden\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>                        <span class=\"token string\">\"priority\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>,</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                        <span class=\"token string\">\"tags\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>                        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>                        <span class=\"token string\">\"secondaryDelaySecs\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>                        <span class=\"token string\">\"votes\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        <span class=\"token punctuation\">]</span>,</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        <span class=\"token string\">\"protocolVersion\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        <span class=\"token string\">\"writeConcernMajorityJournalDefault\"</span> <span class=\"token builtin class-name\">:</span> true,</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        <span class=\"token string\">\"settings\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>                <span class=\"token string\">\"chainingAllowed\"</span> <span class=\"token builtin class-name\">:</span> true,</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>                <span class=\"token string\">\"heartbeatIntervalMillis\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2000</span>,</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>                <span class=\"token string\">\"heartbeatTimeoutSecs\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">10</span>,</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>                <span class=\"token string\">\"electionTimeoutMillis\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">10000</span>,</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>                <span class=\"token string\">\"catchUpTimeoutMillis\"</span> <span class=\"token builtin class-name\">:</span> -1,</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>                <span class=\"token string\">\"catchUpTakeoverDelayMillis\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">30000</span>,</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>                <span class=\"token string\">\"getLastErrorModes\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>                <span class=\"token string\">\"getLastErrorDefaults\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>                        <span class=\"token string\">\"w\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>                        <span class=\"token string\">\"wtimeout\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>                <span class=\"token string\">\"replicaSetId\"</span> <span class=\"token builtin class-name\">:</span> ObjectId<span class=\"token punctuation\">(</span><span class=\"token string\">\"647edd5c454f9ab55a0c8fbf\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>myrs:PRIMARY<span class=\"token operator\">></span></pre></td></tr></table></figure><p>“arbiterOnly” : true, 说明是仲载节点</p>\n<p>查看状态：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>myrs:PRIMARY<span class=\"token operator\">></span> rs.<span class=\"token function-name function\">status</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token string\">\"set\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"myrs\"</span>,</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token string\">\"date\"</span> <span class=\"token builtin class-name\">:</span> ISODate<span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-06T08:04:25.601Z\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token string\">\"myState\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token string\">\"term\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token string\">\"syncSourceHost\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"\"</span>,</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token string\">\"syncSourceId\"</span> <span class=\"token builtin class-name\">:</span> -1,</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token string\">\"heartbeatIntervalMillis\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">2000</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token string\">\"majorityVoteCount\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span>,</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token string\">\"writeMajorityCount\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span>,</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token string\">\"votingMembersCount\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">3</span>,</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token string\">\"writableVotingMembersCount\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span>,</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token string\">\"optimes\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                <span class=\"token string\">\"lastCommittedOpTime\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                        <span class=\"token string\">\"ts\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686038655</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                        <span class=\"token string\">\"t\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                <span class=\"token string\">\"lastCommittedWallTime\"</span> <span class=\"token builtin class-name\">:</span> ISODate<span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-06T08:04:15.625Z\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                <span class=\"token string\">\"readConcernMajorityOpTime\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                        <span class=\"token string\">\"ts\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686038655</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                        <span class=\"token string\">\"t\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                <span class=\"token string\">\"appliedOpTime\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                        <span class=\"token string\">\"ts\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686038655</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                        <span class=\"token string\">\"t\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                <span class=\"token string\">\"durableOpTime\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                        <span class=\"token string\">\"ts\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686038655</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                        <span class=\"token string\">\"t\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                <span class=\"token string\">\"lastAppliedWallTime\"</span> <span class=\"token builtin class-name\">:</span> ISODate<span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-06T08:04:15.625Z\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                <span class=\"token string\">\"lastDurableWallTime\"</span> <span class=\"token builtin class-name\">:</span> ISODate<span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-06T08:04:15.625Z\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token string\">\"lastStableRecoveryTimestamp\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686038625</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        <span class=\"token string\">\"electionCandidateMetrics\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                <span class=\"token string\">\"lastElectionReason\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"electionTimeout\"</span>,</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>                <span class=\"token string\">\"lastElectionDate\"</span> <span class=\"token builtin class-name\">:</span> ISODate<span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-06T07:16:45.057Z\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>                <span class=\"token string\">\"electionTerm\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                <span class=\"token string\">\"lastCommittedOpTimeAtElection\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>                        <span class=\"token string\">\"ts\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686035805</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>                        <span class=\"token string\">\"t\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span>-1<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>                <span class=\"token string\">\"lastSeenOpTimeAtElection\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                        <span class=\"token string\">\"ts\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686035805</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                        <span class=\"token string\">\"t\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span>-1<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>                <span class=\"token string\">\"numVotesNeeded\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>                <span class=\"token string\">\"priorityAtElection\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>                <span class=\"token string\">\"electionTimeoutMillis\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">10000</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>                <span class=\"token string\">\"newTermStartDate\"</span> <span class=\"token builtin class-name\">:</span> ISODate<span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-06T07:16:45.091Z\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>                <span class=\"token string\">\"wMajorityWriteAvailabilityDate\"</span> <span class=\"token builtin class-name\">:</span> ISODate<span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-06T07:16:45.106Z\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        <span class=\"token string\">\"members\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>                <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>                        <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>,</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>                        <span class=\"token string\">\"name\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"192.168.244.142:27017\"</span>,</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>                        <span class=\"token string\">\"health\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>                        <span class=\"token string\">\"state\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>                        <span class=\"token string\">\"stateStr\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"PRIMARY\"</span>,</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>                        <span class=\"token string\">\"uptime\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">3545</span>,</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>                        <span class=\"token string\">\"optime\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>                                <span class=\"token string\">\"ts\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686038655</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>                                <span class=\"token string\">\"t\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>                        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>                        <span class=\"token string\">\"optimeDate\"</span> <span class=\"token builtin class-name\">:</span> ISODate<span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-06T08:04:15Z\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>                        <span class=\"token string\">\"lastAppliedWallTime\"</span> <span class=\"token builtin class-name\">:</span> ISODate<span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-06T08:04:15.625Z\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>                        <span class=\"token string\">\"lastDurableWallTime\"</span> <span class=\"token builtin class-name\">:</span> ISODate<span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-06T08:04:15.625Z\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>                        <span class=\"token string\">\"syncSourceHost\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"\"</span>,</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>                        <span class=\"token string\">\"syncSourceId\"</span> <span class=\"token builtin class-name\">:</span> -1,</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>                        <span class=\"token string\">\"infoMessage\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"\"</span>,</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>                        <span class=\"token string\">\"electionTime\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686035805</span>, <span class=\"token number\">2</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>                        <span class=\"token string\">\"electionDate\"</span> <span class=\"token builtin class-name\">:</span> ISODate<span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-06T07:16:45Z\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>                        <span class=\"token string\">\"configVersion\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">4</span>,</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>                        <span class=\"token string\">\"configTerm\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>                        <span class=\"token string\">\"self\"</span> <span class=\"token builtin class-name\">:</span> true,</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>                        <span class=\"token string\">\"lastHeartbeatMessage\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>                <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>                        <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>                        <span class=\"token string\">\"name\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"192.168.244.142:27018\"</span>,</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>                        <span class=\"token string\">\"health\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>                        <span class=\"token string\">\"state\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span>,</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>                        <span class=\"token string\">\"stateStr\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"SECONDARY\"</span>,</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>                        <span class=\"token string\">\"uptime\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1254</span>,</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>                        <span class=\"token string\">\"optime\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>                                <span class=\"token string\">\"ts\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686038655</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"88\"></td><td><pre>                                <span class=\"token string\">\"t\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>                        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>                        <span class=\"token string\">\"optimeDurable\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>                                <span class=\"token string\">\"ts\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686038655</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"92\"></td><td><pre>                                <span class=\"token string\">\"t\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>                        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"94\"></td><td><pre>                        <span class=\"token string\">\"optimeDate\"</span> <span class=\"token builtin class-name\">:</span> ISODate<span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-06T08:04:15Z\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"95\"></td><td><pre>                        <span class=\"token string\">\"optimeDurableDate\"</span> <span class=\"token builtin class-name\">:</span> ISODate<span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-06T08:04:15Z\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"96\"></td><td><pre>                        <span class=\"token string\">\"lastAppliedWallTime\"</span> <span class=\"token builtin class-name\">:</span> ISODate<span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-06T08:04:15.625Z\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>                        <span class=\"token string\">\"lastDurableWallTime\"</span> <span class=\"token builtin class-name\">:</span> ISODate<span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-06T08:04:15.625Z\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"98\"></td><td><pre>                        <span class=\"token string\">\"lastHeartbeat\"</span> <span class=\"token builtin class-name\">:</span> ISODate<span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-06T08:04:24.037Z\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"99\"></td><td><pre>                        <span class=\"token string\">\"lastHeartbeatRecv\"</span> <span class=\"token builtin class-name\">:</span> ISODate<span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-06T08:04:24.064Z\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"100\"></td><td><pre>                        <span class=\"token string\">\"pingMs\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"101\"></td><td><pre>                        <span class=\"token string\">\"lastHeartbeatMessage\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"\"</span>,</pre></td></tr><tr><td data-num=\"102\"></td><td><pre>                        <span class=\"token string\">\"syncSourceHost\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"192.168.244.142:27017\"</span>,</pre></td></tr><tr><td data-num=\"103\"></td><td><pre>                        <span class=\"token string\">\"syncSourceId\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>,</pre></td></tr><tr><td data-num=\"104\"></td><td><pre>                        <span class=\"token string\">\"infoMessage\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"\"</span>,</pre></td></tr><tr><td data-num=\"105\"></td><td><pre>                        <span class=\"token string\">\"configVersion\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">4</span>,</pre></td></tr><tr><td data-num=\"106\"></td><td><pre>                        <span class=\"token string\">\"configTerm\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"108\"></td><td><pre>                <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>                        <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span>,</pre></td></tr><tr><td data-num=\"110\"></td><td><pre>                        <span class=\"token string\">\"name\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"192.168.244.142:27019\"</span>,</pre></td></tr><tr><td data-num=\"111\"></td><td><pre>                        <span class=\"token string\">\"health\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"112\"></td><td><pre>                        <span class=\"token string\">\"state\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">7</span>,</pre></td></tr><tr><td data-num=\"113\"></td><td><pre>                        <span class=\"token string\">\"stateStr\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"ARBITER\"</span>,</pre></td></tr><tr><td data-num=\"114\"></td><td><pre>                        <span class=\"token string\">\"uptime\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">412</span>,</pre></td></tr><tr><td data-num=\"115\"></td><td><pre>                        <span class=\"token string\">\"lastHeartbeat\"</span> <span class=\"token builtin class-name\">:</span> ISODate<span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-06T08:04:24.012Z\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"116\"></td><td><pre>                        <span class=\"token string\">\"lastHeartbeatRecv\"</span> <span class=\"token builtin class-name\">:</span> ISODate<span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-06T08:04:24.055Z\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"117\"></td><td><pre>                        <span class=\"token string\">\"pingMs\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"118\"></td><td><pre>                        <span class=\"token string\">\"lastHeartbeatMessage\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"\"</span>,</pre></td></tr><tr><td data-num=\"119\"></td><td><pre>                        <span class=\"token string\">\"syncSourceHost\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"\"</span>,</pre></td></tr><tr><td data-num=\"120\"></td><td><pre>                        <span class=\"token string\">\"syncSourceId\"</span> <span class=\"token builtin class-name\">:</span> -1,</pre></td></tr><tr><td data-num=\"121\"></td><td><pre>                        <span class=\"token string\">\"infoMessage\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"\"</span>,</pre></td></tr><tr><td data-num=\"122\"></td><td><pre>                        <span class=\"token string\">\"configVersion\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">4</span>,</pre></td></tr><tr><td data-num=\"123\"></td><td><pre>                        <span class=\"token string\">\"configTerm\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>        <span class=\"token punctuation\">]</span>,</pre></td></tr><tr><td data-num=\"126\"></td><td><pre>        <span class=\"token string\">\"ok\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"127\"></td><td><pre>        <span class=\"token string\">\"<span class=\"token variable\">$clusterTime</span>\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>                <span class=\"token string\">\"clusterTime\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686038655</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"129\"></td><td><pre>                <span class=\"token string\">\"signature\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>                        <span class=\"token string\">\"hash\"</span> <span class=\"token builtin class-name\">:</span> BinData<span class=\"token punctuation\">(</span><span class=\"token number\">0</span>,<span class=\"token string\">\"AAAAAAAAAAAAAAAAAAAAAAAAAAA=\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"131\"></td><td><pre>                        <span class=\"token string\">\"keyId\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"134\"></td><td><pre>        <span class=\"token string\">\"operationTime\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686038655</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>myrs:PRIMARY<span class=\"token operator\">></span></pre></td></tr></table></figure><p>PRIMARY：主节点，SECONDARY：从节点，ARBITER：仲载节点</p>\n<h2 id=\"副本集的数据读写操作\"><a class=\"markdownIt-Anchor\" href=\"#副本集的数据读写操作\">#</a> 副本集的数据读写操作</h2>\n<p>目标：测试三个不同角色的节点的数据读写情况</p>\n<p>登录主节点 27017，写入和读取数据：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>myrs:PRIMARY<span class=\"token operator\">></span> show dbs</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>admin   <span class=\"token number\">0</span>.000GB</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>config  <span class=\"token number\">0</span>.000GB</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token builtin class-name\">local</span>   <span class=\"token number\">0</span>.000GB</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>myrs:PRIMARY<span class=\"token operator\">></span> use articledb</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>switched to db articledb</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>myrs:PRIMARY<span class=\"token operator\">></span> db</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>articledb</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>myrs:PRIMARY<span class=\"token operator\">></span> try<span class=\"token punctuation\">&#123;</span>db.comment.insert<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"name\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"张三\"</span>,<span class=\"token string\">\"age\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"18\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span>catch<span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>print<span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>WriteResult<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"nInserted\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>myrs:PRIMARY<span class=\"token operator\">></span> db.comment.<span class=\"token function-name function\">find</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> ObjectId<span class=\"token punctuation\">(</span><span class=\"token string\">\"647ee966333697b12ce7258a\"</span><span class=\"token punctuation\">)</span>, <span class=\"token string\">\"name\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"张三\"</span>, <span class=\"token string\">\"age\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"18\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>myrs:PRIMARY<span class=\"token operator\">></span></pre></td></tr></table></figure><p>登录从节点 27018</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>myrs:SECONDARY<span class=\"token operator\">></span> show dbs</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>uncaught exception: Error: listDatabases failed:<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token string\">\"topologyVersion\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                <span class=\"token string\">\"processId\"</span> <span class=\"token builtin class-name\">:</span> ObjectId<span class=\"token punctuation\">(</span><span class=\"token string\">\"647edabd93b3e543a0258e7d\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                <span class=\"token string\">\"counter\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token string\">\"ok\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>,</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token string\">\"errmsg\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"not master and slaveOk=false\"</span>,</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token string\">\"code\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">13435</span>,</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token string\">\"codeName\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"NotPrimaryNoSecondaryOk\"</span>,</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token string\">\"<span class=\"token variable\">$clusterTime</span>\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                <span class=\"token string\">\"clusterTime\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686039005</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                <span class=\"token string\">\"signature\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                        <span class=\"token string\">\"hash\"</span> <span class=\"token builtin class-name\">:</span> BinData<span class=\"token punctuation\">(</span><span class=\"token number\">0</span>,<span class=\"token string\">\"AAAAAAAAAAAAAAAAAAAAAAAAAAA=\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                        <span class=\"token string\">\"keyId\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token string\">\"operationTime\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686039005</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#125;</span> <span class=\"token builtin class-name\">:</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>_getErrorWithCode@src/mongo/shell/utils.js:25:13</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>Mongo.prototype.getDBs/<span class=\"token operator\">&lt;</span>@src/mongo/shell/mongo.js:145:19</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>Mongo.prototype.getDBs@src/mongo/shell/mongo.js:97:12</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>shellHelper.show@src/mongo/shell/utils.js:956:13</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>shellHelper@src/mongo/shell/utils.js:838:15</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>@<span class=\"token punctuation\">(</span>shellhelp2<span class=\"token punctuation\">)</span>:1:1</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>myrs:SECONDARY<span class=\"token operator\">></span></pre></td></tr></table></figure><p>发现，不能读取集合的数据。当前从节点只是一个备份，不是奴隶节点，无法读取数据，写当然更不行，因为默认情况下，从节点是没有读写权限的，可以增加读的权限，但需要进行设置。</p>\n<p>设置读操作权限：</p>\n<p>说明：</p>\n<p>设置为奴隶节点，允许在从成员上运行读的操作</p>\n<p>语法：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> rs.slaveOk<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#或</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">></span> rs.slaveOk<span class=\"token punctuation\">(</span>true<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#新版本中上面命令可能被弃用了，使用下面命令即可</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>rs.secondaryOk<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>提示：</p>\n<p>该命令是 db.getMongo ().setSlaveOk () 的简化命令。</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>myrs:SECONDARY<span class=\"token operator\">></span> rs.secondaryOk<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>myrs:SECONDARY<span class=\"token operator\">></span> show dbs</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>admin      <span class=\"token number\">0</span>.000GB</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>articledb  <span class=\"token number\">0</span>.000GB</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>config     <span class=\"token number\">0</span>.000GB</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token builtin class-name\">local</span>      <span class=\"token number\">0</span>.000GB</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>myrs:SECONDARY<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>myrs:SECONDARY<span class=\"token operator\">></span> use articledb</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>switched to db articledb</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>myrs:SECONDARY<span class=\"token operator\">></span> db.comment.<span class=\"token function-name function\">find</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> ObjectId<span class=\"token punctuation\">(</span><span class=\"token string\">\"647ee966333697b12ce7258a\"</span><span class=\"token punctuation\">)</span>, <span class=\"token string\">\"name\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"张三\"</span>, <span class=\"token string\">\"age\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"18\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>myrs:SECONDARY<span class=\"token operator\">></span></pre></td></tr></table></figure><p>可以看到可以将主节点插入的数据同步过来</p>\n<p>但仍然不允许插入  <code> &quot;errmsg&quot; : &quot;not master&quot;</code></p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>myrs:SECONDARY<span class=\"token operator\">></span> try<span class=\"token punctuation\">&#123;</span>db.comment.insert<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"name\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"李四\"</span>,<span class=\"token string\">\"age\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"20\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span>catch<span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>print<span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>WriteCommandError<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token string\">\"topologyVersion\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                <span class=\"token string\">\"processId\"</span> <span class=\"token builtin class-name\">:</span> ObjectId<span class=\"token punctuation\">(</span><span class=\"token string\">\"647edabd93b3e543a0258e7d\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                <span class=\"token string\">\"counter\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token string\">\"ok\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>,</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token string\">\"errmsg\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"not master\"</span>,</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token string\">\"code\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">10107</span>,</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token string\">\"codeName\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"NotWritablePrimary\"</span>,</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token string\">\"<span class=\"token variable\">$clusterTime</span>\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                <span class=\"token string\">\"clusterTime\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686039875</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                <span class=\"token string\">\"signature\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                        <span class=\"token string\">\"hash\"</span> <span class=\"token builtin class-name\">:</span> BinData<span class=\"token punctuation\">(</span><span class=\"token number\">0</span>,<span class=\"token string\">\"AAAAAAAAAAAAAAAAAAAAAAAAAAA=\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                        <span class=\"token string\">\"keyId\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token string\">\"operationTime\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686039875</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>myrs:SECONDARY<span class=\"token operator\">></span></pre></td></tr></table></figure><p>现在可实现了读写分离，让主插入数据，让从来读取数据</p>\n<p>如果要取消奴隶节点的读取权限：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> rs.secondaryOk<span class=\"token punctuation\">(</span>false<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>myrs:SECONDARY<span class=\"token operator\">></span> rs.secondaryOk<span class=\"token punctuation\">(</span>false<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>myrs:SECONDARY<span class=\"token operator\">></span> show dbs</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>uncaught exception: Error: listDatabases failed:<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token string\">\"topologyVersion\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                <span class=\"token string\">\"processId\"</span> <span class=\"token builtin class-name\">:</span> ObjectId<span class=\"token punctuation\">(</span><span class=\"token string\">\"647edabd93b3e543a0258e7d\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                <span class=\"token string\">\"counter\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token string\">\"ok\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>,</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token string\">\"errmsg\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"not master and slaveOk=false\"</span>,</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token string\">\"code\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">13435</span>,</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token string\">\"codeName\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"NotPrimaryNoSecondaryOk\"</span>,</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token string\">\"<span class=\"token variable\">$clusterTime</span>\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                <span class=\"token string\">\"clusterTime\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686039975</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                <span class=\"token string\">\"signature\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                        <span class=\"token string\">\"hash\"</span> <span class=\"token builtin class-name\">:</span> BinData<span class=\"token punctuation\">(</span><span class=\"token number\">0</span>,<span class=\"token string\">\"AAAAAAAAAAAAAAAAAAAAAAAAAAA=\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                        <span class=\"token string\">\"keyId\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token string\">\"operationTime\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686039975</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span> <span class=\"token builtin class-name\">:</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>_getErrorWithCode@src/mongo/shell/utils.js:25:13</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>Mongo.prototype.getDBs/<span class=\"token operator\">&lt;</span>@src/mongo/shell/mongo.js:145:19</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>Mongo.prototype.getDBs@src/mongo/shell/mongo.js:97:12</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>shellHelper.show@src/mongo/shell/utils.js:956:13</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>shellHelper@src/mongo/shell/utils.js:838:15</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>@<span class=\"token punctuation\">(</span>shellhelp2<span class=\"token punctuation\">)</span>:1:1</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>myrs:SECONDARY<span class=\"token operator\">></span></pre></td></tr></table></figure><p>仲载者节点，不存放任何业务数据的 (存放的是一些配置信息)，可以登录查看，就算设置了 <code>rs.secondaryOk()</code>  同样还是看不到数据</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>myrs:ARBITER<span class=\"token operator\">></span> show dbs</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>uncaught exception: Error: listDatabases failed:<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token string\">\"topologyVersion\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                <span class=\"token string\">\"processId\"</span> <span class=\"token builtin class-name\">:</span> ObjectId<span class=\"token punctuation\">(</span><span class=\"token string\">\"647edaca021ba0c72e879407\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                <span class=\"token string\">\"counter\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token string\">\"ok\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>,</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token string\">\"errmsg\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"not master and slaveOk=false\"</span>,</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token string\">\"code\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">13435</span>,</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token string\">\"codeName\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"NotPrimaryNoSecondaryOk\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span> <span class=\"token builtin class-name\">:</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>_getErrorWithCode@src/mongo/shell/utils.js:25:13</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>Mongo.prototype.getDBs/<span class=\"token operator\">&lt;</span>@src/mongo/shell/mongo.js:145:19</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>Mongo.prototype.getDBs@src/mongo/shell/mongo.js:97:12</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>shellHelper.show@src/mongo/shell/utils.js:956:13</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>shellHelper@src/mongo/shell/utils.js:838:15</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>@<span class=\"token punctuation\">(</span>shellhelp2<span class=\"token punctuation\">)</span>:1:1</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>myrs:ARBITER<span class=\"token operator\">></span></pre></td></tr></table></figure><p>我们想要查看的话就会提示不是 slaveOk 不能读取，但是我们设置仲载可读呢</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>myrs:ARBITER<span class=\"token operator\">></span> rs.secondaryOk<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>myrs:ARBITER<span class=\"token operator\">></span> show dbs</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>uncaught exception: Error: listDatabases failed:<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token string\">\"topologyVersion\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                <span class=\"token string\">\"processId\"</span> <span class=\"token builtin class-name\">:</span> ObjectId<span class=\"token punctuation\">(</span><span class=\"token string\">\"647edaca021ba0c72e879407\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                <span class=\"token string\">\"counter\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token string\">\"ok\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>,</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token string\">\"errmsg\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"node is not in primary or recovering state\"</span>,</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token string\">\"code\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">13436</span>,</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token string\">\"codeName\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"NotPrimaryOrSecondary\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span> <span class=\"token builtin class-name\">:</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>_getErrorWithCode@src/mongo/shell/utils.js:25:13</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>Mongo.prototype.getDBs/<span class=\"token operator\">&lt;</span>@src/mongo/shell/mongo.js:145:19</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>Mongo.prototype.getDBs@src/mongo/shell/mongo.js:97:12</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>shellHelper.show@src/mongo/shell/utils.js:956:13</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>shellHelper@src/mongo/shell/utils.js:838:15</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>@<span class=\"token punctuation\">(</span>shellhelp2<span class=\"token punctuation\">)</span>:1:1</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>myrs:ARBITER<span class=\"token operator\">></span></pre></td></tr></table></figure><p>报错提示翻译：节点未处于主状态或正在恢复状态</p>\n<h2 id=\"主节点的选举原则\"><a class=\"markdownIt-Anchor\" href=\"#主节点的选举原则\">#</a> 主节点的选举原则</h2>\n<p>MongoDB 在副本集中，会自动进行主节点的选举，主节点选举的触发条件：</p>\n<ol>\n<li>节点故障</li>\n<li>主节点网络不可达 (默认心跳信息为 10 秒)</li>\n<li>人工干预 (rs.stepDown (600))</li>\n</ol>\n<p>一旦触发选举，就要根据一定规则来选主节点</p>\n<p>选举规则是根据票数来决定谁获胜：</p>\n<ul>\n<li>\n<p>票数最高，且获得了 &quot;大多数&quot; 成员的投票支持的节点获胜</p>\n<p>&quot;大多数&quot; 的定义为：假设复制集内投票成员数量为 N，则大多数为 N/2 + 1，例如：3 个投票成员，则大多数的值是 2，当复制集内存活成员数量不足大多数时，整个复制集将无法选举出 Primary，复制集将无法提供写服务，处于只读状态</p>\n</li>\n<li>\n<p>若投票数相同，且都获得了 &quot;大多数&quot; 成员的投票支持的，数据新的节点获胜。</p>\n<p>数据的新旧是通过操作日志 oplog 来对比的</p>\n</li>\n</ul>\n<p>在获得票数的时候，优先级 (priority) 参数影响重大。</p>\n<p>可以通过设置优先级 (priority) 来设置额外票数，优先级即权重，取值为 0~1000，相当于可额外增加 0 <code>~</code> 1000 的票数，优先级的值越大，就越可能获得多数成员的投票 (votes) 数。指定较高的值可使成员更有资格成员主要成员，更低的值可使成员更不符合条件</p>\n<p>默认情况下，优先级的值是 1</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>myrs:SECONDARY<span class=\"token operator\">></span> rs.<span class=\"token function-name function\">conf</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"myrs\"</span>,</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token string\">\"version\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">4</span>,</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token string\">\"term\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token string\">\"members\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                        <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>,</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                        <span class=\"token string\">\"host\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"192.168.244.142:27017\"</span>,</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                        <span class=\"token string\">\"arbiterOnly\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                        <span class=\"token string\">\"buildIndexes\"</span> <span class=\"token builtin class-name\">:</span> true,</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                        <span class=\"token string\">\"hidden\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                        <span class=\"token string\">\"priority\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                        <span class=\"token string\">\"tags\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                        <span class=\"token string\">\"secondaryDelaySecs\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                        <span class=\"token string\">\"votes\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                        <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                        <span class=\"token string\">\"host\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"192.168.244.142:27018\"</span>,</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                        <span class=\"token string\">\"arbiterOnly\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                        <span class=\"token string\">\"buildIndexes\"</span> <span class=\"token builtin class-name\">:</span> true,</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                        <span class=\"token string\">\"hidden\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                        <span class=\"token string\">\"priority\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                        <span class=\"token string\">\"tags\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                        <span class=\"token string\">\"secondaryDelaySecs\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                        <span class=\"token string\">\"votes\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                        <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span>,</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                        <span class=\"token string\">\"host\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"192.168.244.142:27019\"</span>,</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                        <span class=\"token string\">\"arbiterOnly\"</span> <span class=\"token builtin class-name\">:</span> true,</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                        <span class=\"token string\">\"buildIndexes\"</span> <span class=\"token builtin class-name\">:</span> true,</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>                        <span class=\"token string\">\"hidden\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>                        <span class=\"token string\">\"priority\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>,</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                        <span class=\"token string\">\"tags\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>                        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>                        <span class=\"token string\">\"secondaryDelaySecs\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>                        <span class=\"token string\">\"votes\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        <span class=\"token punctuation\">]</span>,</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        <span class=\"token string\">\"protocolVersion\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        <span class=\"token string\">\"writeConcernMajorityJournalDefault\"</span> <span class=\"token builtin class-name\">:</span> true,</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        <span class=\"token string\">\"settings\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>                <span class=\"token string\">\"chainingAllowed\"</span> <span class=\"token builtin class-name\">:</span> true,</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>                <span class=\"token string\">\"heartbeatIntervalMillis\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2000</span>,</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>                <span class=\"token string\">\"heartbeatTimeoutSecs\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">10</span>,</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>                <span class=\"token string\">\"electionTimeoutMillis\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">10000</span>,</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>                <span class=\"token string\">\"catchUpTimeoutMillis\"</span> <span class=\"token builtin class-name\">:</span> -1,</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>                <span class=\"token string\">\"catchUpTakeoverDelayMillis\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">30000</span>,</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>                <span class=\"token string\">\"getLastErrorModes\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>                <span class=\"token string\">\"getLastErrorDefaults\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>                        <span class=\"token string\">\"w\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>                        <span class=\"token string\">\"wtimeout\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>                <span class=\"token string\">\"replicaSetId\"</span> <span class=\"token builtin class-name\">:</span> ObjectId<span class=\"token punctuation\">(</span><span class=\"token string\">\"647edd5c454f9ab55a0c8fbf\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>myrs:SECONDARY<span class=\"token operator\">></span></pre></td></tr></table></figure><p>除了仲载节点其它 priority (优先级) 都是 1，仲载不能读写数据它只是一个参与投票的人，仲载不可能为王</p>\n<p>(要注意是，官方说了，仲载节点的优先级必须是 0，不能是别的值，即不具备选举权，但具有投票权)</p>\n<h3 id=\"修改优先级\"><a class=\"markdownIt-Anchor\" href=\"#修改优先级\">#</a> 修改优先级</h3>\n<p>比如，下面提升从节点的优先级：</p>\n<ol>\n<li>\n<p>先将配置导入 cfg 变量</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>myrs:SECONDARY<span class=\"token operator\">></span> <span class=\"token assign-left variable\">cfg</span><span class=\"token operator\">=</span>rs.conf<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure></li>\n<li>\n<p>然后修改值 (ID 号默认从 0 开始)</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>myrs:SECONDARY<span class=\"token operator\">></span> cfg.members<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>.priority<span class=\"token operator\">=</span><span class=\"token number\">2</span></pre></td></tr></table></figure><p>稍等片刻会重新开始选举</p>\n</li>\n</ol>\n<h2 id=\"故障测试\"><a class=\"markdownIt-Anchor\" href=\"#故障测试\">#</a> 故障测试</h2>\n<h3 id=\"副本节点故障测试\"><a class=\"markdownIt-Anchor\" href=\"#副本节点故障测试\">#</a> 副本节点故障测试</h3>\n<p>关闭 27018 副本节点：</p>\n<p>发现，主节点和仲载节点对 27018 的心跳失败。因为主节点还在，因此，没有触发投票选举。</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>dkx0@192<span class=\"token punctuation\">]</span>~% <span class=\"token function\">ps</span> -ef<span class=\"token operator\">|</span><span class=\"token function\">grep</span> mongod<span class=\"token operator\">|</span><span class=\"token function\">grep</span> <span class=\"token parameter variable\">-v</span> <span class=\"token function\">grep</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>dkx0       <span class=\"token number\">5300</span>      <span class=\"token number\">1</span>  <span class=\"token number\">1</span> 03:05 ?        00:07:30 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/replica_sets/myrs_27017/log/mongod.conf</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>dkx0       <span class=\"token number\">5367</span>      <span class=\"token number\">1</span>  <span class=\"token number\">1</span> 03:05 ?        00:07:57 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/replica_sets/myrs_27018/log/mongod.conf</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>dkx0       <span class=\"token number\">5434</span>      <span class=\"token number\">1</span>  <span class=\"token number\">1</span> 03:05 ?        00:06:20 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/replica_sets/myrs_27019/log/mongod.conf</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>dkx0@192<span class=\"token punctuation\">]</span>~% <span class=\"token function\">kill</span> <span class=\"token parameter variable\">-2</span> <span class=\"token number\">5367</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>dkx0@192<span class=\"token punctuation\">]</span>~% <span class=\"token function\">ps</span> -ef<span class=\"token operator\">|</span><span class=\"token function\">grep</span> mongod<span class=\"token operator\">|</span><span class=\"token function\">grep</span> <span class=\"token parameter variable\">-v</span> <span class=\"token function\">grep</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>dkx0       <span class=\"token number\">5300</span>      <span class=\"token number\">1</span>  <span class=\"token number\">1</span> 03:05 ?        00:07:31 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/replica_sets/myrs_27017/log/mongod.conf</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>dkx0       <span class=\"token number\">5367</span>      <span class=\"token number\">1</span>  <span class=\"token number\">1</span> 03:05 ?        00:07:58 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/replica_sets/myrs_27018/log/mongod.conf</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>dkx0       <span class=\"token number\">5434</span>      <span class=\"token number\">1</span>  <span class=\"token number\">1</span> 03:05 ?        00:06:20 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/replica_sets/myrs_27019/log/mongod.conf</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>dkx0@192<span class=\"token punctuation\">]</span>~% <span class=\"token function\">ps</span> -ef<span class=\"token operator\">|</span><span class=\"token function\">grep</span> mongod<span class=\"token operator\">|</span><span class=\"token function\">grep</span> <span class=\"token parameter variable\">-v</span> <span class=\"token function\">grep</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>dkx0       <span class=\"token number\">5300</span>      <span class=\"token number\">1</span>  <span class=\"token number\">1</span> 03:05 ?        00:07:31 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/replica_sets/myrs_27017/log/mongod.conf</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>dkx0       <span class=\"token number\">5434</span>      <span class=\"token number\">1</span>  <span class=\"token number\">1</span> 03:05 ?        00:06:21 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/replica_sets/myrs_27019/log/mongod.conf</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">[</span>dkx0@192<span class=\"token punctuation\">]</span>~%</pre></td></tr></table></figure><p>kill -2 没有及时杀掉，证明了 - 2 是等待任务完成自动杀掉而不是暴力杀掉的。</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>myrs:SECONDARY<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr></table></figure><p>从节点被杀掉后按几下回车看下反应，已经没反应了。</p>\n<p>如果此时，在主节点写入数据。</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>myrs:PRIMARY<span class=\"token operator\">></span> db.comment.insert<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"_id\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"3\"</span>,<span class=\"token string\">\"name\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"马保国\"</span>,<span class=\"token string\">\"age\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"22\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>再启动从节点并赋予可读权限，会发现，主节点写入的数据，会自动同步给从节点。</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>myrs:SECONDARY<span class=\"token operator\">></span> rs.secondaryOk<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>myrs:SECONDARY<span class=\"token operator\">></span> use articledb</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>switched to db articledb</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>myrs:SECONDARY<span class=\"token operator\">></span> db.comment.<span class=\"token function-name function\">find</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> ObjectId<span class=\"token punctuation\">(</span><span class=\"token string\">\"647ee966333697b12ce7258a\"</span><span class=\"token punctuation\">)</span>, <span class=\"token string\">\"name\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"张三\"</span>, <span class=\"token string\">\"age\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"18\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"3\"</span>, <span class=\"token string\">\"name\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"马保国\"</span>, <span class=\"token string\">\"age\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"22\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> ObjectId<span class=\"token punctuation\">(</span><span class=\"token string\">\"647f48485710428bcfbf9dbf\"</span><span class=\"token punctuation\">)</span>, <span class=\"token string\">\"name\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"李四\"</span>, <span class=\"token string\">\"age\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"23\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2\"</span>, <span class=\"token string\">\"name\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"123\"</span>, <span class=\"token string\">\"age\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"23\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>myrs:SECONDARY<span class=\"token operator\">></span></pre></td></tr></table></figure><p>可以看到数据同步过来了 &quot;马保国&quot;</p>\n<h3 id=\"主节点故障测试\"><a class=\"markdownIt-Anchor\" href=\"#主节点故障测试\">#</a> 主节点故障测试</h3>\n<p>关闭 27017 节点</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>dkx0@192<span class=\"token punctuation\">]</span>~% <span class=\"token function\">kill</span> <span class=\"token parameter variable\">-2</span> <span class=\"token number\">5300</span>                   </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>dkx0@192<span class=\"token punctuation\">]</span>~% <span class=\"token function\">ps</span> -ef<span class=\"token operator\">|</span><span class=\"token function\">grep</span> mongod<span class=\"token operator\">|</span><span class=\"token function\">grep</span> <span class=\"token parameter variable\">-v</span> <span class=\"token function\">grep</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>dkx0       <span class=\"token number\">5434</span>      <span class=\"token number\">1</span>  <span class=\"token number\">1</span> 03:05 ?        00:06:34 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/replica_sets/myrs_27019/log/mongod.conf</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>dkx0      <span class=\"token number\">29707</span>      <span class=\"token number\">1</span>  <span class=\"token number\">3</span> <span class=\"token number\">11</span>:01 ?        00:00:06 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/replica_sets/myrs_27018/log/mongod.conf</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>dkx0@192<span class=\"token punctuation\">]</span>~%</pre></td></tr></table></figure><p>发现，从节点和仲载节点对 27017 的心跳失败，当失败超过 10 秒，此时因为没有了主节点，会自动发起投票。</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>myrs:PRIMARY<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr></table></figure><p>27017 节点已挂</p>\n<p>而副本节点只有 27018，因此，候选人只有一个就是 27018，开始投票。</p>\n<p>27019 向 27018 投了一票，27018 本身自带一票，因此共两票，超过了 &quot;大多数&quot;</p>\n<p>27019 是仲载节点，没有选举权，27018 不向其投票，其票数是 0.</p>\n<p>最终结果，27018 成为主节点，具备读写功能。</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>myrs:SECONDARY<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>myrs:PRIMARY<span class=\"token operator\">></span></pre></td></tr></table></figure><p>回车刷新状态</p>\n<p>在 27018 写入数据查看。</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>myrs:PRIMARY<span class=\"token operator\">></span> db.comment.insert<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"_id\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"4\"</span>,<span class=\"token string\">\"name\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"弟中之弟\"</span>,<span class=\"token string\">\"age\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"123\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>myrs:PRIMARY<span class=\"token operator\">></span> db.comment.<span class=\"token function-name function\">find</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> ObjectId<span class=\"token punctuation\">(</span><span class=\"token string\">\"647ee966333697b12ce7258a\"</span><span class=\"token punctuation\">)</span>, <span class=\"token string\">\"name\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"张三\"</span>, <span class=\"token string\">\"age\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"18\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"3\"</span>, <span class=\"token string\">\"name\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"马保国\"</span>, <span class=\"token string\">\"age\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"22\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> ObjectId<span class=\"token punctuation\">(</span><span class=\"token string\">\"647f48485710428bcfbf9dbf\"</span><span class=\"token punctuation\">)</span>, <span class=\"token string\">\"name\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"李四\"</span>, <span class=\"token string\">\"age\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"23\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2\"</span>, <span class=\"token string\">\"name\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"123\"</span>, <span class=\"token string\">\"age\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"23\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"4\"</span>, <span class=\"token string\">\"name\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"弟中之弟\"</span>, <span class=\"token string\">\"age\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"123\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>myrs:PRIMARY<span class=\"token operator\">></span></pre></td></tr></table></figure><p>再启动 27017 节点，发现 27017 变成了从节点，27018 仍保持主节点。</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>dkx0@192<span class=\"token punctuation\">]</span>~% /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/replica_sets/myrs_27017/log/mongod.conf </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>about to fork child process, waiting <span class=\"token keyword\">until</span> server is ready <span class=\"token keyword\">for</span> connections.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>forked process: <span class=\"token number\">30161</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>child process started successfully, parent exiting</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>dkx0@192<span class=\"token punctuation\">]</span>~%</pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>E:<span class=\"token punctuation\">\\</span>MongoDB<span class=\"token punctuation\">\\</span>mongodb-win32-x86_64-windows-5.0.17<span class=\"token punctuation\">\\</span>bin<span class=\"token operator\">></span>mongo <span class=\"token parameter variable\">--host</span><span class=\"token operator\">=</span><span class=\"token number\">192.168</span>.244.142 <span class=\"token parameter variable\">--port</span><span class=\"token operator\">=</span><span class=\"token number\">27017</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>MongoDB server version: <span class=\"token number\">5.0</span>.18</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Warning: the <span class=\"token string\">\"mongo\"</span> shell has been superseded by <span class=\"token string\">\"mongosh\"</span>,</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">which</span> delivers improved usability and compatibility.The <span class=\"token string\">\"mongo\"</span> shell has been deprecated and will be removed <span class=\"token keyword\">in</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>an upcoming release.</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>For installation instructions, see</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>https://docs.mongodb.com/mongodb-shell/install/</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>The server generated these startup warnings when booting:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token number\">2023</span>-06-06T11:07:33.780-04:00: Access control is not enabled <span class=\"token keyword\">for</span> the database. Read and <span class=\"token function\">write</span> access to data and configuration is unrestricted</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token number\">2023</span>-06-06T11:07:33.781-04:00: /sys/kernel/mm/transparent_hugepage/enabled is <span class=\"token string\">'always'</span><span class=\"token builtin class-name\">.</span> We suggest setting it to <span class=\"token string\">'never'</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token number\">2023</span>-06-06T11:07:33.781-04:00: /sys/kernel/mm/transparent_hugepage/defrag is <span class=\"token string\">'always'</span><span class=\"token builtin class-name\">.</span> We suggest setting it to <span class=\"token string\">'never'</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token number\">2023</span>-06-06T11:07:33.781-04:00: Soft rlimits <span class=\"token keyword\">for</span> <span class=\"token function\">open</span> <span class=\"token function\">file</span> descriptors too low</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token number\">2023</span>-06-06T11:07:33.781-04:00:         currentValue: <span class=\"token number\">1024</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token number\">2023</span>-06-06T11:07:33.781-04:00:         recommendedMinimum: <span class=\"token number\">64000</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>myrs:SECONDARY<span class=\"token operator\">></span></pre></td></tr></table></figure><p>登录 27017 节点，发现是从节点了需要赋予可读权限，数据自动从 27018 同步。</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>myrs:SECONDARY<span class=\"token operator\">></span> use articledb</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>switched to db articledb</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>myrs:SECONDARY<span class=\"token operator\">></span> db.comment.find<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Error: error: <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token string\">\"topologyVersion\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                <span class=\"token string\">\"processId\"</span> <span class=\"token builtin class-name\">:</span> ObjectId<span class=\"token punctuation\">(</span><span class=\"token string\">\"647f4bb2f95feeec6c69242c\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                <span class=\"token string\">\"counter\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token string\">\"ok\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>,</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token string\">\"errmsg\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"not master and slaveOk=false\"</span>,</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token string\">\"code\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">13435</span>,</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token string\">\"codeName\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"NotPrimaryNoSecondaryOk\"</span>,</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token string\">\"<span class=\"token variable\">$clusterTime</span>\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                <span class=\"token string\">\"clusterTime\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686064102</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                <span class=\"token string\">\"signature\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                        <span class=\"token string\">\"hash\"</span> <span class=\"token builtin class-name\">:</span> BinData<span class=\"token punctuation\">(</span><span class=\"token number\">0</span>,<span class=\"token string\">\"AAAAAAAAAAAAAAAAAAAAAAAAAAA=\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                        <span class=\"token string\">\"keyId\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token string\">\"operationTime\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686064102</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>myrs:SECONDARY<span class=\"token operator\">></span> rs.secondaryOk<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>myrs:SECONDARY<span class=\"token operator\">></span> db.comment.<span class=\"token function-name function\">find</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> ObjectId<span class=\"token punctuation\">(</span><span class=\"token string\">\"647ee966333697b12ce7258a\"</span><span class=\"token punctuation\">)</span>, <span class=\"token string\">\"name\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"张三\"</span>, <span class=\"token string\">\"age\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"18\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> ObjectId<span class=\"token punctuation\">(</span><span class=\"token string\">\"647f48485710428bcfbf9dbf\"</span><span class=\"token punctuation\">)</span>, <span class=\"token string\">\"name\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"李四\"</span>, <span class=\"token string\">\"age\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"23\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2\"</span>, <span class=\"token string\">\"name\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"123\"</span>, <span class=\"token string\">\"age\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"23\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"3\"</span>, <span class=\"token string\">\"name\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"马保国\"</span>, <span class=\"token string\">\"age\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"22\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"4\"</span>, <span class=\"token string\">\"name\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"弟中之弟\"</span>, <span class=\"token string\">\"age\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"123\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>myrs:SECONDARY<span class=\"token operator\">></span></pre></td></tr></table></figure><p>从而实现了高可用。</p>\n<h3 id=\"仲载节点和主节点故障\"><a class=\"markdownIt-Anchor\" href=\"#仲载节点和主节点故障\">#</a> 仲载节点和主节点故障</h3>\n<p>先关掉仲载节点 27019</p>\n<p>关掉现在的主节点 27018</p>\n<p>登录 27017 后，发现，27017 仍然是从节点，副本集中没有主节点了，导致此时，副本集是只读状态，无法写入</p>\n<p>为啥不选举了？因为 27017 的票数，没有获得大多数，既没有大于等于 2，它只有默认的一票 (优先级是 1)</p>\n<p>如果要出发选举，随便加入一个成员即可。</p>\n<ul>\n<li>如果只加入 27019 仲载节点，则主节点一定是 27017，因为没得选了，仲载节点不参与选举，但参与投票</li>\n<li>如果只加入 27018，会发起选举，因为 27017 和 27018 都是两票，按照谁数据新，谁当主节点。</li>\n</ul>\n<h3 id=\"仲载节点和从节点故障\"><a class=\"markdownIt-Anchor\" href=\"#仲载节点和从节点故障\">#</a> 仲载节点和从节点故障</h3>\n<p>先关掉仲载节点 27019</p>\n<p>关掉现在的副本节点 27018</p>\n<p>10 秒后，27017 主节点自动降级为副本节点 (服务降级)</p>\n<p>副本集不可写数据了，已经故障了。</p>\n<h2 id=\"compass连接副本集\"><a class=\"markdownIt-Anchor\" href=\"#compass连接副本集\">#</a> Compass 连接副本集</h2>\n<p>如果使用云服务器需要修改配置中的主节点 IP</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>var config <span class=\"token operator\">=</span> rs.config<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre> config.members<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>.host<span class=\"token operator\">=</span><span class=\"token string\">\"192.168.244.142:27017\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> rs.reconfig<span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>compass 连接：</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031658537.png\" alt=\"image-20230606234834193\"></p>\n<p>输入后直接连接即可。</p>\n<p>注意：</p>\n<p>但是在 Compass 中即便连接的是 secondary 从节点但是还是可以插入数据的。</p>\n<h2 id=\"springdatamongodb连接副本集\"><a class=\"markdownIt-Anchor\" href=\"#springdatamongodb连接副本集\">#</a> SpringDataMongoDB 连接副本集</h2>\n<p>副本集语法：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>mongodb://host1,host2,host3/?connect<span class=\"token operator\">=</span>replicaSet<span class=\"token operator\">&amp;</span><span class=\"token assign-left variable\">secondaryOk</span><span class=\"token operator\">=</span>true<span class=\"token operator\">&amp;</span><span class=\"token assign-left variable\">replicaSet</span><span class=\"token operator\">=</span>副本集名字</pre></td></tr></table></figure><p>其中：</p>\n<ul>\n<li>secondaryOk=true：开启副本节点读的功能，实现读写分离。</li>\n<li>connect=replicaSet：自动到副本集中选择读写的主机，如果 secondaryOk 是打开的，则实现了读写分离</li>\n</ul>\n<p>[示例]</p>\n<p>连接 replica set 三台服务器 (端口 27017，27018，和 27019)，直接连接第一个服务器，无论是 replica set 一部分或者主服务器或者从服务器，写入操作应用在主服务器并且分布查询到从服务器。</p>\n<p>修改配置文件：application.yml</p>\n<p>连接副本集的时候就只能使用 uri 的格式了</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token comment\">#数据源配置</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token key atrule\">data</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token key atrule\">mongodb</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      <span class=\"token comment\">#主机地址</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      <span class=\"token comment\">#host: 192.168.244.142</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token comment\">#数据库</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      <span class=\"token comment\">#database: articledb</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token comment\">#端口号</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token comment\">#port: 27017</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token comment\">#也可以使用 uri 连接</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token comment\">#uri: mongodb://192.168.244.142:27017/articledb</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token comment\">#副本集的连接字符串</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token key atrule\">uri</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        mongodb<span class=\"token punctuation\">:</span>//192.168.244.142<span class=\"token punctuation\">:</span><span class=\"token number\">27017</span><span class=\"token punctuation\">,</span>192.168.244.142<span class=\"token punctuation\">:</span><span class=\"token number\">27018</span><span class=\"token punctuation\">,</span>192.168.244.142<span class=\"token punctuation\">:</span>27019/articledb<span class=\"token punctuation\">?</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        connect=replicaSet<span class=\"token important\">&amp;secondaryOk=true&amp;replicaSet=myrs</span></pre></td></tr></table></figure><p>测试是否可用：查询全部数据</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Test</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Comment</span><span class=\"token punctuation\">></span></span> list <span class=\"token operator\">=</span> commentService<span class=\"token punctuation\">.</span><span class=\"token function\">findCommentList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Comment</span> i<span class=\"token operator\">:</span>list<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">-</span><span class=\"token constant\">RUN</span> <span class=\"token class-name\">Result</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">-</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token class-name\">Comment</span><span class=\"token punctuation\">(</span>id<span class=\"token operator\">=</span><span class=\"token number\">647</span>ee966333697b12ce7258a<span class=\"token punctuation\">,</span> content<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> publishtime<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> userid<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> nickname<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> createdatatim<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> likenum<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> replynum<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> state<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> parentid<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> articleid<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token class-name\">Comment</span><span class=\"token punctuation\">(</span>id<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> content<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> publishtime<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> userid<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> nickname<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> createdatatim<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> likenum<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> replynum<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> state<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> parentid<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> articleid<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token class-name\">Comment</span><span class=\"token punctuation\">(</span>id<span class=\"token operator\">=</span><span class=\"token number\">647f</span><span class=\"token number\">48485710428</span>bcfbf9dbf<span class=\"token punctuation\">,</span> content<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> publishtime<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> userid<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> nickname<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> createdatatim<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> likenum<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> replynum<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> state<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> parentid<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> articleid<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token class-name\">Comment</span><span class=\"token punctuation\">(</span>id<span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> content<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> publishtime<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> userid<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> nickname<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> createdatatim<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> likenum<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> replynum<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> state<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> parentid<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> articleid<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token class-name\">Comment</span><span class=\"token punctuation\">(</span>id<span class=\"token operator\">=</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> content<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> publishtime<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> userid<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> nickname<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> createdatatim<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> likenum<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> replynum<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> state<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> parentid<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> articleid<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token class-name\">Comment</span><span class=\"token punctuation\">(</span>id<span class=\"token operator\">=</span><span class=\"token number\">647f</span><span class=\"token number\">5445f</span><span class=\"token number\">81</span>b0775f8f31924<span class=\"token punctuation\">,</span> content<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> publishtime<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> userid<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> nickname<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> createdatatim<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> likenum<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> replynum<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> state<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> parentid<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> articleid<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token class-name\">Comment</span><span class=\"token punctuation\">(</span>id<span class=\"token operator\">=</span><span class=\"token number\">647f</span><span class=\"token number\">54</span>b24cf08bc145fd6995<span class=\"token punctuation\">,</span> content<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> publishtime<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> userid<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> nickname<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> createdatatim<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> likenum<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> replynum<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> state<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> parentid<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> articleid<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>id 能查出来就证明可用，其它为 null 是因为实体类与表结构</p>\n<p>注意：</p>\n<p>主机必须是副本集中所有的主机，包括主节点，副本节点，仲载节点。</p>\n<h2 id=\"分片集群-sharded-cluster\"><a class=\"markdownIt-Anchor\" href=\"#分片集群-sharded-cluster\">#</a> 分片集群 - Sharded Cluster</h2>\n<h3 id=\"分片概念\"><a class=\"markdownIt-Anchor\" href=\"#分片概念\">#</a> 分片概念</h3>\n<p>分片 (sharding) 是一种跨多台机器分布数据的方法，MongoDB 使用分片来支持具有非常大的数据集和高吞吐量操作的部署。</p>\n<p>换句话说：分片 (sharding) 是指将数据拆分，将其分散存在不同的机器上的过程，有时也用分区 (partitioning) 来表示这个概念，将数据分散道不同的机器上，不需要功能强大的大型计算机就可以存储更多的数据，处理更多的负载。</p>\n<p>具有大型数据集或吞吐量应用程序的数据库系统可以会挑战单个服务器的容量，例如，高查询率会耗尽服务器的 CPU 容量，工作集大小大于系统的 RAM 会强调磁盘驱动的 I/O 容量</p>\n<p>有两种解决系统增长的办法：垂直扩展和水平扩展。</p>\n<p>垂直扩展意味着增加单个服务器的容量，例如使用更强大的 CPU，添加更多 RAM 或增加存储空间量。可用技术的局限性可能会限制单个机器对于给定工作负载而言而言足够强大，此外，基于云 的提供商基于可用的硬件配置具有硬性上限，结果，垂直缩放有实际的最大值</p>\n<p>水平扩展意味着划分系统数据集并加载多个服务器，添加其他服务器以根据需要增加容量，虽然单个机器的总题速度或容量可能不高，但每台机器处理整个工作负载的子集，可能提供比单个高速大容量服务器更高的效率，扩展部署容量只需要根据需要添加额外的服务器，这可能比单个机器的高端硬件的总体成本更低，权衡是基础架构和部署维护的复杂性增加。</p>\n<p>MongoDB 支持通过分片进行水平扩展。</p>\n<h3 id=\"分片集群包含的组件\"><a class=\"markdownIt-Anchor\" href=\"#分片集群包含的组件\">#</a> 分片集群包含的组件</h3>\n<p>MongoDB 分片集群包含以下组件：</p>\n<ul>\n<li>分片 (存储)：每个分片包含分片数据的子集，每个分片都可以部署为副本集</li>\n<li>mongos (路由)：mongos 充当查询路由器，在客户端应用程序和分片集群之间提供接口</li>\n<li>config server (&quot;调度&quot; 的配置)：配置服务器存储群集的元数据和配置设置，从 MongoDB3.4 开始，必须将配置服务器部署为副本集 (CSRS)</li>\n</ul>\n<p>下图描述了分片集群中组件的交互：</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031659686.png\" alt=\"image-20230607171021552\"></p>\n<p>MongoDB 在集合级别对数据库进行分片，将集合数据分布在集群中的分片上</p>\n<p>27018 if mongod is a shared member</p>\n<p>27019 if mongod is a config server member</p>\n<h3 id=\"分片集群架构目标\"><a class=\"markdownIt-Anchor\" href=\"#分片集群架构目标\">#</a> 分片集群架构目标</h3>\n<p>两个分片节点副本集 (3+3) + 一个配置节点副本集 (3) + 两个路由节点 (2) ，共 11 个服务节点。</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031659822.png\" alt=\"image-20230607171256122\"></p>\n<h3 id=\"分片存储节点副本集的创建\"><a class=\"markdownIt-Anchor\" href=\"#分片存储节点副本集的创建\">#</a> 分片 (存储) 节点副本集的创建</h3>\n<p>所有的配置文件都直接放到 sharded_cluster 的相应的子目录下，默认配置文件名字：mongod.conf</p>\n<h3 id=\"第一套副本集\"><a class=\"markdownIt-Anchor\" href=\"#第一套副本集\">#</a> 第一套副本集</h3>\n<p>准备存放数据和日志的目录</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /mongodb/sharded_cluster/myshardrs01_27018/log <span class=\"token punctuation\">\\</span> <span class=\"token operator\">&amp;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /mongodb/sharded_cluster/myshardrs01_27018/data/db <span class=\"token punctuation\">\\</span> <span class=\"token operator\">&amp;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /mongodb/sharded_cluster/myshardrs01_27118/log <span class=\"token punctuation\">\\</span> <span class=\"token operator\">&amp;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /mongodb/sharded_cluster/myshardrs01_27118/data/db <span class=\"token punctuation\">\\</span> <span class=\"token operator\">&amp;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /mongodb/sharded_cluster/myshardrs01_27218/log <span class=\"token punctuation\">\\</span> <span class=\"token operator\">&amp;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /mongodb/sharded_cluster/myshardrs01_27218/data/db</pre></td></tr></table></figure><p><mark>第一个服务</mark></p>\n<p>新建或修改配置文件：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">vim</span> /mongodb/sharded_cluster/myshardrs01_27018/mongod.conf</pre></td></tr></table></figure><p>配置文件内容：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>systemLog:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token comment\">#MongoDB 发送所有日志输出的目标指定为文件</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> <span class=\"token comment\">#The path of the log file to which mongod or mongos should send all diagnostic logging information</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre> destination: <span class=\"token function\">file</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> <span class=\"token comment\">#mongod 或 mongos 应向其发送所有诊断日志记录信息的日志文件的路径</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> path: <span class=\"token string\">\"/mongodb/sharded_cluster/myshardrs01_27018/log/mongod.log\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre> <span class=\"token comment\">#当 mongos 或 mongod 实例重新启动时，mongos 或 mongod 会将新条目附加到现有日志文件的末尾。</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre> logAppend: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>storage:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre> <span class=\"token comment\">#mongod 实例存储其数据的目录。storage.dbPath 设置仅适用于 mongod。</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre> <span class=\"token comment\">#The directory where the mongod instance stores its data.Defaul value is \"/data/db\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre> dbPath: <span class=\"token string\">\"/mongodb/sharded_cluster/myshardrs01_27018/data/db\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre> journal:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token comment\">#启用或禁用持久性日志以确保数据文件保持有效和可恢复</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  enabled: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>processManagement:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token comment\">#启用在后台运行 mongos 或 mongod 进程的守护进程模式。</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre> fork: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre> <span class=\"token comment\">#指定用于保存 mongos 或 mongod 进程的进行 ID 的文件位置，其中 mongos 或 mongod 将写入其 PID</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre> pidFilePath: <span class=\"token string\">\"/mongodb/sharded_cluster/myshardrs01_27018/log/mongod.pid\"</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>net:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token comment\">#服务实例绑定 IP，默认是 localhost</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre> bindIp: localhost,192.168.244.142</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token comment\">#bindIp</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token comment\">#绑定的端口，默认是 27017</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre> port: <span class=\"token number\">27017</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>replication:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre> <span class=\"token comment\">#副本集的名称</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre> replSetName: myshardrs01</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>sharding:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre> <span class=\"token comment\">#分片角色</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre> clusterRole: shardsvr</pre></td></tr></table></figure><p>sharding.clusterRole：</p>\n<table>\n<thead>\n<tr>\n<th>Value</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>configsvr</td>\n<td>Start this instance as a config server. The instance starts on port 27019 by default</td>\n</tr>\n<tr>\n<td>shardsvr</td>\n<td>Start this instance as a shard. The instance starts on port 27018 by default</td>\n</tr>\n</tbody>\n</table>\n<p>注意：</p>\n<p>设置 sharding.clusterRole 需要 mongod 实例运行复制，要将实例部署为副本即成员，请使用 replSetName 设置并制定副本集的名称。</p>\n<p><mark>第二个服务</mark></p>\n<p>新建或修改配置文件：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">vim</span> /mongodb/sharded_cluster/myshardrs01_27118/mongod.conf</pre></td></tr></table></figure><p>配置文件内容：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>systemLog:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token comment\">#MongoDB 发送所有日志输出的目标指定为文件</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> <span class=\"token comment\">#The path of the log file to which mongod or mongos should send all diagnostic logging information</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre> destination: <span class=\"token function\">file</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> <span class=\"token comment\">#mongod 或 mongos 应向其发送所有诊断日志记录信息的日志文件的路径</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> path: <span class=\"token string\">\"/mongodb/sharded_cluster/myshardrs01_27118/log/mongod.log\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre> <span class=\"token comment\">#当 mongos 或 mongod 实例重新启动时，mongos 或 mongod 会将新条目附加到现有日志文件的末尾。</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre> logAppend: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>storage:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre> <span class=\"token comment\">#mongod 实例存储其数据的目录。storage.dbPath 设置仅适用于 mongod。</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre> <span class=\"token comment\">#The directory where the mongod instance stores its data.Defaul value is \"/data/db\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre> dbPath: <span class=\"token string\">\"/mongodb/sharded_cluster/myshardrs01_27118/data/db\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre> journal:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token comment\">#启用或禁用持久性日志以确保数据文件保持有效和可恢复</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  enabled: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>processManagement:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token comment\">#启用在后台运行 mongos 或 mongod 进程的守护进程模式。</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre> fork: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre> <span class=\"token comment\">#指定用于保存 mongos 或 mongod 进程的进行 ID 的文件位置，其中 mongos 或 mongod 将写入其 PID</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre> pidFilePath: <span class=\"token string\">\"/mongodb/sharded_cluster/myshardrs01_27118/log/mongod.pid\"</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>net:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token comment\">#服务实例绑定 IP，默认是 localhost</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre> bindIp: localhost,192.168.244.142</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token comment\">#bindIp</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token comment\">#绑定的端口，默认是 27017</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre> port: <span class=\"token number\">27118</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>replication:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre> <span class=\"token comment\">#副本集的名称</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre> replSetName: myshardrs01</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>sharding:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre> <span class=\"token comment\">#分片角色</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre> clusterRole: shardsvr</pre></td></tr></table></figure><p><mark>第三个服务</mark></p>\n<p>新建或修改配置文件：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">vim</span> /mongodb/sharded_cluster/myshardrs01_27218/mongod.conf</pre></td></tr></table></figure><p>配置文件内容：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>systemLog:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token comment\">#MongoDB 发送所有日志输出的目标指定为文件</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> <span class=\"token comment\">#The path of the log file to which mongod or mongos should send all diagnostic logging information</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre> destination: <span class=\"token function\">file</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> <span class=\"token comment\">#mongod 或 mongos 应向其发送所有诊断日志记录信息的日志文件的路径</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> path: <span class=\"token string\">\"/mongodb/sharded_cluster/myshardrs01_27218/log/mongod.log\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre> <span class=\"token comment\">#当 mongos 或 mongod 实例重新启动时，mongos 或 mongod 会将新条目附加到现有日志文件的末尾。</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre> logAppend: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>storage:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre> <span class=\"token comment\">#mongod 实例存储其数据的目录。storage.dbPath 设置仅适用于 mongod。</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre> <span class=\"token comment\">#The directory where the mongod instance stores its data.Defaul value is \"/data/db\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre> dbPath: <span class=\"token string\">\"/mongodb/sharded_cluster/myshardrs01_27218/data/db\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre> journal:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token comment\">#启用或禁用持久性日志以确保数据文件保持有效和可恢复</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  enabled: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>processManagement:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token comment\">#启用在后台运行 mongos 或 mongod 进程的守护进程模式。</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre> fork: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre> <span class=\"token comment\">#指定用于保存 mongos 或 mongod 进程的进行 ID 的文件位置，其中 mongos 或 mongod 将写入其 PID</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre> pidFilePath: <span class=\"token string\">\"/mongodb/sharded_cluster/myshardrs01_27218/log/mongod.pid\"</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>net:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token comment\">#服务实例绑定 IP，默认是 localhost</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre> bindIp: localhost,192.168.244.142</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token comment\">#bindIp</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token comment\">#绑定的端口，默认是 27017</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre> port: <span class=\"token number\">27218</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>replication:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre> <span class=\"token comment\">#副本集的名称</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre> replSetName: myshardrs01</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>sharding:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre> <span class=\"token comment\">#分片角色</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre> clusterRole: shardsvr</pre></td></tr></table></figure><p>启动第一套副本集：一主一副一仲载</p>\n<p>依次启动三个 mongod 服务：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>➜  / /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/sharded_cluster/myshardrs01_27018/mongod.conf </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>about to fork child process, waiting <span class=\"token keyword\">until</span> server is ready <span class=\"token keyword\">for</span> connections.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>forked process: <span class=\"token number\">2821</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>child process started successfully, parent exiting</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>➜  / /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/sharded_cluster/myshardrs01_27118/mongod.conf </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>about to fork child process, waiting <span class=\"token keyword\">until</span> server is ready <span class=\"token keyword\">for</span> connections.</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>forked process: <span class=\"token number\">2894</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>child process started successfully, parent exiting</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>➜  / /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/sharded_cluster/myshardrs01_27218/mongod.conf </pre></td></tr><tr><td data-num=\"10\"></td><td><pre>about to fork child process, waiting <span class=\"token keyword\">until</span> server is ready <span class=\"token keyword\">for</span> connections.</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>forked process: <span class=\"token number\">2963</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>child process started successfully, parent exiting</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>➜  /</pre></td></tr></table></figure><p>查看启动进程情况：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>➜  / <span class=\"token function\">ps</span> -ef<span class=\"token operator\">|</span><span class=\"token function\">grep</span> mongod<span class=\"token operator\">|</span><span class=\"token function\">grep</span> <span class=\"token parameter variable\">-v</span> <span class=\"token function\">grep</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>dkx0       <span class=\"token number\">2821</span>      <span class=\"token number\">1</span>  <span class=\"token number\">7</span> 06:55 ?        00:00:03 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/sharded_cluster/myshardrs01_27018/mongod.conf</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>dkx0       <span class=\"token number\">2894</span>      <span class=\"token number\">1</span> <span class=\"token number\">10</span> 06:55 ?        00:00:02 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/sharded_cluster/myshardrs01_27118/mongod.conf</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>dkx0       <span class=\"token number\">2963</span>      <span class=\"token number\">1</span> <span class=\"token number\">16</span> 06:56 ?        00:00:02 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/sharded_cluster/myshardrs01_27218/mongod.conf</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>➜  /</pre></td></tr></table></figure><p>1. 初始化副本集和创建主节点：</p>\n<p>使用客户端命令连接任意一个节点，但这里尽量要连接主节点：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>➜  ~ /usr/local/mongodb/bin/mongo  <span class=\"token parameter variable\">--host</span><span class=\"token operator\">=</span><span class=\"token number\">192.168</span>.244.142 <span class=\"token parameter variable\">--port</span><span class=\"token operator\">=</span><span class=\"token number\">27018</span></pre></td></tr></table></figure><p>执行初始化副本集命令：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> rs.<span class=\"token function-name function\">initiate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token string\">\"info2\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"no configuration specified. Using a default configuration for the set\"</span>,</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token string\">\"me\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"192.168.244.142:27018\"</span>,</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token string\">\"ok\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>myshardrs01:SECONDARY<span class=\"token operator\">></span> </pre></td></tr><tr><td data-num=\"8\"></td><td><pre>myshardrs01:PRIMARY<span class=\"token operator\">></span></pre></td></tr></table></figure><p>添加从节点和仲载节点：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>myshardrs01:PRIMARY<span class=\"token operator\">></span> rs.add<span class=\"token punctuation\">(</span><span class=\"token string\">\"192.168.244.142:27118\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>myshardrs01:PRIMARY<span class=\"token operator\">></span> rs.add<span class=\"token punctuation\">(</span><span class=\"token string\">\"192.168.244.142:27218\"</span>,true<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>查看副本集的配置情况：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>myshardrs01:PRIMARY<span class=\"token operator\">></span> rs.<span class=\"token function-name function\">conf</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"myshardrs01\"</span>,</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token string\">\"version\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">3</span>,</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token string\">\"term\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token string\">\"members\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t\t<span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>,</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t\t<span class=\"token string\">\"host\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"192.168.244.142:27018\"</span>,</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t\t<span class=\"token string\">\"arbiterOnly\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\t\t<span class=\"token string\">\"buildIndexes\"</span> <span class=\"token builtin class-name\">:</span> true,</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t\t<span class=\"token string\">\"hidden\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t\t<span class=\"token string\">\"priority\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t\t<span class=\"token string\">\"tags\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t\t\t</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t\t<span class=\"token string\">\"slaveDelay\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t\t<span class=\"token string\">\"votes\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t\t<span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\t\t<span class=\"token string\">\"host\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"192.168.244.142:27118\"</span>,</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t\t<span class=\"token string\">\"arbiterOnly\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t\t<span class=\"token string\">\"buildIndexes\"</span> <span class=\"token builtin class-name\">:</span> true,</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t\t<span class=\"token string\">\"hidden\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t\t<span class=\"token string\">\"priority\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t\t<span class=\"token string\">\"tags\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t\t\t</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t\t<span class=\"token string\">\"slaveDelay\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t\t<span class=\"token string\">\"votes\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t\t<span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span>,</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t\t<span class=\"token string\">\"host\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"192.168.244.142:27218\"</span>,</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\t\t<span class=\"token string\">\"arbiterOnly\"</span> <span class=\"token builtin class-name\">:</span> true,</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\t\t<span class=\"token string\">\"buildIndexes\"</span> <span class=\"token builtin class-name\">:</span> true,</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\t\t<span class=\"token string\">\"hidden\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\t\t<span class=\"token string\">\"priority\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>,</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\t\t<span class=\"token string\">\"tags\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\t\t\t</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\t\t<span class=\"token string\">\"slaveDelay\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t\t\t<span class=\"token string\">\"votes\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t<span class=\"token punctuation\">]</span>,</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t<span class=\"token string\">\"protocolVersion\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t<span class=\"token string\">\"writeConcernMajorityJournalDefault\"</span> <span class=\"token builtin class-name\">:</span> true,</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t<span class=\"token string\">\"settings\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t\t<span class=\"token string\">\"chainingAllowed\"</span> <span class=\"token builtin class-name\">:</span> true,</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t\t<span class=\"token string\">\"heartbeatIntervalMillis\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2000</span>,</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t\t<span class=\"token string\">\"heartbeatTimeoutSecs\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">10</span>,</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t\t<span class=\"token string\">\"electionTimeoutMillis\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">10000</span>,</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t\t<span class=\"token string\">\"catchUpTimeoutMillis\"</span> <span class=\"token builtin class-name\">:</span> -1,</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t\t<span class=\"token string\">\"catchUpTakeoverDelayMillis\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">30000</span>,</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t\t<span class=\"token string\">\"getLastErrorModes\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t\t\t</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t\t<span class=\"token string\">\"getLastErrorDefaults\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t\t\t<span class=\"token string\">\"w\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\t\t\t<span class=\"token string\">\"wtimeout\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t\t<span class=\"token string\">\"replicaSetId\"</span> <span class=\"token builtin class-name\">:</span> ObjectId<span class=\"token punctuation\">(</span><span class=\"token string\">\"648128e18751ababd297a5f4\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>myshardrs01:PRIMARY<span class=\"token operator\">></span></pre></td></tr></table></figure><h3 id=\"第二套副本集\"><a class=\"markdownIt-Anchor\" href=\"#第二套副本集\">#</a> 第二套副本集</h3>\n<p>创建存放数据和日志的目录：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /mongodb/sharded_cluster/myshardrs01_27318/log <span class=\"token punctuation\">\\</span> <span class=\"token operator\">&amp;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /mongodb/sharded_cluster/myshardrs01_27318/data/db <span class=\"token punctuation\">\\</span> <span class=\"token operator\">&amp;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /mongodb/sharded_cluster/myshardrs01_27418/log <span class=\"token punctuation\">\\</span> <span class=\"token operator\">&amp;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /mongodb/sharded_cluster/myshardrs01_27418/data/db <span class=\"token punctuation\">\\</span> <span class=\"token operator\">&amp;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /mongodb/sharded_cluster/myshardrs01_27518/log <span class=\"token punctuation\">\\</span> <span class=\"token operator\">&amp;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /mongodb/sharded_cluster/myshardrs01_27518/data/db</pre></td></tr></table></figure><p><mark>第一个服务</mark></p>\n<p>新建或修改配置文件：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>➜  ~ <span class=\"token function\">vim</span> /mongodb/sharded_cluster/myshardrs01_27318/mongod.conf</pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>systemLog:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token comment\">#MongoDB 发送所有日志输出的目标指定为文件</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> <span class=\"token comment\">#The path of the log file to which mongod or mongos should send all diagnostic logging information</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre> destination: <span class=\"token function\">file</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> <span class=\"token comment\">#mongod 或 mongos 应向其发送所有诊断日志记录信息的日志文件的路径</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> path: <span class=\"token string\">\"/mongodb/sharded_cluster/myshardrs01_27318/log/mongod.log\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre> <span class=\"token comment\">#当 mongos 或 mongod 实例重新启动时，mongos 或 mongod 会将新条目附加到现有日志文件的末尾。</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre> logAppend: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>storage:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre> <span class=\"token comment\">#mongod 实例存储其数据的目录。storage.dbPath 设置仅适用于 mongod。</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre> <span class=\"token comment\">#The directory where the mongod instance stores its data.Defaul value is \"/data/db\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre> dbPath: <span class=\"token string\">\"/mongodb/sharded_cluster/myshardrs01_27318/data/db\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre> journal:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token comment\">#启用或禁用持久性日志以确保数据文件保持有效和可恢复</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  enabled: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>processManagement:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token comment\">#启用在后台运行 mongos 或 mongod 进程的守护进程模式。</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre> fork: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre> <span class=\"token comment\">#指定用于保存 mongos 或 mongod 进程的进行 ID 的文件位置，其中 mongos 或 mongod 将写入其 PID</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre> pidFilePath: <span class=\"token string\">\"/mongodb/sharded_cluster/myshardrs01_27318/log/mongod.pid\"</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>net:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token comment\">#服务实例绑定 IP，默认是 localhost</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre> bindIp: localhost,192.168.244.142</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token comment\">#bindIp</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token comment\">#绑定的端口，默认是 27017</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre> port: <span class=\"token number\">27318</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>replication:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre> <span class=\"token comment\">#副本集的名称</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre> replSetName: myshardrs02</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>sharding:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre> <span class=\"token comment\">#分片角色</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre> clusterRole: shardsvr</pre></td></tr></table></figure><p><mark>第二个服务</mark></p>\n<p>新建或修改配置文件：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>➜  ~ <span class=\"token function\">vim</span> /mongodb/sharded_cluster/myshardrs01_27418/mongod.conf</pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>systemLog:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token comment\">#MongoDB 发送所有日志输出的目标指定为文件</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> <span class=\"token comment\">#The path of the log file to which mongod or mongos should send all diagnostic logging information</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre> destination: <span class=\"token function\">file</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> <span class=\"token comment\">#mongod 或 mongos 应向其发送所有诊断日志记录信息的日志文件的路径</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> path: <span class=\"token string\">\"/mongodb/sharded_cluster/myshardrs01_27418/log/mongod.log\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre> <span class=\"token comment\">#当 mongos 或 mongod 实例重新启动时，mongos 或 mongod 会将新条目附加到现有日志文件的末尾。</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre> logAppend: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>storage:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre> <span class=\"token comment\">#mongod 实例存储其数据的目录。storage.dbPath 设置仅适用于 mongod。</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre> <span class=\"token comment\">#The directory where the mongod instance stores its data.Defaul value is \"/data/db\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre> dbPath: <span class=\"token string\">\"/mongodb/sharded_cluster/myshardrs01_27418/data/db\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre> journal:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token comment\">#启用或禁用持久性日志以确保数据文件保持有效和可恢复</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  enabled: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>processManagement:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token comment\">#启用在后台运行 mongos 或 mongod 进程的守护进程模式。</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre> fork: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre> <span class=\"token comment\">#指定用于保存 mongos 或 mongod 进程的进行 ID 的文件位置，其中 mongos 或 mongod 将写入其 PID</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre> pidFilePath: <span class=\"token string\">\"/mongodb/sharded_cluster/myshardrs01_27418/log/mongod.pid\"</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>net:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token comment\">#服务实例绑定 IP，默认是 localhost</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre> bindIp: localhost,192.168.244.142</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token comment\">#bindIp</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token comment\">#绑定的端口，默认是 27017</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre> port: <span class=\"token number\">27418</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>replication:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre> <span class=\"token comment\">#副本集的名称</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre> replSetName: myshardrs02</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>sharding:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre> <span class=\"token comment\">#分片角色</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre> clusterRole: shardsvr</pre></td></tr></table></figure><p><mark>第三个服务</mark></p>\n<p>新建或修改配置文件：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>➜  ~ <span class=\"token function\">vim</span> /mongodb/sharded_cluster/myshardrs01_27518/mongod.conf</pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>systemLog:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token comment\">#MongoDB 发送所有日志输出的目标指定为文件</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> <span class=\"token comment\">#The path of the log file to which mongod or mongos should send all diagnostic logging information</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre> destination: <span class=\"token function\">file</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> <span class=\"token comment\">#mongod 或 mongos 应向其发送所有诊断日志记录信息的日志文件的路径</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> path: <span class=\"token string\">\"/mongodb/sharded_cluster/myshardrs01_27518/log/mongod.log\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre> <span class=\"token comment\">#当 mongos 或 mongod 实例重新启动时，mongos 或 mongod 会将新条目附加到现有日志文件的末尾。</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre> logAppend: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>storage:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre> <span class=\"token comment\">#mongod 实例存储其数据的目录。storage.dbPath 设置仅适用于 mongod。</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre> <span class=\"token comment\">#The directory where the mongod instance stores its data.Defaul value is \"/data/db\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre> dbPath: <span class=\"token string\">\"/mongodb/sharded_cluster/myshardrs01_27518/data/db\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre> journal:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token comment\">#启用或禁用持久性日志以确保数据文件保持有效和可恢复</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  enabled: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>processManagement:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token comment\">#启用在后台运行 mongos 或 mongod 进程的守护进程模式。</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre> fork: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre> <span class=\"token comment\">#指定用于保存 mongos 或 mongod 进程的进行 ID 的文件位置，其中 mongos 或 mongod 将写入其 PID</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre> pidFilePath: <span class=\"token string\">\"/mongodb/sharded_cluster/myshardrs01_27518/log/mongod.pid\"</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>net:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token comment\">#服务实例绑定 IP，默认是 localhost</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre> bindIp: localhost,192.168.244.142</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token comment\">#bindIp</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token comment\">#绑定的端口，默认是 27017</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre> port: <span class=\"token number\">27518</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>replication:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre> <span class=\"token comment\">#副本集的名称</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre> replSetName: myshardrs02</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>sharding:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre> <span class=\"token comment\">#分片角色</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre> clusterRole: shardsvr</pre></td></tr></table></figure><p>启动服务：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>➜  ~ /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/sharded_cluster/myshardrs01_27318/mongod.conf </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>about to fork child process, waiting <span class=\"token keyword\">until</span> server is ready <span class=\"token keyword\">for</span> connections.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>forked process: <span class=\"token number\">5200</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>child process started successfully, parent exiting</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>➜  ~ /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/sharded_cluster/myshardrs01_27418/mongod.conf </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>about to fork child process, waiting <span class=\"token keyword\">until</span> server is ready <span class=\"token keyword\">for</span> connections.</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>forked process: <span class=\"token number\">5268</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>child process started successfully, parent exiting</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>➜  ~ /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/sharded_cluster/myshardrs01_27518/mongod.conf </pre></td></tr><tr><td data-num=\"10\"></td><td><pre>about to fork child process, waiting <span class=\"token keyword\">until</span> server is ready <span class=\"token keyword\">for</span> connections.</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>forked process: <span class=\"token number\">5337</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>child process started successfully, parent exiting</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>➜  ~</pre></td></tr></table></figure><p>查看进程：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>➜  ~ <span class=\"token function\">ps</span> -ef<span class=\"token operator\">|</span><span class=\"token function\">grep</span> mongod<span class=\"token operator\">|</span><span class=\"token function\">grep</span> <span class=\"token parameter variable\">-v</span> <span class=\"token function\">grep</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>dkx0       <span class=\"token number\">2291</span>      <span class=\"token number\">1</span>  <span class=\"token number\">1</span> <span class=\"token number\">20</span>:57 ?        00:00:52 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/sharded_cluster/myshardrs01_27018/mongod.conf</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>dkx0       <span class=\"token number\">2368</span>      <span class=\"token number\">1</span>  <span class=\"token number\">2</span> <span class=\"token number\">20</span>:57 ?        00:01:11 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/sharded_cluster/myshardrs01_27118/mongod.conf</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>dkx0       <span class=\"token number\">2443</span>      <span class=\"token number\">1</span>  <span class=\"token number\">2</span> <span class=\"token number\">20</span>:57 ?        00:01:08 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/sharded_cluster/myshardrs01_27218/mongod.conf</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>dkx0       <span class=\"token number\">5200</span>      <span class=\"token number\">1</span>  <span class=\"token number\">4</span> <span class=\"token number\">21</span>:42 ?        00:00:03 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/sharded_cluster/myshardrs01_27318/mongod.conf</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>dkx0       <span class=\"token number\">5268</span>      <span class=\"token number\">1</span>  <span class=\"token number\">5</span> <span class=\"token number\">21</span>:42 ?        00:00:03 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/sharded_cluster/myshardrs01_27418/mongod.conf</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>dkx0       <span class=\"token number\">5337</span>      <span class=\"token number\">1</span>  <span class=\"token number\">5</span> <span class=\"token number\">21</span>:43 ?        00:00:02 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/sharded_cluster/myshardrs01_27518/mongod.conf</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>➜  ~</pre></td></tr></table></figure><p>初始化副本集和创建主节点：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>➜  ~ /usr/local/mongodb/bin/mongo <span class=\"token parameter variable\">--host</span><span class=\"token operator\">=</span><span class=\"token number\">192.168</span>.244.142 <span class=\"token parameter variable\">--port</span><span class=\"token operator\">=</span><span class=\"token number\">27318</span></pre></td></tr></table></figure><p>初始化副本集：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> rs.<span class=\"token function-name function\">initiate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token string\">\"info2\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"no configuration specified. Using a default configuration for the set\"</span>,</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token string\">\"me\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"192.168.244.142:27318\"</span>,</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token string\">\"ok\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>myshardrs02:SECONDARY<span class=\"token operator\">></span> </pre></td></tr><tr><td data-num=\"8\"></td><td><pre>myshardrs02:PRIMARY<span class=\"token operator\">></span></pre></td></tr></table></figure><p>添加从节点和仲载节点：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>myshardrs02:PRIMARY<span class=\"token operator\">></span> rs.add<span class=\"token punctuation\">(</span><span class=\"token string\">\"192.168.244.142:27418\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>myshardrs02:PRIMARY<span class=\"token operator\">></span> rs.add<span class=\"token punctuation\">(</span><span class=\"token string\">\"192.168.244.142:27518\"</span>,true<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>查看状态：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>myshardrs02:PRIMARY<span class=\"token operator\">></span> rs.<span class=\"token function-name function\">conf</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"myshardrs02\"</span>,</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token string\">\"version\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">3</span>,</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token string\">\"term\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token string\">\"members\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t\t<span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>,</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t\t<span class=\"token string\">\"host\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"192.168.244.142:27318\"</span>,</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t\t<span class=\"token string\">\"arbiterOnly\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\t\t<span class=\"token string\">\"buildIndexes\"</span> <span class=\"token builtin class-name\">:</span> true,</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t\t<span class=\"token string\">\"hidden\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t\t<span class=\"token string\">\"priority\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t\t<span class=\"token string\">\"tags\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t\t\t</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t\t<span class=\"token string\">\"slaveDelay\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t\t<span class=\"token string\">\"votes\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t\t<span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\t\t<span class=\"token string\">\"host\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"192.168.244.142:27418\"</span>,</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t\t<span class=\"token string\">\"arbiterOnly\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t\t<span class=\"token string\">\"buildIndexes\"</span> <span class=\"token builtin class-name\">:</span> true,</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t\t<span class=\"token string\">\"hidden\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t\t<span class=\"token string\">\"priority\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t\t<span class=\"token string\">\"tags\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t\t\t</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t\t<span class=\"token string\">\"slaveDelay\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t\t<span class=\"token string\">\"votes\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t\t<span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span>,</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t\t<span class=\"token string\">\"host\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"192.168.244.142:27518\"</span>,</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\t\t<span class=\"token string\">\"arbiterOnly\"</span> <span class=\"token builtin class-name\">:</span> true,</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\t\t<span class=\"token string\">\"buildIndexes\"</span> <span class=\"token builtin class-name\">:</span> true,</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\t\t<span class=\"token string\">\"hidden\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\t\t<span class=\"token string\">\"priority\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>,</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\t\t<span class=\"token string\">\"tags\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\t\t\t</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\t\t<span class=\"token string\">\"slaveDelay\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t\t\t<span class=\"token string\">\"votes\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t<span class=\"token punctuation\">]</span>,</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t<span class=\"token string\">\"protocolVersion\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t<span class=\"token string\">\"writeConcernMajorityJournalDefault\"</span> <span class=\"token builtin class-name\">:</span> true,</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t<span class=\"token string\">\"settings\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t\t<span class=\"token string\">\"chainingAllowed\"</span> <span class=\"token builtin class-name\">:</span> true,</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t\t<span class=\"token string\">\"heartbeatIntervalMillis\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2000</span>,</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t\t<span class=\"token string\">\"heartbeatTimeoutSecs\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">10</span>,</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t\t<span class=\"token string\">\"electionTimeoutMillis\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">10000</span>,</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t\t<span class=\"token string\">\"catchUpTimeoutMillis\"</span> <span class=\"token builtin class-name\">:</span> -1,</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t\t<span class=\"token string\">\"catchUpTakeoverDelayMillis\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">30000</span>,</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t\t<span class=\"token string\">\"getLastErrorModes\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t\t\t</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t\t<span class=\"token string\">\"getLastErrorDefaults\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t\t\t<span class=\"token string\">\"w\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\t\t\t<span class=\"token string\">\"wtimeout\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t\t<span class=\"token string\">\"replicaSetId\"</span> <span class=\"token builtin class-name\">:</span> ObjectId<span class=\"token punctuation\">(</span><span class=\"token string\">\"648132fed44efefc463628be\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>myshardrs02:PRIMARY<span class=\"token operator\">></span></pre></td></tr></table></figure><p>到此两个分片副本集就搭建完成了</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031659810.png\" alt=\"image-20230608095125494\"></p>\n<p>下面搭建配置服务</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031659497.png\" alt=\"image-20230608095211835\"></p>\n<h3 id=\"配置节点副本集的创建\"><a class=\"markdownIt-Anchor\" href=\"#配置节点副本集的创建\">#</a> 配置节点副本集的创建</h3>\n<p>创建存放数据和日志的目录：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /mongodb/sharded_cluster/myshardrs01_27019/log <span class=\"token punctuation\">\\</span> <span class=\"token operator\">&amp;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /mongodb/sharded_cluster/myshardrs01_27019/data/db <span class=\"token punctuation\">\\</span> <span class=\"token operator\">&amp;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /mongodb/sharded_cluster/myshardrs01_27119/log <span class=\"token punctuation\">\\</span> <span class=\"token operator\">&amp;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /mongodb/sharded_cluster/myshardrs01_27119/data/db <span class=\"token punctuation\">\\</span> <span class=\"token operator\">&amp;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /mongodb/sharded_cluster/myshardrs01_27219/log <span class=\"token punctuation\">\\</span> <span class=\"token operator\">&amp;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /mongodb/sharded_cluster/myshardrs01_27219/data/db</pre></td></tr></table></figure><p><mark>第一个服务</mark></p>\n<p>新建或修改配置文件：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>➜  ~ <span class=\"token function\">vim</span> /mongodb/sharded_cluster/myshardrs01_27019/mongod.conf</pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>systemLog:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token comment\">#MongoDB 发送所有日志输出的目标指定为文件</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> <span class=\"token comment\">#The path of the log file to which mongod or mongos should send all diagnostic logging information</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre> destination: <span class=\"token function\">file</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> <span class=\"token comment\">#mongod 或 mongos 应向其发送所有诊断日志记录信息的日志文件的路径</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> path: <span class=\"token string\">\"/mongodb/sharded_cluster/myshardrs01_27019/log/mongod.log\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre> <span class=\"token comment\">#当 mongos 或 mongod 实例重新启动时，mongos 或 mongod 会将新条目附加到现有日志文件的末尾。</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre> logAppend: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>storage:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre> <span class=\"token comment\">#mongod 实例存储其数据的目录。storage.dbPath 设置仅适用于 mongod。</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre> <span class=\"token comment\">#The directory where the mongod instance stores its data.Defaul value is \"/data/db\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre> dbPath: <span class=\"token string\">\"/mongodb/sharded_cluster/myshardrs01_27019/data/db\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre> journal:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token comment\">#启用或禁用持久性日志以确保数据文件保持有效和可恢复</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  enabled: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>processManagement:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token comment\">#启用在后台运行 mongos 或 mongod 进程的守护进程模式。</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre> fork: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre> <span class=\"token comment\">#指定用于保存 mongos 或 mongod 进程的进行 ID 的文件位置，其中 mongos 或 mongod 将写入其 PID</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre> pidFilePath: <span class=\"token string\">\"/mongodb/sharded_cluster/myshardrs01_27019/log/mongod.pid\"</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>net:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token comment\">#服务实例绑定 IP，默认是 localhost</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre> bindIp: localhost,192.168.244.142</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token comment\">#bindIp</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token comment\">#绑定的端口，默认是 27017</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre> port: <span class=\"token number\">27019</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>replication:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre> <span class=\"token comment\">#副本集的名称</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre> replSetName: myshardrs</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>sharding:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre> <span class=\"token comment\">#分片角色</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre> clusterRole: configsvr</pre></td></tr></table></figure><p><mark>第二个服务</mark></p>\n<p>新建或修改配置文件：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>➜  ~ <span class=\"token function\">vim</span> /mongodb/sharded_cluster/myshardrs01_27119/mongod.conf</pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>systemLog:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token comment\">#MongoDB 发送所有日志输出的目标指定为文件</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> <span class=\"token comment\">#The path of the log file to which mongod or mongos should send all diagnostic logging information</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre> destination: <span class=\"token function\">file</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> <span class=\"token comment\">#mongod 或 mongos 应向其发送所有诊断日志记录信息的日志文件的路径</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> path: <span class=\"token string\">\"/mongodb/sharded_cluster/myshardrs01_27119/log/mongod.log\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre> <span class=\"token comment\">#当 mongos 或 mongod 实例重新启动时，mongos 或 mongod 会将新条目附加到现有日志文件的末尾。</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre> logAppend: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>storage:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre> <span class=\"token comment\">#mongod 实例存储其数据的目录。storage.dbPath 设置仅适用于 mongod。</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre> <span class=\"token comment\">#The directory where the mongod instance stores its data.Defaul value is \"/data/db\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre> dbPath: <span class=\"token string\">\"/mongodb/sharded_cluster/myshardrs01_27119/data/db\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre> journal:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token comment\">#启用或禁用持久性日志以确保数据文件保持有效和可恢复</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  enabled: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>processManagement:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token comment\">#启用在后台运行 mongos 或 mongod 进程的守护进程模式。</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre> fork: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre> <span class=\"token comment\">#指定用于保存 mongos 或 mongod 进程的进行 ID 的文件位置，其中 mongos 或 mongod 将写入其 PID</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre> pidFilePath: <span class=\"token string\">\"/mongodb/sharded_cluster/myshardrs01_27119/log/mongod.pid\"</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>net:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token comment\">#服务实例绑定 IP，默认是 localhost</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre> bindIp: localhost,192.168.244.142</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token comment\">#bindIp</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token comment\">#绑定的端口，默认是 27017</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre> port: <span class=\"token number\">27119</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>replication:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre> <span class=\"token comment\">#副本集的名称</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre> replSetName: myshardrs</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>sharding:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre> <span class=\"token comment\">#分片角色</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre> clusterRole: configsvr</pre></td></tr></table></figure><p><mark>第三个服务</mark></p>\n<p>新建或修改配置文件：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>➜  ~ <span class=\"token function\">vim</span> /mongodb/sharded_cluster/myshardrs01_27219/mongod.conf</pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>systemLog:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token comment\">#MongoDB 发送所有日志输出的目标指定为文件</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> <span class=\"token comment\">#The path of the log file to which mongod or mongos should send all diagnostic logging information</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre> destination: <span class=\"token function\">file</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> <span class=\"token comment\">#mongod 或 mongos 应向其发送所有诊断日志记录信息的日志文件的路径</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> path: <span class=\"token string\">\"/mongodb/sharded_cluster/myshardrs01_27219/log/mongod.log\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre> <span class=\"token comment\">#当 mongos 或 mongod 实例重新启动时，mongos 或 mongod 会将新条目附加到现有日志文件的末尾。</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre> logAppend: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>storage:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre> <span class=\"token comment\">#mongod 实例存储其数据的目录。storage.dbPath 设置仅适用于 mongod。</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre> <span class=\"token comment\">#The directory where the mongod instance stores its data.Defaul value is \"/data/db\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre> dbPath: <span class=\"token string\">\"/mongodb/sharded_cluster/myshardrs01_27219/data/db\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre> journal:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token comment\">#启用或禁用持久性日志以确保数据文件保持有效和可恢复</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  enabled: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>processManagement:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token comment\">#启用在后台运行 mongos 或 mongod 进程的守护进程模式。</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre> fork: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre> <span class=\"token comment\">#指定用于保存 mongos 或 mongod 进程的进行 ID 的文件位置，其中 mongos 或 mongod 将写入其 PID</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre> pidFilePath: <span class=\"token string\">\"/mongodb/sharded_cluster/myshardrs01_27219/log/mongod.pid\"</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>net:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token comment\">#服务实例绑定 IP，默认是 localhost</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre> bindIp: localhost,192.168.244.142</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token comment\">#bindIp</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token comment\">#绑定的端口，默认是 27017</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre> port: <span class=\"token number\">27219</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>replication:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre> <span class=\"token comment\">#副本集的名称</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre> replSetName: myshardrs</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>sharding:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre> <span class=\"token comment\">#分片角色</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre> clusterRole: configsvr</pre></td></tr></table></figure><p>启动服务：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>➜  ~ /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/sharded_cluster/myshardrs01_27019/mongod.conf </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>about to fork child process, waiting <span class=\"token keyword\">until</span> server is ready <span class=\"token keyword\">for</span> connections.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>forked process: <span class=\"token number\">7659</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>child process started successfully, parent exiting</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>➜  ~ /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/sharded_cluster/myshardrs01_27119/mongod.conf </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>about to fork child process, waiting <span class=\"token keyword\">until</span> server is ready <span class=\"token keyword\">for</span> connections.</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>forked process: <span class=\"token number\">7736</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>child process started successfully, parent exiting</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>➜  ~ /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/sharded_cluster/myshardrs01_27219/mongod.conf </pre></td></tr><tr><td data-num=\"10\"></td><td><pre>about to fork child process, waiting <span class=\"token keyword\">until</span> server is ready <span class=\"token keyword\">for</span> connections.</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>forked process: <span class=\"token number\">7808</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>child process started successfully, parent exiting</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>➜  ~</pre></td></tr></table></figure><p>查看进程：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>➜  ~ <span class=\"token function\">ps</span> -ef<span class=\"token operator\">|</span><span class=\"token function\">grep</span> mongod<span class=\"token operator\">|</span><span class=\"token function\">grep</span> <span class=\"token parameter variable\">-v</span> <span class=\"token function\">grep</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#分片副本集</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>dkx0       <span class=\"token number\">2291</span>      <span class=\"token number\">1</span>  <span class=\"token number\">1</span> <span class=\"token number\">20</span>:57 ?        00:01:36 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/sharded_cluster/myshardrs01_27018/mongod.conf</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>dkx0       <span class=\"token number\">2368</span>      <span class=\"token number\">1</span>  <span class=\"token number\">2</span> <span class=\"token number\">20</span>:57 ?        00:01:55 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/sharded_cluster/myshardrs01_27118/mongod.conf</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>dkx0       <span class=\"token number\">2443</span>      <span class=\"token number\">1</span>  <span class=\"token number\">1</span> <span class=\"token number\">20</span>:57 ?        00:01:40 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/sharded_cluster/myshardrs01_27218/mongod.conf</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>dkx0       <span class=\"token number\">5200</span>      <span class=\"token number\">1</span>  <span class=\"token number\">1</span> <span class=\"token number\">21</span>:42 ?        00:00:48 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/sharded_cluster/myshardrs01_27318/mongod.conf</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>dkx0       <span class=\"token number\">5268</span>      <span class=\"token number\">1</span>  <span class=\"token number\">2</span> <span class=\"token number\">21</span>:42 ?        00:00:49 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/sharded_cluster/myshardrs01_27418/mongod.conf</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>dkx0       <span class=\"token number\">5337</span>      <span class=\"token number\">1</span>  <span class=\"token number\">1</span> <span class=\"token number\">21</span>:43 ?        00:00:38 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/sharded_cluster/myshardrs01_27518/mongod.conf</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">#配置副本集</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>dkx0       <span class=\"token number\">7659</span>      <span class=\"token number\">1</span>  <span class=\"token number\">3</span> <span class=\"token number\">22</span>:19 ?        00:00:08 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/sharded_cluster/myshardrs01_27019/mongod.conf</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>dkx0       <span class=\"token number\">7736</span>      <span class=\"token number\">1</span>  <span class=\"token number\">3</span> <span class=\"token number\">22</span>:19 ?        00:00:07 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/sharded_cluster/myshardrs01_27119/mongod.conf</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>dkx0       <span class=\"token number\">7808</span>      <span class=\"token number\">1</span>  <span class=\"token number\">3</span> <span class=\"token number\">22</span>:19 ?        00:00:07 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/sharded_cluster/myshardrs01_27219/mongod.conf</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>➜  ~</pre></td></tr></table></figure><p>初始化配置服务：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> rs.<span class=\"token function-name function\">initiate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token string\">\"info2\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"no configuration specified. Using a default configuration for the set\"</span>,</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token string\">\"me\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"192.168.244.142:27019\"</span>,</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token string\">\"ok\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token string\">\"<span class=\"token variable\">$gleStats</span>\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\t<span class=\"token string\">\"lastOpTime\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686191196</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t<span class=\"token string\">\"electionId\"</span> <span class=\"token builtin class-name\">:</span> ObjectId<span class=\"token punctuation\">(</span><span class=\"token string\">\"000000000000000000000000\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token string\">\"lastCommittedOpTime\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686191196</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>myshardrs:SECONDARY<span class=\"token operator\">></span> </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>myshardrs:PRIMARY<span class=\"token operator\">></span></pre></td></tr></table></figure><p>添加从节点，配置服务中没有仲载节点：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>myshardrs:PRIMARY<span class=\"token operator\">></span> rs.add<span class=\"token punctuation\">(</span><span class=\"token string\">\"192.168.244.142:27119\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>myshardrs:PRIMARY<span class=\"token operator\">></span> rs.add<span class=\"token punctuation\">(</span><span class=\"token string\">\"192.168.244.142:27219\"</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>查看状态：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>myshardrs:PRIMARY<span class=\"token operator\">></span> rs.<span class=\"token function-name function\">conf</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"myshardrs\"</span>,</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token string\">\"version\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">5</span>,</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token string\">\"term\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token string\">\"members\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t\t<span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>,</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t\t<span class=\"token string\">\"host\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"192.168.244.142:27019\"</span>,</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t\t<span class=\"token string\">\"arbiterOnly\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\t\t<span class=\"token string\">\"buildIndexes\"</span> <span class=\"token builtin class-name\">:</span> true,</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t\t<span class=\"token string\">\"hidden\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t\t<span class=\"token string\">\"priority\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t\t<span class=\"token string\">\"tags\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t\t\t</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t\t<span class=\"token string\">\"secondaryDelaySecs\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t\t<span class=\"token string\">\"votes\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t\t<span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\t\t<span class=\"token string\">\"host\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"192.168.244.142:27119\"</span>,</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t\t<span class=\"token string\">\"arbiterOnly\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t\t<span class=\"token string\">\"buildIndexes\"</span> <span class=\"token builtin class-name\">:</span> true,</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t\t<span class=\"token string\">\"hidden\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t\t<span class=\"token string\">\"priority\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t\t<span class=\"token string\">\"tags\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t\t\t</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t\t<span class=\"token string\">\"secondaryDelaySecs\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t\t<span class=\"token string\">\"votes\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t\t<span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span>,</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t\t<span class=\"token string\">\"host\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"192.168.244.142:27219\"</span>,</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\t\t<span class=\"token string\">\"arbiterOnly\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\t\t<span class=\"token string\">\"buildIndexes\"</span> <span class=\"token builtin class-name\">:</span> true,</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\t\t<span class=\"token string\">\"hidden\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\t\t<span class=\"token string\">\"priority\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\t\t<span class=\"token string\">\"tags\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\t\t\t</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\t\t<span class=\"token string\">\"secondaryDelaySecs\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t\t\t<span class=\"token string\">\"votes\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t<span class=\"token punctuation\">]</span>,</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t<span class=\"token string\">\"configsvr\"</span> <span class=\"token builtin class-name\">:</span> true,</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t<span class=\"token string\">\"protocolVersion\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t<span class=\"token string\">\"writeConcernMajorityJournalDefault\"</span> <span class=\"token builtin class-name\">:</span> true,</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t<span class=\"token string\">\"settings\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t\t<span class=\"token string\">\"chainingAllowed\"</span> <span class=\"token builtin class-name\">:</span> true,</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t\t<span class=\"token string\">\"heartbeatIntervalMillis\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2000</span>,</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t\t<span class=\"token string\">\"heartbeatTimeoutSecs\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">10</span>,</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t\t<span class=\"token string\">\"electionTimeoutMillis\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">10000</span>,</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t\t<span class=\"token string\">\"catchUpTimeoutMillis\"</span> <span class=\"token builtin class-name\">:</span> -1,</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t\t<span class=\"token string\">\"catchUpTakeoverDelayMillis\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">30000</span>,</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t\t<span class=\"token string\">\"getLastErrorModes\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t\t\t</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t\t<span class=\"token string\">\"getLastErrorDefaults\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\t\t\t<span class=\"token string\">\"w\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t\t\t<span class=\"token string\">\"wtimeout\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t\t<span class=\"token string\">\"replicaSetId\"</span> <span class=\"token builtin class-name\">:</span> ObjectId<span class=\"token punctuation\">(</span><span class=\"token string\">\"64813c5c4c6469e9d2fe9264\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>myshardrs:PRIMARY<span class=\"token operator\">></span></pre></td></tr></table></figure><p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031700512.png\" alt=\"image-20230608102950142\"></p>\n<p>配置服务搭建完成！</p>\n<p>分片和配置副本集服务都搭建完成了下面搭建路由节点服务，注意它使用的不是 mongod 服务了而是 mongos 服务</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031700137.png\" alt=\"image-20230608103603425\"></p>\n<h3 id=\"路由节点的创建和操作\"><a class=\"markdownIt-Anchor\" href=\"#路由节点的创建和操作\">#</a> 路由节点的创建和操作</h3>\n<h4 id=\"第一个路由节点的创建和连接\"><a class=\"markdownIt-Anchor\" href=\"#第一个路由节点的创建和连接\">#</a> 第一个路由节点的创建和连接</h4>\n<p>路由的主要作用就是分发不会存储具体的数据，所以不需要 data 目录</p>\n<p>创建存放数据和日志的目录：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>➜ ~ <span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /mongodb/sharded_cluster/myshardrs_27017/log</pre></td></tr></table></figure><p>新建或修改配置文件：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>➜  ~ <span class=\"token function\">vim</span> /mongodb/sharded_cluster/myshardrs_27017/mongos.conf</pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>systemLog:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token comment\">#MongoDB 发送所有日志输出的目标指定为文件</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> <span class=\"token comment\">#The path of the log file to which mongod or mongos should send all diagnostic logging information</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre> destination: <span class=\"token function\">file</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> <span class=\"token comment\">#mongod 或 mongos 应向其发送所有诊断日志记录信息的日志文件的路径</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> path: <span class=\"token string\">\"/mongodb/sharded_cluster/myshardrs_27017/log/mongod.log\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre> <span class=\"token comment\">#当 mongos 或 mongod 实例重新启动时，mongos 或 mongod 会将新条目附加到现有日志文件的末尾。</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre> logAppend: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>processManagement:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token comment\">#启用在后台运行 mongos 或 mongod 进程的守护进程模式。</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre> fork: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre> <span class=\"token comment\">#指定用于保存 mongos 或 mongod 进程的进行 ID 的文件位置，其中 mongos 或 mongod 将写入其 PID</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre> pidFilePath: <span class=\"token string\">\"/mongodb/sharded_cluster/myshardrs_27017/log/mongod.pid\"</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>net:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token comment\">#服务实例绑定 IP，默认是 localhost</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre> bindIp: localhost,192.168.244.142</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token comment\">#bindIp</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token comment\">#绑定的端口，默认是 27017</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre> port: <span class=\"token number\">27017</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>sharding:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre> <span class=\"token comment\">#指定配置节点副本集</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre> <span class=\"token comment\">#        副本集名称 / 主机地址与端口号</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre> configDB: myconfigrs/192.168.244.142:27019,192.168.244.142:27119,192.168.244.142:27219</pre></td></tr></table></figure><p>启动服务：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>➜  ~ /usr/local/mongodb/bin/mongos <span class=\"token parameter variable\">-f</span> /mongodb/sharded_cluster/myshardrs_27017/mongos.conf </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>about to fork child process, waiting <span class=\"token keyword\">until</span> server is ready <span class=\"token keyword\">for</span> connections.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>forked process: <span class=\"token number\">10092</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>child process started successfully, parent exiting</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>➜  ~</pre></td></tr></table></figure><p>查看进程：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#分片副本集</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>➜  ~ <span class=\"token function\">ps</span> -ef<span class=\"token operator\">|</span><span class=\"token function\">grep</span> mongod<span class=\"token operator\">|</span><span class=\"token function\">grep</span> <span class=\"token parameter variable\">-v</span> <span class=\"token function\">grep</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>dkx0       <span class=\"token number\">2291</span>      <span class=\"token number\">1</span>  <span class=\"token number\">1</span> <span class=\"token number\">20</span>:57 ?        00:02:07 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/sharded_cluster/myshardrs01_27018/mongod.conf</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>dkx0       <span class=\"token number\">2368</span>      <span class=\"token number\">1</span>  <span class=\"token number\">2</span> <span class=\"token number\">20</span>:57 ?        00:02:26 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/sharded_cluster/myshardrs01_27118/mongod.conf</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>dkx0       <span class=\"token number\">2443</span>      <span class=\"token number\">1</span>  <span class=\"token number\">1</span> <span class=\"token number\">20</span>:57 ?        00:02:02 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/sharded_cluster/myshardrs01_27218/mongod.conf</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>dkx0       <span class=\"token number\">5200</span>      <span class=\"token number\">1</span>  <span class=\"token number\">1</span> <span class=\"token number\">21</span>:42 ?        00:01:19 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/sharded_cluster/myshardrs01_27318/mongod.conf</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>dkx0       <span class=\"token number\">5268</span>      <span class=\"token number\">1</span>  <span class=\"token number\">1</span> <span class=\"token number\">21</span>:42 ?        00:01:19 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/sharded_cluster/myshardrs01_27418/mongod.conf</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>dkx0       <span class=\"token number\">5337</span>      <span class=\"token number\">1</span>  <span class=\"token number\">1</span> <span class=\"token number\">21</span>:43 ?        00:01:00 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/sharded_cluster/myshardrs01_27518/mongod.conf</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">#配置服务副本集</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>dkx0       <span class=\"token number\">7659</span>      <span class=\"token number\">1</span>  <span class=\"token number\">2</span> <span class=\"token number\">22</span>:19 ?        00:00:53 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/sharded_cluster/myshardrs01_27019/mongod.conf</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>dkx0       <span class=\"token number\">7736</span>      <span class=\"token number\">1</span>  <span class=\"token number\">2</span> <span class=\"token number\">22</span>:19 ?        00:00:54 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/sharded_cluster/myshardrs01_27119/mongod.conf</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>dkx0       <span class=\"token number\">7808</span>      <span class=\"token number\">1</span>  <span class=\"token number\">2</span> <span class=\"token number\">22</span>:19 ?        00:00:53 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/sharded_cluster/myshardrs01_27219/mongod.conf</pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">#路由副本集</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>dkx0      <span class=\"token number\">10092</span>      <span class=\"token number\">1</span>  <span class=\"token number\">0</span> <span class=\"token number\">22</span>:53 ?        00:00:00 /usr/local/mongodb/bin/mongos <span class=\"token parameter variable\">-f</span> /mongodb/sharded_cluster/myshardrs_27017/mongos.conf</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>➜  ~</pre></td></tr></table></figure><p>连接客户端：还是同样的操作，但是命令符提示为：mongos</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>➜  ~ /usr/local/mongodb/bin/mongo <span class=\"token parameter variable\">--host</span><span class=\"token operator\">=</span><span class=\"token number\">192.168</span>.244.142 <span class=\"token parameter variable\">--port</span><span class=\"token operator\">=</span><span class=\"token number\">27017</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>MongoDB shell version v5.0.18</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>connecting to: mongodb://192.168.244.142:27017/?compressors<span class=\"token operator\">=</span>disabled<span class=\"token operator\">&amp;</span><span class=\"token assign-left variable\">gssapiServiceName</span><span class=\"token operator\">=</span>mongodb</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Implicit session: session <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"id\"</span> <span class=\"token builtin class-name\">:</span> UUID<span class=\"token punctuation\">(</span><span class=\"token string\">\"f9216227-99d6-4270-bb3e-b47ab59e205b\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>MongoDB server version: <span class=\"token number\">5.0</span>.18</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>Warning: the <span class=\"token string\">\"mongo\"</span> shell has been superseded by <span class=\"token string\">\"mongosh\"</span>,</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token function\">which</span> delivers improved usability and compatibility.The <span class=\"token string\">\"mongo\"</span> shell has been deprecated and will be removed <span class=\"token keyword\">in</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>an upcoming release.</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>For installation instructions, see</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>https://docs.mongodb.com/mongodb-shell/install/</pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>The server generated these startup warnings when booting: </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token number\">2023</span>-06-07T22:53:18.509-04:00: Access control is not enabled <span class=\"token keyword\">for</span> the database. Read and <span class=\"token function\">write</span> access to data and configuration is unrestricted</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>mongos<span class=\"token operator\">></span></pre></td></tr></table></figure><p>此时，能查看数据库，但是不能写入数据否则报错：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>mongos<span class=\"token operator\">></span> show dbs</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>admin   <span class=\"token number\">0</span>.000GB</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>config  <span class=\"token number\">0</span>.000GB</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>mongos<span class=\"token operator\">></span> use aabb</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>switched to db aabb</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>mongos<span class=\"token operator\">></span> db</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>aabb</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>mongos<span class=\"token operator\">></span> db.aa.insert<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"name\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"刘桑\"</span>,<span class=\"token string\">\"age\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"22\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>WriteCommandError<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token string\">\"ok\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>,</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token string\">\"errmsg\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"Database aabb could not be created :: caused by :: No shards found\"</span>,</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token string\">\"code\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">70</span>,</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token string\">\"codeName\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"ShardNotFound\"</span>,</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token string\">\"<span class=\"token variable\">$clusterTime</span>\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t<span class=\"token string\">\"clusterTime\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686193139</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t<span class=\"token string\">\"signature\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t\t<span class=\"token string\">\"hash\"</span> <span class=\"token builtin class-name\">:</span> BinData<span class=\"token punctuation\">(</span><span class=\"token number\">0</span>,<span class=\"token string\">\"AAAAAAAAAAAAAAAAAAAAAAAAAAA=\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t\t<span class=\"token string\">\"keyId\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token string\">\"operationTime\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686193139</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>mongos<span class=\"token operator\">></span></pre></td></tr></table></figure><p>报错信息：Database aabb could not be created :: caused by :: No shards found</p>\n<p>翻译：无法创建数据库 aabb ：： 由 ：： 未找到分片</p>\n<p>解释：</p>\n<blockquote>\n<p>我们新建路由节点的时候配置文件中只指定了配置服务副本集如下：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>sharding:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token comment\">#指定配置节点副本集</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> <span class=\"token comment\">#        副本集名称 / 主机地址与端口号</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre> configDB: myconfigrs/192.168.244.142:27019,192.168.244.142:27119,192.168.244.142:27219</pre></td></tr></table></figure><p>mongos 启动的时候指定了副本集代表路由和配置服务是联通的，但是没有分片不能存储数据，因为最终存储数据是分片</p>\n</blockquote>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031700965.png\" alt=\"image-20230608110542590\"></p>\n<h4 id=\"在路由节点上进行分片配置操作\"><a class=\"markdownIt-Anchor\" href=\"#在路由节点上进行分片配置操作\">#</a> 在路由节点上进行分片配置操作</h4>\n<p>使用命令添加分片：</p>\n<p>1. 添加分片：</p>\n<p>语法：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>sh.addShard<span class=\"token punctuation\">(</span><span class=\"token string\">\"IP:Port\"</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>将第一套分片副本集添加进来：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>mongos<span class=\"token operator\">></span> sh.addShard<span class=\"token punctuation\">(</span><span class=\"token string\">\"myshardrs01/192.168.244.142:27018,192.168.244.142:27118,192.168.244.142:27218\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token string\">\"shardAdded\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"myshardrs01\"</span>,</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token string\">\"ok\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token string\">\"<span class=\"token variable\">$clusterTime</span>\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t<span class=\"token string\">\"clusterTime\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686193852</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\t<span class=\"token string\">\"signature\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t\t<span class=\"token string\">\"hash\"</span> <span class=\"token builtin class-name\">:</span> BinData<span class=\"token punctuation\">(</span><span class=\"token number\">0</span>,<span class=\"token string\">\"AAAAAAAAAAAAAAAAAAAAAAAAAAA=\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t\t<span class=\"token string\">\"keyId\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token string\">\"operationTime\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686193852</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>mongos<span class=\"token operator\">></span></pre></td></tr></table></figure><p>继续将第二套分片副本集添加进来：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>mongos<span class=\"token operator\">></span> sh.addShard<span class=\"token punctuation\">(</span><span class=\"token string\">\"myshardrs02/192.168.244.142:27318,192.168.244.142:27418,192.168.244.142:27518\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token string\">\"shardAdded\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"myshardrs02\"</span>,</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token string\">\"ok\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token string\">\"<span class=\"token variable\">$clusterTime</span>\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t<span class=\"token string\">\"clusterTime\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686194172</span>, <span class=\"token number\">3</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\t<span class=\"token string\">\"signature\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t\t<span class=\"token string\">\"hash\"</span> <span class=\"token builtin class-name\">:</span> BinData<span class=\"token punctuation\">(</span><span class=\"token number\">0</span>,<span class=\"token string\">\"AAAAAAAAAAAAAAAAAAAAAAAAAAA=\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t\t<span class=\"token string\">\"keyId\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token string\">\"operationTime\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686194172</span>, <span class=\"token number\">3</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>mongos<span class=\"token operator\">></span></pre></td></tr></table></figure><p>查看状态：可以看到 shards 中有两个分片副本集了</p>\n<p>“host” : “myshardrs01/192.168.244.142:27018,192.168.244.142:27118” 没有把仲载节点加进来</p>\n<p>因为仲载不存储数据所以分片的时候没必要知道它，但是使用 sh.addShard 的时候还是必须带上的</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>mongos<span class=\"token operator\">></span> sh.status<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>--- Sharding Status --- </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  sharding version: <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  \t<span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  \t<span class=\"token string\">\"minCompatibleVersion\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">5</span>,</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  \t<span class=\"token string\">\"currentVersion\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">6</span>,</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  \t<span class=\"token string\">\"clusterId\"</span> <span class=\"token builtin class-name\">:</span> ObjectId<span class=\"token punctuation\">(</span><span class=\"token string\">\"64813c5c4c6469e9d2fe9269\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  shards:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span>  <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"myshardrs01\"</span>,  <span class=\"token string\">\"host\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"myshardrs01/192.168.244.142:27018,192.168.244.142:27118\"</span>,  <span class=\"token string\">\"state\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,  <span class=\"token string\">\"topologyTime\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686193851</span>, <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span>  <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"myshardrs02\"</span>,  <span class=\"token string\">\"host\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"myshardrs02/192.168.244.142:27318,192.168.244.142:27418\"</span>,  <span class=\"token string\">\"state\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,  <span class=\"token string\">\"topologyTime\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686194172</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  active mongoses:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token string\">\"5.0.18\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  autosplit:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        Currently enabled: <span class=\"token function\">yes</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  balancer:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        Currently enabled: <span class=\"token function\">yes</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        Currently running: <span class=\"token function\">yes</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        Failed balancer rounds <span class=\"token keyword\">in</span> last <span class=\"token number\">5</span> attempts: <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        Migration results <span class=\"token keyword\">for</span> the last <span class=\"token number\">24</span> hours: </pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                <span class=\"token number\">55</span> <span class=\"token builtin class-name\">:</span> Success</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  databases:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span>  <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"articledb\"</span>,  <span class=\"token string\">\"primary\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"myshardrs01\"</span>,  <span class=\"token string\">\"partitioned\"</span> <span class=\"token builtin class-name\">:</span> false,  <span class=\"token string\">\"version\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span>  <span class=\"token string\">\"uuid\"</span> <span class=\"token builtin class-name\">:</span> UUID<span class=\"token punctuation\">(</span><span class=\"token string\">\"b94e53c7-d498-49b8-8965-1aafcab2df18\"</span><span class=\"token punctuation\">)</span>,  <span class=\"token string\">\"timestamp\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686193851</span>, <span class=\"token number\">3</span><span class=\"token punctuation\">)</span>,  <span class=\"token string\">\"lastMod\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span>  <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"config\"</span>,  <span class=\"token string\">\"primary\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"config\"</span>,  <span class=\"token string\">\"partitioned\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                config.system.sessions</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                        shard key: <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                        unique: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                        balancing: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                        chunks:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                                myshardrs01\t<span class=\"token number\">969</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                                myshardrs02\t<span class=\"token number\">55</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                        too many chunks to print, use verbose <span class=\"token keyword\">if</span> you want to force print</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>mongos<span class=\"token operator\">></span></pre></td></tr></table></figure><p>提示：</p>\n<p>如果添加分片失败，需要先手动移除分片，检查添加分片的信息正确性后，再次添加分片</p>\n<p>移除分片参考：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>use admin</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>db.runcommand<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>removeShard:<span class=\"token string\">\"myshardrs02\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>注意： 如果只剩下最后一个 shard，是无法删除的</p>\n<p>移除时会自动转移分片数据，需要一个时间过程</p>\n<p>完成后，再次执行删除分片命令才能真正删除</p>\n<p>2. 开启分片功能：sh.enableSharding (“库名”)，sh.shardCollection (“库名。集合名”,{“key”:1}&quot;)</p>\n<p>在 mongos 上的 articledb 数据库配置 sharding:</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>mongos<span class=\"token operator\">></span> sh.enableSharding<span class=\"token punctuation\">(</span><span class=\"token string\">\"articledb\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token string\">\"ok\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token string\">\"<span class=\"token variable\">$clusterTime</span>\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\t<span class=\"token string\">\"clusterTime\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686194695</span>, <span class=\"token number\">38</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t<span class=\"token string\">\"signature\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\t\t<span class=\"token string\">\"hash\"</span> <span class=\"token builtin class-name\">:</span> BinData<span class=\"token punctuation\">(</span><span class=\"token number\">0</span>,<span class=\"token string\">\"AAAAAAAAAAAAAAAAAAAAAAAAAAA=\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t\t<span class=\"token string\">\"keyId\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token string\">\"operationTime\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686194695</span>, <span class=\"token number\">38</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>mongos<span class=\"token operator\">></span></pre></td></tr></table></figure><p>查看分片状态：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>mongos<span class=\"token operator\">></span> sh.status<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>--- Sharding Status --- </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  sharding version: <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  \t<span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  \t<span class=\"token string\">\"minCompatibleVersion\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">5</span>,</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  \t<span class=\"token string\">\"currentVersion\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">6</span>,</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  \t<span class=\"token string\">\"clusterId\"</span> <span class=\"token builtin class-name\">:</span> ObjectId<span class=\"token punctuation\">(</span><span class=\"token string\">\"64813c5c4c6469e9d2fe9269\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  shards:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span>  <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"myshardrs01\"</span>,  <span class=\"token string\">\"host\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"myshardrs01/192.168.244.142:27018,192.168.244.142:27118\"</span>,  <span class=\"token string\">\"state\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,  <span class=\"token string\">\"topologyTime\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686193851</span>, <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span>  <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"myshardrs02\"</span>,  <span class=\"token string\">\"host\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"myshardrs02/192.168.244.142:27318,192.168.244.142:27418\"</span>,  <span class=\"token string\">\"state\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,  <span class=\"token string\">\"topologyTime\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686194172</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  active mongoses:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token string\">\"5.0.18\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  autosplit:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        Currently enabled: <span class=\"token function\">yes</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  balancer:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        Currently enabled: <span class=\"token function\">yes</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        Currently running: no</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        Failed balancer rounds <span class=\"token keyword\">in</span> last <span class=\"token number\">5</span> attempts: <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        Migration results <span class=\"token keyword\">for</span> the last <span class=\"token number\">24</span> hours: </pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                <span class=\"token number\">480</span> <span class=\"token builtin class-name\">:</span> Success</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  databases:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span>  <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"articledb\"</span>,  <span class=\"token string\">\"primary\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"myshardrs01\"</span>,  <span class=\"token string\">\"partitioned\"</span> <span class=\"token builtin class-name\">:</span> true,  <span class=\"token string\">\"version\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span>  <span class=\"token string\">\"uuid\"</span> <span class=\"token builtin class-name\">:</span> UUID<span class=\"token punctuation\">(</span><span class=\"token string\">\"b94e53c7-d498-49b8-8965-1aafcab2df18\"</span><span class=\"token punctuation\">)</span>,  <span class=\"token string\">\"timestamp\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686193851</span>, <span class=\"token number\">3</span><span class=\"token punctuation\">)</span>,  <span class=\"token string\">\"lastMod\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span>  <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"config\"</span>,  <span class=\"token string\">\"primary\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"config\"</span>,  <span class=\"token string\">\"partitioned\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                config.system.sessions</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                        shard key: <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                        unique: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                        balancing: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                        chunks:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                                myshardrs01\t<span class=\"token number\">544</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                                myshardrs02\t<span class=\"token number\">480</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                        too many chunks to print, use verbose <span class=\"token keyword\">if</span> you want to force print</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>mongos<span class=\"token operator\">></span></pre></td></tr></table></figure><p>3. 集合分片</p>\n<p>对集合分片，你必须使用 sh.shardCollection () 方法指定集合的分片键。</p>\n<p>语法：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>sh.shardCollection<span class=\"token punctuation\">(</span>namespace,key,unique<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>参数：</p>\n<table>\n<thead>\n<tr>\n<th>Parameter</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>namespace</td>\n<td>string</td>\n<td>要 (分片) 共享的目标集合的命名空间，格式：<database>.<collection></td>\n</tr>\n<tr>\n<td>key</td>\n<td>document</td>\n<td>用作分片键的索引规范文档，shard 键决定 MongoDB 如何在 shard 之间分发文档，除非集合为空，否则索引必须在 shard collection 命令之前存在，如果集合为空，则 MongoDB 在对集合进行分片之前创建索引，前提是支持分片键的索引不存在，简单的说：由包含字段和该字段的索引遍历方向的文档组成</td>\n</tr>\n<tr>\n<td>unique</td>\n<td>boolean</td>\n<td>当值为 true 情况下，片键字段上会限制为确保是唯一索引，哈希策略片键不支持唯一索引，默认是 false</td>\n</tr>\n</tbody>\n</table>\n<p>对集合进行分片时，你需要选择一个片键 (Shard key),shard key 是每条记录都必须包含的，且建立了索引的单个字段或复合字段，MongoDB 按照片键将数据划分到不同的数据块中，并将数据块 均衡的分不到所有分片中，为了按照片键划分数据库 MongoDB 使用基于哈希的分片方式 (随机平均分配) 或者基于范围的分片方式 (数值大小分配)</p>\n<p>用什么字段当片键都可以，如：nickname 作为片键，但一定是必填字段</p>\n<p><mark>注意</mark>：MongoDB 只能通过一个字段给某个集合分片不能说一个集合即按哈希有按范围分片</p>\n<p>分片规则一：哈希策略</p>\n<p>对于基于哈希的分片，MongoDB 计算一个字段的哈希值，并用这个哈希值来创建数据块</p>\n<p>在使用基于哈希分片的系统中，拥有 &quot;相近&quot; 片键的文档，很可能不会存储在同一个数据块中，因此数据的分离性更好一些。</p>\n<p>使用 nickname 作为片键，根据其值的哈希值进行数据分片</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>mongos<span class=\"token operator\">></span> sh.shardCollection<span class=\"token punctuation\">(</span><span class=\"token string\">\"articledb.comment\"</span>,<span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"nickname\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"hashed\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token string\">\"collectionsharded\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"articledb.comment\"</span>,</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token string\">\"ok\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token string\">\"<span class=\"token variable\">$clusterTime</span>\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t<span class=\"token string\">\"clusterTime\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686196321</span>, <span class=\"token number\">36</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\t<span class=\"token string\">\"signature\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t\t<span class=\"token string\">\"hash\"</span> <span class=\"token builtin class-name\">:</span> BinData<span class=\"token punctuation\">(</span><span class=\"token number\">0</span>,<span class=\"token string\">\"AAAAAAAAAAAAAAAAAAAAAAAAAAA=\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t\t<span class=\"token string\">\"keyId\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token string\">\"operationTime\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686196321</span>, <span class=\"token number\">32</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>mongos<span class=\"token operator\">></span></pre></td></tr></table></figure><p>查看状态：</p>\n<p>shard key: {“nickname” : “hashed” } 分片策略哈希</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>mongos<span class=\"token operator\">></span> sh.status<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>--- Sharding Status --- </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  sharding version: <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  \t<span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  \t<span class=\"token string\">\"minCompatibleVersion\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">5</span>,</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  \t<span class=\"token string\">\"currentVersion\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">6</span>,</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  \t<span class=\"token string\">\"clusterId\"</span> <span class=\"token builtin class-name\">:</span> ObjectId<span class=\"token punctuation\">(</span><span class=\"token string\">\"64813c5c4c6469e9d2fe9269\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  shards:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span>  <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"myshardrs01\"</span>,  <span class=\"token string\">\"host\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"myshardrs01/192.168.244.142:27018,192.168.244.142:27118\"</span>,  <span class=\"token string\">\"state\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,  <span class=\"token string\">\"topologyTime\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686193851</span>, <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span>  <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"myshardrs02\"</span>,  <span class=\"token string\">\"host\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"myshardrs02/192.168.244.142:27318,192.168.244.142:27418\"</span>,  <span class=\"token string\">\"state\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,  <span class=\"token string\">\"topologyTime\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686194172</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  active mongoses:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token string\">\"5.0.18\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  autosplit:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        Currently enabled: <span class=\"token function\">yes</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  balancer:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        Currently enabled: <span class=\"token function\">yes</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        Currently running: no</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        Failed balancer rounds <span class=\"token keyword\">in</span> last <span class=\"token number\">5</span> attempts: <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        Migration results <span class=\"token keyword\">for</span> the last <span class=\"token number\">24</span> hours: </pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                <span class=\"token number\">512</span> <span class=\"token builtin class-name\">:</span> Success</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  databases:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span>  <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"articledb\"</span>,  <span class=\"token string\">\"primary\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"myshardrs01\"</span>,  <span class=\"token string\">\"partitioned\"</span> <span class=\"token builtin class-name\">:</span> true,  <span class=\"token string\">\"version\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span>  <span class=\"token string\">\"uuid\"</span> <span class=\"token builtin class-name\">:</span> UUID<span class=\"token punctuation\">(</span><span class=\"token string\">\"b94e53c7-d498-49b8-8965-1aafcab2df18\"</span><span class=\"token punctuation\">)</span>,  <span class=\"token string\">\"timestamp\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686193851</span>, <span class=\"token number\">3</span><span class=\"token punctuation\">)</span>,  <span class=\"token string\">\"lastMod\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                articledb.comment</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                        shard key: <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"hashed\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                        unique: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                        balancing: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                        chunks:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                                myshardrs01\t<span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                                myshardrs02\t<span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                        <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"<span class=\"token variable\">$minKey</span>\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span> --<span class=\"token operator\">>></span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token string\">\"-4611686018427387902\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span> on <span class=\"token builtin class-name\">:</span> myshardrs01 Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                        <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token string\">\"-4611686018427387902\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span> --<span class=\"token operator\">>></span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span> on <span class=\"token builtin class-name\">:</span> myshardrs01 Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                        <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span> --<span class=\"token operator\">>></span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token string\">\"4611686018427387902\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span> on <span class=\"token builtin class-name\">:</span> myshardrs02 Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                        <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token string\">\"4611686018427387902\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span> --<span class=\"token operator\">>></span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"<span class=\"token variable\">$maxKey</span>\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span> on <span class=\"token builtin class-name\">:</span> myshardrs02 Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">3</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span>  <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"config\"</span>,  <span class=\"token string\">\"primary\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"config\"</span>,  <span class=\"token string\">\"partitioned\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                config.system.sessions</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                        shard key: <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>                        unique: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>                        balancing: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                        chunks:</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>                                myshardrs01\t<span class=\"token number\">512</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>                                myshardrs02\t<span class=\"token number\">512</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>                        too many chunks to print, use verbose <span class=\"token keyword\">if</span> you want to force print</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>mongos<span class=\"token operator\">></span></pre></td></tr></table></figure><p>提示：</p>\n<p>报错：please create an index that starts with the shard key before sharding</p>\n<p>解决方式：判断分支是查找是否有可用的索引存在，当无可用的索引，并且表不为空时，就会出现这个错误信息。</p>\n<p>分片规则二：值范围策略</p>\n<p>对于基于范围的分片，MongoDB 按照片键的范围把数据分成不同部分，假设有一个数字的片键：想象一个从负无穷到正无穷的直线，每一个片键的值都在直线上画了一个点。MongoDB 把这条直线划分为更短的不重叠的片段，并称之为数据块，每个数据块包含了片键在一定范围内的数据。</p>\n<p>在使用片键做范围划分的系统中，拥有 &quot;相近&quot; 片键的文档很可能存储在同一个数据块中，因此也会存储在同一个分片中。</p>\n<p>如果使用作者年龄字段作为片键，按照点赞数的值进行分片：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>mongos<span class=\"token operator\">></span> sh.shardCollection<span class=\"token punctuation\">(</span><span class=\"token string\">\"articledb.author\"</span>,<span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"age\"</span>:1<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token string\">\"collectionsharded\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"articledb.author\"</span>,</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token string\">\"ok\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token string\">\"<span class=\"token variable\">$clusterTime</span>\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t<span class=\"token string\">\"clusterTime\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686196802</span>, <span class=\"token number\">6</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\t<span class=\"token string\">\"signature\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t\t<span class=\"token string\">\"hash\"</span> <span class=\"token builtin class-name\">:</span> BinData<span class=\"token punctuation\">(</span><span class=\"token number\">0</span>,<span class=\"token string\">\"AAAAAAAAAAAAAAAAAAAAAAAAAAA=\"</span><span class=\"token punctuation\">)</span>,</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t\t<span class=\"token string\">\"keyId\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token string\">\"operationTime\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686196802</span>, <span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>mongos<span class=\"token operator\">></span></pre></td></tr></table></figure><p>查看状态：</p>\n<p age:1=\"\">shard key:</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>mongos<span class=\"token operator\">></span> sh.status<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>--- Sharding Status --- </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  sharding version: <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  \t<span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  \t<span class=\"token string\">\"minCompatibleVersion\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">5</span>,</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  \t<span class=\"token string\">\"currentVersion\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">6</span>,</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  \t<span class=\"token string\">\"clusterId\"</span> <span class=\"token builtin class-name\">:</span> ObjectId<span class=\"token punctuation\">(</span><span class=\"token string\">\"64813c5c4c6469e9d2fe9269\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  shards:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span>  <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"myshardrs01\"</span>,  <span class=\"token string\">\"host\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"myshardrs01/192.168.244.142:27018,192.168.244.142:27118\"</span>,  <span class=\"token string\">\"state\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,  <span class=\"token string\">\"topologyTime\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686193851</span>, <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span>  <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"myshardrs02\"</span>,  <span class=\"token string\">\"host\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"myshardrs02/192.168.244.142:27318,192.168.244.142:27418\"</span>,  <span class=\"token string\">\"state\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,  <span class=\"token string\">\"topologyTime\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686194172</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  active mongoses:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token string\">\"5.0.18\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  autosplit:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        Currently enabled: <span class=\"token function\">yes</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  balancer:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        Currently enabled: <span class=\"token function\">yes</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        Currently running: no</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        Failed balancer rounds <span class=\"token keyword\">in</span> last <span class=\"token number\">5</span> attempts: <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        Migration results <span class=\"token keyword\">for</span> the last <span class=\"token number\">24</span> hours: </pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                <span class=\"token number\">512</span> <span class=\"token builtin class-name\">:</span> Success</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  databases:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span>  <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"articledb\"</span>,  <span class=\"token string\">\"primary\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"myshardrs01\"</span>,  <span class=\"token string\">\"partitioned\"</span> <span class=\"token builtin class-name\">:</span> true,  <span class=\"token string\">\"version\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span>  <span class=\"token string\">\"uuid\"</span> <span class=\"token builtin class-name\">:</span> UUID<span class=\"token punctuation\">(</span><span class=\"token string\">\"b94e53c7-d498-49b8-8965-1aafcab2df18\"</span><span class=\"token punctuation\">)</span>,  <span class=\"token string\">\"timestamp\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686193851</span>, <span class=\"token number\">3</span><span class=\"token punctuation\">)</span>,  <span class=\"token string\">\"lastMod\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                articledb.author</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                        shard key: <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"age\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                        unique: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                        balancing: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                        chunks:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                                myshardrs01\t<span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                        <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"age\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"<span class=\"token variable\">$minKey</span>\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span> --<span class=\"token operator\">>></span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"age\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"<span class=\"token variable\">$maxKey</span>\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span> on <span class=\"token builtin class-name\">:</span> myshardrs01 Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                articledb.comment</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                        shard key: <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"hashed\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                        unique: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                        balancing: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                        chunks:</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                                myshardrs01\t<span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                                myshardrs02\t<span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>                        <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"<span class=\"token variable\">$minKey</span>\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span> --<span class=\"token operator\">>></span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token string\">\"-4611686018427387902\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span> on <span class=\"token builtin class-name\">:</span> myshardrs01 Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"39\"></td><td><pre>                        <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token string\">\"-4611686018427387902\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span> --<span class=\"token operator\">>></span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span> on <span class=\"token builtin class-name\">:</span> myshardrs01 Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                        <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span> --<span class=\"token operator\">>></span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token string\">\"4611686018427387902\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span> on <span class=\"token builtin class-name\">:</span> myshardrs02 Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"41\"></td><td><pre>                        <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token string\">\"4611686018427387902\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span> --<span class=\"token operator\">>></span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"<span class=\"token variable\">$maxKey</span>\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span> on <span class=\"token builtin class-name\">:</span> myshardrs02 Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">3</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span>  <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"config\"</span>,  <span class=\"token string\">\"primary\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"config\"</span>,  <span class=\"token string\">\"partitioned\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>                config.system.sessions</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>                        shard key: <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                        unique: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                        balancing: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>                        chunks:</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>                                myshardrs01\t<span class=\"token number\">512</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>                                myshardrs02\t<span class=\"token number\">512</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>                        too many chunks to print, use verbose <span class=\"token keyword\">if</span> you want to force print</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>mongos<span class=\"token operator\">></span></pre></td></tr></table></figure><p>注意的是：</p>\n<ol>\n<li>一个集合只能指定一个片键，否则报错</li>\n<li>一旦对一个集合分片，分片键和分片值就不可改变，如：不能给集合选择不同的分片键，不能更新分片键的值</li>\n<li>根据 age 索引进行分配数据</li>\n</ol>\n<p>基于范围的分片方式与基于哈希的分片方式性能对比：</p>\n<p>基于范围的分片方式提供了更高效的范围查询，给定一个片键的范围，分发路由可以很简单的确定哪个数据块存储了请求需要的数据，并将请求转发到相应的分片中</p>\n<p>不过，基于范围的分片会导致数据在不同分片上的不均衡，有时候，带来的消极作用会大于查询性能的积极作用，比如，如果片键所在的字段是线性增长的，一定时间内的所有请求都会落到某个固定的数据块中，最终导致分布在同一个分片中，在这种情况下，一小部分分片承载了集群大部分的数据，系统并不能很好的进行扩展</p>\n<p>与此相比，基于哈希的分片方式已范围查询性能的损失为代价，保证了集群中数据的均衡，哈希值的随机性使数据随机分布在每个数据块中，因此也随机分布在不同分片中，但是也正由于随机性，一个范围查询很难确定应该请求哪些分片，通常为了返回需要的结果，需要请求所有分片</p>\n<p>如无特殊情况，一般推荐使用 Hash Sharding。</p>\n<p>而使用_id 作为片键是一个不错的选择，因为它是必有得，你可以使用数据文档 <code>_id</code>  的哈希作为片键。</p>\n<p>这个方案能够使读和写都能够平均分布，并且它能够保证每个文档都有不同的片键所以数据块能够很精细</p>\n<p>似乎还是不够完美，因为这样的话对多个文档的查询必将命中所有的分片，虽说如此，这也是一种比较好的方案了。</p>\n<p>理想化的 shard key 可以让 document 均匀的在集群分布：</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031700375.png\" alt=\"image-20230608121323081\"></p>\n<p>显示集群的详细信息：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>mongos<span class=\"token operator\">></span> db.printShardingStatus<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>mongos<span class=\"token operator\">></span> db.printShardingStatus<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>--- Sharding Status --- </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  sharding version: <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  \t<span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  \t<span class=\"token string\">\"minCompatibleVersion\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">5</span>,</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  \t<span class=\"token string\">\"currentVersion\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">6</span>,</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  \t<span class=\"token string\">\"clusterId\"</span> <span class=\"token builtin class-name\">:</span> ObjectId<span class=\"token punctuation\">(</span><span class=\"token string\">\"64813c5c4c6469e9d2fe9269\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  shards:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span>  <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"myshardrs01\"</span>,  <span class=\"token string\">\"host\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"myshardrs01/192.168.244.142:27018,192.168.244.142:27118\"</span>,  <span class=\"token string\">\"state\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,  <span class=\"token string\">\"topologyTime\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686193851</span>, <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span>  <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"myshardrs02\"</span>,  <span class=\"token string\">\"host\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"myshardrs02/192.168.244.142:27318,192.168.244.142:27418\"</span>,  <span class=\"token string\">\"state\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,  <span class=\"token string\">\"topologyTime\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686194172</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  active mongoses:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token string\">\"5.0.18\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  autosplit:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        Currently enabled: <span class=\"token function\">yes</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  balancer:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        Currently enabled: <span class=\"token function\">yes</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        Currently running: no</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        Failed balancer rounds <span class=\"token keyword\">in</span> last <span class=\"token number\">5</span> attempts: <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        Migration results <span class=\"token keyword\">for</span> the last <span class=\"token number\">24</span> hours: </pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                <span class=\"token number\">512</span> <span class=\"token builtin class-name\">:</span> Success</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  databases:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span>  <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"articledb\"</span>,  <span class=\"token string\">\"primary\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"myshardrs01\"</span>,  <span class=\"token string\">\"partitioned\"</span> <span class=\"token builtin class-name\">:</span> true,  <span class=\"token string\">\"version\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span>  <span class=\"token string\">\"uuid\"</span> <span class=\"token builtin class-name\">:</span> UUID<span class=\"token punctuation\">(</span><span class=\"token string\">\"b94e53c7-d498-49b8-8965-1aafcab2df18\"</span><span class=\"token punctuation\">)</span>,  <span class=\"token string\">\"timestamp\"</span> <span class=\"token builtin class-name\">:</span> Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1686193851</span>, <span class=\"token number\">3</span><span class=\"token punctuation\">)</span>,  <span class=\"token string\">\"lastMod\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                articledb.author</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                        shard key: <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"age\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                        unique: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                        balancing: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                        chunks:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                                myshardrs01\t<span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                        <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"age\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"<span class=\"token variable\">$minKey</span>\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span> --<span class=\"token operator\">>></span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"age\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"<span class=\"token variable\">$maxKey</span>\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span> on <span class=\"token builtin class-name\">:</span> myshardrs01 Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                articledb.comment</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                        shard key: <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"hashed\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                        unique: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                        balancing: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                        chunks:</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                                myshardrs01\t<span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                                myshardrs02\t<span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>                        <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"<span class=\"token variable\">$minKey</span>\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span> --<span class=\"token operator\">>></span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token string\">\"-4611686018427387902\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span> on <span class=\"token builtin class-name\">:</span> myshardrs01 Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"39\"></td><td><pre>                        <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token string\">\"-4611686018427387902\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span> --<span class=\"token operator\">>></span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span> on <span class=\"token builtin class-name\">:</span> myshardrs01 Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                        <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span> --<span class=\"token operator\">>></span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token string\">\"4611686018427387902\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span> on <span class=\"token builtin class-name\">:</span> myshardrs02 Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"41\"></td><td><pre>                        <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> NumberLong<span class=\"token punctuation\">(</span><span class=\"token string\">\"4611686018427387902\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span> --<span class=\"token operator\">>></span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"<span class=\"token variable\">$maxKey</span>\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span> on <span class=\"token builtin class-name\">:</span> myshardrs02 Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">3</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span>  <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"config\"</span>,  <span class=\"token string\">\"primary\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"config\"</span>,  <span class=\"token string\">\"partitioned\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>                config.system.sessions</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>                        shard key: <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                        unique: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                        balancing: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>                        chunks:</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>                                myshardrs01\t<span class=\"token number\">512</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>                                myshardrs02\t<span class=\"token number\">512</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>                        too many chunks to print, use verbose <span class=\"token keyword\">if</span> you want to force print</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>mongos<span class=\"token operator\">></span></pre></td></tr></table></figure><p>查看均衡器是否工作 (需要重新均衡时系统才会自动启动，不用管它)：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>mongos<span class=\"token operator\">></span> sh.isBalancerRunning<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>mongos<span class=\"token operator\">></span></pre></td></tr></table></figure><p>查看当前 Balancer 状态：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>mongos<span class=\"token operator\">></span> sh.getBalancerState<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>mongos<span class=\"token operator\">></span></pre></td></tr></table></figure><h3 id=\"分片后插入数据测试\"><a class=\"markdownIt-Anchor\" href=\"#分片后插入数据测试\">#</a> 分片后插入数据测试</h3>\n<p>测试一 (哈希规则)：登录 mongos 后，向 comment 循环插入 1000 条数据做测试：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>mongos<span class=\"token operator\">></span> use articledb</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>switched to db articledb</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>mongos<span class=\"token operator\">></span> db</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>articledb</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>mongos<span class=\"token operator\">></span> for<span class=\"token punctuation\">(</span>let <span class=\"token assign-left variable\">i</span><span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>i<span class=\"token operator\">&lt;=</span><span class=\"token number\">1000</span><span class=\"token punctuation\">;</span>i++<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>db.comment.insert<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"_id\"</span>:i+<span class=\"token string\">\"\"</span>,<span class=\"token string\">\"nickname\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"BoBo\"</span>+i<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>WriteResult<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"nInserted\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>mongos<span class=\"token operator\">></span> db.comment.count<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token number\">1000</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>mongos<span class=\"token operator\">></span></pre></td></tr></table></figure><p>提示：js 的语法，因为 mongo 的 shell 是一个 javaScript 的 shell</p>\n<p>注意：从路由上插入的数据，必须包含片键，否则无法插入</p>\n<p>分别登陆两个片的主节点，统计文档数量</p>\n<p>第一个分片副本集：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>myshardrs01:PRIMARY<span class=\"token operator\">></span> db</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>articledb</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>myshardrs01:PRIMARY<span class=\"token operator\">></span> db.comment.count<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">507</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>myshardrs01:PRIMARY<span class=\"token operator\">></span></pre></td></tr></table></figure><p>第二个分片副本集：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>myshardrs02:PRIMARY<span class=\"token operator\">></span> use articledb</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>switched to db articledb</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>myshardrs02:PRIMARY<span class=\"token operator\">></span> db</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>articledb</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>myshardrs02:PRIMARY<span class=\"token operator\">></span> db.comment.count<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token number\">493</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>myshardrs02:PRIMARY<span class=\"token operator\">></span></pre></td></tr></table></figure><p>可以看到，1000 条数据近似均匀的分不到了 2 个 shard 上，是根据片键的哈希值分配的。</p>\n<p>这种分配方式非常易于水平扩展：一旦数据存储需要更大空间，可以直接再增加分片即可，同时提升了性能使用 db.comment.stats () 查看单个集合的完整情况，mongos 执行该命令可以查看该集合的数据分片的情况。</p>\n<p>使用 sh.status () 查看本库内所有集合的分片信息。</p>\n<hr>\n<p>测试二 (值范围规则)：登录 mongos 后，向 comment 循环插入 1000 条数据做测试：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>mongos<span class=\"token operator\">></span> db</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>articledb</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>mongos<span class=\"token operator\">></span> for<span class=\"token punctuation\">(</span>let <span class=\"token assign-left variable\">i</span><span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>i<span class=\"token operator\">&lt;=</span><span class=\"token number\">2000</span><span class=\"token punctuation\">;</span>i++<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>db.author.save<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"name\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"BoBoBo\"</span>+i,<span class=\"token string\">\"age\"</span>:NumberInt<span class=\"token punctuation\">(</span>i%120<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>WriteResult<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"nInserted\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>mongos<span class=\"token operator\">></span> db.author.count<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token number\">2000</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>mongos<span class=\"token operator\">></span></pre></td></tr></table></figure><p>插入成功后，仍然要分别查看两个分片副本集的数据情况。</p>\n<p>分片效果：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>articledb.author</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>                        shard key: <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"age\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                        unique: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                        balancing: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                        chunks:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                                myshardrs01\t<span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                        <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"age\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"<span class=\"token variable\">$minKey</span>\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span> --<span class=\"token operator\">>></span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"age\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"<span class=\"token variable\">$maxKey</span>\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span> on <span class=\"token builtin class-name\">:</span> myshardrs01 Timestamp<span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>提示：</p>\n<p>如果查看状态发现没有分片，则可能是由于以下原因造成了：</p>\n<ol>\n<li>\n<p>系统繁忙，正在分片中。</p>\n</li>\n<li>\n<p>数据块 (chunk) 没有填满，默认的数据块尺寸 (chunksize) 是 64M，填满后才会考虑向其它片的数据块填充数据，因此，为了测试，可以将其改小，这里改为 1M，操作如下：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>mongos<span class=\"token operator\">></span> use config</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>switched to db config</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>mongos<span class=\"token operator\">></span> db</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>config</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>mongos<span class=\"token operator\">></span> db.settings.save<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>_id:<span class=\"token string\">\"chunksize\"</span>,value:1<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>WriteResult<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"nMatched\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>, <span class=\"token string\">\"nUpserted\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>, <span class=\"token string\">\"nModified\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>, <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"chunksize\"</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>mongos<span class=\"token operator\">></span></pre></td></tr></table></figure><p>测试完改回来：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>mongos<span class=\"token operator\">></span> db.settings.save<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>_id:<span class=\"token string\">\"chunksize\"</span>,value:64<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>注意：要先改小，再设置分片，为了测试，可以先删除集合，重新建立集合的分片策略，再插入数据测试即可。</p>\n</li>\n</ol>\n<h3 id=\"再增加一个路由节点\"><a class=\"markdownIt-Anchor\" href=\"#再增加一个路由节点\">#</a> 再增加一个路由节点</h3>\n<p>目录:</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>➜  ~ <span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /mongodb/sharded_cluster/myshardrs_27117/log</pre></td></tr></table></figure><p>新建或修改配置文件：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>➜  ~ <span class=\"token function\">vim</span> /mongodb/sharded_cluster/myshardrs_27117/mongos.conf</pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>systemLog:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token comment\">#MongoDB 发送所有日志输出的目标指定为文件</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> <span class=\"token comment\">#The path of the log file to which mongod or mongos should send all diagnostic logging information</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre> destination: <span class=\"token function\">file</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> <span class=\"token comment\">#mongod 或 mongos 应向其发送所有诊断日志记录信息的日志文件的路径</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> path: <span class=\"token string\">\"/mongodb/sharded_cluster/myshardrs_27117/log/mongod.log\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre> <span class=\"token comment\">#当 mongos 或 mongod 实例重新启动时，mongos 或 mongod 会将新条目附加到现有日志文件的末尾。</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre> logAppend: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>processManagement:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token comment\">#启用在后台运行 mongos 或 mongod 进程的守护进程模式。</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre> fork: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre> <span class=\"token comment\">#指定用于保存 mongos 或 mongod 进程的进行 ID 的文件位置，其中 mongos 或 mongod 将写入其 PID</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre> pidFilePath: <span class=\"token string\">\"/mongodb/sharded_cluster/myshardrs_27117/log/mongod.pid\"</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>net:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token comment\">#服务实例绑定 IP，默认是 localhost</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre> bindIp: localhost,192.168.244.142</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token comment\">#bindIp</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token comment\">#绑定的端口，默认是 27017</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre> port: <span class=\"token number\">27117</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>sharding:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre> <span class=\"token comment\">#指定配置节点副本集</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre> <span class=\"token comment\">#        副本集名称 / 主机地址与端口号</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre> configDB: myconfigrs/192.168.244.142:27019,192.168.244.142:27119,192.168.244.142:27219</pre></td></tr></table></figure><p>启动 mongos2：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>➜  ~ /usr/local/mongodb/bin/mongos <span class=\"token parameter variable\">-f</span> /mongodb/sharded_cluster/myshardrs_27117/mongos.conf </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>about to fork child process, waiting <span class=\"token keyword\">until</span> server is ready <span class=\"token keyword\">for</span> connections.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>forked process: <span class=\"token number\">27750</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>child process started successfully, parent exiting</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>➜  ~</pre></td></tr></table></figure><p>使用 Mongo 客户端登录 27117，发现，第二个路由无需配置，因为分片配置都保存到了配置服务器中了</p>\n<h2 id=\"compass连接分片集群\"><a class=\"markdownIt-Anchor\" href=\"#compass连接分片集群\">#</a> Compass 连接分片集群</h2>\n<p>直接连接路由</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031700753.png\" alt=\"image-20230608143006151\"></p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031700972.png\" alt=\"image-20230608143031512\"></p>\n<h2 id=\"springdatamongodb连接分片集群\"><a class=\"markdownIt-Anchor\" href=\"#springdatamongodb连接分片集群\">#</a> SpringDataMongoDB 连接分片集群</h2>\n<p>Java 客户端常用的是 SpringDataMongoDB，其连接的是 mongos 路由，配置和单机 mongod 的配置是一样的。</p>\n<p>多个路由的时候的 SpringDataMongoDB 的客户端配置参考如下：</p>\n<p>直接连接路由节点即可</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">server</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token comment\">#数据源配置</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">data</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token key atrule\">mongodb</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token comment\">#主机地址</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      <span class=\"token comment\">#host: 192.168.244.142</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token comment\">#数据库</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token comment\">#database: articledb</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token comment\">#端口号</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token comment\">#port: 27017</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token comment\">#也可以使用 uri 连接</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token comment\">#uri: mongodb://192.168.244.142:27017/articledb</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      <span class=\"token comment\">#副本集的连接字符串</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      <span class=\"token comment\">#uri:</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token comment\">#mongodb://192.168.244.142:27017,192.168.244.142:27018,192.168.244.142:27019/articledb?</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token comment\">#connect=replicaSet&amp;secondaryOk=true&amp;replicaSet=myrs</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      <span class=\"token comment\">#连接路由字符串</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      <span class=\"token key atrule\">uri</span><span class=\"token punctuation\">:</span> mongodb<span class=\"token punctuation\">:</span>//192.168.244.142<span class=\"token punctuation\">:</span><span class=\"token number\">27017</span><span class=\"token punctuation\">,</span>192.168.244.142<span class=\"token punctuation\">:</span>27117/articledb</pre></td></tr></table></figure><p>通过日志发现，写入数据的时候，会选择一个路由写入：</p>\n<h2 id=\"安全认证\"><a class=\"markdownIt-Anchor\" href=\"#安全认证\">#</a> 安全认证</h2>\n<h3 id=\"mongodb的用户和角色权限简介\"><a class=\"markdownIt-Anchor\" href=\"#mongodb的用户和角色权限简介\">#</a> MongoDB 的用户和角色权限简介</h3>\n<p>默认情况下，MongoDB 实例启动运行时是没有启用用户访问权限控制的，也就是说，在实例本机服务器上都可以随意连接到实例进行各种操作，MongoDB 不会对连接客户端进行用户验证，这是非常危险的。</p>\n<p>mongoDB 官网上说，为了能保障 mongodb 的安全可以做以下几个步骤：</p>\n<ol>\n<li>使用新的端口，默认的 27017 端口如果一旦知道了 ip 就能连接上，不太安全</li>\n<li>设置 mongodb 的网络环境，最好将 mongodb 部署到公司服务器内网，这样外网是访问不到的，公司内部访问使用 vpn 等</li>\n<li>开启安全认证，认证要同时设置服务器之间的内部认证方式，同时要设置客户端连接到集群的账号密码认证方式</li>\n</ol>\n<p>为了强制开启用户访问控制 (用户验证)，则需要在 MongoDB 实例启动时使用选项–auth 或在指定启动配置文件中添加选项 auth=true</p>\n<p>在开始之前需要了解一下概念</p>\n<ol>\n<li>启用访问控制：</li>\n</ol>\n<p>MongoDB 使用的是基于角色的访问控制 (Role-Based Access Control,RBAC) 来管理用户対实例的访问，通过对用户授予一个或多个角色来控制用户访问数据库资源的权限和数据库操作的权限，在对用户分配角色之前，用户无法访问实例。</p>\n<p>在实例启动时添加选项–auth 或指定启动配置文件中添加选项 auth=true</p>\n<ol start=\"2\">\n<li>角色：</li>\n</ol>\n<p>在 MongoDB 中通过角色对用户授予相应数据库资源的操作权限，每个角色当中的权限可以显式指定，也可以通过继承其它角色的权限，或者两都存在的权限</p>\n<ol start=\"3\">\n<li>权限：</li>\n</ol>\n<p>权限由指定的数据库资源 (resource) 以及允许在指定资源上进行的操作 (action) 组成。</p>\n<ol>\n<li>资源 (resource) 包括：数据库，集合，部分集合和集群；</li>\n<li>操作 (action) 包括：对资源进行的增，删，改，查 (CRUD) 操作。</li>\n</ol>\n<p>在角色定义时可以包含一个或多个已存在的角色，新创建的角色会继承包含的角色所有的权限，在同一个数据库中，新创建角色可以继承其它角色的权限，在 admin 数据库中创建的角色可以继承在其它任意数据库中角色的权限。</p>\n<p>关于角色权限的查看，可以通过如下命令查询：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#查询所有角色权限 (仅用户自定义角色)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token operator\">></span> db.runCommand<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>rolesInfo:1<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">#查询所有用户角色权限 (包含内置角色)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">></span> db.runCommand<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>rolesInfo:1,showBuiltinRoles:true<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">#查询当前数据库中的某角色的权限</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token operator\">></span> db.runCommand<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>rolesInfo:<span class=\"token string\">\"&lt;rolename>\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">#查询其它数据库中指定的角色权限</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token operator\">></span> db.runCommand<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>rolesInfo:<span class=\"token punctuation\">&#123;</span>role:<span class=\"token string\">\"&lt;rolename>\"</span>,db:<span class=\"token string\">\"&lt;database>\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">#查询多个角色权限</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token operator\">></span> db.runCommand<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>rolesInfo:<span class=\"token punctuation\">[</span><span class=\"token string\">\"rolename\"</span>,<span class=\"token punctuation\">&#123;</span>role:<span class=\"token string\">\"&lt;rolename>\"</span>,db:<span class=\"token string\">\"database\"</span><span class=\"token punctuation\">&#125;</span>,<span class=\"token punctuation\">..</span>.<span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>常用的内置角色：</p>\n<ul>\n<li>数据库用户角色：read，readWrite；</li>\n<li>所有数据库用户角色：readAnyDatabase，readWriteAnyDatabase，userAdminAnyDatabase，dbAdminAnyDatabase</li>\n<li>数据库管理角色：dbAdmin，dbOwner，userAdmin；</li>\n<li>集群管理角色：clusterAdmin，clusterManager，clusterMonitor，hostManager；</li>\n<li>备份恢复角色：backup，restore；</li>\n<li>超级用户角色：root</li>\n<li>内部角色：system</li>\n</ul>\n<p>角色说明：</p>\n<table>\n<thead>\n<tr>\n<th>角色</th>\n<th>权限描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>read</td>\n<td>可以读取指定数据库中任何数据</td>\n</tr>\n<tr>\n<td>readWrite</td>\n<td>可以读写指定数据库中任何数据，包括创建，重命名，删除集合</td>\n</tr>\n<tr>\n<td>readAnyDatabase</td>\n<td>可以读取所有数据库中任何数据 (除了数据库 config 和 loacl 之外)</td>\n</tr>\n<tr>\n<td>readWriteAnyDatabase</td>\n<td>可以读写所有数据库中任何数据 (除了数据库 config 和 local 之外)</td>\n</tr>\n<tr>\n<td>userAdminAnyDatabase</td>\n<td>可以在指定数据库创建和修改用户 (除了数据库 config 和 local 之外)</td>\n</tr>\n<tr>\n<td>dbAdminAnyDatabase</td>\n<td>可以读取任何数据库以及对数据库进行清理，修改，压缩，获取统计信息，执行检查等操作 (除了数据库 config 和 local 之外)</td>\n</tr>\n<tr>\n<td>dbAdmin</td>\n<td>可以读取指定数据库以及对数据库进行清理，修怪，压缩，获取统计信息，执行检查等操作。</td>\n</tr>\n<tr>\n<td>userAdmin</td>\n<td>可以在指定数据库创建和修改用户</td>\n</tr>\n<tr>\n<td>clusterAdmin</td>\n<td>可以对整个集群或数据库系统进行管理操作</td>\n</tr>\n<tr>\n<td>backup</td>\n<td>备份 MongoDB 数据最小的权限</td>\n</tr>\n<tr>\n<td>restore</td>\n<td>从备份文件中还原恢复 MongoDB 数据 (除了 system.profile 集合) 的权限。</td>\n</tr>\n<tr>\n<td>root</td>\n<td>超级账号，超级权限</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"单实例环境\"><a class=\"markdownIt-Anchor\" href=\"#单实例环境\">#</a> 单实例环境</h2>\n<p>目标：对单实例的 MongoDB 服务开启安全认证，这里的单实例指定是未开启副本集或分片的 MongoDB 实例。</p>\n<h3 id=\"关闭已开启的服务可选\"><a class=\"markdownIt-Anchor\" href=\"#关闭已开启的服务可选\">#</a> 关闭已开启的服务 (可选)</h3>\n<p>增加 mongod 的单实例的安全认证功能，可以在服务搭建的时候直接添加，也可以在之前搭建好的服务上添加。</p>\n<p>本文使用之前搭建好的服务，因此，先停止之前的服务</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>➜  ~ <span class=\"token function\">ps</span> -ef<span class=\"token operator\">|</span><span class=\"token function\">grep</span> mongod<span class=\"token operator\">|</span><span class=\"token function\">grep</span> <span class=\"token parameter variable\">-v</span> <span class=\"token function\">grep</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>dkx0       <span class=\"token number\">2291</span>      <span class=\"token number\">1</span>  <span class=\"token number\">2</span> Jun07 ?        00:09:22 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/sharded_cluster/myshardrs01_27018/mongod.conf</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>dkx0       <span class=\"token number\">2368</span>      <span class=\"token number\">1</span>  <span class=\"token number\">2</span> Jun07 ?        00:09:19 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/sharded_cluster/myshardrs01_27118/mongod.conf</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>dkx0       <span class=\"token number\">2443</span>      <span class=\"token number\">1</span>  <span class=\"token number\">1</span> Jun07 ?        00:05:27 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/sharded_cluster/myshardrs01_27218/mongod.conf</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>dkx0       <span class=\"token number\">5200</span>      <span class=\"token number\">1</span>  <span class=\"token number\">2</span> Jun07 ?        00:07:06 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/sharded_cluster/myshardrs01_27318/mongod.conf</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>dkx0       <span class=\"token number\">5268</span>      <span class=\"token number\">1</span>  <span class=\"token number\">1</span> Jun07 ?        00:06:37 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/sharded_cluster/myshardrs01_27418/mongod.conf</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>dkx0       <span class=\"token number\">5337</span>      <span class=\"token number\">1</span>  <span class=\"token number\">1</span> Jun07 ?        00:04:25 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/sharded_cluster/myshardrs01_27518/mongod.conf</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>dkx0       <span class=\"token number\">7659</span>      <span class=\"token number\">1</span>  <span class=\"token number\">3</span> Jun07 ?        00:09:26 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/sharded_cluster/myshardrs01_27019/mongod.conf</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>dkx0       <span class=\"token number\">7736</span>      <span class=\"token number\">1</span>  <span class=\"token number\">2</span> Jun07 ?        00:08:15 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/sharded_cluster/myshardrs01_27119/mongod.conf</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>dkx0       <span class=\"token number\">7808</span>      <span class=\"token number\">1</span>  <span class=\"token number\">2</span> Jun07 ?        00:08:11 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/sharded_cluster/myshardrs01_27219/mongod.conf</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>dkx0      <span class=\"token number\">10092</span>      <span class=\"token number\">1</span>  <span class=\"token number\">0</span> Jun07 ?        00:02:23 /usr/local/mongodb/bin/mongos <span class=\"token parameter variable\">-f</span> /mongodb/sharded_cluster/myshardrs_27017/mongos.conf</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>dkx0      <span class=\"token number\">27750</span>      <span class=\"token number\">1</span>  <span class=\"token number\">0</span> 02:22 ?        00:00:31 /usr/local/mongodb/bin/mongos <span class=\"token parameter variable\">-f</span> /mongodb/sharded_cluster/myshardrs_27117/mongos.conf</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>➜  ~</pre></td></tr></table></figure><p>停止服务的方式有两种：快速关闭和标准关闭，下面依次说明：</p>\n<ol>\n<li>快速关闭方式 (快速，简单，数据可能会出错)</li>\n</ol>\n<p>目标：通过系统的 kill 命令直接杀死进程：</p>\n<p>杀完要检查一下，避免有的没有杀掉。</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#通过进程编号关闭节点</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>➜  ~ <span class=\"token function\">kill</span> <span class=\"token parameter variable\">-2</span> <span class=\"token number\">2291</span> <span class=\"token number\">2368</span> <span class=\"token number\">2443</span> <span class=\"token number\">5200</span> <span class=\"token number\">5268</span> <span class=\"token number\">5337</span> <span class=\"token number\">7659</span> <span class=\"token number\">7736</span> <span class=\"token number\">7808</span> <span class=\"token number\">10092</span> <span class=\"token number\">27750</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>➜  ~ <span class=\"token function\">ps</span> -ef<span class=\"token operator\">|</span><span class=\"token function\">grep</span> mongod<span class=\"token operator\">|</span><span class=\"token function\">grep</span> <span class=\"token parameter variable\">-v</span> <span class=\"token function\">grep</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>➜  ~</pre></td></tr></table></figure><p>[补充]</p>\n<p>如果一旦是因为数据损坏，则需要进行如下操作：</p>\n<ol>\n<li>\n<p>删除 lock 文件：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">rm</span> <span class=\"token parameter variable\">-f</span> /mongodb/single/data/db/*.lock</pre></td></tr></table></figure></li>\n<li>\n<p>修复数据：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>/usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">--repair</span> <span class=\"token parameter variable\">--dbpath</span><span class=\"token operator\">=</span>/mongodb/single/data/db</pre></td></tr></table></figure><p>2. 标准的关闭方法 (数据不容易出错，但是麻烦)</p>\n<p>目标：通过 mongo 客户端中的 shutdownServer 命令来关闭服务</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.shutdownServer<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure></li>\n</ol>\n<h3 id=\"添加用户和权限\"><a class=\"markdownIt-Anchor\" href=\"#添加用户和权限\">#</a> 添加用户和权限</h3>\n<p>​    1. 先按照普通无授权认证的配置，来配置服务端的配置文件 /mongodb/single/mongod.conf：(参考，复用之前的)</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>systemLog:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token comment\">#MongoDB 发送所有日志输出的目标指定为文件</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> <span class=\"token comment\">#The path of the log file to which mongod or mongos should send all diagnostic logging information</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre> destination: <span class=\"token function\">file</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> <span class=\"token comment\">#mongod 或 mongos 应向其发送所有诊断日志记录信息的日志文件的路径</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> path: <span class=\"token string\">\"/mongodb/single/log/mongod.log\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre> <span class=\"token comment\">#当 mongos 或 mongod 实例重新启动时，mongos 或 mongod 会将新条目附加到现有日志文件的末尾。</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre> logAppend: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>storage:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre> <span class=\"token comment\">#mongod 实例存储其数据的目录。storage.dbPath 设置仅适用于 mongod。</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre> <span class=\"token comment\">#The directory where the mongod instance stores its data.Defaul value is \"/data/db\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre> dbPath: <span class=\"token string\">\"/mongodb/single/data/db\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre> journal:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token comment\">#启用或禁用持久性日志以确保数据文件保持有效和可恢复</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  enabled: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>processManagement:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token comment\">#启用在后台运行 mongos 或 mongod 进程的守护进程模式。</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre> fork: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>net:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token comment\">#服务实例绑定 IP，默认是 localhost</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre> bindIp: localhost,192.168.244.142</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token comment\">#bindIp</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token comment\">#绑定的端口，默认是 27017</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre> port: <span class=\"token number\">27017</span></pre></td></tr></table></figure><p>2. 按之前为开启认证的方式 (不添加–auth 参数) 来启动 MongoDB 服务：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>➜  ~ /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/single/log/mongod.conf </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>about to fork child process, waiting <span class=\"token keyword\">until</span> server is ready <span class=\"token keyword\">for</span> connections.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>forked process: <span class=\"token number\">34342</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>child process started successfully, parent exiting</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>➜  ~</pre></td></tr></table></figure><p>提示：</p>\n<p>在操作用户时，启动 mongod 服务时尽量不要开启授权</p>\n<p>3. 使用 Mongo 客户端登录：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>➜  ~ /usr/local/mongodb/bin/mongo <span class=\"token parameter variable\">--host</span><span class=\"token operator\">=</span><span class=\"token number\">192.168</span>.244.142 <span class=\"token parameter variable\">--port</span><span class=\"token operator\">=</span><span class=\"token number\">27017</span></pre></td></tr></table></figure><p>4. 创建两个管理员用户，一个是系统的超级管理员 myroot，一个是 admin 库的管理用户 myadmin：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#切换到 admin 库</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token operator\">></span> use admin</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">#创建系统超级用户 myroot，设置密码 123456，设置角色 root</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">></span> db.createUser<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>user:<span class=\"token string\">\"myroot\"</span>,pwd:<span class=\"token string\">\"123456\"</span>,roles:<span class=\"token punctuation\">[</span><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"role\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"root\"</span>,<span class=\"token string\">\"db\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"admin\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">#或 上面指定了集合下面默认是当前所在集合都是 admin</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token operator\">></span> db.createUser<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>user:<span class=\"token string\">\"myroot\"</span>,pwd:<span class=\"token string\">\"123456\"</span>,roles:<span class=\"token punctuation\">[</span><span class=\"token string\">\"root\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>Successfully added user: <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"user\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"myroot\"</span>, <span class=\"token string\">\"roles\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"root\"</span> <span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">#创建专门用来管理 admin 库的账号 myadmin，只用来作为用户权限的管理</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token operator\">></span> db.createUser<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>user:<span class=\"token string\">\"myadmin\"</span>,pwd:<span class=\"token string\">\"123456\"</span>,roles:<span class=\"token punctuation\">[</span><span class=\"token punctuation\">&#123;</span>role:<span class=\"token string\">\"userAdminAnyDatabase\"</span>,db:<span class=\"token string\">\"admin\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>Successfully added user: <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token string\">\"user\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"myadmin\"</span>,</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token string\">\"roles\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t\t<span class=\"token string\">\"role\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"userAdminAnyDatabase\"</span>,</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t\t<span class=\"token string\">\"db\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"admin\"</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token operator\">></span> </pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\">#查看已经创建了的用户的情况：</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token operator\">></span> db.system.users.<span class=\"token function-name function\">find</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"admin.myroot\"</span>, <span class=\"token string\">\"userId\"</span> <span class=\"token builtin class-name\">:</span> UUID<span class=\"token punctuation\">(</span><span class=\"token string\">\"9ecafd01-cef1-43a4-85ad-4ec21e905f81\"</span><span class=\"token punctuation\">)</span>, <span class=\"token string\">\"user\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"myroot\"</span>, <span class=\"token string\">\"db\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"admin\"</span>, <span class=\"token string\">\"credentials\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"SCRAM-SHA-1\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"iterationCount\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">10000</span>, <span class=\"token string\">\"salt\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"LefHopC8WY3knLfOVz56iw==\"</span>, <span class=\"token string\">\"storedKey\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"fFDpj6y1AZCw60aOTM8fBXzUwBc=\"</span>, <span class=\"token string\">\"serverKey\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"YvTH+hyBHN1XThjYnrotc57/hgs=\"</span> <span class=\"token punctuation\">&#125;</span>, <span class=\"token string\">\"SCRAM-SHA-256\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"iterationCount\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">15000</span>, <span class=\"token string\">\"salt\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"35I31t2xZ5NIK0wrw0LZajRGtnY8B8YLwjHfgg==\"</span>, <span class=\"token string\">\"storedKey\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"iy3/8WvkxrNDcKPJmFQ7rTAXxNvzDtjK7uMxzUkhgJ4=\"</span>, <span class=\"token string\">\"serverKey\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"V8Nhn6pBt50M5UsUNBNDGfaOU23f+CLYcYLnxBRTRy0=\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span>, <span class=\"token string\">\"roles\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"role\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"root\"</span>, <span class=\"token string\">\"db\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"admin\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"admin.myadmin\"</span>, <span class=\"token string\">\"userId\"</span> <span class=\"token builtin class-name\">:</span> UUID<span class=\"token punctuation\">(</span><span class=\"token string\">\"c8145c3a-b1a1-4be2-a226-39e067cbe9b0\"</span><span class=\"token punctuation\">)</span>, <span class=\"token string\">\"user\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"myadmin\"</span>, <span class=\"token string\">\"db\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"admin\"</span>, <span class=\"token string\">\"credentials\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"SCRAM-SHA-1\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"iterationCount\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">10000</span>, <span class=\"token string\">\"salt\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"Gc9gasfekYv2F9njhAd/Sg==\"</span>, <span class=\"token string\">\"storedKey\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"vy3mzY/oer2ONiUO8nV0DRrLwUg=\"</span>, <span class=\"token string\">\"serverKey\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"oVgCRHfLt/HW4PslM3QCghvVHZ4=\"</span> <span class=\"token punctuation\">&#125;</span>, <span class=\"token string\">\"SCRAM-SHA-256\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"iterationCount\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">15000</span>, <span class=\"token string\">\"salt\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"vXE6XCPtMv2ErDmXM/21KlbiTlEQEQ89rmcIgQ==\"</span>, <span class=\"token string\">\"storedKey\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"MexKD1eAYxvws8ANYtvNPdDZajNTAjfJphlIDtvPn80=\"</span>, <span class=\"token string\">\"serverKey\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"Zzp84uYSusKlbNoMmTi/rPvskHl531RQDjQIjcdDGkY=\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span>, <span class=\"token string\">\"roles\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"role\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"userAdminAnyDatabase\"</span>, <span class=\"token string\">\"db\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"admin\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token operator\">></span> </pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token comment\">#删除用户</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token operator\">></span> db.dropUser<span class=\"token punctuation\">(</span><span class=\"token string\">\"myadmin\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token operator\">></span> db.system.users.<span class=\"token function-name function\">find</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"admin.myroot\"</span>, <span class=\"token string\">\"userId\"</span> <span class=\"token builtin class-name\">:</span> UUID<span class=\"token punctuation\">(</span><span class=\"token string\">\"9ecafd01-cef1-43a4-85ad-4ec21e905f81\"</span><span class=\"token punctuation\">)</span>, <span class=\"token string\">\"user\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"myroot\"</span>, <span class=\"token string\">\"db\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"admin\"</span>, <span class=\"token string\">\"credentials\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"SCRAM-SHA-1\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"iterationCount\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">10000</span>, <span class=\"token string\">\"salt\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"LefHopC8WY3knLfOVz56iw==\"</span>, <span class=\"token string\">\"storedKey\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"fFDpj6y1AZCw60aOTM8fBXzUwBc=\"</span>, <span class=\"token string\">\"serverKey\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"YvTH+hyBHN1XThjYnrotc57/hgs=\"</span> <span class=\"token punctuation\">&#125;</span>, <span class=\"token string\">\"SCRAM-SHA-256\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"iterationCount\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">15000</span>, <span class=\"token string\">\"salt\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"35I31t2xZ5NIK0wrw0LZajRGtnY8B8YLwjHfgg==\"</span>, <span class=\"token string\">\"storedKey\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"iy3/8WvkxrNDcKPJmFQ7rTAXxNvzDtjK7uMxzUkhgJ4=\"</span>, <span class=\"token string\">\"serverKey\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"V8Nhn6pBt50M5UsUNBNDGfaOU23f+CLYcYLnxBRTRy0=\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span>, <span class=\"token string\">\"roles\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"role\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"root\"</span>, <span class=\"token string\">\"db\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"admin\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token operator\">></span> </pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token comment\">#修改密码</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token operator\">></span> db.changeUserPassword<span class=\"token punctuation\">(</span><span class=\"token string\">\"myroot\"</span>,<span class=\"token string\">\"123456\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr></table></figure><p>提示：</p>\n<ol>\n<li>本案例创建了两个用户，分别对应超管和专门用来管理用户的角色，事实上，你只需要一个用户即可。如果你对安全要求很高，防止超管泄露，则不要创建超管用户。</li>\n<li>和其它数据库 (MySQL) 一样，权限的管理都差不多一样，也是将用户和权限信息保存到数据库对应的表中。MongoDB 存储所有的用户信息在 admin 数据库的集合 system.users 中，保存用户名，密码和数据库信息。</li>\n<li role:userAdminAnyDatabase,db:=\"\">如果不指定数据库，则创建的指定的权限的用户在所有的数据库上有效，如</li>\n</ol>\n<p>认证测试：</p>\n<p>测试添加的用户是否正确：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> use admin</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>switched to db admin</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">#输入错误密码</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">></span> db.auth<span class=\"token punctuation\">(</span><span class=\"token string\">\"myroot\"</span>,<span class=\"token string\">\"1234\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Error: Authentication failed.</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">#输入正确密码</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token operator\">></span> db.auth<span class=\"token punctuation\">(</span><span class=\"token string\">\"myroot\"</span>,<span class=\"token string\">\"123456\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr></table></figure><p>创建普通用户</p>\n<p>创建普通用户可以在没有开启认证的时候添加，也可以在开启认证之后添加，但开启认证之后，必须使用有操作 admin 库的用户登录认证后才能操作，底层都是将用户信息保存在了 admin 数据库的集合 system.users 中。</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> use articledb</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>switched to db articledb</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">></span> db</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>articledb</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">#创建用户，拥有 articledb 数据库的读写权限 readWrite，密码是 123456</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token operator\">></span> db.createUser<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>user:<span class=\"token string\">\"bobo\"</span>,pwd:<span class=\"token string\">\"123456\"</span>,roles:<span class=\"token punctuation\">[</span><span class=\"token punctuation\">&#123;</span>role:<span class=\"token string\">\"readWrite\"</span>,<span class=\"token string\">\"db\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"articledb\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>Successfully added user: <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token string\">\"user\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"bobo\"</span>,</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token string\">\"roles\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\t\t<span class=\"token string\">\"role\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"readWrite\"</span>,</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t\t<span class=\"token string\">\"db\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"articledb\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\">#测试是否可用</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token operator\">></span> db.auth<span class=\"token punctuation\">(</span><span class=\"token string\">\"bobo\"</span>,<span class=\"token string\">\"123456\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr></table></figure><p>提示：</p>\n<p>如果开启了认证后，登录的客户端的用户必须使用 admin 库的角色，如拥有 root 角色的 myadmin 用户，再通过 myadmin 用户去创建其它角色的用户</p>\n<h3 id=\"服务端开启认证和客户端连接登录\"><a class=\"markdownIt-Anchor\" href=\"#服务端开启认证和客户端连接登录\">#</a> 服务端开启认证和客户端连接登录</h3>\n<ol>\n<li>\n<p>关闭已经启动的服务</p>\n</li>\n<li>\n<p>使用 linux 命令杀死进程：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>➜  ~ <span class=\"token function\">ps</span> -ef<span class=\"token operator\">|</span><span class=\"token function\">grep</span> mongod<span class=\"token operator\">|</span><span class=\"token function\">grep</span> <span class=\"token parameter variable\">-v</span> <span class=\"token function\">grep</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>dkx0      <span class=\"token number\">34342</span>      <span class=\"token number\">1</span>  <span class=\"token number\">1</span> 03:53 ?        00:00:29 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/single/log/mongod.conf</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>dkx0      <span class=\"token number\">34546</span>  <span class=\"token number\">34416</span>  <span class=\"token number\">0</span> 03:55 pts/1    00:00:00 /usr/local/mongodb/bin/mongo <span class=\"token parameter variable\">--host</span><span class=\"token operator\">=</span><span class=\"token number\">192.168</span>.244.142 <span class=\"token parameter variable\">--port</span><span class=\"token operator\">=</span><span class=\"token number\">27017</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>➜  ~ <span class=\"token function\">kill</span> <span class=\"token parameter variable\">-2</span> <span class=\"token number\">34342</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>➜  ~</pre></td></tr></table></figure></li>\n<li>\n<p>在 mongo 客户端中使用 shutdownServer 命令来关闭</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.shutdownServer<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">shutdown</span> <span class=\"token builtin class-name\">command</span> only works with the admin database<span class=\"token punctuation\">;</span> try <span class=\"token string\">'use admin'</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">></span> use admin</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>switched to db admin</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token operator\">></span> db.shutdownServer<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>server should be down<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr></table></figure><p>需要几个条件：</p>\n<ul>\n<li>必须是在 admin 库下执行该关闭命令</li>\n<li>如果没有认证，必须是从 localhost 登录的，才能执行关闭服务命令</li>\n<li>非 localhost 得，通过远程登录，必须有登录且必须登录用户有对 admin 操作权限才可以。</li>\n</ul>\n<p>2. 以开启认证的方式启动服务</p>\n<p>有两种方式开启权限认证启动服务：一种是参数方式，一种是配置文件方式 (推荐)。</p>\n<p>1. 参数方式</p>\n<p>在启动时指定参数–auth，如：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>➜  ~ /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/single/log/mongod.conf <span class=\"token parameter variable\">--auth</span></pre></td></tr></table></figure><p>2. 配置文件方式</p>\n<p>在 single/mongod.conf 配置文件中加入:</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"><span>l</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre>security:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token comment\">#开启授权认证</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> authorization: enabled</pre></td></tr></table></figure><p>启动时可不加–auth 参数该方式避免忘记加–auth 导致不安全问题发生：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>➜  ~ /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/single/log/mongod.conf</pre></td></tr></table></figure><p>启动服务并连接客户端查看效果：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>➜  ~ /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/single/log/mongod.conf </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>about to fork child process, waiting <span class=\"token keyword\">until</span> server is ready <span class=\"token keyword\">for</span> connections.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>forked process: <span class=\"token number\">36759</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>child process started successfully, parent exiting</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>➜  ~ </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>➜  ~ /usr/local/mongodb/bin/mongo <span class=\"token parameter variable\">--host</span><span class=\"token operator\">=</span><span class=\"token number\">192.168</span>.244.142 <span class=\"token parameter variable\">--port</span><span class=\"token operator\">=</span><span class=\"token number\">27017</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>MongoDB shell version v5.0.18</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>connecting to: mongodb://192.168.244.142:27017/?compressors<span class=\"token operator\">=</span>disabled<span class=\"token operator\">&amp;</span><span class=\"token assign-left variable\">gssapiServiceName</span><span class=\"token operator\">=</span>mongodb</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>Implicit session: session <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"id\"</span> <span class=\"token builtin class-name\">:</span> UUID<span class=\"token punctuation\">(</span><span class=\"token string\">\"ea29ccf7-9d79-4fc5-9615-b26267842fd8\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>MongoDB server version: <span class=\"token number\">5.0</span>.18</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>Warning: the <span class=\"token string\">\"mongo\"</span> shell has been superseded by <span class=\"token string\">\"mongosh\"</span>,</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token function\">which</span> delivers improved usability and compatibility.The <span class=\"token string\">\"mongo\"</span> shell has been deprecated and will be removed <span class=\"token keyword\">in</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>an upcoming release.</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>For installation instructions, see</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>https://docs.mongodb.com/mongodb-shell/install/</pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token operator\">></span> show dbs</pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token operator\">></span> use articledb</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>switched to db articledb</pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token operator\">></span> show tables</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>Warning: unable to run listCollections, attempting to approximate collection names by parsing connectionStatus</pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr></table></figure><p>可以看到不能访问任何数据</p>\n</li>\n</ol>\n<p>登录 myroot 用户：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> use admin</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>switched to db admin</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">></span> db.auth<span class=\"token punctuation\">(</span><span class=\"token string\">\"myroot\"</span>,<span class=\"token string\">\"123456\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token operator\">></span> show dbs</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>admin      <span class=\"token number\">0</span>.000GB</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>articledb  <span class=\"token number\">0</span>.000GB</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>config     <span class=\"token number\">0</span>.000GB</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token builtin class-name\">local</span>      <span class=\"token number\">0</span>.000GB</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr></table></figure><p>登录 bobo 普通用户：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> show dbs</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token operator\">></span> db.auth<span class=\"token punctuation\">(</span><span class=\"token string\">\"bobo\"</span>,<span class=\"token string\">\"123456\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Error: Authentication failed.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token operator\">></span> use articledb</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>switched to db articledb</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token operator\">></span> db.auth<span class=\"token punctuation\">(</span><span class=\"token string\">\"bobo\"</span>,<span class=\"token string\">\"123456\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token operator\">></span> show dbs</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>articledb  <span class=\"token number\">0</span>.000GB</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token operator\">></span> show tables</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>comment</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr></table></figure><p><mark>注意</mark>：哪个用户权限属于哪个集合就需要 use 到该集合中执行 db.auth 命令才行</p>\n<h3 id=\"springdatamongodb连接认证\"><a class=\"markdownIt-Anchor\" href=\"#springdatamongodb连接认证\">#</a> SpringDataMongoDB 连接认证</h3>\n<p>使用用户名和密码连接到 MongoDB 服务器，你必须使用 <code>username:password@hostname/dbname</code>  格式， <code>username</code>  为用户名， <code>password</code>  为密码</p>\n<p>目标：使用用户 bobo 使用密码 123456 连接到 MongoDB 服务上。</p>\n<p>application.yml</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\t<span class=\"token comment\">#数据源配置</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token key atrule\">data</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t\t<span class=\"token key atrule\">mongodb</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\t\t<span class=\"token comment\">#主机地址</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t\t<span class=\"token comment\">#host: 192.168.244.142</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\t\t<span class=\"token comment\">#数据库</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t\t<span class=\"token comment\">#database: articledb</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t\t<span class=\"token comment\">#默认端口号</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t\t<span class=\"token comment\">#port: 27017</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\t\t<span class=\"token comment\">#账号</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t\t<span class=\"token comment\">#username: bobo</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t\t<span class=\"token comment\">#密码</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t\t<span class=\"token comment\">#password: 123456</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t\t<span class=\"token comment\">#单机有认证的情况下，也是用字符串连接</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t\t<span class=\"token key atrule\">uri</span><span class=\"token punctuation\">:</span> mongodb<span class=\"token punctuation\">:</span>//bobo<span class=\"token punctuation\">:</span>123456@192.168.244.142<span class=\"token punctuation\">:</span>27017/articledb</pre></td></tr></table></figure><p>提示：</p>\n<p>分别测试用户名密码正确以及不正确的情况.</p>\n<p>Compass 连接需要指定用户名和密码否则连接不上</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031701928.png\" alt=\"image-20230608165514763\"></p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031701801.png\" alt=\"image-20230608165613122\"></p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031701100.png\" alt=\"image-20230608165629084\"></p>\n<h2 id=\"副本集环境\"><a class=\"markdownIt-Anchor\" href=\"#副本集环境\">#</a> 副本集环境</h2>\n<h3 id=\"前言\"><a class=\"markdownIt-Anchor\" href=\"#前言\">#</a> 前言</h3>\n<p>对于搭建好的 mongodb 副本集，为了安全，启动安全认证，使用账号密码登。</p>\n<p>副本集环境使用之前搭建好的，架构如下：</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031701536.png\" alt=\"image-20230608165821185\"></p>\n<h3 id=\"关闭已开启的副本集服务\"><a class=\"markdownIt-Anchor\" href=\"#关闭已开启的副本集服务\">#</a> 关闭已开启的副本集服务</h3>\n<h3 id=\"通过主节点添加一个管理员账号\"><a class=\"markdownIt-Anchor\" href=\"#通过主节点添加一个管理员账号\">#</a> 通过主节点添加一个管理员账号</h3>\n<p>只需要在主节点上添加用户，副本集会自动同步</p>\n<p>开启认证之前，创建超管用户：myroot，密码：123456</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>myrs:PRIMARY<span class=\"token operator\">></span> use admin</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>myrs:PRIMARY<span class=\"token operator\">></span> db.createUser<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>user:<span class=\"token string\">\"myroot\"</span>,pwd:<span class=\"token string\">\"123456\"</span>,roles:<span class=\"token punctuation\">[</span><span class=\"token string\">\"root\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>详细操作见单实例环境的 <code>添加用户和权限</code> 的相关操作。</p>\n<p>提示：</p>\n<p>该步骤也可以在开启认证之后，但需要通过 localhost 登录才允许添加用户，用户数据也会自动同步到副本集，后续再创建其它用户，都可以使用该超管用户创建。</p>\n<h3 id=\"创建副本集认证的key文件\"><a class=\"markdownIt-Anchor\" href=\"#创建副本集认证的key文件\">#</a> 创建副本集认证的 key 文件</h3>\n<p>第一步：生成一个 key 文件当当前文件夹中</p>\n<p>可以使用任何方法生成密钥文件，例如：以下操作使用 openssl 生成密码文件，然后使用 chmod 来 更改文件权限，仅为文件所有者提供读取权限</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>➜  ~ openssl rand <span class=\"token parameter variable\">-base64</span> <span class=\"token number\">90</span> <span class=\"token parameter variable\">-out</span> ./mongo.keyfile</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token operator\">></span> <span class=\"token function\">chmod</span> <span class=\"token number\">400</span> ./mongo.keyfile</pre></td></tr></table></figure><p>提示：</p>\n<p>所有副本集节点都必须要用同一份 keyfile，一般是在一台机器上生成，然后拷贝到其它机器上，且必须有读的权限，否则将来会报错：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>permissions on /mongodb/replica_sets/myrs_27017/mongo.keyfile are too</pre></td></tr></table></figure><p>一定要保证密钥文件一致，文件位置随便，但是为了方便查找，建议每台机器都放到一个固定位置，都放到和配置文件一起的目录中</p>\n<p>这里将该文件分别拷贝到多个目录中：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> <span class=\"token function\">cp</span> mongo.keyfile /mongodb/replica_sets/myrs_27017</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token operator\">></span> <span class=\"token function\">cp</span> mongo.keyfile /mongodb/replica_sets/myrs_27018</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">></span> <span class=\"token function\">cp</span> mongo.keyfile /mongodb/replica_sets/myrs_27019</pre></td></tr></table></figure><h3 id=\"修改配置文件指定keyfile\"><a class=\"markdownIt-Anchor\" href=\"#修改配置文件指定keyfile\">#</a> 修改配置文件指定 keyfile</h3>\n<p>分别编辑几个服务的 mongod.conf 文件，添加相关内容：</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">security</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\t<span class=\"token comment\">#keyfile 签权文件</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token key atrule\">keyFile</span><span class=\"token punctuation\">:</span> /mongodb/replica_sets/myrs_27017/mongo.keyfile</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token comment\">#开启认证方式运行</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token key atrule\">authorization</span><span class=\"token punctuation\">:</span> enabled</pre></td></tr></table></figure><figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">security</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\t<span class=\"token comment\">#keyfile 签权文件</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token key atrule\">keyFile</span><span class=\"token punctuation\">:</span> /mongodb/replica_sets/myrs_27018/mongo.keyfile</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token comment\">#开启认证方式运行</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token key atrule\">authorization</span><span class=\"token punctuation\">:</span> enabled</pre></td></tr></table></figure><figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">security</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\t<span class=\"token comment\">#keyfile 签权文件</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token key atrule\">keyFile</span><span class=\"token punctuation\">:</span> /mongodb/replica_sets/myrs_27019/mongo.keyfile</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token comment\">#开启认证方式运行</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token key atrule\">authorization</span><span class=\"token punctuation\">:</span> enabled</pre></td></tr></table></figure><h3 id=\"重新启动副本集\"><a class=\"markdownIt-Anchor\" href=\"#重新启动副本集\">#</a> 重新启动副本集</h3>\n<p>如果副本集是开启状态，则先分别关闭副本集中的每个 mongod，从次节点开始，直到副本集的所有成员都离线，包括任何仲载者，主节点必须是最后一个成员关闭以避免潜在的回滚。</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>➜  ~ <span class=\"token function\">kill</span> <span class=\"token parameter variable\">-2</span> <span class=\"token number\">2453</span> <span class=\"token number\">2224</span> <span class=\"token number\">2110</span> <span class=\"token number\">2013</span></pre></td></tr></table></figure><p>分别启动副本集节点：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>➜  ~ /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/replica_sets/myrs_27017/log/mongod.conf </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>about to fork child process, waiting <span class=\"token keyword\">until</span> server is ready <span class=\"token keyword\">for</span> connections.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>forked process: <span class=\"token number\">3960</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>child process started successfully, parent exiting</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>➜  ~ /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/replica_sets/myrs_27018/log/mongod.conf</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>about to fork child process, waiting <span class=\"token keyword\">until</span> server is ready <span class=\"token keyword\">for</span> connections.</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>forked process: <span class=\"token number\">4043</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>child process started successfully, parent exiting</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>➜  ~ /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/replica_sets/myrs_27019/log/mongod.conf</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>about to fork child process, waiting <span class=\"token keyword\">until</span> server is ready <span class=\"token keyword\">for</span> connections.</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>forked process: <span class=\"token number\">4144</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>child process started successfully, parent exiting</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>➜  ~</pre></td></tr></table></figure><p>查看进程：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>➜  ~ <span class=\"token function\">ps</span> -ef<span class=\"token operator\">|</span><span class=\"token function\">grep</span> mongod<span class=\"token operator\">|</span><span class=\"token function\">grep</span> <span class=\"token parameter variable\">-v</span> <span class=\"token function\">grep</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>dkx0       <span class=\"token number\">3960</span>      <span class=\"token number\">1</span>  <span class=\"token number\">9</span> <span class=\"token number\">22</span>:44 ?        00:00:03 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/replica_sets/myrs_27017/log/mongod.conf</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>dkx0       <span class=\"token number\">4043</span>      <span class=\"token number\">1</span> <span class=\"token number\">10</span> <span class=\"token number\">22</span>:44 ?        00:00:03 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/replica_sets/myrs_27018/log/mongod.conf</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>dkx0       <span class=\"token number\">4144</span>      <span class=\"token number\">1</span> <span class=\"token number\">11</span> <span class=\"token number\">22</span>:44 ?        00:00:02 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/replica_sets/myrs_27019/log/mongod.conf</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>➜  ~</pre></td></tr></table></figure><p>登录 myroot 用户查看</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>myrs:PRIMARY<span class=\"token operator\">></span> show dbs</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>myrs:PRIMARY<span class=\"token operator\">></span> use admin</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>switched to db admin</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>myrs:PRIMARY<span class=\"token operator\">></span> db.auth<span class=\"token punctuation\">(</span><span class=\"token string\">\"myroot\"</span>,<span class=\"token string\">\"123456\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>myrs:PRIMARY<span class=\"token operator\">></span> show dbs</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>admin      <span class=\"token number\">0</span>.000GB</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>articledb  <span class=\"token number\">0</span>.000GB</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>config     <span class=\"token number\">0</span>.000GB</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token builtin class-name\">local</span>      <span class=\"token number\">0</span>.001GB</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token builtin class-name\">test</span>       <span class=\"token number\">0</span>.000GB</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>myrs:PRIMARY<span class=\"token operator\">></span></pre></td></tr></table></figure><h3 id=\"在主节点上添加普通账号\"><a class=\"markdownIt-Anchor\" href=\"#在主节点上添加普通账号\">#</a> 在主节点上添加普通账号</h3>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#添加普通用户管理 articledb 集合</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>myrs:PRIMARY<span class=\"token operator\">></span> db.createUser<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>user:<span class=\"token string\">\"bobo\"</span>,pwd:<span class=\"token string\">\"123456\"</span>,roles:<span class=\"token punctuation\">[</span><span class=\"token punctuation\">&#123;</span>role:<span class=\"token string\">\"readWrite\"</span>,db:<span class=\"token string\">\"articledb\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Successfully added user: <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token string\">\"user\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"bobo\"</span>,</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token string\">\"roles\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\t\t<span class=\"token string\">\"role\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"readWrite\"</span>,</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t\t<span class=\"token string\">\"db\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"articledb\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>myrs:PRIMARY<span class=\"token operator\">></span></pre></td></tr></table></figure><p>重新连接，使用普通用户 bobo 重新登录，查看数据</p>\n<p>注意：也要使用 rs.status () 命令查看副本集是否健康</p>\n<h3 id=\"springdatamongodb连接副本集-2\"><a class=\"markdownIt-Anchor\" href=\"#springdatamongodb连接副本集-2\">#</a> SpringDataMongoDB 连接副本集</h3>\n<p>使用用户名和密码连接到 MongoDB 服务器，必须使用 <code>username:password@hostname/dbname</code>  格式</p>\n<p>目标：使用用户 bobo 使用密码 123456 连接到 mongoDB 服务上</p>\n<p>application.yml</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">server</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token comment\">#数据源配置</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">data</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token key atrule\">mongodb</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token comment\">#主机地址</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      <span class=\"token comment\">#host: 192.168.244.142</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token comment\">#数据库</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token comment\">#database: articledb</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token comment\">#端口号</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token comment\">#port: 27017</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token comment\">#也可以使用 uri 连接</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token comment\">#uri: mongodb://192.168.244.142:27017/articledb</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      <span class=\"token comment\">#副本集的连接字符串</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      <span class=\"token key atrule\">uri</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        mongodb<span class=\"token punctuation\">:</span>//bobo<span class=\"token punctuation\">:</span>123456@192.168.244.142<span class=\"token punctuation\">:</span><span class=\"token number\">27017</span><span class=\"token punctuation\">,</span>192.168.244.142<span class=\"token punctuation\">:</span><span class=\"token number\">27018</span><span class=\"token punctuation\">,</span>192.168.244.142<span class=\"token punctuation\">:</span>27019/articledb<span class=\"token punctuation\">?</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        connect=replicaSet<span class=\"token important\">&amp;secondaryOk=true&amp;replicaSet=myrs</span></pre></td></tr></table></figure><h3 id=\"分片集群环境扩展\"><a class=\"markdownIt-Anchor\" href=\"#分片集群环境扩展\">#</a> 分片集群环境 (扩展)</h3>\n<h4 id=\"关闭已开启的集群服务\"><a class=\"markdownIt-Anchor\" href=\"#关闭已开启的集群服务\">#</a> 关闭已开启的集群服务</h4>\n<p>分片集群环境下的安全认证和副本集环境下基本上一样。</p>\n<p>但分片集群的服务器环境和架构较为复杂，建议在搭建分片集群的时候，直接加入安全认证和服务器间的签权，如果之前有数据，可先将之前的数据备份出来，再还原回去</p>\n<p>本文使用之前搭建好的集群服务，因此，先停止之前的集群服务</p>\n<p>依次杀死 mongod 路由，配置副本集服务，分片副本服务，从次节点开始，直到所有成员都离线，副本集杀的时候，建议先杀仲载者，再杀副本节点，最后是主节点，以避免潜在的回滚，杀完检查一下</p>\n",
            "tags": [
                "计算机学科",
                "database",
                "mongodb"
            ]
        },
        {
            "id": "https://pigpigletsgo.github.io/homepage/2024/04/02/computer-science/database/mongodb/MongoDB%E7%9A%84%E5%AE%89%E8%A3%85%E5%8F%8A%E5%90%AF%E7%94%A8/",
            "url": "https://pigpigletsgo.github.io/homepage/2024/04/02/computer-science/database/mongodb/MongoDB%E7%9A%84%E5%AE%89%E8%A3%85%E5%8F%8A%E5%90%AF%E7%94%A8/",
            "title": "MongoDB的安装及启用",
            "date_published": "2024-04-02T06:23:30.042Z",
            "content_html": "<blockquote>\n<p>MongoDB 是一个开源，高性能，无模式的文档行数据库，NoSQL 数据库产品的一种，是最像关系型数据库的非关系型数据库</p>\n</blockquote>\n<h2 id=\"什么时候使用mongodb\"><a class=\"markdownIt-Anchor\" href=\"#什么时候使用mongodb\">#</a> <strong>什么时候使用 MongoDB</strong> .</h2>\n<ul>\n<li>淘宝用户数据\n<ul>\n<li>存储位置：数据库<br>\n特征：永久性存储，修改频度极低</li>\n</ul>\n</li>\n</ul>\n<img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031654494.png\" alt=\"image-20230508172121935\" style=\"zoom:67%;\" />\n<ul>\n<li>游戏装备数据，游戏道具数据\n<ul>\n<li>存储位置：数据库，MongoDB</li>\n<li>特征：永久性存储与临时存储相结合，修改频度较高</li>\n</ul>\n</li>\n</ul>\n<img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031654564.png\" alt=\"image-20230508172300193\" style=\"zoom:67%;\" />\n<p>可以记录一些数据库，并且这个数据有很高的修改频率这种数据不太适合进数据库，而比较适合进 MongoDB 中</p>\n<h2 id=\"mongodb的下载\"><a class=\"markdownIt-Anchor\" href=\"#mongodb的下载\">#</a> MongoDB 的下载</h2>\n<p>进入官网: <a href=\"https://www.mongodb.com/try/download/community-kubernetes-operator\">MongoDB</a></p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031654073.png\" alt=\"image-20230514194355932\"></p>\n<p>下载完成后进行解压:</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031654323.png\" alt=\"image-20230514194620731\"></p>\n<p>进入解压后的文件夹中查看结构：</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031654953.png\" alt=\"image-20230514194734924\"></p>\n<p>在 MongoDB 解压后的路面中创建一个存储数据的文件夹:data</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031655399.png\" alt=\"image-20230514194931585\"></p>\n<p>在创建一个数据存储相关的文件:db</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031655089.png\" alt=\"image-20230514195004382\"></p>\n<p>在 bin 中 MongoDB 的执行文件是: mongod.exe</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031655736.png\" alt=\"image-20230514195231717\"></p>\n<p>在 MongoDB 目录中打开在当前位置下的 Terminal (终端)</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031655531.png\" alt=\"image-20230514195607777\"></p>\n<p>在 Terminal 中输入指令：mongod [指定存储位置] --dbpath=…/data/db , 完整的指令如下：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>mongod <span class=\"token parameter variable\">--dbpath</span><span class=\"token operator\">=</span><span class=\"token punctuation\">..</span>/data/db</pre></td></tr></table></figure><p>执行指令后的情况如下：这是相关数据的创建过程，犹如启动 Redis 中的 redis-server 一样</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031655165.png\" alt=\"image-20230514195504118\"></p>\n<p>默认端口号为：27017</p>\n<p>再查看 db 文件夹下的情况如下：</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031655245.png\" alt=\"image-20230514195841419\"></p>\n<h2 id=\"进入到mongodb中\"><a class=\"markdownIt-Anchor\" href=\"#进入到mongodb中\">#</a> 进入到 MongoDB 中</h2>\n<p>到 MongoDB 的 bin 目录下，执行指令：mongo 启动 MongoDB</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>mongo</pre></td></tr></table></figure><p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031655792.png\" alt=\"image-20230514200129070\"></p>\n<h2 id=\"方式2配置文件方式启动服务重要\"><a class=\"markdownIt-Anchor\" href=\"#方式2配置文件方式启动服务重要\">#</a> 方式 2：配置文件方式启动服务 (重要)</h2>\n<p>部署项目使用该方式，以上的启动方式便以调试使用</p>\n<p>在解压目录中新建 config 文件夹，该文件夹新建配置文件 mongod.conf，内容参考如下：</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031656962.png\" alt=\"image-20230603091350281\"></p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031656079.png\" alt=\"image-20230603091719879\"></p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">storage</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token comment\">#The directory where the mongod instance sotres its data.Default value is \"\\data\\db\" on Windows.</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> <span class=\"token key atrule\">dbPath</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>配置路径，也就是到db目录的绝对路径<span class=\"token punctuation\">]</span></pre></td></tr></table></figure><p>注意：</p>\n<p>配置文件中如果使用双引号，比如路径地址，自动会将双引号的内容转义，如果不转义，则会报错：</p>\n<pre><code>error-parsing-yaml-config-file-yaml-cpp-error-at-line-3-column-15-unknown-escape-character-d\n</code></pre>\n<p>解决：</p>\n<ol>\n<li>对 <code>\\</code>  换成 <code>/</code>  或 <code>//</code></li>\n<li>如果路径中没有空格，则无需加引号</li>\n<li>配置文件中不能以 Tab 分割字段</li>\n</ol>\n<p>解决：</p>\n<p>将其转换成空格。</p>\n<p>启动方式：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>mongod <span class=\"token parameter variable\">-f</span> <span class=\"token punctuation\">..</span>/config/mongod.conf</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>或</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>mongod <span class=\"token parameter variable\">--config</span> <span class=\"token punctuation\">..</span>/config/mongod.conf</pre></td></tr></table></figure><p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031656411.png\" alt=\"image-20230603094012602\"></p>\n<p>更多参数配置：</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">systemLong</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token key atrule\">destination</span><span class=\"token punctuation\">:</span> file</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> <span class=\"token comment\">#The path of the log file to which mondod mongos should send all diagnostic logging information</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre> <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>mongod.log文件绝对路径地址<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> <span class=\"token key atrule\">logAppend</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">storage</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre> <span class=\"token key atrule\">journal</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre> <span class=\"token comment\">#The directory where the mongod instance storage its data.Default value is \"/data/db\"</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre> <span class=\"token key atrule\">dbPath</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>配置路径，也就是到db目录的绝对路径<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token key atrule\">net</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre> <span class=\"token comment\">#bindIp: 127.0.0.1</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre> <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">27017</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token key atrule\">setParameter</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre> <span class=\"token key atrule\">enableLocalhostAuthBypass</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span></pre></td></tr></table></figure><p>windows 配置如下：</p>\n<pre><code>systemLog:\n  destination: file\n  path: D:\\mongoDB\\mongodb-win32-x86_64-windows-5.0.26\\log\\mongod.log  # 实际日志文件路径\n  logAppend: true\n\nstorage:\n  dbPath: D:\\mongoDB\\mongodb-win32-x86_64-windows-5.0.26\\data  # 实际数据存储路径\n\nnet:\n  bindIp: 0.0.0.0\n  port: 27017  # MongoDB 默认端口号\n</code></pre>\n<h2 id=\"shell连接mongo命令\"><a class=\"markdownIt-Anchor\" href=\"#shell连接mongo命令\">#</a> Shell 连接 (mongo 命令)</h2>\n<p>在命令提示符输入以下 Shell 命令即可完成登录</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>mongo</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>或</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>mongo <span class=\"token parameter variable\">--host</span><span class=\"token operator\">=</span><span class=\"token number\">127.0</span>.0.1 <span class=\"token parameter variable\">--port</span><span class=\"token operator\">=</span><span class=\"token number\">27017</span></pre></td></tr></table></figure><p>查看已经有的数据库</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> show databases</pre></td></tr></table></figure><p>退出 mongodb</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> <span class=\"token builtin class-name\">exit</span></pre></td></tr></table></figure><p>更多参数可以通过帮助查看：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> mongo <span class=\"token parameter variable\">--help</span></pre></td></tr></table></figure><p>提示：</p>\n<p>MongoDB javascript Shell 是一个基于 javascript 的解释器，故是支持 js 程序的。</p>\n<h2 id=\"linux系统中的安装启动和连接\"><a class=\"markdownIt-Anchor\" href=\"#linux系统中的安装启动和连接\">#</a> Linux 系统中的安装启动和连接</h2>\n<p>目标：在 Linux 中部署一个单机的 MongoDB，作为生产环境下使用。</p>\n<p>提示：和 Windows 下操作差不多。</p>\n<p>步骤如下：</p>\n<ol>\n<li>先到官网下载压缩包：mongodb-linux-x86_64-4.0.10.tgz</li>\n<li>上传压缩包到 Linux 中 ，解压到当前目录</li>\n</ol>\n<pre><code>tar -xvf mongodb-linux-x86_64-4.0.10.tgz\n</code></pre>\n<ol start=\"3\">\n<li>移动解压后的文件夹到指定的目录中：</li>\n</ol>\n<pre><code>mv mongodb-linxu-x86_64-4.0.10 /usr/local/mongodb\n</code></pre>\n<ol start=\"4\">\n<li>新建几个目录，分别用来存储数据和日志：</li>\n</ol>\n<pre><code>#数据存储目录\nmkdir -p /mongodb/single/data/db\n#日志存储目录\nmkdir -p /mongodb/single/log\n</code></pre>\n<ol start=\"5\">\n<li>新建并修改配置文件</li>\n</ol>\n<pre><code>vi /mongodb/single/mongod.conf\n</code></pre>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>systemLog:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token comment\">#MongoDB 发送所有日志输出的目标指定为文件</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> <span class=\"token comment\">#The path of the log file to which mongod or mongos should send all diagnostic logging information</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre> destination: <span class=\"token function\">file</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> <span class=\"token comment\">#mongod 或 mongos 应向其发送所有诊断日志记录信息的日志文件的路径</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> path: <span class=\"token punctuation\">[</span>mongod.log绝对路径<span class=\"token punctuation\">]</span>比如：<span class=\"token string\">\"/mongodb/single/log/mongod.log\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre> <span class=\"token comment\">#当 mongos 或 mongod 实例重新启动时，mongos 或 mongod 会将新条目附加到现有日志文件的末尾。</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre> logAppend: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>storage:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre> <span class=\"token comment\">#mongod 实例存储其数据的目录。storage.dbPath 设置仅适用于 mongod。</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre> <span class=\"token comment\">#The directory where the mongod instance stores its data.Defaul value is \"/data/db\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre> dbPath: <span class=\"token string\">\"/mongodb/single/data/db\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre> journal:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token comment\">#启用或禁用持久性日志以确保数据文件保持有效和可恢复</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  enabled: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>processManagement:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token comment\">#启用在后台运行 mongos 或 mongod 进程的守护进程模式。</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  fork: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>net:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token comment\">#服务实例绑定 IP，默认是 localhost</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  bindIp: localhost192.168.0.2</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token comment\">#bindIp</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token comment\">#绑定的端口，默认是 27017</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  port: <span class=\"token number\">27017</span></pre></td></tr></table></figure><p>6. 启动 MongoDB 服务</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>dkx0@localhost<span class=\"token punctuation\">]</span>/% /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/single/log/mongod.conf </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>about to fork child process, waiting <span class=\"token keyword\">until</span> server is ready <span class=\"token keyword\">for</span> connections.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>forked process: <span class=\"token number\">2708</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>child process started successfully, parent exiting</pre></td></tr></table></figure><p>注意：</p>\n<p>如果启动后不是 successfully，则是启动失败了。原因基本上就是配置文件有问题</p>\n<p>通过进程来查看服务是否启动了：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>dkx0@localhost<span class=\"token punctuation\">]</span>/% <span class=\"token function\">ps</span> <span class=\"token parameter variable\">-ef</span> <span class=\"token operator\">|</span><span class=\"token function\">grep</span> mongod<span class=\"token operator\">|</span><span class=\"token function\">grep</span> <span class=\"token parameter variable\">-v</span> <span class=\"token function\">grep</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>dkx0       <span class=\"token number\">2708</span>      <span class=\"token number\">1</span>  <span class=\"token number\">1</span> 03:30 ?        00:00:05 /usr/local/mongodb/bin/mongod <span class=\"token parameter variable\">-f</span> /mongodb/single/log/mongod.conf</pre></td></tr></table></figure><p>7. 分别使用 mongo 命令和 compass 工具来连接测试</p>\n<p>提示：如果远程连接不上，需要配置防火墙放行，或直接关闭 Linux 防火墙</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#查看防火墙状态</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>systemctl status firewalld</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">#临时关闭防火墙</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>systemctl stop firewalld</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">#开机禁止启动防火墙</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>systemctl disable firewalld</pre></td></tr></table></figure><p>8. 停止关闭服务</p>\n<p>停止服务的方式有两种：快速关闭和标准关闭，下面依次说明：</p>\n<p>一，快速关闭方法 (快速，简单，数据可能会出错)</p>\n<p>目标：通过系统的 kill -9 命令直接杀死进程</p>\n<p>杀完要检查一下，避免有的没有杀掉</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#通过进程编号关闭节点</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">kill</span> <span class=\"token parameter variable\">-2</span> <span class=\"token number\">54410</span></pre></td></tr></table></figure><p>[补充]</p>\n<p>如果一旦是因为数据损坏，则需要进行如下操作：</p>\n<p>1. 删除 lock 文件</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">rm</span> <span class=\"token parameter variable\">-f</span> /mongodb/single/data/db/*.lock</pre></td></tr></table></figure><p>2. 修复数据：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>/usr/local/mongdb/bin/mongod <span class=\"token parameter variable\">--repair</span> <span class=\"token parameter variable\">--dbpath</span><span class=\"token operator\">=</span>/mongodb/single/data/db</pre></td></tr></table></figure><p>二，标准的关闭方法 (数据不容易出错，但麻烦)</p>\n<p>目标：通过 mongo 客户端中的 shutdownServer 命令来关闭服务。</p>\n<p>主要的操作步骤参考如下：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#客户端登录服务，注意，这里通过 localhost 登录，如果需要远程登录，必须先登录认证才行</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>mongo <span class=\"token parameter variable\">--port</span> <span class=\"token number\">27016</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">#切换到 admin 库</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>use admin</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">#关闭服务</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>db.shutdownServer<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>连接 linux 中的 mongo，指定 IP 和端口号即可。</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031656672.png\" alt=\"image-20230603154442420\"></p>\n",
            "tags": [
                "计算机学科",
                "database",
                "mongodb"
            ]
        },
        {
            "id": "https://pigpigletsgo.github.io/homepage/2024/04/02/computer-science/database/mongodb/MongoDB%E5%85%A5%E9%97%A8/",
            "url": "https://pigpigletsgo.github.io/homepage/2024/04/02/computer-science/database/mongodb/MongoDB%E5%85%A5%E9%97%A8/",
            "title": "MongoDB入门",
            "date_published": "2024-04-02T06:23:30.039Z",
            "content_html": "<h2 id=\"mongodb相关概念\"><a class=\"markdownIt-Anchor\" href=\"#mongodb相关概念\">#</a> MongoDB 相关概念</h2>\n<h3 id=\"业务应用场景\"><a class=\"markdownIt-Anchor\" href=\"#业务应用场景\">#</a> 业务应用场景</h3>\n<p>传统的关系型数据库 (如 MySQL)，在数据库操作的 &quot;三高&quot; 需求以及应对 Web2.0 的网站需求，显得力不从心</p>\n<p><strong>解释</strong>：“三高” <strong>需求</strong>：</p>\n<ul>\n<li>High performance - 对数据库高并发读写的需求。</li>\n<li>Huge Storage - 对海量数据的高效率存储和访问的需求。</li>\n<li>High Scalabillity &amp;&amp; High Availability - 对数据库的高可扩展性和高可用性的需求。</li>\n</ul>\n<p>而 MongoDB 可应对 &quot;三高&quot; 需求。</p>\n<p><strong>具体的应用场景如</strong>：</p>\n<ol>\n<li>社交场景，使用 MongoDB 存储用户信息，以及用户发表的朋友圈信息，通过地理位置索引实现附近的人，地点等功能。</li>\n<li>游戏场景，使用 MongoDB 存储游戏用户信息，用户的装备，积分等直接以内嵌文档的形式存储，方便查询，高效率存储和访问。</li>\n<li>物流场景，使用 MongoDB 存储订单信息，订单状态在运送过程中会不断更新，以 MongoDB 内嵌数据的形式来存储，一次查询就能将订单所有的变更读取出来。</li>\n<li>物联网场景，使用 MongoDB 存储所有接入的智能设备信息，以及设备汇报的日志信息，并对这些信息进行多维度的分析。</li>\n<li>视频直播，使用 MongoDB 存储用户信息，点赞互动信息等。</li>\n</ol>\n<p>这些应用场景中，数据操作方面的共同特点是：</p>\n<ol>\n<li>数据量大</li>\n<li>写入操作频繁 (读写很频繁)</li>\n<li>价值较低的数据，对事物要求性不高</li>\n</ol>\n<p>对于这样的数据，我们更适合使用 MongoDB 来实现数据的存储</p>\n<h3 id=\"什么时候选择mongodb\"><a class=\"markdownIt-Anchor\" href=\"#什么时候选择mongodb\">#</a> 什么时候选择 MongoDB</h3>\n<p>在构架选型上，除了上述的三个特点外，如果你还犹豫是否选择它，可以考虑以下的一些问题：</p>\n<p>应用不需要事务以及复杂 join 支持</p>\n<p>新应用，需求会变，数据模型无法确定，想快速迭代开发</p>\n<p>应用需要 2000~3000 以上的读写 QPS (更高也可以)</p>\n<p>应用需要 TB 甚至 PB 级别数据存储</p>\n<p>应用要求存储的数据不丢失</p>\n<p>应用需要 99.999% 高可用</p>\n<p>应用需要大量的地理位置查询，文本查询</p>\n<p>如果上述有 1 个符合，可以考虑 MongoDB，2 个以及的符合，选择 MongoDB 绝不会后悔</p>\n<p>思考：如果用 MySQL 呢？</p>\n<p>答：相对 MySQL，可以以更低的成本解决问题 (包括学习，开发，运维等成本)</p>\n<h3 id=\"mongodb简介\"><a class=\"markdownIt-Anchor\" href=\"#mongodb简介\">#</a> MongoDB 简介</h3>\n<p>MongoDB 是一个开源，高性能，无模式的文档型数据库，当初的设计就是用于简化开发和方便扩展，是 NoSQL 数据库产品的一种，是最像关系型数据库 (MySQL) 的非关系型数据库。</p>\n<p>它支持的数据结构非常松散，是一种类似于 JSON 的格式叫 BSON，所以它既可以存储比较复杂的数据类型，有相当灵活。</p>\n<p>MongoDB 中的记录是一个文档，它是一个由字段和值对 (field:value) 组成的数据结构，MongoDB 文档类似于 JSON 对象，即一个文档认为就是一个对象，字段的数据类型是字符串，它的值除了使用基本的一些类型外，还可以包括其它文档，普通数组和文档数组。</p>\n<h2 id=\"体系结构\"><a class=\"markdownIt-Anchor\" href=\"#体系结构\">#</a> 体系结构</h2>\n<p>MySQL 和 MongoDB 对比</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031701137.png\" alt=\"image-20230602204736615\"></p>\n<table>\n<thead>\n<tr>\n<th>SQL 术语 / 概念</th>\n<th>MongoDB 术语 / 概念</th>\n<th>解释 / 说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>database</td>\n<td>databse</td>\n<td>数据库</td>\n</tr>\n<tr>\n<td>table</td>\n<td>collection</td>\n<td>数据库表 / 集合</td>\n</tr>\n<tr>\n<td>row</td>\n<td>document</td>\n<td>数据记录行 / 文档</td>\n</tr>\n<tr>\n<td>column</td>\n<td>field</td>\n<td>数据字段 (列)/ 域 (字段)</td>\n</tr>\n<tr>\n<td>index</td>\n<td>index</td>\n<td>索引</td>\n</tr>\n<tr>\n<td>table joins</td>\n<td></td>\n<td>表连接，MongoDB 不支持</td>\n</tr>\n<tr>\n<td></td>\n<td>嵌入文档</td>\n<td>MongoDB 通过嵌入式文档来替代多表连接</td>\n</tr>\n<tr>\n<td>primary key</td>\n<td>primary key</td>\n<td>主键，MongoDB 自动将_id 字段设置为主键</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"数据模型\"><a class=\"markdownIt-Anchor\" href=\"#数据模型\">#</a> 数据模型</h2>\n<p>MongoDB 的最小存储单位就是文档 (document) 对象，文档 (document) 对象对应于关系型数据库的行，数据在 MongoDB 中以 BSON (Binary-JSON) 文档的格式存储在磁盘上。</p>\n<p>BSON (Binary Serialized Document Format) 是一种类似 json 的一种二进制形式的存储格式，简称 Binary JSON。</p>\n<p>BSON 和 JSON 一样，支持内嵌的文档对象和数组对象，但是 BSON 有 JSON 没有的一些数据类型，如 Date 和 BinData 类型。</p>\n<p>BSON 采用了类似于 C 语言结构体的名称，对表示方法，支持内嵌的文档对象和数组对象，具有轻量性，可遍历性，高效性的三个特点，可以有效描述非结构化数据的结构化数据。这种格式的优点是灵活性高，但它的缺点是空间利用率不是很理想。</p>\n<p>Bson 中，除了基本的 JSON 类型：string，integer，boolean，double，null，array 和 object，mongo 还是用了特殊的数据类型，这些类型包括 date，object，binary，data，regular，expression 和 code。每一个驱动都以特定语言的方式实现了这些类型，查看你的驱动的文档来获取详细信息。</p>\n<p>BSON 数据类型参考列表：</p>\n<table>\n<thead>\n<tr>\n<th>数据类型</th>\n<th>描述</th>\n<th>举例</th>\n</tr>\n</thead>\n<tbody>\n<tr x:foobar=\"\">\n<td>字符串</td>\n<td>UTF-8 字符串都可以表示为字符串类型的数据</td>\n<td></td>\n</tr>\n<tr x:ObjectId()=\"\">\n<td>对象 id</td>\n<td>对象 id 是文档的 12 字节的唯一 ID</td>\n<td></td>\n</tr>\n<tr>\n<td>布尔值</td>\n<td>真或者假：true 或者 false</td>\n<td>{“x”:true}+</td>\n</tr>\n<tr x:[a,b,c]=\"\">\n<td>数组</td>\n<td>值的集合或者列表可以表示成数组</td>\n<td></td>\n</tr>\n<tr>\n<td>32 位整数</td>\n<td>类型不可用，JavaScript 仅支持 64 位浮点数，所以 32 位整数会被自动转换</td>\n<td>shell 是不支持该类型的，shell 中默认会转换成 64 位浮点数</td>\n</tr>\n<tr x:3.14159,y:3=\"\">\n<td>64 位浮点数</td>\n<td>shell 中的数字就是一种类型</td>\n<td></td>\n</tr>\n<tr x:null=\"\">\n<td>null</td>\n<td>表示空值或者未定义的对象</td>\n<td></td>\n</tr>\n<tr x:undefined=\"\">\n<td>undefined</td>\n<td>文档中也可以使用未定义类型</td>\n<td></td>\n</tr>\n<tr>\n<td>符号</td>\n<td>shell 不支持，shell 会将数据库中的符号类型的数据自动转换成字符串</td>\n<td></td>\n</tr>\n<tr x:foobari=\"\">\n<td>正则表达式</td>\n<td>文档中可以包含正则表达式，采用 JavaScript 的正则表达式</td>\n<td></td>\n</tr>\n<tr>\n<td>代码</td>\n<td>文档中还可以包含 JavaScript 代码</td>\n<td>{“x”:function(){/* … */}}</td>\n</tr>\n<tr>\n<td>二进制数据</td>\n<td>二进制数据可以由任意字节的串组成，不过 shell 中无法使用</td>\n<td></td>\n</tr>\n<tr>\n<td>最大值 / 最小值</td>\n<td>BSON 包括一个特殊类型，表示可能的最大值 shell 中没有这个类型</td>\n<td></td>\n</tr>\n</tbody>\n</table>\n<p>提示：</p>\n<p>shell 默认使用 64 位浮点值。{“x”:3.14} 或 {“x”:3}。对于整型值，可以使用 NumberInt (4 个字节符号整数) 或 NumberLong (8 字节符号整数)，{“x”:NumberInt (“3”){“x”:NumberLong (“3”)}}</p>\n<h2 id=\"mongodb的特点\"><a class=\"markdownIt-Anchor\" href=\"#mongodb的特点\">#</a> MongoDB 的特点</h2>\n<p>MongoDB 主要有如下特点：</p>\n<p>1. 高性能</p>\n<p>MongoDB 提供高性能的数据持久性，特别是对嵌入式数据模型的支持减少了数据库系统上的 I/O 活动。</p>\n<p>索引支持更快的查询，并且可以包含来自嵌入式文档和数组的键。(文本索引解决搜索的要求，TTL 索引解决历史数据自动过期的需求，地理位置索引可用于构建各种 O2O 应用)</p>\n<p>mmapv1，wiredtiger，mongorocks (rocksdb)，in-memory 等多引擎支持满足各种场景需求。</p>\n<p>Gridfs 解决文件存储的需求。</p>\n<p>2. 高可用性</p>\n<p>MongoDB 的复制工具成为副本集 (replica set)，它可提供自动故障转移和数据冗余。</p>\n<p>3. 高扩展性</p>\n<p>MongoDB 提供了水平可扩展性作为其核心功能的一部分。</p>\n<p>分片将数据分布在一组集群的机器上。(海量数据存储，服务能力水平扩展)</p>\n<p>从 3.4 开始，MongoDB 支持基于片创建数据区域，在一个平衡的集群中，MongoDB 将一个区域所覆盖的读写只定向到该区域内的那些片。</p>\n<p>4. 丰富的查询支持</p>\n<p>MongoDB 支持丰富的查询语言，支持读和写操作 (CRUD)，比如数据聚合，文本搜索和地理空间查询等。</p>\n<p>5. 其它特点：如无模式 (动态模式)，灵活的文档模型</p>\n<h2 id=\"基本常用命令\"><a class=\"markdownIt-Anchor\" href=\"#基本常用命令\">#</a> 基本常用命令</h2>\n<h3 id=\"案例需求\"><a class=\"markdownIt-Anchor\" href=\"#案例需求\">#</a> 案例需求：</h3>\n<p>存放文章评论的数据存放到 MongoDB 中，数据结构参考如下：</p>\n<p>数据库：articledb</p>\n<table>\n<thead>\n<tr>\n<th>专栏文章评论</th>\n<th>comment</th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>字段名称</td>\n<td>字段含义</td>\n<td>字段类型</td>\n<td>备注</td>\n</tr>\n<tr>\n<td>_id</td>\n<td>ID</td>\n<td>ObjectId 或 String</td>\n<td>Mongo 的主键的字段</td>\n</tr>\n<tr>\n<td>articleid</td>\n<td>文章 ID</td>\n<td>String</td>\n<td></td>\n</tr>\n<tr>\n<td>content</td>\n<td>评论内容</td>\n<td>String</td>\n<td></td>\n</tr>\n<tr>\n<td>userid</td>\n<td>评论人 ID</td>\n<td>String</td>\n<td></td>\n</tr>\n<tr>\n<td>nickname</td>\n<td>评论人昵称</td>\n<td>String</td>\n<td></td>\n</tr>\n<tr>\n<td>createdatetime</td>\n<td>评论的日期时间</td>\n<td>Date</td>\n<td></td>\n</tr>\n<tr>\n<td>likenum</td>\n<td>点赞数</td>\n<td>int32</td>\n<td></td>\n</tr>\n<tr>\n<td>replynum</td>\n<td>回复数</td>\n<td>int32</td>\n<td></td>\n</tr>\n<tr>\n<td>state</td>\n<td>状态</td>\n<td>String</td>\n<td>0：不可见，1：可见</td>\n</tr>\n<tr>\n<td>parentid</td>\n<td>上级 ID</td>\n<td>String</td>\n<td>如果为 0 表示文章的顶级评论</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"数据库操作\"><a class=\"markdownIt-Anchor\" href=\"#数据库操作\">#</a> 数据库操作</h2>\n<h3 id=\"选择和创建数据库\"><a class=\"markdownIt-Anchor\" href=\"#选择和创建数据库\">#</a> 选择和创建数据库</h3>\n<p>选择和创建数据库的语法格式：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> use 数据库名称</pre></td></tr></table></figure><p>如果数据库不存在则自动创建，例如，以下语句创建 spitdb 数据库：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> use articledb</pre></td></tr></table></figure><p>查看有权限查看的所有数据库命令</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> show dbs</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>或</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">></span> show databases</pre></td></tr></table></figure><blockquote>\n<p>注意：在 MongoDB 中，集合只有在内容插入后才会创建！就是说，创建集合 (数据表) 后要再插入一个文档 (记录)，集合才会真正创建。</p>\n</blockquote>\n<p>查看当前正在使用的数据库命令</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db</pre></td></tr></table></figure><p>MongoDB 中默认的数据库为 test，如果你没有选择数据库，集合将存放在 test 数据库中。</p>\n<p>另外：</p>\n<p>数据库名可以是满足以下条件的任意 UTF-8 字符串。</p>\n<ul>\n<li>不能是空字符串 (&quot;&quot;)</li>\n<li>不得含有’ '(空格)，.，$，/，\\，和 \\0 (空字符)</li>\n<li>应全部小写</li>\n<li>最多 64 字节</li>\n</ul>\n<p>有一些数据库名是保留的，可以直接访问这些有特殊作用的数据库</p>\n<ul>\n<li>admin：从权限的角度来看，这是 &quot;roor&quot; 数据库，要是将一个用户添加到这个数据库，这个用户自动继承所有数据库的权限，一些特定的服务器端命令也只能从这个数据库运行，比如列出所有的数据库或者关闭服务器</li>\n<li>local：这个数据库的数据永远不会被复制，可以用来存储限于本地单台服务器的任意集合</li>\n<li>config：当 Mongo 用于分片设置时，config 数据库在内部使用，用于保存分片的相关信息</li>\n</ul>\n<p>创建数据库：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> show dbs</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>admin   <span class=\"token number\">0</span>.000GB</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>config  <span class=\"token number\">0</span>.000GB</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token builtin class-name\">local</span>   <span class=\"token number\">0</span>.000GB</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token operator\">></span> use articledb</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>switched to db articledb</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token operator\">></span> show dbs</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>admin   <span class=\"token number\">0</span>.000GB</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>config  <span class=\"token number\">0</span>.000GB</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token builtin class-name\">local</span>   <span class=\"token number\">0</span>.000GB</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr></table></figure><p>可以看到检查数据库时并没有 articledb 这是为什么呢，看如下解释：</p>\n<blockquote>\n<p>MongoDB 的存储分为两部分：当使用 use articledb 创建数据库时存放到了内存中了，没有持久化到磁盘所以使用 show dbs 是看不到的，当 articledb 中有一个集合的时候，不是一个空的数据库的时候就会自动持久化到磁盘中</p>\n</blockquote>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031701895.png\" alt=\"image-20230603161134922\"></p>\n<p>查看当前所在的数据库：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>articledb</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr></table></figure><h3 id=\"数据库的删除\"><a class=\"markdownIt-Anchor\" href=\"#数据库的删除\">#</a> 数据库的删除</h3>\n<p>MongoDB 删除数据库的语法格式如下：在要删除的数据库中执行</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.dropDatabase<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>提示：主要用来删除已经持久化的数据库</p>\n<h3 id=\"集合操作\"><a class=\"markdownIt-Anchor\" href=\"#集合操作\">#</a> 集合操作</h3>\n<p>集合，类似关系型数据库中的表</p>\n<p>可以显示的创建，也可以隐式的创建</p>\n<h3 id=\"集合的显示创建\"><a class=\"markdownIt-Anchor\" href=\"#集合的显示创建\">#</a> 集合的显示创建</h3>\n<p>基本语法格式：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.createCollection<span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>参数说明：</p>\n<ul>\n<li>name：要创建的集合名称</li>\n</ul>\n<p>例如：创建一个名为 mycollection 的普通集合</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.createCollection<span class=\"token punctuation\">(</span><span class=\"token string\">\"mycollection\"</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>查看当前数据库中的表：show tables 命令</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> show collections</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>或</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">></span> show tables</pre></td></tr></table></figure><p>集合的命名规范：</p>\n<ul>\n<li>集合名不能是空字符串</li>\n<li>集合名不能含有 \\0 字符 (空字符)，这个字符表示集合名的结尾</li>\n<li>集合名不能以 &quot;system.&quot; 开头，这是为系统集合保留的前缀</li>\n<li>用户创建的集合名字不能含有保留字符，有些驱动程序的确支持在集合名里面包含，这是因为某些系统生成的集合中包含该字符，除非你要访问这种系统创建的集合，否则千万不要在名字里出现 $</li>\n</ul>\n<h3 id=\"集合的隐式创建\"><a class=\"markdownIt-Anchor\" href=\"#集合的隐式创建\">#</a> 集合的隐式创建</h3>\n<p>当向一个集合插入一个文档的时候，如果集合不存在，则会自动创建集合。</p>\n<p>详见文档的插入 章节。</p>\n<p>提示：通常我们使用隐式创建文档即可。</p>\n<h3 id=\"集合的删除\"><a class=\"markdownIt-Anchor\" href=\"#集合的删除\">#</a> 集合的删除</h3>\n<p>集合的删除语法格式如下：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.collection.drop<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>或</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">></span> db.集合.drop<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p><strong>返回值</strong></p>\n<p>如果成功删除选定集合，则 drop () 方法返回 true，否则返回 false</p>\n<p>例如：要删除 mycollection 集合</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.mycollection.drop<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> show tables</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>name</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">></span> db.name.drop<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token operator\">></span> show tables</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr></table></figure><h2 id=\"文档基本crud\"><a class=\"markdownIt-Anchor\" href=\"#文档基本crud\">#</a> 文档基本 CRUD</h2>\n<p>文档 (document) 的数据结构和 JSON 基本一样。</p>\n<p>所有存储在集合中的数据都是 BSON 格式</p>\n<h3 id=\"文档的插入\"><a class=\"markdownIt-Anchor\" href=\"#文档的插入\">#</a> 文档的插入</h3>\n<h4 id=\"1单个文档插入\"><a class=\"markdownIt-Anchor\" href=\"#1单个文档插入\">#</a> 1. 单个文档插入</h4>\n<p>使用 insert () 或 save () 方法向集合中插入文档，语法格式如下：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.collection.insert<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>document or array of documents<span class=\"token operator\">></span>,</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t\twriteConcern: <span class=\"token operator\">&lt;</span>document<span class=\"token operator\">></span>,</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\tordered: <span class=\"token operator\">&lt;</span>boolean<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>参数：</p>\n<table>\n<caption id=\"\" style=\"caption-side: bottom\">示例</caption>\n<thead>\n<tr>\n<th>Parameter</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>document</td>\n<td>document or array</td>\n<td>要插入到集合中的文档或文档数组 (json 格式)</td>\n</tr>\n<tr>\n<td>writeConcern</td>\n<td>document</td>\n<td>Optional.A document expressing the write concern.Omit to use the<br>default write concern.See write <a href=\"http://Concern.Do\">Concern.Do</a> not explicitly set the write<br>concerrn for  the operation if run in a <a href=\"http://transaction.To\">transaction.To</a> use write concern<br>with transactions,see Transactions and Write Concern</td>\n</tr>\n<tr>\n<td>orrderd</td>\n<td>boolean</td>\n<td>可选，如果为真，则按顺序插入数组中的文档 ，如果其中一个文档出现错误，MongoDB 将返回而不处理数组中其余文档，如果为假，则执行无序插入，如果其中一个文档出现错误，则继续处理数组中的主文档，在版本 2.6 + 中默认为 true</td>\n</tr>\n</tbody>\n</table>\n<p>要向 comment 的集合 (表) 中插入一条测试数据：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.insert<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"articleid\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"10000\"</span>,<span class=\"token string\">\"content\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"今天天气真好\"</span>,<span class=\"token string\">\"userid\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"1001\"</span>,<span class=\"token string\">\"nickname\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"Rose\"</span>,<span class=\"token string\">\"createdatetime\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"now Date()\"</span>,<span class=\"token string\">\"likenum\"</span>:NumberInt<span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span>,<span class=\"token string\">\"state\"</span>:null<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>提示：</p>\n<ol>\n<li>comment 集合如果不存在，则会隐式创建</li>\n<li>mongo 中的数字，默认情况下是 double 类型，如果要存储整型，必须使用函数 NumberInt (整型数字)，否则取出来就有问题了</li>\n<li>插入当前日期使用 now Date ()</li>\n<li>插入的数据没有指定_id，会自动生成主键值</li>\n<li>如果某字段没有值，可以赋值为 null，或不写该字段</li>\n</ol>\n<p>执行后，如下，说明插入一个数据成功了。</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>WriteResult<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"nInserted\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>现在数据库中没有任何的集合：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> show tables</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr></table></figure><p>向一个不存在的集合插入数据：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.insert<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>uncaught exception: Error: no object passed to insert<span class=\"token operator\">!</span> <span class=\"token builtin class-name\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>DBCollection.prototype.insert@src/mongo/shell/collection.js:275:15</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>@<span class=\"token punctuation\">(</span>db.comment.insert<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"articleid\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"1000\"</span>,<span class=\"token string\">\"content\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"今天天气真好\"</span>,<span class=\"token string\">\"useid\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"1001\"</span>,<span class=\"token string\">\"inckname\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"Rose\"</span>,<span class=\"token string\">\"createdatetime\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"now Date()\"</span>,<span class=\"token string\">\"likenum\"</span>:NumberInt<span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span>,<span class=\"token string\">\"state\"</span>:null<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>001<span class=\"token string\">\",\"</span>incknam<span class=\"token string\">\"&#125;)</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>WriteResult(&#123; \"</span>nInserted\" <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token operator\">></span> show tables</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>comment</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr></table></figure><p>查看集合中插入的数据：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.<span class=\"token function-name function\">find</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> ObjectId<span class=\"token punctuation\">(</span><span class=\"token string\">\"647b250656447c36332f1c37\"</span><span class=\"token punctuation\">)</span>, <span class=\"token string\">\"articleid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1000\"</span>, <span class=\"token string\">\"content\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"今天天气真好\"</span>, <span class=\"token string\">\"useid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1001\"</span>, <span class=\"token string\">\"inckname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"Rose\"</span>, <span class=\"token string\">\"createdatetime\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"now Date()\"</span>, <span class=\"token string\">\"likenum\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">10</span>, <span class=\"token string\">\"state\"</span> <span class=\"token builtin class-name\">:</span> null <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr></table></figure><p>不存在的集合就被隐式的创建了。</p>\n<p><mark>注意</mark>：</p>\n<ol>\n<li>文档中 的键 / 值对是有序的</li>\n<li>文档中的值不仅可以是在双引号里面的字符串，还可以是其它几种数据类型 (甚至可以是整个嵌入的文档)</li>\n<li>MongoDB 区分类型和大小写</li>\n<li>MongoDB 的文档不能有重复的键</li>\n<li>文档的键是字符串，除了少数例外情况，键可以使用任意 UTF-8 字符</li>\n</ol>\n<p>文档键命名规范：</p>\n<ul>\n<li>键不能含有 \\0 (空字符)，这个字符用来表示键的结尾。</li>\n<li>. 和 $ 有特别的意义，只有在特定环境下才能使用</li>\n<li>以下划线 &quot;_&quot; 开头的键是保留的 (不是严格要求的)</li>\n</ul>\n<h4 id=\"2批量插入\"><a class=\"markdownIt-Anchor\" href=\"#2批量插入\">#</a> 2. 批量插入</h4>\n<p>语法：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.collection.insertMany<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token operator\">&lt;</span>document <span class=\"token operator\"><span class=\"token file-descriptor important\">1</span>></span>,<span class=\"token operator\">&lt;</span>document <span class=\"token operator\"><span class=\"token file-descriptor important\">2</span>></span><span class=\"token punctuation\">]</span>,<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\twriteConcern: <span class=\"token operator\">&lt;</span>document<span class=\"token operator\">></span>,</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tordered: <span class=\"token operator\">&lt;</span>boolean<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>参数：</p>\n<table>\n<caption id=\"\" style=\"caption-side: bottom\">示例</caption>\n<thead>\n<tr>\n<th>Parameter</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>document</td>\n<td>document</td>\n<td>要插入到集合中的文档或文档数组 (json 格式)</td>\n</tr>\n<tr>\n<td>writeConcern</td>\n<td>document</td>\n<td>Optional.A document expressing the write concern.Omit to use the default write <a href=\"http://concern.Do\">concern.Do</a> not explicitly set the write concern for the operation if run in a transaction. To use write concern with<br>transactions,see Transactions and write concern</td>\n</tr>\n<tr>\n<td>ordered</td>\n<td>boolean</td>\n<td>可选，一个布尔值，指定 Mongod 示例执行有序插入还是无序插入，默认为 true</td>\n</tr>\n</tbody>\n</table>\n<p>批量插入多条文章评论：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.insertMany<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"_id\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"1\"</span>,<span class=\"token string\">\"articleid\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"10001\"</span>,<span class=\"token string\">\"contet\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"我们不应该把清晨浪费在手机上，健康很重要，一杯温水幸福你我他\"</span>,<span class=\"token string\">\"userid\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"1002\"</span>,<span class=\"token string\">\"nickname\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"相忘于江湖\"</span>,<span class=\"token string\">\"createdatatime\"</span>:new Date<span class=\"token punctuation\">(</span><span class=\"token string\">\"2019-08-05T22:08:15.522Z\"</span>,<span class=\"token string\">\"likenum\"</span>:NumberInt<span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span>,<span class=\"token string\">\"state\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"1\"</span><span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"_id\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"2\"</span>,<span class=\"token string\">\"articleid\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"10001\"</span>,<span class=\"token string\">\"contet\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"我夏天空腹喝凉开水，冬天喝温开水\"</span>,<span class=\"token string\">\"userid\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"1005\"</span>,<span class=\"token string\">\"nickname\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"伊人憔悴\"</span>,<span class=\"token string\">\"createdatatime\"</span>:new Date<span class=\"token punctuation\">(</span><span class=\"token string\">\"2019-08-05T22:58:51.485Z\"</span>,<span class=\"token string\">\"likenum\"</span>:NumberInt<span class=\"token punctuation\">(</span><span class=\"token number\">888</span><span class=\"token punctuation\">)</span>,<span class=\"token string\">\"state\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"1\"</span><span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"_id\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"3\"</span>,<span class=\"token string\">\"articleid\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"10001\"</span>,<span class=\"token string\">\"contet\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"我一直喝凉开水，冬天夏天都喝\"</span>,<span class=\"token string\">\"userid\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"1004\"</span>,<span class=\"token string\">\"nickname\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"杰克船长\"</span>,<span class=\"token string\">\"createdatatime\"</span>:new Date<span class=\"token punctuation\">(</span><span class=\"token string\">\"2019-08-05T22:05:51.485Z\"</span>,<span class=\"token string\">\"likenum\"</span>:NumberInt<span class=\"token punctuation\">(</span><span class=\"token number\">888</span><span class=\"token punctuation\">)</span>,<span class=\"token string\">\"state\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"1\"</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>提示：</p>\n<p>插入时指定了_id，则主键就是该值</p>\n<p>如果某条数据插入失败，将会终止插入，但已经插入成功的数据不会回滚掉</p>\n<p>因为批量插入由于数据较多容易出现失败，因为，可以使用 try catch 进行异常捕获处理，测试的时候可以不处理，如 (了解)：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> try<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\tdb.comment.insertMany<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"_id\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"1\"</span>,<span class=\"token string\">\"articleid\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"10001\"</span>,<span class=\"token string\">\"contet\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"我们不应该把清晨浪费在手机上，健康很重要，一杯温水幸福你我他\"</span>,<span class=\"token string\">\"userid\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"1002\"</span>,<span class=\"token string\">\"nickname\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"相忘于江湖\"</span>,<span class=\"token string\">\"createdatatime\"</span>:new Date<span class=\"token punctuation\">(</span><span class=\"token string\">\"2019-08-05T22:08:15.522Z\"</span>,<span class=\"token string\">\"likenum\"</span>:NumberInt<span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span>,<span class=\"token string\">\"state\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"1\"</span><span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"_id\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"2\"</span>,<span class=\"token string\">\"articleid\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"10001\"</span>,<span class=\"token string\">\"contet\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"我夏天空腹喝凉开水，冬天喝温开水\"</span>,<span class=\"token string\">\"userid\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"1005\"</span>,<span class=\"token string\">\"nickname\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"伊人憔悴\"</span>,<span class=\"token string\">\"createdatatime\"</span>:new Date<span class=\"token punctuation\">(</span><span class=\"token string\">\"2019-08-05T22:58:51.485Z\"</span>,<span class=\"token string\">\"likenum\"</span>:NumberInt<span class=\"token punctuation\">(</span><span class=\"token number\">888</span><span class=\"token punctuation\">)</span>,<span class=\"token string\">\"state\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"1\"</span><span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"_id\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"3\"</span>,<span class=\"token string\">\"articleid\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"10001\"</span>,<span class=\"token string\">\"contet\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"我一直喝凉开水，冬天夏天都喝\"</span>,<span class=\"token string\">\"userid\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"1004\"</span>,<span class=\"token string\">\"nickname\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"杰克船长\"</span>,<span class=\"token string\">\"createdatatime\"</span>:new Date<span class=\"token punctuation\">(</span><span class=\"token string\">\"2019-08-05T22:05:51.485Z\"</span>,<span class=\"token string\">\"likenum\"</span>:NumberInt<span class=\"token punctuation\">(</span><span class=\"token number\">888</span><span class=\"token punctuation\">)</span>,<span class=\"token string\">\"state\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"1\"</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span>catch<span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tprint<span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> try<span class=\"token punctuation\">&#123;</span>db.comment.insertMany<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"_id\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"1\"</span>,<span class=\"token string\">\"articleid\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"10001\"</span><span class=\"token punctuation\">&#125;</span>,<span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"_id\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"2\"</span>,<span class=\"token string\">\"articleid\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"10001\"</span><span class=\"token punctuation\">&#125;</span>,<span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"_id\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"3\"</span>,<span class=\"token string\">\"articleid\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"10001\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span>catch<span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>print<span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"acknowledged\"</span> <span class=\"token builtin class-name\">:</span> true, <span class=\"token string\">\"insertedIds\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"1\"</span>, <span class=\"token string\">\"2\"</span>, <span class=\"token string\">\"3\"</span> <span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr></table></figure><ul>\n<li>测试 - 嫌麻烦添加了比较少的数据</li>\n</ul>\n<h2 id=\"文档的基本查询\"><a class=\"markdownIt-Anchor\" href=\"#文档的基本查询\">#</a> 文档的基本查询</h2>\n<p>查询数据的语法格式如下：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.collection.find<span class=\"token punctuation\">(</span><span class=\"token operator\">&lt;</span>query<span class=\"token operator\">></span>,<span class=\"token punctuation\">[</span>projection<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>参数：</p>\n<table>\n<caption id=\"\" style=\"caption-side: bottom\">示例</caption>\n<thead>\n<tr>\n<th>Parameter</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>query</td>\n<td>document</td>\n<td>可选，使用查询运算符指定选择筛选器，若要返回集合中的所有文档，请省略此参数或传递空文档 ({})</td>\n</tr>\n<tr>\n<td>projection</td>\n<td>document</td>\n<td>可选，指定要在与查询筛选器匹配的文档中返回的字段 (投影)，诺要返回匹配文档中的所有字段，请省略此参数</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"1查询所有\"><a class=\"markdownIt-Anchor\" href=\"#1查询所有\">#</a> 1. 查询所有</h3>\n<p>如果我们要查询 spit 集合的所有文档，我们输入以下命令：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>db.comment.find<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>或</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>db.comment.find<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>这里你会发现每条文档会有一个叫_id 的字段，这个相当于我们原来关系型数据库中表的主键，当你在插入文档记录时没有 指定该字段，MongoDB 会自动创建，其类型是 ObjectID 类型</p>\n<p>如果我们在插入文档记录时指定该字段也可以，其类型可以是 ObjectID 类型，也可以是 MongoDB 支持的任意类型</p>\n<p>如果我想按一定条件来查询，比如我想查询 userid 为 1003 的记录，怎么办？很简单！只要在 find () 中添加参数即可，参数也是 json 格式，如下：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.find<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"articleid\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"10001\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1\"</span>, <span class=\"token string\">\"articleid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"10001\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2\"</span>, <span class=\"token string\">\"articleid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"10001\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"3\"</span>, <span class=\"token string\">\"articleid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"10001\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token operator\">></span> db.comment.find<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"articleid\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"10001\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token number\">2</span><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1\"</span>, <span class=\"token string\">\"articleid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"10001\"</span> <span class=\"token punctuation\">&#125;</span><span class=\"token number\">3</span><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2\"</span>, <span class=\"token string\">\"articleid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"10001\"</span> <span class=\"token punctuation\">&#125;</span><span class=\"token number\">4</span><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"3\"</span>, <span class=\"token string\">\"articleid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"10001\"</span> <span class=\"token punctuation\">&#125;</span><span class=\"token operator\"><span class=\"token file-descriptor important\">5</span>></span>db.comment.find<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>userid:<span class=\"token string\">'1003'</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>如果你只需要返回符合条件的第一条数据，我们可以使用 findOne 命令来实现，语法和 find 一样。</p>\n<p>如：查询用户编号是 1003 的记录，但只最多返回符合条件的第一条记录：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.findOne<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"articleid\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"10001\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1\"</span>, <span class=\"token string\">\"articleid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"10001\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr></table></figure><p>2. 投影查询 (Projection Query)</p>\n<p>如果要查询结果返回部分字段，则需要使用投影查询 (不显示所有字段，只显示指定的字段)</p>\n<p>如：查询结果只显示 <code>_id，aticleid，nickname</code></p>\n<pre><code>&gt; db.comment.find(&#123;aticleid:&quot;10001&quot;&#125;,&#123;aticleid:1,nickname:1&#125;)\n&#123; &quot;_id&quot; : &quot;1&quot;, &quot;aticleid&quot; : &quot;10001&quot;, &quot;nickname&quot; : &quot;Rose&quot; &#125;\n&gt;\n</code></pre>\n<p>默认 <code>_id</code>  会显示</p>\n<p>如：查询结果只显示，aticleid，nickname，不显示 <code>_id</code>  :</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.find<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>aticleid:<span class=\"token string\">\"10001\"</span><span class=\"token punctuation\">&#125;</span>,<span class=\"token punctuation\">&#123;</span>aticleid:1,nickname:1,_id:0<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"aticleid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"10001\"</span>, <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"Rose\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr></table></figure><p>再例如：查询所有数据，但只显示_id，aticleid，nickname；</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.find<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>,<span class=\"token punctuation\">&#123;</span>aticleid:1,nickname:1<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1\"</span>, <span class=\"token string\">\"aticleid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"10001\"</span>, <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"Rose\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr></table></figure><h2 id=\"文档的更新\"><a class=\"markdownIt-Anchor\" href=\"#文档的更新\">#</a> 文档的更新</h2>\n<p>更新文档的语法：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>db.collection.update<span class=\"token punctuation\">(</span>query,update,options<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>或</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>db.collection.update<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>query<span class=\"token operator\">></span>,</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>update<span class=\"token operator\">></span>,</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\tupsert: <span class=\"token operator\">&lt;</span>boolean<span class=\"token operator\">></span>,</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\tmulti: <span class=\"token operator\">&lt;</span>boolean<span class=\"token operator\">></span>,</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\twriteConcern: <span class=\"token operator\">&lt;</span>document<span class=\"token operator\">></span>,</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\tcollation: <span class=\"token operator\">&lt;</span>document<span class=\"token operator\">></span>,</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\tarrayFilters: <span class=\"token punctuation\">[</span><span class=\"token operator\">&lt;</span>filterdocument<span class=\"token operator\"><span class=\"token file-descriptor important\">1</span>></span>,<span class=\"token punctuation\">..</span>.<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\thint: <span class=\"token operator\">&lt;</span>document<span class=\"token operator\">|</span>string<span class=\"token operator\">></span> //Available starting <span class=\"token keyword\">in</span> MongoDB <span class=\"token number\">4.2</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>参数：</p>\n<table>\n<thead>\n<tr>\n<th>Parameter</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>query</td>\n<td>document</td>\n<td>更新的选择条件，可以使用与 find () 方法中相同的查询选择器，类似 sql update 查询内 where 后面的，在 3.0 版中进行了更改：当使用 upsert:true 执行 update () 时，如果查询使用点表示法存在_id 字段上指定条件，则 MongoDB 将拒绝插入新文档</td>\n</tr>\n<tr>\n<td>update</td>\n<td>document or pipeline</td>\n<td>要应用的修改，该值可以是：包含更新运算符表达式的文档，或仅包含<field1>: <value>对的替换文档，或在 MongoDB4.2 中启动聚合管道，管道可以由以下阶段组成：<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>a</mi><mi>d</mi><mi>d</mi><mi>F</mi><mi>I</mi><mi>e</mi><mi>l</mi><mi>d</mi><mi>s</mi><mtext>及其别名</mtext><mi mathvariant=\"normal\">‘</mi></mrow><annotation encoding=\"application/x-tex\">addFIelds及其别名`</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">F</span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">s</span><span class=\"mord cjk_fallback\">及</span><span class=\"mord cjk_fallback\">其</span><span class=\"mord cjk_fallback\">别</span><span class=\"mord cjk_fallback\">名</span><span class=\"mord\">‘</span></span></span></span> <code>set</code> <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"normal\">‘</mi><mi>p</mi><mi>r</mi><mi>o</mi><mi>j</mi><mi>e</mi><mi>c</mi><mi>t</mi><mtext>及其别名</mtext><mi mathvariant=\"normal\">‘</mi></mrow><annotation encoding=\"application/x-tex\">`project及其别名`</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord\">‘</span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.05724em;\">j</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">t</span><span class=\"mord cjk_fallback\">及</span><span class=\"mord cjk_fallback\">其</span><span class=\"mord cjk_fallback\">别</span><span class=\"mord cjk_fallback\">名</span><span class=\"mord\">‘</span></span></span></span> <code>unset</code> <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"normal\">‘</mi><mi>r</mi><mi>e</mi><mi>p</mi><mi>l</mi><mi>a</mi><mi>c</mi><mi>e</mi><mi>r</mi><mi>o</mi><mi>o</mi><mi>t</mi><mtext>及其别名</mtext><mi mathvariant=\"normal\">‘</mi></mrow><annotation encoding=\"application/x-tex\">`replaceroot及其别名`</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord\">‘</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">t</span><span class=\"mord cjk_fallback\">及</span><span class=\"mord cjk_fallback\">其</span><span class=\"mord cjk_fallback\">别</span><span class=\"mord cjk_fallback\">名</span><span class=\"mord\">‘</span></span></span></span> <code>replaceWith，换句话说：它是update的对象和一些更新的操作符(如</code> <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"normal\">‘</mi><mo separator=\"true\">,</mo><mi mathvariant=\"normal\">‘</mi></mrow><annotation encoding=\"application/x-tex\">`,`</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord\">‘</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">‘</span></span></span></span>`inc…) 等，也可以理解为 sql update 查询内 set 后面的值</td>\n</tr>\n<tr>\n<td>upsert</td>\n<td>boolean</td>\n<td>可选，如果设置为 true，则在没有与查询条件匹配的文档时创建新文档，默认值为 false，如果找不到匹配项，则不会插入新文档</td>\n</tr>\n<tr>\n<td>multi</td>\n<td>boolean</td>\n<td>可选，如果设置为 true，则更新符合查询条件的多个文档，如果设置为 false，则更新一个文档，默认值为 fasle</td>\n</tr>\n<tr>\n<td>writeConcern</td>\n<td>document</td>\n<td>可选，表示写问题的文档，抛出异常的级别</td>\n</tr>\n<tr>\n<td>collation</td>\n<td>document</td>\n<td>可选<br>指定要用于操作的校对规则<br>校对规则允许用户为字符串比较指定特定与语言的规则，例如字母大小写和重音标记的规则<br>校对规则选项具有以下语句：<br>校对规则：{<br>区域设置:<string>,<br>caseLevel:<boolean>,<br>caseFirst:<string>,<br>强度:<int>,<br>numericordering:<boolean>,<br>替代:<string>,<br>最大变量:<string>,<br>向后:<boolean><br>}<br>指定校对规则时，区域设置字段是必须得，所有其它校对规则字段都是可选的，有关字段的说明，请参阅校对规则文档<br>如果未指定校对规则，但集合具有默认校对规则 (请参见 db.createCollection ())，则该操作将使用为集合指定的校对规则。<br>如果没有为集合或操作指定校对规则，MongoDB 将使用以前的版本中使用的简单二进制比较进行字符串比较，不能为一个操作指定多个校对规则，例如，不能为每个字段指定不同的校对规则，或者如果使用排序执行查找，则不能将一个校对规则用于查找，另一个校对规则用于排序<br>3.4 版新增</td>\n</tr>\n<tr>\n<td>arrayFilters</td>\n<td>array</td>\n<td>可选，一个筛选文档数组，用于确定要为数组字段上的更新操作修改那些数组元素，在更新文档中，使用 [ <code>$</code> <a href=\"\"></a>{}] 筛选的位置运算符来定义标识符，然后咋子数组过滤器文档中应用，如果标识符未包含在更新文档中，则不能有标识符的数组筛选器文档，注意，<identifier>必须以小写字母开头，并且只包含字母数字字符，您可以在更新文档中多次包含同一标识符：但是，对于 r 在更新文档中，每个不同的标识符 ( <code>$</code> [标识符]) 都必须指定一个对应的数组筛选器文档，也就是说，不能为同一个标识符指定多个数组筛选器文档，3.6 版 +</td>\n</tr>\n<tr>\n<td>hint</td>\n<td>Document or string</td>\n<td>可选，指定用于支持查询谓词的索引的文档或字符串，该选项可以采用索引规范文档或索引名称字符串，如果指定的索引不存在，则说明操作错误，例如：版本 4 中的 未更新操作指定提示</td>\n</tr>\n</tbody>\n</table>\n<p>提示：</p>\n<p>主要关注前四个参数即可</p>\n<p>[示例]</p>\n<h3 id=\"1覆盖的修改\"><a class=\"markdownIt-Anchor\" href=\"#1覆盖的修改\">#</a> 1. 覆盖的修改</h3>\n<p>如果我们想修改_id 为 1 的记录，点赞量为 1001，输入以下语句</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.update<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>_id:<span class=\"token string\">\"1\"</span><span class=\"token punctuation\">&#125;</span>,<span class=\"token punctuation\">&#123;</span>likenum:NumberInt<span class=\"token punctuation\">(</span><span class=\"token number\">1001</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.update<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>_id:1<span class=\"token punctuation\">&#125;</span>,<span class=\"token punctuation\">&#123;</span>likenum:NumberInt<span class=\"token punctuation\">(</span><span class=\"token number\">1001</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>WriteResult<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"nMatched\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>, <span class=\"token string\">\"nUpserted\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>, <span class=\"token string\">\"nModified\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">></span> db.comment.find<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#注意这里的_id 为 1 的我不小心设置为了数据型的，而_id 为 2 设置为字符串型更改时也要对应数据类型才能找得到</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>, <span class=\"token string\">\"likenum\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1001</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2\"</span>, <span class=\"token string\">\"articleid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"10001\"</span>, <span class=\"token string\">\"likenum\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">889</span>, <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"凯撒大帝\"</span>, <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1003\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr></table></figure><p>执行后，我们会发现，这条文档除了 likenum 字段其它字段都不见了</p>\n<h3 id=\"2局部修改\"><a class=\"markdownIt-Anchor\" href=\"#2局部修改\">#</a> 2. 局部修改</h3>\n<p>为了解决这个问题，我们需要使用修改器 <code>$</code> set 来实现，命令如下：</p>\n<p>我们想修改_id 为 2 的记录，浏览量为 889，输入以下语句：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.update<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>_id:2<span class=\"token punctuation\">&#125;</span>,<span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$set</span>:<span class=\"token punctuation\">&#123;</span>likenum:NumberInt<span class=\"token punctuation\">(</span><span class=\"token number\">889</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.update<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>_id:<span class=\"token string\">\"2\"</span><span class=\"token punctuation\">&#125;</span>,<span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$set</span>:<span class=\"token punctuation\">&#123;</span>likenum:NumberInt<span class=\"token punctuation\">(</span><span class=\"token number\">889</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>WriteResult<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"nMatched\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>, <span class=\"token string\">\"nUpserted\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>, <span class=\"token string\">\"nModified\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">></span> db.comment.<span class=\"token function-name function\">find</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>, <span class=\"token string\">\"articleid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"10001\"</span>, <span class=\"token string\">\"likenum\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span>, <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"刘桑\"</span>, <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1003\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2\"</span>, <span class=\"token string\">\"articleid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"10001\"</span>, <span class=\"token string\">\"likenum\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">889</span>, <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"小花\"</span>, <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1003\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr></table></figure><p>这样就 OK 了</p>\n<h3 id=\"3批量的修改\"><a class=\"markdownIt-Anchor\" href=\"#3批量的修改\">#</a> 3. 批量的修改</h3>\n<p>更新所有用户为 1003 的用户的昵称为 凯撒大帝</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#默认只修改第一条数据</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token operator\">></span> db.comment.update<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>userid:<span class=\"token string\">\"1003\"</span><span class=\"token punctuation\">&#125;</span>,<span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$set</span>:<span class=\"token punctuation\">&#123;</span>nickname:<span class=\"token string\">\"凯撒2\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">#修改所有符合条件的数据</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">></span> db.comment.update<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>userid:<span class=\"token string\">\"1003\"</span><span class=\"token punctuation\">&#125;</span>,<span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$set</span>:<span class=\"token punctuation\">&#123;</span>nickname:<span class=\"token string\">\"凯撒大帝\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span>,<span class=\"token punctuation\">&#123;</span>multi:true<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.update<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>userid:<span class=\"token string\">\"1003\"</span><span class=\"token punctuation\">&#125;</span>,<span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$set</span>:<span class=\"token punctuation\">&#123;</span>nickname:<span class=\"token string\">\"凯撒大帝\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span>,<span class=\"token punctuation\">&#123;</span>multi:true<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>WriteResult<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"nMatched\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span>, <span class=\"token string\">\"nUpserted\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>, <span class=\"token string\">\"nModified\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">></span> db.comment.<span class=\"token function-name function\">find</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>, <span class=\"token string\">\"articleid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"10001\"</span>, <span class=\"token string\">\"likenum\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span>, <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"凯撒大帝\"</span>, <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1003\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2\"</span>, <span class=\"token string\">\"articleid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"10001\"</span>, <span class=\"token string\">\"likenum\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">889</span>, <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"凯撒大帝\"</span>, <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1003\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr></table></figure><p>提示：</p>\n<p>如果不加后面的参数，则只更新符合条件的第一条记录</p>\n<h3 id=\"3列值增长的修改\"><a class=\"markdownIt-Anchor\" href=\"#3列值增长的修改\">#</a> 3. 列值增长的修改</h3>\n<p>如果我们想实现对某列值在原有值的基础上进行增加或减少，可以使用 <code>$</code> inc 运算符来实现。</p>\n<p>需求：对 3 号数据的点赞数，每次递增 1</p>\n<pre><code>&gt; db.comment.update(&#123;_id:1&#125;,&#123;$inc:&#123;likenum:NumberInt(1)&#125;&#125;)\n</code></pre>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.update<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>_id:1<span class=\"token punctuation\">&#125;</span>,<span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$inc</span>:<span class=\"token punctuation\">&#123;</span>likenum:NumberInt<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>WriteResult<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"nMatched\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>, <span class=\"token string\">\"nUpserted\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>, <span class=\"token string\">\"nModified\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">></span> db.comment.<span class=\"token function-name function\">find</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>, <span class=\"token string\">\"likenum\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1002</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2\"</span>, <span class=\"token string\">\"articleid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"10001\"</span>, <span class=\"token string\">\"likenum\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">889</span>, <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"凯撒大帝\"</span>, <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1003\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.update<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>userid:<span class=\"token string\">\"1003\"</span><span class=\"token punctuation\">&#125;</span>,<span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$inc</span>:<span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"likenum\"</span>:NumberInt<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span>,<span class=\"token punctuation\">&#123;</span>multi:true<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>WriteResult<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"nMatched\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span>, <span class=\"token string\">\"nUpserted\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>, <span class=\"token string\">\"nModified\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">></span> db.comment.<span class=\"token function-name function\">find</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1\"</span>, <span class=\"token string\">\"articleid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"10001\"</span>, <span class=\"token string\">\"likenum\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1003</span>, <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"凯撒大帝\"</span>, <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1003\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2\"</span>, <span class=\"token string\">\"articleid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"10002\"</span>, <span class=\"token string\">\"likenum\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">890</span>, <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"凯撒大帝\"</span>, <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1003\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr></table></figure><h2 id=\"删除文档\"><a class=\"markdownIt-Anchor\" href=\"#删除文档\">#</a> 删除文档</h2>\n<p>删除文档的语法结构：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.集合名称.remove<span class=\"token punctuation\">(</span>条件<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>以下语句可以将数据全部删除，请慎用</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.remove<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>如果删除_id=1 的记录，输入以下语句，删除条件有多个会删除多个</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.remove<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>_id:<span class=\"token string\">\"1\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.<span class=\"token function-name function\">find</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1\"</span>, <span class=\"token string\">\"articleid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"10001\"</span>, <span class=\"token string\">\"likenum\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1003</span>, <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"凯撒大帝\"</span>, <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1003\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2\"</span>, <span class=\"token string\">\"articleid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"10002\"</span>, <span class=\"token string\">\"likenum\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">890</span>, <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"凯撒大帝\"</span>, <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1003\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">></span> db.comment.remove<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>_id:<span class=\"token string\">\"1\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>WriteResult<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"nRemoved\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token operator\">></span> db.comment.<span class=\"token function-name function\">find</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2\"</span>, <span class=\"token string\">\"articleid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"10002\"</span>, <span class=\"token string\">\"likenum\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">890</span>, <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"凯撒大帝\"</span>, <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1003\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.<span class=\"token function-name function\">find</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2\"</span>, <span class=\"token string\">\"articleid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"10002\"</span>, <span class=\"token string\">\"likenum\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">890</span>, <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"凯撒大帝\"</span>, <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1003\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1\"</span>, <span class=\"token string\">\"articleid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"10001\"</span>, <span class=\"token string\">\"likenum\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1003</span>, <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"凯撒大帝\"</span>, <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1003\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">></span> db.comment.remove<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>userid:<span class=\"token string\">\"1003\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>WriteResult<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"nRemoved\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token operator\">></span> db.comment.find<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr></table></figure><h2 id=\"文档的分页查询\"><a class=\"markdownIt-Anchor\" href=\"#文档的分页查询\">#</a> 文档的分页查询</h2>\n<h3 id=\"统计查询\"><a class=\"markdownIt-Anchor\" href=\"#统计查询\">#</a> 统计查询</h3>\n<p>统计查询使用 count () 方法，语法如下：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.collection.count<span class=\"token punctuation\">(</span>query,options<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>参数：</p>\n<table>\n<caption id=\"\" style=\"caption-side: bottom\">示例</caption>\n<thead>\n<tr>\n<th>Parameter</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>query</td>\n<td>document</td>\n<td>查询选择条件</td>\n</tr>\n<tr>\n<td>options</td>\n<td>document</td>\n<td>可选，用于修改统计数的额外选项</td>\n</tr>\n</tbody>\n</table>\n<p>1. 统计所有记录数：</p>\n<p>统计 comment 集合的所有的记录数：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.count<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr></table></figure><p>2. 按条件统计记录：</p>\n<p>例如：统计 userid 为 1003 的记录条数</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.count<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>userid:<span class=\"token string\">\"1003\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">></span> db.comment.count<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>_id:<span class=\"token string\">\"1\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token operator\">></span> db.comment.count<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>_id:<span class=\"token string\">\"2\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr></table></figure><p>提示：</p>\n<p>默认情况下 count () 方法返回符合条件的全部记录条数</p>\n<h3 id=\"分页列表查询\"><a class=\"markdownIt-Anchor\" href=\"#分页列表查询\">#</a> 分页列表查询</h3>\n<p>可以使用 limit () 方法来读取指定数量的数据，使用 skip () 方法来跳过指定数量的数据</p>\n<p>基本语法格式如下：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.COLLECTION_NAME.find<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>.limit<span class=\"token punctuation\">(</span>NUMBER<span class=\"token punctuation\">)</span>.skip<span class=\"token punctuation\">(</span>NUMBER<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.find<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>.limit<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>.skip<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2\"</span>, <span class=\"token string\">\"articleid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"10002\"</span>, <span class=\"token string\">\"likenum\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">890</span>, <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"凯撒大帝\"</span>, <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1003\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">></span> db.comment.find<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>.limit<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>.skip<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">></span> db.comment.find<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>.limit<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>.skip<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1\"</span>, <span class=\"token string\">\"articleid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"10001\"</span>, <span class=\"token string\">\"likenum\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1003</span>, <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"凯撒大帝\"</span>, <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1003\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2\"</span>, <span class=\"token string\">\"articleid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"10002\"</span>, <span class=\"token string\">\"likenum\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">890</span>, <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"凯撒大帝\"</span>, <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1003\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token operator\">></span> db.comment.find<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>.limit<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>.skip<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1\"</span>, <span class=\"token string\">\"articleid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"10001\"</span>, <span class=\"token string\">\"likenum\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1003</span>, <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"凯撒大帝\"</span>, <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1003\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>如果你想返回指定条数的记录，可以在 find 方法后调用 limit 来返回结果 (TopN)，默认值 20，例如：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.find<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>.limit<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.find<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>.limit<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1\"</span>, <span class=\"token string\">\"articleid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"10001\"</span>, <span class=\"token string\">\"likenum\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1003</span>, <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"凯撒大帝\"</span>, <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1003\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2\"</span>, <span class=\"token string\">\"articleid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"10002\"</span>, <span class=\"token string\">\"likenum\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">890</span>, <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"凯撒大帝\"</span>, <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1003\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr></table></figure><p>skip 方法同样接受一个数字参数作为跳过的记录条数，(前 N 个不要)，默认值是 0</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.find<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>.skip<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.find<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>.skip<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token operator\">></span> db.comment.find<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>.skip<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2\"</span>, <span class=\"token string\">\"articleid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"10002\"</span>, <span class=\"token string\">\"likenum\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">890</span>, <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"凯撒大帝\"</span>, <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1003\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr></table></figure><p>分页查询：需求：每页 2 个，第二页开始：跳过前两条数据，接着值显示 3 和 4 条数据</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#第一页</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token operator\">></span> db.comment.find<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>.skip<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>.limit<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">#第二页</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">></span> db.comment.find<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>.skip<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>.limit<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">#第三页</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token operator\">></span> db.comment.find<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>.skip<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span>.limit<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h2 id=\"排序查询\"><a class=\"markdownIt-Anchor\" href=\"#排序查询\">#</a> 排序查询</h2>\n<p>sort () 方法对数据进行排序，sort () 方法可以通过参数指定排序的字段，并使用 1 和 - 1 来指定排序方式，其中 1 为升序排列，而 - 1 是用于降序排列</p>\n<p>语法如下所示：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment_name.find<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>.sort<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>KEY:1<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>或</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">></span> db.集合名称.find<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>.sort<span class=\"token punctuation\">(</span>排序方式<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>例如：</p>\n<p>对 userid 降序排列，并对访问量进行升序排列</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.find<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>.sort<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>userid:1,likenum:1<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.find<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>.sort<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>userid:-1,likenum:1<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2\"</span>, <span class=\"token string\">\"articleid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"10002\"</span>, <span class=\"token string\">\"likenum\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">890</span>, <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"凯撒大帝\"</span>, <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1003\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1\"</span>, <span class=\"token string\">\"articleid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"10001\"</span>, <span class=\"token string\">\"likenum\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1003</span>, <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"凯撒大帝\"</span>, <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1003\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr></table></figure><p>提示：</p>\n<p>skip ()，limit ()，sort () 三个放在一起执行的时候，执行的顺序是先 sort () 然后是 skip () 最后是显示的 limit () 和命令编写顺序无关</p>\n<p>sort &gt; skip &gt; limit</p>\n<h2 id=\"文档的更多查询\"><a class=\"markdownIt-Anchor\" href=\"#文档的更多查询\">#</a> 文档的更多查询</h2>\n<h3 id=\"正则的复杂条件查询\"><a class=\"markdownIt-Anchor\" href=\"#正则的复杂条件查询\">#</a> 正则的复杂条件查询</h3>\n<p>MongoDB 的模糊查询是通过正则表达式的方式实现的，格式为：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.collection.find<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>field:/正则表达式/<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>或</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">></span> db.集合名称.find<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>字段:/正则表达式/<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>提示：正则表达式是 js 的语法，直接量的写法</p>\n<p>例如：我要查询评论内容包含 &quot;开水&quot; 的所有文档，代码如下：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.find<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>content:/开水/<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.<span class=\"token function-name function\">find</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1\"</span>, <span class=\"token string\">\"articleid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"10001\"</span>, <span class=\"token string\">\"likenum\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1003</span>, <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"凯撒大帝\"</span>, <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1003\"</span>, <span class=\"token string\">\"content\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"开水\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2\"</span>, <span class=\"token string\">\"articleid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"10002\"</span>, <span class=\"token string\">\"likenum\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">890</span>, <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"凯撒大帝\"</span>, <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1003\"</span>, <span class=\"token string\">\"content\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"专家表明\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"3\"</span>, <span class=\"token string\">\"articleid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"10003\"</span>, <span class=\"token string\">\"likenum\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">100</span>, <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"123\"</span>, <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1003\"</span>, <span class=\"token string\">\"content\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"开水\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token operator\">></span> db.comment.find<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>content:/开水/<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1\"</span>, <span class=\"token string\">\"articleid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"10001\"</span>, <span class=\"token string\">\"likenum\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1003</span>, <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"凯撒大帝\"</span>, <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1003\"</span>, <span class=\"token string\">\"content\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"开水\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"3\"</span>, <span class=\"token string\">\"articleid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"10003\"</span>, <span class=\"token string\">\"likenum\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">100</span>, <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"123\"</span>, <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1003\"</span>, <span class=\"token string\">\"content\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"开水\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr></table></figure><p>如果要查询评论的内容中以 &quot;专家&quot; 开头的，代码如下：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.find<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>content:/^专家/<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.find<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>content:/^专家/<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2\"</span>, <span class=\"token string\">\"articleid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"10002\"</span>, <span class=\"token string\">\"likenum\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">890</span>, <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"凯撒大帝\"</span>, <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1003\"</span>, <span class=\"token string\">\"content\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"专家表明\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr></table></figure><h2 id=\"比较查询\"><a class=\"markdownIt-Anchor\" href=\"#比较查询\">#</a> 比较查询</h2>\n<p>&lt;，&lt;=，&gt;，&gt;= 这个操作符也是很常用的，格式如下：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#大于：field > vlaue</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token operator\">></span> db.集合名称.find<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"field\"</span>:<span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$gt</span>:value<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">#小于：field &lt; value</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">></span> db.集合名称.find<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"field\"</span>:<span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$lt</span>:value<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">#大于等于：field >= value</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token operator\">></span> db.集合名称.find<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"field\"</span>:<span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$gte</span>:value<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">#小于等于：field &lt;= value</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token operator\">></span> db.集合名称.find<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"field\"</span>:<span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$lte</span>:value<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">#不等于：field != value</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token operator\">></span> db.集合名称.find<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"field\"</span>:<span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$ne</span>:value<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>示例：查询评论带你赞数量大于 700 的记录</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.find<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>likenum:<span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$gt</span>:NumberInt<span class=\"token punctuation\">(</span><span class=\"token number\">700</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.find<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>likenum:<span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$gt</span>:NumberInt<span class=\"token punctuation\">(</span><span class=\"token number\">700</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1\"</span>, <span class=\"token string\">\"articleid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"10001\"</span>, <span class=\"token string\">\"likenum\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1003</span>, <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"凯撒大帝\"</span>, <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1003\"</span>, <span class=\"token string\">\"content\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"开水\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2\"</span>, <span class=\"token string\">\"articleid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"10002\"</span>, <span class=\"token string\">\"likenum\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">890</span>, <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"凯撒大帝\"</span>, <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1003\"</span>, <span class=\"token string\">\"content\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"专家表明\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr></table></figure><h2 id=\"包含查询\"><a class=\"markdownIt-Anchor\" href=\"#包含查询\">#</a> 包含查询</h2>\n<p>包含使用 $in 操作符</p>\n<p>示例：查询评论的集合中 userid 字段包含 1003 和 1004 的文档</p>\n<pre><code class=\"language-shll\">&gt; db.comment.find(&#123;userid:&#123;$in:[&quot;1003&quot;,&quot;1004&quot;]&#125;&#125;)\n</code></pre>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.find<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>userid:<span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$in</span>:<span class=\"token punctuation\">[</span><span class=\"token string\">\"1003\"</span>,<span class=\"token string\">\"1004\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1\"</span>, <span class=\"token string\">\"articleid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"10001\"</span>, <span class=\"token string\">\"likenum\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1003</span>, <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"凯撒大帝\"</span>, <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1003\"</span>, <span class=\"token string\">\"content\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"开水\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2\"</span>, <span class=\"token string\">\"articleid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"10002\"</span>, <span class=\"token string\">\"likenum\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">890</span>, <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"凯撒大帝\"</span>, <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1003\"</span>, <span class=\"token string\">\"content\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"专家表明\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"3\"</span>, <span class=\"token string\">\"articleid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"10003\"</span>, <span class=\"token string\">\"likenum\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">100</span>, <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"凯撒\"</span>, <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1003\"</span>, <span class=\"token string\">\"content\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"开水\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr></table></figure><h2 id=\"条件连接查询\"><a class=\"markdownIt-Anchor\" href=\"#条件连接查询\">#</a> 条件连接查询</h2>\n<p>我们如果需要查询同时满足两个以上条件，需要使用 $and 操作符将条件进行关联 (相当于 SQL 的 and)</p>\n<p>格式为：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token variable\">$and</span>:<span class=\"token punctuation\">[</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>,<span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>,<span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">]</span></pre></td></tr></table></figure><p>示例：查询评论集合中 likenum 大于等于 700 并且小于 2000 的文档</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.find<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$and</span>:<span class=\"token punctuation\">[</span><span class=\"token punctuation\">&#123;</span>lienum:<span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$gte</span>:NumberInt<span class=\"token punctuation\">(</span><span class=\"token number\">700</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span>,<span class=\"token punctuation\">&#123;</span>likenum:<span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$lt</span>:NumberInt<span class=\"token punctuation\">(</span><span class=\"token number\">2000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.find<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$and</span>:<span class=\"token punctuation\">[</span><span class=\"token punctuation\">&#123;</span>likenum:<span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$gte</span>:NumberInt<span class=\"token punctuation\">(</span><span class=\"token number\">700</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span>,<span class=\"token punctuation\">&#123;</span>likenum:<span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$lt</span>:NumberInt<span class=\"token punctuation\">(</span><span class=\"token number\">2000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1\"</span>, <span class=\"token string\">\"articleid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"10001\"</span>, <span class=\"token string\">\"likenum\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1003</span>, <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"凯撒大帝\"</span>, <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1003\"</span>, <span class=\"token string\">\"content\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"开水\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2\"</span>, <span class=\"token string\">\"articleid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"10002\"</span>, <span class=\"token string\">\"likenum\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">890</span>, <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"凯撒大帝\"</span>, <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1003\"</span>, <span class=\"token string\">\"content\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"专家表明\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr></table></figure><p>如果两个以上条件之间是或者的关系，我们使用操作符进行关联，与前面 and 的使用方式相同</p>\n<p>格式为：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token variable\">$or</span>:<span class=\"token punctuation\">[</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>,<span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>,<span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">]</span></pre></td></tr></table></figure><p>示例：查询评论集合中 userid 为 1003，或者点赞数小于 1000 的文档记录</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.find<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$or</span>:<span class=\"token punctuation\">[</span><span class=\"token punctuation\">&#123;</span>userid:<span class=\"token string\">\"1003\"</span><span class=\"token punctuation\">&#125;</span>,<span class=\"token punctuation\">&#123;</span>likenum:<span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$lt</span>:1000<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.find<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$or</span>:<span class=\"token punctuation\">[</span><span class=\"token punctuation\">&#123;</span>userid:<span class=\"token string\">\"1003\"</span><span class=\"token punctuation\">&#125;</span>,<span class=\"token punctuation\">&#123;</span>likenum:<span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$lt</span>:1000<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1\"</span>, <span class=\"token string\">\"articleid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"10001\"</span>, <span class=\"token string\">\"likenum\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1003</span>, <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"凯撒大帝\"</span>, <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1003\"</span>, <span class=\"token string\">\"content\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"开水\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2\"</span>, <span class=\"token string\">\"articleid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"10002\"</span>, <span class=\"token string\">\"likenum\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">890</span>, <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"凯撒大帝\"</span>, <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1003\"</span>, <span class=\"token string\">\"content\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"专家表明\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"3\"</span>, <span class=\"token string\">\"articleid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"10003\"</span>, <span class=\"token string\">\"likenum\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">100</span>, <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"凯撒\"</span>, <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1003\"</span>, <span class=\"token string\">\"content\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"开水\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token operator\">></span> db.comment.find<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$and</span>:<span class=\"token punctuation\">[</span><span class=\"token punctuation\">&#123;</span>userid:<span class=\"token string\">\"1003\"</span><span class=\"token punctuation\">&#125;</span>,<span class=\"token punctuation\">&#123;</span>likenum:<span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$lt</span>:1000<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2\"</span>, <span class=\"token string\">\"articleid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"10002\"</span>, <span class=\"token string\">\"likenum\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">890</span>, <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"凯撒大帝\"</span>, <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1003\"</span>, <span class=\"token string\">\"content\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"专家表明\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"3\"</span>, <span class=\"token string\">\"articleid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"10003\"</span>, <span class=\"token string\">\"likenum\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">100</span>, <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"凯撒\"</span>, <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1003\"</span>, <span class=\"token string\">\"content\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"开水\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr></table></figure><h2 id=\"常用命令小结\"><a class=\"markdownIt-Anchor\" href=\"#常用命令小结\">#</a> 常用命令小结</h2>\n<p>选择切换数据库：use articledb</p>\n<p>插入数据：db.comment.insert ({bson 数据})</p>\n<p>查询所有数据：db.comment.find ()</p>\n<p>条件查询数据：db.cmoment.find ({条件})</p>\n<p>查询符合条件的第一条记录：db.comment.findOne ({条件})</p>\n<p>查询符合条件的前几条记录：db.comment.find ({条件}).limit (条数)</p>\n<p>查询符合条件的跳过的记录：db.comment.find ({条件}).skip (条数)</p>\n<p>修改数据：db.comment.update ({条件},{修改后的数据}) 或 db.comment.update ({条件},{$set:{要修改部分的字段：数据}})</p>\n<p>修改数据并自增某字段值：db.comment.update ({条件},{$inc:{自增的字段：步进值}})</p>\n<p>删除数据：db.comment.remove ({条件})</p>\n<p>统计查询：db.comment.count ({条件})</p>\n<p>模糊查询：db.comment.find ({字段名:/ 正则表达式 /})</p>\n<p>条件比较运算：db.comment.find ({字段名:{$gt: 值}})</p>\n<p>包含查询：db.comment.find ({字段名:{ <code>$</code> in:[值 1, 值 2]}}) 或 db.comment.find ({字段名:{ <code>$</code> nin:[值 1, 值 2]}})</p>\n<p>条件连接查询：db.comment.find ({ <code>$</code> and:[{条件 1},{条件 2}]}) 或 db.comment.find ({ <code>$</code> or:[{条件 1},{条件 2}])</p>\n<h2 id=\"索引的类型\"><a class=\"markdownIt-Anchor\" href=\"#索引的类型\">#</a> 索引的类型</h2>\n<h3 id=\"单字段索引\"><a class=\"markdownIt-Anchor\" href=\"#单字段索引\">#</a> 单字段索引</h3>\n<p>MongoDB 支持在文档的单个字段上创建用户定义的升序 / 降序索引，称为单字段索引 (Single Field Index)</p>\n<p>对于单个字段索引的排序操作，索引键的排序顺序 (即升序或降序) 并不重要，因为 MongoDB 可以在任何方向上遍历索引</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031702130.png\" alt=\"image-20230604161713948\"></p>\n<h3 id=\"其它索引\"><a class=\"markdownIt-Anchor\" href=\"#其它索引\">#</a> 其它索引</h3>\n<p>地理空间索引 (Geospatial Index)，文本索引 (Text Indexes)，哈希索引 (Hashed Indexes)</p>\n<h4 id=\"地理空间索引geospatial-index\"><a class=\"markdownIt-Anchor\" href=\"#地理空间索引geospatial-index\">#</a> 地理空间索引 (Geospatial Index)</h4>\n<p>为了支持对地理空间坐标数据的有效查询，MongoDB 提供了两种特殊的索引：返回结果是使用平面几何的二维索引和返回结果时使用球面几何的二维球面索引</p>\n<h4 id=\"文本索引text-indexes\"><a class=\"markdownIt-Anchor\" href=\"#文本索引text-indexes\">#</a> 文本索引 (Text Indexes)</h4>\n<p>MongoDB 提供了一种文本索引类型，支持在集合中搜索字符串内容，这些文本索引不存储特定于语言的停止词 (例如：“the”，“a”，“or”)，而将集合中的此作为词干，只存储跟词。</p>\n<h4 id=\"哈希索引hashed-indexes\"><a class=\"markdownIt-Anchor\" href=\"#哈希索引hashed-indexes\">#</a> 哈希索引 (Hashed Indexes)</h4>\n<p>为了支持基于散列的分片，MongoDB 提供了散列索引类型，它对字段值的散列进行索引，这些索引在其范围内的值分布更加随机，但只支持相等匹配，不支持基于范围的查询</p>\n<h3 id=\"索引的管理操作\"><a class=\"markdownIt-Anchor\" href=\"#索引的管理操作\">#</a> 索引的管理操作</h3>\n<h4 id=\"索引的查看\"><a class=\"markdownIt-Anchor\" href=\"#索引的查看\">#</a> 索引的查看</h4>\n<p>说明：</p>\n<p>返回一个集合中的所有索引的数组。</p>\n<p>语法：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.collection.getIndexes<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>提示：该语法命令运行要求是 MongoDB 3.0+</p>\n<p>[示例]</p>\n<p>查看 comment 集合中所有的索引情况</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.getIndexes<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.getIndexes<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"v\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span>, <span class=\"token string\">\"key\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">&#125;</span>, <span class=\"token string\">\"name\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"_id_\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr></table></figure><p>结果中显示的是默认_id 索引</p>\n<p>默认_id 索引：</p>\n<p>MongoDB 在创建集合的过程中，在_id 字段上创建一个唯一的索引，默认名字为 <code>_id_</code> ，该索引可防止客户端插入两个具有相同值的文档，您不能在 <code>_id</code>  字段上删除此索引</p>\n<p>注意：该索引是唯一索引，因此值不能重复，即_id 值不能重复的，在分片集群中，通常使用 <code>_id</code>  作为片键</p>\n<h3 id=\"索引的创建\"><a class=\"markdownIt-Anchor\" href=\"#索引的创建\">#</a> 索引的创建</h3>\n<p>说明：</p>\n<p>在集合上创建索引</p>\n<p>语法：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.collection.createIndex<span class=\"token punctuation\">(</span>keys.options<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>参数：</p>\n<table>\n<thead>\n<tr>\n<th>Parameter</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>keys</td>\n<td>document</td>\n<td>包含字段和值对的文档，其中字段是索引键，值描述该字段的索引类型，对于字段上的升序索引，请指定值 1；对于降序索引，请指定值 - 1；比如：{字段：1 或 - 1}，其中 1 为指定按升序创建索引，如果你想按降序创建索引指定为 - 1 即可。另外 MongoDB 支持几种不同的索引类型，包括文本，地理空间和哈希索引</td>\n</tr>\n<tr>\n<td>options</td>\n<td>document</td>\n<td>可选，包含一组控制索引创建的选项的文档，有关详细信息，请参见选项详情列表</td>\n</tr>\n</tbody>\n</table>\n<p>options (更多选项) 列表：</p>\n<table>\n<thead>\n<tr>\n<th>Parameter</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>background</td>\n<td>Boolean</td>\n<td>键索引过程会阻塞其它数据库操作，background 可指定以后台方式创建索引，即增加 &quot;background&quot; 可选参数，&quot;background&quot; 默认值为 false</td>\n</tr>\n<tr>\n<td>unique</td>\n<td>Boolean</td>\n<td>建立的索引是否唯一，指定为 true 创建唯一索引，默认值为 false</td>\n</tr>\n<tr>\n<td>name</td>\n<td>string</td>\n<td>索引的名称，如果未指定，MongoDB 的通过连接索引的字段名和排序生成一个索引名称</td>\n</tr>\n<tr>\n<td>dropDups</td>\n<td>Boolean</td>\n<td>3.0 + 版本已经废弃，在建立唯一索引时是否删除重复记录，指定 true 创建唯一索引，默认值为 false</td>\n</tr>\n<tr>\n<td>sparse</td>\n<td>Boolean</td>\n<td>对文档中不存在的字段数据不启用索引；这个参数需要特别注意，如果设置为 true 的话，在索引字段中不会查询出不包含对应字段的文档，默认值为 false</td>\n</tr>\n<tr>\n<td>expireAfterSeconds</td>\n<td>integer</td>\n<td>指定一个以秒为单位的数值，完成 TTL 设定，设定集合的生存时间</td>\n</tr>\n<tr>\n<td>v</td>\n<td>index<br>version</td>\n<td>索引的版本号，默认的索引版本取决于 mongod 创建索引时运行的版本</td>\n</tr>\n<tr>\n<td>weights</td>\n<td>document</td>\n<td>索引权重值，数值在 1 到 99.999 之间，表示该索引相对于其它索引字段得分权重</td>\n</tr>\n<tr>\n<td>default_language</td>\n<td>string</td>\n<td>对于文本索引，该参数决定了停用词及词干和词器的规则的列表，默认为英语</td>\n</tr>\n</tbody>\n</table>\n<p>提示：</p>\n<p>注意在 3.0.0 版本前创建索引方法为： <code>db.collection.ensureIndex()</code> ，之后的版本使用了 <code>db.collection.createIndex()</code>  方法， <code>ensureIndex()</code>  还能用，但只是 <code>createIndex()</code>  的别名</p>\n<p>[示例]</p>\n<p>1. 单字段索引示例：对 <code>userid</code>  字段建立索引</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.createIndex<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>userid:1<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.createIndex<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>userid:1<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token string\">\"numIndexesBefore\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token string\">\"numIndexesAfter\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span>,</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token string\">\"createdCollectionAutomatically\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token string\">\"ok\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr></table></figure><p>参数 1：按升序创建索引</p>\n<p>可以查看一下：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.getIndexes<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                <span class=\"token string\">\"v\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span>,</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                <span class=\"token string\">\"key\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                        <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                <span class=\"token string\">\"name\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"_id_\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                <span class=\"token string\">\"v\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span>,</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                <span class=\"token string\">\"key\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                        <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                <span class=\"token string\">\"name\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"userid_1\"</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr></table></figure><p>索引名字为： <code>userid_1</code></p>\n<p>compass 查看：</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031702245.png\" alt=\"image-20230604171621927\"></p>\n<p>复合索引：对 <code>userid</code>  和 <code>nickname</code>  同时建立复合 (Compound) 索引：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.createIndex<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>userid:1,nickname:-1<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.createIndex<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>userid:1,nickname:-1<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token string\">\"numIndexesBefore\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span>,</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token string\">\"numIndexesAfter\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">3</span>,</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token string\">\"createdCollectionAutomatically\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token string\">\"ok\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr></table></figure><p>查看一下索引：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.getIndexes<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                <span class=\"token string\">\"v\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span>,</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                <span class=\"token string\">\"key\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                        <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                <span class=\"token string\">\"name\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"_id_\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                <span class=\"token string\">\"v\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span>,</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                <span class=\"token string\">\"key\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                        <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                <span class=\"token string\">\"name\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"userid_1\"</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                <span class=\"token string\">\"v\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span>,</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                <span class=\"token string\">\"key\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                        <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                        <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token parameter variable\">-1</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                <span class=\"token string\">\"name\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"userid_1_nickname_-1\"</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr></table></figure><h3 id=\"索引的移除\"><a class=\"markdownIt-Anchor\" href=\"#索引的移除\">#</a> 索引的移除</h3>\n<p>说明：可以移除指定的索引，或移除所有索引</p>\n<h4 id=\"一指定索引的移除\"><a class=\"markdownIt-Anchor\" href=\"#一指定索引的移除\">#</a> 一，指定索引的移除</h4>\n<p>语法：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.collection.dropIndex<span class=\"token punctuation\">(</span>index<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>参数：</p>\n<table>\n<caption id=\"\" style=\"caption-side: bottom\">示例</caption>\n<thead>\n<tr>\n<th>Parameter</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>index</td>\n<td>string or document</td>\n<td>指定要删除的索引，可以通过索引名称或索引规范文档指定索引，诺要删除文本索引，请指定索引名称</td>\n</tr>\n</tbody>\n</table>\n<p>删除 <code>comment</code>  集合中 <code>userid</code>  字段上的升序索引：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.dropIndex<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>userid:1<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>查看已经删除了</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.getIndexes<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                <span class=\"token string\">\"v\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span>,</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                <span class=\"token string\">\"key\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                        <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                <span class=\"token string\">\"name\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"_id_\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                <span class=\"token string\">\"v\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span>,</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                <span class=\"token string\">\"key\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                        <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                <span class=\"token string\">\"name\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"userid_1\"</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                <span class=\"token string\">\"v\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span>,</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                <span class=\"token string\">\"key\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                        <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                        <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token parameter variable\">-1</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                <span class=\"token string\">\"name\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"userid_1_nickname_-1\"</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token operator\">></span> db.comment.dropIndex<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>userid:1<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"nIndexesWas\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">3</span>, <span class=\"token string\">\"ok\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token operator\">></span> db.comment.getIndexes<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                <span class=\"token string\">\"v\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span>,</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                <span class=\"token string\">\"key\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                        <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                <span class=\"token string\">\"name\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"_id_\"</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>                <span class=\"token string\">\"v\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span>,</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>                <span class=\"token string\">\"key\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                        <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>                        <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token parameter variable\">-1</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>                <span class=\"token string\">\"name\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"userid_1_nickname_-1\"</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr></table></figure><h4 id=\"二所有索引的移除\"><a class=\"markdownIt-Anchor\" href=\"#二所有索引的移除\">#</a> 二，所有索引的移除</h4>\n<p>语法：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.collection.dropIndexes<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>[示例]</p>\n<p>删除 skip 集合中所有索引</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.<span class=\"token function-name function\">dropIndexes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token string\">\"nIndexesWas\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span>,</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token string\">\"msg\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"non-_id indexes dropped for collection\"</span>,</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token string\">\"ok\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr></table></figure><p>提示： <code>_id</code>  的字段的索引是无法删除的，只能删除非 <code>_id</code>  字段的索引</p>\n<p>查看索引：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.getIndexes<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"v\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span>, <span class=\"token string\">\"key\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">&#125;</span>, <span class=\"token string\">\"name\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"_id_\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr></table></figure><h3 id=\"索引的使用\"><a class=\"markdownIt-Anchor\" href=\"#索引的使用\">#</a> 索引的使用</h3>\n<h4 id=\"执行计划\"><a class=\"markdownIt-Anchor\" href=\"#执行计划\">#</a> 执行计划</h4>\n<p>分析查询性能 (Analyze Query Performance) 通常使用执行计划，(解释计划，Explin Plan) 来查看查询的情况，如查询耗费的时间，是否基于索引查询等</p>\n<p>那么，通常，我们想知道，建立的索引是否有效，效果如何，都需要通过执行计划查看</p>\n<p>语法：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.collection.find<span class=\"token punctuation\">(</span>query,options<span class=\"token punctuation\">)</span>.explain<span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>[示例]</p>\n<p>查看根据 userid 查询数据的情况：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.find<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>userid:<span class=\"token string\">\"1003\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>.<span class=\"token function-name function\">explain</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token string\">\"explainVersion\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1\"</span>,</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token string\">\"queryPlanner\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                <span class=\"token string\">\"namespace\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"articledb.comment\"</span>,</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                <span class=\"token string\">\"indexFilterSet\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                <span class=\"token string\">\"parsedQuery\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                        <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                                <span class=\"token string\">\"<span class=\"token variable\">$eq</span>\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1003\"</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                <span class=\"token string\">\"queryHash\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"37A12FC3\"</span>,</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                <span class=\"token string\">\"planCacheKey\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"4A7D843D\"</span>,</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                <span class=\"token string\">\"maxIndexedOrSolutionsReached\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                <span class=\"token string\">\"maxIndexedAndSolutionsReached\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                <span class=\"token string\">\"maxScansToExplodeReached\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                <span class=\"token string\">\"winningPlan\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                        <span class=\"token string\">\"stage\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"COLLSCAN\"</span>,</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                        <span class=\"token string\">\"filter\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                                <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                                        <span class=\"token string\">\"<span class=\"token variable\">$eq</span>\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1003\"</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                        <span class=\"token string\">\"direction\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"forward\"</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                <span class=\"token string\">\"rejectedPlans\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token string\">\"command\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                <span class=\"token string\">\"find\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"comment\"</span>,</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                <span class=\"token string\">\"filter\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                        <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1003\"</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                <span class=\"token string\">\"<span class=\"token variable\">$db</span>\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"articledb\"</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token string\">\"serverInfo\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                <span class=\"token string\">\"host\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"localhost.localdomain\"</span>,</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                <span class=\"token string\">\"port\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">27017</span>,</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>                <span class=\"token string\">\"version\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"5.0.18\"</span>,</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>                <span class=\"token string\">\"gitVersion\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"796abe56bfdbca6968ff570311bf72d93632825b\"</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        <span class=\"token string\">\"serverParameters\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>                <span class=\"token string\">\"internalQueryFacetBufferSizeBytes\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">104857600</span>,</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>                <span class=\"token string\">\"internalQueryFacetMaxOutputDocSizeBytes\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">104857600</span>,</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>                <span class=\"token string\">\"internalLookupStageIntermediateDocumentMaxSizeBytes\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">104857600</span>,</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                <span class=\"token string\">\"internalDocumentSourceGroupMaxMemoryBytes\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">104857600</span>,</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                <span class=\"token string\">\"internalQueryMaxBlockingSortMemoryUsageBytes\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">104857600</span>,</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>                <span class=\"token string\">\"internalQueryProhibitBlockingMergeOnMongoS\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>,</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>                <span class=\"token string\">\"internalQueryMaxAddToSetBytes\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">104857600</span>,</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>                <span class=\"token string\">\"internalDocumentSourceSetWindowFieldsMaxMemoryBytes\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">104857600</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        <span class=\"token string\">\"ok\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr></table></figure><p>查看出来的结果是文档的扫描是 5 条记录，数据是 5 条，扫描也是 5 条就代表全文档扫描</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031702609.png\" alt=\"image-20230604214503129\"></p>\n<p>想用上索引就需要给数据 加上索引</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.createIndex<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>userid:1<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token string\">\"numIndexesBefore\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token string\">\"numIndexesAfter\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span>,</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token string\">\"createdCollectionAutomatically\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token string\">\"ok\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.find<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>userid:<span class=\"token string\">\"1003\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>.<span class=\"token function-name function\">explain</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token string\">\"explainVersion\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1\"</span>,</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token string\">\"queryPlanner\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                <span class=\"token string\">\"namespace\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"articledb.comment\"</span>,</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                <span class=\"token string\">\"indexFilterSet\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                <span class=\"token string\">\"parsedQuery\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                        <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                                <span class=\"token string\">\"<span class=\"token variable\">$eq</span>\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1003\"</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                <span class=\"token string\">\"queryHash\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"37A12FC3\"</span>,</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                <span class=\"token string\">\"planCacheKey\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"3B74CBDE\"</span>,</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                <span class=\"token string\">\"maxIndexedOrSolutionsReached\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                <span class=\"token string\">\"maxIndexedAndSolutionsReached\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                <span class=\"token string\">\"maxScansToExplodeReached\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                <span class=\"token string\">\"winningPlan\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                        <span class=\"token string\">\"stage\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"FETCH\"</span>,</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                        <span class=\"token string\">\"inputStage\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                                <span class=\"token string\">\"stage\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"IXSCAN\"</span>,</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                                <span class=\"token string\">\"keyPattern\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                                        <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                                <span class=\"token string\">\"indexName\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"userid_1\"</span>,</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                                <span class=\"token string\">\"isMultiKey\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                                <span class=\"token string\">\"multiKeyPaths\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                                        <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                                <span class=\"token string\">\"isUnique\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                                <span class=\"token string\">\"isSparse\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                                <span class=\"token string\">\"isPartial\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                                <span class=\"token string\">\"indexVersion\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span>,</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                                <span class=\"token string\">\"direction\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"forward\"</span>,</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                                <span class=\"token string\">\"indexBounds\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                                        <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                                                <span class=\"token string\">\"[<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>1003<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>, <span class=\"token entity\" title=\"\\&quot;\">\\\"</span>1003<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>]\"</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                                        <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>                                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>                        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>                <span class=\"token string\">\"rejectedPlans\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        <span class=\"token string\">\"command\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>                <span class=\"token string\">\"find\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"comment\"</span>,</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                <span class=\"token string\">\"filter\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                        <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1003\"</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>                <span class=\"token string\">\"<span class=\"token variable\">$db</span>\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"articledb\"</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        <span class=\"token string\">\"serverInfo\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>                <span class=\"token string\">\"host\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"localhost.localdomain\"</span>,</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>                <span class=\"token string\">\"port\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">27017</span>,</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>                <span class=\"token string\">\"version\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"5.0.18\"</span>,</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>                <span class=\"token string\">\"gitVersion\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"796abe56bfdbca6968ff570311bf72d93632825b\"</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        <span class=\"token string\">\"serverParameters\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>                <span class=\"token string\">\"internalQueryFacetBufferSizeBytes\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">104857600</span>,</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>                <span class=\"token string\">\"internalQueryFacetMaxOutputDocSizeBytes\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">104857600</span>,</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>                <span class=\"token string\">\"internalLookupStageIntermediateDocumentMaxSizeBytes\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">104857600</span>,</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>                <span class=\"token string\">\"internalDocumentSourceGroupMaxMemoryBytes\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">104857600</span>,</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>                <span class=\"token string\">\"internalQueryMaxBlockingSortMemoryUsageBytes\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">104857600</span>,</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>                <span class=\"token string\">\"internalQueryProhibitBlockingMergeOnMongoS\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>,</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>                <span class=\"token string\">\"internalQueryMaxAddToSetBytes\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">104857600</span>,</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>                <span class=\"token string\">\"internalDocumentSourceSetWindowFieldsMaxMemoryBytes\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">104857600</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>        <span class=\"token string\">\"ok\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr></table></figure><p>此时的 &quot;stage&quot; : &quot;FETCH&quot; 就变成了 FETCH</p>\n<p>此时文档的扫描就是 2 条数据了</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031703658.png\" alt=\"image-20230604215307694\"></p>\n<p>它是先通过 IXSCAN 查询索引里面的集合，索引也是一个小集合</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031703416.png\" alt=\"image-20230604215400607\"></p>\n<p>再通过抓取，去抓取指定查回来的 2 条数据</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031703567.png\" alt=\"image-20230604215440187\"></p>\n<h2 id=\"涵盖的查询\"><a class=\"markdownIt-Anchor\" href=\"#涵盖的查询\">#</a> 涵盖的查询</h2>\n<p>Convered Queries</p>\n<p>当查询条件和查询的投影仅包含索引字段时，MongoDB 直接从索引返回结果，而不扫描任何文档或将文档带入内存，这些覆盖的查询可以非常有效</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031703796.png\" alt=\"image-20230604220253854\"></p>\n<p>如果查询的数据在索引中已经有了就不会再去文档中去找了，而是直接从索引中 取</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031703030.png\" alt=\"image-20230604220509616\"></p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.find<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>userid:<span class=\"token string\">\"1003\"</span><span class=\"token punctuation\">&#125;</span>,<span class=\"token punctuation\">&#123;</span>userid:1,_id:0<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>.<span class=\"token function-name function\">explain</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token string\">\"explainVersion\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1\"</span>,</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token string\">\"queryPlanner\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                <span class=\"token string\">\"namespace\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"articledb.comment\"</span>,</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                <span class=\"token string\">\"indexFilterSet\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                <span class=\"token string\">\"parsedQuery\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                        <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                                <span class=\"token string\">\"<span class=\"token variable\">$eq</span>\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1003\"</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                <span class=\"token string\">\"queryHash\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"8177476D\"</span>,</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                <span class=\"token string\">\"planCacheKey\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"F842FA57\"</span>,</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                <span class=\"token string\">\"maxIndexedOrSolutionsReached\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                <span class=\"token string\">\"maxIndexedAndSolutionsReached\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                <span class=\"token string\">\"maxScansToExplodeReached\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                <span class=\"token string\">\"winningPlan\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                        <span class=\"token string\">\"stage\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"PROJECTION_COVERED\"</span>,</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                        <span class=\"token string\">\"transformBy\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                                <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                                <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                        <span class=\"token string\">\"inputStage\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                                <span class=\"token string\">\"stage\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"IXSCAN\"</span>,</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                                <span class=\"token string\">\"keyPattern\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                                        <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                                <span class=\"token string\">\"indexName\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"userid_1\"</span>,</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                                <span class=\"token string\">\"isMultiKey\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                                <span class=\"token string\">\"multiKeyPaths\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                                        <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                                <span class=\"token string\">\"isUnique\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                                <span class=\"token string\">\"isSparse\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                                <span class=\"token string\">\"isPartial\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                                <span class=\"token string\">\"indexVersion\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span>,</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                                <span class=\"token string\">\"direction\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"forward\"</span>,</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>                                <span class=\"token string\">\"indexBounds\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>                                        <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                                                <span class=\"token string\">\"[<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>1003<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>, <span class=\"token entity\" title=\"\\&quot;\">\\\"</span>1003<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>]\"</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>                                        <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>                                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>                        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                <span class=\"token string\">\"rejectedPlans\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        <span class=\"token string\">\"command\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>                <span class=\"token string\">\"find\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"comment\"</span>,</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>                <span class=\"token string\">\"filter\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>                        <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1003\"</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>                <span class=\"token string\">\"projection\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>                        <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>,</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>                        <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>                <span class=\"token string\">\"<span class=\"token variable\">$db</span>\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"articledb\"</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        <span class=\"token string\">\"serverInfo\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>                <span class=\"token string\">\"host\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"localhost.localdomain\"</span>,</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>                <span class=\"token string\">\"port\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">27017</span>,</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>                <span class=\"token string\">\"version\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"5.0.18\"</span>,</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>                <span class=\"token string\">\"gitVersion\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"796abe56bfdbca6968ff570311bf72d93632825b\"</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        <span class=\"token string\">\"serverParameters\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>                <span class=\"token string\">\"internalQueryFacetBufferSizeBytes\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">104857600</span>,</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>                <span class=\"token string\">\"internalQueryFacetMaxOutputDocSizeBytes\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">104857600</span>,</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>                <span class=\"token string\">\"internalLookupStageIntermediateDocumentMaxSizeBytes\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">104857600</span>,</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>                <span class=\"token string\">\"internalDocumentSourceGroupMaxMemoryBytes\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">104857600</span>,</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>                <span class=\"token string\">\"internalQueryMaxBlockingSortMemoryUsageBytes\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">104857600</span>,</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>                <span class=\"token string\">\"internalQueryProhibitBlockingMergeOnMongoS\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>,</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>                <span class=\"token string\">\"internalQueryMaxAddToSetBytes\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">104857600</span>,</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>                <span class=\"token string\">\"internalDocumentSourceSetWindowFieldsMaxMemoryBytes\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">104857600</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>        <span class=\"token string\">\"ok\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr></table></figure><h2 id=\"文章评论\"><a class=\"markdownIt-Anchor\" href=\"#文章评论\">#</a> 文章评论</h2>\n<h3 id=\"需求分析\"><a class=\"markdownIt-Anchor\" href=\"#需求分析\">#</a> 需求分析</h3>\n<p>某头条的文章评论业务如下：</p>\n<p>需要实现以下功能：</p>\n<ol>\n<li>基本增删改查 API</li>\n<li>根据文章 id 查询评论</li>\n<li>评论点赞</li>\n</ol>\n<h3 id=\"表结构分析\"><a class=\"markdownIt-Anchor\" href=\"#表结构分析\">#</a> 表结构分析</h3>\n<p>数据库：articledb</p>\n<table>\n<thead>\n<tr>\n<th>专栏文章评论</th>\n<th>comment</th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>字段名称</td>\n<td>字段含义</td>\n<td>字段类型</td>\n<td>备注</td>\n</tr>\n<tr>\n<td>_id</td>\n<td>ID</td>\n<td>ObjectId 或 String</td>\n<td>Mongo 的主键的字段</td>\n</tr>\n<tr>\n<td>articleid</td>\n<td>文章 ID</td>\n<td>String</td>\n<td></td>\n</tr>\n<tr>\n<td>content</td>\n<td>评论内容</td>\n<td>String</td>\n<td></td>\n</tr>\n<tr>\n<td>userid</td>\n<td>评论人 ID</td>\n<td>String</td>\n<td></td>\n</tr>\n<tr>\n<td>nickname</td>\n<td>评论人昵称</td>\n<td>String</td>\n<td></td>\n</tr>\n<tr>\n<td>createdatetime</td>\n<td>评论的日期时间</td>\n<td>Date</td>\n<td></td>\n</tr>\n<tr>\n<td>likenum</td>\n<td>点赞数</td>\n<td>int32</td>\n<td></td>\n</tr>\n<tr>\n<td>replynum</td>\n<td>回复数</td>\n<td>int32</td>\n<td></td>\n</tr>\n<tr>\n<td>state</td>\n<td>状态</td>\n<td>String</td>\n<td>0: 不可见；1: 可见；</td>\n</tr>\n<tr>\n<td>parentid</td>\n<td>上级 ID</td>\n<td>String</td>\n<td>如果为 0 表示文章的顶级评论</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"技术选型\"><a class=\"markdownIt-Anchor\" href=\"#技术选型\">#</a> 技术选型</h3>\n<p>mongodb-driver</p>\n<p>mongodb-driver 是 MongoDB 官方推出的 java 连接 mongoDB 的驱动包，相当于 JDBC 驱动，我们通过一个入门的案例来了解 mongodb-driver 的基本使用</p>\n<p>官方驱动说明和下载：<a href=\"https://mongodb.github.io/mongo-java-driver/\">https://mongodb.github.io/mongo-java-driver/</a></p>\n<p>官方驱动示例文档：<a href=\"https://mongodb.github.io/mongo-java-driver/3.8/driver/getting-started/quick-start/\">https://mongodb.github.io/mongo-java-driver/3.8/driver/getting-started/quick-start/</a></p>\n<h3 id=\"springdatamongodb\"><a class=\"markdownIt-Anchor\" href=\"#springdatamongodb\">#</a> SpringDataMongoDB</h3>\n<p>SpringData 家族成员之一，用于操作 MongoDB 的持久层框架，封装了底层的 MongoDB-Driver</p>\n<p>官方主页：<a href=\"https://spring.io/projects/spring-data-mongodb/\">https://spring.io/projects/spring-data-mongodb/</a></p>\n<p>我们十次方项目的吐槽微服务就采用 SpringDataMongoDB 框架</p>\n<p>1. 创建好 SpringBoot 的项目结构</p>\n<p>2. 导入相关依赖</p>\n<figure class=\"highlight xml\"><figcaption data-lang=\"XML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">></span></span>org.springframework.boot<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">></span></span>spring-boot-starter-data-mongodb<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">></span></span></pre></td></tr></table></figure><p>3. 配置 mongodb 连接配置</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">server</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token comment\">#数据源配置</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">data</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token key atrule\">mongodb</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token comment\">#主机地址</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      <span class=\"token key atrule\">host</span><span class=\"token punctuation\">:</span> 192.168.244.142</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token comment\">#数据库</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token key atrule\">database</span><span class=\"token punctuation\">:</span> articledb</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token comment\">#端口号</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">27017</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token comment\">#也可以使用 uri 连接</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token comment\">#uri: mongodb://192.168.244.142:27017/articledb</span></pre></td></tr></table></figure><p>4. 启动 SpringBoot 查看是否有报错</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202401031703699.png\" alt=\"image-20230605084426815\"></p>\n<p>一切顺利</p>\n<h3 id=\"文章评论实体类的编写\"><a class=\"markdownIt-Anchor\" href=\"#文章评论实体类的编写\">#</a> 文章评论实体类的编写</h3>\n<p>创建实体类</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">lombok<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Getter</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">lombok<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Setter</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>annotation<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Id</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>mongodb<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span>index<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">CompoundIndex</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>mongodb<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span>index<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Indexed</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>mongodb<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span>mapping<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Document</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>mongodb<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span>mapping<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Field</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>io<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Serializable</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">LocalDateTime</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Date</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token annotation punctuation\">@Getter</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token annotation punctuation\">@Setter</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\">// 对应 collection 名</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token annotation punctuation\">@Document</span><span class=\"token punctuation\">(</span>collection <span class=\"token operator\">=</span> <span class=\"token string\">\"comment\"</span><span class=\"token punctuation\">)</span><span class=\"token comment\">// 可以省略，如果省略，则默认使用类名小写映射集合</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">// 复合索引</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token annotation punctuation\">@CompoundIndex</span><span class=\"token punctuation\">(</span>def <span class=\"token operator\">=</span> <span class=\"token string\">\"&#123;'userid':1,'nickname':-1&#125;\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Comment</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">Serializable</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\">//    主键标识，该属性的值会自动对应 mongodb 的主键字段_id，如果该属性名就叫 id，则该注解可以省略，否则必须写</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token annotation punctuation\">@Id</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> id<span class=\"token punctuation\">;</span><span class=\"token comment\">// 主键</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\">//    该属性对应 mongodb 的字段名字，如果一致，则无需该注解</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token annotation punctuation\">@Field</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"content\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> content<span class=\"token punctuation\">;</span><span class=\"token comment\">// 吐槽内容</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Date</span> publishtime<span class=\"token punctuation\">;</span><span class=\"token comment\">// 发布日期</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token comment\">//    添加了一个单字段的索引</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token annotation punctuation\">@Indexed</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> userid<span class=\"token punctuation\">;</span><span class=\"token comment\">// 发布人 ID</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> nickname<span class=\"token punctuation\">;</span><span class=\"token comment\">// 昵称</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">LocalDateTime</span> createdatatime<span class=\"token punctuation\">;</span><span class=\"token comment\">// 评论的日期时间</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Integer</span> likenum<span class=\"token punctuation\">;</span><span class=\"token comment\">// 点赞数</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Integer</span> replynum<span class=\"token punctuation\">;</span><span class=\"token comment\">// 回复数</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> state<span class=\"token punctuation\">;</span><span class=\"token comment\">// 状态</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> parentid<span class=\"token punctuation\">;</span><span class=\"token comment\">// 上级 ID</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> articleid<span class=\"token punctuation\">;</span><span class=\"token comment\">// 文章 ID</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"文章评论的基本增删改查\"><a class=\"markdownIt-Anchor\" href=\"#文章评论的基本增删改查\">#</a> 文章评论的基本增删改查</h3>\n<p>创建数据访问接口</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">com<span class=\"token punctuation\">.</span>dkx<span class=\"token punctuation\">.</span>domain<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Comment</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>mongodb<span class=\"token punctuation\">.</span>repository<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">MongoRepository</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// 评论的持久层接口</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">CommentRepository</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">MongoRepository</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Comment</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>2. 创建业务逻辑类</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">com<span class=\"token punctuation\">.</span>dkx<span class=\"token punctuation\">.</span>dao<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">CommentRepository</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">com<span class=\"token punctuation\">.</span>dkx<span class=\"token punctuation\">.</span>domain<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Comment</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>beans<span class=\"token punctuation\">.</span>factory<span class=\"token punctuation\">.</span>annotation<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Autowired</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>stereotype<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Service</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">List</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token annotation punctuation\">@SuppressWarnings</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"all\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token annotation punctuation\">@Service</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CommentService</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token annotation punctuation\">@Autowired</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">CommentRepository</span> commentRepository<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>     * 保存一个评论</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>     * @param comment</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>     */</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Comment</span> comment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>         * 如果需要自定义主键，可以在这里指定主键；如果不指定主键，MongoDB 会自动生成主键</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>         * 设置一些默认初始值。。。</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>         * 调用 dao</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>         */</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        commentRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>comment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>     * 更新评论</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>     * @param comment</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>     */</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">updateComment</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Comment</span> comment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token comment\">// 调用 dao</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        commentRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>comment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>     * 根据 id 删除评论</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>     * @param id</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>     */</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">deleteCommentById</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        <span class=\"token comment\">// 调用 dao</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        commentRepository<span class=\"token punctuation\">.</span><span class=\"token function\">deleteById</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>     * 查询所有评论</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>     * @return</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>     */</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Comment</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findCommentList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        <span class=\"token keyword\">return</span> commentRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>     * 根据 id 查询评论</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>     * @param id</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>     * @return</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>     */</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Comment</span> <span class=\"token function\">findCommentById</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        <span class=\"token keyword\">return</span> commentRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findById</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>测试代码：</p>\n<p>获取全部数据</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@SpringBootTest</span><span class=\"token punctuation\">(</span>classes <span class=\"token operator\">=</span> <span class=\"token class-name\">App</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token annotation punctuation\">@RunWith</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SpringJUnit4ClassRunner</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AppTest</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token annotation punctuation\">@Autowired</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">CommentService</span> commentService<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token annotation punctuation\">@Test</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Comment</span><span class=\"token punctuation\">></span></span> list <span class=\"token operator\">=</span> commentService<span class=\"token punctuation\">.</span><span class=\"token function\">findCommentList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Comment</span> i<span class=\"token operator\">:</span>list<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token constant\">RUN</span> <span class=\"token class-name\">Result</span> <span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token class-name\">Comment</span><span class=\"token punctuation\">(</span>id<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> content<span class=\"token operator\">=</span>多喝凉水<span class=\"token punctuation\">,</span> publishtime<span class=\"token operator\">=</span><span class=\"token class-name\">Sat</span> <span class=\"token class-name\">Jan</span> <span class=\"token number\">02</span> <span class=\"token number\">08</span><span class=\"token operator\">:</span><span class=\"token number\">00</span><span class=\"token operator\">:</span><span class=\"token number\">00</span> <span class=\"token class-name\">CST</span> <span class=\"token number\">2021</span><span class=\"token punctuation\">,</span> userid<span class=\"token operator\">=</span><span class=\"token number\">1003</span><span class=\"token punctuation\">,</span> nickname<span class=\"token operator\">=</span>山海经<span class=\"token punctuation\">,</span> createdatatim<span class=\"token operator\">=</span><span class=\"token number\">2021</span><span class=\"token operator\">-</span><span class=\"token number\">01</span><span class=\"token operator\">-</span><span class=\"token number\">02</span><span class=\"token constant\">T08</span><span class=\"token operator\">:</span><span class=\"token number\">00</span><span class=\"token punctuation\">,</span> likenum<span class=\"token operator\">=</span><span class=\"token number\">10001</span><span class=\"token punctuation\">,</span> replynum<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> state<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> parentid<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> articleid<span class=\"token operator\">=</span><span class=\"token number\">1001</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>添加一条数据</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Test</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">test1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token class-name\">Comment</span> comment <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Comment</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        comment<span class=\"token punctuation\">.</span><span class=\"token function\">setId</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        comment<span class=\"token punctuation\">.</span><span class=\"token function\">setContent</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"我天天喝\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        comment<span class=\"token punctuation\">.</span><span class=\"token function\">setPublishtime</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        comment<span class=\"token punctuation\">.</span><span class=\"token function\">setUserid</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"1001\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        comment<span class=\"token punctuation\">.</span><span class=\"token function\">setNickname</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"凯撒\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        comment<span class=\"token punctuation\">.</span><span class=\"token function\">setCreatedatatim</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">LocalDateTime</span><span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        comment<span class=\"token punctuation\">.</span><span class=\"token function\">setLikenum</span><span class=\"token punctuation\">(</span><span class=\"token number\">10003</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        comment<span class=\"token punctuation\">.</span><span class=\"token function\">setReplynum</span><span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        comment<span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        comment<span class=\"token punctuation\">.</span><span class=\"token function\">setParentid</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        comment<span class=\"token punctuation\">.</span><span class=\"token function\">setArticleid</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"1001\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        commentService<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>comment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token constant\">RUN</span> <span class=\"token class-name\">Result</span> <span class=\"token class-name\">Check</span> <span class=\"token class-name\">Terminal</span> <span class=\"token class-name\">Mongo</span> <span class=\"token class-name\">DataStatement</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">-</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token operator\">></span> db<span class=\"token punctuation\">.</span>comment<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"1\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"articleid\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"1001\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"content\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"多喝凉水\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"userid\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"1003\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"nickname\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"山海经\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"createdatatim\"</span> <span class=\"token operator\">:</span> <span class=\"token class-name\">ISODate</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"2021-01-02T00:00:00Z\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"likenum\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"10001\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"replynum\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"3\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"state\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"1\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"parentid\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"0\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"publishtime\"</span> <span class=\"token operator\">:</span> <span class=\"token class-name\">ISODate</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"2021-01-02T00:00:00Z\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"2\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"content\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"我天天喝\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"publishtime\"</span> <span class=\"token operator\">:</span> <span class=\"token class-name\">ISODate</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-05T02:26:15.397Z\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"userid\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"1001\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"nickname\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"凯撒\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"createdatatim\"</span> <span class=\"token operator\">:</span> <span class=\"token class-name\">ISODate</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-05T02:26:15.405Z\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"likenum\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">10003</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"replynum\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"state\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"1\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"parentid\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"1\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"articleid\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"1001\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"_class\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"com.dkx.domain.Comment\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr></table></figure><h3 id=\"根据上级id查询文章评论的分页列表\"><a class=\"markdownIt-Anchor\" href=\"#根据上级id查询文章评论的分页列表\">#</a> 根据上级 ID 查询文章评论的分页列表</h3>\n<p>1.CommentRepository 新增方法定义</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">com<span class=\"token punctuation\">.</span>dkx<span class=\"token punctuation\">.</span>domain<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Comment</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>domain<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Page</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>domain<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Pageable</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>mongodb<span class=\"token punctuation\">.</span>repository<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">MongoRepository</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">// 评论的持久层接口</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token annotation punctuation\">@SuppressWarnings</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"all\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">CommentRepository</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">MongoRepository</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Comment</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">//    方法名必须是 findBy 语法 Parentid 对应集合的字段的不能写错或者乱写都是不行的</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token class-name\">Page</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Comment</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findByParentid</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> parentid<span class=\"token punctuation\">,</span><span class=\"token class-name\">Pageable</span> pageable<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>2. 编写 service 代码</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * 分页查询上级 ID</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * @param parentid</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * @param page</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> * @param size</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> * @return</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">Page</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Comment</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findCommentListByParentid</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> parentid<span class=\"token punctuation\">,</span><span class=\"token keyword\">int</span> page<span class=\"token punctuation\">,</span><span class=\"token keyword\">int</span> size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   <span class=\"token keyword\">return</span> commentRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findByParentid</span><span class=\"token punctuation\">(</span>parentid<span class=\"token punctuation\">,</span> <span class=\"token class-name\">PageRequest</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>page <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>3. 测试代码：</p>\n<p>先查看集合的数据</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> db.comment.<span class=\"token function-name function\">find</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1\"</span>, <span class=\"token string\">\"articleid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1001\"</span>, <span class=\"token string\">\"content\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"多喝凉水\"</span>, <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1003\"</span>, <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"山海经\"</span>, <span class=\"token string\">\"createdatatim\"</span> <span class=\"token builtin class-name\">:</span> ISODate<span class=\"token punctuation\">(</span><span class=\"token string\">\"2021-01-02T00:00:00Z\"</span><span class=\"token punctuation\">)</span>, <span class=\"token string\">\"likenum\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"10001\"</span>, <span class=\"token string\">\"replynum\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"3\"</span>, <span class=\"token string\">\"state\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1\"</span>, <span class=\"token string\">\"parentid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"0\"</span>, <span class=\"token string\">\"publishtime\"</span> <span class=\"token builtin class-name\">:</span> ISODate<span class=\"token punctuation\">(</span><span class=\"token string\">\"2021-01-02T00:00:00Z\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2\"</span>, <span class=\"token string\">\"content\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"我天天喝\"</span>, <span class=\"token string\">\"publishtime\"</span> <span class=\"token builtin class-name\">:</span> ISODate<span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-05T02:26:15.397Z\"</span><span class=\"token punctuation\">)</span>, <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1001\"</span>, <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"凯撒\"</span>, <span class=\"token string\">\"createdatatim\"</span> <span class=\"token builtin class-name\">:</span> ISODate<span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-05T02:26:15.405Z\"</span><span class=\"token punctuation\">)</span>, <span class=\"token string\">\"likenum\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">10003</span>, <span class=\"token string\">\"replynum\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">4</span>, <span class=\"token string\">\"state\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1\"</span>, <span class=\"token string\">\"parentid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1\"</span>, <span class=\"token string\">\"articleid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1001\"</span>, <span class=\"token string\">\"_class\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"com.dkx.domain.Comment\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> ObjectId<span class=\"token punctuation\">(</span><span class=\"token string\">\"647d5340b50522086f5836bb\"</span><span class=\"token punctuation\">)</span>, <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1001\"</span>, <span class=\"token string\">\"parentid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1\"</span>, <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"刘桑\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> ObjectId<span class=\"token punctuation\">(</span><span class=\"token string\">\"647d5340b50522086f5836bc\"</span><span class=\"token punctuation\">)</span>, <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1002\"</span>, <span class=\"token string\">\"parentid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1\"</span>, <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"张三\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token builtin class-name\">:</span> ObjectId<span class=\"token punctuation\">(</span><span class=\"token string\">\"647d5340b50522086f5836bd\"</span><span class=\"token punctuation\">)</span>, <span class=\"token string\">\"userid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1004\"</span>, <span class=\"token string\">\"parentid\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1\"</span>, <span class=\"token string\">\"nickname\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"李四\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token operator\">></span></pre></td></tr></table></figure><p>parentid 为 1 的数据有 4 条，测试代码中传入查询 2 条数据</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Test</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">test2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   <span class=\"token class-name\">Page</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Comment</span><span class=\"token punctuation\">></span></span> list <span class=\"token operator\">=</span> commentService<span class=\"token punctuation\">.</span><span class=\"token function\">findCommentListByParentid</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"1\"</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Comment</span> i<span class=\"token operator\">:</span>list<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">-</span><span class=\"token constant\">RUN</span> <span class=\"token class-name\">Result</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">-</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token class-name\">Comment</span><span class=\"token punctuation\">(</span>id<span class=\"token operator\">=</span><span class=\"token number\">647d</span><span class=\"token number\">5340</span>b50522086f5836bb<span class=\"token punctuation\">,</span> content<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> publishtime<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> userid<span class=\"token operator\">=</span><span class=\"token number\">1001</span><span class=\"token punctuation\">,</span> nickname<span class=\"token operator\">=</span>刘桑<span class=\"token punctuation\">,</span> createdatatim<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> likenum<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> replynum<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> state<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> parentid<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> articleid<span class=\"token operator\">=</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h3 id=\"mongotemplate实现评论点赞\"><a class=\"markdownIt-Anchor\" href=\"#mongotemplate实现评论点赞\">#</a> MongoTemplate 实现评论点赞</h3>\n<p>我们看一下以下点赞的临时示例代码：CommentService 新增 updateThumbup 方法</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * 点赞 - 效率低</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * @Param id</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">updateCommentThumbupToIncrementingOld</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   <span class=\"token class-name\">Comment</span> comment <span class=\"token operator\">=</span> <span class=\"token class-name\">CommentRepository</span><span class=\"token punctuation\">.</span><span class=\"token function\">findById</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   comment<span class=\"token punctuation\">.</span><span class=\"token function\">setLikenum</span><span class=\"token punctuation\">(</span>comment<span class=\"token punctuation\">.</span><span class=\"token function\">getLikenum</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   <span class=\"token class-name\">CommentRepository</span><span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>comment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>以上方法虽然实现起来比较简单，但是执行效率并不高，因为我只需要将点赞数加 1 就可以了，没必要查询出所有字段修改后再更新所有字段 (蝴蝶效应)</p>\n<p>我们可以使用 MongoTemplate 类来实现对某列的操作</p>\n<p>1. 修改 CommentService</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Autowired</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">private</span> <span class=\"token class-name\">MongoTemplate</span> mongoTemplate<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">updateCommentLikenum</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   <span class=\"token comment\">//        查询对象</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   <span class=\"token class-name\">Query</span> query <span class=\"token operator\">=</span> <span class=\"token class-name\">Query</span><span class=\"token punctuation\">.</span><span class=\"token function\">query</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Criteria</span><span class=\"token punctuation\">.</span><span class=\"token function\">where</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"_id\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">is</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   <span class=\"token comment\">//        更新对象</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   <span class=\"token class-name\">Update</span> update <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Update</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   <span class=\"token comment\">//        递增 $inc</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   update<span class=\"token punctuation\">.</span><span class=\"token function\">inc</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"likenum\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>         * 参数 1：查询对象 query</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>         * 参数 2：更新对象 update</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>         * 参数 3：集合的名字或实体类的类型 Comment.class</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>         */</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>   mongoTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">updateFirst</span><span class=\"token punctuation\">(</span>query<span class=\"token punctuation\">,</span>update<span class=\"token punctuation\">,</span><span class=\"token string\">\"comment\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>2. 测试代码：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Test</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">test4</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   commentService<span class=\"token punctuation\">.</span><span class=\"token function\">updateCommentLikenum</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token constant\">RUN</span> <span class=\"token class-name\">Result</span> mongo <span class=\"token class-name\">Terminal</span> statment<span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>修改前</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"2\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"content\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"我天天喝\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"publishtime\"</span> <span class=\"token operator\">:</span> <span class=\"token class-name\">ISODate</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-05T02:26:15.397Z\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"userid\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"1001\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"nickname\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"凯撒\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"createdatatim\"</span> <span class=\"token operator\">:</span> <span class=\"token class-name\">ISODate</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-05T02:26:15.405Z\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"likenum\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">10003</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"replynum\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"state\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"1\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"parentid\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"1\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"articleid\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"1001\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"_class\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"com.dkx.domain.Comment\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>修改后</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"_id\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"2\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"content\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"我天天喝\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"publishtime\"</span> <span class=\"token operator\">:</span> <span class=\"token class-name\">ISODate</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-05T02:26:15.397Z\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"userid\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"1001\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"nickname\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"凯撒\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"createdatatim\"</span> <span class=\"token operator\">:</span> <span class=\"token class-name\">ISODate</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"2023-06-05T02:26:15.405Z\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"likenum\"</span> <span class=\"token operator\">:</span> <span class=\"token class-name\">NumberLong</span><span class=\"token punctuation\">(</span><span class=\"token number\">10004</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"replynum\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"state\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"1\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"parentid\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"1\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"articleid\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"1001\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"_class\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"com.dkx.domain.Comment\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure>",
            "tags": [
                "计算机学科",
                "database",
                "mongodb"
            ]
        }
    ]
}