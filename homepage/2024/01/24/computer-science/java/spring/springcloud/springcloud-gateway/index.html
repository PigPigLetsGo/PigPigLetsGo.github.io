<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>六、统一网关Gateway | homepage</title><meta name="author"><meta name="copyright"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="# 六、统一网关 Gateway🎄  为什么需要网关 gateway 快速入门 断言工厂 过滤器工厂 全局过滤器 跨域问题  # 6.1、为什么需要网关🌳 先看下现在的微服务结构： 我们有很多个不同的服务，每个服务都需要去访问数据库完成自己的业务功能，并且微服务都可以在 nacos 里面完成服务注册，配置管理。当微服务内部又相互调用关系时，我们就可以利用 feign 组件去做了。而外部用户需要">
<meta property="og:type" content="article">
<meta property="og:title" content="六、统一网关Gateway">
<meta property="og:url" content="https://pigpigletsgo.github.io/homepage/2024/01/24/computer-science/java/spring/springcloud/springcloud-gateway/">
<meta property="og:site_name" content="homepage">
<meta property="og:description" content="# 六、统一网关 Gateway🎄  为什么需要网关 gateway 快速入门 断言工厂 过滤器工厂 全局过滤器 跨域问题  # 6.1、为什么需要网关🌳 先看下现在的微服务结构： 我们有很多个不同的服务，每个服务都需要去访问数据库完成自己的业务功能，并且微服务都可以在 nacos 里面完成服务注册，配置管理。当微服务内部又相互调用关系时，我们就可以利用 feign 组件去做了。而外部用户需要">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png">
<meta property="article:published_time" content="2024-01-24T10:48:46.130Z">
<meta property="article:modified_time" content="2024-03-24T11:35:29.028Z">
<meta property="article:tag" content="计算机学科">
<meta property="article:tag" content="springcloud">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png"><link rel="shortcut icon" href="/homepage/img/favicon.png"><link rel="canonical" href="https://pigpigletsgo.github.io/homepage/2024/01/24/computer-science/java/spring/springcloud/springcloud-gateway/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/homepage/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/homepage/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '六、统一网关Gateway',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-03-24 19:35:29'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/homepage/atom.xml" title="homepage" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/homepage/archives/"><div class="headline">文章</div><div class="length-num">452</div></a><a href="/homepage/tags/"><div class="headline">标签</div><div class="length-num">151</div></a><a href="/homepage/categories/"><div class="headline">分类</div><div class="length-num">115</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/homepage/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/homepage/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/homepage/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a href="/homepage/" title="homepage"><span class="site-name">homepage</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/homepage/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/homepage/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/homepage/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">六、统一网关Gateway</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-01-24T10:48:46.130Z" title="发表于 2024-01-24 18:48:46">2024-01-24</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-03-24T11:35:29.028Z" title="更新于 2024-03-24 19:35:29">2024-03-24</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/homepage/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%AD%A6%E7%A7%91/">计算机学科</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/homepage/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%AD%A6%E7%A7%91/java/">java</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/homepage/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%AD%A6%E7%A7%91/java/spring/">spring</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/homepage/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%AD%A6%E7%A7%91/java/spring/springcloud/">springcloud</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="六、统一网关Gateway"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="六-统一网关gateway"><a class="anchor" href="#六-统一网关gateway">#</a> 六、统一网关 Gateway🎄</h2>
<ul>
<li>为什么需要网关</li>
<li>gateway 快速入门</li>
<li>断言工厂</li>
<li>过滤器工厂</li>
<li>全局过滤器</li>
<li>跨域问题</li>
</ul>
<h3 id="61-为什么需要网关"><a class="anchor" href="#61-为什么需要网关">#</a> 6.1、为什么需要网关🌳</h3>
<p>先看下现在的微服务结构：</p>
<p>我们有很多个不同的服务，每个服务都需要去访问数据库完成自己的业务功能，并且微服务都可以在 nacos 里面完成服务注册，配置管理。当微服务内部又相互调用关系时，我们就可以利用 feign 组件去做了。而外部用户需要访问时则让它直接发请求到微服务就行了。</p>
<p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310071145537.png" alt="image-20231007114556885" /></p>
<p>但是！这里其实存在一个问题。</p>
<p>我们微服务直接摆在那里允许任何人发请求来访问是不是不太安全呢？你要知道不是所有业务都对外公开的</p>
<p>所以我们需要对用户的身份进行验证，如果说你是符号条件的人员才能让你进去看相关的内容和操作否则拦住不让进。</p>
<p>那这件事儿就是由网关来做的。</p>
<p>一切请求一定先到网关再到微服务</p>
<p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310071149540.png" alt="image-20231007114955240" /></p>
<p>这就是网关功能之一：身份认证和权限校验</p>
<p>但是还有一个问题。</p>
<p>比如说某用户要做一个用户查询，那么网关能处理用户查询的业务吗？不能！肯定要把请求转发到对应的处理用户查询的服务。比如说 userService。因此网关必须做一件事儿了，它需要根据用户请求判断是找 userService 还是 orderService 如果弄错了就要出问题了。</p>
<p>而这个动作我们称之为：服务路由，负载均衡</p>
<h3 id="62-网关功能"><a class="anchor" href="#62-网关功能">#</a> 6.2、网关功能：🌳</h3>
<ul>
<li>身份认证和权限校验</li>
<li>服务路由，负载均衡</li>
<li>请求限流</li>
</ul>
<h3 id="63-网关的技术实现"><a class="anchor" href="#63-网关的技术实现">#</a> 6.3、网关的技术实现🌳</h3>
<p>在 SpringCloud 中网关的实现包括两种：</p>
<ul>
<li>gateway</li>
<li>zuul</li>
</ul>
<blockquote>
<p>zuul 与 gateway 对比：</p>
<p>Zuul 是基于 Servlet 的实现，属于阻塞式编程。而 SpringCloudGateway 则是基于 Spring5 中提供的 WebFlux，属于响应式编程的实现，具备更好的性能。</p>
</blockquote>
<blockquote>
<p><strong>总结</strong>：</p>
<p>网关的作用：</p>
<ul>
<li>对用户请求做身份认证，权限校验</li>
<li>将用户请求路由到微服务，并实现负载均衡</li>
<li>对用户请求做限流</li>
</ul>
</blockquote>
<h3 id="64-搭建网关服务"><a class="anchor" href="#64-搭建网关服务">#</a> 6.4、搭建网关服务🌳</h3>
<p>搭建网关服务的步骤：</p>
<p>1、创建新的 module，引入 SpringCloudGateway 的依赖和 nacos 的服务发现依赖：</p>
<figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">&lt;!-- 网关依赖 --></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-gateway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">&lt;!--nacos 服务发现依赖 --></span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><p>2、编写路由配置及 nacos 地址</p>
<figure class="highlight yml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#=========== 这些配置让网关能够联系上 nacos 实现服务注册和发现 ====</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">server</span><span class="token punctuation">:</span>                                              <span class="token comment">#||</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10010</span> <span class="token comment"># 网关端口                              #||</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token key atrule">spring</span><span class="token punctuation">:</span>                                              <span class="token comment">#||</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">application</span><span class="token punctuation">:</span>                                       <span class="token comment">#||</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token key atrule">name</span><span class="token punctuation">:</span> gateway <span class="token comment"># 服务名称                           #||</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>                                              <span class="token comment">#||</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>                                            <span class="token comment">#||</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment"># nacos 地址          #||</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">#========================================================</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">#========================= 网关路由配置 =====================</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>                                           <span class="token comment">#||</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token key atrule">routes</span><span class="token punctuation">:</span> <span class="token comment"># 网关路由配置                              ||</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> user<span class="token punctuation">-</span>service <span class="token comment"># 路由 id，自定义，只要唯一即可    ||</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token comment"># uri 有两种方式的写法                             ||</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token comment"># uri: http://127.0.0.1:8081 # 路由的目标地址 http 就是固定地址</span></pre></td></tr><tr><td data-num="17"></td><td><pre>          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//userservice <span class="token comment"># 路由的目标地址 lb (LoadBalance) 就是负载均衡，后面跟服务名称</span></pre></td></tr><tr><td data-num="18"></td><td><pre>          <span class="token key atrule">predicates</span><span class="token punctuation">:</span> <span class="token comment"># 路由断言，也就是判断请求是否符合路由规则的条件</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token punctuation">-</span> Path=/user/<span class="token important">**</span> <span class="token comment"># 这个是按照路径匹配，只要以 /user/ 开头就符合要求</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> order<span class="token punctuation">-</span>service                            <span class="token comment">#||</span></pre></td></tr><tr><td data-num="21"></td><td><pre>          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//orderservice                       <span class="token comment">#||</span></pre></td></tr><tr><td data-num="22"></td><td><pre>          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>                                  <span class="token comment">#||</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token punctuation">-</span> Path=/order/<span class="token important">**</span>                           <span class="token comment">#||</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment">#=========================================================</span></pre></td></tr></table></figure><p>访问 gateway 网关 uri：<span class="exturl" data-url="aHR0cDovL2xvY2FsaG9zdDoxMDAxMC91c2VyLzE=">http://localhost:10010/user/1</span></p>
<p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310071601031.png" alt="image-20231007160105779" /></p>
<p>503 的各种原因：</p>
<p>1、注意 yml 配置文件中的 uri 配置 lb// 服务名，是否与 nacos 中的自定义服务名相同。</p>
<ul>
<li>解释：gateway 的路由规则是基于 nacos 配置中心来定位项目的</li>
</ul>
<p>2、如果配置文件没问题，Spring Cloud 2020 版本报 503 错误，需要手动添加 loadbalancer 依赖</p>
<ul>
<li>
<p>在当前项目的 pom.xml 文件中导入如下依赖即可</p>
<figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-loadbalancer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr></table></figure></li>
</ul>
<p>再次访问 gateway 网关 uri：<span class="exturl" data-url="aHR0cDovL2xvY2FsaG9zdDoxMDAxMC91c2VyLzE=">http://localhost:10010/user/1</span></p>
<p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310071600956.png" alt="image-20231007160021450" /></p>
<p>&lt;center&gt; 路由过程流程图 &lt;/center&gt;</p>
<p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310071618234.png" alt="image-20231007161853807" /></p>
<p>微服务都可以注册到 nacos 注册中心，这时用户发送了请求，请求进入网关但是网关无法处理这个业务。所以它只能是基于路由规则去做判断，而上面我们定义了两个规则一个是把 user 请求开头的路径代理到 userservice，另一个是把 order 请求开头的路径代理到 orderservice。网关拿着 userserivce 去注册中心拉取服务列表然后做负载均衡，至此流程完毕！</p>
<blockquote>
<p><strong>总结</strong>：</p>
<p>网关搭建步骤：</p>
<ol>
<li>创建项目，引入 nacos 服务发现和 gateway 依赖</li>
<li>配置 application.yml，包括服务基本信息，nacos 地址，路由</li>
</ol>
<p>路由配置包括：</p>
<ol>
<li>路由 id：路由的唯一标示</li>
<li>路由目标 (uri)：路由的目标地址，http 代表固定地址，lb 代表根据服务名负载均衡</li>
<li>路由断言 (predicates)：判断路由的规则</li>
<li>过滤器 (filters)：对请求或响应做处理</li>
</ol>
</blockquote>
<h3 id="65-路由断言工厂route-predicate-factory"><a class="anchor" href="#65-路由断言工厂route-predicate-factory">#</a> 6.5、路由断言工厂 Route Predicate Factory🌳</h3>
<p>网关路由可以配置的内容包括：</p>
<ul>
<li>路由 id：路由唯一标示</li>
<li>uri：路由目的地，支持 lb 和 http 两种</li>
<li>&lt;font color='red'&gt;predicates：路由断言，判断请求是否符合要求，符合则转发到路由目的地 &lt;/font&gt;.</li>
<li>filters：路由过滤器，处理请求或响应</li>
</ul>
<p>断言我们知道就是一种判断的规则，那断言工厂又是什么呢？</p>
<h4 id="651-路由断言工厂route-predicate-factory"><a class="anchor" href="#651-路由断言工厂route-predicate-factory">#</a> 6.5.1、路由断言工厂 Route Predicate Factory🌲</h4>
<ul>
<li>
<p>我们在配置文件中写的断言规则只是字符串，这些字符串会被 (断言工厂) Prediacte Factory 读取并处理，转变为路由判断的条件</p>
</li>
<li>
<p>例如 Path=/user/*** 是按照路径匹配，这个规则是由</p>
<p>org.springframework.cloud.gateway.handler.predicate.PathRoutePredicateFactory 类来处理的</p>
</li>
<li>
<p>像这样的断言工厂在 SpringCloudGateway 还有十几个，每个都有自己的判断规则和条件</p>
</li>
</ul>
<p><strong>Spring 提供了 11 种基本的 Predicate 工厂</strong>：</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody>
<tr>
<td>After</td>
<td>是某个时间点后的请求</td>
<td>- After=2037-01-20T17:42:47.789-07:00[America/Denver]</td>
</tr>
<tr>
<td>Before</td>
<td>是某个时间点之前的请求</td>
<td>- Before=2031-04-13T15:14:47.433+08:00[Asia/Shanghai]</td>
</tr>
<tr>
<td>Between</td>
<td>是某两个时间点之前的请求</td>
<td>- Between=2037-01-20T17:42:47.789-07:00[America/Denver]&lt;br /&gt;,2037-01-21T17:42:47.789-07:00[America/Denver]</td>
</tr>
<tr>
<td>Cookie</td>
<td>请求必须包含某些 Cookie</td>
<td>- Cookie=chocolate，ch.p</td>
</tr>
<tr>
<td>Header</td>
<td>请求必须包含某些 header</td>
<td>- Header=X-Request-Id，\d+</td>
</tr>
<tr>
<td>Host</td>
<td>请求必须是访问某个 host (域名)</td>
<td><code>- Host**.somehost.org，**.anotherhost.org</code></td>
</tr>
<tr>
<td>Method</td>
<td>请求方式必须是指定方式</td>
<td>- Method=GET，POST</td>
</tr>
<tr>
<td>Path</td>
<td>请求路径必须符合指定规则</td>
<td>- Path=/red/{segment}，/blue/**</td>
</tr>
<tr>
<td>Query</td>
<td>请求参数必须包含指定参数</td>
<td>- Query=name，jack 或者 - Query=name</td>
</tr>
<tr>
<td>RemoteAddr</td>
<td>请求者的 ip 必须是指定范围</td>
<td>- RemoteAddr=192.168.1.1/24</td>
</tr>
<tr>
<td>Weight</td>
<td>权重处理</td>
<td></td>
</tr>
</tbody>
</table>
<p>功能演示：</p>
<figure class="highlight yml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#=========== 这些配置让网关能够联系上 nacos 实现服务注册和发现 ====</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">server</span><span class="token punctuation">:</span>                                              <span class="token comment">#||</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10010</span> <span class="token comment"># 网关端口                              #||</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token key atrule">spring</span><span class="token punctuation">:</span>                                              <span class="token comment">#||</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">application</span><span class="token punctuation">:</span>                                       <span class="token comment">#||</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token key atrule">name</span><span class="token punctuation">:</span> gateway <span class="token comment"># 服务名称                           #||</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>                                              <span class="token comment">#||</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>                                            <span class="token comment">#||</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment"># nacos 地址          #||</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">#========================================================</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">#========================= 网关路由配置 =====================</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>                                           <span class="token comment">#||</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token key atrule">routes</span><span class="token punctuation">:</span> <span class="token comment"># 网关路由配置                              ||</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> user_service <span class="token comment"># 路由 id，自定义，只要唯一即可    ||</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token comment"># uri 有两种方式的写法                             ||</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token comment"># uri: http://127.0.0.1:8081 # 路由的目标地址 http 就是固定地址</span></pre></td></tr><tr><td data-num="17"></td><td><pre>          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//userservice <span class="token comment"># 路由的目标地址 lb (LoadBalance) 就是负载均衡，后面跟服务名称</span></pre></td></tr><tr><td data-num="18"></td><td><pre>          <span class="token key atrule">predicates</span><span class="token punctuation">:</span> <span class="token comment"># 路由断言，也就是判断请求是否符合路由规则的条件</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token punctuation">-</span> Path=/user/<span class="token important">**</span> <span class="token comment"># 这个是按照路径匹配，只要以 /user/ 开头就符合要求</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> order_service                            <span class="token comment">#||</span></pre></td></tr><tr><td data-num="21"></td><td><pre>          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//orderservice                       <span class="token comment">#||</span></pre></td></tr><tr><td data-num="22"></td><td><pre>          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>                                  <span class="token comment">#||</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token punctuation">-</span> Path=/order/<span class="token important">**</span>                           <span class="token comment">#||</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            <span class="token comment"># 配置断言规则是在 2037 年之后才能访问</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token punctuation">-</span> After=2037<span class="token punctuation">-</span>01<span class="token punctuation">-</span>20T17<span class="token punctuation">:</span>42<span class="token punctuation">:</span>47.789<span class="token punctuation">-</span>07<span class="token punctuation">:</span>00<span class="token punctuation">[</span>America/Denver<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token comment">#========================================================</span></pre></td></tr></table></figure><p><mark>使用 Query 的方式如下：</mark></p>
<figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">spring</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">cloud</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token key atrule">gateway</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>      <span class="token key atrule">routes</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> test_route</pre></td></tr><tr><td data-num="6"></td><td><pre>          <span class="token key atrule">uri</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//www.baidu.com</pre></td></tr><tr><td data-num="7"></td><td><pre>          <span class="token key atrule">predicates</span><span class="token punctuation">:</span> <span class="token comment"># 断言规则当我们访问某个 url 比如：http://localhost:8088/?url=qq 那么此时就会跳转到 qq 的网址 访问 url=baidu 就到百度了</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token punctuation">-</span> Query=url<span class="token punctuation">,</span>baidu</pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> qq_route</pre></td></tr><tr><td data-num="10"></td><td><pre>          <span class="token key atrule">uri</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//www.qq.com</pre></td></tr><tr><td data-num="11"></td><td><pre>          <span class="token key atrule">predicates</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token punctuation">-</span> Query=url<span class="token punctuation">,</span>qq</pre></td></tr></table></figure><p>访问 uri：<span class="exturl" data-url="aHR0cDovLzEyNy4wLjAuMToxMDAxMC9vcmRlci8xMDE=">http://127.0.0.1:10010/order/101</span></p>
<p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310071706489.png" alt="image-20231007170619279" /></p>
<figure class="highlight yml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#=========== 这些配置让网关能够联系上 nacos 实现服务注册和发现 ====</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">server</span><span class="token punctuation">:</span>                                              <span class="token comment">#||</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10010</span> <span class="token comment"># 网关端口                              #||</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token key atrule">spring</span><span class="token punctuation">:</span>                                              <span class="token comment">#||</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">application</span><span class="token punctuation">:</span>                                       <span class="token comment">#||</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token key atrule">name</span><span class="token punctuation">:</span> gateway <span class="token comment"># 服务名称                           #||</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>                                              <span class="token comment">#||</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>                                            <span class="token comment">#||</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment"># nacos 地址          #||</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">#========================================================</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">#========================= 网关路由配置 =====================</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>                                           <span class="token comment">#||</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token key atrule">routes</span><span class="token punctuation">:</span> <span class="token comment"># 网关路由配置                              ||</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> user_service <span class="token comment"># 路由 id，自定义，只要唯一即可    ||</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token comment"># uri 有两种方式的写法                             ||</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token comment"># uri: http://127.0.0.1:8081 # 路由的目标地址 http 就是固定地址</span></pre></td></tr><tr><td data-num="17"></td><td><pre>          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//userservice <span class="token comment"># 路由的目标地址 lb (LoadBalance) 就是负载均衡，后面跟服务名称</span></pre></td></tr><tr><td data-num="18"></td><td><pre>          <span class="token key atrule">predicates</span><span class="token punctuation">:</span> <span class="token comment"># 路由断言，也就是判断请求是否符合路由规则的条件</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token punctuation">-</span> Path=/user/<span class="token important">**</span> <span class="token comment"># 这个是按照路径匹配，只要以 /user/ 开头就符合要求</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> order_service                            <span class="token comment">#||</span></pre></td></tr><tr><td data-num="21"></td><td><pre>          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//orderservice                       <span class="token comment">#||</span></pre></td></tr><tr><td data-num="22"></td><td><pre>          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>                                  <span class="token comment">#||</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token punctuation">-</span> Path=/order/<span class="token important">**</span>                           <span class="token comment">#||</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            <span class="token comment"># 配置断言规则是在 2037 年之后才能访问</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token punctuation">-</span> Before=2037<span class="token punctuation">-</span>01<span class="token punctuation">-</span>20T17<span class="token punctuation">:</span>42<span class="token punctuation">:</span>47.789<span class="token punctuation">-</span>07<span class="token punctuation">:</span>00<span class="token punctuation">[</span>America/Denver<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token comment">#========================================================</span></pre></td></tr></table></figure><p>访问 uri：<span class="exturl" data-url="aHR0cDovLzEyNy4wLjAuMToxMDAxMC9vcmRlci8xMDE=">http://127.0.0.1:10010/order/101</span></p>
<p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310071707263.png" alt="image-20231007170751853" /></p>
<blockquote>
<p><strong>总结</strong>：</p>
<ul>
<li>
<p>PredicateFactory 的作用是什么？</p>
<p>读取用户定义的断言条件，对请求做判断</p>
</li>
<li>
<p>Path=/user/** 是什么含义？</p>
<p>路径是以 /user 开头的就认为是符合的</p>
</li>
</ul>
</blockquote>
<h3 id="66-路由过滤gatewayfilter"><a class="anchor" href="#66-路由过滤gatewayfilter">#</a> 6.6、路由过滤 GatewayFilter🌳</h3>
<p>GatewayFilter 是网关中提供的一种过滤器，可以对进入网关的<mark>请求</mark>和微服务返回的<mark>响应</mark>做<mark>处理</mark>。</p>
<p>请求：</p>
<blockquote>
<p>当用户向网关发起请求时，需要先做路由里面会有一个断言工厂它可以基于我们配置的规则完成请求路由去判断到底应该到哪个微服务。但是路由之后也并不能直接向微服务发起请求。因为我们还可以给路由配置各种各样的过滤器</p>
</blockquote>
<p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310071746074.png" alt="image-20231007174642784" /></p>
<blockquote>
<p>这些过滤器会形成一个过滤器链。那么用户的请求就一定要经过这些过滤器链，然后才能到达微服务。</p>
<p>那么在这个过程当中过滤器就可以对进入网关的请求做各种处理。比如说对请求头或者请求参数做什么处理都是没问题的。</p>
</blockquote>
<p>响应：</p>
<blockquote>
<p>当用户请求给微服务后，微服务处理完了要返回一个结果。而这个结果肯定也是先到达了网关，网关同样会经过过滤器链来逐层处理这个响应结果，最终才会返回给用户</p>
</blockquote>
<p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310071754515.png" alt="image-20231007175153476" /></p>
<blockquote>
<p>那么在这个过程当中过滤器可以对响应做些什么事儿呢？比如说把响应头检查一下加一些头信息之类的</p>
</blockquote>
<p>对请求或响应做出各种各样的处理，具体能做出什么样的处理那就要看 Spring 里面提供的过滤工厂了</p>
<h4 id="661-过滤器工厂gatewayfilterfactory"><a class="anchor" href="#661-过滤器工厂gatewayfilterfactory">#</a> 6.6.1、过滤器工厂 GatewayFilterFactory🌲</h4>
<p>Spring 提供了 31 种不同的路由过滤器工厂。例如：</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>AddRequestHeader</td>
<td>给当前请求添加一个请求头</td>
</tr>
<tr>
<td>RemoveRequestHeader</td>
<td>移除请求中的一个请求头</td>
</tr>
<tr>
<td>AddResponseHeader</td>
<td>给响应结果中添加一个响应头</td>
</tr>
<tr>
<td>RemoveResponseHeader</td>
<td>从响应结果中移除有一个响应头</td>
</tr>
<tr>
<td>RequestRateLimiter</td>
<td>限制请求的流量</td>
</tr>
<tr>
<td>…</td>
<td></td>
</tr>
</tbody>
</table>
<h5 id="6611-代码案例"><a class="anchor" href="#6611-代码案例">#</a> 6.6.1.1、代码案例🌴</h5>
<p><strong>给所有进入 userservice 的请求添加一个请求头</strong>.</p>
<p>给所有进入 userservice 的请求添加一个请求头：Truth=itcast is freaking awesome!</p>
<p>实现方式：</p>
<p>在 gateway 中修改 application.yml 文件，给 userservice 的路由添加过滤器：</p>
<figure class="highlight yml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">spring</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">cloud</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>                                          </pre></td></tr><tr><td data-num="4"></td><td><pre>      <span class="token key atrule">routes</span><span class="token punctuation">:</span> <span class="token comment"># 网关路由配置                              </span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> user_service <span class="token comment"># 路由 id，自定义，只要唯一即可   </span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token comment"># uri 有两种方式的写法                             </span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token comment"># uri: http://127.0.0.1:8081 # 路由的目标地址 http 就是固定地址</span></pre></td></tr><tr><td data-num="8"></td><td><pre>          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//userservice <span class="token comment"># 路由的目标地址 lb (LoadBalance) 就是负载均衡，后面跟服务名称</span></pre></td></tr><tr><td data-num="9"></td><td><pre>          <span class="token key atrule">predicates</span><span class="token punctuation">:</span> <span class="token comment"># 路由断言，也就是判断请求是否符合路由规则的条件</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token punctuation">-</span> Path=/user/<span class="token important">**</span> <span class="token comment"># 这个是按照路径匹配，只要以 /user/ 开头就符合要求</span></pre></td></tr><tr><td data-num="11"></td><td><pre>          <span class="token key atrule">filters</span><span class="token punctuation">:</span> <span class="token comment"># 过滤器</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token punctuation">-</span> AddRequestHeader=Truth<span class="token punctuation">,</span>Itcast is freaking awesome<span class="token tag">!</span> <span class="token comment"># 添加请求头</span></pre></td></tr></table></figure><p>在 UserController 类中编写 queryById 使用注解 @RequestHeader 获取请求头的信息，加上 require=false 表示没获取到也没有关系，不加会报错。输出请求头的信息</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Slf4j</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@RestController</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/user"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">UserService</span> userService<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/&#123;id&#125;"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token function">queryById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestHeader</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"Truth"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> truth<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"truth: "</span> <span class="token operator">+</span> truth<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token keyword">return</span> userService<span class="token punctuation">.</span><span class="token function">queryById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>访问 uri：<span class="exturl" data-url="aHR0cDovL2xvY2FsaG9zdDoxMDAxMC91c2VyLzE=">http://localhost:10010/user/1</span></p>
<p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310071926883.png" alt="image-20231007192552616" /></p>
<p>可以正常访问我们查看 idea 控制台中 user-service 的打印有没有请求体信息输出的那句话</p>
<p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310071928357.png" alt="image-20231007192850157" /></p>
<p>可以看到请求头信息被打印出来了。</p>
<p>但是有个问题，我如果想要给全部的微服务都加请求头信息呢，这时可以使用默认过滤器来配置</p>
<h5 id="6612-默认过滤器"><a class="anchor" href="#6612-默认过滤器">#</a> 6.6.1.2、默认过滤器🌴</h5>
<p>如果要对所有的路由都生效，则可以将过滤器工厂写到 default 下。格式如下：</p>
<figure class="highlight yml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">spring</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">cloud</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>                                          </pre></td></tr><tr><td data-num="4"></td><td><pre>      <span class="token key atrule">routes</span><span class="token punctuation">:</span> <span class="token comment"># 网关路由配置                              </span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> user_service <span class="token comment"># 路由 id，自定义，只要唯一即可   </span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token comment"># uri 有两种方式的写法                             </span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token comment"># uri: http://127.0.0.1:8081 # 路由的目标地址 http 就是固定地址</span></pre></td></tr><tr><td data-num="8"></td><td><pre>          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//userservice <span class="token comment"># 路由的目标地址 lb (LoadBalance) 就是负载均衡，后面跟服务名称</span></pre></td></tr><tr><td data-num="9"></td><td><pre>          <span class="token key atrule">predicates</span><span class="token punctuation">:</span> <span class="token comment"># 路由断言，也就是判断请求是否符合路由规则的条件</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token punctuation">-</span> Path=/user/<span class="token important">**</span> <span class="token comment"># 这个是按照路径匹配，只要以 /user/ 开头就符合要求</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token key atrule">default-filters</span><span class="token punctuation">:</span> <span class="token comment"># 默认过滤器，会对所有的路由请求都生效</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token punctuation">-</span> AddRequestHeader=Truth<span class="token punctuation">,</span>Itcast is freaking awesome<span class="token tag">!</span> <span class="token comment"># 添加请求头</span></pre></td></tr></table></figure><p>多访问几次 uri：<span class="exturl" data-url="aHR0cDovL2xvY2FsaG9zdDoxMDAxMC91c2VyLzE=">http://localhost:10010/user/1</span></p>
<p>查看每个服务的打印信息是否有请求头信息</p>
<p>8081</p>
<p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310071938856.png" alt="image-20231007193808029" /></p>
<p>8082</p>
<p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310071938158.png" alt="image-20231007193834963" /></p>
<p>8083</p>
<p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310071939348.png" alt="image-20231007193903983" /></p>
<blockquote>
<p><strong>总结</strong>：</p>
<ul>
<li>过滤器的作用是什么？
<ol>
<li>对路由的请求或响应做加工处理，比如添加请求头</li>
<li>配置在路由下的过滤器只对当前路由的请求生效</li>
</ol>
</li>
<li>defaultFilters 的作用是什么？
<ol>
<li>对所有路由都生效的过滤器</li>
</ol>
</li>
</ul>
</blockquote>
<h4 id="662-全局过滤器globalfilter"><a class="anchor" href="#662-全局过滤器globalfilter">#</a> 6.6.2、全局过滤器 GlobalFilter🌲</h4>
<p>全局过滤器的作用也是处理一切进入网关的请求和微服务响应，与 GatewayFilter 的作用一样。</p>
<p>区别在于 GatewayFilter 通过配置定义，处理逻辑是固定的。而 GlobalFilter 的逻辑需要自己写代码实现可操作性更高。</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ClobalFilter</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>   <span class="token comment">/**</pre></td></tr><tr><td data-num="4"></td><td><pre>   * 处理当前请求，有必要的话通过 &#123;@link GatewayFilterChain&#125; 将请求交给下一个过滤器处理</pre></td></tr><tr><td data-num="5"></td><td><pre>   *</pre></td></tr><tr><td data-num="6"></td><td><pre>   * @param exchange 请求上下文，里面可以获取 Request，Response 等信息</pre></td></tr><tr><td data-num="7"></td><td><pre>   * @param chain 用来把请求委托给下一个过滤器</pre></td></tr><tr><td data-num="8"></td><td><pre>   * @return &#123;@code Mono&lt;Void>&#125; 返回标示当前过滤器业务结束</pre></td></tr><tr><td data-num="9"></td><td><pre>   */</span></pre></td></tr><tr><td data-num="10"></td><td><pre>   <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h5 id="6621-代码案例"><a class="anchor" href="#6621-代码案例">#</a> 6.6.2.1、代码案例🌴</h5>
<p><strong>定义全局过滤器，拦截并判断用户身份</strong>.</p>
<p>需求：定义全局过滤器，拦截请求，判断请求的参数是否满足下面条件：</p>
<ul>
<li>参数中是否有 authorization</li>
<li>authorization 参数值是否为 admin</li>
</ul>
<p>如果同时满足则放行，否则拦截</p>
<p>在 gateway 服务中创建一个 AuthorizeFilter 类实现 GlobalFilter 接口并重写过滤器方法来达到自己的目的</p>
<p>目的：请求头有 authorization=admin 的信息则可以访问网关后的服务，否则拦截</p>
<p>@Order：配置多个过滤器的执行优先级 21 亿到负 21 亿  数值越小优先级越高</p>
<p>也可以实现 Ordered 并重写 getOrder 函数来实现多过滤器执行优先级</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>gateway<span class="token punctuation">.</span>filter<span class="token punctuation">.</span></span><span class="token class-name">GatewayFilterChain</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>gateway<span class="token punctuation">.</span>filter<span class="token punctuation">.</span></span><span class="token class-name">GlobalFilter</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Order</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpStatus</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span>server<span class="token punctuation">.</span>reactive<span class="token punctuation">.</span></span><span class="token class-name">ServerHttpRequest</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">MultiValueMap</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>server<span class="token punctuation">.</span></span><span class="token class-name">ServerWebExchange</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">reactor<span class="token punctuation">.</span>core<span class="token punctuation">.</span>publisher<span class="token punctuation">.</span></span><span class="token class-name">Mono</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="12"></td><td><pre> * @author Dkx</pre></td></tr><tr><td data-num="13"></td><td><pre> * @version 1.0</pre></td></tr><tr><td data-num="14"></td><td><pre> * @2023/10/719:53</pre></td></tr><tr><td data-num="15"></td><td><pre> * @function</pre></td></tr><tr><td data-num="16"></td><td><pre> * @comment</pre></td></tr><tr><td data-num="17"></td><td><pre> */</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment">// @Order：设置多个过滤器执行的优先级顺序，可以通过注解也可以通过方法</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token annotation punctuation">@Component</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthorizeFilter</span> <span class="token keyword">implements</span> <span class="token class-name">GlobalFilter</span><span class="token comment">/*, Ordered*/</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token comment">// 1. 获取请求参数</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token class-name">ServerHttpRequest</span> request <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token class-name">MultiValueMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> params <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getQueryParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token comment">// 2. 获取参数中的 authorization 参数</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token class-name">String</span> auth <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">getFirst</span><span class="token punctuation">(</span><span class="token string">"authorization"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token comment">// 3. 判断参数值是否等于 admin</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>auth<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>            <span class="token comment">// 4. 是，放行</span></pre></td></tr><tr><td data-num="33"></td><td><pre>            <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token comment">// 5. 否拦截</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token comment">// 5.1 设置状态码返回给用户</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setStatusCode</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">UNAUTHORIZED</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token comment">// 5.2 拦截请求</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token keyword">return</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token comment">/*</pre></td></tr><tr><td data-num="43"></td><td><pre>    重写执行过滤器优先级的方法</pre></td></tr><tr><td data-num="44"></td><td><pre>    @Override</pre></td></tr><tr><td data-num="45"></td><td><pre>    public int getOrder () &#123;</pre></td></tr><tr><td data-num="46"></td><td><pre>        return -1;</pre></td></tr><tr><td data-num="47"></td><td><pre>    &#125;</pre></td></tr><tr><td data-num="48"></td><td><pre>*/</span></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>访问 uri：<span class="exturl" data-url="aHR0cDovLzEyNy4wLjAuMToxMDAxMC91c2VyLzE=">http://127.0.0.1:10010/user/1</span></p>
<p>次 uri 没有写在请求头信息 authorization=admin</p>
<p>结果：</p>
<p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310072014686.png" alt="image-20231007201452411" /></p>
<p>由于访问被拦截所以服务在 idea 中控制台没有打印任何请求的响应数据</p>
<p>这次携带上请求头信息 authorization=admin 再进行访问 uri：<span class="exturl" data-url="aHR0cDovLzEyNy4wLjAuMToxMDAxMC91c2VyLzE/YXV0aG9yaXphdGlvbj1hZG1pbg==">http://127.0.0.1:10010/user/1?authorization=admin</span></p>
<p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310072015402.png" alt="image-20231007201545206" /></p>
<p>访问成功！</p>
<blockquote>
<p><strong>总结</strong>：</p>
<ul>
<li>
<p>全局过滤器的作用是什么？</p>
<p>对所有路由都生效的过滤器，并且可以自定义处理逻辑</p>
</li>
<li>
<p>实现全局过滤器的步骤？</p>
<ol>
<li>实现 GlobalFilter 接口</li>
<li>添加 @Order 注解或实现 Ordered 接口</li>
<li>编写处理逻辑</li>
</ol>
</li>
</ul>
</blockquote>
<h4 id="663-过滤器执行顺序"><a class="anchor" href="#663-过滤器执行顺序">#</a> 6.6.3、过滤器执行顺序🌲</h4>
<p>请求进入网关会碰到三类过滤器：当前路由的过滤器，DefaultFilter，GlobalFilter</p>
<p>&lt;font color='red'&gt; 请求路由后 &lt;/font&gt;，会将当前路由过滤器和 DefaultFilter，GlobalFilter，合并到一个过滤器链 (集合) 中，排序后依次执行每个过滤器</p>
<p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310072025396.png" alt="image-20231007202537098" /></p>
<p>网关中所有过滤器最终都是 GatewayFilter 类型，既然是同一种类型那就可以存到一个集合中去做排序了</p>
<p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310072029369.png" alt="image-20231007202943934" /></p>
<p>新的问题是，怎么排序呢？</p>
<ul>
<li>每一个过滤器都必须指定一个 int 类型的 order 值，<mark>order 值越小，优先级越高，执行顺序越靠前</mark>。</li>
<li>GlobalFilter 通过实现 Ordered 接口，或者添加 @Order 注解来指定 order 值，由我们自己指定</li>
<li>路由过滤器和 defaultFilter 的 order 由 Spring 指定，默认是按照声明顺序从 1 递增。</li>
<li>&lt;font color='red'&gt; 当过滤器的 order 值一样时 &lt;/font&gt;，会按照 defaultFilter &gt; 路由过滤器 &gt; GlobalFilter 的顺序执行。</li>
</ul>
<p>默认按照声明顺序从 1 递增的解释：</p>
<blockquote>
<p>每个过滤器声明时有一个 order 值标记每加一个就会递增 order 值，而且路由过滤器和 defaultFilter 两个 order 是分开的，还有自定义的 GlobalFilter 我们自己设置 order 值也可能会一样，值都冲突了该怎么排序呢？</p>
</blockquote>
<figure class="highlight yml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">spring</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">cloud</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>                                          </pre></td></tr><tr><td data-num="4"></td><td><pre>      <span class="token key atrule">routes</span><span class="token punctuation">:</span> <span class="token comment"># 网关路由配置                              </span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> user_service <span class="token comment"># 路由 id，自定义，只要唯一即可   </span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token comment"># uri 有两种方式的写法                             </span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token comment"># uri: http://127.0.0.1:8081 # 路由的目标地址 http 就是固定地址</span></pre></td></tr><tr><td data-num="8"></td><td><pre>          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//userservice <span class="token comment"># 路由的目标地址 lb (LoadBalance) 就是负载均衡，后面跟服务名称</span></pre></td></tr><tr><td data-num="9"></td><td><pre>          <span class="token key atrule">predicates</span><span class="token punctuation">:</span> <span class="token comment"># 路由断言，也就是判断请求是否符合路由规则的条件</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token punctuation">-</span> Path=/user/<span class="token important">**</span> <span class="token comment"># 这个是按照路径匹配，只要以 /user/ 开头就符合要求</span></pre></td></tr><tr><td data-num="11"></td><td><pre>          <span class="token key atrule">filters</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token punctuation">-</span> AddRequestHeader=Truth<span class="token punctuation">,</span>Itcast is freaking awesome<span class="token tag">!</span> <span class="token comment"># order 1</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token punctuation">-</span> AxxxHeader=Truth<span class="token punctuation">,</span>Itcast is freaking awesome<span class="token tag">!</span> <span class="token comment"># order 2</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token punctuation">-</span> AxxxHeader=Truth<span class="token punctuation">,</span>Itcast is freaking awesome<span class="token tag">!</span> <span class="token comment"># order 3</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token key atrule">default-filters</span><span class="token punctuation">:</span> <span class="token comment"># 默认过滤器，会对所有的路由请求都生效</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token punctuation">-</span> AddRequestHeader=Truth<span class="token punctuation">,</span>Itcast is freaking awesome<span class="token tag">!</span> <span class="token comment"># order 1</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token punctuation">-</span> AxxxHeader=Truth<span class="token punctuation">,</span>Itcast is freaking awesome<span class="token tag">!</span> <span class="token comment"># order 2</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token punctuation">-</span> AxxxHeader=Truth<span class="token punctuation">,</span>Itcast is freaking awesome<span class="token tag">!</span> <span class="token comment"># order 3</span></pre></td></tr></table></figure><p>可以参考下面几个类的源码来查看：</p>
<p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310072041796.png" alt="image-20231007204141622" /></p>
<blockquote>
<p><strong>总结</strong>：</p>
<ul>
<li>路由过滤器，defaultFilter，全局过滤器的执行顺序？
<ol>
<li>order 值越小，优先级越高</li>
<li>当 order 值一样时，顺序是 defaultFilter 最先，然后是局部的路由过滤器，最后是全局过滤器</li>
</ol>
</li>
</ul>
</blockquote>
<h3 id="67-跨域问题处理"><a class="anchor" href="#67-跨域问题处理">#</a> 6.7、跨域问题处理🌳</h3>
<blockquote>
<p>在学习前后端分离项目时已经学习过了解决跨域问题，那为什么在微服务中还要学习跨域问题呢？</p>
<p>这是因为在微服务中所有的请求都要先经过网关再到微服务，也就是说跨域请求你不需要在每个微服务里都去处理。仅仅在网关处理就可以了，但是网关又跟我们以前实现不一样，网关是基于 WebFlux 实现的，没有 Servlet 相关的 API 因此我们以前所学的解决方案不一定能够适用。</p>
</blockquote>
<p>跨域：域名不一致就是跨域，主要包括：</p>
<ul>
<li>域名不同：<span class="exturl" data-url="aHR0cDovL3d3dy50YW9iYW8ueG4tLWNvbXd3dy1rNzZqLnRhb2Jhby54bi0tb3Jnd3d3LWs3NmouamQueG4tLWNvbW1pYW9zaGEtamg3cS5qcy5jb20=">www.taobao.com 和 www.taobao.org 和 www.jd.com 和 miaosha.js.com</span></li>
<li>域名相同，端口不同：localhost:8080 和 loclahost:8081</li>
<li>但是我们前面学习一直用的 8080 访问 8081 端口的数据就没有出现什么问题啊这是怎么回事呢？</li>
</ul>
<p><strong>原因</strong>：跨域问题：<mark>浏览器禁止</mark>请求的发起者与服务端发生跨域<mark> ajax 请求</mark>，请求被浏览器拦截的问题</p>
<p>order-service 和 user-service 和浏览器没有关系，也没有用到 ajax 所以不会出现跨域问题</p>
<p><mark>解决方案</mark>：CORS</p>
<h4 id="671-演示案例"><a class="anchor" href="#671-演示案例">#</a> 6.7.1、演示案例🌲</h4>
<p>前端页面</p>
<p>index.html</p>
<figure class="highlight html"><figcaption data-lang="HTML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>X-UA-Compatible<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ie=edge<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Document<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://unpkg.com/axios/dist/axios.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript"></pre></td></tr><tr><td data-num="13"></td><td><pre>  axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"http://localhost:10010/user/1?authorization=admin"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">resp</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><p>访问页面后查看浏览器控制台的打印信息</p>
<p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310072111173.png" alt="image-20231007211114669" /></p>
<p>这里有严重的问题因为 gateway 服务配置文件允许跨域的请求不可能是上图中 uri 的样子，我们需要使用一个服务器启动页面然后将 uri 允许跨域请求即可，比如我下面是使用 tomcat 启动的这个页面端口号为：8898</p>
<p>可以看到报错了说是跨域问题</p>
<p><strong>网关处理跨域采用的同样是 CORS 方案，并且只需要简单配置即可实现</strong>：</p>
<figure class="highlight yml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#=========== 这些配置让网关能够联系上 nacos 实现服务注册和发现 ====</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">server</span><span class="token punctuation">:</span>                                              <span class="token comment">#||</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10010</span> <span class="token comment"># 网关端口                              #||</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token key atrule">spring</span><span class="token punctuation">:</span>                                              <span class="token comment">#||</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">application</span><span class="token punctuation">:</span>                                       <span class="token comment">#||</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token key atrule">name</span><span class="token punctuation">:</span> gateway <span class="token comment"># 服务名称                           #||</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>                                              <span class="token comment">#||</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>                                            <span class="token comment">#||</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment"># nacos 地址          #||</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">#========================================================</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">#========================= 网关路由配置 =====================</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>                                           <span class="token comment">#||</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token key atrule">routes</span><span class="token punctuation">:</span> <span class="token comment"># 网关路由配置                              ||</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> user_service <span class="token comment"># 路由 id，自定义，只要唯一即可    ||</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token comment"># uri 有两种方式的写法                             ||</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token comment"># uri: http://127.0.0.1:8081 # 路由的目标地址 http 就是固定地址</span></pre></td></tr><tr><td data-num="17"></td><td><pre>          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//userservice <span class="token comment"># 路由的目标地址 lb (LoadBalance) 就是负载均衡，后面跟服务名称</span></pre></td></tr><tr><td data-num="18"></td><td><pre>          <span class="token key atrule">predicates</span><span class="token punctuation">:</span> <span class="token comment"># 路由断言，也就是判断请求是否符合路由规则的条件</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token punctuation">-</span> Path=/user/<span class="token important">**</span> <span class="token comment"># 这个是按照路径匹配，只要以 /user/ 开头就符合要求</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment">#          filters: # 过滤器</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment">#            - AddRequestHeader=Truth,Itcast is freaking awesome! # 添加请求头</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> order_service                            <span class="token comment">#||</span></pre></td></tr><tr><td data-num="23"></td><td><pre>          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//orderservice                       <span class="token comment">#||</span></pre></td></tr><tr><td data-num="24"></td><td><pre>          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>                                  <span class="token comment">#||</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token punctuation">-</span> Path=/order/<span class="token important">**</span>                           <span class="token comment">#||</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token comment"># 配置断言规则是在 2037 年之后才能访问</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token punctuation">-</span> Before=2037<span class="token punctuation">-</span>01<span class="token punctuation">-</span>20T17<span class="token punctuation">:</span>42<span class="token punctuation">:</span>47.789<span class="token punctuation">-</span>07<span class="token punctuation">:</span>00<span class="token punctuation">[</span>America/Denver<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="28"></td><td><pre>      <span class="token key atrule">default-filters</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token punctuation">-</span> AddRequestHeader=Truth<span class="token punctuation">,</span>Itcast is freaking awesome<span class="token tag">!</span> <span class="token comment"># 添加请求头</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token comment">#=========================== 全局的跨域处理 =============================</span></pre></td></tr><tr><td data-num="31"></td><td><pre>      <span class="token key atrule">globalcors</span><span class="token punctuation">:</span> <span class="token comment"># 全局的跨域处理                                    #||</span></pre></td></tr><tr><td data-num="32"></td><td><pre>      <span class="token comment"># ajax 采用的是 cors 方案，cors 是浏览器去问服务器让不让这个请求跨域，     ||</span></pre></td></tr><tr><td data-num="33"></td><td><pre>      <span class="token comment"># 但是这个请求方式是  option，默认情况下这种请求会被网关拦截的，而加上这个配置就是不拦截           # option 请求，这样 cors 请求就能正常发出了。                         ||</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token key atrule">add-to-simple-url-handler-mapping</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 解决 options 请求被拦截问题</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token key atrule">corsConfigurations</span><span class="token punctuation">:</span>                                        <span class="token comment">#||</span></pre></td></tr><tr><td data-num="36"></td><td><pre>          <span class="token key atrule">'[/**]'</span><span class="token punctuation">:</span>                                                 <span class="token comment">#||</span></pre></td></tr><tr><td data-num="37"></td><td><pre>            <span class="token key atrule">allowedOrigins</span><span class="token punctuation">:</span> <span class="token comment"># 允许哪些网站的跨域请求                   #||</span></pre></td></tr><tr><td data-num="38"></td><td><pre>              <span class="token comment"># - "http://localhost:8090"                            #||</span></pre></td></tr><tr><td data-num="39"></td><td><pre>                <span class="token punctuation">-</span> <span class="token string">"http://localhost:8898"</span>                    <span class="token comment">#||</span></pre></td></tr><tr><td data-num="40"></td><td><pre>            <span class="token key atrule">allowedMethods</span><span class="token punctuation">:</span> <span class="token comment"># 允许的跨域 ajax 的请求方式                #||</span></pre></td></tr><tr><td data-num="41"></td><td><pre>              <span class="token punctuation">-</span> <span class="token string">"GET"</span>                                              <span class="token comment">#||</span></pre></td></tr><tr><td data-num="42"></td><td><pre>              <span class="token punctuation">-</span> <span class="token string">"POST"</span>                                             <span class="token comment">#||</span></pre></td></tr><tr><td data-num="43"></td><td><pre>              <span class="token punctuation">-</span> <span class="token string">"DELETE"</span>                                           <span class="token comment">#||</span></pre></td></tr><tr><td data-num="44"></td><td><pre>              <span class="token punctuation">-</span> <span class="token string">"PUT"</span>                                              <span class="token comment">#||</span></pre></td></tr><tr><td data-num="45"></td><td><pre>              <span class="token punctuation">-</span> <span class="token string">"OPTIONS"</span>                                          <span class="token comment">#||</span></pre></td></tr><tr><td data-num="46"></td><td><pre>            <span class="token key atrule">allowedHeaders</span><span class="token punctuation">:</span> <span class="token string">"*"</span> <span class="token comment"># 允许在请求中携带的头信息             #||</span></pre></td></tr><tr><td data-num="47"></td><td><pre>            <span class="token key atrule">allowCredentials</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 是否允许携带 cookie              #||</span></pre></td></tr><tr><td data-num="48"></td><td><pre>            <span class="token key atrule">maxAge</span><span class="token punctuation">:</span> <span class="token number">360000</span> <span class="token comment"># 这次跨域检测的有效期                     #||</span></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token comment">#====================================================================</span></pre></td></tr></table></figure><p>重启 Gateway 服务然后再访问 uri：<span class="exturl" data-url="aHR0cDovL2xvY2FsaG9zdDo4ODk4L2luZGV4Lmh0bWw=">http://localhost:8898/index.html</span></p>
<p>配置文件中本机地址是 localhost 就不要用 127.0.0.1 这样也会被跨域拦截</p>
<p><img data-src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310072130838.png" alt="image-20231007213052264" /></p>
<blockquote>
<p><strong>总结</strong>：</p>
<p>CORS 跨域要配置的参数包括哪几个？</p>
<ul>
<li>允许哪些域名跨域？</li>
<li>允许哪些请求头？</li>
<li>允许哪些请求方式？</li>
<li>是否允许使用 cookie？</li>
<li>有效期是多久？</li>
</ul>
</blockquote>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://pigpigletsgo.github.io/homepage"></a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://pigpigletsgo.github.io/homepage/2024/01/24/computer-science/java/spring/springcloud/springcloud-gateway/">https://pigpigletsgo.github.io/homepage/2024/01/24/computer-science/java/spring/springcloud/springcloud-gateway/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://pigpigletsgo.github.io/homepage" target="_blank">homepage</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/homepage/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%AD%A6%E7%A7%91/">计算机学科</a><a class="post-meta__tags" href="/homepage/tags/springcloud/">springcloud</a></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/homepage/2024/01/24/computer-science/java/spring/springcloud/springcloud-http%E5%AE%A2%E6%88%B7%E7%AB%AFFeign/" title="五、http客户端Feign"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">五、http客户端Feign</div></div></a></div><div class="next-post pull-right"><a href="/homepage/2024/01/24/computer-science/java/spring/springcloud/SpringBoot%E6%95%B4%E5%90%88docker%E9%83%A8%E7%BD%B2xxl-job-2.3.1/" title="XXL-JOB介绍和使用"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">XXL-JOB介绍和使用</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/homepage/2024/01/24/computer-science/java/spring/springcloud/SpringBoot%E6%95%B4%E5%90%88docker%E9%83%A8%E7%BD%B2xxl-job-2.3.1/" title="XXL-JOB介绍和使用"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-01-24</div><div class="title">XXL-JOB介绍和使用</div></div></a></div><div><a href="/homepage/2024/01/24/computer-science/java/spring/springcloud/SpringCloud%E5%85%A5%E9%97%A8/" title="一、SpringCloud入门|介绍"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-01-24</div><div class="title">一、SpringCloud入门|介绍</div></div></a></div><div><a href="/homepage/2024/01/24/computer-science/java/spring/springcloud/springcloud-Ribbon%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/" title="三、Ribbon负载均衡"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-01-24</div><div class="title">三、Ribbon负载均衡</div></div></a></div><div><a href="/homepage/2024/01/24/computer-science/java/spring/springcloud/springcloud-http%E5%AE%A2%E6%88%B7%E7%AB%AFFeign/" title="五、http客户端Feign"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-01-24</div><div class="title">五、http客户端Feign</div></div></a></div><div><a href="/homepage/2024/01/24/computer-science/java/spring/springcloud/springcloud-%E6%9C%8D%E5%8A%A1%E6%8B%86%E5%88%86%E5%8F%8A%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8/" title="二、服务拆分及远程调用"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-01-24</div><div class="title">二、服务拆分及远程调用</div></div></a></div><div><a href="/homepage/2024/03/18/computer-science/java/spring/springcloud/Docker/docker%E5%AE%B9%E5%99%A8%E4%B8%80%E9%94%AE%E5%90%AF%E5%8A%A8%E5%92%8C%E5%85%B3%E9%97%AD/" title="docker一键启动和关闭，删除所有镜像"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-03-18</div><div class="title">docker一键启动和关闭，删除所有镜像</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/homepage/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name"></div><div class="author-info__description">欢迎来我的博客空间</div></div><div class="card-info-data site-data is-center"><a href="/homepage/archives/"><div class="headline">文章</div><div class="length-num">452</div></a><a href="/homepage/tags/"><div class="headline">标签</div><div class="length-num">151</div></a><a href="/homepage/categories/"><div class="headline">分类</div><div class="length-num">115</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD-%E7%BB%9F%E4%B8%80%E7%BD%91%E5%85%B3gateway"><span class="toc-number">1.</span> <span class="toc-text"> 六、统一网关 Gateway🎄</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#61-%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E7%BD%91%E5%85%B3"><span class="toc-number">1.1.</span> <span class="toc-text"> 6.1、为什么需要网关🌳</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#62-%E7%BD%91%E5%85%B3%E5%8A%9F%E8%83%BD"><span class="toc-number">1.2.</span> <span class="toc-text"> 6.2、网关功能：🌳</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#63-%E7%BD%91%E5%85%B3%E7%9A%84%E6%8A%80%E6%9C%AF%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.3.</span> <span class="toc-text"> 6.3、网关的技术实现🌳</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#64-%E6%90%AD%E5%BB%BA%E7%BD%91%E5%85%B3%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.4.</span> <span class="toc-text"> 6.4、搭建网关服务🌳</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#65-%E8%B7%AF%E7%94%B1%E6%96%AD%E8%A8%80%E5%B7%A5%E5%8E%82route-predicate-factory"><span class="toc-number">1.5.</span> <span class="toc-text"> 6.5、路由断言工厂 Route Predicate Factory🌳</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#651-%E8%B7%AF%E7%94%B1%E6%96%AD%E8%A8%80%E5%B7%A5%E5%8E%82route-predicate-factory"><span class="toc-number">1.5.1.</span> <span class="toc-text"> 6.5.1、路由断言工厂 Route Predicate Factory🌲</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#66-%E8%B7%AF%E7%94%B1%E8%BF%87%E6%BB%A4gatewayfilter"><span class="toc-number">1.6.</span> <span class="toc-text"> 6.6、路由过滤 GatewayFilter🌳</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#661-%E8%BF%87%E6%BB%A4%E5%99%A8%E5%B7%A5%E5%8E%82gatewayfilterfactory"><span class="toc-number">1.6.1.</span> <span class="toc-text"> 6.6.1、过滤器工厂 GatewayFilterFactory🌲</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#6611-%E4%BB%A3%E7%A0%81%E6%A1%88%E4%BE%8B"><span class="toc-number">1.6.1.1.</span> <span class="toc-text"> 6.6.1.1、代码案例🌴</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6612-%E9%BB%98%E8%AE%A4%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">1.6.1.2.</span> <span class="toc-text"> 6.6.1.2、默认过滤器🌴</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#662-%E5%85%A8%E5%B1%80%E8%BF%87%E6%BB%A4%E5%99%A8globalfilter"><span class="toc-number">1.6.2.</span> <span class="toc-text"> 6.6.2、全局过滤器 GlobalFilter🌲</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#6621-%E4%BB%A3%E7%A0%81%E6%A1%88%E4%BE%8B"><span class="toc-number">1.6.2.1.</span> <span class="toc-text"> 6.6.2.1、代码案例🌴</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#663-%E8%BF%87%E6%BB%A4%E5%99%A8%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F"><span class="toc-number">1.6.3.</span> <span class="toc-text"> 6.6.3、过滤器执行顺序🌲</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#67-%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86"><span class="toc-number">1.7.</span> <span class="toc-text"> 6.7、跨域问题处理🌳</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#671-%E6%BC%94%E7%A4%BA%E6%A1%88%E4%BE%8B"><span class="toc-number">1.7.1.</span> <span class="toc-text"> 6.7.1、演示案例🌲</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><div class="content"><a class="title" href="/homepage/2024/04/02/computer-science/java/%E7%9F%A5%E8%AF%86%E7%82%B9/lambda/%E5%A6%99%E7%94%A8Function%E5%87%BD%E6%95%B0%E5%BC%8F%E6%8E%A5%E5%8F%A3%E6%B6%88%E7%81%ADif-else/" title="Function函数式接口">Function函数式接口</a><time datetime="2024-04-02T01:52:46.687Z" title="发表于 2024-04-02 09:52:46">2024-04-02</time></div></div><div class="aside-list-item"><div class="content"><a class="title" href="/homepage/2024/04/01/computer-science/database/%E7%9F%A5%E8%AF%86%E7%82%B9/%E6%89%B9%E9%87%8F%E5%88%A0%E9%99%A4%E6%95%B0%E6%8D%AE%E5%BA%93%E6%89%80%E6%9C%89%E8%A1%A8/" title="批量删除数据库所有表">批量删除数据库所有表</a><time datetime="2024-04-01T01:34:35.867Z" title="发表于 2024-04-01 09:34:35">2024-04-01</time></div></div><div class="aside-list-item"><div class="content"><a class="title" href="/homepage/2024/04/01/computer-science/java/%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93/%E9%80%9A%E8%BF%87%E6%89%8B%E6%9C%BA%E5%8F%B7%E8%8E%B7%E5%8F%96%E5%BD%92%E5%B1%9E%E5%9C%B0%E5%92%8C%E8%BF%90%E8%90%A5%E5%95%86/" title="通过手机号获取归属地和运营商">通过手机号获取归属地和运营商</a><time datetime="2024-04-01T01:06:59.408Z" title="发表于 2024-04-01 09:06:59">2024-04-01</time></div></div><div class="aside-list-item"><div class="content"><a class="title" href="/homepage/2024/03/31/computer-science/database/%E7%9F%A5%E8%AF%86%E7%82%B9/%E7%94%B5%E5%95%86%E9%A1%B9%E7%9B%AE%E4%B8%AD%E7%9A%84SKU%E4%B8%8ESPU%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8%E8%AE%BE%E8%AE%A1/" title="电商项目中的SKU与SPU的数据库表设计">电商项目中的SKU与SPU的数据库表设计</a><time datetime="2024-03-31T06:32:26.858Z" title="发表于 2024-03-31 14:32:26">2024-03-31</time></div></div><div class="aside-list-item"><div class="content"><a class="title" href="/homepage/2024/03/31/computer-science/database/navicat/navicat%E6%A8%A1%E5%9E%8B-%E6%B8%85%E7%90%86%E8%A1%A8%E4%B9%8B%E9%97%B4%E7%9A%84%E5%85%B3%E7%B3%BB/" title="navicat模型-清理表之间的关系">navicat模型-清理表之间的关系</a><time datetime="2024-03-31T02:56:00.245Z" title="发表于 2024-03-31 10:56:00">2024-03-31</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By null</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/homepage/js/utils.js?v=4.13.0"></script><script src="/homepage/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>