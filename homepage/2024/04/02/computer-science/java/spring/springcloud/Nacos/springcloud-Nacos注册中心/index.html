<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>四、Nacos注册中心 | homepage</title><meta name="author"><meta name="copyright"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="# 四、Nacos 注册中心🎄  认识和安装 Nacos Nacos 快速入门 Nacos 服务分级存储模型 Nacos 环境隔离  # 4.1、认识 Nacos🌳 Nacos 是阿里巴巴的产品，现在是 SpringCloud 中的一个组件。相比 Eureka 功能更加丰富，在国内受欢迎程度较高。  安装和启动教程详细查看：点击查看. # 4.2、服务注册到 Nacos🌳 1、在 cloud">
<meta property="og:type" content="article">
<meta property="og:title" content="四、Nacos注册中心">
<meta property="og:url" content="https://pigpigletsgo.github.io/homepage/2024/04/02/computer-science/java/spring/springcloud/Nacos/springcloud-Nacos%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83/">
<meta property="og:site_name" content="homepage">
<meta property="og:description" content="# 四、Nacos 注册中心🎄  认识和安装 Nacos Nacos 快速入门 Nacos 服务分级存储模型 Nacos 环境隔离  # 4.1、认识 Nacos🌳 Nacos 是阿里巴巴的产品，现在是 SpringCloud 中的一个组件。相比 Eureka 功能更加丰富，在国内受欢迎程度较高。  安装和启动教程详细查看：点击查看. # 4.2、服务注册到 Nacos🌳 1、在 cloud">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png">
<meta property="article:published_time" content="2024-04-02T10:00:51.032Z">
<meta property="article:modified_time" content="2024-03-24T04:24:29.400Z">
<meta property="article:tag" content="计算机学科">
<meta property="article:tag" content="springcloud">
<meta property="article:tag" content="Nacos">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png"><link rel="shortcut icon" href="/homepage/img/favicon.png"><link rel="canonical" href="https://pigpigletsgo.github.io/homepage/2024/04/02/computer-science/java/spring/springcloud/Nacos/springcloud-Nacos%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/homepage/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/homepage/',
  algolia: undefined,
  localSearch: {"path":"/homepage/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '四、Nacos注册中心',
  isPost: true,
  isHome: false,
  isHighlightShrink: true,
  isToc: true,
  postUpdate: '2024-03-24 12:24:29'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/homepage/atom.xml" title="homepage" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/homepage/archives/"><div class="headline">文章</div><div class="length-num">452</div></a><a href="/homepage/tags/"><div class="headline">标签</div><div class="length-num">151</div></a><a href="/homepage/categories/"><div class="headline">分类</div><div class="length-num">115</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/homepage/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/homepage/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/homepage/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page" href="/homepage/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a href="/homepage/" title="homepage"><span class="site-name">homepage</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/homepage/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/homepage/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/homepage/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page" href="/homepage/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">四、Nacos注册中心</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-04-02T10:00:51.032Z" title="发表于 2024-04-02 18:00:51">2024-04-02</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-03-24T04:24:29.400Z" title="更新于 2024-03-24 12:24:29">2024-03-24</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/homepage/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%AD%A6%E7%A7%91/">计算机学科</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/homepage/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%AD%A6%E7%A7%91/java/">java</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/homepage/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%AD%A6%E7%A7%91/java/spring/">spring</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/homepage/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%AD%A6%E7%A7%91/java/spring/springcloud/">springcloud</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/homepage/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%AD%A6%E7%A7%91/java/spring/springcloud/Nacos/">Nacos</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="四、Nacos注册中心"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="四-nacos注册中心"><a class="markdownIt-Anchor" href="#四-nacos注册中心">#</a> 四、Nacos 注册中心🎄</h2>
<ul>
<li>认识和安装 Nacos</li>
<li>Nacos 快速入门</li>
<li>Nacos 服务分级存储模型</li>
<li>Nacos 环境隔离</li>
</ul>
<h3 id="41-认识nacos"><a class="markdownIt-Anchor" href="#41-认识nacos">#</a> 4.1、认识 Nacos🌳</h3>
<p><a target="_blank" rel="noopener" href="http://nacos.io/zh-cn/">Nacos</a> 是阿里巴巴的产品，现在是<a target="_blank" rel="noopener" href="https://spring.io/projects/spring-cloud"> SpringCloud</a> 中的一个组件。相比<a target="_blank" rel="noopener" href="https://github.com/Netflix/eureka"> Eureka</a> 功能更加丰富，在国内受欢迎程度较高。</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051155062.png" alt="image-20231005115513961"></p>
<p><strong>安装和启动教程详细查看</strong>：<a href="Nacos/Nacos%E5%AE%89%E8%A3%85%E6%8C%87%E5%8D%97.md">点击查看</a>.</p>
<h3 id="42-服务注册到nacos"><a class="markdownIt-Anchor" href="#42-服务注册到nacos">#</a> 4.2、服务注册到 Nacos🌳</h3>
<p>1、在 cloud-demo 父工程中添加 spring-cloud-alibaba 的管理依赖：</p>
<figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">&lt;!--nacos 管理依赖 --></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-alibaba-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.2.5.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">></span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><p>2、注释掉 order-service 和 user-service 中原有的 eureka 依赖。</p>
<p>3、添加 nacos 的客户端依赖：</p>
<figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">&lt;!-- nacos 客户端依赖包 --></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><p>4、修改 user-service &amp; order-service 中的 application.yml 文件，注释 eureka 地址，添加 nacos 地址：</p>
<figure class="highlight yml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">spring</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">cloud</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token key atrule">nacos</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment"># nacos 服务地址</span></pre></td></tr></table></figure><p><mark>PS</mark>：在当前启动类中添加注解：@EnableDiscoveryClient (服务发现)</p>
<p>5、启动并测试</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051308798.png" alt="image-20231005130842602"></p>
<blockquote>
<p><strong>总结</strong>：</p>
<ol>
<li>Nacos 服务搭建
<ol>
<li>下载安装包</li>
<li>解压</li>
<li>在 bin 目录下运行指令：startup.cmd -m standalone</li>
</ol>
</li>
<li>Nacos 服务注册或发现
<ol>
<li>引入 nacos.discovery 依赖</li>
<li>配置 nacos 地址 spring.cloud.nacos.server-addr</li>
<li>在当前启动类中添加 @EnableDiscoveryClient 注解，用于服务发现</li>
</ol>
</li>
</ol>
</blockquote>
<h3 id="43-nacos服务分级存储模型"><a class="markdownIt-Anchor" href="#43-nacos服务分级存储模型">#</a> 4.3、Nacos 服务分级存储模型🌳</h3>
<p><strong>服务</strong>：提供用户查询的 user service ，提供订单查询的 order-service 都叫<mark>服务</mark>.</p>
<p>user-service 还部署了多个实例：8081，8082，8083</p>
<p>所以我们之前是分为两层概念的：</p>
<p>一层是服务，而第二层就是实例，一个服务可以包含多个实例</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051420619.png" alt="image-20231005142022420"></p>
<p>不过随着业务规模越来越扩大，那么我们就要考虑更多的问题了。</p>
<blockquote>
<p>比如说我们把所有的实例都部署到一个机房，这就像把所有的鸡蛋都放到一个篮子里一样，不小心将篮子打翻了那么里面所有的蛋也就全部都打了，如果是机房哪天天灾人祸出了事儿，那这整个服务不就完了。所以为了解决这个问题我们会将一个服务的多个实例部署到多个机房。</p>
</blockquote>
<p>特别像阿里巴巴，京东这样的大公司，给全国各地都整一个。这就像我们把鸡蛋分散开了，一个打了我还有好几篮子呢。</p>
<p>这样就能做到一种叫 <strong>容灾</strong>.</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051425151.png" alt="image-20231005142511407"></p>
<p>而 Nacos 服务分级存储模型就是引入了这样一个机房的概念或者叫地域的概念。它把同在一个机房的多个实例称为一个集群</p>
<p>比如说：杭州两个机房的 userService 实例就称之为杭州的 userService 集群</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051430517.png" alt="image-20231005143046790"></p>
<p>所以在 Nacos 服务分级存储模型中一级是服务往下是集群再往下就是实例</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051432046.png" alt="image-20231005143242380"></p>
<p><strong>为什么 Nacos 要引入这样的一个服务分级的模型呢？我原来直接用服务找实例不好吗？为什么要多加一个地域划分集群的一个概念？</strong></p>
<h4 id="431-服务跨集群调用问题"><a class="markdownIt-Anchor" href="#431-服务跨集群调用问题">#</a> 4.3.1、服务跨集群调用问题🌲</h4>
<p>我们设想这样一种情况：</p>
<p>比方说 我有一个杭州的机房里面有 order-service 集群还有 user-service 的集群。还有还有一个上海的机房里面也是同样的配置</p>
<p>现在，order-service 需要访问 user-service 那么有两种选择：一种是在自己本地局域网内访问，另一种是去外面机房访问</p>
<p>局域网内访问速度比较快，延迟比较低</p>
<blockquote>
<p>服务调用尽可能选择本地集群的服务，跨集群调用延迟较高</p>
<p>本地集群不可访问时，再去访问其它集群</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051442382.png" alt="image-20231005144140180"></p>
<p>但是现在我们还没有配置集群属性，看下 nacos 控制台</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051506788.png" alt="image-20231005150616402"></p>
<p>可以看到集群名称为：Default 默认，没有集群</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051507220.png" alt="image-20231005150745644"></p>
<h3 id="44-服务集群属性"><a class="markdownIt-Anchor" href="#44-服务集群属性">#</a> 4.4、服务集群属性🌳</h3>
<p>1、修改 application.yml，添加如下内容：</p>
<figure class="highlight yml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">spring</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">cloud</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token key atrule">nacos</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment"># nacos 服务端地址</span></pre></td></tr><tr><td data-num="5"></td><td><pre>      <span class="token key atrule">discovery</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token key atrule">cluster-name</span><span class="token punctuation">:</span> HZ <span class="token comment"># 配置集群名称，也就是机房位置，这里 HZ 代指杭州</span></pre></td></tr></table></figure><p>2、我们创建两个服务来模拟演示集群三个分别代表不同的位置</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051510774.png" alt="image-20231005151045217"></p>
<p>具体的操作步骤看动图：</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051518637.gif" alt="test"></p>
<p>3、查看 nacos 的情况</p>
<p>可以看到成功启动了三个集群</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051513016.png" alt="image-20231005151355371"></p>
<p>查看详细，别分是不同的位置的集群</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051515250.png" alt="image-20231005151517180"></p>
<blockquote>
<p><strong>总结</strong>：</p>
<ol>
<li>Nacos 服务分级存储模型
<ol>
<li>一级是服务，例如 userservice</li>
<li>二级是集群，例如杭州或上海</li>
<li>三级是实例，例如杭州机房的某台部署了 userservice 的服务器</li>
</ol>
</li>
<li>如何设置实例的集群属性
<ol>
<li>修改 application.yml 文件，添加 spring.cloud.nacos.discovery.cluster-name 属性即可</li>
</ol>
</li>
</ol>
</blockquote>
<p>我们将 user-service 的 8081 服务和 8082 服务还有 8083 服务分别设置到了不同位置的集群但是我们最终想要实现的是 order-service 远程调用 user-service 时，优先选择本地集群。那因此呢我们还需要给 order-service 也配置一个集群属性</p>
<h4 id="441-根据集群负载均衡"><a class="markdownIt-Anchor" href="#441-根据集群负载均衡">#</a> 4.4.1、根据集群负载均衡🌲</h4>
<p>1、在 order-service 服务中的 application.yml 中进行配置</p>
<figure class="highlight yml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">spring</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">cloud</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token key atrule">nacos</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment"># nacos 服务端地址</span></pre></td></tr><tr><td data-num="5"></td><td><pre>      <span class="token key atrule">discovery</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token key atrule">cluster-name</span><span class="token punctuation">:</span> HZ <span class="token comment"># 配置集群名称，也就是机房位置，这里 HZ 代指杭州</span></pre></td></tr></table></figure><p>配置完成后启动 order-service 服务</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051531329.png" alt="image-20231005153152984"></p>
<p>查看 nacos 信息 order-service 是否与 user-service 处于 HZ 集群</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051533345.png" alt="image-20231005153349541"></p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051534369.png" alt="image-20231005153426289"></p>
<p>2、然后在 order-service 中设置负载均衡的 IRule 为 NacosRule，这个规则优先会寻找与自己同集群的服务：</p>
<figure class="highlight yml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 给指定的微服务进行集群负载均衡的配置</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">userservice</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token key atrule">ribbon</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token key atrule">NFLoadBalancerRuleClassName</span><span class="token punctuation">:</span> com.alibaba.cloud.nacos.ribbon.NacosRule <span class="token comment"># 负载均衡规则</span></pre></td></tr></table></figure><p>3、访问 order-service 服务 3 次查看轮询结果</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051630022.gif" alt="test"></p>
<p>访问第一次：</p>
<figure class="highlight sh"><figcaption data-lang="sh"></figcaption><table><tr><td data-num="1"></td><td><pre>http://127.0.0.1:8080/order/101</pre></td></tr></table></figure><p>访问第二次：</p>
<figure class="highlight sh"><figcaption data-lang="sh"></figcaption><table><tr><td data-num="1"></td><td><pre>http://127.0.0.1:8080/order/102</pre></td></tr></table></figure><p>访问第三次：</p>
<figure class="highlight sh"><figcaption data-lang="sh"></figcaption><table><tr><td data-num="1"></td><td><pre>http://127.0.0.1:8080/order/103</pre></td></tr></table></figure><p>8081</p>
<pre><code>Creating a new SqlSession
SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@20d32e8c] was not registered for synchronization because synchronization is not active
JDBC Connection [HikariProxyConnection@773117158 wrapping com.mysql.cj.jdbc.ConnectionImpl@1a9c99e4] will not be managed by Spring
==&gt;  Preparing: select * from tb_user where id = ? 
==&gt; Parameters: 1(Long)
&lt;==    Columns: id, username, address
&lt;==        Row: 1, 柳岩, 湖南省衡阳市
&lt;==      Total: 1
Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@20d32e8c]
Creating a new SqlSession
SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@4c31c2cf] was not registered for synchronization because synchronization is not active
JDBC Connection [HikariProxyConnection@1123427641 wrapping com.mysql.cj.jdbc.ConnectionImpl@1a9c99e4] will not be managed by Spring
==&gt;  Preparing: select * from tb_user where id = ? 
==&gt; Parameters: 2(Long)
&lt;==    Columns: id, username, address
&lt;==        Row: 2, 文二狗, 陕西省西安市
&lt;==      Total: 1
Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@4c31c2cf]
Creating a new SqlSession
SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@16810291] was not registered for synchronization because synchronization is not active
JDBC Connection [HikariProxyConnection@407305777 wrapping com.mysql.cj.jdbc.ConnectionImpl@1a9c99e4] will not be managed by Spring
==&gt;  Preparing: select * from tb_user where id = ? 
==&gt; Parameters: 3(Long)
&lt;==    Columns: id, username, address
&lt;==        Row: 3, 华沉鱼, 湖北省十堰市
&lt;==      Total: 1
Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@16810291]
</code></pre>
<p>8082</p>
<pre><code></code></pre>
<p>8083</p>
<pre><code></code></pre>
<p>可以看到优先选择的是本地集群的服务，但是也会有可能选择远程的集群。</p>
<p>它并不是轮询调用本机集群或者远程集群而是一种没有规律的随机的调用方式</p>
<p>如果说 user-service:8081 这个服务挂掉了呢？ 将 8081 关闭我们再次访问</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051635074.png" alt="image-20231005163505936"></p>
<p>此时 8083 就被请求了打印出了消息</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051635696.png" alt="image-20231005163557083"></p>
<p>但是在 order-service 中控制台中就会打印一个警告</p>
<p>警告的意思就是：发生了一次跨集群的访问 order-service 访问 user-service 位置为 HZ 的集群但是却访问了 SH</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051637118.png" alt="image-20231005163756874"></p>
<p>通过这次测试我们得出 NacosRule 它其实优先访问的是本地，本地没有它才会进行跨集群访问，而跨集群就会发出一次警告</p>
<p>3、注意将 user-service 的权重都设置为 1</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051641100.png" alt="image-20231005164127314"></p>
<blockquote>
<p><strong>总结</strong>：</p>
<ol>
<li>NacosRule 负载均衡策略
<ol>
<li>优先选择同集群服务实例列表</li>
<li>本地集群找不到提供者，才去其它集群寻找，并且会报警告</li>
<li>确定了可用实例列表后，再采用随机负载均衡挑选实例</li>
</ol>
</li>
</ol>
</blockquote>
<h4 id="442-根据权重负载均衡"><a class="markdownIt-Anchor" href="#442-根据权重负载均衡">#</a> 4.4.2、根据权重负载均衡🌲</h4>
<blockquote>
<p>上集，我们学习了 Nacos 的负载均衡的一种规则 NacosRule，它可以做到<mark>集群优先的负载均衡</mark>。不过我们部署的时候可能出现这样的情况，由于企业设备会更新迭代有些机器性能比较好，还有一些属于是祖传设备了性能非常差，可以说老弱病残。这时候我们肯定希望这些性能好的机器它承担更多的用户请求，而哪些性能差一点的自然承担少一点的用户请求。但是我们目前看来 NacosRule 做到的是集群优先而后做随机。当用户请求完了以后它可不会管你机器性能好还是差的拉过来就是一顿叫这时性能差的机器肯定就出问题了。</p>
<p>那么我们要怎么去控制不同服务它请求的量呢？</p>
<p>Nacos 给我们提供了一种权重的配置</p>
</blockquote>
<p><strong>实际部署中会出现这样的场景</strong>：</p>
<ul>
<li>服务器设备性能有差异，部分实例所在机器性能较好，另一些较差，我们希望性能好的机器承担更多的用户请求</li>
</ul>
<p>Nacos 提供了权重配置来控制访问频率，权重越大则访问频率越高</p>
<h4 id="443-权重配置操作"><a class="markdownIt-Anchor" href="#443-权重配置操作">#</a> 4.4.3、权重配置操作：🌲</h4>
<p>1、在 Nacos 控制台可以设置实例的权重值，首先选中实例后面的编辑按钮</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051655722.png" alt="image-20231005165528544"></p>
<p>2、将权重设置为 0.1，测试可以发现 8081 被访问到的频率大大降低</p>
<p>权重值配置范围：0 ~ 1</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051656163.png" alt="image-20231005165622001"></p>
<p>查看下目前的集群情况</p>
<p>order-service</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051659631.png" alt="image-20231005165920414"></p>
<p>user-service</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051700588.png" alt="image-20231005170021931"></p>
<p>在没有配置权重值都是相同的情况下访问 3 次 order-service 打印的信息如下</p>
<p>user-service:8081 打印了全部的信息，8082,8083 都没有</p>
<p>我们将 8081 这个集群的权重值设置为 0 在进行测试</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310051940128.png" alt="image-20231005194035918"></p>
<p>访问 order-service 刷新页面 10 次打印的信息如下</p>
<p>8081 没有信息，8082 有信息，8083 有信息</p>
<blockquote>
<p><strong>总结</strong>：</p>
<ol>
<li>实例的权重控制
<ol>
<li>Nacos 控制台可以设置实例的权重值，0 ~ 1 之间</li>
<li>同集群内的多个实例，权重越高被访问的频率越高</li>
<li>权重设置为 0 则完全不会被访问</li>
</ol>
</li>
</ol>
</blockquote>
<h3 id="45-环境隔离-namespace"><a class="markdownIt-Anchor" href="#45-环境隔离-namespace">#</a> 4.5、环境隔离 - namespace🌳</h3>
<p>Nacos 中服务存储和数据存储的最外层都是一个名为 namespace 的东西，用来做最外层隔离</p>
<blockquote>
<p>将来可以有多个 namespace 可以理解为多个蛋，相互之间是隔离开的，在 namespace 内部有一个 group 属性。也就是说同一个命名空间的多个东西我们将来还可以分组，组内就是具体的东西了。比如说服务，服务再往下就是集群，再往下就是实例。</p>
</blockquote>
<p>这里我们的环境隔离其实就是在对服务做隔离</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310052013655.png" alt="image-20231005201313765"></p>
<p>为什么需要隔离呢？</p>
<p>服务划分，实例划分这是基于业务去做的划分或者是地域但事实上我们还会有开发环境，生产环境，测试环境的变化所以我们会基于这种环境变化去做隔离。</p>
<p>我们可以吧业务相关度比较高的放在一组中</p>
<p>1、在 Nacos 控制台可以创建 namespace，用来隔离不同环境</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310052024412.png" alt="image-20231005202456034"></p>
<p>2、然后填写一个新的命名空间信息</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310052025744.png" alt="image-20231005202536537"></p>
<p>3、保存后会在控制台看到这个命名空间的 id</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310052026832.png" alt="image-20231005202632739"></p>
<p>4、修改 order-service 的 application.yml，添加 namespace</p>
<figure class="highlight yml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">spring</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">datasource</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>3306/cloud_user<span class="token punctuation">?</span>useSSL=false<span class="token important">&amp;characterEncoding=utf-8&amp;serverTimezone=UTC</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token key atrule">username</span><span class="token punctuation">:</span> root</pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token key atrule">password</span><span class="token punctuation">:</span> dkx.</pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver</pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">application</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token key atrule">name</span><span class="token punctuation">:</span> userservice</pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">cloud</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">nacos</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment"># nacos 服务端地址</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token key atrule">discovery</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token key atrule">cluster-name</span><span class="token punctuation">:</span> TJ <span class="token comment"># 集群名称，这里 HZ 代指杭州</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ed32fa6f<span class="token punctuation">-</span>e9e3<span class="token punctuation">-</span>4483<span class="token punctuation">-</span>b860<span class="token punctuation">-</span>7bcd9731d0d9 <span class="token comment"># 命名空间，填 ID</span></pre></td></tr></table></figure><p>5、刷新 nacos 页面</p>
<p>order-service 就不在 public 中了</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310052032144.png" alt="image-20231005203254198"></p>
<p>而是到了 dev 中了，它们两个已经不是同一个位置的服务了</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310052033504.png" alt="image-20231005203322946"></p>
<p>我们访问的话就会报错：</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310052034062.png" alt="image-20231005203400951"></p>
<p><strong>idea 控制台报错提示为</strong>：<font color='red'>找不到可用的实例</font>.</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310052034175.png" alt="image-20231005203453936"></p>
<p>所以要想让服务可以访问必须是同一个环境下</p>
<blockquote>
<p><strong>总结</strong>：</p>
<ol>
<li>Nacos 环境隔离
<ol>
<li>namespace 用来做环境隔离</li>
<li>每个 namespace 都有唯一 id</li>
<li>不同 namespace 下的服务不可见
<ul>
<li>如果想要两个服务可以访问必须把它们放到同一个 namespace 下</li>
</ul>
</li>
</ol>
</li>
</ol>
</blockquote>
<h3 id="46-nacos注册中心细节分析"><a class="markdownIt-Anchor" href="#46-nacos注册中心细节分析">#</a> 4.6、nacos 注册中心细节分析🌳</h3>
<p>服务提供者在启动时，都会把自己的信息提交给注册中心。而注册中心就会把这些信息保留下来</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310052039311.png" alt="image-20231005203942965"></p>
<p>当服务消费者要消费时它就可以去找注册中心拉取服务信息了。不过这个拉取的动作不是每一次都要做的它会将拉取到的服务信息缓存到一个列表中</p>
<p>当然如果缓存一直不更新也是不行的万一服务提供者信息变化了呢，所以这个列表会每隔 30 秒重新拉取一次，进行一个更新</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310052042295.png" alt="image-20231005204255542"></p>
<p>消费者拿到服务列表以后再去负载均衡挑选一个发起远程调用就可以了</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310052045232.png" alt="image-20231005204549665"></p>
<p>但是 nacos 与 eureka 还是有一些差别，差别就在于服务提供者的健康检测</p>
<p>nacos 会把<mark>服务提供者划分成</mark><strong>临时实例</strong>和<strong>非临时实例</strong>。</p>
<p>在 nacos 页面中挑选一个服务查看 详情就可以看到 临时实例还是非临时实例了</p>
<p>如下图，nacos 中默认就是临时实例，而临时实例与非临时实例在 nacos 中做健康监测是不一样的</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310052048533.png" alt="image-20231005204834080"></p>
<h4 id="461-临时实例"><a class="markdownIt-Anchor" href="#461-临时实例">#</a> 4.6.1、临时实例🌲</h4>
<p>临时实例，听其名认为它是将来可能人为的把服务停掉的，所以它在 nacos 中做健康监测时采用的是心跳检测</p>
<p>如果服务提供者心跳不跳了超过时间就会被 nacos 从服务列表中剔除</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310052051280.png" alt="image-20231005205144644"></p>
<h4 id="462-非临时实例"><a class="markdownIt-Anchor" href="#462-非临时实例">#</a> 4.6.2、非临时实例🌲</h4>
<blockquote>
<p>非临时实例中 nacos 不会去做心跳，那么这时健康监测是怎么监测的呢？</p>
<p>是由 nacos 主动发请求去询问服务提供者：“诶！你还活着吗？”，如果它没回应 nacos 并不会将它从服务列表中剔除而是标记为不健康了，它们等着这个服务恢复健康</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310052056840.png" alt="image-20231005205645566"></p>
<p>这是一个 nacos 与 eureka 之间的差别，但是还有一个差别在于消费者</p>
<p>eureka 采用的是定时拉取每隔 30 秒拉取一次，如果有服务提供者在 30 秒内挂掉了那消费者不知道吧，它不知道提供者挂了还直接去消费就会出问题了。</p>
<p>所以 eureka 做服务定时拉取它服务列表更新的这个效率比较差 (更新不够及时)</p>
<p>而 nacos 它做了一个叫推送消息。也就是 eureka 采用的是 pull，而 nacos 采用的是 pull+push 两者结合</p>
<p>假设 nacos 发现服务提供者挂了，它就会立即发送一条消息推送给我们的服务消费者，然后服务消费者就赶紧更新</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310052101513.png" alt="image-20231005210145076"></p>
<p>这就是 eureka 与 nacos 之间的一些差别了！</p>
<h4 id="463-临时实例和非临时实例"><a class="markdownIt-Anchor" href="#463-临时实例和非临时实例">#</a> 4.6.3、临时实例和非临时实例🌲</h4>
<p>服务注册到 nacos 时，可以选择注册为临时实例或非临时实例，通过下面的配置来设置：</p>
<figure class="highlight yml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">spring</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">cloud</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token key atrule">nacos</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span></pre></td></tr><tr><td data-num="5"></td><td><pre>      <span class="token key atrule">discovery</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token key atrule">ephemeral</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># 设置是否为临时实例 设置为非临时实例</span></pre></td></tr></table></figure><p>临时实例宕机时，会从 nacos 的服务列表中剔除，而非临时实例则不会</p>
<p>​	在 order-service 中进行配置为非临时实例，再去 nacos 中查看 orderservice 的详情</p>
<p>可以看到临时实例为 false，表示为非临时实例了</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310052131922.png" alt="image-20231005213059792"></p>
<p>这时我们将 order-service 服务停掉</p>
<p>由于是非临时实例，就算服务提供者挂掉了 注册中心 也不会将其从服务列表中剔除掉，标红表示这个服务挂掉了</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310052132484.png" alt="image-20231005213247819"></p>
<p>如果改为临时实例</p>
<figure class="highlight yml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">spring</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">cloud</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token key atrule">nacos</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span></pre></td></tr><tr><td data-num="5"></td><td><pre>      <span class="token key atrule">discovery</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token key atrule">ephemeral</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 设置是否为临时实例 设置为非临时实例</span></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310052134138.png" alt="image-20231005213417852"></p>
<p>我们再次将 order-service 服务停掉，然后再刷新页面或者返回到这个页面时发现关掉的服务被 注册中心 给剔除掉了不在服务列表中了。</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310052134361.png" alt="image-20231005213452133"></p>
<h5 id="4631-cap理论"><a class="markdownIt-Anchor" href="#4631-cap理论">#</a> 4.6.3.1、CAP 理论🌴</h5>
<p>C 一致性，A 高可用，P 分区容错性</p>
<ul>
<li>
<p>eureka 只支持 AP</p>
</li>
<li>
<p>nacos 支持 CP 和 AP 两种</p>
<p>nacos 是根据配置识别 CP 或 AP 模式，如果注册 Nacos 的 client 节点注册时是 ephemeral=true 即为临时节点，那么 Nacos 集群对这个 client 节点效果就是 AP，反之则是 CP，既不是临时节点</p>
</li>
</ul>
<blockquote>
<p><strong>总结</strong>：</p>
<ol>
<li>Nacos 与 eureka 的共同点
<ol>
<li>都支持服务注册和服务拉取</li>
<li>都支持服务提供者心跳方式做健康检测</li>
</ol>
</li>
<li>Nacos 与 Eureka 的区别
<ol>
<li>Nacos 支持服务端主动检测提供者状态：
<ol>
<li>临时实例采用心跳模式</li>
<li>非临时实例采用主动检测模式</li>
</ol>
</li>
<li>临时实例心跳不正常会被剔除，非临时实例则不会被剔除 (除非手动删除)</li>
<li>Nacos 支持服务列表变更的消息推送模式，服务列表更新及时</li>
<li>Nacos 集群默认采用 AP 方式，当集群中存在非临时实例时，采用 CP 模式；Eureka 采用 AP 方式</li>
</ol>
</li>
</ol>
</blockquote>
<h3 id="47-nacos配置管理"><a class="markdownIt-Anchor" href="#47-nacos配置管理">#</a> 4.7、Nacos 配置管理🌳</h3>
<ul>
<li>统一配置管理</li>
<li>配置热更新</li>
<li>配置共享</li>
<li>搭建 Naocs 集群</li>
</ul>
<h4 id="471-统一配置管理"><a class="markdownIt-Anchor" href="#471-统一配置管理">#</a> 4.7.1、统一配置管理🌲</h4>
<p>上面学习我们搭建了两个微服务，每个服务里面的业务都需要完成数据库的查询，并且服务之间还会有一个相互调用。而完成相互调用我们的做法是让服务注册到注册中心，然后消费者就可以从注册中心完成服务的发现，实现服务获取和负载均衡。完成远程调用</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310060840065.png" alt="image-20231006084042876"></p>
<p>那么随着我们微服务越来越多，我们在生产环境中可能会达到数十上百甚至上千台服务器的情况，这时就有一个问题。</p>
<p><font color='red'><strong>问题一</strong></font>：如果我们修改一个配置文件而这个配置文件可能跟我数十上百个微服务都有关系，那这个时候我是不是要逐个微服务去调整配置呢？</p>
<p>这样很麻烦。</p>
<p><font color='red'><strong>问题二</strong></font>：修改配置后这些关联的服务是不是都需要重启啊</p>
<p>所以我们的需求就是可以将配置文件进行<mark>统一的管理</mark>.</p>
<p><strong>统一管理</strong>：我不需要修改数十上百个微服务的配置文件而是只需要修改一个地方的配置文件就可以了。</p>
<ul>
<li>
<p><strong>配置更改热更新</strong>.</p>
<p>希望配置更改后不需要重启，而可以立马生效这就是 <mark>配置更改热更新</mark>.</p>
</li>
</ul>
<p>而要实现 “配置更改热更新” 我们就需要一个 “配置管理服务”</p>
<blockquote>
<p><strong>配置管理服务的作用</strong>：</p>
<p>会去记录微服务中的一些核心的配置，那么微服务启动的时候就可以去读取 <mark>配置管理服务</mark> 中的配置再和本地的配置结合作为完整配置去使用了。将来如果配置要发生修改我们不需要逐个服务修改，而是找到 <mark>配置管理服务</mark> 在它上面把需要修改的配置修改一下，<mark>配置管理服务</mark> 发现配置修改了以后它会立即<mark>通知微服务</mark>，微服务再去读取 <mark>配置管理服务</mark> 中修改后的配置文件并且不用重启进行热更新生效</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310060900914.png" alt="image-20231006090015625"></p>
<p>我们使用的是 nacos 的配置管理，而我们知道 nacos 已经有注册中心功能了。所以我们配置中心也好，注册中心也好，同时都是由 nacos 去实现的。</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310060902958.png" alt="image-20231006090222743"></p>
<p>1、在 Nacos 中添加配置信息：</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310060916710.png" alt="image-20231006091626481"></p>
<p>2、在弹出表单中填写配置信息：</p>
<p><font color='red'>注意项</font>：</p>
<ol>
<li>DataId：需要具备唯一性</li>
<li>配置内容：只需要配置有热更新需求的内容而不是将服务中配置文件的内容全拷贝进去</li>
</ol>
<p>填写完毕后，点击发布</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061049488.png" alt="image-20231006104947319"></p>
<p>3、发布完成后返回查看</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310060915386.png" alt="image-20231006091517632"></p>
<p>先看如下图 没有 Nacos 时服务如何获取配置，配置获取的步骤如下：</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310060921217.png" alt="image-20231006092110607"></p>
<p>上面流程中读取的是本地的配置文件，但现在我们多了一个东西就是 nacos 中的配置文件。</p>
<p>将来我们的项目会把 nacos 的配置与本地配置做一个合并而后再去完成后续的容器创建 bean 的创建动作。</p>
<p>所以 nacos 读取要加入到上面流程当中那么就会变成如下的步骤：</p>
<p>项目启动先读取 nacos 配置文件再去读取本地配置文件两者合并最后创建 bean</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310060925392.png" alt="image-20231006092504157"></p>
<p><font color='red'>问题</font>：</p>
<ul>
<li><strong>第一</strong>：去哪读取</li>
<li><strong>第二</strong>：读取谁</li>
</ul>
<p>我们读取 nacos 配置文件时需要提前知道 nacos 的地址，那么需要一个启动优先级高于 application.yml 的东西来存储 nacos 地址。</p>
<p>此时，可以使用 “bootstrap.yml” 配置文件，这是 SpringBoot 中提供的。这个文件的优先级高于 application.yml</p>
<p>当项目启动优先读取 “bootstrap.yml” 配置文件，我们只要把 nacos 地址，文件相关信息都配置进去那么它就可以完成 nacos 配置的读取了。而后再跟本地结合完成后续动作</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310060930844.png" alt="image-20231006093027358"></p>
<p><strong>那么就需要注意了</strong>：</p>
<ul>
<li><mark>与 nacos 地址和配置文件有关的所有信息都应该放到 “bootstrap.yml” 当中</mark>。</li>
</ul>
<h4 id="472-操作步骤"><a class="markdownIt-Anchor" href="#472-操作步骤">#</a> 4.7.2、操作步骤：🌲</h4>
<p>1、引入 Nacos 的配置管理客户端依赖：</p>
<figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">&lt;!--nacos 配置管理依赖 --></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-alibaba-nacos-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><p>2、在 userservice 中的 resource 目录添加一个<font color='red'>bootstrap.yml</font>文件，这个文件是引导文件，优先级高于 application.yml</p>
<figure class="highlight yml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">spring</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">application</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token key atrule">name</span><span class="token punctuation">:</span> userservice <span class="token comment"># 服务名称</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">profiles</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token key atrule">active</span><span class="token punctuation">:</span> dev <span class="token comment"># 环境</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token key atrule">cloud</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token key atrule">nacos</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment"># nacos 地址</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token key atrule">config</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml <span class="token comment"># 配置文件后缀名</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment"># 三要素：服务名称，环境，后缀名 而这三个决定了 DateId</span></pre></td></tr></table></figure><p>多环境配置和共享配置 不在本案例范围中，只是演示可以这样做</p>
<p>多环境配置：</p>
<figure class="highlight yml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">spring</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">application</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token key atrule">name</span><span class="token punctuation">:</span> content<span class="token punctuation">-</span>service</pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">cloud</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token key atrule">nacos</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment"># nacos 地址</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token key atrule">config</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev <span class="token comment"># 命名空间</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>project <span class="token comment"># 组名称</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml <span class="token comment"># 文件后缀</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token key atrule">refresh-enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 是否开启自动刷新值</span></pre></td></tr></table></figure><p>共享配置 / 扩展配置</p>
<p>多个扩展配置的案例如下：</p>
<p><a href="https://pigpigletsgo.github.io/computer-science/java/spring/springcloud/Nacos/%E6%A1%88%E4%BE%8B/%E6%8B%86%E5%88%86%E4%B8%8D%E5%90%8C%E9%85%8D%E7%BD%AE%E5%88%B0nacos%E5%B9%B6%E8%AF%BB%E5%8F%96%E4%B8%8D%E5%90%8C%E9%85%8D%E7%BD%AE%E5%88%B0%E9%A1%B9%E7%9B%AE/">案例文章</a></p>
<figure class="highlight yml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">spring</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">application</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token key atrule">name</span><span class="token punctuation">:</span> content<span class="token punctuation">-</span>api <span class="token comment"># 服务名</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">cloud</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token key atrule">nacos</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.249.128<span class="token punctuation">:</span><span class="token number">8848</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token key atrule">discovery</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>project</pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token key atrule">config</span><span class="token punctuation">:</span> <span class="token comment"># 配置文件相关信息</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>project</pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml</pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token key atrule">refresh-enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token comment"># 共享配置 / 扩展配置</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token key atrule">extension-configs</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>          <span class="token punctuation">-</span> <span class="token key atrule">data-id</span><span class="token punctuation">:</span> content<span class="token punctuation">-</span>service<span class="token punctuation">-</span>$<span class="token punctuation">&#123;</span>spring.profiles.active<span class="token punctuation">&#125;</span>.yaml</pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>project</pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token key atrule">refresh</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token key atrule">profiles</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token key atrule">active</span><span class="token punctuation">:</span> dev <span class="token comment">#环境名</span></pre></td></tr></table></figure><p>3、我们在 user-service 中将 pattern.dateformat 这个属性注入到 UserController 中做测试：</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Slf4j</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@RestController</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/user"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">// 注入 nacos 中的配置属性</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;pattern.dateformat&#125;"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> dateformat<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">// 编写 controller，通过日期格式化器来格式化现在时间并返回</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"now"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"dateFormat = "</span><span class="token operator">+</span>dateformat<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span>dateformat<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>4、请求接口查看结果</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061054265.png" alt="image-20231006105444087"></p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061056279.png" alt="image-20231006105458931"></p>
<blockquote>
<p><strong>总结</strong>：</p>
<p>将配置交给 nacos 管理的步骤</p>
<ol>
<li>在 nacos 中添加配置文件</li>
<li>在微服务中引入 nacos 的 config 依赖</li>
<li>在微服务中添加 bootstrap.yml，配置 nacos 地址，当前环境，服务名称，文件后缀名。这些决定了程序启动时去 nacos 读取哪个文件，写错一个就会报错！</li>
</ol>
</blockquote>
<h4 id="473-配置自动刷新"><a class="markdownIt-Anchor" href="#473-配置自动刷新">#</a> 4.7.3、配置自动刷新🌲</h4>
<p>我们改一下 nacos 中配置文件的信息，点击编辑进行修改指定的 nacos 配置文件信息</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061058197.png" alt="image-20231006105819948"></p>
<p>原来的</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061057556.png" alt="image-20231006105744125"></p>
<p>修改后的</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061059763.png" alt="image-20231006105913419"></p>
<p>修改完点击发布，然后再去请求获取日期格式化的接口</p>
<p>可以看到没有变化</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061100940.png" alt="image-20231006110004691"></p>
<p>要想实现配置的自动更新我们需要如下操作：</p>
<p>Nacos 中的配置文件变更后，微服务无需重启就可以感知。不过需要通过下面两种配置实现：</p>
<h5 id="474-refreshscope"><a class="markdownIt-Anchor" href="#474-refreshscope">#</a> 4.7.4、@RefreshScope🌴</h5>
<ul>
<li>方式一：在 @Value 注入的变量所在类上添加注解 @RefreshScope</li>
</ul>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061103130.png" alt="image-20231006110317505"></p>
<p>加上注解后重启服务，因为上次的更改没有生效这里又将 nacos 配置文件的信息改为原来的了。再次进行修改测试</p>
<p>修改前</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061106769.png" alt="image-20231006110621029"></p>
<p>修改后</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061107482.png" alt="image-20231006110720366"></p>
<p>在没有重启服务的情况下刷新两下从 nacos 配置文件中获取的格式化日期就发生了改变，说明热更新生效了。</p>
<h5 id="475-configurationproperties"><a class="markdownIt-Anchor" href="#475-configurationproperties">#</a> 4.7.5、@ConfigurationProperties🌴</h5>
<ul>
<li>方式二：使用 @ConfigurationProperties 注解</li>
</ul>
<p>通过 @ConfigurationProperties 注解读取一个前缀为 pattern 的配置信息 (约定大于配置)</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061113170.png" alt="image-20231006111308948"></p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061120271.png" alt="image-20231006112043132"></p>
<p>重启服务，测试结果</p>
<p>修改前</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061122192.png" alt="image-20231006112226998"></p>
<p>修改后</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061123665.png" alt="image-20231006112303423"></p>
<p>刷新页面</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061123281.png" alt="image-20231006112317230"></p>
<blockquote>
<p><strong>总结</strong>：</p>
<p>Nacos 配置更改后，微服务可以实现热更新，方式：</p>
<ol>
<li>通过 @Value 注解注入，结合 @RefreshScope 来刷新</li>
<li>通过 @ConfigurationProperties 注入，自动刷新 (建议使用，因为方便)</li>
</ol>
<p><font color='red'><strong>注意事项</strong></font>：</p>
<ul>
<li>不是所有的配置都适合放到配置中心，维护起来比较麻烦</li>
<li>建议将一些关键参数，需要运行时调整的参数放到 nacos 配置中心，一般都是自定义配置</li>
</ul>
</blockquote>
<h4 id="474-多环境配置共享"><a class="markdownIt-Anchor" href="#474-多环境配置共享">#</a> 4.7.4、多环境配置共享🌲</h4>
<blockquote>
<p>场景：</p>
<p>有一个配置属性，它在开发，生产和测试等环境下的值都是一样的，那像这样的配置我在每个配置文件里都写一份。是不是有点浪费呀，而且将来如果要改动我还得在每个配置文件都去改这样很麻烦。我们想找一个地方我配置一次以后不管环境怎么变这个配置都能够被加载。那这就是多环境共享的需求了！</p>
</blockquote>
<p>微服务启动时会从 nacos 读取多个配置文件：</p>
<p>第一个：它的构成有三部分</p>
<ol>
<li>服务名称</li>
<li>环境</li>
<li>后缀名</li>
</ol>
<ul>
<li>[<a target="_blank" rel="noopener" href="http://spring.application.name">spring.application.name</a>]-[spring.profiles.active].yaml，例如：userservice-dev.yaml</li>
</ul>
<p>第二个：它的构成有二部分，跟环境没有关系</p>
<ol>
<li>服务名称</li>
<li>后缀名</li>
</ol>
<ul>
<li>[<a target="_blank" rel="noopener" href="http://spring.application.name">spring.application.name</a>].yaml，例如：userservice.yaml</li>
</ul>
<p>无论 profile 如何变化，[<a target="_blank" rel="noopener" href="http://spring.application.name">spring.application.name</a>].yaml 这个文件一定会加载，因此多环境共享配置可以写入这个文件</p>
<blockquote>
<p>比如说如下图，有 dev.yaml 和 userservice.yaml 将来有测试环境在定义一个 userservice-test.yaml。但是不管是 dev 还是 userservice-test，userservice.yaml 一定会被共享</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061141107.png" alt="image-20231006114137708"></p>
<p>编写获取 envSharedValue 的代码：</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Data</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@Component</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"pattern"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PatternProperties</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> dateformat<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> envSharedValue<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Slf4j</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@RestController</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/user"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">PatternProperties</span> patternProperties<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>   </pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"prop"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">PatternProperties</span> <span class="token function">patternProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token keyword">return</span> patternProperties<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>启动 user-service 服务！</p>
<p>但是需要注意当前服务的环境：</p>
<p>当前处于 dev 开发环境下，所以既可以访问到 userservice 环境也可以访问到 dev 环境</p>
<figure class="highlight yml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">spring</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">application</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token key atrule">name</span><span class="token punctuation">:</span> userservice <span class="token comment"># 服务名称</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">profiles</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token key atrule">active</span><span class="token punctuation">:</span> dev <span class="token comment"># 环境</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token key atrule">cloud</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token key atrule">nacos</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment"># nacos 地址</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token key atrule">config</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml <span class="token comment"># 配置文件后缀名</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment"># 三要素：服务名称，环境，后缀名 而这三个决定了 DateId</span></pre></td></tr></table></figure><p>然后再启动一个 test 环境的服务这次不修改配置文件中的代码，而是在 idea 启动参数中设置 环境</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061210818.png" alt="image-20231006121029595"></p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061211188.png" alt="image-20231006121106691"></p>
<p>两个服务启动完成后，进行请求 user-service 服务：</p>
<p>访问：<a target="_blank" rel="noopener" href="http://127.0.0.1:8081/user/prop">http://127.0.0.1:8081/user/prop</a> 这是 dev 环境，可以看到显示了 格式化日期和 envSharedValue 信息</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061234508.png" alt="image-20231006123404747"></p>
<p>访问：<a target="_blank" rel="noopener" href="http://127.0.0.1:8082/user/prop">http://127.0.0.1:8082/user/prop</a> 这是 test 环境，可以看到依然可以获取到 userservice 环境的值，而 dev 环境的格式化日期的值获取不到了。</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061234043.png" alt="image-20231006123455577"></p>
<p>同上测试可以证明，8081：dev 环境，8082：test 环境。都均可以得到 userserivce 环境的值</p>
<p>证明了 userservice.yaml 文件是被不同环境所共享的。</p>
<h5 id="4741-测试配置文件优先级"><a class="markdownIt-Anchor" href="#4741-测试配置文件优先级">#</a> 4.7.4.1、测试配置文件优先级🌴</h5>
<p>假如说 userservice 与 dev 配置文件中有相同的属性那它会以谁的为准呢？</p>
<p>测试一、在本地和远端都配置相同的属性看看以谁的为准</p>
<p>在本地配置文件中配置一个值</p>
<figure class="highlight yml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">pattern</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> 本地环境local</pre></td></tr></table></figure><p>在 PatternProperties 类中也加上这个属性</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Data</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@Component</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"pattern"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PatternProperties</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> dateformat<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> envSharedValue<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>再到 nacos 控制台中给 userservice 环境加上这个属性</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061245246.png" alt="image-20231006124535158"></p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061245100.png" alt="image-20231006124517976"></p>
<p>重启 user-service 服务。请求 user-service 的 url：<a target="_blank" rel="noopener" href="http://127.0.0.1:8081/user/prop">http://127.0.0.1:8081/user/prop</a></p>
<p>结果是 userservice 环境中的属性值。这就证明了 本地与远端，远端的优先级高！</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061247510.png" alt="image-20231006124719747"></p>
<p>我们再将 nacos 控制台中的 dev 环境也加上这个属性</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061249639.png" alt="image-20231006124900533"></p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061249996.png" alt="image-20231006124929760"></p>
<p>再去请求 user-service 的 url：<a target="_blank" rel="noopener" href="http://127.0.0.1:8081/user/prop">http://127.0.0.1:8081/user/prop</a></p>
<p>这次结果是自己的环境配置的属性值了</p>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061251197.png" alt="image-20231006125141160"></p>
<h5 id="4742-多种配置的优先级"><a class="markdownIt-Anchor" href="#4742-多种配置的优先级">#</a> 4.7.4.2、多种配置的优先级：🌴</h5>
<ul>
<li>服务名 - profile.yaml &gt; 服务名称.yaml &gt; 本地配置</li>
</ul>
<center>优先级关系图</center>
<p><img src="https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310061254076.png" alt="image-20231006125407644"></p>
<p>如果想让本地配置优先则配置如下内容：</p>
<figure class="highlight yml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 配置本地优先</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">spring</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token key atrule">cloud</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">config</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>   <span class="token key atrule">override-none</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr></table></figure><blockquote>
<p><strong>总结</strong>：</p>
<p>微服务会从 nacos 读取的配置文件：</p>
<ol>
<li>[服务名]-[spring.profile.active].yaml，环境配置</li>
<li>[服务名].yaml，默认配置，多环境共享</li>
</ol>
<p>优先级：</p>
<ul>
<li>[服务名]-[环境].yaml &gt; [服务名].yaml &gt; 本地配置</li>
</ul>
</blockquote>
<h4 id="475-nacos集群搭建"><a class="markdownIt-Anchor" href="#475-nacos集群搭建">#</a> 4.7.5、Nacos 集群搭建🌲</h4>
<p>Nacos 生产环境下一定要部署为集群状态，部署方式参考课前资料中的文档：</p>
<blockquote>
<p>在前面的学习中我们学习到了 Nacos 的基本用法，不过之前我们一直使用的都是单点的 nacos。这种方式我们自己测试的时候玩玩可还行，如果是在企业生产环境下也这么搞。那可就要出大问题了。</p>
<p>因为在企业当中我们更强调的是高可用所以 nacos 一定要做成一个集群，下面我们学习如何搭建 nacos 集群</p>
</blockquote>
<p>查看 nacos 配合 nginx 基本集群搭建：<a href="./Nacos/nacos%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA.md">nacos 集群搭建文章</a>.</p>
<blockquote>
<p><strong>总结</strong>：</p>
<p>集群搭建步骤：</p>
<ol>
<li>搭建 MySQL 集群并初始化数据库表</li>
<li>下载解压 nacos</li>
<li>修改集群配置 (节点信息)，数据库配置</li>
<li>分别启动多个 nacos 节点</li>
<li>nginx 反向代理</li>
</ol>
</blockquote>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://pigpigletsgo.github.io/homepage"></a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://pigpigletsgo.github.io/homepage/2024/04/02/computer-science/java/spring/springcloud/Nacos/springcloud-Nacos%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83/">https://pigpigletsgo.github.io/homepage/2024/04/02/computer-science/java/spring/springcloud/Nacos/springcloud-Nacos%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://pigpigletsgo.github.io/homepage" target="_blank">homepage</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/homepage/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%AD%A6%E7%A7%91/">计算机学科</a><a class="post-meta__tags" href="/homepage/tags/springcloud/">springcloud</a><a class="post-meta__tags" href="/homepage/tags/Nacos/">Nacos</a></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/homepage/2024/04/02/computer-science/java/spring/springcloud/Nacos/%E6%A1%88%E4%BE%8B/%E6%8B%86%E5%88%86%E4%B8%8D%E5%90%8C%E9%85%8D%E7%BD%AE%E5%88%B0nacos%E5%B9%B6%E8%AF%BB%E5%8F%96%E4%B8%8D%E5%90%8C%E9%85%8D%E7%BD%AE%E5%88%B0%E9%A1%B9%E7%9B%AE/" title="拆分不同配置到nacos并读取不同配置到项目"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">拆分不同配置到nacos并读取不同配置到项目</div></div></a></div><div class="next-post pull-right"><a href="/homepage/2024/04/02/computer-science/java/spring/springcloud/Nacos/nacos%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/" title="Nacos集群搭建"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Nacos集群搭建</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/homepage/2024/04/02/computer-science/java/spring/springcloud/Nacos/Nacos%E5%AE%89%E8%A3%85%E6%8C%87%E5%8D%97/" title="Nacos安装指南"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-02</div><div class="title">Nacos安装指南</div></div></a></div><div><a href="/homepage/2024/04/02/computer-science/java/spring/springcloud/Nacos/nacos%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/" title="Nacos集群搭建"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-02</div><div class="title">Nacos集群搭建</div></div></a></div><div><a href="/homepage/2024/04/02/computer-science/java/spring/springcloud/Nacos/%E6%A1%88%E4%BE%8B/%E6%8B%86%E5%88%86%E4%B8%8D%E5%90%8C%E9%85%8D%E7%BD%AE%E5%88%B0nacos%E5%B9%B6%E8%AF%BB%E5%8F%96%E4%B8%8D%E5%90%8C%E9%85%8D%E7%BD%AE%E5%88%B0%E9%A1%B9%E7%9B%AE/" title="拆分不同配置到nacos并读取不同配置到项目"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-02</div><div class="title">拆分不同配置到nacos并读取不同配置到项目</div></div></a></div><div><a href="/homepage/2024/04/02/computer-science/java/spring/springcloud/SpringBoot%E6%95%B4%E5%90%88docker%E9%83%A8%E7%BD%B2xxl-job-2.3.1/" title="XXL-JOB介绍和使用"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-02</div><div class="title">XXL-JOB介绍和使用</div></div></a></div><div><a href="/homepage/2024/04/02/computer-science/java/spring/springcloud/SpringCloud%E5%85%A5%E9%97%A8/" title="一、SpringCloud入门|介绍"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-02</div><div class="title">一、SpringCloud入门|介绍</div></div></a></div><div><a href="/homepage/2024/04/02/computer-science/java/spring/springcloud/springcloud-Ribbon%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/" title="三、Ribbon负载均衡"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-02</div><div class="title">三、Ribbon负载均衡</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/homepage/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name"></div><div class="author-info__description">欢迎来我的博客空间</div></div><div class="card-info-data site-data is-center"><a href="/homepage/archives/"><div class="headline">文章</div><div class="length-num">452</div></a><a href="/homepage/tags/"><div class="headline">标签</div><div class="length-num">151</div></a><a href="/homepage/categories/"><div class="headline">分类</div><div class="length-num">115</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B-nacos%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="toc-number">1.</span> <span class="toc-text"> 四、Nacos 注册中心🎄</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#41-%E8%AE%A4%E8%AF%86nacos"><span class="toc-number">1.1.</span> <span class="toc-text"> 4.1、认识 Nacos🌳</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#42-%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%88%B0nacos"><span class="toc-number">1.2.</span> <span class="toc-text"> 4.2、服务注册到 Nacos🌳</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#43-nacos%E6%9C%8D%E5%8A%A1%E5%88%86%E7%BA%A7%E5%AD%98%E5%82%A8%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.3.</span> <span class="toc-text"> 4.3、Nacos 服务分级存储模型🌳</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#431-%E6%9C%8D%E5%8A%A1%E8%B7%A8%E9%9B%86%E7%BE%A4%E8%B0%83%E7%94%A8%E9%97%AE%E9%A2%98"><span class="toc-number">1.3.1.</span> <span class="toc-text"> 4.3.1、服务跨集群调用问题🌲</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#44-%E6%9C%8D%E5%8A%A1%E9%9B%86%E7%BE%A4%E5%B1%9E%E6%80%A7"><span class="toc-number">1.4.</span> <span class="toc-text"> 4.4、服务集群属性🌳</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#441-%E6%A0%B9%E6%8D%AE%E9%9B%86%E7%BE%A4%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">1.4.1.</span> <span class="toc-text"> 4.4.1、根据集群负载均衡🌲</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#442-%E6%A0%B9%E6%8D%AE%E6%9D%83%E9%87%8D%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">1.4.2.</span> <span class="toc-text"> 4.4.2、根据权重负载均衡🌲</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#443-%E6%9D%83%E9%87%8D%E9%85%8D%E7%BD%AE%E6%93%8D%E4%BD%9C"><span class="toc-number">1.4.3.</span> <span class="toc-text"> 4.4.3、权重配置操作：🌲</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#45-%E7%8E%AF%E5%A2%83%E9%9A%94%E7%A6%BB-namespace"><span class="toc-number">1.5.</span> <span class="toc-text"> 4.5、环境隔离 - namespace🌳</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#46-nacos%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E7%BB%86%E8%8A%82%E5%88%86%E6%9E%90"><span class="toc-number">1.6.</span> <span class="toc-text"> 4.6、nacos 注册中心细节分析🌳</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#461-%E4%B8%B4%E6%97%B6%E5%AE%9E%E4%BE%8B"><span class="toc-number">1.6.1.</span> <span class="toc-text"> 4.6.1、临时实例🌲</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#462-%E9%9D%9E%E4%B8%B4%E6%97%B6%E5%AE%9E%E4%BE%8B"><span class="toc-number">1.6.2.</span> <span class="toc-text"> 4.6.2、非临时实例🌲</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#463-%E4%B8%B4%E6%97%B6%E5%AE%9E%E4%BE%8B%E5%92%8C%E9%9D%9E%E4%B8%B4%E6%97%B6%E5%AE%9E%E4%BE%8B"><span class="toc-number">1.6.3.</span> <span class="toc-text"> 4.6.3、临时实例和非临时实例🌲</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4631-cap%E7%90%86%E8%AE%BA"><span class="toc-number">1.6.3.1.</span> <span class="toc-text"> 4.6.3.1、CAP 理论🌴</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#47-nacos%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86"><span class="toc-number">1.7.</span> <span class="toc-text"> 4.7、Nacos 配置管理🌳</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#471-%E7%BB%9F%E4%B8%80%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86"><span class="toc-number">1.7.1.</span> <span class="toc-text"> 4.7.1、统一配置管理🌲</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#472-%E6%93%8D%E4%BD%9C%E6%AD%A5%E9%AA%A4"><span class="toc-number">1.7.2.</span> <span class="toc-text"> 4.7.2、操作步骤：🌲</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#473-%E9%85%8D%E7%BD%AE%E8%87%AA%E5%8A%A8%E5%88%B7%E6%96%B0"><span class="toc-number">1.7.3.</span> <span class="toc-text"> 4.7.3、配置自动刷新🌲</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#474-refreshscope"><span class="toc-number">1.7.3.1.</span> <span class="toc-text"> 4.7.4、@RefreshScope🌴</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#475-configurationproperties"><span class="toc-number">1.7.3.2.</span> <span class="toc-text"> 4.7.5、@ConfigurationProperties🌴</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#474-%E5%A4%9A%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E5%85%B1%E4%BA%AB"><span class="toc-number">1.7.4.</span> <span class="toc-text"> 4.7.4、多环境配置共享🌲</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4741-%E6%B5%8B%E8%AF%95%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%BC%98%E5%85%88%E7%BA%A7"><span class="toc-number">1.7.4.1.</span> <span class="toc-text"> 4.7.4.1、测试配置文件优先级🌴</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4742-%E5%A4%9A%E7%A7%8D%E9%85%8D%E7%BD%AE%E7%9A%84%E4%BC%98%E5%85%88%E7%BA%A7"><span class="toc-number">1.7.4.2.</span> <span class="toc-text"> 4.7.4.2、多种配置的优先级：🌴</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#475-nacos%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA"><span class="toc-number">1.7.5.</span> <span class="toc-text"> 4.7.5、Nacos 集群搭建🌲</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/homepage/2024/04/02/tools/%E5%AF%86%E7%A0%81%E7%AE%A1%E7%90%86/%E5%AF%86%E7%A0%81%E5%AD%98%E5%82%A8%E5%BA%93%E4%BD%BF%E7%94%A8KeePass/" title="KeePass的使用">KeePass的使用</a><time datetime="2024-04-02T10:00:51.942Z" title="发表于 2024-04-02 18:00:51">2024-04-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/homepage/2024/04/02/tools/%E5%89%8D%E7%AB%AF/json-server/" title="JSON-SERVER">JSON-SERVER</a><time datetime="2024-04-02T10:00:51.935Z" title="发表于 2024-04-02 18:00:51">2024-04-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/homepage/2024/04/02/tools/%E5%89%8D%E7%AB%AF/form-serialize%E6%8F%92%E4%BB%B6/" title="form-serialize插件，快速收集表单元素的值">form-serialize插件，快速收集表单元素的值</a><time datetime="2024-04-02T10:00:51.933Z" title="发表于 2024-04-02 18:00:51">2024-04-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/homepage/2024/04/02/tools/%E5%89%8D%E7%AB%AF/alova/" title="alova">alova</a><time datetime="2024-04-02T10:00:51.930Z" title="发表于 2024-04-02 18:00:51">2024-04-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/homepage/2024/04/02/tools/windows/%E5%AE%89%E8%A3%85scoop/" title="安装和使用scoop">安装和使用scoop</a><time datetime="2024-04-02T10:00:51.923Z" title="发表于 2024-04-02 18:00:51">2024-04-02</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By null</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/homepage/js/utils.js?v=4.13.0"></script><script src="/homepage/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/homepage/js/search/local-search.js?v=4.13.0"></script></div></div></body></html>