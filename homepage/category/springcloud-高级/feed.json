{
    "version": "https://jsonfeed.org/version/1",
    "title": "homepage â€¢ All posts by \"springcloud-é«˜çº§\" category",
    "description": "æ¬¢è¿æ¥æˆ‘çš„åšå®¢ç©ºé—´",
    "home_page_url": "https://pigpigletsgo.github.io/homepage",
    "items": [
        {
            "id": "https://pigpigletsgo.github.io/homepage/2024/04/02/computer-science/java/spring/springcloud/springcloud-%E9%AB%98%E7%BA%A7/sentinel/sentinel%E8%A7%84%E5%88%99%E6%8C%81%E4%B9%85%E5%8C%96/",
            "url": "https://pigpigletsgo.github.io/homepage/2024/04/02/computer-science/java/spring/springcloud/springcloud-%E9%AB%98%E7%BA%A7/sentinel/sentinel%E8%A7%84%E5%88%99%E6%8C%81%E4%B9%85%E5%8C%96/",
            "title": "Sentinelè§„åˆ™æŒä¹…åŒ–",
            "date_published": "2024-04-02T06:23:31.038Z",
            "content_html": "<h1 id=\"sentinel-è§„åˆ™æŒä¹…åŒ–\"><a class=\"markdownIt-Anchor\" href=\"#sentinel-è§„åˆ™æŒä¹…åŒ–\">#</a> Sentinel è§„åˆ™æŒä¹…åŒ–</h1>\n<h2 id=\"ä¸€-ä¿®æ”¹order-serviceæœåŠ¡\"><a class=\"markdownIt-Anchor\" href=\"#ä¸€-ä¿®æ”¹order-serviceæœåŠ¡\">#</a> ä¸€ã€ä¿®æ”¹ order-service æœåŠ¡</h2>\n<p>ä¿®æ”¹ OrderServiceï¼Œè®©å…¶ç›‘å¬ Nacos ä¸­çš„ sentinel è§„åˆ™é…ç½®ã€‚</p>\n<p>å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š</p>\n<h3 id=\"1å¼•å…¥ä¾èµ–\"><a class=\"markdownIt-Anchor\" href=\"#1å¼•å…¥ä¾èµ–\">#</a> 1. å¼•å…¥ä¾èµ–</h3>\n<p>åœ¨ order-service ä¸­å¼•å…¥ sentinel ç›‘å¬ nacos çš„ä¾èµ–ï¼š</p>\n<figure class=\"highlight xml\"><figcaption data-lang=\"XML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">></span></span>com.alibaba.csp<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">></span></span>sentinel-datasource-nacos<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">></span></span></pre></td></tr></table></figure><h3 id=\"2é…ç½®nacosåœ°å€\"><a class=\"markdownIt-Anchor\" href=\"#2é…ç½®nacosåœ°å€\">#</a> 2. é…ç½® nacos åœ°å€</h3>\n<p>åœ¨ order-service ä¸­çš„ application.yml æ–‡ä»¶é…ç½® nacos åœ°å€åŠç›‘å¬çš„é…ç½®ä¿¡æ¯ï¼š</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">cloud</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token key atrule\">sentinel</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      <span class=\"token key atrule\">datasource</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token key atrule\">flow</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>          <span class=\"token key atrule\">nacos</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            <span class=\"token key atrule\">server-addr</span><span class=\"token punctuation\">:</span> localhost<span class=\"token punctuation\">:</span><span class=\"token number\">8848</span> <span class=\"token comment\"># nacos åœ°å€</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token key atrule\">dataId</span><span class=\"token punctuation\">:</span> orderservice<span class=\"token punctuation\">-</span>flow<span class=\"token punctuation\">-</span>rules</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token key atrule\">groupId</span><span class=\"token punctuation\">:</span> SENTINEL_GROUP</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token key atrule\">rule-type</span><span class=\"token punctuation\">:</span> flow <span class=\"token comment\"># è¿˜å¯ä»¥æ˜¯ï¼šdegradeã€authorityã€param-flow</span></pre></td></tr></table></figure><h2 id=\"äºŒ-ä¿®æ”¹sentinel-dashboardæºç \"><a class=\"markdownIt-Anchor\" href=\"#äºŒ-ä¿®æ”¹sentinel-dashboardæºç \">#</a> äºŒã€ä¿®æ”¹ sentinel-dashboard æºç </h2>\n<p>SentinelDashboard é»˜è®¤ä¸æ”¯æŒ nacos çš„æŒä¹…åŒ–ï¼Œéœ€è¦ä¿®æ”¹æºç ã€‚</p>\n<h3 id=\"1-è§£å‹\"><a class=\"markdownIt-Anchor\" href=\"#1-è§£å‹\">#</a> 1. è§£å‹</h3>\n<p>è§£å‹è¯¾å‰èµ„æ–™ä¸­çš„ sentinel æºç åŒ…ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171644436.png\" alt=\"image-20210618201340086\"></p>\n<p>ç„¶åå¹¶ç”¨ IDEA æ‰“å¼€è¿™ä¸ªé¡¹ç›®ï¼Œç»“æ„å¦‚ä¸‹ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171644159.png\" alt=\"image-20210618201412878\"></p>\n<h3 id=\"2-ä¿®æ”¹nacosä¾èµ–\"><a class=\"markdownIt-Anchor\" href=\"#2-ä¿®æ”¹nacosä¾èµ–\">#</a> 2. ä¿®æ”¹ nacos ä¾èµ–</h3>\n<p>åœ¨ sentinel-dashboard æºç çš„ pom æ–‡ä»¶ä¸­ï¼Œnacos çš„ä¾èµ–é»˜è®¤çš„ scope æ˜¯ testï¼Œåªèƒ½åœ¨æµ‹è¯•æ—¶ä½¿ç”¨ï¼Œè¿™é‡Œè¦å»é™¤ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171644823.png\" alt=\"image-20210618201607831\"></p>\n<p>å°† sentinel-datasource-nacos ä¾èµ–çš„ scope å»æ‰ï¼š</p>\n<figure class=\"highlight xml\"><figcaption data-lang=\"XML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">></span></span>com.alibaba.csp<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">></span></span>sentinel-datasource-nacos<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">></span></span></pre></td></tr></table></figure><h3 id=\"3-æ·»åŠ nacosæ”¯æŒ\"><a class=\"markdownIt-Anchor\" href=\"#3-æ·»åŠ nacosæ”¯æŒ\">#</a> 3. æ·»åŠ  nacos æ”¯æŒ</h3>\n<p>åœ¨ sentinel-dashboard çš„ test åŒ…ä¸‹ï¼Œå·²ç»ç¼–å†™äº†å¯¹ nacos çš„æ”¯æŒï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶æ‹·è´åˆ° main ä¸‹ã€‚</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171644434.png\" alt=\"image-20210618201726280\"></p>\n<h3 id=\"4-ä¿®æ”¹nacosåœ°å€\"><a class=\"markdownIt-Anchor\" href=\"#4-ä¿®æ”¹nacosåœ°å€\">#</a> 4. ä¿®æ”¹ nacos åœ°å€</h3>\n<p>ç„¶åï¼Œè¿˜éœ€è¦ä¿®æ”¹æµ‹è¯•ä»£ç ä¸­çš„ NacosConfig ç±»ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171644320.png\" alt=\"image-20210618201912078\"></p>\n<p>ä¿®æ”¹å…¶ä¸­çš„ nacos åœ°å€ï¼Œè®©å…¶è¯»å– application.properties ä¸­çš„é…ç½®ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171644820.png\" alt=\"image-20210618202047575\"></p>\n<p>åœ¨ sentinel-dashboard çš„ application.properties ä¸­æ·»åŠ  nacos åœ°å€é…ç½®ï¼š</p>\n<figure class=\"highlight properties\"><figcaption data-lang=\".properties\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key attr-name\">nacos.addr</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">localhost:8848</span></pre></td></tr></table></figure><h3 id=\"5-é…ç½®nacosæ•°æ®æº\"><a class=\"markdownIt-Anchor\" href=\"#5-é…ç½®nacosæ•°æ®æº\">#</a> 5. é…ç½® nacos æ•°æ®æº</h3>\n<p>å¦å¤–ï¼Œè¿˜éœ€è¦ä¿®æ”¹ com.alibaba.csp.sentinel.dashboard.controller.v2 åŒ…ä¸‹çš„ FlowControllerV2 ç±»ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171644684.png\" alt=\"w\"></p>\n<p>è®©æˆ‘ä»¬æ·»åŠ çš„ Nacos æ•°æ®æºç”Ÿæ•ˆï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171644334.png\" alt=\"image-20210618202334536\"></p>\n<h3 id=\"6-ä¿®æ”¹å‰ç«¯é¡µé¢\"><a class=\"markdownIt-Anchor\" href=\"#6-ä¿®æ”¹å‰ç«¯é¡µé¢\">#</a> 6. ä¿®æ”¹å‰ç«¯é¡µé¢</h3>\n<p>æ¥ä¸‹æ¥ï¼Œè¿˜è¦ä¿®æ”¹å‰ç«¯é¡µé¢ï¼Œæ·»åŠ ä¸€ä¸ªæ”¯æŒ nacos çš„èœå•ã€‚</p>\n<p>ä¿®æ”¹ src/main/webapp/resources/app/scripts/directives/sidebar/ ç›®å½•ä¸‹çš„ sidebar.html æ–‡ä»¶ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171644086.png\" alt=\"image-20210618202433356\"></p>\n<p>å°†å…¶ä¸­çš„è¿™éƒ¨åˆ†æ³¨é‡Šæ‰“å¼€ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171644031.png\" alt=\"image-20210618202449881\"></p>\n<p>ä¿®æ”¹å…¶ä¸­çš„æ–‡æœ¬ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171644504.png\" alt=\"image-20210618202501928\"></p>\n<h3 id=\"7-é‡æ–°ç¼–è¯‘-æ‰“åŒ…é¡¹ç›®\"><a class=\"markdownIt-Anchor\" href=\"#7-é‡æ–°ç¼–è¯‘-æ‰“åŒ…é¡¹ç›®\">#</a> 7. é‡æ–°ç¼–è¯‘ã€æ‰“åŒ…é¡¹ç›®</h3>\n<p>è¿è¡Œ IDEA ä¸­çš„ maven æ’ä»¶ï¼Œç¼–è¯‘å’Œæ‰“åŒ…ä¿®æ”¹å¥½çš„ Sentinel-Dashboardï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171644941.png\" alt=\"image-20210618202701492\"></p>\n<h3 id=\"8å¯åŠ¨\"><a class=\"markdownIt-Anchor\" href=\"#8å¯åŠ¨\">#</a> 8. å¯åŠ¨</h3>\n<p>å¯åŠ¨æ–¹å¼è·Ÿå®˜æ–¹ä¸€æ ·ï¼š</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">java</span> <span class=\"token parameter variable\">-jar</span> sentinel-dashboard.jar</pre></td></tr></table></figure><p>å¦‚æœè¦ä¿®æ”¹ nacos åœ°å€ï¼Œéœ€è¦æ·»åŠ å‚æ•°ï¼š</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">java</span> <span class=\"token parameter variable\">-jar</span> <span class=\"token parameter variable\">-Dnacos.addr</span><span class=\"token operator\">=</span>localhost:8848 sentinel-dashboard.jar</pre></td></tr></table></figure>",
            "tags": [
                "è®¡ç®—æœºå­¦ç§‘",
                "springcloud",
                "Sentinel",
                "æŒä¹…åŒ–"
            ]
        },
        {
            "id": "https://pigpigletsgo.github.io/homepage/2024/04/02/computer-science/java/spring/springcloud/springcloud-%E9%AB%98%E7%BA%A7/seata/seata%E7%9A%84%E9%83%A8%E7%BD%B2%E5%92%8C%E9%9B%86%E6%88%90/",
            "url": "https://pigpigletsgo.github.io/homepage/2024/04/02/computer-science/java/spring/springcloud/springcloud-%E9%AB%98%E7%BA%A7/seata/seata%E7%9A%84%E9%83%A8%E7%BD%B2%E5%92%8C%E9%9B%86%E6%88%90/",
            "title": "seataçš„éƒ¨ç½²å’Œé›†æˆ",
            "date_published": "2024-04-02T06:23:31.030Z",
            "content_html": "<h1 id=\"seataçš„éƒ¨ç½²å’Œé›†æˆ\"><a class=\"markdownIt-Anchor\" href=\"#seataçš„éƒ¨ç½²å’Œé›†æˆ\">#</a> seata çš„éƒ¨ç½²å’Œé›†æˆ</h1>\n<h1 id=\"ä¸€-éƒ¨ç½²seataçš„tc-server\"><a class=\"markdownIt-Anchor\" href=\"#ä¸€-éƒ¨ç½²seataçš„tc-server\">#</a> ä¸€ã€éƒ¨ç½² Seata çš„ tc-server</h1>\n<h2 id=\"1ä¸‹è½½\"><a class=\"markdownIt-Anchor\" href=\"#1ä¸‹è½½\">#</a> 1. ä¸‹è½½</h2>\n<p>é¦–å…ˆæˆ‘ä»¬è¦ä¸‹è½½ seata-server åŒ…ï¼Œåœ°å€åœ¨<a href=\"http://seata.io/zh-cn/blog/download.html\"> http</a><a href=\"http://seata.io/zh-cn/blog/download.html\">ğŸ˜•/seata.io/zh-cn/blog/download</a><a href=\"http://seata.io/zh-cn/blog/download.html\">.</a><a href=\"http://seata.io/zh-cn/blog/download.html\">html</a></p>\n<p>å½“ç„¶ï¼Œè¯¾å‰èµ„æ–™ä¹Ÿå‡†å¤‡å¥½äº†ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310180750149.png\" alt=\"image-20210622202357640\"></p>\n<h2 id=\"2è§£å‹\"><a class=\"markdownIt-Anchor\" href=\"#2è§£å‹\">#</a> 2. è§£å‹</h2>\n<p>åœ¨éä¸­æ–‡ç›®å½•è§£å‹ç¼©è¿™ä¸ª zip åŒ…ï¼Œå…¶ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310180750336.png\" alt=\"image-20210622202515014\"></p>\n<h2 id=\"3ä¿®æ”¹é…ç½®\"><a class=\"markdownIt-Anchor\" href=\"#3ä¿®æ”¹é…ç½®\">#</a> 3. ä¿®æ”¹é…ç½®</h2>\n<p>ä¿®æ”¹ conf ç›®å½•ä¸‹çš„ registry.conf æ–‡ä»¶ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310180750504.png\" alt=\"image-20210622202622874\"></p>\n<p>å†…å®¹å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight properties\"><figcaption data-lang=\".properties\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key attr-name\">registry</span> <span class=\"token value attr-value\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">  # tc æœåŠ¡çš„æ³¨å†Œä¸­å¿ƒç±»ï¼Œè¿™é‡Œé€‰æ‹© nacosï¼Œä¹Ÿå¯ä»¥æ˜¯ eurekaã€zookeeper ç­‰</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key attr-name\">  type</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"nacos\"</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token key attr-name\">  nacos</span> <span class=\"token value attr-value\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">    # seata tc æœåŠ¡æ³¨å†Œåˆ° nacos çš„æœåŠ¡åç§°ï¼Œå¯ä»¥è‡ªå®šä¹‰</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token key attr-name\">    application</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"seata-tc-server\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token key attr-name\">    serverAddr</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"127.0.0.1:8848\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token key attr-name\">    group</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"DEFAULT_GROUP\"</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token key attr-name\">    namespace</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token key attr-name\">    cluster</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"SH\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token key attr-name\">    username</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"nacos\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token key attr-name\">    password</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"nacos\"</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  &#125;</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>&#125;</pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token key attr-name\">config</span> <span class=\"token value attr-value\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\">  # è¯»å– tc æœåŠ¡ç«¯çš„é…ç½®æ–‡ä»¶çš„æ–¹å¼ï¼Œè¿™é‡Œæ˜¯ä» nacos é…ç½®ä¸­å¿ƒè¯»å–ï¼Œè¿™æ ·å¦‚æœ tc æ˜¯é›†ç¾¤ï¼Œå¯ä»¥å…±äº«é…ç½®</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token key attr-name\">  type</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"nacos\"</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\">  # é…ç½® nacos åœ°å€ç­‰ä¿¡æ¯</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token key attr-name\">  nacos</span> <span class=\"token value attr-value\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token key attr-name\">    serverAddr</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"127.0.0.1:8848\"</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token key attr-name\">    namespace</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"\"</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token key attr-name\">    group</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"SEATA_GROUP\"</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token key attr-name\">    username</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"nacos\"</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token key attr-name\">    password</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"nacos\"</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token key attr-name\">    dataId</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"seataServer.properties\"</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  &#125;</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>&#125;</pre></td></tr></table></figure><p>Seata-1.7.0 ç‰ˆæœ¬çš„é…ç½®å¦‚ä¸‹ï¼š</p>\n<p>æ‰¾åˆ° yml é…ç½®æ–‡ä»¶</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310180927758.png\" alt=\"image-20231018092704361\"></p>\n<figure class=\"highlight yml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">server</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">7091</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">application</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> seata<span class=\"token punctuation\">-</span>server</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token key atrule\">logging</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token key atrule\">config</span><span class=\"token punctuation\">:</span> classpath<span class=\"token punctuation\">:</span>logback<span class=\"token punctuation\">-</span>spring.xml</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token key atrule\">file</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">&#123;</span>user.home<span class=\"token punctuation\">&#125;</span>/logs/seata</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token key atrule\">extend</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token key atrule\">logstash-appender</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token key atrule\">destination</span><span class=\"token punctuation\">:</span> 127.0.0.1<span class=\"token punctuation\">:</span><span class=\"token number\">4560</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token key atrule\">kafka-appender</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      <span class=\"token key atrule\">bootstrap-servers</span><span class=\"token punctuation\">:</span> 127.0.0.1<span class=\"token punctuation\">:</span><span class=\"token number\">9092</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      <span class=\"token key atrule\">topic</span><span class=\"token punctuation\">:</span> logback_to_logstash</pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token key atrule\">console</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token key atrule\">user</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token key atrule\">username</span><span class=\"token punctuation\">:</span> seata</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token key atrule\">password</span><span class=\"token punctuation\">:</span> seata</pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token key atrule\">seata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token key atrule\">config</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token comment\"># support: nacos, consul, apollo, zk, etcd3</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> nacos</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token key atrule\">nacos</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      <span class=\"token key atrule\">server-addr</span><span class=\"token punctuation\">:</span> 127.0.0.1<span class=\"token punctuation\">:</span><span class=\"token number\">8848</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      <span class=\"token comment\"># æ”¹è¿™é‡Œä¼šæŠ¥é”™</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      <span class=\"token key atrule\">group</span><span class=\"token punctuation\">:</span> SEATA_GROUP</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      <span class=\"token key atrule\">username</span><span class=\"token punctuation\">:</span> nacos</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>      <span class=\"token key atrule\">password</span><span class=\"token punctuation\">:</span> nacos</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      <span class=\"token comment\">##if use MSE Nacos with auth, mutex with username/password attribute</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>      <span class=\"token comment\">#access-key: \"\"</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>      <span class=\"token comment\">#secret-key: \"\"</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      <span class=\"token key atrule\">data-id</span><span class=\"token punctuation\">:</span> seataServer.properties</pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  <span class=\"token key atrule\">registry</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token comment\"># support: nacos, eureka, redis, zk, consul, etcd3, sofa</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> nacos</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token key atrule\">preferred-networks</span><span class=\"token punctuation\">:</span> 30.240.*</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token key atrule\">nacos</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>      <span class=\"token key atrule\">application</span><span class=\"token punctuation\">:</span> seata<span class=\"token punctuation\">-</span>tc<span class=\"token punctuation\">-</span>server</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>      <span class=\"token key atrule\">server-addr</span><span class=\"token punctuation\">:</span> 127.0.0.1<span class=\"token punctuation\">:</span><span class=\"token number\">8848</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>      <span class=\"token key atrule\">group</span><span class=\"token punctuation\">:</span> DEFAULT_GROUP</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>      <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>      <span class=\"token key atrule\">cluster</span><span class=\"token punctuation\">:</span> SH</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>      <span class=\"token key atrule\">username</span><span class=\"token punctuation\">:</span> nacos</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>      <span class=\"token key atrule\">password</span><span class=\"token punctuation\">:</span> nacos</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>      <span class=\"token comment\">##if use MSE Nacos with auth, mutex with username/password attribute</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>      <span class=\"token comment\">#access-key: \"\"</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>      <span class=\"token comment\">#secret-key: \"\"</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  <span class=\"token key atrule\">store</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    <span class=\"token comment\"># support: file ã€ db ã€ redis</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    <span class=\"token key atrule\">mode</span><span class=\"token punctuation\">:</span> db</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    <span class=\"token key atrule\">db</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>      <span class=\"token key atrule\">datasource</span><span class=\"token punctuation\">:</span> druid</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>      <span class=\"token key atrule\">db-type</span><span class=\"token punctuation\">:</span> mysql</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>      <span class=\"token key atrule\">driver-class-name</span><span class=\"token punctuation\">:</span> com.mysql.cj.jdbc.Driver</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>      <span class=\"token key atrule\">url</span><span class=\"token punctuation\">:</span> jdbc<span class=\"token punctuation\">:</span>mysql<span class=\"token punctuation\">:</span>//127.0.0.1<span class=\"token punctuation\">:</span>13306/seata<span class=\"token punctuation\">?</span>useUnicode=true<span class=\"token important\">&amp;rewriteBatchedStatements=true&amp;serverTimezone=GMT</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>      <span class=\"token key atrule\">user</span><span class=\"token punctuation\">:</span> root</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>      <span class=\"token key atrule\">password</span><span class=\"token punctuation\">:</span> dkx.</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>      <span class=\"token key atrule\">min-conn</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>      <span class=\"token key atrule\">max-conn</span><span class=\"token punctuation\">:</span> <span class=\"token number\">100</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>      <span class=\"token key atrule\">global-table</span><span class=\"token punctuation\">:</span> global_table</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>      <span class=\"token key atrule\">branch-table</span><span class=\"token punctuation\">:</span> branch_table</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>      <span class=\"token key atrule\">lock-table</span><span class=\"token punctuation\">:</span> lock_table</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>      <span class=\"token key atrule\">distributed-lock-table</span><span class=\"token punctuation\">:</span> distributed_lock</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>      <span class=\"token key atrule\">query-limit</span><span class=\"token punctuation\">:</span> <span class=\"token number\">100</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>      <span class=\"token key atrule\">max-wait</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5000</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre><span class=\"token comment\">#  server:</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre><span class=\"token comment\">#    service-port: 8091 #If not configured, the default is '$&#123;server.port&#125; + 1000'</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>  <span class=\"token key atrule\">security</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>    <span class=\"token key atrule\">secretKey</span><span class=\"token punctuation\">:</span> SeataSecretKey0c382ef121d778043159209298fd40bf3850a017</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>    <span class=\"token key atrule\">tokenValidityInMilliseconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1800000</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>    <span class=\"token key atrule\">ignore</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>      <span class=\"token key atrule\">urls</span><span class=\"token punctuation\">:</span> /<span class=\"token punctuation\">,</span>/<span class=\"token important\">**/*.css</span><span class=\"token punctuation\">,</span>/<span class=\"token important\">**/*.js</span><span class=\"token punctuation\">,</span>/<span class=\"token important\">**/*.html</span><span class=\"token punctuation\">,</span>/<span class=\"token important\">**/*.map</span><span class=\"token punctuation\">,</span>/<span class=\"token important\">**/*.svg</span><span class=\"token punctuation\">,</span>/<span class=\"token important\">**/*.png</span><span class=\"token punctuation\">,</span>/<span class=\"token important\">**/*.ico</span><span class=\"token punctuation\">,</span>/console<span class=\"token punctuation\">-</span>fe/public/<span class=\"token important\">**</span><span class=\"token punctuation\">,</span>/api/v1/auth/login</pre></td></tr></table></figure><h2 id=\"4åœ¨nacosæ·»åŠ é…ç½®\"><a class=\"markdownIt-Anchor\" href=\"#4åœ¨nacosæ·»åŠ é…ç½®\">#</a> 4. åœ¨ nacos æ·»åŠ é…ç½®</h2>\n<p>ç‰¹åˆ«æ³¨æ„ï¼Œä¸ºäº†è®© tc æœåŠ¡çš„é›†ç¾¤å¯ä»¥å…±äº«é…ç½®ï¼Œæˆ‘ä»¬é€‰æ‹©äº† nacos ä½œä¸ºç»Ÿä¸€é…ç½®ä¸­å¿ƒã€‚å› æ­¤æœåŠ¡ç«¯é…ç½®æ–‡ä»¶ seataServer.properties æ–‡ä»¶éœ€è¦åœ¨ nacos ä¸­é…å¥½ã€‚</p>\n<p>æ ¼å¼å¦‚ä¸‹ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310180750398.png\" alt=\"image-20210622203609227\"></p>\n<p>é…ç½®å†…å®¹å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight properties\"><figcaption data-lang=\".properties\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># æ•°æ®å­˜å‚¨æ–¹å¼ï¼Œdb ä»£è¡¨æ•°æ®åº“</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key attr-name\">store.mode</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">db</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key attr-name\">store.db.datasource</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">druid</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token key attr-name\">store.db.dbType</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">mysql</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token key attr-name\">store.db.driverClassName</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">com.mysql.jdbc.Driver</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key attr-name\">store.db.url</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">jdbc:mysql://127.0.0.1:3306/seata?useUnicode=true&amp;rewriteBatchedStatements=true</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token key attr-name\">store.db.user</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">root</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token key attr-name\">store.db.password</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">123</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token key attr-name\">store.db.minConn</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">5</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token key attr-name\">store.db.maxConn</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">30</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token key attr-name\">store.db.globalTable</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">global_table</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token key attr-name\">store.db.branchTable</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">branch_table</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token key attr-name\">store.db.queryLimit</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">100</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token key attr-name\">store.db.lockTable</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">lock_table</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token key attr-name\">store.db.maxWait</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">5000</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\"># äº‹åŠ¡ã€æ—¥å¿—ç­‰é…ç½®</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token key attr-name\">server.recovery.committingRetryPeriod</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">1000</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token key attr-name\">server.recovery.asynCommittingRetryPeriod</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">1000</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token key attr-name\">server.recovery.rollbackingRetryPeriod</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">1000</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token key attr-name\">server.recovery.timeoutRetryPeriod</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">1000</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token key attr-name\">server.maxCommitRetryTimeout</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">-1</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token key attr-name\">server.maxRollbackRetryTimeout</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">-1</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token key attr-name\">server.rollbackRetryTimeoutUnlockEnable</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">false</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token key attr-name\">server.undo.logSaveDays</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">7</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token key attr-name\">server.undo.logDeletePeriod</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">86400000</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token comment\"># å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¼ è¾“æ–¹å¼</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token key attr-name\">transport.serialization</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">seata</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token key attr-name\">transport.compressor</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">none</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token comment\"># å…³é—­ metrics åŠŸèƒ½ï¼Œæé«˜æ€§èƒ½</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token key attr-name\">metrics.enabled</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">false</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token key attr-name\">metrics.registryType</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">compact</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token key attr-name\">metrics.exporterList</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">prometheus</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token key attr-name\">metrics.exporterPrometheusPort</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">9898</span></pre></td></tr></table></figure><p><mark>å…¶ä¸­çš„æ•°æ®åº“åœ°å€ã€ç”¨æˆ·åã€å¯†ç éƒ½éœ€è¦ä¿®æ”¹æˆä½ è‡ªå·±çš„æ•°æ®åº“ä¿¡æ¯ã€‚</mark></p>\n<h2 id=\"5åˆ›å»ºæ•°æ®åº“è¡¨\"><a class=\"markdownIt-Anchor\" href=\"#5åˆ›å»ºæ•°æ®åº“è¡¨\">#</a> 5. åˆ›å»ºæ•°æ®åº“è¡¨</h2>\n<p>ç‰¹åˆ«æ³¨æ„ï¼štc æœåŠ¡åœ¨ç®¡ç†åˆ†å¸ƒå¼äº‹åŠ¡æ—¶ï¼Œéœ€è¦è®°å½•äº‹åŠ¡ç›¸å…³æ•°æ®åˆ°æ•°æ®åº“ä¸­ï¼Œä½ éœ€è¦æå‰åˆ›å»ºå¥½è¿™äº›è¡¨ã€‚</p>\n<p>æ–°å»ºä¸€ä¸ªåä¸º seata çš„æ•°æ®åº“ï¼Œè¿è¡Œè¯¾å‰èµ„æ–™æä¾›çš„ sql æ–‡ä»¶ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310180750346.png\" alt=\"image-20210622204145159\"></p>\n<p>è¿™äº›è¡¨ä¸»è¦è®°å½•å…¨å±€äº‹åŠ¡ã€åˆ†æ”¯äº‹åŠ¡ã€å…¨å±€é”ä¿¡æ¯ï¼š</p>\n<pre><code class=\"language-mysql\">\nSET NAMES utf8mb4;\nSET FOREIGN_KEY_CHECKS = 0;\n\n-- ----------------------------\n-- åˆ†æ”¯äº‹åŠ¡è¡¨\n-- ----------------------------\nDROP TABLE IF EXISTS `branch_table`;\nCREATE TABLE `branch_table`  (\n  `branch_id` bigint(20) NOT NULL,\n  `xid` varchar(128) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,\n  `transaction_id` bigint(20) NULL DEFAULT NULL,\n  `resource_group_id` varchar(32) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,\n  `resource_id` varchar(256) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,\n  `branch_type` varchar(8) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,\n  `status` tinyint(4) NULL DEFAULT NULL,\n  `client_id` varchar(64) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,\n  `application_data` varchar(2000) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,\n  `gmt_create` datetime(6) NULL DEFAULT NULL,\n  `gmt_modified` datetime(6) NULL DEFAULT NULL,\n  PRIMARY KEY (`branch_id`) USING BTREE,\n  INDEX `idx_xid`(`xid`) USING BTREE\n) ENGINE = InnoDB CHARACTER SET = utf8 COLLATE = utf8_general_ci ROW_FORMAT = Compact;\n\n-- ----------------------------\n-- å…¨å±€äº‹åŠ¡è¡¨\n-- ----------------------------\nDROP TABLE IF EXISTS `global_table`;\nCREATE TABLE `global_table`  (\n  `xid` varchar(128) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,\n  `transaction_id` bigint(20) NULL DEFAULT NULL,\n  `status` tinyint(4) NOT NULL,\n  `application_id` varchar(32) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,\n  `transaction_service_group` varchar(32) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,\n  `transaction_name` varchar(128) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,\n  `timeout` int(11) NULL DEFAULT NULL,\n  `begin_time` bigint(20) NULL DEFAULT NULL,\n  `application_data` varchar(2000) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,\n  `gmt_create` datetime NULL DEFAULT NULL,\n  `gmt_modified` datetime NULL DEFAULT NULL,\n  PRIMARY KEY (`xid`) USING BTREE,\n  INDEX `idx_gmt_modified_status`(`gmt_modified`, `status`) USING BTREE,\n  INDEX `idx_transaction_id`(`transaction_id`) USING BTREE\n) ENGINE = InnoDB CHARACTER SET = utf8 COLLATE = utf8_general_ci ROW_FORMAT = Compact;\n\nSET FOREIGN_KEY_CHECKS = 1;\n</code></pre>\n<h2 id=\"6å¯åŠ¨tcæœåŠ¡\"><a class=\"markdownIt-Anchor\" href=\"#6å¯åŠ¨tcæœåŠ¡\">#</a> 6. å¯åŠ¨ TC æœåŠ¡</h2>\n<p>è¿›å…¥ bin ç›®å½•ï¼Œè¿è¡Œå…¶ä¸­çš„ seata-server.bat å³å¯ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310180750008.png\" alt=\"image-20210622205427318\"></p>\n<p>å¯åŠ¨æˆåŠŸåï¼Œseata-server åº”è¯¥å·²ç»æ³¨å†Œåˆ° nacos æ³¨å†Œä¸­å¿ƒäº†ã€‚</p>\n<p>æ‰“å¼€æµè§ˆå™¨ï¼Œè®¿é—® nacos åœ°å€ï¼š<a href=\"http://localhost:8848\">http://localhost:8848</a>ï¼Œç„¶åè¿›å…¥æœåŠ¡åˆ—è¡¨é¡µé¢ï¼Œå¯ä»¥çœ‹åˆ° seata-tc-server çš„ä¿¡æ¯ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310180750053.png\" alt=\"image-20210622205901450\"></p>\n<h1 id=\"äºŒ-å¾®æœåŠ¡é›†æˆseata\"><a class=\"markdownIt-Anchor\" href=\"#äºŒ-å¾®æœåŠ¡é›†æˆseata\">#</a> äºŒã€å¾®æœåŠ¡é›†æˆ seata</h1>\n<h2 id=\"1å¼•å…¥ä¾èµ–\"><a class=\"markdownIt-Anchor\" href=\"#1å¼•å…¥ä¾èµ–\">#</a> 1. å¼•å…¥ä¾èµ–</h2>\n<p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åœ¨å¾®æœåŠ¡ä¸­å¼•å…¥ seata ä¾èµ–ï¼š</p>\n<figure class=\"highlight xml\"><figcaption data-lang=\"XML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">></span></span>com.alibaba.cloud<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">></span></span>spring-cloud-starter-alibaba-seata<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>exclusions</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token comment\">&lt;!-- ç‰ˆæœ¬è¾ƒä½ï¼Œ1.3.0ï¼Œå› æ­¤æ’é™¤ --></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>exclusion</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">></span></span>seata-spring-boot-starter<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">></span></span>io.seata<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>exclusion</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>exclusions</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">&lt;!--seata starter é‡‡ç”¨ 1.4.2 ç‰ˆæœ¬ --></span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">></span></span>io.seata<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">></span></span>seata-spring-boot-starter<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>version</span><span class=\"token punctuation\">></span></span>$&#123;seata.version&#125;<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>version</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">></span></span></pre></td></tr></table></figure><h2 id=\"2ä¿®æ”¹é…ç½®æ–‡ä»¶\"><a class=\"markdownIt-Anchor\" href=\"#2ä¿®æ”¹é…ç½®æ–‡ä»¶\">#</a> 2. ä¿®æ”¹é…ç½®æ–‡ä»¶</h2>\n<p>éœ€è¦ä¿®æ”¹ application.yml æ–‡ä»¶ï¼Œæ·»åŠ ä¸€äº›é…ç½®ï¼š</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">seata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">registry</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># TC æœåŠ¡æ³¨å†Œä¸­å¿ƒçš„é…ç½®ï¼Œå¾®æœåŠ¡æ ¹æ®è¿™äº›ä¿¡æ¯å»æ³¨å†Œä¸­å¿ƒè·å– tc æœåŠ¡åœ°å€</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token comment\"># å‚è€ƒ tc æœåŠ¡è‡ªå·±çš„ registry.conf ä¸­çš„é…ç½®</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> nacos</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token key atrule\">nacos</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># tc</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      <span class=\"token key atrule\">server-addr</span><span class=\"token punctuation\">:</span> 127.0.0.1<span class=\"token punctuation\">:</span><span class=\"token number\">8848</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      <span class=\"token key atrule\">group</span><span class=\"token punctuation\">:</span> DEFAULT_GROUP</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token key atrule\">application</span><span class=\"token punctuation\">:</span> seata<span class=\"token punctuation\">-</span>tc<span class=\"token punctuation\">-</span>server <span class=\"token comment\"># tc æœåŠ¡åœ¨ nacos ä¸­çš„æœåŠ¡åç§°</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token key atrule\">cluster</span><span class=\"token punctuation\">:</span> SH</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token key atrule\">tx-service-group</span><span class=\"token punctuation\">:</span> seata<span class=\"token punctuation\">-</span>demo <span class=\"token comment\"># äº‹åŠ¡ç»„ï¼Œæ ¹æ®è¿™ä¸ªè·å– tc æœåŠ¡çš„ cluster åç§°</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token key atrule\">vgroup-mapping</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># äº‹åŠ¡ç»„ä¸ TC æœåŠ¡ cluster çš„æ˜ å°„å…³ç³»</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token key atrule\">seata-demo</span><span class=\"token punctuation\">:</span> SH</pre></td></tr></table></figure><p>è¦ä» nacos ä¸­æ‰¾åˆ°ä¸€ä¸ªæœåŠ¡ï¼Œæˆ‘éœ€è¦çŸ¥é“ä»€ä¹ˆä¿¡æ¯ã€‚</p>\n<p>æˆ‘ä»¬ä» nacos æ‰¾åˆ°ä¸€ä¸ªæœåŠ¡è‡³å°‘éœ€è¦çŸ¥é“ namespaceï¼Œgroupï¼Œapplication-name å’Œ cluster</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310180945757.png\" alt=\"image-20231018094533567\"></p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310180948844.png\" alt=\"image-20231018094851842\"></p>\n<blockquote>\n<p><strong>æ€»ç»“</strong>ï¼š</p>\n<p>nacos æœåŠ¡åç§°ç»„æˆåŒ…æ‹¬ï¼Ÿ</p>\n<ul>\n<li>namespace + group + serviceName + cluster</li>\n</ul>\n<p>seata å®¢æˆ·ç«¯è·å– tc çš„ cluster åç§°æ–¹å¼</p>\n<ul>\n<li>ä»¥ tx-group-service çš„å€¼ä¸º key åˆ° vgroupMapping ä¸­æŸ¥æ‰¾</li>\n</ul>\n</blockquote>\n<h1 id=\"ä¸‰-tcæœåŠ¡çš„é«˜å¯ç”¨å’Œå¼‚åœ°å®¹ç¾\"><a class=\"markdownIt-Anchor\" href=\"#ä¸‰-tcæœåŠ¡çš„é«˜å¯ç”¨å’Œå¼‚åœ°å®¹ç¾\">#</a> ä¸‰ã€TC æœåŠ¡çš„é«˜å¯ç”¨å’Œå¼‚åœ°å®¹ç¾</h1>\n<h2 id=\"1æ¨¡æ‹Ÿå¼‚åœ°å®¹ç¾çš„tcé›†ç¾¤\"><a class=\"markdownIt-Anchor\" href=\"#1æ¨¡æ‹Ÿå¼‚åœ°å®¹ç¾çš„tcé›†ç¾¤\">#</a> 1. æ¨¡æ‹Ÿå¼‚åœ°å®¹ç¾çš„ TC é›†ç¾¤</h2>\n<p>è®¡åˆ’å¯åŠ¨ä¸¤å° seata çš„ tc æœåŠ¡èŠ‚ç‚¹ï¼š</p>\n<table>\n<thead>\n<tr>\n<th>èŠ‚ç‚¹åç§°</th>\n<th>ip åœ°å€</th>\n<th>ç«¯å£å·</th>\n<th>é›†ç¾¤åç§°</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>seata</td>\n<td>127.0.0.1</td>\n<td>8091</td>\n<td>SH</td>\n</tr>\n<tr>\n<td>seata2</td>\n<td>127.0.0.1</td>\n<td>8092</td>\n<td>HZ</td>\n</tr>\n</tbody>\n</table>\n<p>ä¹‹å‰æˆ‘ä»¬å·²ç»å¯åŠ¨äº†ä¸€å° seata æœåŠ¡ï¼Œç«¯å£æ˜¯ 8091ï¼Œé›†ç¾¤åä¸º SHã€‚</p>\n<p>ç°åœ¨ï¼Œå°† seata ç›®å½•å¤åˆ¶ä¸€ä»½ï¼Œèµ·åä¸º seata2</p>\n<p>ä¿®æ”¹ seata2/conf/registry.conf å†…å®¹å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight nginx\"><figcaption data-lang=\"nginx\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token directive\"><span class=\"token keyword\">registry</span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token comment\"># tc æœåŠ¡çš„æ³¨å†Œä¸­å¿ƒç±»ï¼Œè¿™é‡Œé€‰æ‹© nacosï¼Œä¹Ÿå¯ä»¥æ˜¯ eurekaã€zookeeper ç­‰</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token directive\"><span class=\"token keyword\">type</span> = <span class=\"token string\">\"nacos\"</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  nacos</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token comment\"># seata tc æœåŠ¡æ³¨å†Œåˆ° nacos çš„æœåŠ¡åç§°ï¼Œå¯ä»¥è‡ªå®šä¹‰</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    application = \"seata-tc-server\"</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    serverAddr = \"127.0.0.1:8848\"</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    group = \"DEFAULT_GROUP\"</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    namespace = \"\"</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    cluster = \"HZ\"</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    username = \"nacos\"</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    password = \"nacos\"</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token directive\"><span class=\"token keyword\">config</span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token comment\"># è¯»å– tc æœåŠ¡ç«¯çš„é…ç½®æ–‡ä»¶çš„æ–¹å¼ï¼Œè¿™é‡Œæ˜¯ä» nacos é…ç½®ä¸­å¿ƒè¯»å–ï¼Œè¿™æ ·å¦‚æœ tc æ˜¯é›†ç¾¤ï¼Œå¯ä»¥å…±äº«é…ç½®</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token directive\"><span class=\"token keyword\">type</span> = <span class=\"token string\">\"nacos\"</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token comment\"># é…ç½® nacos åœ°å€ç­‰ä¿¡æ¯</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  nacos</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    serverAddr = \"127.0.0.1:8848\"</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    namespace = \"\"</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    group = \"SEATA_GROUP\"</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    username = \"nacos\"</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    password = \"nacos\"</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    dataId = \"seataServer.properties\"</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>Seata-1.7.0 ç‰ˆæœ¬çš„é…ç½®å¦‚ä¸‹ï¼š</p>\n<p>æ‰¾åˆ° yml é…ç½®æ–‡ä»¶</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310181958636.png\" alt=\"image-20231018092704361\"></p>\n<figure class=\"highlight yml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">server</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">7091</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">application</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> seata<span class=\"token punctuation\">-</span>server</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token key atrule\">logging</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token key atrule\">config</span><span class=\"token punctuation\">:</span> classpath<span class=\"token punctuation\">:</span>logback<span class=\"token punctuation\">-</span>spring.xml</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token key atrule\">file</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">&#123;</span>user.home<span class=\"token punctuation\">&#125;</span>/logs/seata</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token key atrule\">extend</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token key atrule\">logstash-appender</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token key atrule\">destination</span><span class=\"token punctuation\">:</span> 127.0.0.1<span class=\"token punctuation\">:</span><span class=\"token number\">4560</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token key atrule\">kafka-appender</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      <span class=\"token key atrule\">bootstrap-servers</span><span class=\"token punctuation\">:</span> 127.0.0.1<span class=\"token punctuation\">:</span><span class=\"token number\">9092</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      <span class=\"token key atrule\">topic</span><span class=\"token punctuation\">:</span> logback_to_logstash</pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token key atrule\">console</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token key atrule\">user</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token key atrule\">username</span><span class=\"token punctuation\">:</span> seata</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token key atrule\">password</span><span class=\"token punctuation\">:</span> seata</pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token key atrule\">seata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token key atrule\">config</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token comment\"># support: nacos, consul, apollo, zk, etcd3</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> nacos</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token key atrule\">nacos</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      <span class=\"token key atrule\">server-addr</span><span class=\"token punctuation\">:</span> 127.0.0.1<span class=\"token punctuation\">:</span><span class=\"token number\">8848</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      <span class=\"token comment\"># æ”¹è¿™é‡Œä¼šæŠ¥é”™</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      <span class=\"token key atrule\">group</span><span class=\"token punctuation\">:</span> SEATA_GROUP</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      <span class=\"token key atrule\">username</span><span class=\"token punctuation\">:</span> nacos</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>      <span class=\"token key atrule\">password</span><span class=\"token punctuation\">:</span> nacos</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      <span class=\"token comment\">##if use MSE Nacos with auth, mutex with username/password attribute</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>      <span class=\"token comment\">#access-key: \"\"</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>      <span class=\"token comment\">#secret-key: \"\"</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      <span class=\"token key atrule\">data-id</span><span class=\"token punctuation\">:</span> seataServer.properties</pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  <span class=\"token key atrule\">registry</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token comment\"># support: nacos, eureka, redis, zk, consul, etcd3, sofa</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> nacos</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token key atrule\">preferred-networks</span><span class=\"token punctuation\">:</span> 30.240.*</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token key atrule\">nacos</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>      <span class=\"token key atrule\">application</span><span class=\"token punctuation\">:</span> seata<span class=\"token punctuation\">-</span>tc<span class=\"token punctuation\">-</span>server</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>      <span class=\"token key atrule\">server-addr</span><span class=\"token punctuation\">:</span> 127.0.0.1<span class=\"token punctuation\">:</span><span class=\"token number\">8848</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>      <span class=\"token key atrule\">group</span><span class=\"token punctuation\">:</span> DEFAULT_GROUP</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>      <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>      <span class=\"token key atrule\">cluster</span><span class=\"token punctuation\">:</span> HZ <span class=\"token comment\"># ä¿®æ”¹é›†ç¾¤åœ°å€</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>      <span class=\"token key atrule\">username</span><span class=\"token punctuation\">:</span> nacos</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>      <span class=\"token key atrule\">password</span><span class=\"token punctuation\">:</span> nacos</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>      <span class=\"token comment\">##if use MSE Nacos with auth, mutex with username/password attribute</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>      <span class=\"token comment\">#access-key: \"\"</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>      <span class=\"token comment\">#secret-key: \"\"</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"56\"></td><td><pre>  <span class=\"token key atrule\">store</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    <span class=\"token comment\"># support: file ã€ db ã€ redis</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    <span class=\"token key atrule\">mode</span><span class=\"token punctuation\">:</span> db</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    <span class=\"token key atrule\">db</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>      <span class=\"token key atrule\">datasource</span><span class=\"token punctuation\">:</span> druid</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>      <span class=\"token key atrule\">db-type</span><span class=\"token punctuation\">:</span> mysql</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>      <span class=\"token key atrule\">driver-class-name</span><span class=\"token punctuation\">:</span> com.mysql.cj.jdbc.Driver</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>      <span class=\"token key atrule\">url</span><span class=\"token punctuation\">:</span> jdbc<span class=\"token punctuation\">:</span>mysql<span class=\"token punctuation\">:</span>//127.0.0.1<span class=\"token punctuation\">:</span>13306/seata<span class=\"token punctuation\">?</span>useUnicode=true<span class=\"token important\">&amp;rewriteBatchedStatements=true&amp;serverTimezone=GMT</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>      <span class=\"token key atrule\">user</span><span class=\"token punctuation\">:</span> root</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>      <span class=\"token key atrule\">password</span><span class=\"token punctuation\">:</span> dkx.</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>      <span class=\"token key atrule\">min-conn</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>      <span class=\"token key atrule\">max-conn</span><span class=\"token punctuation\">:</span> <span class=\"token number\">100</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>      <span class=\"token key atrule\">global-table</span><span class=\"token punctuation\">:</span> global_table</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>      <span class=\"token key atrule\">branch-table</span><span class=\"token punctuation\">:</span> branch_table</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>      <span class=\"token key atrule\">lock-table</span><span class=\"token punctuation\">:</span> lock_table</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>      <span class=\"token key atrule\">distributed-lock-table</span><span class=\"token punctuation\">:</span> distributed_lock</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>      <span class=\"token key atrule\">query-limit</span><span class=\"token punctuation\">:</span> <span class=\"token number\">100</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>      <span class=\"token key atrule\">max-wait</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5000</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre><span class=\"token comment\">#  server:</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre><span class=\"token comment\">#    service-port: 8091 #If not configured, the default is '$&#123;server.port&#125; + 1000'</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>  <span class=\"token key atrule\">security</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>    <span class=\"token key atrule\">secretKey</span><span class=\"token punctuation\">:</span> SeataSecretKey0c382ef121d778043159209298fd40bf3850a017</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>    <span class=\"token key atrule\">tokenValidityInMilliseconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1800000</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>    <span class=\"token key atrule\">ignore</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>      <span class=\"token key atrule\">urls</span><span class=\"token punctuation\">:</span> /<span class=\"token punctuation\">,</span>/<span class=\"token important\">**/*.css</span><span class=\"token punctuation\">,</span>/<span class=\"token important\">**/*.js</span><span class=\"token punctuation\">,</span>/<span class=\"token important\">**/*.html</span><span class=\"token punctuation\">,</span>/<span class=\"token important\">**/*.map</span><span class=\"token punctuation\">,</span>/<span class=\"token important\">**/*.svg</span><span class=\"token punctuation\">,</span>/<span class=\"token important\">**/*.png</span><span class=\"token punctuation\">,</span>/<span class=\"token important\">**/*.ico</span><span class=\"token punctuation\">,</span>/console<span class=\"token punctuation\">-</span>fe/public/<span class=\"token important\">**</span><span class=\"token punctuation\">,</span>/api/v1/auth/login</pre></td></tr></table></figure><p>è¿›å…¥ seata2/bin ç›®å½•ï¼Œç„¶åè¿è¡Œå‘½ä»¤ï¼š</p>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>seata-server<span class=\"token punctuation\">.</span>bat <span class=\"token operator\">-</span>p 8092</pre></td></tr></table></figure><p>1.7.0 ç‰ˆæœ¬å®åœ¨ä¸è¡Œå°±é…ç½®æ–‡ä»¶é‡Œä¿®æ”¹ç«¯å£å·</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310182005822.png\" alt=\"image-20231018200503303\"></p>\n<p>æ‰“å¼€ nacos æ§åˆ¶å°ï¼ŒæŸ¥çœ‹æœåŠ¡åˆ—è¡¨ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310180750772.png\" alt=\"image-20210624151150840\"></p>\n<p>ç‚¹è¿›è¯¦æƒ…æŸ¥çœ‹ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310180750333.png\" alt=\"image-20210624151221747\"></p>\n<h2 id=\"2å°†äº‹åŠ¡ç»„æ˜ å°„é…ç½®åˆ°nacos\"><a class=\"markdownIt-Anchor\" href=\"#2å°†äº‹åŠ¡ç»„æ˜ å°„é…ç½®åˆ°nacos\">#</a> 2. å°†äº‹åŠ¡ç»„æ˜ å°„é…ç½®åˆ° nacos</h2>\n<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦å°† tx-service-group ä¸ cluster çš„æ˜ å°„å…³ç³»éƒ½é…ç½®åˆ° nacos é…ç½®ä¸­å¿ƒã€‚</p>\n<p>æ–°å»ºä¸€ä¸ªé…ç½®ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310180751774.png\" alt=\"image-20210624151507072\"></p>\n<p>é…ç½®çš„å†…å®¹å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight properties\"><figcaption data-lang=\".properties\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># äº‹åŠ¡ç»„æ˜ å°„å…³ç³»</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key attr-name\">service.vgroupMapping.seata-demo</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">SH</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token key attr-name\">service.enableDegrade</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">false</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token key attr-name\">service.disableGlobalTransaction</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">false</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># ä¸ TC æœåŠ¡çš„é€šä¿¡é…ç½®</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token key attr-name\">transport.type</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">TCP</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token key attr-name\">transport.server</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">NIO</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token key attr-name\">transport.heartbeat</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">true</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token key attr-name\">transport.enableClientBatchSendRequest</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">false</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token key attr-name\">transport.threadFactory.bossThreadPrefix</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">NettyBoss</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token key attr-name\">transport.threadFactory.workerThreadPrefix</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">NettyServerNIOWorker</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token key attr-name\">transport.threadFactory.serverExecutorThreadPrefix</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">NettyServerBizHandler</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token key attr-name\">transport.threadFactory.shareBossWorker</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">false</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token key attr-name\">transport.threadFactory.clientSelectorThreadPrefix</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">NettyClientSelector</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token key attr-name\">transport.threadFactory.clientSelectorThreadSize</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">1</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token key attr-name\">transport.threadFactory.clientWorkerThreadPrefix</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">NettyClientWorkerThread</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token key attr-name\">transport.threadFactory.bossThreadSize</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">1</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token key attr-name\">transport.threadFactory.workerThreadSize</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">default</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token key attr-name\">transport.shutdown.wait</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">3</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token comment\"># RM é…ç½®</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token key attr-name\">client.rm.asyncCommitBufferLimit</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">10000</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token key attr-name\">client.rm.lock.retryInterval</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">10</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token key attr-name\">client.rm.lock.retryTimes</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">30</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token key attr-name\">client.rm.lock.retryPolicyBranchRollbackOnConflict</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">true</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token key attr-name\">client.rm.reportRetryCount</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">5</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token key attr-name\">client.rm.tableMetaCheckEnable</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">false</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token key attr-name\">client.rm.tableMetaCheckerInterval</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">60000</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token key attr-name\">client.rm.sqlParserType</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">druid</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token key attr-name\">client.rm.reportSuccessEnable</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">false</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token key attr-name\">client.rm.sagaBranchRegisterEnable</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">false</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token comment\"># TM é…ç½®</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token key attr-name\">client.tm.commitRetryCount</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">5</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token key attr-name\">client.tm.rollbackRetryCount</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">5</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token key attr-name\">client.tm.defaultGlobalTransactionTimeout</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">60000</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token key attr-name\">client.tm.degradeCheck</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">false</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token key attr-name\">client.tm.degradeCheckAllowTimes</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">10</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token key attr-name\">client.tm.degradeCheckPeriod</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">2000</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token comment\"># undo æ—¥å¿—é…ç½®</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token key attr-name\">client.undo.dataValidation</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">true</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token key attr-name\">client.undo.logSerialization</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">jackson</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token key attr-name\">client.undo.onlyCareUpdateColumns</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">true</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token key attr-name\">client.undo.logTable</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">undo_log</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token key attr-name\">client.undo.compress.enable</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">true</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token key attr-name\">client.undo.compress.type</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">zip</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token key attr-name\">client.undo.compress.threshold</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">64k</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token key attr-name\">client.log.exceptionRate</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">100</span></pre></td></tr></table></figure><h2 id=\"3å¾®æœåŠ¡è¯»å–nacosé…ç½®\"><a class=\"markdownIt-Anchor\" href=\"#3å¾®æœåŠ¡è¯»å–nacosé…ç½®\">#</a> 3. å¾®æœåŠ¡è¯»å– nacos é…ç½®</h2>\n<p>æ¥ä¸‹æ¥ï¼Œéœ€è¦ä¿®æ”¹æ¯ä¸€ä¸ªå¾®æœåŠ¡çš„ application.yml æ–‡ä»¶ï¼Œè®©å¾®æœåŠ¡è¯»å– nacos ä¸­çš„ client.properties æ–‡ä»¶ï¼š</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">seata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">config</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> nacos</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token key atrule\">nacos</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      <span class=\"token key atrule\">server-addr</span><span class=\"token punctuation\">:</span> 127.0.0.1<span class=\"token punctuation\">:</span><span class=\"token number\">8848</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      <span class=\"token key atrule\">username</span><span class=\"token punctuation\">:</span> nacos</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token key atrule\">password</span><span class=\"token punctuation\">:</span> nacos</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      <span class=\"token key atrule\">group</span><span class=\"token punctuation\">:</span> SEATA_GROUP <span class=\"token comment\"># è¿™é‡Œå’Œ nacos æ·»åŠ é…ç½®æ–‡ä»¶ä¸­çš„ group è¦ä¸€è‡´</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token key atrule\">data-id</span><span class=\"token punctuation\">:</span> client.properties</pre></td></tr></table></figure><p>é‡å¯å¾®æœåŠ¡ï¼Œç°åœ¨å¾®æœåŠ¡åˆ°åº•æ˜¯è¿æ¥ tc çš„ SH é›†ç¾¤ï¼Œè¿˜æ˜¯ tc çš„ HZ é›†ç¾¤ï¼Œéƒ½ç»Ÿä¸€ç”± nacos çš„ client.properties æ¥å†³å®šäº†ã€‚</p>\n<p>8092</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310182016810.png\" alt=\"image-20231018201640218\"></p>\n<p>7091</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310182017126.png\" alt=\"image-20231018201658572\"></p>\n<p>å¯ä»¥çœ‹åˆ° 8092 æ²¡æœ‰ä»»ä½•äººæ³¨å†Œï¼Œè€Œæ˜¯éƒ½æ³¨å†Œåˆ°äº† 7091 ä¸Šäº†</p>\n<p>æˆ‘ä»¬å» nacos æ§åˆ¶å°ä¸­å¯¹åˆšæ‰åˆ›å»ºçš„é…ç½®æ–‡ä»¶çš„é›†ç¾¤åœ°å€è¿›è¡Œä¿®æ”¹ä¸ºï¼šHZ</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310182019284.png\" alt=\"image-20231018201902967\"></p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310182019735.png\" alt=\"image-20231018201919714\"></p>\n<p>åœ¨ 8092 çš„ seata å¯åŠ¨çª—å£å°±å¯ä»¥çœ‹åˆ°å¦‚ä¸‹ä¿¡æ¯ï¼š</p>\n<p>æ­¤æ—¶æœåŠ¡å°±å…¨éƒ¨éƒ½åˆ‡æ¢åˆ°äº† 8092 è¿™ä¸ª seata æœåŠ¡ä¸Šäº†ï¼Œ7091 å°±æ²¡ç”¨äº†ç”šè‡³äºåœæ‰ä¹Ÿæ²¡æœ‰é—®é¢˜</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310182027851.png\" alt=\"image-20231018202705207\"></p>\n",
            "tags": [
                "è®¡ç®—æœºå­¦ç§‘",
                "springcloud",
                "éƒ¨ç½²",
                "Seata"
            ]
        },
        {
            "id": "https://pigpigletsgo.github.io/homepage/2024/04/02/computer-science/java/spring/springcloud/springcloud-%E9%AB%98%E7%BA%A7/OpenResty/%E5%AE%89%E8%A3%85OpenResty/",
            "url": "https://pigpigletsgo.github.io/homepage/2024/04/02/computer-science/java/spring/springcloud/springcloud-%E9%AB%98%E7%BA%A7/OpenResty/%E5%AE%89%E8%A3%85OpenResty/",
            "title": "å®‰è£…OpenResty",
            "date_published": "2024-04-02T06:23:31.021Z",
            "content_html": "<h1 id=\"å®‰è£…openresty\"><a class=\"markdownIt-Anchor\" href=\"#å®‰è£…openresty\">#</a> å®‰è£… OpenResty</h1>\n<h1 id=\"1å®‰è£…\"><a class=\"markdownIt-Anchor\" href=\"#1å®‰è£…\">#</a> 1. å®‰è£…</h1>\n<p>é¦–å…ˆä½ çš„ Linux è™šæ‹Ÿæœºå¿…é¡»è”ç½‘</p>\n<h2 id=\"1å®‰è£…å¼€å‘åº“\"><a class=\"markdownIt-Anchor\" href=\"#1å®‰è£…å¼€å‘åº“\">#</a> <strong>1ï¼‰å®‰è£…å¼€å‘åº“</strong></h2>\n<p>é¦–å…ˆè¦å®‰è£… OpenResty çš„ä¾èµ–å¼€å‘åº“ï¼Œæ‰§è¡Œå‘½ä»¤ï¼š</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>yum <span class=\"token function\">install</span> <span class=\"token parameter variable\">-y</span> pcre-devel openssl-devel gcc --skip-broken</pre></td></tr></table></figure><h2 id=\"2å®‰è£…openrestyä»“åº“\"><a class=\"markdownIt-Anchor\" href=\"#2å®‰è£…openrestyä»“åº“\">#</a> <strong>2ï¼‰å®‰è£… OpenResty ä»“åº“</strong></h2>\n<p>ä½ å¯ä»¥åœ¨ä½ çš„ CentOS ç³»ç»Ÿä¸­æ·»åŠ   <code>openresty</code>  ä»“åº“ï¼Œè¿™æ ·å°±å¯ä»¥ä¾¿äºæœªæ¥å®‰è£…æˆ–æ›´æ–°æˆ‘ä»¬çš„è½¯ä»¶åŒ…ï¼ˆé€šè¿‡  <code>yum check-update</code>  å‘½ä»¤ï¼‰ã€‚è¿è¡Œä¸‹é¢çš„å‘½ä»¤å°±å¯ä»¥æ·»åŠ æˆ‘ä»¬çš„ä»“åº“ï¼š</p>\n<pre><code>yum-config-manager --add-repo https://openresty.org/package/centos/openresty.repo\n</code></pre>\n<p>å¦‚æœæç¤ºè¯´å‘½ä»¤ä¸å­˜åœ¨ï¼Œåˆ™è¿è¡Œï¼š</p>\n<pre><code>yum install -y yum-utils \n</code></pre>\n<p>ç„¶åå†é‡å¤ä¸Šé¢çš„å‘½ä»¤</p>\n<h2 id=\"3å®‰è£…openresty\"><a class=\"markdownIt-Anchor\" href=\"#3å®‰è£…openresty\">#</a> <strong>3ï¼‰å®‰è£… OpenResty</strong></h2>\n<p>ç„¶åå°±å¯ä»¥åƒä¸‹é¢è¿™æ ·å®‰è£…è½¯ä»¶åŒ…ï¼Œæ¯”å¦‚  <code>openresty</code> ï¼š</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>yum <span class=\"token function\">install</span> <span class=\"token parameter variable\">-y</span> openresty</pre></td></tr></table></figure><h2 id=\"4å®‰è£…opmå·¥å…·\"><a class=\"markdownIt-Anchor\" href=\"#4å®‰è£…opmå·¥å…·\">#</a> <strong>4ï¼‰å®‰è£… opm å·¥å…·</strong></h2>\n<p>opm æ˜¯ OpenResty çš„ä¸€ä¸ªç®¡ç†å·¥å…·ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬å®‰è£…ä¸€ä¸ªç¬¬ä¸‰æ–¹çš„ Lua æ¨¡å—ã€‚</p>\n<p>å¦‚æœä½ æƒ³å®‰è£…å‘½ä»¤è¡Œå·¥å…·  <code>opm</code> ï¼Œé‚£ä¹ˆå¯ä»¥åƒä¸‹é¢è¿™æ ·å®‰è£…  <code>openresty-opm</code>  åŒ…ï¼š</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>yum <span class=\"token function\">install</span> <span class=\"token parameter variable\">-y</span> openresty-opm</pre></td></tr></table></figure><h2 id=\"5ç›®å½•ç»“æ„\"><a class=\"markdownIt-Anchor\" href=\"#5ç›®å½•ç»“æ„\">#</a> <strong>5ï¼‰ç›®å½•ç»“æ„</strong></h2>\n<p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒOpenResty å®‰è£…çš„ç›®å½•æ˜¯ï¼š/usr/local/openresty</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310200901485.png\" alt=\"image-20200310225539214\"></p>\n<p>çœ‹åˆ°é‡Œé¢çš„ nginx ç›®å½•äº†å—ï¼ŒOpenResty å°±æ˜¯åœ¨ Nginx åŸºç¡€ä¸Šé›†æˆäº†ä¸€äº› Lua æ¨¡å—ã€‚</p>\n<h2 id=\"6é…ç½®nginxçš„ç¯å¢ƒå˜é‡\"><a class=\"markdownIt-Anchor\" href=\"#6é…ç½®nginxçš„ç¯å¢ƒå˜é‡\">#</a> <strong>6ï¼‰é…ç½® nginx çš„ç¯å¢ƒå˜é‡</strong></h2>\n<p>æ‰“å¼€é…ç½®æ–‡ä»¶ï¼š</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">vi</span> /etc/profile</pre></td></tr></table></figure><p>åœ¨æœ€ä¸‹é¢åŠ å…¥ä¸¤è¡Œï¼š</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">NGINX_HOME</span><span class=\"token operator\">=</span>/usr/local/openresty/nginx</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\"><span class=\"token environment constant\">PATH</span></span><span class=\"token operator\">=</span><span class=\"token variable\">$&#123;NGINX_HOME&#125;</span>/sbin:<span class=\"token environment constant\">$PATH</span></pre></td></tr></table></figure><p>NGINX_HOMEï¼šåé¢æ˜¯ OpenResty å®‰è£…ç›®å½•ä¸‹çš„ nginx çš„ç›®å½•</p>\n<p>ç„¶åè®©é…ç½®ç”Ÿæ•ˆï¼š</p>\n<pre><code>source /etc/profile\n</code></pre>\n<h1 id=\"2å¯åŠ¨å’Œè¿è¡Œ\"><a class=\"markdownIt-Anchor\" href=\"#2å¯åŠ¨å’Œè¿è¡Œ\">#</a> 2. å¯åŠ¨å’Œè¿è¡Œ</h1>\n<p>OpenResty åº•å±‚æ˜¯åŸºäº Nginx çš„ï¼ŒæŸ¥çœ‹ OpenResty ç›®å½•çš„ nginx ç›®å½•ï¼Œç»“æ„ä¸ windows ä¸­å®‰è£…çš„ nginx åŸºæœ¬ä¸€è‡´ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310200901105.png\" alt=\"image-20210811100653291\"></p>\n<p>æ‰€ä»¥è¿è¡Œæ–¹å¼ä¸ nginx åŸºæœ¬ä¸€è‡´ï¼š</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># å¯åŠ¨ nginx</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>nginx</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># é‡æ–°åŠ è½½é…ç½®</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>nginx <span class=\"token parameter variable\">-s</span> reload</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># åœæ­¢</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>nginx <span class=\"token parameter variable\">-s</span> stop</pre></td></tr></table></figure><p>nginx çš„é»˜è®¤é…ç½®æ–‡ä»¶æ³¨é‡Šå¤ªå¤šï¼Œå½±å“åç»­æˆ‘ä»¬çš„ç¼–è¾‘ï¼Œè¿™é‡Œå°† nginx.conf ä¸­çš„æ³¨é‡Šéƒ¨åˆ†åˆ é™¤ï¼Œä¿ç•™æœ‰æ•ˆéƒ¨åˆ†ã€‚</p>\n<p>ä¿®æ”¹ <code>/usr/local/openresty/nginx/conf/nginx.conf</code>  æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight nginx\"><figcaption data-lang=\"nginx\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#user  nobody;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token directive\"><span class=\"token keyword\">worker_processes</span>  <span class=\"token number\">1</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token directive\"><span class=\"token keyword\">error_log</span>  logs/error.log</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token directive\"><span class=\"token keyword\">events</span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token directive\"><span class=\"token keyword\">worker_connections</span>  <span class=\"token number\">1024</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token directive\"><span class=\"token keyword\">http</span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token directive\"><span class=\"token keyword\">include</span>       mime.types</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token directive\"><span class=\"token keyword\">default_type</span>  application/octet-stream</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token directive\"><span class=\"token keyword\">sendfile</span>        <span class=\"token boolean\">on</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token directive\"><span class=\"token keyword\">keepalive_timeout</span>  <span class=\"token number\">65</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token directive\"><span class=\"token keyword\">server</span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token directive\"><span class=\"token keyword\">listen</span>       <span class=\"token number\">8081</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token directive\"><span class=\"token keyword\">server_name</span>  localhost</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token directive\"><span class=\"token keyword\">location</span> /</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            <span class=\"token directive\"><span class=\"token keyword\">root</span>   html</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            <span class=\"token directive\"><span class=\"token keyword\">index</span>  index.html index.htm</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token directive\"><span class=\"token keyword\">error_page</span>   <span class=\"token number\">500</span> <span class=\"token number\">502</span> <span class=\"token number\">503</span> <span class=\"token number\">504</span>  /50x.html</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token directive\"><span class=\"token keyword\">location</span> = /50x.html</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            <span class=\"token directive\"><span class=\"token keyword\">root</span>   html</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>åœ¨ Linux çš„æ§åˆ¶å°è¾“å…¥å‘½ä»¤ä»¥å¯åŠ¨ nginxï¼š</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>nginx</pre></td></tr></table></figure><p>ç„¶åè®¿é—®é¡µé¢ï¼š<a href=\"http://192.168.150.101:8081\">http://192.168.150.101:8081</a>ï¼Œæ³¨æ„ ip åœ°å€æ›¿æ¢ä¸ºä½ è‡ªå·±çš„è™šæ‹Ÿæœº IPï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310200910980.png\" alt=\"image-20231020091008283\"></p>\n<h1 id=\"3å¤‡æ³¨\"><a class=\"markdownIt-Anchor\" href=\"#3å¤‡æ³¨\">#</a> 3. å¤‡æ³¨</h1>\n<p>åŠ è½½ OpenResty çš„ lua æ¨¡å—ï¼š</p>\n<figure class=\"highlight nginx\"><figcaption data-lang=\"nginx\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#lua æ¨¡å—</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token directive\"><span class=\"token keyword\">lua_package_path</span> <span class=\"token string\">\"/usr/local/openresty/lualib/?.lua;;\"</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">#c æ¨¡å—     </span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token directive\"><span class=\"token keyword\">lua_package_cpath</span> <span class=\"token string\">\"/usr/local/openresty/lualib/?.so;;\"</span></span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>ç›‘å¬æµè§ˆå™¨è¯·æ±‚</p>\n<figure class=\"highlight nginx\"><figcaption data-lang=\"nginx\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token directive\"><span class=\"token keyword\">server</span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>        <span class=\"token directive\"><span class=\"token keyword\">listen</span>       <span class=\"token number\">8081</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token directive\"><span class=\"token keyword\">server_name</span>  localhost</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token directive\"><span class=\"token keyword\">location</span> /api/item</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>          <span class=\"token comment\"># é»˜è®¤çš„å“åº”ç±»å‹</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>          <span class=\"token directive\"><span class=\"token keyword\">default_type</span> application/json</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>          <span class=\"token comment\"># å“åº”ç»“æœç”± lua/item.lua ä¸‹çš„æ–‡ä»¶å†³å®š</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>          <span class=\"token directive\"><span class=\"token keyword\">content_by_lua_file</span> lua/item.lua</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token directive\"><span class=\"token keyword\">location</span> /</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token directive\"><span class=\"token keyword\">root</span>   html</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            <span class=\"token directive\"><span class=\"token keyword\">index</span>  index.html index.htm</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token directive\"><span class=\"token keyword\">error_page</span>   <span class=\"token number\">500</span> <span class=\"token number\">502</span> <span class=\"token number\">503</span> <span class=\"token number\">504</span>  /50x.html</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token directive\"><span class=\"token keyword\">location</span> = /50x.html</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            <span class=\"token directive\"><span class=\"token keyword\">root</span>   html</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>common.lua</p>\n<figure class=\"highlight lua\"><figcaption data-lang=\"lua\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- å°è£…å‡½æ•°ï¼Œå‘é€ http è¯·æ±‚ï¼Œå¹¶è§£æå“åº”</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">local</span> <span class=\"token keyword\">function</span> <span class=\"token function\">read_http</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">,</span> params<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">local</span> resp <span class=\"token operator\">=</span> ngx<span class=\"token punctuation\">.</span>location<span class=\"token punctuation\">.</span><span class=\"token function\">capture</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">,</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        method <span class=\"token operator\">=</span> ngx<span class=\"token punctuation\">.</span>HTTP_GET<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        args <span class=\"token operator\">=</span> params<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> resp <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token comment\">-- è®°å½•é”™è¯¯ä¿¡æ¯ï¼Œè¿”å› 404</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        ngx<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>ngx<span class=\"token punctuation\">.</span>ERR<span class=\"token punctuation\">,</span> <span class=\"token string\">\"http not found, path: \"</span><span class=\"token punctuation\">,</span> path <span class=\"token punctuation\">,</span> <span class=\"token string\">\", args: \"</span><span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        ngx<span class=\"token punctuation\">.</span><span class=\"token function\">exit</span><span class=\"token punctuation\">(</span><span class=\"token number\">404</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">return</span> resp<span class=\"token punctuation\">.</span>body</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">-- å°†æ–¹æ³•å¯¼å‡º</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">local</span> _M <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    read_http <span class=\"token operator\">=</span> read_http</pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span>  </pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token keyword\">return</span> _M</pre></td></tr></table></figure><p>é‡Šæ”¾ Redis è¿æ¥ APIï¼š</p>\n<figure class=\"highlight lua\"><figcaption data-lang=\"lua\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- å…³é—­ redis è¿æ¥çš„å·¥å…·æ–¹æ³•ï¼Œå…¶å®æ˜¯æ”¾å…¥è¿æ¥æ± </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">local</span> <span class=\"token keyword\">function</span> <span class=\"token function\">close_redis</span><span class=\"token punctuation\">(</span>red<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">local</span> pool_max_idle_time <span class=\"token operator\">=</span> <span class=\"token number\">10000</span> <span class=\"token comment\">-- è¿æ¥çš„ç©ºé—²æ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">local</span> pool_size <span class=\"token operator\">=</span> <span class=\"token number\">100</span> <span class=\"token comment\">-- è¿æ¥æ± å¤§å°</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">local</span> ok<span class=\"token punctuation\">,</span> err <span class=\"token operator\">=</span> red<span class=\"token punctuation\">:</span><span class=\"token function\">set_keepalive</span><span class=\"token punctuation\">(</span>pool_max_idle_time<span class=\"token punctuation\">,</span> pool_size<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> ok <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        ngx<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>ngx<span class=\"token punctuation\">.</span>ERR<span class=\"token punctuation\">,</span> <span class=\"token string\">\"æ”¾å…¥redisè¿æ¥æ± å¤±è´¥: \"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">end</span></pre></td></tr></table></figure><p>è¯»å– Redis æ•°æ®çš„ APIï¼š</p>\n<figure class=\"highlight lua\"><figcaption data-lang=\"lua\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- æŸ¥è¯¢ redis çš„æ–¹æ³• ip å’Œ port æ˜¯ redis åœ°å€ï¼Œkey æ˜¯æŸ¥è¯¢çš„ key</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">local</span> <span class=\"token keyword\">function</span> <span class=\"token function\">read_redis</span><span class=\"token punctuation\">(</span>ip<span class=\"token punctuation\">,</span> port<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token comment\">-- è·å–ä¸€ä¸ªè¿æ¥</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">local</span> ok<span class=\"token punctuation\">,</span> err <span class=\"token operator\">=</span> red<span class=\"token punctuation\">:</span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>ip<span class=\"token punctuation\">,</span> port<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> ok <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        ngx<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>ngx<span class=\"token punctuation\">.</span>ERR<span class=\"token punctuation\">,</span> <span class=\"token string\">\"è¿æ¥rediså¤±è´¥ : \"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token keyword\">nil</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token comment\">-- æŸ¥è¯¢ redis</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">local</span> resp<span class=\"token punctuation\">,</span> err <span class=\"token operator\">=</span> red<span class=\"token punctuation\">:</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token comment\">-- æŸ¥è¯¢å¤±è´¥å¤„ç†</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> resp <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        ngx<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>ngx<span class=\"token punctuation\">.</span>ERR<span class=\"token punctuation\">,</span> <span class=\"token string\">\"æŸ¥è¯¢Rediså¤±è´¥: \"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">,</span> <span class=\"token string\">\", key = \"</span> <span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token comment\">-- å¾—åˆ°çš„æ•°æ®ä¸ºç©ºå¤„ç†</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">if</span> resp <span class=\"token operator\">==</span> ngx<span class=\"token punctuation\">.</span>null <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        resp <span class=\"token operator\">=</span> <span class=\"token keyword\">nil</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        ngx<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>ngx<span class=\"token punctuation\">.</span>ERR<span class=\"token punctuation\">,</span> <span class=\"token string\">\"æŸ¥è¯¢Redisæ•°æ®ä¸ºç©º, key = \"</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token function\">close_redis</span><span class=\"token punctuation\">(</span>red<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">return</span> resp</pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token keyword\">end</span></pre></td></tr></table></figure><p>å¼€å¯å…±äº«è¯å…¸ï¼š</p>\n<figure class=\"highlight nginx\"><figcaption data-lang=\"nginx\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># å…±äº«å­—å…¸ï¼Œä¹Ÿå°±æ˜¯æœ¬åœ°ç¼“å­˜ï¼Œåç§°å«åšï¼šitem_cacheï¼Œå¤§å° 150m</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token directive\"><span class=\"token keyword\">lua_shared_dict</span> item_cache <span class=\"token number\">150m</span></span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure>",
            "tags": [
                "è®¡ç®—æœºå­¦ç§‘",
                "springcloud",
                "OpenResty"
            ]
        },
        {
            "id": "https://pigpigletsgo.github.io/homepage/2024/04/02/computer-science/java/spring/springcloud/springcloud-%E9%AB%98%E7%BA%A7/canal/%E5%AE%89%E8%A3%85Canal/",
            "url": "https://pigpigletsgo.github.io/homepage/2024/04/02/computer-science/java/spring/springcloud/springcloud-%E9%AB%98%E7%BA%A7/canal/%E5%AE%89%E8%A3%85Canal/",
            "title": "å®‰è£…å’Œé…ç½®Canal",
            "date_published": "2024-04-02T06:23:31.010Z",
            "content_html": "<h1 id=\"å®‰è£…å’Œé…ç½®canal\"><a class=\"markdownIt-Anchor\" href=\"#å®‰è£…å’Œé…ç½®canal\">#</a> å®‰è£…å’Œé…ç½® Canal</h1>\n<p>ä¸‹é¢æˆ‘ä»¬å°±å¼€å¯ mysql çš„ä¸»ä»åŒæ­¥æœºåˆ¶ï¼Œè®© Canal æ¥æ¨¡æ‹Ÿ salve</p>\n<h1 id=\"1å¼€å¯mysqlä¸»ä»\"><a class=\"markdownIt-Anchor\" href=\"#1å¼€å¯mysqlä¸»ä»\">#</a> 1. å¼€å¯ MySQL ä¸»ä»</h1>\n<p>Canal æ˜¯åŸºäº MySQL çš„ä¸»ä»åŒæ­¥åŠŸèƒ½ï¼Œå› æ­¤å¿…é¡»å…ˆå¼€å¯ MySQL çš„ä¸»ä»åŠŸèƒ½æ‰å¯ä»¥ã€‚</p>\n<p>è¿™é‡Œä»¥ä¹‹å‰ç”¨ Docker è¿è¡Œçš„ mysql ä¸ºä¾‹ï¼š</p>\n<h2 id=\"11å¼€å¯binlog\"><a class=\"markdownIt-Anchor\" href=\"#11å¼€å¯binlog\">#</a> 1.1. å¼€å¯ binlog</h2>\n<p>æ‰“å¼€ mysql å®¹å™¨æŒ‚è½½çš„æ—¥å¿—æ–‡ä»¶ï¼Œæˆ‘çš„åœ¨ <code>/tmp/mysql/conf</code>  ç›®å½•:</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310210931806.png\" alt=\"image-20210813153241537\"></p>\n<p>ä¿®æ”¹æ–‡ä»¶ï¼š</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">vi</span> /tmp/mysql/conf/my.cnf</pre></td></tr></table></figure><p>æ·»åŠ å†…å®¹ï¼š</p>\n<figure class=\"highlight ini\"><figcaption data-lang=\"ini\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key attr-name\">log-bin</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">/var/lib/mysql/mysql-bin</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># æ•°æ®åº“åç§°</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key attr-name\">binlog-do-db</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">dkx</span></pre></td></tr></table></figure><p>é…ç½®è§£è¯»ï¼š</p>\n<ul>\n<li><code>log-bin=/var/lib/mysql/mysql-bin</code> ï¼šè®¾ç½® binary log æ–‡ä»¶çš„å­˜æ”¾åœ°å€å’Œæ–‡ä»¶åï¼Œå«åš mysql-bin</li>\n<li><code>binlog-do-db=dkx</code> ï¼šæŒ‡å®šå¯¹å“ªä¸ª database è®°å½• binary log eventsï¼Œè¿™é‡Œè®°å½• heima è¿™ä¸ªåº“</li>\n</ul>\n<p>æœ€ç»ˆæ•ˆæœï¼š</p>\n<figure class=\"highlight ini\"><figcaption data-lang=\"ini\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token section\"><span class=\"token punctuation\">[</span><span class=\"token section-name selector\">mysqld</span><span class=\"token punctuation\">]</span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>skip-name-resolve</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key attr-name\">character_set_server</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">utf8</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token key attr-name\">datadir</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">/var/lib/mysql</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token key attr-name\">server-id</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">1000</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key attr-name\">log-bin</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">/var/lib/mysql/mysql-bin</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token key attr-name\">binlog-do-db</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">dkx</span></pre></td></tr></table></figure><p>é‡å¯ mysql</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">docker</span> restart mysql</pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å¦‚ä¸‹å›¾ä¸­å‡ºç°äº†æŒ‡å®šæ–‡ä»¶è¡¨ç¤ºæˆåŠŸï¼</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310211007103.png\" alt=\"image-20231021100731994\"></p>\n<h2 id=\"12è®¾ç½®ç”¨æˆ·æƒé™\"><a class=\"markdownIt-Anchor\" href=\"#12è®¾ç½®ç”¨æˆ·æƒé™\">#</a> 1.2. è®¾ç½®ç”¨æˆ·æƒé™</h2>\n<p>æ¥ä¸‹æ¥æ·»åŠ ä¸€ä¸ªä»…ç”¨äºæ•°æ®åŒæ­¥çš„è´¦æˆ·ï¼Œå‡ºäºå®‰å…¨è€ƒè™‘ï¼Œè¿™é‡Œä»…æä¾›å¯¹ heima è¿™ä¸ªåº“çš„æ“ä½œæƒé™ã€‚</p>\n<pre><code class=\"language-mysql\">create user canal@'%' IDENTIFIED by 'canal';\nGRANT SELECT, REPLICATION SLAVE, REPLICATION CLIENT,SUPER ON *.* TO 'canal'@'%' identified by 'canal';\nFLUSH PRIVILEGES;\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">USER</span> canal IDENTIFIED <span class=\"token keyword\">BY</span> <span class=\"token string\">'canal'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">GRANT</span> <span class=\"token keyword\">SELECT</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">REPLICATION</span> SLAVE<span class=\"token punctuation\">,</span> <span class=\"token keyword\">REPLICATION</span> CLIENT <span class=\"token keyword\">ON</span> <span class=\"token punctuation\">.</span> <span class=\"token keyword\">TO</span> <span class=\"token string\">'canal'</span><span class=\"token variable\">@'%'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">GRANT</span> <span class=\"token keyword\">ALL</span> <span class=\"token keyword\">PRIVILEGES</span> <span class=\"token keyword\">ON</span> <span class=\"token punctuation\">.</span> <span class=\"token keyword\">TO</span> <span class=\"token string\">'canal'</span><span class=\"token variable\">@'%'</span> <span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>FLUSH <span class=\"token keyword\">PRIVILEGES</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>mysql 8.0.2 å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">USER</span> canal IDENTIFIED <span class=\"token keyword\">BY</span> <span class=\"token string\">'canal'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">GRANT</span> <span class=\"token keyword\">SELECT</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">SHOW</span> <span class=\"token keyword\">VIEW</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">REPLICATION</span> SLAVE<span class=\"token punctuation\">,</span> <span class=\"token keyword\">REPLICATION</span> CLIENT <span class=\"token keyword\">ON</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">.</span><span class=\"token operator\">*</span> <span class=\"token keyword\">TO</span> <span class=\"token string\">'canal'</span><span class=\"token variable\">@'%'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>FLUSH <span class=\"token keyword\">PRIVILEGES</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>é‡å¯ mysql å®¹å™¨å³å¯</p>\n<pre><code>docker restart mysql\n</code></pre>\n<p>æµ‹è¯•è®¾ç½®æ˜¯å¦æˆåŠŸï¼šåœ¨ mysql æ§åˆ¶å°ï¼Œæˆ–è€… Navicat ä¸­ï¼Œè¾“å…¥å‘½ä»¤ï¼š</p>\n<pre><code>show master status;\n</code></pre>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310211015054.png\" alt=\"image-20231021101552134\"></p>\n<h1 id=\"2å®‰è£…canal\"><a class=\"markdownIt-Anchor\" href=\"#2å®‰è£…canal\">#</a> 2. å®‰è£… Canal</h1>\n<h2 id=\"21åˆ›å»ºç½‘ç»œ\"><a class=\"markdownIt-Anchor\" href=\"#21åˆ›å»ºç½‘ç»œ\">#</a> 2.1. åˆ›å»ºç½‘ç»œ</h2>\n<p>æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªç½‘ç»œï¼Œå°† MySQLã€Canalã€MQ æ”¾åˆ°åŒä¸€ä¸ª Docker ç½‘ç»œä¸­ï¼š</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">docker</span> network create dkx</pre></td></tr></table></figure><p>è®© mysql åŠ å…¥è¿™ä¸ªç½‘ç»œï¼š</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">docker</span> network connect dkx mysql</pre></td></tr></table></figure><h2 id=\"23å®‰è£…canal\"><a class=\"markdownIt-Anchor\" href=\"#23å®‰è£…canal\">#</a> 2.3. å®‰è£… Canal</h2>\n<p>è¯¾å‰èµ„æ–™ä¸­æä¾›äº† canal çš„é•œåƒå‹ç¼©åŒ…:</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310211145229.png\" alt=\"image-20210813161804292\"></p>\n<p>å¤§å®¶å¯ä»¥ä¸Šä¼ åˆ°è™šæ‹Ÿæœºï¼Œç„¶åé€šè¿‡å‘½ä»¤å¯¼å…¥ï¼š</p>\n<pre><code>docker load -i canal.tar\n</code></pre>\n<p>ç„¶åè¿è¡Œå‘½ä»¤åˆ›å»º Canal å®¹å™¨ï¼š</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-p</span> <span class=\"token number\">11111</span>:11111 <span class=\"token parameter variable\">--name</span> canal <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">canal.destinations</span><span class=\"token operator\">=</span>dkx1 <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">canal.instance.master.address</span><span class=\"token operator\">=</span><span class=\"token number\">192.168</span>.249.128:3306  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">canal.instance.dbUsername</span><span class=\"token operator\">=</span>canal  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">canal.instance.dbPassword</span><span class=\"token operator\">=</span>canal  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">canal.instance.connectionCharset</span><span class=\"token operator\">=</span>UTF-8 <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">canal.instance.tsdb.enable</span><span class=\"token operator\">=</span>true <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">canal.instance.gtidon</span><span class=\"token operator\">=</span>false  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">canal.instance.filter.regex</span><span class=\"token operator\">=</span>dkx<span class=\"token punctuation\">\\</span><span class=\"token punctuation\">\\</span><span class=\"token punctuation\">..</span>* <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token parameter variable\">--network</span> dkx1 <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token parameter variable\">-d</span> canal/canal-server:v1.1.5</pre></td></tr></table></figure><p>è¯´æ˜:</p>\n<ul>\n<li><code>-p 11111:11111</code> ï¼šè¿™æ˜¯ canal çš„é»˜è®¤ç›‘å¬ç«¯å£</li>\n<li><code>-e canal.instance.master.address=mysql:3306</code> ï¼šæ•°æ®åº“åœ°å€ (åŒä¸€ç½‘ç»œå¯ä»¥ä½¿ç”¨å®¹å™¨åäº’è”) å’Œç«¯å£ï¼Œå¦‚æœä¸çŸ¥é“ mysql å®¹å™¨åœ°å€ï¼Œå¯ä»¥é€šè¿‡ <code>docker inspect å®¹å™¨id</code>  æ¥æŸ¥çœ‹</li>\n<li><code>-e canal.instance.dbUsername=canal</code> ï¼šæ•°æ®åº“ç”¨æˆ·å</li>\n<li><code>-e canal.instance.dbPassword=canal</code>  ï¼šæ•°æ®åº“å¯†ç </li>\n<li><code>-e canal.instance.filter.regex=</code> ï¼šè¦ç›‘å¬çš„è¡¨åç§°</li>\n</ul>\n<p>è¡¨åç§°ç›‘å¬æ”¯æŒçš„è¯­æ³•ï¼š</p>\n<pre><code>mysql æ•°æ®è§£æå…³æ³¨çš„è¡¨ï¼ŒPerlæ­£åˆ™è¡¨è¾¾å¼.\nå¤šä¸ªæ­£åˆ™ä¹‹é—´ä»¥é€—å·(,)åˆ†éš”ï¼Œè½¬ä¹‰ç¬¦éœ€è¦åŒæ–œæ (\\\\) \nå¸¸è§ä¾‹å­ï¼š\n1.  æ‰€æœ‰è¡¨ï¼š.*   or  .*\\\\..*\n2.  canal schemaä¸‹æ‰€æœ‰è¡¨ï¼š canal\\\\..*\n3.  canalä¸‹çš„ä»¥canalæ‰“å¤´çš„è¡¨ï¼šcanal\\\\.canal.*\n4.  canal schemaä¸‹çš„ä¸€å¼ è¡¨ï¼šcanal.test1\n5.  å¤šä¸ªè§„åˆ™ç»„åˆä½¿ç”¨ç„¶åä»¥é€—å·éš”å¼€ï¼šcanal\\\\..*,mysql.test1,mysql.test2 \n</code></pre>\n<p>æŸ¥çœ‹å¯åŠ¨æ—¥å¿—ï¼ŒæŸ¥çœ‹æ˜¯å¦å¯åŠ¨æˆåŠŸäº†ï¼š</p>\n<pre><code class=\"language-shÂ·\">[root@localhost tmp]# docker logs -f canal\nDOCKER_DEPLOY_TYPE=VM\n==&gt; INIT /alidata/init/02init-sshd.sh\n==&gt; EXIT CODE: 0\n==&gt; INIT /alidata/init/fix-hosts.py\n==&gt; EXIT CODE: 0\n==&gt; INIT DEFAULT\nGenerating SSH1 RSA host key: [  OK  ]\nStarting sshd: [  OK  ]\nStarting crond: [  OK  ]\n==&gt; INIT DONE\n==&gt; RUN /home/admin/app.sh\n==&gt; START ...\nstart canal ...\nstart canal successful\n==&gt; START SUCCESSFUL ...\n</code></pre>\n<p>æŸ¥çœ‹ canal æ˜¯å¦ä¸ mysql è¿›è¡Œå»ºç«‹è¿æ¥äº†</p>\n<p>æ­¥éª¤ï¼š</p>\n<p>1ã€è¿›å…¥ canal å†…éƒ¨</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@localhost tmp<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker exec -it canal bash</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@a02803287608 admin<span class=\"token punctuation\">]</span><span class=\"token comment\">#</span></pre></td></tr></table></figure><p>2ã€ä½¿ç”¨å‘½ä»¤ç›‘æ§ canal çš„æ—¥å¿—ä¿¡æ¯</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@a02803287608 admin<span class=\"token punctuation\">]</span><span class=\"token comment\"># ll</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>total <span class=\"token number\">8</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>-rwxr-xr-x. <span class=\"token number\">1</span> admin admin <span class=\"token number\">3941</span> Apr <span class=\"token number\">19</span>  <span class=\"token number\">2021</span> app.sh</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>drwxr-xr-x. <span class=\"token number\">2</span> admin admin   <span class=\"token number\">43</span> Apr <span class=\"token number\">19</span>  <span class=\"token number\">2021</span> bin</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>drwxr-xr-x. <span class=\"token number\">1</span> admin admin   <span class=\"token number\">66</span> Apr <span class=\"token number\">19</span>  <span class=\"token number\">2021</span> canal-server</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>-rwxr-xr-x. <span class=\"token number\">1</span> admin admin  <span class=\"token number\">670</span> Apr <span class=\"token number\">19</span>  <span class=\"token number\">2021</span> health.sh</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>lrwxrwxrwx. <span class=\"token number\">1</span> admin admin   <span class=\"token number\">44</span> Apr <span class=\"token number\">19</span>  <span class=\"token number\">2021</span> node_exporter -<span class=\"token operator\">></span> /home/admin/node_exporter-0.18.1.linux-arm64</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>drwxr-xr-x. <span class=\"token number\">2</span> admin admin   <span class=\"token number\">56</span> Jun  <span class=\"token number\">5</span>  <span class=\"token number\">2019</span> node_exporter-0.18.1.linux-arm64</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>root@a02803287608 admin<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -f canal-server/logs/canal/canal.log</span></pre></td></tr></table></figure><p>æ‰“å°æ—¥å¿—å¦‚ä¸‹</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">2023</span>-10-21 <span class=\"token number\">10</span>:31:37.324 <span class=\"token punctuation\">[</span>main<span class=\"token punctuation\">]</span> INFO  com.alibaba.otter.canal.deployer.CanalLauncher - <span class=\"token comment\">## set default uncaught exception handler</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">2023</span>-10-21 <span class=\"token number\">10</span>:31:37.376 <span class=\"token punctuation\">[</span>main<span class=\"token punctuation\">]</span> INFO  com.alibaba.otter.canal.deployer.CanalLauncher - <span class=\"token comment\">## load canal configurations</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">2023</span>-10-21 <span class=\"token number\">10</span>:31:37.392 <span class=\"token punctuation\">[</span>main<span class=\"token punctuation\">]</span> INFO  com.alibaba.otter.canal.deployer.CanalStarter - <span class=\"token comment\">## start the canal server.</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">2023</span>-10-21 <span class=\"token number\">10</span>:31:37.466 <span class=\"token punctuation\">[</span>main<span class=\"token punctuation\">]</span> INFO  com.alibaba.otter.canal.deployer.CanalController - <span class=\"token comment\">## start the canal server[172.22.0.3(172.22.0.3):11111]</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">2023</span>-10-21 <span class=\"token number\">10</span>:31:39.126 <span class=\"token punctuation\">[</span>main<span class=\"token punctuation\">]</span> INFO  com.alibaba.otter.canal.deployer.CanalStarter - <span class=\"token comment\">## the canal server is running now ......</span></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å¯åŠ¨æ²¡ä»€ä¹ˆé—®é¢˜</p>\n<p>æŸ¥çœ‹ mysql è¿æ¥çš„æ—¥å¿—</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@a02803287608 admin<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -f canal-server/logs/dkx1/dkx1.log</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">find</span> start position successfully, EntryPosition<span class=\"token punctuation\">[</span>included<span class=\"token operator\">=</span>false,journalName<span class=\"token operator\">=</span>mysql-bin.000006,position<span class=\"token operator\">=</span><span class=\"token number\">4</span>,serverId<span class=\"token operator\">=</span><span class=\"token number\">1000</span>,gtid<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>null<span class=\"token operator\">></span>,timestamp<span class=\"token operator\">=</span><span class=\"token number\">1697857809000</span><span class=\"token punctuation\">]</span> cost <span class=\"token builtin class-name\">:</span> 521ms , the next step is binlog dump</pre></td></tr></table></figure>",
            "tags": [
                "è®¡ç®—æœºå­¦ç§‘",
                "åŸºç¡€",
                "springcloud",
                "Canal"
            ]
        },
        {
            "id": "https://pigpigletsgo.github.io/homepage/2024/04/02/computer-science/java/spring/springcloud/springcloud-%E9%AB%98%E7%BA%A7/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%AB%98%E7%BA%A7%E7%AF%87/",
            "url": "https://pigpigletsgo.github.io/homepage/2024/04/02/computer-science/java/spring/springcloud/springcloud-%E9%AB%98%E7%BA%A7/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%AB%98%E7%BA%A7%E7%AF%87/",
            "title": "SpringCloudé«˜çº§ç¯‡",
            "date_published": "2024-04-02T06:23:31.000Z",
            "content_html": "<h1 id=\"ä¸€-å¾®æœåŠ¡ä¿æŠ¤\"><a class=\"markdownIt-Anchor\" href=\"#ä¸€-å¾®æœåŠ¡ä¿æŠ¤\">#</a> ä¸€ã€å¾®æœåŠ¡ä¿æŠ¤ğŸ„</h1>\n<ul>\n<li>Sentinel</li>\n</ul>\n<p>å­¦ä¹ å†…å®¹ï¼š</p>\n<ul>\n<li>åˆå§‹ Sentinel</li>\n<li>æµé‡æ§åˆ¶</li>\n<li>éš”ç¦»å’Œé™çº§</li>\n<li>æˆæƒè§„åˆ™</li>\n<li>è§„åˆ™æŒä¹…åŒ–</li>\n</ul>\n<h2 id=\"11-åˆå§‹sentinel\"><a class=\"markdownIt-Anchor\" href=\"#11-åˆå§‹sentinel\">#</a> 1.1ã€åˆå§‹ SentinelğŸŒ³</h2>\n<ul>\n<li>é›ªå´©é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ</li>\n<li>æœåŠ¡ä¿æŠ¤æŠ€æœ¯å¯¹æ¯”</li>\n<li>Sentinel ä»‹ç»å’Œå®‰è£…</li>\n<li>å¾®æœåŠ¡æ•´åˆ Sentinel</li>\n</ul>\n<h3 id=\"111-é›ªå´©é—®é¢˜\"><a class=\"markdownIt-Anchor\" href=\"#111-é›ªå´©é—®é¢˜\">#</a> 1.1.1ã€é›ªå´©é—®é¢˜ğŸŒ²</h3>\n<p>å¾®æœåŠ¡è°ƒç”¨é“¾è·¯ä¸­çš„æŸä¸ªæœåŠ¡æ•…éšœï¼Œå¼•èµ·æ•´ä¸ªé“¾è·¯ä¸­çš„æ‰€æœ‰å¾®æœåŠ¡éƒ½ä¸å¯ç”¨ï¼Œè¿™å°±æ˜¯é›ªå´©ã€‚</p>\n<p><strong>åœºæ™¯</strong>ï¼š</p>\n<p>æ¯”æ–¹è¯´åœ¨æœåŠ¡ A å†…éƒ¨ä¾èµ–äºæœåŠ¡ Bï¼Œè€ŒæœåŠ¡ A å†…éƒ¨å¯èƒ½è¿˜æœ‰ä¸€äº›å…¶å®ƒçš„ä¸šåŠ¡æ¯”å¦‚è¯´å®ƒä¾èµ–äºæœåŠ¡ C æˆ–è€…æ˜¯ä¾èµ–äºæœåŠ¡ D</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310161531964.png\" alt=\"image-20231016153100257\"></p>\n<p>ç°åœ¨å‡è®¾è¯´æœåŠ¡ D å‡ºç°äº†æ•…éšœï¼Œé‚£æœåŠ¡ A å†…éƒ¨ä¾èµ–ä¸æœåŠ¡ D çš„ä¸šåŠ¡è¯·æ±‚å°±ä¸èƒ½æ­£å¸¸è®¿é—®äº†</p>\n<p>å› ä¸ºæœåŠ¡ A è®¿é—®æœåŠ¡ D å°±å¿…ç„¶è¦ç­‰å¾…æœåŠ¡ D çš„å“åº”ç»“æœï¼Œè€Œå› ä¸ºæœåŠ¡ D å‡ºç°äº†æ•…éšœä¸å¯èƒ½è¿”å›ç»“æœå®ƒä¼šé˜»å¡ï¼Œé‚£å°±å¯¼è‡´äº†æœåŠ¡ A å†…éƒ¨ä¸šåŠ¡ä¹Ÿä¼šé˜»å¡ï¼Œé˜»å¡ å®ƒå°±ä¸ä¼šé‡Šæ”¾ tomcat çš„é“¾æ¥ã€‚å½“ç„¶å…¶å®ƒä¸šåŠ¡è¯·æ±‚ä¸å—å½±å“è¿˜å¯ä»¥æ­£å¸¸å·¥ä½œã€‚</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310161532119.png\" alt=\"image-20231016153207881\"></p>\n<p>ä½†æ˜¯æ—¢ç„¶æœ‰ç¬¬ä¸€ä¸ªä¾èµ–äºæœåŠ¡ D è¿™æ ·çš„è¯·æ±‚ï¼Œé‚£ä¸€å®šè¿˜ä¼šæœ‰ç¬¬äºŒä¸ªç”šè‡³ç¬¬ä¸‰ä¸ªã€‚è¿™æ ·ä¾èµ–äºæœåŠ¡ D çš„ä¸šåŠ¡è¯·æ±‚è¶Šæ¥è¶Šå¤šï¼Œè€Œå®ƒä»¬éƒ½ä¸ä¼šé‡Šæ”¾è¿æ¥ï¼Œé‚£ä¹ˆæ—¶ä¹…ä¸€å®šä¼šæŠŠæœåŠ¡ A å†…éƒ¨æ‰€æœ‰çš„é“¾æ¥éƒ½ç»™å ç”¨äº†</p>\n<p>ä¹Ÿå°±æ˜¯è¯´ tomcat èµ„æºè€—å°½äº†</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310161537530.png\" alt=\"image-20231016153714784\"></p>\n<p>æ­¤æ—¶å†æœ‰æœåŠ¡è¿›æ¥å“ªæ€•ä¸æ˜¯ä¾èµ–äºæœåŠ¡ D çš„è€Œæ˜¯æœåŠ¡ B çš„ï¼Œæ˜¯ä¸æ˜¯ä¹Ÿè¿›ä¸æ¥äº†ã€‚é‚£å°±å¯ä»¥è®¤ä¸ºæœåŠ¡ A ä¹Ÿå‡ºç°äº†æ•…éšœ</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310161539417.png\" alt=\"image-20231016153923278\"></p>\n<p>è¿™å°±é€ æˆäº†ä¸€ä¸ªæœåŠ¡çš„æ•…éšœå¯¼è‡´äº†ä¾èµ–äºå®ƒçš„æœåŠ¡æœ€ç»ˆä¹Ÿå‡ºç°äº†æ•…éšœã€‚åœ¨å¾®æœåŠ¡é‡Œè¿™ç§è°ƒç”¨å…³ç³»å¯ä¸æ­¢è¿™ä¹ˆç®€å•</p>\n<p>é‚£ä¹ˆæœåŠ¡ A ä¾èµ–äºæœåŠ¡ D å¯¼è‡´æœ€åç»™æœåŠ¡ D æ‹–å®äº†ï¼Œé‚£è‚¯å®šè¿˜ä¼šæœ‰å…¶å®ƒçš„æœåŠ¡ä¹Ÿä¾èµ–äºæœåŠ¡ Dï¼Œæœ€ç»ˆä¹Ÿä¼šè¢«æ‹–å®ï¼Œå°†æ¥å…¶å®ƒä¾èµ–äºæœåŠ¡ A çš„ä¹Ÿä¼šå‡ºç°æ•…éšœï¼Œæœ€ç»ˆæ•…éšœçš„æœåŠ¡è¶Šæ¥è¶Šå¤šé‚£ä¹ˆæ•´ä¸ªå¾®æœåŠ¡ç¾¤å°±ä¸å¯ç”¨äº†ã€‚</p>\n<p>è¿™ä¸å°±æ˜¯é›ªå´©äº†å—ï¼</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310161541181.png\" alt=\"image-20231016154142767\"></p>\n<h3 id=\"112-è§£å†³é›ªå´©é—®é¢˜\"><a class=\"markdownIt-Anchor\" href=\"#112-è§£å†³é›ªå´©é—®é¢˜\">#</a> 1.1.2ã€è§£å†³é›ªå´©é—®é¢˜ğŸŒ²</h3>\n<p><strong>è§£å†³é›ªå´©é—®é¢˜çš„å¸¸è§æ–¹å¼æœ‰å››ç§</strong>ï¼š</p>\n<p>1ã€<mark>è¶…æ—¶å¤„ç†</mark>ï¼šè®¾å®šè¶…æ—¶æ—¶é—´ï¼Œè¯·æ±‚è¶…è¿‡ä¸€å®šæ—¶é—´æ²¡æœ‰å“åº”ç»“æœå°±è¿”å›é”™è¯¯ä¿¡æ¯ï¼Œä¸ä¼šæ— ä¼‘æ­¢ç­‰å¾…</p>\n<p>ä¼šåœ¨è°ƒç”¨ä¸šåŠ¡æ—¶åŠ ä¸Šä¸€ä¸ªè¶…æ—¶æ—¶é—´æ¯”å¦‚è¯´ 1 ç§’é’Ÿï¼Œå½“æœåŠ¡ A ä¾èµ–äºæœåŠ¡ C æ—¶è¯·æ±‚æœ€å¤šç­‰å¾… 1 ç§’é’Ÿï¼Œå¦‚æœè¯·æ±‚è¶…è¿‡ 1 ç§’é’Ÿå°±ä¼šç«‹å³ç»“æŸè¿™ä¸ªè¯·æ±‚ï¼Œä¸å†ç­‰å¾…ï¼Œè¿”å›ç»™ç”¨æˆ·æç¤ºä¿¡æ¯ (ä¸å¥½æ„æ€å¤±è´¥äº†)</p>\n<p>ç¼ºç‚¹ï¼šåªèƒ½èµ·åˆ°ç¼“è§£ä½œç”¨ï¼Œä¸èƒ½è§£å†³æ ¹æœ¬é—®é¢˜ï¼Œå› ä¸ºè¯·æ±‚é€Ÿåº¦å¤§äºç­‰å¾…æ—¶é—´å°±ä¼šå‡ºç°é—®é¢˜</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310161546216.png\" alt=\"image-20231016154632246\"></p>\n<p>2ã€<mark>èˆ±å£æ¨¡å¼</mark>ï¼šé™å®šæ¯ä¸ªä¸šåŠ¡èƒ½ä½¿ç”¨çš„çº¿ç¨‹æ•°ï¼Œé¿å…è€—å°½æ•´ä¸ª tomcat çš„èµ„æºï¼Œå› æ­¤ä¹Ÿå«çº¿ç¨‹éš”ç¦»ã€‚</p>\n<p>èˆ±å£æ¨¡å¼æ˜¯æ¥è‡ªäºç°å®ç”Ÿæ´»ä¸­çš„èˆ¹èˆ±çš„è®¾è®¡ï¼Œä¸€äº›å¤§å‹çš„è½®èˆ¹å®ƒéƒ½ä¼šæŠŠèˆ¹ä½“åˆ©ç”¨éš”æ¿åˆ†éš”æˆç‹¬ç«‹çš„å°çš„ç©ºé—´è¿™æ ·çš„éš”æ¿å°±å«åšèˆ±å£ã€‚å› ä¸ºè¿™äº›ç©ºé—´ä¹‹é—´æ˜¯ç›¸äº’éš”ç¦»çš„ï¼Œå‡è®¾è¯´èˆ¹ä½“çš„æŸä¸ªéƒ¨ä½æ’ä¸Šäº†å†°å±±æ¼æ°´äº†ã€‚é‚£ä¹ˆæœ€å¤šåªæ˜¯æŠŠéƒ¨åˆ†èˆ¹èˆ±å¡«æ»¡æ°´ï¼Œå› ä¸ºæ˜¯éš”ç¦»çš„æ‰€ä»¥å…¶å®ƒèˆ¹èˆ±ä¸å—å½±å“ã€‚è¿™æ ·å°±æé«˜äº†æ•´è‰˜èˆ¹çš„å®¹ç¾èƒ½åŠ›</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310161550959.png\" alt=\"image-20231016155024959\"></p>\n<p>è¿™ç§æ¨¡å¼å»¶ç»­åˆ°ç¨‹åºè®¾è®¡é‡Œè¾¹æ˜¯æ€ä¹ˆåšçš„å‘¢ï¼Ÿ</p>\n<p>è¿™æ˜¯æœåŠ¡ A é‡Œé¢çš„èµ„æºä¹Ÿå°±æ˜¯ tomcat å°±å¯ä»¥çœ‹åšæˆæ•´è‰˜èˆ¹ã€‚æˆ‘ä»¬å¯ä»¥æŠŠ tomcat é‡Œé¢çš„èµ„æº (çº¿ç¨‹) åˆ’åˆ†æˆä¸€ä¸ªä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹æ± ã€‚ç»™æ¯ä¸ªä¸šåŠ¡åˆ†é…ä¸€ä¸ªçº¿ç¨‹æ± ã€‚ç°åœ¨ä¸šåŠ¡ 1 è¿›æ¥åå®ƒä¾èµ–äºæœåŠ¡ Bï¼Œå®ƒæœ€å¤šä½¿ç”¨åä¸ªé™åˆ¶ï¼Œè®¿é—®ä¸šåŠ¡ 2 æ¯”æ–¹è¯´å®ƒä¾èµ–äºæœåŠ¡ Cï¼Œå®ƒä¹Ÿæœ€å¤šä½¿ç”¨åçº¿ç¨‹ã€‚</p>\n<p>ç°åœ¨å‡è®¾è¯´æœåŠ¡ C å‡ºç°æ•…éšœäº†ï¼Œè¿™ä¸ªä¸šåŠ¡ 2 å°±ä¼šé˜»å¡å ç”¨çº¿ç¨‹ï¼Œä½†æ˜¯å®ƒæœ€å¤šå ç”¨åä¸ªï¼Œè¿™æ—¶å®ƒèƒ½å¤Ÿä½¿ç”¨ tomcat çš„èµ„æºæ˜¯æœ‰é™çš„ï¼Œè¿™æ ·å°±æŠŠæ•…éšœéš”ç¦»åˆ°åä¸ªçº¿ç¨‹å†…äº†ï¼Œå› æ­¤ä¹Ÿå«çº¿ç¨‹éš”ç¦»ã€‚å› æ­¤å°±é¿å…äº†æ•´ä¸ª tomcat è¢«è€—å°½çš„æƒ…å†µ</p>\n<p>ç¼ºç‚¹ï¼šèµ„æºæœ‰ä¸€å®šçš„æµªè´¹ï¼Œæ¯”å¦‚è¯´æœåŠ¡ C çœŸçš„å®•æœºäº†ï¼Œç°åœ¨æ¯æ¬¡è¯·æ±‚æ¥è¿˜è®©å®ƒå°è¯•ç€å»è®¿é—®ä¸€ä¸‹æœåŠ¡ C è¿˜è¦å ç”¨åä¸ªçº¿ç¨‹ä¹Ÿæ˜¯ä¸€ç§æµªè´¹</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310161558553.png\" alt=\"image-20231016155848381\"></p>\n<p>3ã€<mark>ç†”æ–­é™çº§</mark>ï¼šç”±<mark>æ–­è·¯å™¨</mark>ç»Ÿè®¡ä¸šåŠ¡æ‰§è¡Œçš„å¼‚å¸¸æ¯”ä¾‹ï¼Œå¦‚æœè¶…å‡ºé˜ˆå€¼åˆ™ä¼š<mark>ç†”æ–­</mark>è¯¥ä¸šåŠ¡ï¼Œæ‹¦æˆªè®¿é—®è¯¥ä¸šåŠ¡çš„ä¸€åˆ‡è¯·æ±‚ã€‚</p>\n<p>ç»Ÿè®¡æœåŠ¡ A é‡Œé¢çš„ä¸šåŠ¡ï¼Œæ¯”æ–¹è¯´æœåŠ¡ A é‡Œç¬¬ä¸€æ¬¡ä¸šåŠ¡è®¿é—®æ˜¯æ­£å¸¸çš„ï¼Œç»“æœåé¢ä¸¤æ¬¡éƒ½å‡ºç°äº†æ•…éšœã€‚è¿™æ—¶æ–­è·¯å™¨å°±ä¼šç»Ÿè®¡æ¯”ä¾‹ï¼Œä¸‰ä¸ªè¯·æ±‚ä¸€ä¸ªæ­£å¸¸ä¸¤ä¸ªæ•…éšœï¼Œæ•…éšœæ¯”ä¾‹é«˜è¾¾ 60%ã€‚å‡è®¾è¯´é˜ˆå€¼æ˜¯ 50% è¶…å‡ºäº†é˜ˆå€¼ï¼Œæ­¤æ—¶å°±ä¼šå‡ºç°ç†”æ–­ã€‚</p>\n<p>ä¸€æ—¦è¢«ç†”æ–­å¦‚æœåœ¨æœåŠ¡ A å†…éƒ¨è¿˜æƒ³è¦è®¿é—®æœåŠ¡ D çš„ä¸šåŠ¡å°±æ— æ³•å†å»è®¿é—®æœåŠ¡ D äº†ï¼Œåªè¦æ˜¯è®¿é—®æœåŠ¡ D çš„ä¸šåŠ¡å°±ä¼šè¢«æ‹¦æˆª</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310161606208.png\" alt=\"image-20231016160627109\"></p>\n<p>4ã€<mark>æµé‡æ§åˆ¶</mark>ï¼šé™åˆ¶ä¸šåŠ¡è®¿é—® QPSï¼Œé¿å…æœåŠ¡å› æµé‡çš„çªå¢è€Œæ•…éšœã€‚</p>\n<p>QPSï¼šæ¯ç§’é’Ÿå¤„ç†çš„è¯·æ±‚æ•°é‡</p>\n<p>æ¯”æ–¹è¯´æœ‰ä¸€ä¸ªå¾®æœåŠ¡ï¼Œå®ƒèƒ½æ‰¿å—çš„æœ€å¤§ QPS ä¸º 2ï¼Œä¹Ÿå°±æ˜¯æ¯ç§’é’Ÿæœ€å¤šå¤„ç†ä¸¤ä¸ªè¯·æ±‚ã€‚</p>\n<p>ä½†æ˜¯ç°åœ¨æœ‰æ— æ•°ä¸ªè¯·æ±‚æ¶Œè¿‡æ¥ï¼Œå°±ä¼šå‡ºç°æ•…éšœï¼Œä¸€æ—¦è¿™ä¸ªæœåŠ¡å‡ºç°æ•…éšœï¼Œè€Œä¾èµ–äºè¿™ä¸ªæœåŠ¡çš„å…¶å®ƒæœåŠ¡ä¹Ÿå°±è·Ÿç€å‡ºç°æ•…éšœå°±ä¼šå‡ºç°é›ªå´©é—®é¢˜</p>\n<p>æ‰€ä»¥æˆ‘ä»¬è¦é¿å…æœåŠ¡å› ä¸ºæµé‡è¿‡é«˜è€Œå¼•èµ·æ•…éšœï¼Œè¿™æ—¶å°±éœ€è¦ç”¨åˆ° Sentinel äº†</p>\n<p>ç°åœ¨å‡è®¾è¯´æœ‰æ— æ•°ä¸ªè¯·æ±‚è¿‡æ¥è€Œ Sentinel å¯ä»¥æŒ‰ç…§è¿™ä¸ªæœåŠ¡æ‰€èƒ½å¤Ÿæ‰¿å—çš„é¢‘ç‡å»é‡Šæ”¾è¯·æ±‚ï¼Œè¿™æ—¶å¾®æœåŠ¡å°±èƒ½ä»å®¹åº”å¯¹è¿™äº›è¯·æ±‚äº†å°±é¿å…äº†å‡ºç°æ•…éšœ</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310161613445.png\" alt=\"image-20231016161314587\"></p>\n<p>æµé‡æ§åˆ¶æ˜¯é¢„é˜²é›ªå´©ï¼Œå‰é¢ä¸‰ç§æ˜¯å·²ç»æœ‰æœåŠ¡æ•…éšœäº†æˆ‘æ€ä¹ˆæ ·å»é¿å…è¿™ä¸ªæ•…éšœä¼ é€’ç»™å…¶å®ƒæœåŠ¡</p>\n<p>ä½†æ˜¯ä¹Ÿä¸èƒ½è¯´ï¼Œé‚£æˆ‘å°±åªç”¨ æµé‡æ§åˆ¶å‘—ï¼Œå…¶å®ƒçš„æˆ‘å°±ä¸ç”¨äº†ï¼Œè¿™æ ·æ˜¾ç„¶æ˜¯ä¸å¯¹çš„ã€‚</p>\n<p>å› ä¸ºé«˜å¹¶å‘å¼•èµ·çš„æœåŠ¡æ•…éšœåªæ˜¯æ•…éšœçš„åŸå› ä¹‹ä¸€ï¼Œå¾€å¾€æœåŠ¡è¿˜ä¼šå› ä¸ºå…¶å®ƒé—®é¢˜è€Œå‡ºç°æ•…éšœã€‚æ¯”æ–¹è¯´ç½‘ç»œé—®é¢˜æˆ–è€…è¯´ fgc å¼•èµ·çš„å‡æ­»é—®é¢˜ï¼Œè¿™æ—¶æˆ‘ä»¬å°±éœ€è¦ç”¨åˆ°å…¶å®ƒçš„è§£å†³æ–¹æ¡ˆäº†</p>\n<blockquote>\n<p><strong>æ€»ç»“</strong>ï¼š</p>\n<p>ä»€ä¹ˆæ˜¯é›ªå´©é—®é¢˜ï¼Ÿ</p>\n<ul>\n<li>å¾®æœåŠ¡ä¹‹é—´ç›¸äº’è°ƒç”¨ï¼Œå› ä¸ºè°ƒç”¨é“¾ä¸­ä¸€ä¸ªæœåŠ¡æ•…éšœï¼Œå¼•èµ·æ•´ä¸ªé“¾è·¯éƒ½æ— æ³•è®¿é—®çš„æƒ…å†µ</li>\n</ul>\n<p>å¦‚ä½•é¿å…å› ç¬é—´é«˜å¹¶å‘æµé‡è€Œå¯¼è‡´æœåŠ¡æ•…éšœï¼Ÿ</p>\n<ul>\n<li>æµé‡æ§åˆ¶</li>\n</ul>\n<p>å¦‚ä½•é¿å…å› æœåŠ¡æ•…éšœå¼•èµ·çš„é›ªå´©é—®é¢˜ï¼Ÿ</p>\n<ul>\n<li>è¶…æ—¶å¤„ç†</li>\n<li>çº¿ç¨‹éš”ç¦»</li>\n<li>é™çº§ç†”æ–­</li>\n</ul>\n</blockquote>\n<h3 id=\"113-æœåŠ¡ä¿æŠ¤æŠ€æœ¯å¯¹æ¯”\"><a class=\"markdownIt-Anchor\" href=\"#113-æœåŠ¡ä¿æŠ¤æŠ€æœ¯å¯¹æ¯”\">#</a> 1.1.3ã€æœåŠ¡ä¿æŠ¤æŠ€æœ¯å¯¹æ¯”ğŸŒ²</h3>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Sentinel</th>\n<th>Hystrix</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>éš”ç¦»ç­–ç•¥</td>\n<td>ä¿¡å·é‡éš”ç¦»</td>\n<td>çº¿ç¨‹æ± éš”ç¦» / ä¿¡å·é‡éš”ç¦»</td>\n</tr>\n<tr>\n<td>ç†”æ–­é™çº§ç­–ç•¥</td>\n<td>åŸºäºæ…¢è°ƒç”¨æ¯”ä¾‹æˆ–å¼‚å¸¸æ¯”ä¾‹</td>\n<td>åŸºäºå¤±è´¥æ¯”ä¾‹</td>\n</tr>\n<tr>\n<td>å®æ—¶æŒ‡æ ‡å®ç°</td>\n<td>æ»‘åŠ¨çª—å£</td>\n<td>æ»‘åŠ¨çª—å£ (åŸºäº RxJava)</td>\n</tr>\n<tr>\n<td>è§„åˆ™é…ç½®</td>\n<td>æ”¯æŒå¤šç§æ•°æ®æº</td>\n<td>æ”¯æŒå¤šç§æ•°æ®æº</td>\n</tr>\n<tr>\n<td>æ‰©å±•æ€§</td>\n<td>å¤šä¸ªæ‰©å±•ç‚¹</td>\n<td>æ’ä»¶çš„å½¢å¼</td>\n</tr>\n<tr>\n<td>åŸºäºæ³¨è§£çš„æ”¯æŒ</td>\n<td>æ”¯æŒ</td>\n<td>æ”¯æŒ</td>\n</tr>\n<tr>\n<td>é™æµ</td>\n<td>åŸºäº QPSï¼Œæ”¯æŒåŸºäºè°ƒç”¨å…³ç³»çš„é™æµ</td>\n<td>æœ‰é™çš„æ”¯æŒ</td>\n</tr>\n<tr>\n<td>æµé‡æ•´å½¢</td>\n<td>æ”¯æŒæ…¢å¯åŠ¨ï¼ŒåŒ€é€Ÿæ’é˜Ÿæ¨¡å¼</td>\n<td>ä¸æ”¯æŒ</td>\n</tr>\n<tr>\n<td>ç³»ç»Ÿè‡ªé€‚åº”ä¿æŠ¤</td>\n<td>æ”¯æŒ</td>\n<td>ä¸æ”¯æŒ</td>\n</tr>\n<tr>\n<td>æ§åˆ¶å°</td>\n<td>å¼€ç®±å³ç”¨ï¼Œå¯é…ç½®è§„åˆ™ï¼ŒæŸ¥çœ‹ç§’çº§ç›‘æ§ï¼Œæœºå™¨å‘ç°ç­‰</td>\n<td>ä¸å®Œå–„</td>\n</tr>\n<tr>\n<td>å¸¸è§æ¡†æ¶çš„é€‚é…</td>\n<td>Servletï¼ŒSpring Cloudï¼ŒDubboï¼ŒgRPC ç­‰</td>\n<td>Servletï¼ŒSpring Cloud Netflix</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"12-è®¤è¯†sentinel\"><a class=\"markdownIt-Anchor\" href=\"#12-è®¤è¯†sentinel\">#</a> 1.2ã€è®¤è¯† SentinelğŸŒ³</h2>\n<p>Sentinel æ˜¯é˜¿é‡Œå·´å·´å¼€æºçš„ä¸€æ¬¾å¾®æœåŠ¡æµé‡æ§åˆ¶ç»„ä»¶ã€‚å®˜ç½‘åœ°å€ï¼š<a href=\"https://sentinelguard.io/zh-cn/\">https://sentinelguard.io/zh-cn/</a></p>\n<p><strong>Sentinel å…·æœ‰ä»¥ä¸‹ç‰¹å¾</strong>ï¼š</p>\n<p>1ã€<mark>ä¸°å¯Œçš„åº”ç”¨åœºæ™¯</mark>ï¼šSentinel æ‰¿æ¥äº†é˜¿é‡Œå·´å·´è¿› 10 å¹´çš„åŒåä¸€å¤§ä¿ƒæµé‡çš„æ ¸å¿ƒåœºæ™¯ï¼Œä¾‹å¦‚ç§’æ€ (å³çªå‘æµé‡æ§åˆ¶åœ¨ç³»ç»Ÿå®¹é‡å¯ä»¥æ‰¿å—çš„èŒƒå›´)ï¼Œæ¶ˆæ¯å‰Šå³°æ·»è°·ï¼Œé›†ç¾¤æµé‡æ§åˆ¶ï¼Œå®æ—¶ç†”æ–­ä¸‹æ¸¸ä¸å¯ç”¨åº”ç”¨ç­‰ã€‚</p>\n<p>2ã€<mark>å®Œå¤‡çš„å®æ—¶ç›‘æ§</mark>ï¼šSentinel åŒæ—¶æä¾›å®æ—¶çš„ç›‘æ§åŠŸèƒ½ã€‚æ‚¨å¯ä»¥åœ¨æ§åˆ¶å°ä¸­çœ‹åˆ°æ¥å…¥åº”ç”¨çš„å•å°é›†ç¾¤ç§’çº§æ•°æ®ï¼Œç”šè‡³ 500 å°ä»¥ä¸‹è§„æ¨¡çš„é›†ç¾¤çš„æ±‡æ€»è¿è¡Œæƒ…å†µ</p>\n<p>3ã€<mark>å¹¿æ³›çš„å¼€æºç”Ÿæ€</mark>ï¼šSentinel æä¾›å¼€ç®±å³ç”¨çš„ä¸å…¶å®ƒå¼€æºæ¡†æ¶ / åº“çš„æ•´åˆæ¨¡å—ï¼Œä¾‹å¦‚ä¸ Spring cloudï¼ŒDubboï¼ŒgRPC çš„æ•´åˆã€‚æ‚¨åªéœ€è¦å¼•å…¥ç›¸åº”çš„ä¾èµ–å¹¶è¿è¡Œç®€å•çš„é…ç½®å³å¯å¿«é€Ÿçš„æ¥å…¥ Sentinel</p>\n<p>4ã€<mark>å®Œå–„çš„ SPI æ‰©å±•ç‚¹</mark>ï¼šSentinel æä¾›ç®€å•æ˜“ç”¨ï¼Œå®Œå–„çš„ SPI æ‰©å±•æ¥å£ã€‚æ‚¨å¯ä»¥é€šè¿‡å®ç°æ‰©å±•æ¥å£æ¥å¿«é€Ÿçš„å®šåˆ¶é€»è¾‘ã€‚ä¾‹å¦‚å®šåˆ¶è§„åˆ™ç®¡ç†ï¼Œé€‚é…åŠ¨æ€æ•°æ®æºç­‰ã€‚</p>\n<h3 id=\"121-å®‰è£…sentinelæ§åˆ¶å°\"><a class=\"markdownIt-Anchor\" href=\"#121-å®‰è£…sentinelæ§åˆ¶å°\">#</a> 1.2.1ã€å®‰è£… Sentinel æ§åˆ¶å°ğŸŒ²</h3>\n<p>sentinel å®˜æ–¹æä¾›äº† UI æ§åˆ¶å°ï¼Œæ–¹ä¾¿æˆ‘ä»¬å¯¹ç³»ç»Ÿåšé™æµè®¾ç½®ã€‚å¤§å®¶å¯ä»¥åœ¨<a href=\"https://github.com/alibaba/Sentinel\"> Github</a> ä¸‹è½½ã€‚</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310161747500.png\" alt=\"image-20231016174714403\"></p>\n<p>1ã€å°†å…¶æ‹·è´åˆ°ä¸€ä¸ªéä¸­æ–‡ç›®å½•ï¼Œç„¶åè¿è¡Œå‘½ä»¤</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">java</span> <span class=\"token parameter variable\">-jar</span> sentinel-dashboard-1.8.6.jar</pre></td></tr></table></figure><p>2ã€ç„¶åè®¿é—®ï¼šlocalhost:8080 å³å¯çœ‹åˆ°æ§åˆ¶å°é¡µé¢ï¼Œé»˜è®¤çš„è´¦å·å’Œå¯†ç éƒ½æ˜¯ sentinel</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310161747766.png\" alt=\"image-20231016174746831\"></p>\n<h2 id=\"13-å®‰è£…sentinelæ§åˆ¶å°\"><a class=\"markdownIt-Anchor\" href=\"#13-å®‰è£…sentinelæ§åˆ¶å°\">#</a> 1.3ã€å®‰è£… Sentinel æ§åˆ¶å°ğŸŒ³</h2>\n<p>å¦‚æœè¦ä¿®æ”¹ Sentinel çš„é»˜è®¤ç«¯å£ï¼Œè´¦å·ï¼Œå¯†ç ï¼Œå¯ä»¥é€šè¿‡ä¸‹åˆ—é…ç½®ï¼š</p>\n<table>\n<thead>\n<tr>\n<th>é…ç½®é¡¹</th>\n<th>é»˜è®¤å€¼</th>\n<th>è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>server.port</td>\n<td>8080</td>\n<td>æœåŠ¡ç«¯å£</td>\n</tr>\n<tr>\n<td>sentinel.dashboard.auth.username</td>\n<td>sentinel</td>\n<td>é»˜è®¤ç”¨æˆ·å</td>\n</tr>\n<tr>\n<td>sentinel.dashboard.auth.password</td>\n<td>sentinel</td>\n<td>é»˜è®¤å¯†ç </td>\n</tr>\n</tbody>\n</table>\n<p>ä½†æ˜¯å®ƒå·²ç»æ˜¯ä¸€ä¸ª jar åŒ…äº†æ€ä¹ˆæ”¹å®ƒçš„é…ç½®æ–‡ä»¶å‘¢ï¼Ÿ</p>\n<p>ä¿®æ”¹é…ç½®æ–¹å¼ï¼š</p>\n<blockquote>\n<p>ä¸¾ä¾‹è¯´æ˜ï¼š</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>sentinel-dashboard-1.8.6.jar <span class=\"token parameter variable\">-Dserver.port</span><span class=\"token operator\">=</span><span class=\"token number\">8090</span></pre></td></tr></table></figure></blockquote>\n<h2 id=\"14-å¾®æœåŠ¡ä¸sentinelæ•´åˆ\"><a class=\"markdownIt-Anchor\" href=\"#14-å¾®æœåŠ¡ä¸sentinelæ•´åˆ\">#</a> 1.4ã€å¾®æœåŠ¡ä¸ Sentinel æ•´åˆğŸŒ³</h2>\n<h3 id=\"141-å¼•å…¥cloud-demo\"><a class=\"markdownIt-Anchor\" href=\"#141-å¼•å…¥cloud-demo\">#</a> 1.4.1ã€å¼•å…¥ cloud-demoğŸŒ²</h3>\n<p>è¦ä½¿ç”¨ Sentinel è‚¯å®šè¦ç»“åˆå¾®æœåŠ¡ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ SpringCloud å·¥ç¨‹ï¼Œé¡¹ç›®åœ°å€ï¼š<a href=\"https://gitee.com/doukaixin/typora.git\">https://gitee.com/doukaixin/typora.git</a></p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310161754232.png\" alt=\"image-20231016175423216\"></p>\n<p>é¡¹ç›®ç»“æ„å¦‚ä¸‹ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310161755797.png\" alt=\"image-20231016175537988\"></p>\n<p>å¯åŠ¨é¡¹ç›®è¿›è¡Œæµ‹è¯•çœ‹çœ‹æ˜¯å¦è¿˜å¯ä»¥æ­£å¸¸ä½¿ç”¨ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310161939226.png\" alt=\"image-20231016193950393\"></p>\n<p>è®¿é—®é¡µé¢</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310161939102.png\" alt=\"image-20231016193935669\"></p>\n<p>ä¸€åˆ‡æ­£å¸¸åæˆ‘ä»¬å°±å¼€å§‹æ•´åˆ</p>\n<h3 id=\"142-å¾®æœåŠ¡æ•´åˆsentinel\"><a class=\"markdownIt-Anchor\" href=\"#142-å¾®æœåŠ¡æ•´åˆsentinel\">#</a> 1.4.2ã€å¾®æœåŠ¡æ•´åˆ SentinelğŸŒ²</h3>\n<p>æˆ‘ä»¬åœ¨ order-service ä¸­æ•´åˆ Sentinelï¼Œå¹¶ä¸”é“¾æ¥ Sentinel çš„æ§åˆ¶å°ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š</p>\n<p>1ã€å¼•å…¥ Sentinel ä¾èµ–ï¼š</p>\n<figure class=\"highlight xml\"><figcaption data-lang=\"XML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">></span></span>com.alibaba.cloud<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">></span></span>spring-cloud-starter-alibaba-sentinel<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">></span></span></pre></td></tr></table></figure><p>2ã€é…ç½®æ§åˆ¶å°åœ°å€</p>\n<figure class=\"highlight yml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">cloud</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token key atrule\">sentinel</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      <span class=\"token key atrule\">transport</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token key atrule\">dashboard</span><span class=\"token punctuation\">:</span> localhost<span class=\"token punctuation\">:</span><span class=\"token number\">8080</span></pre></td></tr></table></figure><p>3ã€è®¿é—®å¾®æœåŠ¡çš„ä»»æ„ç«¯ç‚¹ï¼Œè§¦å‘ Sentinel ç›‘æ§</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310161955434.png\" alt=\"image-20231016195535390\"></p>\n<h2 id=\"15-é™æµè§„åˆ™\"><a class=\"markdownIt-Anchor\" href=\"#15-é™æµè§„åˆ™\">#</a> 1.5ã€é™æµè§„åˆ™ğŸŒ³</h2>\n<ul>\n<li>å¿«é€Ÿå…¥é—¨</li>\n<li>æµæ§æ¨¡å¼</li>\n<li>æµæ§æ•ˆæœ</li>\n<li>çƒ­ç‚¹å‚æ•°é™æµ</li>\n</ul>\n<h3 id=\"151-è”Ÿç‚¹é“¾è·¯\"><a class=\"markdownIt-Anchor\" href=\"#151-è”Ÿç‚¹é“¾è·¯\">#</a> 1.5.1ã€è”Ÿç‚¹é“¾è·¯ğŸŒ²</h3>\n<p>è”Ÿç‚¹é“¾è·¯ï¼šå°±æ˜¯é¡¹ç›®å†…çš„è°ƒç”¨é“¾è·¯ï¼Œé“¾è·¯ä¸­<mark>è¢«ç›‘æ§</mark>çš„æ¯ä¸ªæ¥å£å°±æ˜¯ä¸€ä¸ªèµ„æºã€‚é»˜è®¤æƒ…å†µä¸‹ Sentinel ä¼šç›‘æ§ SpringMVC çš„æ¯ä¸€ä¸ªç«¯ç‚¹ (Endpoint)ï¼Œå› æ­¤ SpringMVC çš„æ¯ä¸€ä¸ªç«¯ç‚¹ (Endpoint)ï¼Œå°±æ˜¯è°ƒç”¨é“¾è·¯ä¸­çš„ä¸€ä¸ªèµ„æºã€‚</p>\n<p>æµæ§ï¼Œç†”æ–­ç­‰éƒ½æ˜¯<mark>é’ˆå¯¹è”Ÿç‚¹é“¾è·¯ä¸­çš„èµ„æº</mark>æ¥è®¾ç½®çš„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ç‚¹å‡»å¯¹åº”èµ„æºåé¢çš„æŒ‰é’®æ¥è®¾ç½®è§„åˆ™ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310162003730.png\" alt=\"image-20231016200306361\"></p>\n<p>ç‚¹å‡»èµ„æº /order/{orderId} åé¢çš„æµæ§æŒ‰é’®ï¼Œå°±å¯ä»¥å¼¹å‡ºè¡¨å•ã€‚è¡¨å•ä¸­å¯ä»¥æ·»åŠ æµæ§è§„åˆ™ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310162009637.png\" alt=\"image-20231016200951539\"></p>\n<p>å…¶å«ä¹‰æ˜¯é™åˆ¶ /order/{orderId} è¿™ä¸ªèµ„æºçš„å•å‡» QPS ä¸º 1ï¼Œå³æ¯ç§’åªå…è®¸ 1 æ¬¡è¯·æ±‚ï¼Œè¶…å‡ºçš„è¯·æ±‚ä¼šè¢«æ‹¦æˆªå¹¶æŠ¥é”™ã€‚</p>\n<p>é’ˆå¯¹æ¥æºä¸­ defalt è¡¨ç¤ºä¸€åˆ‡è¯·æ±‚éƒ½é™æµ</p>\n<h4 id=\"1511-æ¡ˆä¾‹æµæ§è§„åˆ™å…¥é—¨æ¡ˆä¾‹\"><a class=\"markdownIt-Anchor\" href=\"#1511-æ¡ˆä¾‹æµæ§è§„åˆ™å…¥é—¨æ¡ˆä¾‹\">#</a> 1.5.1.1ã€æ¡ˆä¾‹ï¼Œæµæ§è§„åˆ™å…¥é—¨æ¡ˆä¾‹ğŸŒ´</h4>\n<p><strong>éœ€æ±‚</strong>ï¼šç»™ /order/{orderId} è¿™ä¸ªèµ„æºè®¾ç½®æµæ§è§„åˆ™ï¼ŒQPS ä¸èƒ½è¶…è¿‡ 5ã€‚ç„¶ååˆ©ç”¨ jmeter æµ‹è¯•ã€‚</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310162014028.png\" alt=\"image-20231016201450102\"></p>\n<p>è¿™é‡Œä½¿ç”¨ jemeter è¿›è¡Œå¹¶å‘çš„æµ‹è¯•å·¥å…·å®‰è£…æ–‡ç« ï¼š<a href=\"../Jmeter/Jmeter%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8.md\">jmeter å®‰è£…åŠä½¿ç”¨</a>.</p>\n<p>æµ‹è¯•æ–‡ä»¶æ–‡ç« åœ°å€ï¼š<a href=\"../%E6%B5%8B%E8%AF%95%E6%96%87%E4%BB%B6/sentinel%E6%B5%8B%E8%AF%95.jmx\">sentinel æµ‹è¯•.jmx</a>.</p>\n<p>å¯¼å…¥åˆ° jmeter ä¸­</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310162035976.png\" alt=\"image-20231016203528848\"></p>\n<p>å¦‚æœç‚¹å‡»æ²¡æœ‰ååº”å°±ç›´æ¥å°† jmx æ–‡ä»¶æ‹–åˆ°è“ç“¶å­é‡Œé¢å°±ç®—å¯¼å…¥äº†</p>\n<p>å³é”®ï¼Œæµæ§å…¥é—¨ï¼Œç‚¹å‡»å¯åŠ¨ï¼Œä¹‹åå¯ä»¥ç‚¹å‡»æŸ¥çœ‹ç»“æœæ ‘æ¥æŸ¥çœ‹è¯·æ±‚çš„æƒ…å†µ</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310162036099.png\" alt=\"image-20231016203617798\"></p>\n<p>è¿™æ˜¯è®¾ç½® QPS åçš„è¯·æ±‚æƒ…å†µï¼Œæ²¡æœ‰é™æµçš„æ—¶å€™å…¨æ˜¯é€šè¿‡çš„</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310162037652.png\" alt=\"image-20231016203706692\"></p>\n<p>æŸ¥çœ‹æ§åˆ¶å°çš„æƒ…å†µ</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310162032402.png\" alt=\"image-20231016203257242\"></p>\n<h3 id=\"152-æµæ§æ¨¡å¼\"><a class=\"markdownIt-Anchor\" href=\"#152-æµæ§æ¨¡å¼\">#</a> 1.5.2ã€æµæ§æ¨¡å¼ğŸŒ²</h3>\n<p>åœ¨æ·»åŠ é™æµè§„åˆ™æ—¶ï¼Œç‚¹å‡»é«˜çº§é€‰é¡¹ï¼Œå¯ä»¥é€‰æ‹©ä¸‰ç§æµæ§æ¨¡å¼ï¼š</p>\n<ul>\n<li>\n<p>ç›´æ¥ï¼šç»Ÿè®¡å½“å‰èµ„æºçš„è¯·æ±‚ï¼Œè§¦å‘é˜ˆå€¼æ—¶å¯¹å½“å‰èµ„æºç›´æ¥é™æµï¼Œä¹Ÿæ˜¯é»˜è®¤çš„æ¨¡å¼</p>\n</li>\n<li>\n<p>å…³è”ï¼šç»Ÿè®¡ä¸å½“å‰èµ„æºç›¸å…³çš„å¦ä¸€ä¸ªèµ„æºï¼Œè§¦å‘é˜ˆå€¼æ—¶ï¼Œå¯¹å½“å‰èµ„æºé™æµ</p>\n<p>ä¸¤ä¸ªèµ„æºï¼ŒA è§¦å‘äº†é˜ˆå€¼ï¼Œä½†æˆ‘å´å¯¹ B åšäº†é™æµ</p>\n</li>\n<li>\n<p>é“¾è·¯ï¼šç»Ÿè®¡ä»æŒ‡å®šé“¾è·¯è®¿é—®åˆ°æœ¬èµ„æºçš„è¯·æ±‚ï¼Œè§¦å‘é˜ˆå€¼æ—¶ï¼Œå¯¹æŒ‡å®šé“¾è·¯é™æµ</p>\n</li>\n</ul>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310162041214.png\" alt=\"image-20231016204109075\"></p>\n<h4 id=\"1521-æµæ§æ¨¡å¼-å…³è”\"><a class=\"markdownIt-Anchor\" href=\"#1521-æµæ§æ¨¡å¼-å…³è”\">#</a> 1.5.2.1ã€æµæ§æ¨¡å¼ - å…³è”ğŸŒ´</h4>\n<ul>\n<li>å…³è”æ¨¡å¼ï¼šç»Ÿè®¡ä¸å½“å‰èµ„æºç›¸å…³çš„å¦ä¸€ä¸ªèµ„æºï¼Œè§¦å‘é˜ˆå€¼æ—¶ï¼Œå¯¹å½“å‰èµ„æºé™æµ</li>\n<li>ä½¿ç”¨åœºæ™¯ï¼šæ¯”å¦‚ç”¨æˆ·æ”¯ä»˜æ—¶éœ€è¦ä¿®æ”¹è®¢å•çŠ¶æ€ï¼ŒåŒæ—¶ç”¨æˆ·è¦æŸ¥è¯¢è®¢å•ã€‚æŸ¥è¯¢å’Œä¿®æ”¹æ“ä½œä¼šäº‰æŠ¢æ•°æ®åº“é”ï¼Œäº§ç”Ÿç«äº‰ã€‚ä¸šåŠ¡éœ€æ±‚æ˜¯æœ‰é™æ”¯ä»˜å’Œæ›´æ–°è®¢å•çš„ä¸šåŠ¡ï¼Œå› æ­¤å½“ä¿®æ”¹è®¢å•ä¸šåŠ¡è§¦å‘é˜ˆå€¼æ—¶ï¼Œéœ€è¦å¯¹æŸ¥è¯¢è®¢å•ä¸šåŠ¡é™æµã€‚</li>\n</ul>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310162047957.png\" alt=\"image-20231016204748747\"></p>\n<p>å½“ /write èµ„æºè®¿é—®é‡è§¦å‘é˜ˆå€¼æ—¶ï¼Œå°±ä¼šå¯¹ /read èµ„æºé™æµï¼Œé¿å…å½±å“ /write èµ„æºã€‚</p>\n<h5 id=\"15211-æ¡ˆä¾‹æµæ§æ¨¡å¼-å…³è”\"><a class=\"markdownIt-Anchor\" href=\"#15211-æ¡ˆä¾‹æµæ§æ¨¡å¼-å…³è”\">#</a> 1.5.2.1.1ã€æ¡ˆä¾‹ï¼Œæµæ§æ¨¡å¼ - å…³è”ğŸ‹</h5>\n<p>éœ€æ±‚ï¼š</p>\n<ul>\n<li>åœ¨ OrderController æ–°å»ºä¸¤ä¸ªç«¯ç‚¹ï¼š/order/query å’Œ /order/updateï¼Œæ— éœ€å®ç°ä¸šåŠ¡</li>\n<li>é…ç½®æµæ§è§„åˆ™ï¼Œå½“ /order/update èµ„æºè¢«è®¿é—®çš„ QPS è¶…è¿‡ 5 ä¸ªæ—¶ï¼Œå¯¹ /order/query è¯·æ±‚é™æµ</li>\n</ul>\n<p>é‡å¯æœåŠ¡åè”Ÿç‚¹é“¾è·¯é‡Œé¢å°±ä¼šè¢«æ¸…ç©ºäº†ï¼Œæˆ‘ä»¬éœ€è¦é‡æ–°å»è¯·æ±‚ä¸€ä¸‹</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310162054136.png\" alt=\"image-20231016205436554\"></p>\n<p>åˆ†åˆ«è¯·æ±‚ä¸€ä¸‹ query å’Œ update çš„æ¥å£</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310162055490.png\" alt=\"image-20231016205532378\"></p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310162055118.png\" alt=\"image-20231016205543133\"></p>\n<p>å†å»æŸ¥çœ‹è”Ÿç‚¹é“¾è·¯å°±å¯ä»¥çœ‹åˆ°æœ‰ä¿¡æ¯äº†</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310162056790.png\" alt=\"image-20231016205631141\"></p>\n<p>é…ç½®æµæ§è§„åˆ™ï¼Œå½“ /order/update èµ„æºè¢«è®¿é—®çš„ QPS è¶…è¿‡ 5 ä¸ªæ—¶ï¼Œå¯¹ /order/query è¯·æ±‚é™æµã€‚</p>\n<p>æˆ‘ä»¬è¦å¯¹è°è¿›è¡Œé™æµå°±å¯¹è°è¿›è¡Œæµæ§è§„åˆ™</p>\n<p>ç‚¹å‡» query çš„æµæ§</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310162058104.png\" alt=\"image-20231016205856014\"></p>\n<p>é€šè¿‡ jmeter è¿›è¡Œæµ‹è¯•ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310162101233.png\" alt=\"image-20231016210113073\"></p>\n<p>è¯·æ±‚çš„åœ°å€å°±æ˜¯ /order/update</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310162101101.png\" alt=\"image-20231016210145527\"></p>\n<p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªè¯·æ±‚ä¸ä¼šå—åˆ°ä»»ä½•å½±å“</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310162102511.png\" alt=\"image-20231016210228553\"></p>\n<p>ä½†ï¼Œå½“è®¿é—® /order/query æ—¶</p>\n<p>å°±å‘ç”Ÿäº†å¼‚å¸¸ï¼Œupdate è§¦å‘é˜ˆå€¼æ—¶å¯¹ query é™æµå°±å®ç°äº†è¿™æ ·ä¸€ç§å…³è”æ¨¡å¼äº†</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310162103557.png\" alt=\"image-20231016210318424\"></p>\n<blockquote>\n<p><strong>å°ç»“</strong>ï¼š</p>\n<p>æ»¡è¶³ä¸‹é¢æ¡ä»¶å¯ä»¥ä½¿ç”¨å…³è”æ¨¡å¼ï¼š</p>\n<ul>\n<li>ä¸¤ä¸ªæœ‰ç«äº‰å…³ç³»çš„èµ„æº</li>\n<li>ä¸€ä¸ªä¼˜å…ˆçº§è¾ƒé«˜ï¼Œä¸€ä¸ªä¼˜å…ˆçº§è¾ƒä½</li>\n</ul>\n</blockquote>\n<h4 id=\"1523-æµæ§æ¨¡å¼-é“¾è·¯\"><a class=\"markdownIt-Anchor\" href=\"#1523-æµæ§æ¨¡å¼-é“¾è·¯\">#</a> 1.5.2.3ã€æµæ§æ¨¡å¼ - é“¾è·¯ğŸŒ´</h4>\n<p>é“¾è·¯æ¨¡å¼ï¼šåªé’ˆå¯¹ä»æŒ‡å®šé“¾è·¯è®¿é—®åˆ°æœ¬èµ„æºçš„è¯·æ±‚åšç»Ÿè®¡ï¼Œåˆ¤æ–­æ˜¯å¦è¶…è¿‡é˜ˆå€¼ã€‚</p>\n<p>ä¾‹å¦‚ï¼šæœ‰ä¸¤æ¡è¯·æ±‚é“¾è·¯ä¸€ä¸ªæ˜¯ä» test1 è®¿é—® common èµ„æºå¦ä¸€ä¸ªæ˜¯ä» test2 è®¿é—® common èµ„æºï¼š</p>\n<ul>\n<li>/test1 -&gt; /common</li>\n<li>/test2 -&gt; /common</li>\n</ul>\n<p>å¦‚æœå¸Œæœ›ç»Ÿè®¡ä» /test2 è¿›å…¥åˆ° /common çš„è¯·æ±‚ï¼Œåˆ™å¯ä»¥è¿™æ ·é…ç½®ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310162107107.png\" alt=\"image-20231016210716025\"></p>\n<p>è¿™ä¸ªé…ç½®çš„æ„æ€ï¼š</p>\n<p>åœ¨åšé™æµç»Ÿè®¡æ—¶ï¼Œåªç»Ÿè®¡ä» test2 è¿›å…¥ common çš„è¯·æ±‚ï¼Œtest1 è¿›æ¥çš„ä¸ç®¡ã€‚æ‰€ä»¥è¿™ç§ç»Ÿè®¡æ˜¯å¯¹è¯·æ±‚æ¥æºçš„ä¸€ç§ç»Ÿè®¡</p>\n<p>ä»€ä¹ˆæƒ…å†µä¸‹æˆ‘ä»¬ä¼šç”¨åˆ°è¿™æ ·çš„æ¨¡å¼å‘¢ï¼Ÿé€šè¿‡å¦‚ä¸‹æ¡ˆä¾‹äº†è§£</p>\n<h5 id=\"15231-æ¡ˆä¾‹æµæ§æ¨¡å¼-é“¾è·¯\"><a class=\"markdownIt-Anchor\" href=\"#15231-æ¡ˆä¾‹æµæ§æ¨¡å¼-é“¾è·¯\">#</a> 1.5.2.3.1ã€æ¡ˆä¾‹ï¼Œæµæ§æ¨¡å¼ - é“¾è·¯ğŸ‹</h5>\n<p>éœ€æ±‚ï¼šæœ‰æŸ¥è¯¢è®¢å•å’Œåˆ›å»ºè®¢å•ä¸šåŠ¡ï¼Œä¸¤è€…éœ€è¦æŸ¥è¯¢å•†å“ã€‚é’ˆå¯¹ä»æŸ¥è¯¢è®¢å•è¿›å…¥åˆ°æŸ¥è¯¢å•†å“çš„è¯·æ±‚ç»Ÿè®¡ï¼Œå¹¶è®¾ç½®é™æµã€‚</p>\n<p>æ­¥éª¤ï¼š</p>\n<p>1ã€åœ¨ OrderService ä¸­æ·»åŠ ä¸€ä¸ª queryGoods æ–¹æ³•ï¼Œä¸ç”¨å®ç°ä¸šåŠ¡</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Service</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">OrderService</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token annotation punctuation\">@SentinelResource</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"goods\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">queryGoods</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"æŸ¥è¯¢å•†å“\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>2ã€åœ¨ OrderController ä¸­ï¼Œæ”¹é€  /order/query ç«¯ç‚¹ï¼Œè°ƒç”¨ OrderService ä¸­çš„ queryGoods æ–¹æ³•</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"query\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">queryOrder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   <span class=\"token comment\">// æŸ¥è¯¢å•†å“</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   orderService<span class=\"token punctuation\">.</span><span class=\"token function\">queryGoods</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   <span class=\"token comment\">// æŸ¥è¯¢è®¢å•</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"æŸ¥è¯¢è®¢å•\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   <span class=\"token keyword\">return</span> <span class=\"token string\">\"æŸ¥è¯¢è®¢å•æˆåŠŸ\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>3ã€åœ¨ OrderController ä¸­æ·»åŠ ä¸€ä¸ª /order/save çš„ç«¯ç‚¹ï¼Œè°ƒç”¨ OrderService çš„ queryGoods æ–¹æ³•</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"save\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">saveOrder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   orderService<span class=\"token punctuation\">.</span><span class=\"token function\">queryGoods</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"æ–°å¢è®¢å•\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   <span class=\"token keyword\">return</span> <span class=\"token string\">\"æ–°å¢è®¢å•æˆåŠŸ\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>4ã€ç»™ queryGoods è®¾ç½®é™æµè§„åˆ™ï¼Œä» /order/query è¿›å…¥ queryGoods çš„æ–¹æ³•é™åˆ¶ QPS å¿…é¡»å°äº 2</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310170741307.png\" alt=\"image-20231017074152072\"></p>\n<ul>\n<li>\n<p>Sentinel é»˜è®¤åªæ ‡è®° Controller ä¸­çš„æ–¹æ³•ä¸ºèµ„æºï¼Œå¦‚æœè¦æ ‡è®°å…¶å®ƒæ–¹æ³•ï¼Œéœ€è¦åˆ©ç”¨ @SentinelResource æ³¨è§£ï¼Œç¤ºä¾‹ï¼š</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@SentinelResource</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"goods\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">queryGoods</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"æŸ¥è¯¢å•†å“\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure></li>\n<li>\n<p>Sentinel é»˜è®¤ä¼šå°† Controller æ–¹æ³•åš context æ•´åˆï¼Œå¯¼è‡´é“¾è·¯æ¨¡å¼çš„æµæ§å¤±è´¥ï¼Œéœ€è¦ä¿®æ”¹ application.ymlï¼Œæ·»åŠ é…ç½®ï¼š</p>\n<figure class=\"highlight yml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">cloud</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token key atrule\">sentinel</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      <span class=\"token key atrule\">transport</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token key atrule\">dashboard</span><span class=\"token punctuation\">:</span> localhost<span class=\"token punctuation\">:</span><span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      <span class=\"token key atrule\">web-context-unify</span><span class=\"token punctuation\">:</span> false // å…³é—­contextæ•´åˆ</pre></td></tr></table></figure></li>\n</ul>\n<p>è®¿é—® order/query å’Œ order/save</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310162148402.png\" alt=\"image-20231016214825324\"></p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310162148432.png\" alt=\"image-20231016214834464\"></p>\n<p>æŸ¥çœ‹ sentinel çš„è”Ÿç‚¹é“¾è·¯ä¿¡æ¯</p>\n<p>å¯ä»¥çœ‹åˆ° /order/query ä¸ /order/save å˜æˆäº†ä¸¤ä¸ªç‹¬ç«‹çš„é“¾è·¯äº†ï¼Œåœ¨ä¹‹å‰æ²¡æœ‰å…³é—­ context æ•´åˆæ—¶å®ƒä¿©æ˜¯åŒä¸€ä¸ªè·Ÿé“¾è·¯ä¸‹çš„å­é“¾è·¯</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310162149544.png\" alt=\"image-20231016214905203\"></p>\n<p>ç°åœ¨æˆ‘ä»¬å°±å¯ä»¥å¯¹ goods æ·»åŠ æµæ§è§„åˆ™äº†ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢çš„ç¬¬ 4 æ­¥</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310170741307.png\" alt=\"\"></p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310170755887.png\" alt=\"image-20231017075526647\"></p>\n<p>ä½¿ç”¨ jmeter è¿›è¡Œæµ‹è¯•</p>\n<p>å‘èµ· 200 ä¸ªè¯·æ±‚æ¯ç§’å‘èµ· 4 ä¸ª ï¼Œè€Œä¸”åŒæ—¶å‘èµ·ä¸¤ä¸ªè¯·æ±‚</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310170802306.png\" alt=\"image-20231017080217215\"></p>\n<p>å¯ä»¥çœ‹åˆ°è¯·æ±‚ save æ²¡é—®é¢˜</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310170806261.png\" alt=\"image-20231017080631501\"></p>\n<p>å¯ä»¥çœ‹åˆ°è¯·æ±‚ query æ—¶æ˜¯ä¸¤ä¸ªä¸¤ä¸ªçš„ã€‚</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310170806763.png\" alt=\"image-20231017080641204\"></p>\n<blockquote>\n<p><strong>æ€»ç»“</strong>ï¼š</p>\n<p>æµæ§æ¨¡å¼æœ‰å“ªäº›ï¼Ÿ</p>\n<ul>\n<li>ç›´æ¥ï¼šå¯¹å½“å‰èµ„æºé™æµ</li>\n<li>å…³è”ï¼šé«˜ä¼˜å…ˆçº§èµ„æºè§¦å‘é˜ˆå€¼ï¼Œå¯¹ä½ä¼˜å…ˆçº§èµ„æºé™æµ</li>\n<li>é“¾è·¯ï¼šé˜ˆå€¼ç»Ÿè®¡æ—¶ï¼Œåªç»Ÿè®¡ä»æŒ‡å®šèµ„æºè¿›å…¥å½“å‰èµ„æºçš„è¯·æ±‚ï¼Œæ˜¯å¯¹è¯·æ±‚æ¥æºçš„é™æµ</li>\n</ul>\n</blockquote>\n<h4 id=\"1524-æµæ§æ•ˆæœ\"><a class=\"markdownIt-Anchor\" href=\"#1524-æµæ§æ•ˆæœ\">#</a> 1.5.2.4ã€æµæ§æ•ˆæœğŸŒ²</h4>\n<p>æµæ§æ•ˆæœæ˜¯æŒ‡è¯·æ±‚è¾¾åˆ°æµæ§é˜ˆå€¼æ—¶åº”è¯¥é‡‡å–çš„æªæ–½ï¼ŒåŒ…æ‹¬ä¸‰ç§ï¼š</p>\n<ul>\n<li>å¿«é€Ÿå¤±è´¥ï¼šè¾¾åˆ°é˜ˆå€¼åï¼Œæ–°çš„è¯·æ±‚ä¼šè¢«ç«‹å³æ‹’ç»å¹¶æŠ›å‡º FlowException å¼‚å¸¸ã€‚æ˜¯é»˜è®¤çš„å¤„ç†æ–¹å¼ã€‚</li>\n<li>warm upï¼šé¢„çƒ­æ¨¡å¼ï¼Œå¯¹è¶…å‡ºé˜ˆå€¼çš„è¯·æ±‚åŒæ ·æ˜¯æ‹’ç»å¹¶æŠ›å‡ºå¼‚å¸¸ã€‚ä½†è¿™ç§æ¨¡å¼é˜ˆå€¼ä¼šåŠ¨æ€å˜åŒ–ï¼Œä»ä¸€ä¸ªè¾ƒå°å€¼é€æ¸å¢åŠ åˆ°æœ€å¤§é˜ˆå€¼</li>\n<li>æ’é˜Ÿç­‰å¾…ï¼šè®©æ‰€æœ‰çš„è¯·æ±‚æŒ‰ç…§å…ˆåæ¬¡åºæ’é˜Ÿæ‰§è¡Œï¼Œä¸¤ä¸ªè¯·æ±‚çš„å‰ªä¸ªä¸èƒ½å°äºæŒ‡å®šæ—¶é•¿</li>\n</ul>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310170813160.png\" alt=\"image-20231017081328807\"></p>\n<h5 id=\"15241-æµæ§æ•ˆæœ-warm-up\"><a class=\"markdownIt-Anchor\" href=\"#15241-æµæ§æ•ˆæœ-warm-up\">#</a> 1.5.2.4.1ã€æµæ§æ•ˆæœ - warm upğŸŒ´</h5>\n<p>warm up ä¹Ÿå«é¢„çƒ­æ¨¡å¼ï¼Œæ˜¯åº”å¯¹æœåŠ¡å†·å¯åŠ¨çš„ä¸€ç§æ–¹æ¡ˆã€‚è¯·æ±‚é˜ˆå€¼åˆå§‹å€¼æ˜¯ threshold é™¤ä»¥ coldFactorï¼ŒæŒç»­æŒ‡å®šæ—¶é•¿åï¼Œé€æ¸æé«˜åˆ° threshold å€¼ã€‚è€Œ clodFactor çš„é»˜è®¤å€¼æ˜¯ 3.</p>\n<p>ä¾‹å¦‚ï¼Œæˆ‘è®¾ç½® QPS çš„ threshold ä¸º 10ï¼Œé¢„çƒ­æ—¶é—´ä¸º 5 ç§’ï¼Œé‚£ä¹ˆåˆå§‹é˜ˆå€¼å°±æ˜¯ 10 / 3ï¼Œä¹Ÿå°±æ˜¯ 3ï¼Œç„¶ååœ¨ 5 ç§’åé€æ¸å¢é•¿åˆ° 10</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310170818338.png\" alt=\"image-20231017081845114\"></p>\n<h6 id=\"152411-æ¡ˆä¾‹æµæ§æ•ˆæœ-warm-up\"><a class=\"markdownIt-Anchor\" href=\"#152411-æ¡ˆä¾‹æµæ§æ•ˆæœ-warm-up\">#</a> 1.5.2.4.1.1ã€æ¡ˆä¾‹ï¼Œæµæ§æ•ˆæœ - warm upğŸ‹</h6>\n<p>éœ€æ±‚ï¼šç»™ /order/{orderId} è¿™ä¸ªèµ„æºè®¾ç½®é™æµï¼Œæœ€å¤§ QPS ä¸º 10ï¼Œåˆ©ç”¨ warm up æ•ˆæœï¼Œé¢„çƒ­æ—¶é•¿ä¸º 5 ç§’</p>\n<p>è¯·æ±‚ä¸€ä¸‹é€šè¿‡ id æŸ¥è¯¢çš„ uriï¼š<a href=\"http://localhost:8088/order/101\">http://localhost:8088/order/101</a></p>\n<p>ç„¶åå›åˆ° Sentinel åˆ·æ–°é¡µé¢ï¼Œå°±å¯ä»¥çœ‹åˆ° orderId äº†</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310170823021.png\" alt=\"image-20231017082330841\"></p>\n<p>ç»™ orderId æ·»åŠ ä¸€ä¸ªæµæ§è§„åˆ™</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310170827278.png\" alt=\"image-20231017082705193\"></p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310170827270.png\" alt=\"image-20231017082714223\"></p>\n<p>ä½¿ç”¨ jmeter è¿›è¡Œæµ‹è¯•ï¼š</p>\n<p>å¯ä»¥çœ‹åˆ°é€šè¿‡çš„ QPS è¶Šæ¥è¶Šå¤š</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310170829082.png\" alt=\"image-20231017082949095\"></p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310170830693.png\" alt=\"image-20231017083005138\"></p>\n<h5 id=\"15242-æµæ§æ•ˆæœ-æ’é˜Ÿç­‰å¾…\"><a class=\"markdownIt-Anchor\" href=\"#15242-æµæ§æ•ˆæœ-æ’é˜Ÿç­‰å¾…\">#</a> 1.5.2.4.2ã€æµæ§æ•ˆæœ - æ’é˜Ÿç­‰å¾…ğŸŒ´</h5>\n<p>å½“è¯·æ±‚è¶…è¿‡ QPS é˜ˆå€¼æ—¶ï¼Œå¿«é€Ÿå¤±è´¥å’Œ warm up ä¼šæ‹’ç»æ–°çš„è¯·æ±‚å¹¶æŠ›å‡ºå¼‚å¸¸ã€‚è€Œæ’é˜Ÿç­‰å¾…åˆ™æ˜¯è®©æ‰€æœ‰è¯·æ±‚è¿›å…¥ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œç„¶åæŒ‰ç…§é˜ˆå€¼å…è®¸çš„æ—¶é—´é—´éš”ä¾æ¬¡æ‰§è¡Œã€‚åæ¥çš„è¯·æ±‚å¿…é¡»ç­‰å¾…å‰é¢æ‰§è¡Œå®Œæˆã€‚å¦‚æœè¯·æ±‚é¢„æœŸçš„ç­‰å¾…æ—¶é—´è¶…å‡ºæœ€å¤§æ—¶é•¿ï¼Œåˆ™ä¼šè¢«æ‹’ç»ã€‚</p>\n<p>ä¾‹å¦‚ï¼šQPS=5ï¼Œæ„å‘³ç€æ¯ 200ms å¤„ç†ä¸€ä¸ªé˜Ÿåˆ—ä¸­çš„è¯·æ±‚ï¼›timeout=2000ï¼Œæ„å‘³ç€é¢„æœŸç­‰å¾…è¶…è¿‡ 2000ms çš„è¯·æ±‚ä¼šè¢«æ‹’ç»å¹¶æŠ›å‡ºå¼‚å¸¸</p>\n<p>æ¯”å¦‚ä¸‹é¢çš„æ—¶é—´çº¿ï¼Œæœ‰æ— æ•°ä¸ªè¯·æ±‚è¦è¿›å…¥é˜Ÿåˆ—æ‰§è¡Œï¼Œé‚£ç¬¬ä¸€ä¸ªè¿›å…¥é˜Ÿåˆ—çš„è¯·æ±‚å®ƒçš„ç­‰å¾…æ—¶é—´ä¸€å®šæ˜¯ 0msã€‚ä½†æ˜¯åŒä¸€æ—¶åˆ»åˆæ¥äº†ä¸€ä¸ªè¯·æ±‚é‚£ä¹ˆç¬¬äºŒä¸ªè¯·æ±‚å®ƒä¸€å®šè¦ç­‰å¾…è‡³å°‘ 200msï¼Œæ‰€ä»¥å®ƒçš„é¢„æœŸç­‰å¾…æ—¶é—´å°±æ˜¯ 2 ç§’ï¼Œåé¢çš„è¯·æ±‚ä»¥æ­¤ç±»æ¨ã€‚ç›´åˆ°ç­‰åˆ°æ—¶é—´æœ€å¤šä¸º 2000ms æ—¶ï¼Œå†æ¥ä¸€ä¸ªè¯·æ±‚å®ƒçš„ç­‰å¾…æ—¶é—´å°±æ˜¯è¶…å‡ºè¿™ 2000ms çš„æ—¶é—´äº†ï¼Œè€Œè¶…å‡ºçš„è¯·æ±‚å°±ä¼šè¢«æ‹’ç»</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310170838123.png\" alt=\"image-20231017083846925\"></p>\n<p>å¥½å¤„ï¼šå‡è®¾è¯´è¯·æ±‚ QPS æ˜¯æ³¢åŠ¨å‹çš„ï¼Œæ¯”å¦‚è¯´ç¬¬ä¸€ç§’é’Ÿä¸€ä¸ªè¯·æ±‚ä¹Ÿæ²¡æ¥ï¼Œè¿™æ—¶é˜Ÿåˆ—æ˜¯ç©ºçš„ã€‚ç»“æœç¬¬äºŒç§’ä¸€ä¸‹æ¥äº† 10 ä¸ªè¯·æ±‚ï¼Œæ”¾åˆ°é˜Ÿåˆ—é‡Œç„¶åæ¯ 200ms æ”¾è¡Œä¸€ä¸ªæ¢ç®—æˆ QPS å°±æ˜¯ 5ï¼Œæ‰€ä»¥ä¸ç®¡è¿›å…¥çš„ QPS æ˜¯æ€æ ·æ³¢åŠ¨çš„å‡ºå»çš„ QPS ä¸€å®šæ˜¯ç¨³å®šçš„æŒ‰ç…§ 200ms ä¸€ä¸ªçš„é€Ÿåº¦å»æ”¾ã€‚æ‰€ä»¥å°±èµ·åˆ°äº†æµé‡æ•´å½¢çš„ä½œç”¨</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310170854889.png\" alt=\"image-20231017085359679\"></p>\n<h6 id=\"152421-æ¡ˆä¾‹æµæ§æ•ˆæœ-æ’é˜Ÿç­‰å¾…\"><a class=\"markdownIt-Anchor\" href=\"#152421-æ¡ˆä¾‹æµæ§æ•ˆæœ-æ’é˜Ÿç­‰å¾…\">#</a> 1.5.2.4.2.1ã€æ¡ˆä¾‹ï¼Œæµæ§æ•ˆæœ - æ’é˜Ÿç­‰å¾…ğŸ‹</h6>\n<p>éœ€æ±‚ï¼šç»™ /order/{orderId} è¿™ä¸ªèµ„æºè®¾ç½®é™æµï¼Œæœ€å¤§ QPS ä¸º 10ï¼Œåˆ©ç”¨æ’é˜Ÿçš„æµæ§æ•ˆæœï¼Œè¶…æ—¶æ—¶é•¿è®¾ç½®ä¸º 5ss</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310170859614.png\" alt=\"image-20231017085932633\"></p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310170901195.png\" alt=\"image-20231017090152352\"></p>\n<p>ä½¿ç”¨ jmeter è¿›è¡Œæµ‹è¯•ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310170908478.png\" alt=\"image-20231017090853567\"></p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310170909192.png\" alt=\"image-20231017090906285\"></p>\n<blockquote>\n<p><strong>æ€»ç»“</strong>ï¼š</p>\n<p>æµæ§æ•ˆæœæœ‰å“ªäº›ï¼Ÿ</p>\n<ul>\n<li>å¿«é€Ÿå¤±è´¥ï¼šQPS è¶…è¿‡é˜ˆå€¼æ—¶ï¼Œæ‹’ç»æ–°çš„è¯·æ±‚</li>\n<li>warm upï¼šQPS è¶…è¿‡é˜ˆå€¼æ—¶ï¼Œæ‹’ç»æ–°çš„è¯·æ±‚ï¼›QPS é˜ˆå€¼æ˜¯é€æ¸æå‡çš„ï¼Œå¯ä»¥é¿å…å†·å¯åŠ¨æ—¶é«˜å¹¶å‘å¯¼è‡´æœåŠ¡å®•æœºã€‚</li>\n<li>æ’é˜Ÿç­‰å¾…ï¼šè¯·æ±‚ä¼šè¿›å…¥é˜Ÿåˆ—ï¼ŒæŒ‰ç…§é˜ˆå€¼å…è®¸çš„æ—¶é—´é—´éš”ä¾æ¬¡æ‰§è¡Œè¯·æ±‚ï¼›å¦‚æœè¯·æ±‚é¢„æœŸç­‰å¾…æ—¶é•¿å¤§äºè¶…æ—¶æ—¶é—´ï¼Œç›´æ¥æ‹’ç»</li>\n</ul>\n</blockquote>\n<h3 id=\"153-çƒ­ç‚¹å‚æ•°é™æµ\"><a class=\"markdownIt-Anchor\" href=\"#153-çƒ­ç‚¹å‚æ•°é™æµ\">#</a> 1.5.3ã€çƒ­ç‚¹å‚æ•°é™æµğŸŒ²</h3>\n<p>ä¹‹å‰çš„é™æµæ˜¯ç»Ÿè®¡è®¿é—®æŸä¸ªèµ„æºçš„æ‰€æœ‰è¯·æ±‚ï¼Œåˆ¤æ–­æ˜¯å¦è¶…è¿‡ QPS é˜ˆå€¼ã€‚è€Œçƒ­ç‚¹å‚æ•°é™æµæ˜¯åˆ†åˆ«ç»Ÿè®¡<mark>å‚æ•°å€¼ç›¸åŒ</mark>çš„è¯·æ±‚ï¼Œåˆ¤è¯»æ˜¯å¦è¶…è¿‡ QPS é˜ˆå€¼ã€‚</p>\n<p>æ¯”å¦‚è¯´ï¼šæœ‰ä¸€ä¸ªèµ„æºæ˜¯æ ¹æ® id æŸ¥è¯¢å•†å“ï¼Œå…±æœ‰ 4 ä¸ªè¯·æ±‚ã€‚å¦‚æœæŒ‰ç…§åŸæ¥çš„ç»Ÿè®¡æ–¹å¼é‚£ QPS å°±æ˜¯ 4ã€‚è€ŒæŒ‰ç…§çƒ­ç‚¹å‚æ•°å®ƒä¼šæ ¹æ®å‚æ•°å€¼æ¥åˆ¤æ–­ï¼Œå‰ä¸‰ä¸ªè¯·æ±‚ä¼ é€’çš„ id ä¸º 1ï¼Œè€Œæœ€åä¸€ä¸ªä¼ é€’çš„ id ä¸º 2ã€‚æ‰€ä»¥ QPS ç»Ÿè®¡å°±ä¼šåˆ†å¼€ç»Ÿè®¡äº†ï¼Œid ä¸º 1 çš„ç»Ÿè®¡ä¸º 3 ä¸ª QPS å°±ä¸º 3ï¼Œid ä¸º 2 çš„ç»Ÿè®¡ä¸º 1 ä¸ª QPS å°±ä¸º 1</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310170919488.png\" alt=\"image-20231017091910421\"></p>\n<h4 id=\"1531-é…ç½®çƒ­ç‚¹é™æµ\"><a class=\"markdownIt-Anchor\" href=\"#1531-é…ç½®çƒ­ç‚¹é™æµ\">#</a> 1.5.3.1ã€é…ç½®çƒ­ç‚¹é™æµğŸŒ´</h4>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310170920122.png\" alt=\"image-20231017092015196\"></p>\n<p>å‚æ•°ç´¢å¼•ï¼šä»£è¡¨å½“å‰åˆ—è¡¨ä¸­ç´¢å¼•ä¸º 0 çš„å‚æ•°ä¹Ÿå°±æ˜¯ç¬¬ä¸€ä¸ª</p>\n<p>å•æœºé˜ˆå€¼ + ç»Ÿè®¡çª—å£æ—¶é•¿ = n ç§’é’Ÿæœ€å¤šå¤„ç† 5 ä¸ªè¯·æ±‚</p>\n<p>ä»£è¡¨çš„å«ä¹‰æ˜¯ï¼šå¯¹ hot è¿™ä¸ªèµ„æºçš„ 0 å·å‚æ•° (ç¬¬ä¸€ä¸ªå‚æ•°) åšç»Ÿè®¡ï¼Œæ¯ 1 ç§’<strong>ç›¸åŒå‚æ•°å€¼</strong>çš„è¯·æ±‚æ•°ä¸èƒ½è¶…è¿‡ 5</p>\n<h4 id=\"1532-é…ç½®çƒ­ç‚¹é™æµé«˜çº§é¡¹\"><a class=\"markdownIt-Anchor\" href=\"#1532-é…ç½®çƒ­ç‚¹é™æµé«˜çº§é¡¹\">#</a> 1.5.3.2ã€é…ç½®çƒ­ç‚¹é™æµé«˜çº§é¡¹ğŸŒ´</h4>\n<p>åœ¨çƒ­ç‚¹å‚æ•°é™æµçš„é«˜çº§é€‰é¡¹ä¸­ï¼Œå¯ä»¥å¯¹éƒ¨åˆ†å‚æ•°è®¾ç½®ä¾‹å¤–é…ç½®ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310170924654.png\" alt=\"image-20231017092441509\"></p>\n<p>ç»“åˆä¸Šä¸€ä¸ªé…ç½®ï¼Œè¿™é‡Œçš„å«ä¹‰æ˜¯å¯¹ 0 å·çš„ long ç±»å‹å‚æ•°é™æµï¼Œæ¯ 1 ç§’ç›¸åŒå‚æ•°çš„ QPS ä¸èƒ½è¶…è¿‡ 5ï¼Œæœ‰ä¸¤ä¸ªä¾‹å¤–ï¼š</p>\n<p>1ã€å¦‚æœå‚æ•°å€¼æ˜¯ 100ï¼Œåˆ™æ¯ 1 ç§’å…è®¸çš„ QPS ä¸º 10</p>\n<p>2ã€å¦‚æœå‚æ•°å€¼æ˜¯ 101ï¼Œåˆ™æ¯ 1 ç§’å…è®¸çš„ QPS ä¸º 15</p>\n<h4 id=\"1533-æ¡ˆä¾‹çƒ­ç‚¹å‚æ•°é™æµ\"><a class=\"markdownIt-Anchor\" href=\"#1533-æ¡ˆä¾‹çƒ­ç‚¹å‚æ•°é™æµ\">#</a> 1.5.3.3ã€æ¡ˆä¾‹ï¼Œçƒ­ç‚¹å‚æ•°é™æµğŸŒ´</h4>\n<p>ç»™ /order/{orderId} è¿™ä¸ªèµ„æºæ·»åŠ çƒ­ç‚¹å‚æ•°é™æµï¼Œè§„åˆ™å¦‚ä¸‹ï¼š</p>\n<ul>\n<li>é»˜è®¤çš„çƒ­ç‚¹å‚æ•°è§„åˆ™æ˜¯æ¯ 1 ç§’è¯·æ±‚é‡ä¸è¶…è¿‡ 2</li>\n<li>ç»™ 102 è¿™ä¸ªå‚æ•°è®¾ç½®ä¾‹å¤–ï¼šæ¯ 1 ç§’è¯·æ±‚é‡ä¸è¶…è¿‡ 4</li>\n<li>ç»™ 103 è¿™ä¸ªå‚æ•°è®¾ç½®ä¾‹å¤–ï¼šæ¯ 1 ç§’è¯·æ±‚é‡ä¸è¶…è¿‡ 10</li>\n</ul>\n<blockquote>\n<p><font color='red'>æ³¨æ„</font>ï¼š</p>\n<p>çƒ­ç‚¹å‚æ•°é™æµå¯¹é»˜è®¤çš„ SpringMVC èµ„æºæ— æ•ˆ</p>\n</blockquote>\n<p>æ­¥éª¤ï¼š</p>\n<p>1ã€çƒ­ç‚¹å‚æ•°é™æµå¯¹é»˜è®¤çš„ SpringMVC èµ„æºæ— æ•ˆï¼Œæˆ‘ä»¬ order/{orderId} è¿™ä¸ªèµ„æºæ°å¥½å°±æ˜¯ Sentinel é»˜è®¤å¯¹ SpringMVC ç›‘æ§çš„ä¸€ä¸ªèµ„æºï¼Œæ‰€ä»¥å³ä¾¿é…ç½®äº†çƒ­ç‚¹å‚æ•°ä¹Ÿä¸ä¼šç”Ÿæ•ˆï¼Œåªæœ‰é€šè¿‡ @SentinelResource å»å£°æ˜çš„èµ„æºæ‰å¯ä»¥é…ç½®çƒ­ç‚¹å‚æ•°é™æµ</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@SentinelResource</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hot\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"&#123;orderId&#125;\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">Order</span> <span class=\"token function\">queryOrderByUserId</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@PathVariable</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"orderId\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">Long</span> orderId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   <span class=\"token comment\">// æ ¹æ® id æŸ¥è¯¢è®¢å•å¹¶è¿”å›</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   <span class=\"token keyword\">return</span> orderService<span class=\"token punctuation\">.</span><span class=\"token function\">queryOrderById</span><span class=\"token punctuation\">(</span>orderId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>è¿™æ—¶èµ„æºå°±åŒæ—¶å…·å¤‡äº†ä¸¤ä¸ªåç§°äº†ï¼Œä¸€ä¸ªæ˜¯ order/{orderId} è¿™æ˜¯é»˜è®¤çš„ SpringMVC èµ„æºåç§°ã€‚</p>\n<p>å¦å¤–ä¸€ä¸ªå°±æ˜¯æˆ‘ä»¬è‡ªå·±èµ·çš„ hot</p>\n<p>é‡å¯ orderService æœåŠ¡åè®¿é—®é¡µé¢ uriï¼š<a href=\"http://localhost:8088/order/101\">http://localhost:8088/order/101</a></p>\n<p>è¿™æ ·å°±å¯ä»¥çœ‹åˆ°è”Ÿç‚¹é“¾è·¯äº†</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171009407.png\" alt=\"image-20231017100944355\"></p>\n<p>2ã€é…ç½®çƒ­ç‚¹é™æµï¼Œä¸è¦ç‚¹å‡»æ ‘å½¢åˆ—è¡¨ä¸­çš„çƒ­ç‚¹è¿™ä¸ªè¡¨å•é‡Œé¢æ²¡æœ‰é«˜çº§é…ç½®</p>\n<p>æˆ‘ä»¬ç‚¹å‡»å·¦è¾¹çš„é€‰é¡¹æ ä¸­çš„çƒ­ç‚¹è§„åˆ™ï¼Œè¿›è¡Œé…ç½®</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171011792.png\" alt=\"image-20231017101141197\"></p>\n<p>ç‚¹å‡»æ–°å¢çƒ­ç‚¹é™æµè§„åˆ™å°±ä¼šå¼¹å‡ºä¸€ä¸ªè¡¨å•è¿›è¡Œé…ç½®</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171015751.png\" alt=\"image-20231017101511501\"></p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171017813.gif\" alt=\"test\"></p>\n<p>ä½¿ç”¨ jmeter è¿›è¡Œæµ‹è¯•ï¼š</p>\n<p>order/101 çš„è¯·æ±‚ç»“æœ</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171021326.png\" alt=\"image-20231017102157624\"></p>\n<p>order/102 è¯·æ±‚çš„ç»“æœ</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171022007.png\" alt=\"image-20231017102216489\"></p>\n<p>order/103 è¯·æ±‚ç»“æœ</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171022759.png\" alt=\"image-20231017102239351\"></p>\n<p>Sentinel çš„æ§åˆ¶å°æƒ…å†µ</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171022389.png\" alt=\"image-20231017102256408\"></p>\n<h2 id=\"16-éš”ç¦»å’Œé™çº§\"><a class=\"markdownIt-Anchor\" href=\"#16-éš”ç¦»å’Œé™çº§\">#</a> 1.6ã€éš”ç¦»å’Œé™çº§ğŸŒ³</h2>\n<ul>\n<li>FeignClient æ•´åˆ Sentinel</li>\n<li>çº¿ç¨‹éš”ç¦» (èˆ±å£æ¨¡å¼)</li>\n<li>ç†”æ–­é™çº§</li>\n</ul>\n<p><strong>å›é¡¾ï¼Œéš”ç¦»å’Œé™çº§çš„åŸç†</strong></p>\n<p>è™½ç„¶é™æµå¯ä»¥å°½é‡é¿å…å› é«˜å¹¶å‘è€Œå¼•èµ·çš„æœåŠ¡æ•…éšœï¼Œä½†æœåŠ¡è¿˜ä¼šå› ä¸ºå…¶å®ƒåŸå› è€Œæ•…éšœã€‚è€Œè¦å°†è¿™äº›æ•…éšœæ§åˆ¶åœ¨ä¸€å®šèŒƒå›´ï¼Œé¿å…é›ªå´©ï¼Œå°±è¦é çº¿ç¨‹éš”ç¦» (èˆ±å£æ¨¡å¼) å’Œç†”æ–­é™çº§æ‰‹æ®µäº†ã€‚</p>\n<p>ç»™æ¯ä¸ªä¸šåŠ¡åˆ’åˆ†çº¿ç¨‹æ± ï¼Œå½“æœ‰è¯·æ±‚è®¿é—®ä¸šåŠ¡ 1 æ—¶æœ€å¤šä½¿ç”¨åä¸ªçº¿ç¨‹ï¼Œè™½ç„¶æœåŠ¡ C æ•…éšœäº†è¯·æ±‚è¿‡ç¨‹ä¸­ä¼šé˜»å¡ä½†æ˜¯æœ€å¤šåªå ç”¨ 10 ä¸ªçº¿ç¨‹èµ„æº</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171031862.png\" alt=\"image-20231017103151291\"></p>\n<p>ç†”æ–­é™çº§ä¼šç»Ÿè®¡æ•…éšœæœåŠ¡çš„æ¯”ä¾‹ï¼Œæ¯”å¦‚è¯´æœåŠ¡ A è®¿é—®æœåŠ¡ D æˆåŠŸçš„åªæœ‰ä¸€ä¸ªï¼Œæ•…éšœçš„æœ‰ä¸¤ä¸ªè¿™æ—¶çš„æ¯”ä¾‹å°±æ˜¯ 60%ã€‚æ­¤æ—¶ æ–­è·¯å™¨å°±ä¼šç†”æ–­ä¸šåŠ¡ï¼Œå†æœ‰è¦è¯·æ±‚æœåŠ¡ D çš„ä¸šåŠ¡å°±ä¼šå¿«é€Ÿå¤±è´¥</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171033093.png\" alt=\"image-20231017103347716\"></p>\n<p>ä¸ç®¡æ˜¯çº¿ç¨‹éš”ç¦»è¿˜æ˜¯ç†”æ–­é™çº§ï¼Œéƒ½æ˜¯å¯¹ <font color='red'>å®¢æˆ·ç«¯ (è°ƒç”¨æ–¹) </font>. çš„ä¿æŠ¤</p>\n<h3 id=\"161-feignæ•´åˆsentinel\"><a class=\"markdownIt-Anchor\" href=\"#161-feignæ•´åˆsentinel\">#</a> 1.6.1ã€Feign æ•´åˆ SentinelğŸŒ²</h3>\n<p>SpringCloud ä¸­ï¼Œå¾®æœåŠ¡è°ƒç”¨éƒ½æ˜¯é€šè¿‡ Feign æ¥å®ç°çš„ï¼Œå› æ­¤åšå®¢æˆ·ç«¯ä¿æŠ¤å¿…é¡»æ•´åˆ Feign å’Œ Sentinel</p>\n<p>1ã€ä¿®æ”¹ OrderService çš„ applicaiton.yml æ–‡ä»¶ï¼Œå¼€å¯ Feign çš„ Sentinel åŠŸèƒ½</p>\n<figure class=\"highlight yml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">feign</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token key atrule\">sentinel</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span> <span class=\"token comment\"># å¼€å¯ feign å¯¹ sentinel çš„æ”¯æŒ</span></pre></td></tr></table></figure><p>2ã€ç»™ FeignClient ç¼–å†™å¤±è´¥åçš„é™çº§é€»è¾‘</p>\n<p>2.1ã€æ–¹å¼ä¸€ï¼šFallbackClassï¼Œæ— æ³•å¯¹è¿œç¨‹è°ƒç”¨çš„å¼‚å¸¸åšå¤„ç†</p>\n<p>2.2ã€æ–¹å¼äºŒï¼šFallbackFactoryï¼Œå¯ä»¥å¯¹è¿œç¨‹è°ƒç”¨çš„å¼‚å¸¸åšå¤„ç†ï¼Œæˆ‘ä»¬é€‰æ‹©è¿™ç§</p>\n<p>2.2.1ã€åœ¨ feign-api é¡¹ç›®ä¸­å®šä¹‰ç±»ï¼Œå®ç° FallbackFactoryï¼š</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Slf4j</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">UserClientFallbackFactory</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">FallbackFactory</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">UserClient</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">UserClient</span> <span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Throwable</span> throwable<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token comment\">// åˆ›å»º UserClient æ¥å£å®ç°ç±»ï¼Œå®ç°å…¶ä¸­çš„æ–¹æ³•ï¼Œç¼–å†™å¤±è´¥é™çº§çš„å¤„ç†é€»è¾‘</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">UserClient</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token keyword\">public</span> <span class=\"token class-name\">User</span> <span class=\"token function\">findById</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                <span class=\"token comment\">// è®°å½•å¼‚å¸¸ä¿¡æ¯</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                log<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"æŸ¥è¯¢ç”¨æˆ·å¼‚å¸¸\"</span><span class=\"token punctuation\">,</span> throwable<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                <span class=\"token comment\">// æ ¹æ®ä¸šåŠ¡éœ€æ±‚è¿”å›é»˜è®¤çš„æ•°æ®ï¼Œè¿™é‡Œæ˜¯ç©ºç”¨æˆ·</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">User</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>2.2.2ã€åœ¨ feign-api é¡¹ç›®ä¸­çš„ DefaultFeignConfigration ç±»ä¸­å°† UserClientFallbackFactory æ³¨å†Œä¸ºä¸€ä¸ª Beanï¼š</p>\n<p>å£°æ˜ Bean å¾ˆç®€å•ï¼Œå®šä¹‰å‡½æ•°è¿”å› new å‡ºæ¥çš„å¯¹è±¡å¹¶æ³¨å†Œ Bean å°±è¡Œäº†</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Bean</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">UserClientFallbackFactory</span> <span class=\"token function\">userClientFallbackFactory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">UserClientFallbackFactory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>2.2.3ã€åœ¨ feign-api é¡¹ç›®ä¸­çš„ UserClient æ¥å£ä¸­ä½¿ç”¨ UserClientFallbackFactoryï¼š</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@FeignClient</span><span class=\"token punctuation\">(</span>value <span class=\"token operator\">=</span> <span class=\"token string\">\"userservice\"</span><span class=\"token punctuation\">,</span> fallbackFactory <span class=\"token operator\">=</span> <span class=\"token class-name\">UserClientFallbackFactory</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">UserClient</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"user/&#123;id&#125;\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token class-name\">User</span> <span class=\"token function\">findById</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@PathVariable</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>3ã€é‡å¯ orderService æœåŠ¡</p>\n<p>é‡å¤å®ŒæˆåæŸ¥çœ‹ Sentinel çš„è”Ÿç‚¹é“¾è·¯æƒ…å†µï¼Œä¸‹é¢çš„æƒ…å†µè¯´æ˜å®Œæˆäº† Feign ä¸ Sentinel çš„æ•´åˆäº†</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171304966.png\" alt=\"image-20231017130442973\"></p>\n<blockquote>\n<p><strong>æ€»ç»“</strong>ï¼š</p>\n<p>Sentinel æ”¯æŒçš„é›ªå´©è§£å†³æ–¹æ¡ˆï¼š</p>\n<ul>\n<li>çº¿ç¨‹éš”ç¦» (ä»“å£æ¨¡å¼)</li>\n<li>é™çº§ç†”æ–­</li>\n</ul>\n<p>Feign æ•´åˆ Sentinel çš„æ­¥éª¤ï¼š</p>\n<ol>\n<li>åœ¨ application.yml ä¸­é…ç½®ï¼šfeign.sentinel.enable = true</li>\n<li>ç»™ FeignClient ç¼–å†™ FallbackFactory å¹¶æ³¨å†Œä¸º Bean</li>\n<li>å°† FallbackFactory é…ç½®åˆ° FeignClient</li>\n</ol>\n</blockquote>\n<h3 id=\"162-çº¿ç¨‹éš”ç¦»\"><a class=\"markdownIt-Anchor\" href=\"#162-çº¿ç¨‹éš”ç¦»\">#</a> 1.6.2ã€çº¿ç¨‹éš”ç¦»ğŸŒ²</h3>\n<p>çº¿ç¨‹éš”ç¦»æœ‰ä¸¤ç§æ–¹å¼å®ç°ï¼š</p>\n<ul>\n<li>çº¿ç¨‹æ± éš”ç¦»</li>\n<li>ä¿¡å·é‡éš”ç¦» (Sentinel é»˜è®¤é‡‡ç”¨)</li>\n</ul>\n<p>é€šè¿‡æ¡ˆä¾‹æ¥æŸ¥çœ‹ä¸¤ä¸ªçº¿ç¨‹éš”ç¦»çš„å·®åˆ«ï¼š</p>\n<p>å‡è®¾è¯´æœ‰å››ä¸ªæœåŠ¡ iï¼Œaï¼Œbï¼Œc ã€‚æœåŠ¡ i é‡Œé¢çš„ä¸šåŠ¡ä¾èµ–äºæœåŠ¡ aï¼Œbï¼Œcã€‚æ¯”æ–¹è¯´æ¥äº†ä¸€ä¸ªè¯·æ±‚ï¼Œå®ƒçš„ä¸šåŠ¡ä¾èµ–äºæœåŠ¡ aï¼Œbã€‚å¦‚æœè¯´æˆ‘ä»¬ç°åœ¨ç”¨çš„æ˜¯çº¿ç¨‹æ± éš”ç¦»é‚£ä¹ˆå®ƒå°±ä¼šç»™è¿™ä¸ªä¸šåŠ¡æ‰€ä¾èµ–çš„æ¯ä¸ªæœåŠ¡éƒ½åˆ›å»ºçº¿ç¨‹æ± ï¼Œè¯·æ±‚æ¥äº†ä»¥åä¸ä¼šä½¿ç”¨è¯·æ±‚æœ¬èº«çš„çº¿ç¨‹ï¼Œè€Œæ˜¯å»åˆ›å»ºçš„çº¿ç¨‹æ± ä¸­åˆ†åˆ«å–ä¸€ä¸ªçº¿ç¨‹è€Œç”¨è¿™ä¸ªçº¿ç¨‹å»è°ƒç”¨ Feign çš„å®¢æˆ·ç«¯ï¼Œå‘èµ·è¿œç¨‹è°ƒç”¨ã€‚è¿™æ ·å‘¢å°±æŠŠä¸¤ä¸ªæœåŠ¡éš”ç¦»äº†</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171315936.png\" alt=\"image-20231017131457045\"></p>\n<p>è€Œå¦‚æœé‡‡ç”¨çš„æ˜¯ä¿¡å·é‡çš„æ¨¡å¼å°±ç®€å•å¤šäº†ã€‚æ¯”å¦‚è¯´æ¥äº†ä¸€ä¸ªè¯·æ±‚ï¼Œè¦è®¿é—®æœåŠ¡ cã€‚å®ƒä¼šä½¿ç”¨è¯·æ±‚æœ¬èº«çš„çº¿ç¨‹ç›´æ¥å»è°ƒç”¨ Feign çš„å®¢æˆ·ç«¯å»è°ƒç”¨æœåŠ¡ cã€‚é‚£å®ƒæ€ä¹ˆåšéš”ç¦»å‘¢ï¼Ÿå®ƒä¼šåœ¨è¯·æ±‚è¿›å…¥æ—¶åšä¸€ä¸ªåˆ¤æ–­ï¼Œç»´æŒäº†ä¸€ä¸ªè®¡æ•°å™¨ã€‚åˆ¤æ–­ç°åœ¨è®¡æ•°å™¨è¿˜æœ‰æ²¡æœ‰ã€‚æ¯”å¦‚è¯´è®¡æ•°å™¨æ€»æ•°ä¸º 10 æ¯è¿›å…¥ä¸€ä¸ªè¯·æ±‚è®¡æ•°å™¨å°±ä¼šå‡ 1ï¼Œç„¶åå°±å¯ä»¥å»è®¿é—®æœåŠ¡ c äº†ã€‚å½“æ¥äº†åä¸ªè¯·æ±‚è®¡æ•°å™¨è¢«å–å®Œåå†æ¥æ–°è¯·æ±‚å°±ä¼šè¢«æ‹’ç»ã€‚è¿™æ ·å°±ç­‰äºåˆ©ç”¨è®¡æ•°å™¨é™åˆ¶äº†æœ€ç»ˆçº¿ç¨‹çš„æ•°é‡äº†ã€‚å¦‚æœå¤„ç†å®Œè¯·æ±‚è®¡æ•°å™¨è¿˜æ˜¯è¦è¿˜å›å»çš„</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171319389.png\" alt=\"image-20231017131940276\"></p>\n<h4 id=\"1621-ä¸¤è€…çš„ä¼˜ç¼ºç‚¹\"><a class=\"markdownIt-Anchor\" href=\"#1621-ä¸¤è€…çš„ä¼˜ç¼ºç‚¹\">#</a> 1.6.2.1ã€ä¸¤è€…çš„ä¼˜ç¼ºç‚¹ï¼š</h4>\n<h5 id=\"çº¿ç¨‹æ± éš”ç¦»\"><a class=\"markdownIt-Anchor\" href=\"#çº¿ç¨‹æ± éš”ç¦»\">#</a> çº¿ç¨‹æ± éš”ç¦»</h5>\n<p><strong>ä¼˜ç‚¹</strong>ï¼š</p>\n<p>1ã€æ”¯æŒä¸»åŠ¨è¶…æ—¶</p>\n<p>å¦‚æœå‘ç°è¯·æ±‚æœ‰ç‚¹ä¹…äº†å¯ä»¥æ‰‹åŠ¨çš„ç»ˆæ­¢çº¿ç¨‹</p>\n<p>2ã€æ”¯æŒå¼‚æ­¥è°ƒç”¨</p>\n<p>æ¯ä¸€æ¬¡è¯·æ±‚éƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹è€Œä¸æ˜¯ tomcat è¯·æ±‚çš„çº¿ç¨‹</p>\n<p><strong>ç¼ºç‚¹</strong>ï¼š</p>\n<p>1ã€çº¿ç¨‹çš„é¢å¤–å¼€é”€æ¯”è¾ƒå¤§</p>\n<p>åœºæ™¯ï¼š</p>\n<p>1ã€ä½æ‰‡å‡º</p>\n<p>æ‰‡å‡ºï¼šæ¯”æ–¹è¯´è¯·æ±‚åˆ°æˆ‘è¿™ä¸ªæœåŠ¡ï¼Œè€Œæˆ‘è¿™ä¸ªæœåŠ¡ä¾èµ–äºå…¶å®ƒçš„ n ä¸ªæœåŠ¡ã€‚å°±æ˜¯ä»æˆ‘è¿™æ¥äº†ï¼Œæ¥äº†ä¸€ä¸ªè€Œåæˆ‘æ‰‡å‡ºäº†å¥½å‡ ä¸ªã€‚å¦‚æœä¾èµ–çš„æœåŠ¡è¶Šå¤šï¼Œé‚£æ‰‡å‡ºä¹Ÿå°±è¶Šé«˜ï¼Œè€Œæ‰‡å‡ºè¶Šé«˜è°ƒç”¨çš„è¶Šå¤šæˆ‘éœ€è¦å¼€å¯çš„çº¿ç¨‹ä¹Ÿè¶Šå¤šï¼Œæ¶ˆè€—ä¹Ÿå°±è¶Šå¤§ã€‚æ‰€ä»¥å®ƒä¸é€‚ç”¨äºé«˜æ‰‡å‡ºçš„åœºæ™¯ï¼</p>\n<h5 id=\"ä¿¡å·é‡éš”ç¦»\"><a class=\"markdownIt-Anchor\" href=\"#ä¿¡å·é‡éš”ç¦»\">#</a> ä¿¡å·é‡éš”ç¦»</h5>\n<p><strong>ä¼˜ç‚¹</strong>ï¼š</p>\n<p>1ã€è½»é‡çº§ï¼Œæ— é¢å¤–å¼€é”€</p>\n<p><strong>ç¼ºç‚¹</strong>ï¼š</p>\n<p>1ã€ä¸æ”¯æŒä¸»åŠ¨è¶…æ—¶</p>\n<p>2ã€ä¸æ”¯æŒå¼‚æ­¥è°ƒç”¨</p>\n<p>åœºæ™¯ï¼š</p>\n<p>1ã€é«˜é¢‘è°ƒç”¨</p>\n<p>2ã€é«˜æ‰‡å‡º</p>\n<h4 id=\"1622-çº¿ç¨‹éš”ç¦»-èˆ±å£æ¨¡å¼\"><a class=\"markdownIt-Anchor\" href=\"#1622-çº¿ç¨‹éš”ç¦»-èˆ±å£æ¨¡å¼\">#</a> 1.6.2.2ã€çº¿ç¨‹éš”ç¦» (èˆ±å£æ¨¡å¼)ğŸŒ´</h4>\n<p>åœ¨æ·»åŠ é™æµè§„åˆ™æ—¶ï¼Œå¯ä»¥é€‰æ‹©ä¸¤ç§é˜ˆå€¼ç±»å‹ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171332558.png\" alt=\"image-20231017133257502\"></p>\n<ul>\n<li>QPSï¼šå°±æ˜¯æ¯ç§’çš„è¯·æ±‚æ•°ï¼Œåœ¨å¿«é€Ÿå…¥é—¨ä¸­å·²ç»æ¼”ç¤ºè¿‡</li>\n<li>çº¿ç¨‹æ•°ï¼šæ˜¯è¯¥èµ„æºèƒ½ä½¿ç”¨çš„ tomcat çº¿ç¨‹æ•°çš„æœ€å¤§å€¼ã€‚ä¹Ÿå°±æ˜¯é€šè¿‡é™åˆ¶çº¿ç¨‹æ•°é‡ï¼Œå®ç°<font color='red'>èˆ±å£æ¨¡å¼</font>.</li>\n</ul>\n<h5 id=\"16221-æ¡ˆä¾‹çº¿ç¨‹éš”ç¦»-èˆ±å£æ¨¡å¼\"><a class=\"markdownIt-Anchor\" href=\"#16221-æ¡ˆä¾‹çº¿ç¨‹éš”ç¦»-èˆ±å£æ¨¡å¼\">#</a> 1.6.2.2.1ã€æ¡ˆä¾‹ï¼Œçº¿ç¨‹éš”ç¦» (èˆ±å£æ¨¡å¼)ğŸ‹</h5>\n<p>éœ€æ±‚ï¼šç»™ UserClient çš„æŸ¥è¯¢ç”¨æˆ·æ¥å£è®¾ç½®æµæ§è§„åˆ™ï¼Œçº¿ç¨‹æ•°ä¸èƒ½è¶…è¿‡ 2ã€‚ç„¶ååˆ©ç”¨ jmeter æµ‹è¯•ã€‚</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171336102.png\" alt=\"image-20231017133620881\"></p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171336135.png\" alt=\"image-20231017133657213\"></p>\n<p>é…ç½®å®Œæˆï¼ä½¿ç”¨ jmeter è¿›è¡Œé«˜å¹¶å‘æµ‹è¯•ï¼š</p>\n<p>å…¶ä¸­çš„çº¿ç¨‹æ•°ä¸º 10ï¼Œæ—¶é—´ä¸º 0ã€‚è¡¨ç¤ºä¸€ç¬é—´å‘ 10 ä¸ªçº¿ç¨‹è¯·æ±‚ã€‚</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171337544.png\" alt=\"image-20231017133755763\"></p>\n<p>æµ‹è¯•ç»“æœï¼š</p>\n<p>ä½†æ˜¯æ€ä¹ˆæ²¡æœ‰çœ‹åˆ°è¢«æ‹’ç»çš„è¯·æ±‚å‘¢ï¼Ÿ</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171341275.png\" alt=\"image-20231017134110845\"></p>\n<p>å…¶å®æˆ‘ä»¬åšäº†é™çº§ç­–ç•¥äº†</p>\n<p>åœ¨ FeignClient æ³¨è§£ä¸­åŠ äº† fallbackFactory</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@FeignClient</span><span class=\"token punctuation\">(</span>value <span class=\"token operator\">=</span> <span class=\"token string\">\"userservice\"</span><span class=\"token punctuation\">,</span> fallbackFactory <span class=\"token operator\">=</span> <span class=\"token class-name\">UserClientFallbackFactory</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">UserClient</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"user/&#123;id&#125;\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token class-name\">User</span> <span class=\"token function\">findById</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@PathVariable</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>æ‰€ä»¥å½“çº¿ç¨‹éš”ç¦»è¢«é™çº§ä»¥åå®ƒä¸æ˜¯æŠ¥é”™ï¼Œè€Œæ˜¯ä¼šèµ°è¿™ä¸ªé™çº§é€»è¾‘è¿”å›ä¸€ä¸ªç©ºå¯¹è±¡</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Slf4j</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">UserClientFallbackFactory</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">FallbackFactory</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">UserClient</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">UserClient</span> <span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Throwable</span> throwable<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token comment\">// åˆ›å»º UserClient æ¥å£å®ç°ç±»ï¼Œå®ç°å…¶ä¸­çš„æ–¹æ³•ï¼Œç¼–å†™å¤±è´¥é™çº§çš„å¤„ç†é€»è¾‘</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">UserClient</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token keyword\">public</span> <span class=\"token class-name\">User</span> <span class=\"token function\">findById</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                <span class=\"token comment\">// è®°å½•å¼‚å¸¸ä¿¡æ¯</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                log<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"æŸ¥è¯¢ç”¨æˆ·å¼‚å¸¸\"</span><span class=\"token punctuation\">,</span> throwable<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                <span class=\"token comment\">// æ ¹æ®ä¸šåŠ¡éœ€æ±‚è¿”å›é»˜è®¤çš„æ•°æ®ï¼Œè¿™é‡Œæ˜¯ç©ºç”¨æˆ·</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">User</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>ä½†æ˜¯åœ¨ idea çš„æ§åˆ¶å°ä¼šæ‰“å°å¼‚å¸¸çš„ä¿¡æ¯</p>\n<pre><code>10-17 13:40:38:046 ERROR 1804 --- [nio-8088-exec-3] c.i.f.c.f.UserClientFallbackFactory : æŸ¥è¯¢ç”¨æˆ·å¼‚å¸¸\n</code></pre>\n<p>æˆ‘ä»¬åœ¨å›åˆ° jmeter ç‚¹å‡»è¯·æ±‚æŸ¥çœ‹è¯¦ç»†æƒ…å†µï¼Œæœ‰çš„è·å–çš„æ•°æ®æ˜¯ç©ºçš„</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171347804.png\" alt=\"image-20231017134731646\"></p>\n<blockquote>\n<p><strong>æ€»ç»“</strong>ï¼š</p>\n<p>çº¿ç¨‹éš”ç¦»çš„ä¸¤ç§æ‰‹æ®µæ˜¯ï¼Ÿ</p>\n<ul>\n<li>ä¿¡å·éš”ç¦»</li>\n<li>çº¿ç¨‹æ± éš”ç¦»</li>\n</ul>\n<p>ä¿¡å·é‡éš”ç¦»çš„ç‰¹ç‚¹æ˜¯ï¼Ÿ</p>\n<ul>\n<li>åŸºäºè®¡æ•°å™¨æ¨¡å¼ï¼Œç®€å•ï¼Œå¼€é”€å°</li>\n</ul>\n<p>çº¿ç¨‹æ± éš”ç¦»çš„ç‰¹ç‚¹æ˜¯ï¼Ÿ</p>\n<ul>\n<li>åŸºäºçº¿ç¨‹æ± æ¨¡å¼ï¼Œæœ‰é¢å¤–å¼€é”€ï¼Œä½†éš”ç¦»æ§åˆ¶æ›´å¼º</li>\n</ul>\n</blockquote>\n<h3 id=\"163-ç†”æ–­é™çº§\"><a class=\"markdownIt-Anchor\" href=\"#163-ç†”æ–­é™çº§\">#</a> 1.6.3ã€ç†”æ–­é™çº§ğŸŒ²</h3>\n<p>ç†”æ–­é™çº§æ˜¯è§£å†³é›ªå´©é—®é¢˜çš„é‡è¦æ‰‹æ®µã€‚å…¶æ€è·¯æ˜¯ç”±<font color='red'>æ–­è·¯å™¨</font>ç»Ÿè®¡æœåŠ¡è°ƒç”¨çš„å¼‚å¸¸æ¯”ä¾‹ï¼Œæ…¢è¯·æ±‚æ¯”ä¾‹ï¼Œå¦‚æœè¶…å‡ºé˜ˆå€¼åˆ™ä¼š<font color='red'>ç†”æ–­</font>è¯¥æœåŠ¡ã€‚å³æ‹¦æˆªè®¿é—®è¯¥æœåŠ¡çš„ä¸€åˆ‡è¯·æ±‚ï¼›è€Œå½“è¯·æ±‚æ¢å¤æ—¶ï¼Œæ–­è·¯å™¨ä¼šæ”¾è¡Œè®¿é—®è¯¥æœåŠ¡çš„è¯·æ±‚ã€‚</p>\n<p>æ–­è·¯å™¨å†…éƒ¨ç”±ä¸€ä¸ªçŠ¶æ€æœºæ¥å®ç°çš„ï¼Œè¿™ä¸ªçŠ¶æ€æœºåŒ…å«ä¸‰ç§çŠ¶æ€ï¼Œåˆ†åˆ«æ˜¯ï¼šclosedï¼Œopenï¼ŒHalf-Open</p>\n<p>closed çŠ¶æ€ä¸‹ï¼Œæ–­è·¯å™¨ä¸ä¼šæ‹¦æˆªä»»ä½•è¯·æ±‚ã€‚ä¸ç®¡è¯·æ±‚æ˜¯æ­£å¸¸çš„è¿˜æ˜¯å¼‚å¸¸çš„éƒ½å¯ä»¥è®¿é—®ï¼Œå®ƒä¼šå»ç»Ÿè®¡è°ƒç”¨å¼‚å¸¸çš„æ¯”ä¾‹ï¼Œå¦‚æœç»Ÿè®¡è¿‡ç¨‹ä¸­å‘ç°å¼‚å¸¸æ¯”ä¾‹è¿‡é«˜è¾¾åˆ°äº†é˜ˆå€¼å°±ä¼šä» closed çŠ¶æ€åˆ‡æ¢åˆ° open çŠ¶æ€ã€è¿™æ—¶å°±ä¼šæ‹¦æˆªè¿›å…¥è¯¥æœåŠ¡çš„ä¸€äº›è¯·æ±‚äº†ä¹Ÿå°±ç›¸å½“äºæ˜¯ç†”æ–­äº†ã€‚ç†”æ–­æœ‰ä¸€ä¸ªæŒç»­çš„æ—¶é—´ï¼Œå½“ç†”æ–­æ—¶é—´ç»“æŸå°±ä¼šä» open çŠ¶æ€åˆ‡æ¢åˆ° half-open çŠ¶æ€ (åŠå¼€çŠ¶æ€)ã€‚half-open çŠ¶æ€ä¼šæ”¾è¡Œä¸€æ¬¡è¯·æ±‚ï¼Œç„¶åæ ¹æ®è¿™æ¬¡è¯·æ±‚çš„ç»“æœæ¥åˆ¤æ–­ä¸‹ä¸€æ­¥ã€‚</p>\n<p>æ¯”å¦‚è¯´æ”¾è¡Œä¸€æ¬¡è¯·æ±‚å‘ç°è¿™ä¸ªè¯·æ±‚ä¾èµ–æ˜¯å¤±è´¥çš„é‚£ä¹ˆå°±ä¼šå†æ¬¡è¿›å…¥ open çŠ¶æ€</p>\n<p>å¦‚æœæ”¾è¡Œä¸€æ¬¡è¯·æ±‚æ‰§è¡Œå®Œäº†å‘ç°æ˜¯æˆåŠŸçš„é‚£ä¹ˆå°±ä¼šä» half-open åˆ‡æ¢åˆ° closed çŠ¶æ€</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171422210.png\" alt=\"image-20231017142215093\"></p>\n<p>æˆ‘ä»¬çŸ¥é“æ–­è·¯å™¨è¦æƒ³ä» closed çŠ¶æ€è¿›å…¥åˆ° open çŠ¶æ€éœ€è¦åˆ¤æ–­æœåŠ¡æœ‰æ²¡æœ‰è§¦å‘ç†”æ–­çš„æ¡ä»¶ã€‚è€Œç†”æ–­åˆ¤æ–­çš„æ¡ä»¶å°±æ˜¯ä¾æ®ç†”æ–­ç­–ç•¥æ¥å®Œæˆçš„ï¼Œè€Œåœ¨ Sentinel é‡Œç†”æ–­çš„ç­–ç•¥æœ‰ä¸‰ç§ï¼šæ…¢è°ƒç”¨ï¼Œå¼‚å¸¸æ¯”ä¾‹ï¼Œå¼‚å¸¸æ•°</p>\n<h4 id=\"1631-ç†”æ–­ç­–ç•¥-æ…¢è°ƒç”¨\"><a class=\"markdownIt-Anchor\" href=\"#1631-ç†”æ–­ç­–ç•¥-æ…¢è°ƒç”¨\">#</a> 1.6.3.1ã€ç†”æ–­ç­–ç•¥ - æ…¢è°ƒç”¨ğŸŒ´</h4>\n<p><mark>æ…¢è°ƒç”¨</mark>ï¼šä¸šåŠ¡çš„å“åº”æ—¶é•¿ (RT) å¤§äºæŒ‡å®šæ—¶é•¿çš„è¯·æ±‚è®¤å®šä¸ºæ…¢è°ƒç”¨è¯·æ±‚ã€‚åœ¨æŒ‡å®šæ—¶é—´å†…ï¼Œå¦‚æœè¯·æ±‚æ•°é‡è¶…è¿‡è®¾å®šçš„æœ€å°æ•°é‡ï¼Œæ…¢è°ƒç”¨æ¯”ä¾‹å¤§äºè®¾å®šçš„é˜ˆå€¼ï¼Œåˆ™è§¦å‘ç†”æ–­ã€‚ä¾‹å¦‚ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171428040.png\" alt=\"image-20231017142805647\"></p>\n<p><strong>è§£è¯»</strong>ï¼šRT è¶…è¿‡ 500ms çš„è°ƒç”¨æ˜¯æ…¢è°ƒç”¨ï¼Œç»Ÿè®¡æœ€è¿‘ 10000ms å†…çš„è¯·æ±‚ï¼Œå¦‚æœè¯·æ±‚é‡è¶…è¿‡ 10 æ¬¡ï¼Œå¹¶ä¸”æ…¢è°ƒç”¨æ¯”ä¾‹ä¸ä½äº 0.5ï¼Œåˆ™è§¦å‘ç†”æ–­ï¼Œç†”æ–­æ—¶é•¿ä¸º 5 ç§’ã€‚ç„¶åè¿›å…¥ half-open çŠ¶æ€ï¼Œæ”¾è¡Œä¸€æ¬¡è¯·æ±‚åšæµ‹è¯•ã€‚</p>\n<h5 id=\"16311-æ¡ˆä¾‹ç†”æ–­ç­–ç•¥-æ…¢è°ƒç”¨\"><a class=\"markdownIt-Anchor\" href=\"#16311-æ¡ˆä¾‹ç†”æ–­ç­–ç•¥-æ…¢è°ƒç”¨\">#</a> 1.6.3.1.1ã€æ¡ˆä¾‹ï¼Œç†”æ–­ç­–ç•¥ - æ…¢è°ƒç”¨ğŸ‹</h5>\n<p>éœ€æ±‚ï¼šç»™ UserClient çš„æŸ¥è¯¢ç”¨æˆ·æ¥å£è®¾ç½®é™çº§è§„åˆ™ï¼Œæ…¢è°ƒç”¨çš„ RT é˜ˆå€¼ä¸º 50msï¼Œç»Ÿè®¡æ—¶é—´ä¸º 1 ç§’ï¼Œ æœ€å°è¯·æ±‚æ•°é‡ä¸º 5ï¼Œå¤±è´¥é˜ˆå€¼æ¯”ä¾‹ä¸º 0.4ï¼Œç†”æ–­æ—¶é•¿ä¸º 5</p>\n<p>é—®é¢˜ï¼šæœ¬åœ°è°ƒç”¨æ—¶é—´ä¸å¯èƒ½é‚£ä¹ˆé•¿æ‰€ä»¥ä¸ºäº†èƒ½å¤Ÿè§¦å‘æ…¢è°ƒç”¨éœ€è¦ä¿®æ”¹ä¸€ä¸‹ä¸šåŠ¡ä»£ç è®©å…¶è¶…è¿‡å“åº”æ—¶é—´</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/&#123;id&#125;\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">User</span> <span class=\"token function\">queryById</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@PathVariable</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"id\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">,</span> <span class=\"token annotation punctuation\">@RequestHeader</span><span class=\"token punctuation\">(</span>value <span class=\"token operator\">=</span> <span class=\"token string\">\"Truth\"</span><span class=\"token punctuation\">,</span> required <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">String</span> truth<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>id <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      <span class=\"token comment\">// ä¼‘çœ ï¼Œè§¦å‘ç†”æ–­</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>         <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">60</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>         <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RuntimeException</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>   <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"truth: \"</span> <span class=\"token operator\">+</span> truth<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>   <span class=\"token keyword\">return</span> userService<span class=\"token punctuation\">.</span><span class=\"token function\">queryById</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>é‡å¯ userService æœåŠ¡</p>\n<p>è®¿é—® order/101 æ—¶å°±ä¼šå»è¯·æ±‚ userId ä¸º 1 çš„ç”¨æˆ·</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171439770.png\" alt=\"image-20231017143949635\"></p>\n<p>order/102</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171441135.png\" alt=\"image-20231017144136736\"></p>\n<p>order/101</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171441279.png\" alt=\"image-20231017144150302\"></p>\n<p>å¯ä»¥çœ‹åˆ° 102 è¯·æ±‚æ—¶é•¿åŸºæœ¬ä¸è¶…è¿‡ 10 æ¯«ç§’ï¼Œè€Œ 101 è¯·æ±‚æ—¶é•¿åŸºæœ¬ä¸ä¸‹ 70 æ¯«ç§’ã€‚è¿™æ ·å°±èƒ½æ»¡è¶³æˆ‘ä»¬è§¦å‘é˜ˆå€¼çš„æƒ…å†µäº†</p>\n<p>ç„¶åå°±å¯ä»¥å»é…ç½®ç†”æ–­é™çº§ç­–ç•¥äº†ï¼Œå» Sentinel æ§åˆ¶å°ä¸­</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171445150.png\" alt=\"image-20231017144506913\"></p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171445998.png\" alt=\"image-20231017144515744\"></p>\n<p>ç„¶åæˆ‘ä»¬å°±å¯ä»¥å»è¿›è¡Œæµ‹è¯•äº†ï¼š</p>\n<p>è¿™æ¬¡çš„æµ‹è¯•å¯ä»¥ä¸ç”¨ jmeter äº†ï¼Œå› ä¸ºéœ€è¦ä¸€ç§’å†… 5 æ¬¡è¯·æ±‚ï¼Œæœ‰ 2 æ¬¡è§¦å‘å°±è¡Œäº†å¾ˆå®¹æ˜“å¯ä»¥å»åˆ·æ–° order/{orderId} çš„è¯·æ±‚é¡µé¢</p>\n<p>ç°åœ¨è®¿é—® order/102ï¼Œæ˜¯æ­£å¸¸å¯ä»¥è®¿é—®çš„</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171448397.png\" alt=\"image-20231017144804306\"></p>\n<p>è¿ç»­è¯·æ±‚ 5 æ¬¡ order/101ï¼Œä¹Ÿå°±æ˜¯åˆ·æ–° 5 æ¬¡é¡µé¢</p>\n<p>å†å»è®¿é—® order/102 å°±ä¼šå‘ç° user ä¸­æ²¡æœ‰æ•°æ®äº†ï¼Œå½“ order å»æŸ¥ user çš„é‚£ä¸€åˆ»ç›´æ¥è¢«ç†”æ–­äº†ï¼Œå‹æ ¹æ²¡æœ‰å»æŸ¥ç›´æ¥èµ°é™çº§é€»è¾‘è¿”å› null äº†</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171449564.png\" alt=\"image-20231017144859133\"></p>\n<p>ç­‰å¾… 5 ç§’åå†å»åˆ·æ–°ä¸€ä¸ª order/102 é¡µé¢ï¼Œç†”æ–­å°±å–æ¶ˆäº†å¯ä»¥è¯·æ±‚åˆ° user çš„æ•°æ®äº†</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171451453.png\" alt=\"image-20231017145103496\"></p>\n<h4 id=\"1632-ç†”æ–­ç­–ç•¥-å¼‚å¸¸æ¯”ä¾‹å¼‚å¸¸æ•°\"><a class=\"markdownIt-Anchor\" href=\"#1632-ç†”æ–­ç­–ç•¥-å¼‚å¸¸æ¯”ä¾‹å¼‚å¸¸æ•°\">#</a> 1.6.3.2ã€ç†”æ–­ç­–ç•¥ - å¼‚å¸¸æ¯”ä¾‹ï¼Œå¼‚å¸¸æ•°ğŸŒ´</h4>\n<ul>\n<li><mark>å¼‚å¸¸æ¯”ä¾‹æˆ–å¼‚å¸¸æ•°</mark>ï¼šç»Ÿè®¡æŒ‡å®šæ—¶é—´å†…çš„ è°ƒç”¨ï¼Œå¦‚æœè°ƒç”¨æ¬¡æ•°è¶…è¿‡æŒ‡å®šçš„è¯·æ±‚æ•°ï¼Œå¹¶ä¸”å‡ºç°å¼‚å¸¸çš„æ¯”ä¾‹è¾¾åˆ°è®¾å®šçš„æ¯”ä¾‹é˜ˆå€¼ (æˆ–è¶…è¿‡æŒ‡å®šå¼‚å¸¸æ•°) ï¼Œåˆ™è§¦å‘ç†”æ–­ã€‚ä¾‹å¦‚ï¼š</li>\n</ul>\n<p>æŒ‰ç…§å¼‚å¸¸çš„æ¯”ä¾‹ç†”æ–­</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171454750.png\" alt=\"image-20231017145414614\"></p>\n<p>è¾¾åˆ°å¼‚å¸¸æ•°é‡ç†”æ–­</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171456985.png\" alt=\"image-20231017145619743\"></p>\n<p><strong>è§£è¯»</strong>ï¼šç»Ÿè®¡æœ€è¿‘ 1000ms å†…çš„è¯·æ±‚ï¼Œå¦‚æœè¯·æ±‚é‡è¶…è¿‡ 10 æ¬¡ï¼Œå¹¶ä¸”å¼‚å¸¸æ¯”ä¾‹ä¸ä½äº 0.5ï¼Œåˆ™è§¦å‘ç†”æ–­ï¼Œç†”æ–­æ—¶é•¿ä¸º 5 ç§’ã€‚ç„¶åè¿›å…¥ half-open çŠ¶æ€ï¼Œæ”¾è¡Œä¸€æ¬¡è¯·æ±‚åšæµ‹è¯•ã€‚</p>\n<h5 id=\"16321-æ¡ˆä¾‹ç†”æ–­ç­–ç•¥-å¼‚å¸¸æ¯”ä¾‹\"><a class=\"markdownIt-Anchor\" href=\"#16321-æ¡ˆä¾‹ç†”æ–­ç­–ç•¥-å¼‚å¸¸æ¯”ä¾‹\">#</a> 1.6.3.2.1ã€æ¡ˆä¾‹ï¼Œç†”æ–­ç­–ç•¥ - å¼‚å¸¸æ¯”ä¾‹ğŸ‹</h5>\n<p><strong>éœ€æ±‚</strong>ï¼šç»™ UserClient çš„æŸ¥è¯¢ç”¨æˆ·æ¥å£è®¾ç½®é™çº§è§„åˆ™ï¼Œç»Ÿè®¡æ—¶é—´ä¸º 1 ç§’ï¼Œæœ€å°è¯·æ±‚æ•°é‡ä¸º 5ï¼Œå¤±è´¥é˜ˆå€¼æ¯”ä¾‹ä¸º 0.4ï¼Œç†”æ–­æ—¶é•¿ä¸º 5</p>\n<p><font color='red'>æç¤º</font>ï¼šä¸ºäº†è§¦å‘å¼‚å¸¸ç»Ÿè®¡ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹ UserService ä¸­çš„ä¸šåŠ¡ï¼ŒæŠ›å‡ºå¼‚å¸¸å¦‚ä¸‹ä»£ç ï¼š</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/&#123;id&#125;\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">User</span> <span class=\"token function\">queryById</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@PathVariable</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"id\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">,</span> <span class=\"token annotation punctuation\">@RequestHeader</span><span class=\"token punctuation\">(</span>value <span class=\"token operator\">=</span> <span class=\"token string\">\"Truth\"</span><span class=\"token punctuation\">,</span> required <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">String</span> truth<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>id <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RuntimeException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"æ•…æ„æŠ›å‡ºå¼‚å¸¸ï¼Œè§¦å‘å¼‚å¸¸æ¯”ä¾‹ç†”æ–­\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"truth: \"</span> <span class=\"token operator\">+</span> truth<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   <span class=\"token keyword\">return</span> userService<span class=\"token punctuation\">.</span><span class=\"token function\">queryById</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>ç»™ UserClient æŸ¥è¯¢ç”¨æˆ·æ¥å£è®¾ç½®é™çº§è§„åˆ™</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171511550.png\" alt=\"image-20231017151144666\"></p>\n<p>è®¿é—® order/102</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171512960.png\" alt=\"image-20231017151235103\"></p>\n<p>ç„¶åè¿ç»­è®¿é—® n æ¬¡ order/101</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171516133.png\" alt=\"image-20231017151605944\"></p>\n<p>åœ¨è®¿é—® order/102 å°±å‘ç°è¢«ç†”æ–­äº†</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171515798.png\" alt=\"image-20231017151556049\"></p>\n<blockquote>\n<p><strong>æ€»ç»“</strong>ï¼š</p>\n<p>Sentinel ç†”æ–­é™çº§çš„ç­–ç•¥æœ‰å“ªäº›ï¼Ÿ</p>\n<p>1ã€æ…¢è°ƒç”¨æ¯”ä¾‹ï¼šè¶…è¿‡æŒ‡å®šæ—¶é•¿çš„è°ƒç”¨ä¸ºæ…¢è°ƒç”¨ï¼Œç»Ÿè®¡å•ä½æ—¶é•¿å†…æ…¢è°ƒç”¨çš„æ¯”ä¾‹ï¼Œè¶…è¿‡é˜ˆå€¼åˆ™ç†”æ–­</p>\n<p>2ã€å¼‚å¸¸æ¯”ä¾‹ï¼šç»Ÿè®¡å•ä½æ—¶é•¿å†…å¼‚å¸¸è°ƒç”¨çš„æ¯”ä¾‹ï¼Œè¶…è¿‡é˜ˆå€¼åˆ™ç†”æ–­</p>\n<p>3ã€å¼‚å¸¸æ•°ï¼šç»Ÿè®¡å•ä½æ—¶é•¿å†…å¼‚å¸¸è°ƒç”¨çš„æ¬¡æ•°ï¼Œè¶…è¿‡é˜ˆå€¼åˆ™ç†”æ–­</p>\n</blockquote>\n<h2 id=\"17-æˆæƒè§„åˆ™\"><a class=\"markdownIt-Anchor\" href=\"#17-æˆæƒè§„åˆ™\">#</a> 1.7ã€æˆæƒè§„åˆ™ğŸŒ³</h2>\n<ul>\n<li>æˆæƒè§„åˆ™</li>\n<li>è‡ªå®šä¹‰å¼‚å¸¸ç»“æœ</li>\n</ul>\n<h3 id=\"171-æˆæƒè§„åˆ™\"><a class=\"markdownIt-Anchor\" href=\"#171-æˆæƒè§„åˆ™\">#</a> 1.7.1ã€æˆæƒè§„åˆ™ğŸŒ²</h3>\n<p>æˆæƒè§„åˆ™å¯ä»¥å¯¹è°ƒç”¨æ–¹çš„æ¥æºåšæ§åˆ¶ï¼Œæœ‰ç™½åå•å’Œé»‘åå•ä¸¤ç§æ–¹å¼ã€‚</p>\n<blockquote>\n<p>æˆ‘ä»¬å­¦ä¹ ç½‘å…³çš„æ—¶å€™è®²è¿‡ï¼Œgateway å®ƒä¸å°±æ˜¯æŠŠé—¨çš„å—ã€‚æ‰€æœ‰è¯·æ±‚éƒ½è¦ç»è¿‡ç½‘å…³å»åšèº«ä»½çš„è®¤è¯ï¼Œæ€ä¹ˆåˆ°è¿™å„¿åˆè¦æ•´ä¸€ä¸ªå‘¢ï¼Ÿ</p>\n<p>ä¸‡ä¸€å…¬å¸å‡ºäº†ä¸€ä¸ªå†…é¬¼ï¼Œå®ƒæŠŠå¾®æœåŠ¡åœ°å€æ³„éœ²ç»™äº†å¤–è¾¹å“ªäº›ä¸æ€€å¥½æ„çš„äººï¼Œé‚£è¿™äº›å“¥ä»¬å°±å¯ä»¥ç»•è¿‡ç½‘å…³ç›´æ¥è®¿é—®å¾®æœåŠ¡äº†ã€‚é‚£ç½‘å…³é‡Œåšçš„å†ä¸¥å¯†ä¹Ÿéƒ½æ²¡ç”¨äº†ï¼Œæ‰€ä»¥ Sentinel æˆæƒè§„åˆ™å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚æˆæƒè§„åˆ™ä¼šå»éªŒè¯ä½ è¯·æ±‚ä»å“ªæ¥çš„ã€‚å¦‚æœè¯´ä½ æ˜¯ä»ç½‘å…³è¿‡æ¥çš„é‚£å°±æ”¾è¡Œï¼Œå¦‚æœè¯´ä½ ä»åˆ«çš„åœ°æ–¹æ¥çš„å°±æ‹¦æˆª</p>\n</blockquote>\n<ul>\n<li>ç™½åå•ï¼šæ¥æº (origin) åœ¨ç™½åå•å†…çš„è°ƒç”¨è€…å…è®¸è®¿é—®</li>\n<li>é»‘åå•ï¼šæ¥æº (origin) åœ¨é»‘åå•å†…çš„è°ƒç”¨è€…ä¸å…è®¸è®¿é—®</li>\n</ul>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171530129.png\" alt=\"image-20231017153026632\"></p>\n<p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬é™å®šåªå…è®¸ä»ç½‘å…³æ¥çš„è¯·æ±‚è®¿é—® order-serviceï¼Œé‚£ä¹ˆæµæ§åº”ç”¨ä¸­å°±å¡«å†™ç½‘å…³çš„åç§°</p>\n<p>é‚£ä¹ˆè¿™æ—¶</p>\n<p orderId=\"\">èµ„æºåå¡«çš„å°±æ˜¯ï¼šorder-service é‡Œé¢çš„å—ä¿æŠ¤èµ„æºï¼Œæ¯”æ–¹è¯´ order/</p>\n<p>æµæ§åº”ç”¨å¡«çš„å°±æ˜¯ï¼šå…è®¸çš„è°ƒç”¨è€…çš„åå­— originï¼Œè¯·æ±‚æ¥æºåç§°ï¼Œé‚£ä¹ˆè¯·æ±‚æ¥æºåç§°æ˜¯æ€ä¹ˆå¾—åˆ°çš„å‘¢ï¼Ÿ</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171531533.png\" alt=\"image-20231017153153844\"></p>\n<p>Sentinel æ˜¯é€šè¿‡ RequestOriginParser è¿™ä¸ªæ¥å£çš„ parseOrigin æ¥è·å–è¯·æ±‚çš„æ¥æºçš„ã€‚</p>\n<p>ä½†æ˜¯è¿™ä¸ªæ–¹æ³•çš„è¿”å›ç»“æœåªèƒ½æ˜¯ defaultï¼Œä¹Ÿå°±æ˜¯è¯´æ— è®ºæ˜¯ä»ç½‘å…³è¿‡æ¥è¿˜æ˜¯æµè§ˆå™¨è¿‡æ¥å®ƒçš„æ¥æºåç§°éƒ½å« default</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">RequestOriginParser</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   * ä»è¯·æ±‚ request å¯¹è±¡ä¸­è·å– originï¼Œè·å–æ–¹å¼è‡ªå®šä¹‰</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   */</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   <span class=\"token class-name\">String</span> <span class=\"token function\">parseOrigin</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpServletRequest</span> request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>æ‰€ä»¥æˆ‘ä»¬å¿…é¡»è‡ªå·±æƒ³åŠæ³•å®ç°è¿™ä¸ªæ¥å£ç¼–å†™å®ƒçš„ä¸šåŠ¡é€»è¾‘ï¼Œè®©ä»ç½‘å…³è¿‡æ¥çš„è¯·æ±‚å’Œä»æµè§ˆå™¨è¿‡æ¥çš„è¯·æ±‚è¿”å›ä¸åŒçš„ç»“æœï¼Œè¿™æ ·æ¥æºåç§°ä¸åŒå°±å¯ä»¥ç¼–å†™æˆæƒè§„åˆ™äº†</p>\n<p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬å°è¯•ä» reqeust ä¸­è·å–ä¸€ä¸ªåä¸º origin çš„è¯·æ±‚å¤´ï¼Œä½œä¸º origin çš„å€¼ï¼š</p>\n<p>è¿™é‡Œ gateway è®¿é—®æ¶ˆè´¹è€…ä¹Ÿå°±æ˜¯ orderservice æœåŠ¡æ‰€ä»¥ä¸‹é¢ä¸šåŠ¡ä»£ç æ˜¯å†™åˆ° order æœåŠ¡ä¸­çš„</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Component</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">HeaderOriginParser</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">RequestOriginParser</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">parseOrigin</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpServletRequest</span> request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token comment\">// 1. è·å–è¯·æ±‚å¤´</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token class-name\">String</span> header <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span><span class=\"token function\">getHeader</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"origin\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token comment\">// 2. éç©ºåˆ¤æ–­</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">StringUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEmpty</span><span class=\"token punctuation\">(</span>header<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            header <span class=\"token operator\">=</span> <span class=\"token string\">\"blank\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token keyword\">return</span> header<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>æˆ‘ä»¬è¿˜éœ€è¦åœ¨ gateway æœåŠ¡ä¸­ï¼Œåˆ©ç”¨ç½‘å…³çš„è¿‡æ»¤å™¨æ·»åŠ åä¸º gateway çš„ origin å¤´</p>\n<figure class=\"highlight yml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">cloud</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token key atrule\">gateway</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      <span class=\"token key atrule\">default-filters</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token punctuation\">-</span> AddRequestHeader=origin<span class=\"token punctuation\">,</span>gateway <span class=\"token comment\"># æ·»åŠ åä¸º origin çš„è¯·æ±‚å¤´ï¼Œå€¼ä¸º gateway</span></pre></td></tr></table></figure><p>é‡å¯ orderservice æœåŠ¡å’Œ gateway æœåŠ¡</p>\n<p>éšä¾¿è®¿é—®ä¸€ä¸ª uriï¼š<a href=\"http://localhost:8088/order/101\">http://localhost:8088/order/101</a></p>\n<p>ç„¶åæŸ¥çœ‹ Sentinel æ§åˆ¶å°ä¸­çš„è”Ÿç‚¹é“¾è·¯</p>\n<p>ç„¶åæˆ‘ä»¬å°±å¯ä»¥ç»™ /order/{orderId} é…ç½®æˆæƒè§„åˆ™ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171605527.png\" alt=\"image-20231017160506456\"></p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171605725.png\" alt=\"image-20231017160532751\"></p>\n<p>æ­¤æ—¶æˆ‘ä»¬å†å»è®¿é—® order/101 æœåŠ¡</p>\n<p>æ³¨æ„ï¼šè¿™é‡Œ order/101 æ˜¯ç»•è¿‡äº†ç½‘å…³çš„</p>\n<p>è®¿é—®æ˜¯ä¸æˆåŠŸçš„ã€‚</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171605535.png\" alt=\"image-20231017160543084\"></p>\n<p>é‚£æˆ‘ä»¬ä½¿ç”¨ç½‘å…³è¿›è¡Œè®¿é—®çš„</p>\n<p>å¯ä»¥æ­£å¸¸è®¿é—®</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171606887.png\" alt=\"image-20231017160611726\"></p>\n<p>ä½†æ˜¯ç”±äºä¸Šé¢ç›´æ¥è·³è¿‡ç½‘å…³è®¿é—® order/101 çš„æ—¶å€™å°±ä¼šæŠ¥é”™ï¼Œé¡µé¢çš„æŠ¥é”™æç¤ºå¦‚ä¸‹ï¼š</p>\n<p>è¯´æ˜¯é™æµå¼‚å¸¸è¿™å°±ä¸åˆç†äº†ï¼Œæ˜æ˜æ˜¯æˆæƒå¼‚å¸¸æ€ä¹ˆå°±é™æµå¼‚å¸¸äº†å‘¢</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171609433.png\" alt=\"image-20231017160543084\"></p>\n<p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å¯¹å…¶è¿›è¡Œè‡ªå®šä¹‰å¼‚å¸¸ï¼š</p>\n<h3 id=\"172-è‡ªå®šä¹‰å¼‚å¸¸ç»“æœ\"><a class=\"markdownIt-Anchor\" href=\"#172-è‡ªå®šä¹‰å¼‚å¸¸ç»“æœ\">#</a> 1.7.2ã€è‡ªå®šä¹‰å¼‚å¸¸ç»“æœğŸŒ²</h3>\n<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå‘ç”Ÿé™æµï¼Œé™çº§ï¼Œæˆæƒæ‹¦æˆªæ—¶ï¼Œéƒ½ä¼šæŠ›å‡ºå¼‚å¸¸åˆ°è°ƒç”¨æ–¹ã€‚å¦‚æœè¦è‡ªå®šä¹‰å¼‚å¸¸æ—¶çš„è¿”å›ç»“æœï¼Œéœ€è¦å®ç° BlockExceptionHanlder æ¥å£ï¼š</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">BlockExcpetionHandler</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   * å¤„ç†è¯·æ±‚è¢«é™æµï¼Œé™çº§ï¼Œæˆæƒæ‹¦æˆªæ—¶æŠ›å‡ºçš„å¼‚å¸¸ï¼šBlockException</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   */</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   <span class=\"token keyword\">void</span> <span class=\"token function\">handle</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpServletRequest</span> request<span class=\"token punctuation\">,</span> <span class=\"token class-name\">HttpServletResponse</span> response<span class=\"token punctuation\">,</span> <span class=\"token class-name\">BlockExcpetion</span> e<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>è€Œ BlockException åŒ…å«å¾ˆå¤šä¸ªå­ç±»ï¼Œåˆ†åˆ«å¯¹åº”ä¸åŒçš„åœºæ™¯ï¼š</p>\n<table>\n<thead>\n<tr>\n<th>å¼‚å¸¸</th>\n<th>è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>FlowException</td>\n<td>é™æµå¼‚å¸¸</td>\n</tr>\n<tr>\n<td>ParamFlowException</td>\n<td>çƒ­ç‚¹å‚æ•°é™æµçš„å¼‚å¸¸</td>\n</tr>\n<tr>\n<td>DegradeException</td>\n<td>é™çº§å¼‚å¸¸</td>\n</tr>\n<tr>\n<td>AuthorityException</td>\n<td>æˆæƒè§„åˆ™å¼‚å¸¸</td>\n</tr>\n<tr>\n<td>SystemBlockException</td>\n<td>ç³»ç»Ÿè§„åˆ™å¼‚å¸¸</td>\n</tr>\n</tbody>\n</table>\n<p>æˆ‘ä»¬åœ¨ order-service ä¸­å®šä¹‰ç±»ï¼Œå®ç° BlockExceptionHandler æ¥å£ï¼š</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Component</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">SentinelBlockHandler</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">BlockExceptionHandler</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">handle</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpServletRequest</span> httpServletRequest<span class=\"token punctuation\">,</span> <span class=\"token class-name\">HttpServletResponse</span> response<span class=\"token punctuation\">,</span> <span class=\"token class-name\">BlockException</span> e<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token class-name\">String</span> msg <span class=\"token operator\">=</span> <span class=\"token string\">\"æœªçŸ¥å¼‚å¸¸\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">int</span> status <span class=\"token operator\">=</span> <span class=\"token number\">429</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>e <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">FlowException</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            msg <span class=\"token operator\">=</span> <span class=\"token string\">\"è¯·æ±‚è¢«é™æµäº† !\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>e <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">DegradeException</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            msg <span class=\"token operator\">=</span> <span class=\"token string\">\"è¯·æ±‚è¢«é™çº§äº† !\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>e <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">ParamFlowException</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            msg <span class=\"token operator\">=</span> <span class=\"token string\">\"çƒ­ç‚¹å‚æ•°é™æµ !\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>e <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">AuthorityException</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            msg <span class=\"token operator\">=</span> <span class=\"token string\">\"è¯·æ±‚æ²¡æœ‰æƒé™ !\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            status <span class=\"token operator\">=</span> <span class=\"token number\">401</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        response<span class=\"token punctuation\">.</span><span class=\"token function\">setContentType</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"application/json;charset=utf-8\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        response<span class=\"token punctuation\">.</span><span class=\"token function\">setStatus</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        response<span class=\"token punctuation\">.</span><span class=\"token function\">getWriter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"&#123;\\\"message\\\": \\\"\"</span> <span class=\"token operator\">+</span> msg <span class=\"token operator\">+</span> <span class=\"token string\">\"\\\",\\\"status\\\": \"</span> <span class=\"token operator\">+</span> status <span class=\"token operator\">+</span> <span class=\"token string\">\"&#125;\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>é‡å¯ orderservice æœåŠ¡ï¼Œç„¶åè®¿é—®ä¸€ä¸‹ order/101ã€‚å†å» Sentinel æ§åˆ¶å°æŸ¥çœ‹è”Ÿç‚¹é“¾è·¯å¹¶æ·»åŠ æˆæƒè§„åˆ™ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171629649.png\" alt=\"image-20231017162948414\"></p>\n<p>ç„¶åå†å¯¹ order/101 è¿›è¡Œç›´æ¥è®¿é—®</p>\n<p>å¯ä»¥çœ‹åˆ°è‡ªå®šä¹‰å¼‚å¸¸æˆåŠŸäº†ï¼</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171630717.png\" alt=\"image-20231017163007309\"></p>\n<blockquote>\n<p><strong>æ€»ç»“</strong>ï¼š</p>\n<p>è·å–è¯·æ±‚æ¥æºçš„æ¥å£æ˜¯ä»€ä¹ˆï¼Ÿ</p>\n<ul>\n<li>RequestOriginParser</li>\n</ul>\n<p>å¤„ç† BlockException çš„æ¥å£æ˜¯ä»€ä¹ˆ</p>\n<ul>\n<li>BlockExcpetionHandler</li>\n</ul>\n</blockquote>\n<h2 id=\"18-è§„åˆ™æŒä¹…åŒ–\"><a class=\"markdownIt-Anchor\" href=\"#18-è§„åˆ™æŒä¹…åŒ–\">#</a> 1.8ã€è§„åˆ™æŒä¹…åŒ–ğŸŒ³</h2>\n<ul>\n<li>è§„åˆ™ç®¡ç†æ¨¡å¼</li>\n<li>å®ç° push æ¨¡å¼</li>\n</ul>\n<p>Sentinel çš„æ§åˆ¶å°è§„åˆ™ç®¡ç†æœ‰ä¸‰ç§æ¨¡å¼ï¼š</p>\n<ul>\n<li>åŸå§‹æ¨¡å¼ï¼šSentinel çš„é»˜è®¤æ¨¡å¼ï¼Œå°†è§„åˆ™ä¿å­˜åœ¨å†…å­˜ï¼Œé‡å¯æœåŠ¡ä¼šä¸¢å¤±ã€‚</li>\n<li>pull æ¨¡å¼</li>\n<li>push æ¨¡å¼</li>\n</ul>\n<h3 id=\"181-è§„åˆ™ç®¡ç†æ¨¡å¼-pullæ¨¡å¼\"><a class=\"markdownIt-Anchor\" href=\"#181-è§„åˆ™ç®¡ç†æ¨¡å¼-pullæ¨¡å¼\">#</a> 1.8.1ã€è§„åˆ™ç®¡ç†æ¨¡å¼ - pull æ¨¡å¼ğŸŒ²</h3>\n<p>pull æ¨¡å¼ï¼šæ§åˆ¶å°å°†é…ç½®çš„è§„åˆ™æ¨é€åˆ° Sentinel å®¢æˆ·ç«¯ï¼Œè€Œå®¢æˆ·ç«¯ä¼šå°†é…ç½®è§„åˆ™ä¿å­˜åœ¨æœ¬åœ°æ–‡ä»¶æˆ–æ•°æ®åº“ä¸­ã€‚ä»¥åä¼šå®šæ—¶å»æœ¬åœ°æ–‡ä»¶æˆ–æ•°æ®åº“ä¸­æŸ¥è¯¢ï¼Œæ›´æ–°æœ¬åœ°è§„åˆ™ã€‚</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171635037.png\" alt=\"image-20231017163548813\"></p>\n<p>ç¼ºç‚¹ï¼šå­˜åœ¨æ—¶æ•ˆæ€§é—®é¢˜ï¼Œä»è€Œå¯¼è‡´æ•°æ®çš„ä¸ä¸€è‡´é—®é¢˜</p>\n<h3 id=\"182-è§„åˆ™ç®¡ç†æ¨¡å¼-pushæ¨¡å¼\"><a class=\"markdownIt-Anchor\" href=\"#182-è§„åˆ™ç®¡ç†æ¨¡å¼-pushæ¨¡å¼\">#</a> 1.8.2ã€è§„åˆ™ç®¡ç†æ¨¡å¼ - push æ¨¡å¼ğŸŒ²</h3>\n<p>push æ¨¡å¼ï¼šæ§åˆ¶å°å°†é…ç½®è§„åˆ™æ¨é€åˆ°è¿œç¨‹é…ç½®ä¸­å¿ƒï¼Œä¾‹å¦‚ Nacosã€‚Sentinel å®¢æˆ·ç«¯ç›‘å¬ Nacosï¼Œè·å–é…ç½®å˜æ›´çš„æ¨é€æ¶ˆæ¯ï¼Œå®Œæˆæœ¬åœ°é…ç½®æ›´æ–°</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171639844.png\" alt=\"image-20231017163912849\"></p>\n<blockquote>\n<p><strong>æ€»ç»“</strong>ï¼š</p>\n<p>Sentinel çš„ä¸‰ç§é…ç½®ç®¡ç†æ¨¡å¼æ˜¯ä»€ä¹ˆï¼Ÿ</p>\n<ul>\n<li>\n<p>åŸå§‹æ¨¡å¼ï¼šä¿å­˜åœ¨å†…å­˜</p>\n<p>ä¸æ”¯æŒæŒä¹…åŒ–</p>\n</li>\n<li>\n<p>pull æ¨¡å¼ï¼šä¿å­˜åœ¨æœ¬åœ°æ–‡ä»¶æˆ–æ•°æ®åº“ï¼Œå®šæ—¶å»è¯»å–</p>\n<p>å®šæ—¶è½®è¯¢å­˜åœ¨æ—¶æ•ˆæ€§é—®é¢˜ï¼Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´</p>\n</li>\n<li>\n<p>push æ¨¡å¼ï¼šä¿å­˜åœ¨ Nacosï¼Œç›‘å¬å˜æ›´å®æ—¶æ›´æ–°</p>\n</li>\n</ul>\n</blockquote>\n<h3 id=\"183-å®ç°pushæ¨¡å¼\"><a class=\"markdownIt-Anchor\" href=\"#183-å®ç°pushæ¨¡å¼\">#</a> 1.8.3ã€å®ç° push æ¨¡å¼ğŸŒ²</h3>\n<p>push æ¨¡å¼å®ç°æœ€ä¸ºå¤æ‚ï¼Œä¾èµ–äº Nacosï¼Œå¹¶ä¸”éœ€è¦ä¿®æ”¹ Sentinel æ§åˆ¶å°æºç ã€‚</p>\n<p>è¯¦ç»†æ­¥éª¤å¯ä»¥å‚è€ƒæ–‡ç« <a href=\"../sentinel%E6%8C%81%E4%B9%85%E5%8C%96/sentinel%E8%A7%84%E5%88%99%E6%8C%81%E4%B9%85%E5%8C%96.md\"> sentinel è§„åˆ™æŒä¹…åŒ–</a>.</p>\n<h1 id=\"äºŒ-åˆ†å¸ƒå¼äº‹åŠ¡\"><a class=\"markdownIt-Anchor\" href=\"#äºŒ-åˆ†å¸ƒå¼äº‹åŠ¡\">#</a> äºŒã€åˆ†å¸ƒå¼äº‹åŠ¡ğŸ„</h1>\n<ul>\n<li>seata</li>\n</ul>\n<p><strong>äº‹åŠ¡çš„ ACID åŸåˆ™</strong></p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171718973.png\" alt=\"image-20231017171810630\"></p>\n<h2 id=\"21-åˆ†å¸ƒå¼æœåŠ¡æ¡ˆä¾‹\"><a class=\"markdownIt-Anchor\" href=\"#21-åˆ†å¸ƒå¼æœåŠ¡æ¡ˆä¾‹\">#</a> 2.1ã€åˆ†å¸ƒå¼æœåŠ¡æ¡ˆä¾‹ğŸŒ³</h2>\n<p>å¾®æœåŠ¡ä¸‹å•ä¸šåŠ¡ï¼Œåœ¨ä¸‹å•æ—¶ä¼šè°ƒç”¨è®¢å•æœåŠ¡ï¼Œåˆ›å»ºè®¢å•å¹¶å†™å…¥æ•°æ®åº“ã€‚ç„¶åè®¢å•æœåŠ¡è°ƒç”¨è´¦æˆ·æœåŠ¡å’Œåº“å­˜æœåŠ¡ï¼š</p>\n<ul>\n<li>è´¦æˆ·æœåŠ¡è´Ÿè´£æ‰£å‡ç”¨æˆ·ä½™é¢</li>\n<li>åº“å­˜æœåŠ¡è´Ÿè´£æ‰£å‡å•†å“åº“å­˜</li>\n</ul>\n<p>æ¯”æ–¹è¯´ä»¥ä¸‹å¾®æœåŠ¡ï¼šé‡Œé¢åŒ…å«ä¸‰ä¸ªæœåŠ¡ è®¢å•æœåŠ¡ï¼Œè´¦æˆ·æœåŠ¡ï¼Œåº“å­˜æœåŠ¡ã€‚ç°åœ¨æœ‰ä¸€ä¸ªç”¨æˆ·ä¸‹å•çš„ä¸šåŠ¡ï¼Œç”¨æˆ·ä¸‹å•æ—¶æˆ‘å¸Œæœ›è®¢å•æœåŠ¡å»åˆ›å»ºè®¢å•å¹¶ä¸”å†™å…¥æ•°æ®åº“ï¼Œè€Œåå®ƒå†å»è°ƒç”¨è´¦æˆ·æœåŠ¡å’Œåº“å­˜æœåŠ¡ã€‚è´¦æˆ·æœåŠ¡å»æ‰£å‡ç”¨æˆ·çš„ä½™é¢ï¼Œè€Œåº“å­˜æœåŠ¡åˆ™å»æ‰£å‡å•†å“åº“å­˜ã€‚é‡Œé¢å°±åŒ…å«äº†ä¸‰ä¸ªä¸åŒçš„å¾®æœåŠ¡è°ƒç”¨ï¼Œè€Œæ¯ä¸ªå¾®æœåŠ¡éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„æ•°æ®åº“ï¼Œä¹Ÿå°±æ˜¯ç‹¬ç«‹çš„äº‹åŠ¡ã€‚æœ€ç»ˆå¸Œæœ›çš„è‚¯å®šæ˜¯ä¸‹å•ä¸šåŠ¡ä¸€æ—¦æ‰§è¡Œæ¯ä¸€ä¸ªæœåŠ¡éƒ½è¦æˆåŠŸï¼Œå¦‚æœå¤±è´¥éƒ½å¤±è´¥ã€‚ä½†æ˜¯èƒ½ä¸èƒ½è¾¾åˆ°è¿™æ ·çš„ç»“æœå‘¢ä¸‹é¢è¿›è¡ŒéªŒè¯</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171720793.png\" alt=\"image-20231017172030706\"></p>\n<h2 id=\"22-æ¼”ç¤ºåˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜\"><a class=\"markdownIt-Anchor\" href=\"#22-æ¼”ç¤ºåˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜\">#</a> 2.2ã€æ¼”ç¤ºåˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜ ğŸŒ³</h2>\n<p>åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸‹ï¼Œä¸€ä¸ªä¸šåŠ¡è·¨è¶Šå¤šä¸ªæœåŠ¡æˆ–æ•°æ®æºï¼Œæ¯ä¸ªæœåŠ¡éƒ½æ˜¯ä¸€ä¸ªåˆ†æ”¯äº‹åŠ¡ï¼Œè¦ä¿è¯æ‰€æœ‰åˆ†æ”¯äº‹åŠ¡æœ€ç»ˆçŠ¶æ€ä¸€è‡´è¿™æ ·çš„äº‹åŠ¡å°±æ˜¯<font color='red'>åˆ†å¸ƒå¼äº‹åŠ¡</font>.</p>\n<p>1ã€å¯¼å…¥å¾®æœåŠ¡é¡¹ç›®ï¼š<a href=\"https://gitee.com/doukaixin/typora.git\">https://gitee.com/doukaixin/typora.git</a></p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171737590.png\" alt=\"image-20231017173700559\"></p>\n<p>2ã€åˆ›å»ºæ•°æ®åº“ï¼Œåä¸º seata_demoï¼Œç„¶åå¯¼å…¥ SQL æ–‡ä»¶ï¼Œæ”¹ SQL æ–‡ä»¶åœ¨ seata-demo é¡¹ç›®ä¸­çš„ SQL æ–‡ä»¶å¤¹ä¸­</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171737039.png\" alt=\"image-20231017173733114\"></p>\n<p>3ã€å¯åŠ¨ nacosï¼Œæ‰€æœ‰å¾®æœåŠ¡</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171955624.png\" alt=\"image-20231017195536248\"></p>\n<p>4ã€æµ‹è¯•ä¸‹å•åŠŸèƒ½ï¼Œå‘é€ Post è¯·æ±‚</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171956965.png\" alt=\"image-20231017195605740\"></p>\n<p>å‘é€è¯·æ±‚åæŸ¥çœ‹æ•°æ®åº“</p>\n<p>è´¦æˆ·è¡¨</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171956775.png\" alt=\"image-20231017195643886\"></p>\n<p>åº“å­˜è¡¨</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171957799.png\" alt=\"image-20231017195701407\"></p>\n<p>å¯ä»¥å‘ç°ï¼Œè´¦æˆ·ä½™é¢æ‰£äº† 200 å˜æˆäº† 800ï¼Œè€Œåº“å­˜æ‰£äº† 2 å˜æˆäº† 8</p>\n<p>é‚£ä¹ˆæˆ‘ä»¬è®©æ‰£é™¤åº“å­˜çš„æ—¶å€™æŠ¥é”™çœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆæƒ…å†µã€‚</p>\n<p>ç°åœ¨åº“å­˜ä¸å¤Ÿ 10 ä¸ªäº†æˆ‘è¯·æ±‚æ‰£ 10 ä¸ªå°±ä¼šå‘ç”ŸæŠ¥é”™ã€‚</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171958176.png\" alt=\"image-20231017195804119\"></p>\n<p>å¯ä»¥çœ‹åˆ°å“åº”ç»“æœ 500 äº†</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171958776.png\" alt=\"image-20231017195845362\"></p>\n<p>æ­¤æ—¶æˆ‘ä»¬å†æŸ¥çœ‹æ•°æ®åº“çš„æƒ…å†µ</p>\n<p>è´¦æˆ·è¡¨</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171959625.png\" alt=\"image-20231017195918162\"></p>\n<p>åº“å­˜è¡¨</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310171959448.png\" alt=\"image-20231017195930412\"></p>\n<p>è´¦æˆ·è¡¨çš„ä½™é¢è¢«æ‰£äº† 200ï¼Œä½†æ˜¯åº“å­˜è¡¨çš„æ•°é‡å´æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œè¿™æ ·æ˜¾ç„¶æ˜¯ä¸åˆç†çš„ã€‚</p>\n<p>ä¸‹é¢æˆ‘ä»¬æ¥åˆ†æä¸‹è¿™ä»¶äº‹å„¿ã€‚</p>\n<p>åœ¨ä¸Šé¢çš„ä¸šåŠ¡ä¸­ï¼Œè®¢å•æœåŠ¡å»åˆ›å»ºäº†è®¢å•ç„¶åå»è°ƒç”¨äº†è´¦æˆ·æœåŠ¡å’Œåº“å­˜æœåŠ¡å®Œæˆä½™é¢æ‰£å‡å’Œåº“å­˜æ‰£å‡ï¼Œå…¶ä¸­è®¢å•æœåŠ¡å’Œè´¦æˆ·æœåŠ¡éƒ½åˆ›å»ºæˆåŠŸäº†ã€‚è€Œåº“å­˜æœåŠ¡åœ¨æ‰§è¡Œçš„æ—¶å€™å´å› ä¸ºåº“å­˜ä¸è¶³è€Œå¤±è´¥äº†ã€‚é‚£æŒ‰ç…§ç†è®ºä¸Šè®²è¿™é‡ŒæŠ¥é”™å‰é¢éƒ½åº”è¯¥è·Ÿç€å›æ»š</p>\n<p>åŸå› ï¼š</p>\n<p>1ã€æ¯ä¸ªæœåŠ¡éƒ½æ˜¯ç‹¬ç«‹çš„åº“å­˜æœåŠ¡æŠ›å‡ºå¼‚å¸¸å…¶å®ƒæœåŠ¡ä¹Ÿä¸çŸ¥é“</p>\n<p>2ã€æ¯ä¸ªæœåŠ¡éƒ½æ˜¯ç‹¬ç«‹çš„æ‰€ä»¥å®ƒä»¬çš„äº‹åŠ¡ä¹Ÿæ˜¯ç‹¬ç«‹çš„</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310172023838.png\" alt=\"image-20231017202319388\"></p>\n<p>å¦‚æœè¦è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡çš„é—®é¢˜ï¼Œé¦–å…ˆè¦è€ƒè™‘å››ç‚¹ï¼š</p>\n<p>é¦–å…ˆç¬¬ä¸€ç‚¹ï¼šåˆ†å¸ƒå¼äº‹åŠ¡äº§ç”Ÿçš„åŸå› ï¼Œè¿™ä¸ªä¸Šè¿°åˆ†æè¿‡äº†ã€‚</p>\n<p>ç¬¬äºŒç‚¹ï¼šç†è§£ç†è®ºåŸºç¡€</p>\n<p>ç¬¬ä¸‰ç‚¹ï¼šå¼„æ¸… seata åŸç†</p>\n<p>ç¬¬å››ç‚¹ï¼šåˆ©ç”¨ seata æ‰‹åŠ¨å®è·µï¼Œè§£å†³åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310172032081.png\" alt=\"image-20231017203228913\"></p>\n<p>å­¦ä¹ å†…å®¹ï¼š</p>\n<ul>\n<li>ç†è®ºåŸºç¡€</li>\n<li>åˆå§‹ Seata</li>\n<li>æ‰‹åŠ¨å®è·µ</li>\n<li>é«˜å¯ç”¨</li>\n</ul>\n<h2 id=\"23-ç†è®ºåŸºç¡€\"><a class=\"markdownIt-Anchor\" href=\"#23-ç†è®ºåŸºç¡€\">#</a> 2.3ã€ç†è®ºåŸºç¡€ğŸŒ³</h2>\n<ul>\n<li>CAP å®šç†</li>\n<li>BASE ç†è®º</li>\n</ul>\n<h3 id=\"231-capå®šç†\"><a class=\"markdownIt-Anchor\" href=\"#231-capå®šç†\">#</a> 2.3.1ã€CAP å®šç†ğŸŒ²</h3>\n<p>1998 å¹´ï¼ŒåŠ å·å¤§å­¦çš„è®¡ç®—æœºç§‘å­¦ Eric Brewer æå‡ºï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿæœ‰ä¸‰ä¸ªæŒ‡æ ‡ï¼š</p>\n<p>1ã€Consistency (ä¸€è‡´æ€§)</p>\n<p>2ã€Availability (å¯ç”¨æ€§)</p>\n<p>3ã€Partition tolerance (åˆ†åŒºå®¹é”™æ€§)</p>\n<p>Eric Brewer è¯´ï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿæ— æ³•åŒæ—¶æ»¡è¶³è¿™ä¸‰ä¸ªæŒ‡æ ‡ã€‚</p>\n<p>è¿™ä¸ªç»“è®ºå°±å«åš CAP å®šç†ã€‚</p>\n<p>ä¸‰ä¸ªåœ†ä¸ä¼šåŒæ—¶é‡å ï¼Œæœ€å¤šä¸¤ä¸¤é‡å ï¼Œä¹Ÿå°±æ˜¯è¯´åŒæ—¶æ»¡è¶³ä¸¤ä¸ª</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310172037268.png\" alt=\"image-20231017203753986\"></p>\n<h4 id=\"2311-capå®šç†-consistency\"><a class=\"markdownIt-Anchor\" href=\"#2311-capå®šç†-consistency\">#</a> 2.3.1.1ã€CAP å®šç† - ConsistencyğŸŒ´</h4>\n<p>Consistency (ä¸€è‡´æ€§) ï¼šç”¨æˆ·è®¿é—®åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„ä»»æ„èŠ‚ç‚¹ï¼Œå¾—åˆ°çš„æ•°æ®å¿…é¡»ä¸€è‡´</p>\n<p>æ¯”æ–¹è¯´æœ‰ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¸Šæœ‰ä¸ªæ•°æ®å« data å€¼ä¸º 0ï¼Œç¬¬äºŒä¸ªèŠ‚ç‚¹ä¹Ÿæ˜¯å¦‚æ­¤ã€‚ç°åœ¨ç”¨æˆ·ä¸ç®¡æ˜¯è®¿é—®å“ªä¸ªèŠ‚ç‚¹ï¼Œç»“æœéƒ½æ˜¯ä¸€æ ·çš„ã€‚</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310172043065.png\" alt=\"image-20231017204312228\"></p>\n<p>ä½†æ˜¯ï¼Œå¦‚æœæˆ‘å¯¹èŠ‚ç‚¹ node1 çš„æ•°æ®è¿›è¡Œäº†ä¿®æ”¹ï¼Œè¿™æ—¶ä¸¤ä¸ªèŠ‚ç‚¹çš„æ•°æ®å°±ä¸ä¸€æ ·äº†ã€‚</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310172044702.png\" alt=\"image-20231017204437374\"></p>\n<p>ä¸ºäº†æ»¡è¶³ä¸€è‡´æ€§å°±ä¸€å®šè¦æŠŠ node1 çš„æ•°æ®åŒæ­¥åˆ° node2 ä¸­ï¼Œä¸€æ—¦æ•°æ®åŒæ­¥å®Œæˆï¼Œæ•°æ®å°±å†æ­¤ä¸€è‡´äº†</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310172044179.png\" alt=\"image-20231017204454104\"></p>\n<p>æ‰€ä»¥ï¼Œä½œä¸ºä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿåœ¨åšæ•°æ®å¤‡ä»½çš„æ—¶å€™ä¸€å®šè¦åŠæ—¶å®Œæˆæ•°æ®åŒæ­¥è¿™æ ·æ‰èƒ½æ»¡è¶³ä¸€è‡´æ€§</p>\n<h4 id=\"2312-capå®šç†-availability\"><a class=\"markdownIt-Anchor\" href=\"#2312-capå®šç†-availability\">#</a> 2.3.1.2ã€CAP å®šç† - AvailabilityğŸŒ´</h4>\n<p>Availability (å¯ç”¨æ€§) ï¼šç”¨æˆ·è®¿é—®é›†ç¾¤ä¸­çš„ä»»æ„å¥åº·èŠ‚ç‚¹ï¼Œå¿…é¡»èƒ½å¾—åˆ°å“åº”ï¼Œè€Œä¸æ˜¯è¶…æ—¶æˆ–æ‹’ç»</p>\n<p>æ¯”å¦‚è¯´ node3 çš„è¯·æ±‚è¢«é˜»å¡æˆ–è€…æ‹’ç»äº†ï¼Œé‚£æ‰€æœ‰çš„è¯·æ±‚è¿›æ¥æ— æ³•è®¿é—®äº†ï¼Œè¿™æ—¶ node3 å°±æ˜¯ä¸å¯ç”¨äº†</p>\n<p>æ‰€ä»¥å¯ç”¨æ€§æ˜¯æŒ‡è¿™ä¸ªèŠ‚ç‚¹èƒ½ä¸èƒ½è¢«æ­£å¸¸çš„è®¿é—®</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310172048465.png\" alt=\"image-20231017204818409\"></p>\n<h4 id=\"2313-capå®šç†-partition-tolerance\"><a class=\"markdownIt-Anchor\" href=\"#2313-capå®šç†-partition-tolerance\">#</a> 2.3.1.3ã€CAP å®šç† - Partition toleranceğŸŒ´</h4>\n<p>Partition (åˆ†åŒº) ï¼šå› ä¸ºç½‘ç»œæ•…éšœæˆ–å…¶å®ƒåŸå› å¯¼è‡´åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„éƒ¨åˆ†èŠ‚ç‚¹ä¸å…¶å®ƒèŠ‚ç‚¹å¤±å»è¿æ¥ï¼Œå½¢æˆç‹¬ç«‹åˆ†åŒºã€‚</p>\n<p>Tolerance (å®¹é”™) ï¼šåœ¨é›†ç¾¤å‡ºç°åˆ†åŒºæ—¶ï¼Œæ•´ä¸ªç³»ç»Ÿä¹Ÿè¦æŒç»­å¯¹å¤–æä¾›æœåŠ¡</p>\n<p>æ¯”å¦‚è¯´ node3 å› ä¸ºç½‘ç»œæ•…éšœä¸ node1 ä¸ node2 æ–­å¼€äº†è¿æ¥ã€‚node1 ä¸ node2 ä¹‹é—´æ­£å¸¸è®¿é—®ã€‚</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310172052718.png\" alt=\"image-20231017205201677\"></p>\n<p>æ­¤æ—¶æ•´ä¸ªé›†ç¾¤å°±ä¼šè¢«åˆ’åˆ†æˆä¸¤ä¸ªåŒºäº†ã€‚node1 å’Œ node2 å®ƒä¿©æ˜¯ä¸€ä¸ªåŒºï¼Œnode3 è‡ªå·±æ˜¯ä¸€ä¸ªåŒºï¼Œè¿™æ—¶å¦‚æœæœ‰ç”¨æˆ·å‘ node2 å†™å…¥äº†ä¸€ä¸ªæ•°æ®ï¼Œnode2 å¯ä»¥æŠŠæ•°æ®åŒæ­¥ç»™ node1 çš„ä½†æ˜¯ node3 ä¸Šä¸èƒ½åŒæ­¥åˆ°æ•°æ®ï¼Œå› æ­¤è¿™ä¸¤ä¸ªåŒºçš„æ•°æ®å°±ä¸ä¸€è‡´äº†</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310172055775.png\" alt=\"image-20231017205544452\"></p>\n<p>é‚£å¦‚æœæˆ‘ä¸€å®šè¦æ»¡è¶³æ•°æ®çš„ä¸€è‡´æ€§å‘¢ï¼Œé‚£æˆ‘æ˜¯ä¸æ˜¯å¯ä»¥è®© node3 ç­‰å¾… node2 ç½‘ç»œçš„æ¢å¤å’Œæ•°æ®çš„åŒæ­¥ï¼Œåœ¨æ¢å¤ä¹‹å‰æ‰€æœ‰æ¥è®¿é—®æˆ‘çš„è¯·æ±‚æˆ‘éƒ½é˜»å¡åœ¨è¿™é‡Œã€‚å¦‚æœè¿™ä¹ˆåšå¯èƒ½ä¼šæ»¡è¶³æ•°æ®çš„ä¸€è‡´æ€§ï¼Œä½†æ˜¯ node3 æ˜æ˜æ˜¯ä¸€ä¸ªå¥åº·çš„èŠ‚ç‚¹ç»“æœè¿›æ¥çš„è¯·æ±‚ä½ éƒ½å¡åœ¨è¿™é‡Œä¸è®©äººå®¶è®¿é—®ï¼Œé‚£ node3 ä¸å°±æ˜¯ä¸å¯ç”¨äº†å—ï¼Œæ‰€ä»¥å®ƒå°±ä¸æ»¡è¶³ å¯ç”¨æ€§äº†ã€‚</p>\n<p>æˆ‘è¦æƒ³æ»¡è¶³å¯ç”¨æ€§ï¼Œæˆ‘å°±æ²¡åŠæ³•ä¿è¯ä¸€è‡´æ€§ã€‚</p>\n<p>æˆ‘è¦ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Œæˆ‘å°±æ²¡åŠæ³•è®© node3 æ˜¯å¯ç”¨æ€§çš„</p>\n<p>å½“ç½‘ç»œå‡ºç°åˆ†åŒºæ—¶ï¼Œå¯ç”¨æ€§å’Œä¸€è‡´æ€§æ²¡æœ‰åŠæ³•åŒæ—¶æ»¡è¶³ã€‚ä½†æ˜¯ç½‘ç»œåˆ†åŒºä¹Ÿæ˜¯ä¸å¯é¿å…çš„ã€‚</p>\n<p>å½“ p ä¸€å®šè¦å®ç°ï¼Œé‚£ä¹ˆè¿™æ—¶ c å’Œ a ä¹‹é—´å°±è¦åšå‡ºæŠ‰æ‹©äº†ã€‚è¦ä¹ˆ c è¦ä¹ˆ a æ²¡æœ‰åŠæ³•åŒæ—¶æ»¡è¶³ã€‚è¿™å°±æ˜¯ CAP å®šç†äº†çš„åŸå› äº†</p>\n<blockquote>\n<p><strong>æ€»ç»“</strong>ï¼š</p>\n<p>ç®€è¿° CAP å®šç†å†…å®¹ï¼Ÿ</p>\n<ul>\n<li>åˆ†å¸ƒå¼ç³»ç»ŸèŠ‚ç‚¹é€šè¿‡ç½‘ç»œè¿æ¥ï¼Œä¸€å®šä¼šå‡ºç°åˆ†åŒºé—®é¢˜ Â§</li>\n<li>å½“åˆ†åŒºå‡ºç°æ—¶ï¼Œç³»ç»Ÿçš„ä¸€è‡´æ€§ Â© å’Œå¯ç”¨æ€§ (A) å°±æ— æ³•åŒæ—¶æ»¡è¶³</li>\n</ul>\n<p>æ€è€ƒï¼šelasticsearch é›†ç¾¤æ˜¯ CP è¿˜æ˜¯ APï¼Ÿ</p>\n<p>ç­”ï¼šES é›†ç¾¤å½“ç½‘ç»œå‡ºç°æ•…éšœæ—¶ï¼Œæœ‰èŠ‚ç‚¹ä¸å…¶å®ƒèŠ‚ç‚¹æ–­å¼€è¿æ¥çš„æ—¶å€™ã€‚es é›†ç¾¤å¤„äºä¸€ä¸ªè­¦å‘ŠçŠ¶æ€ï¼Œå‡ºç°æ•…éšœçš„èŠ‚ç‚¹è¿‡äº†ä¸€æ®µæ—¶é—´åå°±ä¼šä»é›†ç¾¤ä¸­å‰”é™¤ï¼Œè€Œè¿™ä¸ªèŠ‚ç‚¹ä¸ŠåŸæ¥çš„æ•°æ®åˆ†ç‰‡ã€‚ä¼šåˆ†æ•£åˆ°å…¶å®ƒå¥åº·çš„èŠ‚ç‚¹ä¸Šï¼Œè€Œæ•…éšœèŠ‚ç‚¹ä»é›†ç¾¤ä¸­å‰”é™¤ç”¨æˆ·æ— æ³•è®¿é—®äº†å› æ­¤å°±ç‰ºç‰²äº† å¯ç”¨æ€§äº†ã€‚è€Œæ•°æ®ä¼šè´Ÿè´£å…¶å®ƒèŠ‚ç‚¹æ•°æ®åŒæ­¥å¯ä»¥æ­£å¸¸è¿›è¡Œä¿è¯äº†æ•°æ®çš„ä¸€è‡´æ€§ã€‚</p>\n<p>å› æ­¤ es é›†ç¾¤æ˜¾ç„¶æ˜¯ä¸€ä¸ª CPã€‚æ»¡è¶³é«˜ä¸€è‡´æ€§ä½å¯ç”¨æ€§</p>\n</blockquote>\n<p>æˆ‘ä»¬çŸ¥é“åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸‹ç½‘ç»œåˆ†åŒºæ˜¯ä¸å¯é¿å…çš„ï¼Œæ‰€ä»¥ä¸å¾—ä¸åœ¨ä¸€è‡´æ€§å’Œå¯ç”¨æ€§ä¹‹é—´åšå‡ºä¸€ä¸ªé€‰æ‹©ã€‚</p>\n<p>ä½†æ˜¯è¿™ä¸¤ä¸ªç‰¹æ€§éƒ½å¾ˆé‡è¦æˆ‘ä¸€ä¸ªéƒ½ä¸æƒ³æ”¾å¼ƒæˆ‘è¯¥æ€ä¹ˆåŠå‘¢ï¼ŸBase ç†è®ºæ­£å¥½å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜</p>\n<h3 id=\"232-baseç†è®º\"><a class=\"markdownIt-Anchor\" href=\"#232-baseç†è®º\">#</a> 2.3.2ã€BASE ç†è®ºğŸŒ²</h3>\n<p>BASE ç†è®ºæ˜¯å¯¹ CAP çš„ä¸€ç§è§£å†³æ€è·¯ï¼ŒåŒ…å«ä¸‰ä¸ªæ€æƒ³ï¼š</p>\n<ul>\n<li>Basically Available (åŸºæœ¬å¯ç”¨)ï¼šåˆ†å¸ƒå¼ç³»ç»Ÿåœ¨å‡ºç°æ•…éšœæ—¶ï¼Œå…è®¸æŸå¤±éƒ¨åˆ†å¯ç”¨æ€§ï¼Œå³ä¿è¯æ ¸å¿ƒå¯ç”¨ã€‚</li>\n<li>Soft State (è½¯çŠ¶æ€)ï¼šåœ¨ä¸€å®šæ—¶é—´å†…ï¼Œå…è®¸å‡ºç°ä¸­é—´çŠ¶æ€ï¼Œæ¯”å¦‚ä¸´æ—¶çš„ä¸ä¸€è‡´çŠ¶æ€ã€‚</li>\n<li>Eventually Consistent (æœ€ç»ˆä¸€è‡´æ€§)ï¼šè™½ç„¶æ— æ³•ä¿è¯å¼ºä¸€è‡´æ€§ï¼Œä½†æ˜¯åœ¨è½¯çŠ¶æ€ç»“æŸåï¼Œæœ€ç»ˆè¾¾åˆ°æ•°æ®ä¸€è‡´ã€‚</li>\n</ul>\n<p>è€Œåˆ†å¸ƒå¼äº‹åŠ¡æœ€å¤§çš„é—®é¢˜æ˜¯å„ä¸ªå­äº‹åŠ¡çš„ä¸€è‡´æ€§é—®é¢˜ï¼Œå› æ­¤å¯ä»¥å€Ÿç­¾ CAP å®šç†çš„ BASE ç†è®ºï¼š</p>\n<ul>\n<li>AP æ¨¡å¼ï¼šå„å­äº‹åŠ¡åˆ†åˆ«æ‰§è¡Œå’Œæäº¤ï¼Œå…è®¸å‡ºç°ç»“æœä¸ä¸€è‡´ï¼Œç„¶åé‡‡ç”¨å¼¥è¡¥æªæ–½æ¢å¤æ•°æ®å³å¯ï¼Œå®ç°<font color='red'>æœ€ç»ˆä¸€è‡´</font>.</li>\n<li>CP æ¨¡å¼ï¼šå„ä¸ªå­äº‹åŠ¡æ‰§è¡Œåäº’ç›¸ç­‰å¾…ï¼ŒåŒæ—¶æäº¤ï¼ŒåŒæ—¶å›æ»šï¼Œè¾¾æˆ<font color='red'>å¼ºä¸€è‡´</font>ã€‚ä½†äº‹åŠ¡ç­‰å¾…è¿‡ç¨‹ä¸­ï¼Œå¤„äºå¼±å¯ç”¨çŠ¶æ€ã€‚</li>\n</ul>\n<h4 id=\"2321-åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å‹\"><a class=\"markdownIt-Anchor\" href=\"#2321-åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å‹\">#</a> 2.3.2.1ã€åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å‹ğŸŒ´</h4>\n<p>è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œå„ä¸ªå­ç³»ç»Ÿä¹‹é—´å¿…é¡»èƒ½æ„ŸçŸ¥åˆ°å½¼æ­¤çš„äº‹åŠ¡çŠ¶æ€ï¼Œæ‰èƒ½ä¿è¯çŠ¶æ€ä¸€è‡´ï¼Œå› æ­¤éœ€è¦ä¸€ä¸ªäº‹åŠ¡åè°ƒè€…æ¥åè°ƒæ¯ä¸€ä¸ªäº‹åŠ¡çš„å‚ä¸è€… (å­ç³»ç»Ÿäº‹åŠ¡)ã€‚</p>\n<p>ç”¨æˆ·ä¸‹å•è°ƒç”¨è®¢å•æœåŠ¡ï¼Œç„¶åå»è°ƒç”¨è´¦æˆ·æœåŠ¡å’Œåº“å­˜æœåŠ¡ã€‚é‚£è¿™ä¸ªåœ°æ–¹æˆ‘ä»¬å°±éœ€è¦ä¸€ä¸ªäº‹åŠ¡çš„åè°ƒè€…äº†ï¼Œæ¯ä¸ªå¾®æœåŠ¡éƒ½è·Ÿäº‹åŠ¡åè°ƒè€…ä¿æŒè”ç³»ï¼Œå¦‚æœä½ ç°åœ¨è¦åšå¼ºä¸€è‡´ã€‚è®¢å•æœåŠ¡æ‰§è¡Œçš„æ—¶å€™ä¸è¦æäº¤ï¼Œæ‰£æ¬¾æœåŠ¡ï¼Œæ‰£åº“å­˜æœåŠ¡ï¼Œä½†æ˜¯åº“å­˜æœåŠ¡æ‰§è¡Œå®Œåå‘ç°å¤±è´¥äº†ã€‚æ€ä¹ˆçŸ¥é“çš„ã€‚å®ƒä»¬è¦æŠŠè‡ªå·±çš„æ‰§è¡Œç»“æœå‘ŠçŸ¥ç»™åè°ƒè€…ï¼Œç„¶ååè°ƒè€…ä¸€çœ‹æœ‰äººå¤±è´¥äº†å°†æ¥å†é€šçŸ¥å…¶å®ƒæœåŠ¡è®©å®ƒä»¬åšå›æ»šï¼Œè¿™æ ·å¤§å®¶å°±èƒ½ä¿æŒä¸€è‡´äº†</p>\n<p>æ¯ä¸€ä¸ªäº‹åŠ¡çš„å‚ä¸è€… (å­ç³»ç»Ÿäº‹åŠ¡)ã€‚</p>\n<p>è¿™é‡Œçš„å­ç³»ç»Ÿäº‹åŠ¡ï¼Œç§°ä¸º<font color='red'> åˆ†æ”¯äº‹åŠ¡</font>.ï¼›æœ‰å…³è”çš„å„ä¸ªåˆ†æ”¯äº‹åŠ¡ åœ¨ä¸€èµ·ç§°ä¸º <font color='red'>å…¨å±€äº‹åŠ¡</font>.</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310172141933.png\" alt=\"image-20231017214146879\"></p>\n<p>æ‰€ä»¥äº‹åŠ¡åè°ƒè€…ï¼Œå°±æ˜¯å»åè°ƒå„ä¸ªåˆ†æ”¯äº‹ç‰©çš„çŠ¶æ€è®©å®ƒä»¬è¾¾æˆä¸€è‡´</p>\n<blockquote>\n<p><strong>æ€»ç»“</strong>ï¼š</p>\n<p>ç®€è¿° BASE ç†è®ºä¸‰ä¸ªæ€æƒ³ï¼š</p>\n<ol>\n<li>åŸºæœ¬å¯ç”¨</li>\n<li>è½¯çŠ¶æ€</li>\n<li>æœ€ç»ˆä¸€è‡´</li>\n</ol>\n<p>è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡çš„æ€æƒ³å’Œæ¨¡å‹ï¼š</p>\n<ol>\n<li>å…¨å±€äº‹åŠ¡ï¼šæ•´ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡</li>\n<li>åˆ†æ”¯äº‹åŠ¡ï¼šåˆ†å¸ƒå¼äº‹åŠ¡ä¸­åŒ…å«çš„æ¯ä¸ªå­ç³»ç»Ÿçš„äº‹åŠ¡</li>\n<li>æœ€ç»ˆä¸€è‡´æ€æƒ³ï¼šå„åˆ†æ”¯äº‹åŠ¡åˆ†åˆ«æ‰§è¡Œå¹¶æäº¤ï¼Œå¦‚æœæœ‰ä¸ä¸€è‡´çš„æƒ…å†µï¼Œå†æƒ³åŠæ³•æ¢å¤æ•°æ®</li>\n<li>å¼ºä¸€è‡´æ€æƒ³ï¼šå„åˆ†æ”¯äº‹åŠ¡æ‰§è¡Œå®Œä¸šåŠ¡ä¸è¦æäº¤ï¼Œç­‰å¾…å½¼æ­¤ç»“æœã€‚è€Œåç»Ÿä¸€æäº¤æˆ–å›æ»š</li>\n</ol>\n</blockquote>\n<h2 id=\"24-åˆå§‹seata\"><a class=\"markdownIt-Anchor\" href=\"#24-åˆå§‹seata\">#</a> 2.4ã€åˆå§‹ SeatağŸŒ³</h2>\n<ul>\n<li>Seata çš„æ¶æ„</li>\n<li>éƒ¨ç½² TC æœåŠ¡</li>\n<li>å¾®æœåŠ¡é›†æˆ Seata</li>\n</ul>\n<p>Seata æ˜¯ 2019 å¹´ 1 æœˆä»½èš‚èšé‡‘æœå’Œé˜¿é‡Œå·´å·´å…±åŒå¼€æºçš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆã€‚è‡´åŠ›äºæä¾›é«˜æ€§èƒ½å’Œç®€å•æ˜“ç”¨çš„åˆ†å¸ƒå¼äº‹åŠ¡æœåŠ¡ï¼Œä¸ºç”¨æˆ·æ‰“é€ ä¸€ç«™å¼çš„åˆ†å¸ƒå¼è§£å†³æ–¹æ¡ˆã€‚</p>\n<p>å®˜ç½‘åœ°å€ï¼š<a href=\"https://seata.io/zh-cn/\">https://seata.io/zh-cn/</a></p>\n<p><strong>Seata äº‹åŠ¡ç®¡ç†ä¸­æœ‰ä¸‰ä¸ªé‡è¦çš„è§’è‰²</strong>ï¼š</p>\n<p>1ã€TC (Transaction Coordinator) - äº‹åŠ¡åè°ƒè€…ï¼šç»´æŠ¤å…¨å±€å’Œåˆ†å¸ƒå¼äº‹åŠ¡çš„çŠ¶æ€ï¼Œåè°ƒå…¨å±€äº‹åŠ¡æäº¤å’Œå›æ»šã€‚</p>\n<p>2ã€TM (Transaction Manager) - äº‹åŠ¡ç®¡ç†å™¨ï¼šå®šä¹‰å…¨å±€äº‹åŠ¡çš„èŒƒå›´ï¼Œå¼€å§‹å…¨å±€äº‹åŠ¡ï¼Œæäº¤æˆ–å›æ»šå…¨å±€äº‹åŠ¡ã€‚</p>\n<p>3ã€RM (Resource Manager) - èµ„æºç®¡ç†å™¨ï¼šç®¡ç†åˆ†æ”¯äº‹åŠ¡å¤„ç†çš„èµ„æºï¼Œä¸ TC äº¤è°ˆä»¥æ³¨å†Œåˆ†æ”¯äº‹åŠ¡å’ŒæŠ¥å‘Šåˆ†æ”¯äº‹åŠ¡çš„çŠ¶æ€ï¼Œå¹¶é©±åŠ¨åˆ†æ”¯äº‹åŠ¡æäº¤æˆ–å›æ»šã€‚</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310180745437.png\" alt=\"image-20231018074554248\"></p>\n<p>Seata æ ¹æ®è¦åšå¼ºä¸€è‡´è¿˜æ˜¯æœ€ç»ˆä¸€è‡´åˆå»¶ä¼¸å‡ºäº†å¥½å‡ ç§ä¸åŒçš„è§£å†³æ–¹æ¡ˆï¼š</p>\n<p><strong>Seata æä¾›äº†å››ä¸ªä¸åŒçš„åˆ†å¸ƒå¼è§£å†³æ–¹æ¡ˆ</strong>ï¼š</p>\n<p>1ã€XA æ¨¡å¼ï¼šå¼ºä¸€è‡´æ€§åˆ†é˜¶æ®µäº‹åŠ¡æ¨¡å¼ï¼Œç‰ºç‰²äº†ä¸€å®šçš„å¯ç”¨æ€§ï¼Œæ— ä¸šåŠ¡ä¾µå…¥</p>\n<p>2ã€TCC æ¨¡å¼ï¼šæœ€ç»ˆä¸€è‡´çš„åˆ†é˜¶æ®µäº‹åŠ¡æ¨¡å¼ï¼Œæœ‰ä¸šåŠ¡ä¾µå…¥</p>\n<p>3ã€AT æ¨¡å¼ï¼šæœ€ç»ˆä¸€è‡´çš„åˆ†é˜¶æ®µäº‹åŠ¡æ¨¡å¼ï¼Œæ— ä¸šåŠ¡ä¾µå…¥ï¼Œä¹Ÿæ˜¯ Seata çš„é»˜è®¤æ¨¡å¼</p>\n<p>4ã€SAGA æ¨¡å¼ï¼šé•¿äº‹åŠ¡æ¨¡å¼ï¼Œæœ‰ä¸šåŠ¡ä¾µå…¥</p>\n<h3 id=\"241-éƒ¨ç½²tcæœåŠ¡\"><a class=\"markdownIt-Anchor\" href=\"#241-éƒ¨ç½²tcæœåŠ¡\">#</a> 2.4.1ã€éƒ¨ç½² TC æœåŠ¡ğŸŒ²</h3>\n<p>å‚è€ƒæ–‡ç« ï¼š<a href=\"../Seata/seata%E7%9A%84%E9%83%A8%E7%BD%B2%E5%92%8C%E9%9B%86%E6%88%90.md\">seata çš„éƒ¨ç½²å’Œé›†æˆ</a>.</p>\n<h3 id=\"242-æ‰‹åŠ¨å®è·µ\"><a class=\"markdownIt-Anchor\" href=\"#242-æ‰‹åŠ¨å®è·µ\">#</a> 2.4.2ã€æ‰‹åŠ¨å®è·µğŸŒ²</h3>\n<ul>\n<li>XA æ¨¡å¼</li>\n<li>AT æ¨¡å¼</li>\n<li>TCC æ¨¡å¼</li>\n<li>SAGA æ¨¡å¼</li>\n</ul>\n<h4 id=\"2421-xaæ¨¡å¼åŸç†\"><a class=\"markdownIt-Anchor\" href=\"#2421-xaæ¨¡å¼åŸç†\">#</a> 2.4.2.1ã€XA æ¨¡å¼åŸç†ğŸŒ´</h4>\n<p>XA è§„åˆ™ æ˜¯ X/Open ç»„ç»‡å®šä¹‰çš„åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç† (DTPï¼ŒDistributed Transaction Processing) æ ‡å‡†ï¼ŒXA è§„èŒƒ æè¿°äº†å…¨å±€çš„ TM ä¸å±€éƒ¨çš„ RM ä¹‹é—´çš„æ¥å£ï¼Œå‡ ä¹æ‰€æœ‰ä¸»æµçš„æ•°æ®åº“éƒ½å¯¹ XA è§„èŒƒ æä¾›äº†æ”¯æŒã€‚</p>\n<p>è¿™ç§æ¨¡å¼ï¼Œå®ƒæŠŠåˆ†å¸ƒå¼äº‹åŠ¡å®šä¹‰æˆäº†ä¸¤ä¸ªé˜¶æ®µã€‚ç¬¬ä¸€é˜¶æ®µä¸º â€œå‡†å¤‡é˜¶æ®µâ€ åœ¨æ­¤é˜¶æ®µä¸­å®ç‰©åè°ƒè€…ä¼šå‘äº‹åŠ¡å‚ä¸è€… (RM) å»å‘èµ·ä¸€ä¸ªå‡†å¤‡çš„è¯·æ±‚ï¼Œåœ¨ä¸Šé¢è®²è¿°ä¸­ RM æ˜¯èµ„æºç®¡ç†å™¨ï¼Œä½†æ˜¯åœ¨ XA æ ‡å‡†ä¸­è¿™ä¸ª RM å…¶å®éƒ½æ˜¯ç”±æ•°æ®åŒºå®ç°çš„ã€‚ä¹Ÿå°±æ˜¯è¯´æ•°æ®åº“æœ¬èº«å®ç°äº† RM åŠŸèƒ½ã€‚äº‹åŠ¡åè°ƒè€…é€šçŸ¥è¿™äº›æ•°æ®åº“å»æ‰§è¡Œè‡ªå·±çš„ä¸šåŠ¡ï¼Œä½†æ˜¯æ‰§è¡Œå®Œä¸è¦æäº¤ï¼Œç„¶åæŠŠæ‰§è¡Œç»“æœå‘ŠçŸ¥äº‹åŠ¡åè°ƒè€…</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310181016731.png\" alt=\"Snipaste_2023-10-18_10-16-42\"></p>\n<p>ç„¶åè¿›è¡Œ â€œç¬¬äºŒé˜¶æ®µâ€ äº‹åŠ¡åè°ƒè€…é€šçŸ¥ RM å¯ä»¥æäº¤äº†ã€‚äº‹åŠ¡ç»“æŸ</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310181017816.png\" alt=\"image-20231018101741714\"></p>\n<p>å¦‚æœ ç¬¬ä¸€é˜¶æ®µ æœ‰ä»»æ„ä¸€ä¸ªæœåŠ¡å¤±è´¥äº†</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310181018842.png\" alt=\"image-20231018101839751\"></p>\n<p>é‚£ä¹ˆç¬¬äºŒé˜¶æ®µï¼Œäº‹åŠ¡åè°ƒè€…å°±ä¼šé€šçŸ¥æ‰€æœ‰çš„ RM è¿›è¡Œå›æ»š</p>\n<p>XA æ¨¡å¼ï¼Œå…¶å®å°±æ˜¯åŸºäºæ•°æ®åº“æœ¬èº«çš„ç‰¹æ€§å»å®ç°çš„ä¸€ç§åˆ†å¸ƒå¼äº‹åŠ¡</p>\n<h4 id=\"2422-seataçš„xaæ¨¡å¼\"><a class=\"markdownIt-Anchor\" href=\"#2422-seataçš„xaæ¨¡å¼\">#</a> 2.4.2.2ã€seata çš„ XA æ¨¡å¼ğŸŒ´</h4>\n<p>seata çš„ XA æ¨¡å¼åšäº†ä¸€äº›è°ƒæ•´ï¼Œä½†å¤§ä½“ç›¸ä¼¼ï¼š</p>\n<p>TM æ³¨å†Œå…¨å±€äº‹åŠ¡ï¼ŒTM ä½œä¸ºåˆ†å¸ƒå¼å…¥å£è‡ªç„¶å»è°ƒç”¨å¾®æœåŠ¡ï¼Œè°ƒç”¨å¾®æœåŠ¡é‡Œé¢çš„ RM æ‹¦æˆªè¯·æ±‚ï¼Œseata é‡Œé¢ä¹Ÿå®ç°äº† RMï¼Œæ•°æ®åº“ä¹Ÿæœ‰ RMï¼Œåœ¨è¿™ä¸ªæƒ…å†µä¸‹ seata çš„ RM ä»…ä»…æ˜¯ä»£ç†ä½ çš„è¯·æ±‚ã€‚ç„¶ååšä¸€ä¸‹åˆ†æ”¯äº‹åŠ¡çš„æ³¨å†Œï¼Œæ¥ä¸‹æ¥çš„äº‹å°±æ˜¯ç›´æ¥è°ƒç”¨æ•°æ®åº“äº†æ‰§è¡Œä¸šåŠ¡ SQLï¼Œä½†æ˜¯æ‰§è¡Œå®Œä¸æäº¤ï¼Œå»æŠ¥å‘Šä¸€ä¸‹äº‹åŠ¡çš„çŠ¶æ€åˆ° TC å°±è¡Œäº†ã€‚æ‰€ä»¥ TC æ­¤æ—¶å°±å†²å½“äº†äº‹åŠ¡åè°ƒçš„ä½œç”¨äº†</p>\n<p>è‡³æ­¤ï¼Œç¬¬ä¸€é˜¶æ®µç»“æŸ</p>\n<p>ç¬¬äºŒé˜¶æ®µ TM å‘ç°ä¸šåŠ¡ç»“æŸäº†å°±å»é€šçŸ¥ TCï¼Œç„¶å TC å»æ£€æŸ¥äº‹åŠ¡çš„çŠ¶æ€ï¼Œéƒ½æˆåŠŸå°±æˆåŠŸã€‚æœ‰ä¸€ä¸ªå¤±è´¥å°±è¦å›æ»š</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310181126968.png\" alt=\"image-20231018112632854\"></p>\n<p>å¦‚æœæˆ‘ä»¬åªçœ‹æ ¸å¿ƒéƒ¨åˆ†å°±å’Œ XA æ²¡æœ‰ä»€ä¹ˆå¤ªå¤§çš„åŒºåˆ«äº†</p>\n<p><strong>RM ä¸€é˜¶æ®µçš„å·¥ä½œ</strong>ï¼š</p>\n<p>1ã€æ³¨å†Œåˆ†æ”¯å®ç‰©åˆ° TC</p>\n<p>2ã€æ‰§è¡Œåˆ†æ”¯ä¸šåŠ¡ sql ä½†ä¸æäº¤</p>\n<p>3ã€æŠ¥å‘Šæ‰§è¡ŒçŠ¶æ€åˆ° TC</p>\n<p><strong>TC äºŒé˜¶æ®µçš„å·¥ä½œ</strong>ï¼š</p>\n<ul>\n<li>TC æ£€æµ‹å„åˆ†æ”¯äº‹åŠ¡æ‰§è¡ŒçŠ¶æ€\n<ul>\n<li>å¦‚æœéƒ½æˆåŠŸï¼Œé€šè¿‡æ‰€æœ‰ RM æäº¤äº‹åŠ¡</li>\n<li>å¦‚æœæœ‰å¤±è´¥ï¼Œé€šè¿‡æ‰€æœ‰ RM å›æ»šäº‹åŠ¡</li>\n</ul>\n</li>\n</ul>\n<p><strong>RM äºŒé˜¶æ®µçš„å·¥ä½œ</strong>ï¼š</p>\n<ul>\n<li>æ¥æ”¶ TC æŒ‡ä»¤ï¼Œæäº¤æˆ–å›æ»šäº‹åŠ¡</li>\n</ul>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310181128704.png\" alt=\"image-20231018112758938\"></p>\n<blockquote>\n<p><strong>æ€»ç»“</strong>ï¼š</p>\n<p>XA æ¨¡å¼çš„ä¼˜ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ</p>\n<ul>\n<li>äº‹åŠ¡çš„å¼ºä¸€è‡´æ€§ï¼Œæ»¡è¶³ ACID åŸåˆ™</li>\n<li>å¸¸ç”¨æ•°æ®åº“éƒ½æ”¯æŒï¼Œå®ç°ç®€å•ï¼Œå¹¶ä¸”æ²¡æœ‰ä»£ç ä¾µå…¥</li>\n</ul>\n<p>XA æ¨¡å¼çš„ç¼ºç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ</p>\n<ul>\n<li>å› ä¸ºä¸€é˜¶æ®µéœ€è¦é”å®šæ•°æ®åº“èµ„æºï¼Œç­‰å¾…äºŒé˜¶æ®µç»“æŸæ‰é‡Šæ”¾ï¼Œæ€§èƒ½è¾ƒå·®</li>\n<li>ä¾èµ–å…³ç³»å‹æ•°æ®åº“å®ç°äº‹åŠ¡</li>\n</ul>\n</blockquote>\n<h4 id=\"2423-å®ç°xaæ¨¡å¼\"><a class=\"markdownIt-Anchor\" href=\"#2423-å®ç°xaæ¨¡å¼\">#</a> 2.4.2.3ã€å®ç° XA æ¨¡å¼ğŸŒ´</h4>\n<p>Seata çš„ starter å·²ç»å®Œæˆäº† XA æ¨¡å¼çš„è‡ªåŠ¨è£…é…ï¼Œå®ç°éå¸¸ç®€å•ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š</p>\n<p>1ã€ä¿®æ”¹ application.yml æ–‡ä»¶ (æ¯ä¸ªå‚ä¸äº‹åŠ¡çš„å¾®æœåŠ¡)ï¼Œå¼€å¯ XA æ¨¡å¼</p>\n<figure class=\"highlight yml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">seata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">data-source-proxy-mode</span><span class=\"token punctuation\">:</span> XA <span class=\"token comment\"># å¼€å¯æ•°æ®æºä»£ç†çš„ XA æ¨¡å¼</span></pre></td></tr></table></figure><p>2ã€ç»™å‘èµ·å…¨å±€äº‹åŠ¡çš„å…¥å£æ–¹æ³•æ·»åŠ  @GlobalTransactional æ³¨è§£ï¼Œæœ¬ä¾‹ä¸­æ˜¯ OrderServiceImpl ä¸­çš„ create æ–¹æ³•ï¼š</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token annotation punctuation\">@GlobalTransactional</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">Long</span> <span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Order</span> order<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   <span class=\"token comment\">// åˆ›å»ºè®¢å•</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   orderMapper<span class=\"token punctuation\">.</span><span class=\"token function\">insert</span><span class=\"token punctuation\">(</span>order<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token comment\">// æ‰£ç”¨æˆ·ä½™é¢</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      accountClient<span class=\"token punctuation\">.</span><span class=\"token function\">deduct</span><span class=\"token punctuation\">(</span>order<span class=\"token punctuation\">.</span><span class=\"token function\">getUserId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> order<span class=\"token punctuation\">.</span><span class=\"token function\">getMoney</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token comment\">// æ‰£åº“å­˜</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      storageClient<span class=\"token punctuation\">.</span><span class=\"token function\">deduct</span><span class=\"token punctuation\">(</span>order<span class=\"token punctuation\">.</span><span class=\"token function\">getCommodityCode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> order<span class=\"token punctuation\">.</span><span class=\"token function\">getCount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">FeignException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      log<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ä¸‹å•å¤±è´¥ï¼ŒåŸå› :&#123;&#125;\"</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">.</span><span class=\"token function\">contentUTF8</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RuntimeException</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span><span class=\"token function\">contentUTF8</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>   <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>   <span class=\"token keyword\">return</span> order<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>3ã€é‡å¯æœåŠ¡å¹¶æµ‹è¯•</p>\n<p>ç›®å‰çš„ account_tbl è¡¨å•ä¿¡æ¯</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310181144973.png\" alt=\"image-20231018114458627\"></p>\n<p>ç›®å‰ storage_tbl è¡¨å•ä¿¡æ¯</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310181145948.png\" alt=\"image-20231018114522634\"></p>\n<p>ä½¿ç”¨ postman è¿›è¡Œå‘é€è¯·æ±‚æµ‹è¯•</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310181146511.png\" alt=\"image-20231018114629170\"></p>\n<p>æµ‹è¯•å account_tbl è¡¨å•ä¿¡æ¯</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310181146234.png\" alt=\"image-20231018114658167\"></p>\n<p>æµ‹è¯•å storage_tbl è¡¨å•ä¿¡æ¯</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310181147047.png\" alt=\"image-20231018114715998\"></p>\n<p>å¯ä»¥çœ‹åˆ°æ²¡æœ‰é—®é¢˜ï¼Œä¸‹é¢æµ‹è¯• å¼‚å¸¸ çš„æƒ…å†µ</p>\n<p>postman æµ‹è¯•å¦‚ä¸‹ï¼š</p>\n<p>å°†å­˜åº“æ•°é‡æ”¹ä¸º 10ï¼Œå½“å‰çš„åº“å­˜æ•°æ®æ˜¯ä¸è¶³ 10 ä¸ªçš„å› æ­¤æ‰§è¡Œå°±ä¼šå‡ºé—®é¢˜å¯ä»¥çœ‹åˆ°çŠ¶æ€ç  500 å·²ç»å¼‚å¸¸äº†</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310181148645.png\" alt=\"image-20231018114814272\"></p>\n<p>æˆ‘ä»¬çœ‹ä¸‹æ•°æ®åº“æœ‰æ²¡æœ‰å›æ»šå•Š</p>\n<p>æµ‹è¯•å account_tbl è¡¨å•ä¿¡æ¯</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310181149371.png\" alt=\"image-20231018114937327\"></p>\n<p>æµ‹è¯•å storage_tbl è¡¨å•ä¿¡æ¯</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310181149916.png\" alt=\"image-20231018114955744\"></p>\n<p>å¯ä»¥çœ‹åˆ°æ²¡æœ‰ä»»ä½•å˜åŒ–</p>\n<p>çœ‹ä¸‹ idea çš„æ§åˆ¶å°çš„æ‰“å°ä¿¡æ¯ï¼š</p>\n<p>accountApplication æ‰“å°å‡ºäº†äº‹åŠ¡å›æ»šçš„ä¿¡æ¯ï¼Œå…¶å®ƒçš„æ˜¯æŠ¥é”™çš„ä¿¡æ¯ï¼Œå› ä¸ºæŠ¥é”™æœ¬èº«å°±æ²¡æœ‰æ‰§è¡ŒæˆåŠŸ</p>\n<pre><code>10-18 11:48:06:076  INFO 18016 --- [h_RMROLE_1_2_16] i.s.c.r.p.c.RmBranchRollbackProcessor    : rm handle branch rollback process:xid=192.168.45.1:8091:4251845158843265029,branchId=4251845158843265031,branchType=XA,resourceId=jdbc:mysql:///seata_demo,applicationData=null\n10-18 11:48:06:080  INFO 18016 --- [h_RMROLE_1_2_16] io.seata.rm.AbstractRMHandler            : Branch Rollbacking: 192.168.45.1:8091:4251845158843265029 4251845158843265031 jdbc:mysql:///seata_demo\n10-18 11:48:06:083  INFO 18016 --- [h_RMROLE_1_2_16] i.s.rm.datasource.xa.ResourceManagerXA   : 192.168.45.1:8091:4251845158843265029-4251845158843265031 was rollbacked\n10-18 11:48:06:084  INFO 18016 --- [h_RMROLE_1_2_16] io.seata.rm.AbstractRMHandler            : Branch Rollbacked result: PhaseTwo_Rollbacked\n</code></pre>\n<h4 id=\"2424-atæ¨¡å¼åŸç†\"><a class=\"markdownIt-Anchor\" href=\"#2424-atæ¨¡å¼åŸç†\">#</a> 2.4.2.4ã€AT æ¨¡å¼åŸç†ğŸŒ´</h4>\n<p>AT æ¨¡å¼åŒæ ·æ˜¯åˆ†é˜¶æ®µæäº¤çš„äº‹åŠ¡æ¨¡å‹ï¼Œä¸è¿‡å´å¼¥è¡¥äº† XA æ¨¡å‹ä¸­èµ„æºé”å®šå‘¨æœŸè¿‡é•¿çš„ç¼ºé™·ã€‚</p>\n<p>AT æ¨¡å¼æ‰§è¡Œå®Œä¸šåŠ¡ sql åä¼šç›´æ¥æäº¤äº‹åŠ¡ï¼Œè€Œä¸æ˜¯ç­‰å¾…å¯¹æ–¹çš„æ‰§è¡Œã€‚åœ¨æ‰§è¡Œä¸šåŠ¡ sql çš„æ—¶å€™ç”± RM æ‹¦æˆªè¿™æ¬¡çš„æ‰§è¡Œå¹¶ä¸”ç»™æ•°æ®å½¢æˆä¸€ä¸ªå¿«ç…§ï¼Œå¿«ç…§åä¸ºï¼šundo logï¼Œå¦‚æœå¤±è´¥äº†å°±å¯ä»¥æ ¹æ®å¿«ç…§è¿›è¡Œæ¢å¤äº†ã€‚åœ¨ç¬¬ä¸€é˜¶æ®µå°±å·²ç»æäº¤äº†ï¼Œç¬¬äºŒé˜¶æ®µå°† log ç»™åˆ é™¤</p>\n<p>é˜¶æ®µä¸€ RM çš„å·¥ä½œï¼š</p>\n<p>1ã€æ³¨å†Œåˆ†æ”¯äº‹åŠ¡</p>\n<p>2ã€<font color='red'>è®°å½• undo-log (æ•°æ®å¿«ç…§)</font>.</p>\n<p>3ã€æ‰§è¡Œä¸šåŠ¡ sql å¹¶<font color='red'>æäº¤</font>.</p>\n<p>4ã€æŠ¥å‘Šäº‹åŠ¡çŠ¶æ€</p>\n<p>é˜¶æ®µäºŒæäº¤æ—¶ RM çš„å·¥ä½œï¼š</p>\n<p>1ã€åˆ é™¤ undo-log å³å¯</p>\n<p>é˜¶æ®µäºŒå›æ»šæ—¶ RM çš„å·¥ä½œï¼š</p>\n<p>1ã€æ ¹æ® undo-log æ¢å¤æ•°æ®åˆ°æ›´æ–°å‰</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310181329271.png\" alt=\"image-20231018132921268\"></p>\n<p>ä¸‹é¢é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥è¿›è¡Œæ¯”å–»ï¼š</p>\n<p>ä¾‹å¦‚ï¼Œä¸€ä¸ªåˆ†æ”¯ä¸šåŠ¡çš„ SQL æ˜¯è¿™æ ·çš„ï¼šupdate tb_account set money = money - 10 where id = 1</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310181333976.png\" alt=\"image-20231018133322819\"></p>\n<blockquote>\n<p><strong>æ€»ç»“</strong>ï¼š</p>\n<p>ç®€è¿° AT æ¨¡å¼ä¸ XA æ¨¡å¼æœ€å¤§çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ</p>\n<ul>\n<li>XA æ¨¡å¼ä¸€é˜¶æ®µä¸æäº¤äº‹åŠ¡ï¼Œé”å®šèµ„æºï¼›AT æ¨¡å¼ä¸€é˜¶æ®µç›´æ¥æäº¤ï¼Œä¸é”å®šèµ„æº</li>\n<li>XA æ¨¡å¼ä¾èµ–æ•°æ®åº“æœºåˆ¶å®ç°å›æ»šï¼›AT æ¨¡å¼åˆ©ç”¨æ•°æ®å¿«ç…§å®ç°æ•°æ®å›æ»š</li>\n<li>XA æ¨¡å¼å¼ºä¸€è‡´ï¼›AT æ¨¡å¼æœ€ç»ˆä¸€è‡´</li>\n</ul>\n</blockquote>\n<h5 id=\"24241-atæ¨¡å¼çš„è„å†™é—®é¢˜\"><a class=\"markdownIt-Anchor\" href=\"#24241-atæ¨¡å¼çš„è„å†™é—®é¢˜\">#</a> 2.4.2.4.1ã€AT æ¨¡å¼çš„è„å†™é—®é¢˜ğŸ‹</h5>\n<p>ä¸Šè¿°å¾—çŸ¥ï¼ŒAT æ¨¡å¼ç›¸å¯¹äº XA æ¨¡å¼æ¥è®²ï¼Œæ€§èƒ½å¾—åˆ°äº†ä¸€äº›æå‡ï¼Œå› ä¸º AT æ¨¡å¼åœ¨ç¬¬ä¸€é˜¶æ®µçš„æ—¶å€™æ‰§è¡Œäº‹åŠ¡ä¼šç›´æ¥æäº¤ã€‚è€Œä¸æ˜¯ç­‰å¾…å„ä¸ªåˆ†æ”¯ä¸€èµ·æ‰§è¡Œå®Œï¼Œå› æ­¤èµ„æºé”å®šå‘¨æœŸçŸ­ æ€§èƒ½å°±æ¯”è¾ƒå¥½äº†ã€‚ä½†æ˜¯ä¹Ÿæ­£æ˜¯å› ä¸ºå®ƒæå‰é‡Šæ”¾äº†èµ„æºæ²¡æœ‰å»åšé”ï¼Œè¿™å°±å¯¼è‡´äº†åœ¨å¹¶å‘è®¿é—®æƒ…å†µä¸‹ä¼šå­˜åœ¨ä¸€äº›å®‰å…¨é—®é¢˜ã€‚</p>\n<p>æ¯”å¦‚è¯´æœ‰ä¸ª account è¡¨ï¼Œä¸šåŠ¡æ˜¯ä¿®æ”¹ money å­—æ®µè®©å…¶å‡ 10ï¼Œé‚£ä¹ˆæœ‰ä¸€ä¸ªçº¿ç¨‹å¼€å¯äº†è¿™ä¸ªæ ·äº‹åŠ¡ã€‚äº‹åŠ¡å¼€å¯ç¬¬ä¸€ä»¶äº‹å°±æ˜¯è·å–æ•°æ®åº“é”ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªå¿«ç…§ã€‚ç„¶åæ‰§è¡Œ sql ä» 100 æ”¹ä¸º 90ï¼Œç„¶åæäº¤äº‹åŠ¡ï¼Œäº‹åŠ¡ä¸€æ—¦æäº¤é”å°±é‡Šæ”¾äº†ï¼Œæ•°æ®ä¹Ÿå°±æ”¹äº†ã€‚ç¬¬ä¸€é˜¶æ®µå®Œæˆå°±è½®åˆ°ç¬¬äºŒé˜¶æ®µï¼Œä½†åŒä¸€æ—¶åˆ»å› ä¸ºæ˜¯å¹¶å‘ç°åœ¨æœ‰å¦å¤–ä¸€ä¸ªçº¿ç¨‹ä¹Ÿå¼€å¯äº†äº‹åŠ¡æ‰§è¡Œè¿™ä¸ªä¸šåŠ¡ã€‚äº‹åŠ¡ 2 ç­‰å¾…äº‹åŠ¡ 1 é‡Šæ”¾é”äº†ï¼Œç„¶åæ‹¿åˆ°é”æ‰èƒ½å»ä¿å­˜å¿«ç…§å¹¶æ‰§è¡Œä¸šåŠ¡ sql å°† 90 æ”¹ ä¸º 80ï¼Œç„¶åæäº¤äº‹åŠ¡å¹¶é‡Šæ”¾é”ã€‚</p>\n<p>å¦‚æœè¿™æ—¶äº‹åŠ¡ 1 æ‹¿åˆ°é”åå®ƒè¦åšå›æ»šï¼Œå› ä¸ºäº‹åŠ¡ 1 çš„ç¬¬äºŒé˜¶æ®µè¿˜æ²¡åšå®Œï¼Œè¿™æ—¶äº‹åŠ¡ 1 çš„å¿«ç…§æ•°æ®ä¸º money=100 è¿™æ˜¯å›æ»šå°±å‡ºé—®é¢˜äº†ã€‚</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310181351685.png\" alt=\"image-20231018135124412\"></p>\n<p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ AT æ¨¡å¼å¼•å…¥äº†ä¸€ä¸ªå« â€œå…¨å±€é”â€ çš„ä¸œè¥¿</p>\n<p><mark>å…¨å±€é”</mark>ï¼šç”± TC è®°å½•å½“å‰æ­£åœ¨æ“ä½œæŸè¡Œæ•°æ®çš„äº‹åŠ¡ï¼Œæ”¹äº‹åŠ¡æŒæœ‰å…¨å±€é”ï¼Œå…·å¤‡æ‰§è¡Œæƒã€‚</p>\n<p>TC é€šè¿‡ä¸€å¼ è¡¨æ¥è¿›è¡Œè®°å½•ï¼Œåˆ†åˆ«è®°å½•ï¼šå½“å‰ç”±å“ªä¸ªäº‹åŠ¡åœ¨æ“ä½œï¼Œæ“ä½œçš„å“ªå¼ è¡¨ï¼Œä¸»é”® æ“ä½œè¿™å¼ è¡¨çš„å“ªä¸€è¡Œæ•°æ®ã€‚é€šè¿‡è®°å½•æŸ¥çœ‹è¿™ä¸ªè¡¨çš„è¿™è¡Œæ•°æ®å°±åªèƒ½è¢«è¿™ä¸ªäº‹åŠ¡è¿›è¡Œæ“ä½œï¼Œå…¶å®ƒäº‹åŠ¡ä¸èƒ½æ“ä½œã€‚</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310181402045.png\" alt=\"image-20231018140242928\"></p>\n<p>å°½ç®¡å¦‚æ­¤ï¼Œäº‹åŠ¡ 1 åœ¨æ“ä½œ money å­—æ®µçš„æ—¶å€™ä¹Ÿå¯èƒ½ä¼šæœ‰ä¸€ä¸ªæ²¡æœ‰è¢« seata ç®¡ç†çš„ä¸šåŠ¡æ¥æ“ä½œ money å­—æ®µæ­¤æ—¶å°±ä¼šäº§ç”Ÿè„å†™çš„é—®é¢˜äº†ã€‚åˆ†å¸ƒå¼äº‹åŠ¡æˆ‘ä»¬åº”è¯¥å°½é‡çš„é¿å…ä¸¤ä¸ªæ“ä½œåŒä¸€ä¸ªå­—æ®µã€‚ä½†æ˜¯å†æ€ä¹ˆé¿å…ä¹Ÿä¸æ˜¯ä¸å¯èƒ½çš„æƒ…å†µ</p>\n<p>AT æ¨¡å¼ä¹Ÿå¯¹è¿™ç§æ–¹å¼åšäº†ä¸€äº›å¤„ç†ã€‚</p>\n<p>å½“äº‹åŠ¡ 1 ç¬¬äºŒé˜¶æ®µè¿›è¡Œå›æ»šæ—¶ï¼Œä¼šæ‹¿åˆ° æ›´æ–°å‰çš„å¿«ç…§å’Œæ›´æ–°åçš„å¿«ç…§ã€‚ç„¶åç”¨æ›´æ–°åçš„å¿«ç…§æ•°æ®å»å¯¹å½“å‰çš„æ•°æ®åº“æ•°æ®åšå¯¹æ¯”ï¼Œåˆ¤æ–­æ˜¯å¦ä¸€è‡´ï¼Œå¦‚æœä¸ä¸€è‡´å°±ä¼šè®°å½•å¼‚å¸¸ï¼Œå‘é€è­¦å‘Šï¼Œäººå·¥ä»‹å…¥</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310181414617.png\" alt=\"image-20231018141424667\"></p>\n<blockquote>\n<p><strong>æ€»ç»“</strong>ï¼š</p>\n<p>AT æ¨¡å¼çš„ä¼˜ç‚¹ï¼š</p>\n<ul>\n<li>ä¸€é˜¶æ®µå®Œæˆç›´æ¥æäº¤äº‹åŠ¡ï¼Œé‡Šæ”¾æ•°æ®åº“èµ„æºï¼Œæ€§èƒ½æ¯”è¾ƒå¥½</li>\n<li>åˆ©ç”¨å…¨å±€é”å®ç°è¯»å†™éš”ç¦»</li>\n<li>æ²¡æœ‰ä»£ç ä¾µå…¥ï¼Œæ¡†æ¶è‡ªåŠ¨å®Œæˆå›æ»šå’Œæäº¤</li>\n</ul>\n<p>AT æ¨¡å¼çš„ç¼ºç‚¹ï¼š</p>\n<ul>\n<li>ä¸¤é˜¶æ®µä¹‹é—´å±äºè½¯çŠ¶æ€ï¼Œå±äºæœ€ç»ˆä¸€è‡´</li>\n<li>æ¡†æ¶çš„å¿«ç…§åŠŸèƒ½ä¼šå½±å“æ€§èƒ½ï¼Œä½†æ¯” XA æ¨¡å¼å¥½å¾ˆå¤š</li>\n</ul>\n</blockquote>\n<h4 id=\"2425-å®ç°atæ¨¡å¼\"><a class=\"markdownIt-Anchor\" href=\"#2425-å®ç°atæ¨¡å¼\">#</a> 2.4.2.5ã€å®ç° AT æ¨¡å¼ğŸŒ´</h4>\n<p>AT æ¨¡å¼ä¸­çš„å¿«ç…§ç”Ÿæˆï¼Œå›æ»šç­‰åŠ¨ä½œéƒ½æ˜¯ç”±æ¡†æ¶è‡ªåŠ¨å®Œæˆï¼Œæ²¡æœ‰ä»»ä½•ä»£ç ä¾µå…¥ï¼Œå› æ­¤å®ç°éå¸¸ç®€å•ã€‚</p>\n<p>1ã€å¯¼å…¥ SQL æ–‡ä»¶ï¼šseata-at.sqlã€‚æ‰“å¼€ sql æ–‡ä»¶å…¶ä¸­ lock_table å¯¼å…¥åˆ° TC æœåŠ¡å…³è”çš„æ•°æ®åº“ï¼Œundo_log è¡¨å¯¼å…¥åˆ°å¾®æœåŠ¡ç®¡ç†çš„æ•°æ®åº“ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310181426661.png\" alt=\"image-20231018142639716\"></p>\n<p>2ã€ä¿®æ”¹ application.yml æ–‡ä»¶ï¼Œå°†äº‹åŠ¡æ¨¡å¼ä¿®æ”¹ä¸º AT æ¨¡å¼å³å¯ï¼š</p>\n<figure class=\"highlight yml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">seata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">data-source-proxy-mode</span><span class=\"token punctuation\">:</span> AT <span class=\"token comment\"># å¼€å¯æ•°æ®æºä»£ç†çš„ AT æ¨¡å¼</span></pre></td></tr></table></figure><p>3ã€é‡å¯æœåŠ¡å¹¶æµ‹è¯•</p>\n<p>ç›®å‰çš„æ•°æ®åº“æ•°æ®</p>\n<p>account_tbl è¡¨çš„æ•°æ®</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310181429533.png\" alt=\"image-20231018142929459\"></p>\n<p>storage_tbl è¡¨çš„æ•°æ®</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310181429518.png\" alt=\"image-20231018142946308\"></p>\n<p>ä½¿ç”¨ postman è¿›è¡Œæµ‹è¯•</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310181430146.png\" alt=\"image-20231018143051522\"></p>\n<p>æµ‹è¯•åçš„ account_tbl è¡¨çš„æ•°æ®</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310181431746.png\" alt=\"image-20231018143114523\"></p>\n<p>æµ‹è¯•åçš„ storage_tbl è¡¨çš„æ•°æ®</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310181431267.png\" alt=\"image-20231018143133064\"></p>\n<p>ä½¿ç”¨ postman è¿›è¡Œä¸€æ¬¡å¤±è´¥çš„æµ‹è¯•ï¼š</p>\n<p>åº“å­˜æ•°æ®ç°åœ¨ä¸å¤Ÿ 10 ä¸ªæˆ‘ä»¬æ‰£å‡ 10 ä¸ªæ­¤æ—¶å°±ä¼šäº§ç”Ÿå¼‚å¸¸</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310181432899.png\" alt=\"image-20231018143222278\"></p>\n<p>æµ‹è¯•åçš„ account_tbl è¡¨çš„æ•°æ®</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310181432696.png\" alt=\"image-20231018143252735\"></p>\n<p>æµ‹è¯•åçš„ storage_tbl è¡¨çš„æ•°æ®</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310181433130.png\" alt=\"image-20231018143302062\"></p>\n<p>å¯ä»¥å‘ç°æ²¡æœ‰å‘ç”Ÿä»»ä½•çš„å˜åŒ–å•Šã€‚è¯´æ˜äº‹åŠ¡ç”Ÿæ•ˆäº†ï¼Œæ•´ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡éƒ½å›æ»šäº†</p>\n<p>accountApplication æœåŠ¡åœ¨ idea æ§åˆ¶å°ä¸­æ‰“å°çš„ä¿¡æ¯å¦‚ä¸‹ï¼š</p>\n<p>å¯ä»¥çœ‹åˆ°æœ€ç»ˆåˆ é™¤äº†ä¸€ä¸ªå« undo_log çš„è¡¨çš„æ•°æ®ä¹Ÿå°±æ˜¯å¿«ç…§æ•°æ®</p>\n<pre><code>10-18 14:32:15:309  INFO 19080 --- [h_RMROLE_1_2_16] i.s.c.r.p.c.RmBranchRollbackProcessor    : rm handle branch rollback process:xid=192.168.45.1:8091:4251845158843265037,branchId=4251845158843265039,branchType=AT,resourceId=jdbc:mysql:///seata_demo,applicationData=null\n10-18 14:32:15:310  INFO 19080 --- [h_RMROLE_1_2_16] io.seata.rm.AbstractRMHandler            : Branch Rollbacking: 192.168.45.1:8091:4251845158843265037 4251845158843265039 jdbc:mysql:///seata_demo\n10-18 14:32:15:347  INFO 19080 --- [h_RMROLE_1_2_16] i.s.r.d.undo.AbstractUndoLogManager      : xid 192.168.45.1:8091:4251845158843265037 branch 4251845158843265039, undo_log deleted with GlobalFinished\n10-18 14:32:15:348  INFO 19080 --- [h_RMROLE_1_2_16] io.seata.rm.AbstractRMHandler            : Branch Rollbacked result: PhaseTwo_Rollbacked\n</code></pre>\n<h4 id=\"2426-tccæ¨¡å¼åŸç†\"><a class=\"markdownIt-Anchor\" href=\"#2426-tccæ¨¡å¼åŸç†\">#</a> 2.4.2.6ã€TCC æ¨¡å¼åŸç†ğŸŒ´</h4>\n<p>TCC æ¨¡å¼ä¸ AT æ¨¡å¼éå¸¸ç›¸ä¼¼ï¼Œæ¯é˜¶æ®µéƒ½æ˜¯ç‹¬ç«‹äº‹åŠ¡ï¼Œä¸åŒçš„æ˜¯ TCC é€šè¿‡äººå·¥ç¼–ç æ¥å®ç°æ•°æ®æ¢å¤ã€‚éœ€è¦å®ç°ä¸‰ä¸ªæ–¹æ³•ï¼š</p>\n<p>1ã€Tryï¼šèµ„æºçš„æ£€æµ‹å’Œé¢„ç•™</p>\n<p>2ã€Confirmï¼šå®Œæˆèµ„æºæ“ä½œä¸šåŠ¡ï¼›è¦æ±‚ Try æˆåŠŸ Confirm ä¸€å®šè¦èƒ½æˆåŠŸ</p>\n<p>3ã€Cancelï¼šé¢„ç•™èµ„æºé‡Šæ”¾ï¼Œå¯ä»¥ç†è§£ä¸º try çš„åå‘æ“ä½œ</p>\n<p>ä¸¾ä¾‹ï¼Œä¸€ä¸ªæ‰£å‡ç”¨æˆ·ä½™é¢çš„ä¸šåŠ¡ã€‚å‡è®¾è´¦æˆ· A åŸæ¥ä½™é¢æ˜¯ 100ï¼Œéœ€è¦ä½™é¢æ‰£å‡ 30 å…ƒ</p>\n<ul>\n<li>\n<p>é˜¶æ®µä¸€ (Try)ï¼šæ£€æŸ¥ä½™é¢æ˜¯å¦å……è¶³ï¼Œå¦‚æœå……è¶³åˆ™å†»ç»“é‡‘é¢å¢åŠ  30 å…ƒï¼Œå¯ç”¨ä½™é¢æ‰£é™¤ 30</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310181448987.png\" alt=\"image-20231018144806649\"></p>\n</li>\n<li>\n<p>é˜¶æ®µäºŒ (Confirm)ï¼šå‡å¦‚è¦æäº¤ï¼Œåˆ™å†»ç»“é‡‘é¢æ‰£å‡ 30</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310181448879.png\" alt=\"image-20231018144815748\"></p>\n</li>\n<li>\n<p>é˜¶æ®µäºŒ (Cancel)ï¼šå¦‚æœè¦å›æ»šï¼Œåˆ™å†»ç»“é‡‘é¢æ‰£å‡ 30ï¼Œå¯ç”¨ä½™é¢å¢åŠ  30</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310181448428.png\" alt=\"image-20231018144824406\"></p>\n</li>\n</ul>\n<p>TCC çš„å·¥ä½œæ¨¡å‹å›¾ï¼š</p>\n<p>ç”± TM å¼€å¯å¹¶æ³¨å†Œå…¨å±€äº‹åŠ¡åˆ° TC ä¸Šï¼Œç„¶å TM é€šçŸ¥æ¯ä¸€ä¸ªåˆ†æ”¯äº‹åŠ¡å»æ‰§è¡Œï¼Œåˆ†æ”¯äº‹åŠ¡è¢« RM åšæ‹¦æˆªï¼ŒRM å…ˆå»æ³¨å†Œä¸€ä¸‹åˆ†æ”¯äº‹åŠ¡ã€‚ç„¶åå†æ‰§è¡Œæ“ä½œï¼Œç¬¬ä¸€é˜¶æ®µè¿›è¡Œ Tryã€‚Try æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„èµ„æºä¼šç›´æ¥æäº¤ï¼Œæäº¤åæŠ¥å‘Šäº‹åŠ¡çš„çŠ¶æ€ã€‚äºŒé˜¶æ®µï¼šTM é€šçŸ¥ TC äº‹åŠ¡ç»“æŸäº†ï¼Œç„¶å TC åšäº‹åŠ¡çŠ¶æ€çš„åˆ¤æ–­ï¼Œçœ‹çœ‹åˆ†æ”¯èµ„æºå¤Ÿä¸å¤Ÿã€‚å¦‚æœå¤Ÿç›´æ¥ Confirm æäº¤ï¼Œå¦‚æœä¸å¤Ÿå°±æ‰§è¡Œ Cancel é€»è¾‘è¿›è¡Œå›æ»šã€‚</p>\n<p>è€Œè¿™ä¸‰ä¸ª Tryï¼ŒConfirmï¼ŒCancel éƒ½æ˜¯éœ€è¦äººå·¥ç¼–å†™çš„</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310181456139.png\" alt=\"image-20231018145621001\"></p>\n<blockquote>\n<p><strong>æ€»ç»“</strong>ï¼š</p>\n<p>TCC æ¨¡å¼çš„æ¯ä¸ªé˜¶æ®µæ˜¯åšä»€ä¹ˆçš„ï¼Ÿ</p>\n<ul>\n<li>Tryï¼šèµ„æºæ£€æŸ¥å’Œé¢„ç•™</li>\n<li>Confirmï¼šä¸šåŠ¡æ‰§è¡Œå’Œæäº¤</li>\n<li>Cancelï¼šé¢„ç•™èµ„æºçš„é‡Šæ”¾</li>\n</ul>\n<p>TCC çš„ä¼˜ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ</p>\n<ul>\n<li>ä¸€é˜¶æ®µå®Œæˆç›´æ¥æäº¤äº‹åŠ¡ï¼Œé‡Šæ”¾æ•°æ®åº“èµ„æºï¼Œæ€§èƒ½å¥½</li>\n<li>ç›¸æ¯” AT æ¨¡å‹ï¼Œæ— éœ€ç”Ÿæˆå¿«ç…§ï¼Œæ— éœ€ä½¿ç”¨å…¨å±€é”ï¼Œæ€§èƒ½æœ€å¼º</li>\n<li>ä¸ä¾èµ–æ•°æ®åº“äº‹åŠ¡ï¼Œè€Œæ˜¯ä¾èµ–è¡¥å¿æ“ä½œï¼Œå¯ä»¥ç”¨äºéäº‹åŠ¡å‹æ•°æ®åº“æ¯”å¦‚ï¼šredis</li>\n</ul>\n<p>TCC çš„ç¼ºç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ</p>\n<ul>\n<li>æœ‰ä»£ç ä¾µå…¥ï¼Œéœ€è¦è®¤ä¸ºç¼–å†™ Tryï¼ŒConfirm å’Œ Cancel æ¥å£ï¼Œå¤ªéº»çƒ¦</li>\n<li>è½¯çŠ¶æ€ï¼Œäº‹åŠ¡æ˜¯æœ€ç»ˆä¸€è‡´</li>\n<li>éœ€è¦è€ƒè™‘ Confirm å’Œ Cancel çš„å¤±è´¥æƒ…å†µï¼Œåšå¥½å¹‚ç­‰å¤„ç†</li>\n</ul>\n</blockquote>\n<h5 id=\"24261-æ¡ˆä¾‹æ”¹é€ account-serviceæœåŠ¡åˆ©ç”¨tccå®ç°åˆ†å¸ƒå¼äº‹åŠ¡\"><a class=\"markdownIt-Anchor\" href=\"#24261-æ¡ˆä¾‹æ”¹é€ account-serviceæœåŠ¡åˆ©ç”¨tccå®ç°åˆ†å¸ƒå¼äº‹åŠ¡\">#</a> 2.4.2.6.1ã€æ¡ˆä¾‹ï¼Œæ”¹é€  account-service æœåŠ¡ï¼Œåˆ©ç”¨ TCC å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ğŸ‹</h5>\n<p>éœ€æ±‚å¦‚ä¸‹ï¼š</p>\n<p>1ã€ä¿®æ”¹ acoount-serviceï¼Œç¼–å†™ Tryï¼ŒConfirmï¼ŒCancel é€»è¾‘</p>\n<p>2ã€Try ä¸šåŠ¡ï¼šæ·»åŠ å†»ç»“é‡‘é¢ï¼Œæ‰£å‡å¯ç”¨é‡‘é¢</p>\n<p>3ã€Confirm ä¸šåŠ¡ï¼šåˆ é™¤å†»ç»“é‡‘é¢</p>\n<p>4ã€Cancel ä¸šåŠ¡ï¼šåˆ é™¤å†»ç»“é‡‘é¢ï¼Œæ¢å¤å¯ç”¨é‡‘é¢</p>\n<p>5ã€ä¿è¯ Confirmï¼ŒCancel æ¥å£çš„<font color='red'>å¹‚ç­‰æ€§</font>.</p>\n<p>6ã€å…è®¸<font color='red'>ç©ºå›æ»š</font>.</p>\n<p>7ã€æ‹’ç»<font color='red'>ä¸šåŠ¡æ‚¬æŒ‚</font>.</p>\n<h5 id=\"24262-tccçš„ç©ºå›æ»šå’Œä¸šåŠ¡æ‚¬æŒ‚\"><a class=\"markdownIt-Anchor\" href=\"#24262-tccçš„ç©ºå›æ»šå’Œä¸šåŠ¡æ‚¬æŒ‚\">#</a> 2.4.2.6.2ã€TCC çš„ç©ºå›æ»šå’Œä¸šåŠ¡æ‚¬æŒ‚ğŸ‹</h5>\n<blockquote>\n<p>å½“æŸåˆ†æ”¯äº‹åŠ¡çš„ try é˜¶æ®µé˜»å¡æ—¶ï¼Œå¯èƒ½å¯¼è‡´å…¨å±€äº‹åŠ¡è¶…æ—¶è€Œè§¦å‘äºŒé˜¶æ®µçš„ cancel æ“ä½œã€‚åœ¨æœªæ‰§è¡Œ try æ“ä½œæ—¶å…ˆæ‰§è¡Œäº† cancel æ“ä½œï¼Œè¿™æ—¶ cancel ä¸èƒ½åšå›æ»šï¼Œå°±æ˜¯<font color='red'>ç©ºå›æ»š</font>.</p>\n<p>å› æ­¤ä¹Ÿä¸èƒ½æŠ¥é”™ã€‚æŠ¥é”™å°±ä¼šé‡è¯•å°±ä¼šé™·å…¥ä¸€ä¸ªæ­»å¾ªç¯ä¸­ã€‚</p>\n<p>å¯¹äºå·²ç»ç©ºå›æ»šçš„ä¸šåŠ¡ï¼Œå¦‚æœä»¥åç»§ç»­æ‰§è¡Œ tryï¼Œå°±æ°¸è¿œä¸å¯èƒ½ Confirm æˆ– Cancelï¼Œè¿™å°±æ˜¯<font color='red'>ä¸šåŠ¡æ‚¬æŒ‚</font>ã€‚åº”å½“é˜»æ­¢æ‰§è¡Œç©ºå›æ»šåçš„ try æ“ä½œï¼Œé¿å…æ‚¬æŒ‚</p>\n</blockquote>\n<p>å½“ç¬¬äºŒä¸ªäº‹åŠ¡å»æ‰§è¡Œçš„æ—¶å€™å°±ä¼šè¢«é˜»å¡ï¼Œé˜»å¡åå¾—ä¸åˆ°æ‰§è¡Œ TM å°±ä¼šå¡åœ¨è¿™é‡Œï¼Œç­‰å¾…è¶…æ—¶åå°±ä¼šæŠ¥ä¸€ä¸ªé”™è¯¯ç»™ TC äº†ï¼ŒTC æ­¤æ—¶å°±ä¼šè¿”å›ä¸€ä¸ªå›æ»šçš„é€šçŸ¥äºæ˜¯ RM å°±ä¼šæ‰§è¡Œ Cancel çš„é€»è¾‘äº†ã€‚</p>\n<p>ç¬¬ä¸€ä¸ªåˆ†æ”¯æ‰§è¡Œ Cancel æ²¡é—®é¢˜å› ä¸ºå®ƒå·²ç» Try äº†ï¼Œä½†æ˜¯ç¬¬äºŒä¸ªåˆ†æ”¯å°±å‡ºé—®é¢˜äº† è¿˜æ²¡å†»ç»“é‡‘é¢å°±å»æ¢å¤é‡‘é¢å»äº†</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310181514887.png\" alt=\"image-20231018151440530\"></p>\n<p>â€‹</p>\n<p><strong>ä¸šåŠ¡åˆ†æ</strong></p>\n<p>ä¸ºäº†å®ç°ç©ºå›æ»šï¼Œé˜²æ­¢ä¸šåŠ¡æ‚¬æŒ‚ï¼Œä»¥åŠå¹‚ç­‰æ€§è¦æ±‚ã€‚æˆ‘ä»¬å¿…é¡»åœ¨æ•°æ®åº“è®°å½•å†»ç»“é‡‘é¢çš„åŒæ—¶ï¼Œè®°å½•å½“å‰äº‹åŠ¡ id å’Œæ‰§è¡ŒçŠ¶æ€ï¼Œä¸ºæ­¤æˆ‘ä»¬è®¾è®¡äº†ä¸€å¼ è¡¨ (account_freeze_tbl è¿™ä¸ªè¡¨åœ¨é¡¹ç›®ä¸­ sql æ–‡ä»¶å¤¹å·²ç»æä¾›äº†)ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310181702525.png\" alt=\"image-20231018170230443\"></p>\n<p>æœ‰äº†è¡¨åæˆ‘ä»¬è¿˜éœ€è¦åˆ›å»ºå®ä½“ç±»å’Œ mapper</p>\n<p>å®ä½“ç±»</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Data</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token annotation punctuation\">@TableName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"account_freeze_tbl\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AccountFreeze</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token annotation punctuation\">@TableId</span><span class=\"token punctuation\">(</span>type <span class=\"token operator\">=</span> <span class=\"token class-name\">IdType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">INPUT</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> xid<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> userId<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Integer</span> freezeMoney<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Integer</span> state<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">State</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">int</span> <span class=\"token constant\">TRY</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">int</span> <span class=\"token constant\">CONFIRM</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">int</span> <span class=\"token constant\">CANCEL</span> <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>mapper</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">AccountFreezeMapper</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">BaseMapper</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">AccountFreeze</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h5 id=\"24263-å£°æ˜tccæ¥å£\"><a class=\"markdownIt-Anchor\" href=\"#24263-å£°æ˜tccæ¥å£\">#</a> 2.4.2.6.3ã€å£°æ˜ TCC æ¥å£ï¼š</h5>\n<p>TCC çš„ Tryï¼ŒConfirmï¼ŒCancel æ–¹æ³•éƒ½éœ€è¦åœ¨æ¥å£ä¸­åŸºäºæ³¨è§£æ¥å£°æ˜ï¼Œè¯­æ³•å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@LocalTCC</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">AccountTCCService</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   <span class=\"token comment\">// Try é€»è¾‘ï¼Œ@TwoPhaseBusinessAction ä¸­çš„ name å±æ€§è¦ä¸å½“å‰æ–¹æ³•åä¸€è‡´ï¼Œç”¨äºæŒ‡å®š Try é€»è¾‘å¯¹åº”æ–¹æ³•</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token annotation punctuation\">@TwoPhaseBusinessAction</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"deduct\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            commitMethod <span class=\"token operator\">=</span> <span class=\"token string\">\"confirm\"</span><span class=\"token punctuation\">,</span> rollbackMethod <span class=\"token operator\">=</span> <span class=\"token string\">\"cancel\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">void</span> <span class=\"token function\">deduct</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@BusinessActionContextParameter</span><span class=\"token punctuation\">(</span>paramName <span class=\"token operator\">=</span> <span class=\"token string\">\"userId\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">String</span> userId<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                <span class=\"token annotation punctuation\">@BusinessActionContextParameter</span><span class=\"token punctuation\">(</span>paramName <span class=\"token operator\">=</span> <span class=\"token string\">\"money\"</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">int</span> money<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   <span class=\"token comment\">// äºŒé˜¶æ®µ confirm ç¡®è®¤æ–¹æ³•ï¼Œå¯ä»¥å¦å‘½åï¼Œä½†è¦ä¿è¯ä¸ commitMethod ä¸€è‡´</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   <span class=\"token comment\">// @Param context ä¸Šä¸‹æ–‡ï¼Œå¯ä»¥ä¼ é€’ Try æ–¹æ³•çš„å‚æ•°</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   <span class=\"token comment\">// @return boolean æ‰§è¡Œæ˜¯å¦æˆåŠŸ</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   <span class=\"token keyword\">boolean</span> <span class=\"token function\">confirm</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">BusinessActionContext</span> ctx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   <span class=\"token comment\">// äºŒé˜¶æ®µå›æ»šæ–¹æ³•ï¼Œè¦ä¿è¯ä¸ rollbackMethod ä¸€è‡´</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">boolean</span> <span class=\"token function\">cancel</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">BusinessActionContext</span> ctx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>å®ç°ç±»ï¼š</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Slf4j</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token annotation punctuation\">@Service</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AccountTccServiceImpl</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">AccountTCCService</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">AccountMapper</span> mapper<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">AccountFreezeMapper</span> freezeMapper<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">AccountTccServiceImpl</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">AccountMapper</span> mapper<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                                 <span class=\"token class-name\">AccountFreezeMapper</span> freezeMapper<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>mapper <span class=\"token operator\">=</span> mapper<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>freezeMapper <span class=\"token operator\">=</span> freezeMapper<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token annotation punctuation\">@Transactional</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">deduct</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> userId<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> money<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token comment\">// 1. è·å–äº‹åŠ¡ id</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token class-name\">String</span> xid <span class=\"token operator\">=</span> <span class=\"token class-name\">RootContext</span><span class=\"token punctuation\">.</span><span class=\"token function\">getXID</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token comment\">// 1.1. åˆ¤æ–­ freeze ä¸­æ˜¯å¦æœ‰å†»ç»“è®°å½•ï¼Œå¦‚æœæœ‰ï¼Œä¸€å®šæ˜¯ CANCEL æ‰§è¡Œè¿‡ï¼Œè¦æ‹’ç»ä¸šåŠ¡</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token class-name\">AccountFreeze</span> freeze1 <span class=\"token operator\">=</span> freezeMapper<span class=\"token punctuation\">.</span><span class=\"token function\">selectById</span><span class=\"token punctuation\">(</span>xid<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>freeze1 <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            <span class=\"token comment\">// CANCEL æ‰§è¡Œè¿‡ï¼Œè¦æ‹’ç»ä¸šåŠ¡</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token comment\">// 2. æ‰£å‡å¯ç”¨ä½™é¢</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        mapper<span class=\"token punctuation\">.</span><span class=\"token function\">deduct</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">,</span> money<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        <span class=\"token comment\">// 3. è®°å½•å†»ç»“é‡‘é¢ï¼Œäº‹åŠ¡çŠ¶æ€</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token class-name\">AccountFreeze</span> freeze <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AccountFreeze</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        freeze<span class=\"token punctuation\">.</span><span class=\"token function\">setUserId</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        freeze<span class=\"token punctuation\">.</span><span class=\"token function\">setFreezeMoney</span><span class=\"token punctuation\">(</span>money<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        freeze<span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">AccountFreeze<span class=\"token punctuation\">.</span>State</span><span class=\"token punctuation\">.</span><span class=\"token constant\">TRY</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        freeze<span class=\"token punctuation\">.</span><span class=\"token function\">setXid</span><span class=\"token punctuation\">(</span>xid<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        freezeMapper<span class=\"token punctuation\">.</span><span class=\"token function\">insert</span><span class=\"token punctuation\">(</span>freeze<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">confirm</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">BusinessActionContext</span> ctx<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        <span class=\"token comment\">// 1. è·å–äº‹åŠ¡ id</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        <span class=\"token class-name\">String</span> xid <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span><span class=\"token function\">getXid</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        <span class=\"token comment\">// 2. æ ¹æ® id åˆ é™¤å†»ç»“è®°å½•</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        <span class=\"token keyword\">int</span> count <span class=\"token operator\">=</span> freezeMapper<span class=\"token punctuation\">.</span><span class=\"token function\">deleteById</span><span class=\"token punctuation\">(</span>xid<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        <span class=\"token keyword\">return</span> count <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">cancel</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">BusinessActionContext</span> ctx<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        <span class=\"token comment\">// 1. ä»ä¸Šä¸‹æ–‡ä¸­è·å– ç”¨æˆ·çš„ id å’Œä½™é¢</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        <span class=\"token class-name\">String</span> xid <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span><span class=\"token function\">getXid</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        <span class=\"token class-name\">String</span> userId <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span><span class=\"token function\">getActionContext</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"userId\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        <span class=\"token class-name\">AccountFreeze</span> freeze <span class=\"token operator\">=</span> freezeMapper<span class=\"token punctuation\">.</span><span class=\"token function\">selectById</span><span class=\"token punctuation\">(</span>xid<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        <span class=\"token comment\">// 1.1. ç©ºå›æ»šçš„åˆ¤æ–­ï¼Œåˆ¤æ–­ freeze æ˜¯å¦ä¸º nullï¼Œä¸º null è¯æ˜ try æ²¡æœ‰æ‰§è¡Œï¼Œéœ€è¦ç©ºå›æ»š</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>freeze <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>            <span class=\"token comment\">// è¯æ˜ try æ²¡æœ‰æ‰§è¡Œï¼Œéœ€è¦å›æ»š</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>            freeze <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AccountFreeze</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>            freeze<span class=\"token punctuation\">.</span><span class=\"token function\">setUserId</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>            freeze<span class=\"token punctuation\">.</span><span class=\"token function\">setFreezeMoney</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>            freeze<span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">AccountFreeze<span class=\"token punctuation\">.</span>State</span><span class=\"token punctuation\">.</span><span class=\"token constant\">CANCEL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>            freeze<span class=\"token punctuation\">.</span><span class=\"token function\">setXid</span><span class=\"token punctuation\">(</span>xid<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>            freezeMapper<span class=\"token punctuation\">.</span><span class=\"token function\">insert</span><span class=\"token punctuation\">(</span>freeze<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>        <span class=\"token comment\">// 1.2. å¹‚ç­‰åˆ¤æ–­</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>freeze<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token class-name\">AccountFreeze<span class=\"token punctuation\">.</span>State</span><span class=\"token punctuation\">.</span><span class=\"token constant\">CANCEL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>            <span class=\"token comment\">// å·²ç»å¤„ç†è¿‡ä¸€æ¬¡ CANCEL äº†ï¼Œæ— éœ€é‡å¤å¤„ç†</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>        <span class=\"token comment\">// 2. æ¢å¤å¯ç”¨ä½™é¢</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>        mapper<span class=\"token punctuation\">.</span><span class=\"token function\">refund</span><span class=\"token punctuation\">(</span>freeze<span class=\"token punctuation\">.</span><span class=\"token function\">getUserId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> freeze<span class=\"token punctuation\">.</span><span class=\"token function\">getFreezeMoney</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>        <span class=\"token comment\">// 3. å°†å†»ç»“é‡‘é¢æ¸…é›¶ï¼ŒçŠ¶æ€æ”¹ä¸º CANCEL</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>        freeze<span class=\"token punctuation\">.</span><span class=\"token function\">setFreezeMoney</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>        freeze<span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">AccountFreeze<span class=\"token punctuation\">.</span>State</span><span class=\"token punctuation\">.</span><span class=\"token constant\">CANCEL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>        <span class=\"token keyword\">int</span> count <span class=\"token operator\">=</span> freezeMapper<span class=\"token punctuation\">.</span><span class=\"token function\">updateById</span><span class=\"token punctuation\">(</span>freeze<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>        <span class=\"token keyword\">return</span> count <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>ç›®å‰çš„æ•°æ®åº“æ•°æ®</p>\n<p>account_tbl è¡¨çš„æ•°æ®</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310181752228.png\" alt=\"image-20231018175239070\"></p>\n<p>storage_tbl è¡¨çš„æ•°æ®</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310181752894.png\" alt=\"image-20231018175252816\"></p>\n<p>ä½¿ç”¨ postman è¿›è¡Œæµ‹è¯•</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310181753247.png\" alt=\"image-20231018175315999\"></p>\n<p>è¯·æ±‚å®ŒåæŸ¥çœ‹æ•°æ®åº“çš„æ•°æ®</p>\n<p>account_tbl è¡¨çš„æ•°æ®</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310181753982.png\" alt=\"image-20231018175345921\"></p>\n<p>storage_tbl è¡¨çš„æ•°æ®</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310181754323.png\" alt=\"image-20231018175359525\"></p>\n<p>æµ‹è¯•å¤±è´¥çš„ postman è¯·æ±‚</p>\n<p>å› ä¸ºæ­¤æ—¶åº“å­˜çš„æ•°é‡ä¸å¤Ÿ 10 ä¸ªï¼Œæˆ‘ä»¬å‡å» 10 ä¸ªå°±ä¼šäº§ç”Ÿå¼‚å¸¸</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310181754231.png\" alt=\"image-20231018175428861\"></p>\n<p>æŸ¥çœ‹æ•°æ®åº“çš„æ•°æ®æƒ…å†µ</p>\n<p>æµ‹è¯•åçš„ account_tbl è¡¨çš„æ•°æ®</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310181932222.png\" alt=\"image-20231018193221241\"></p>\n<p>æµ‹è¯•åçš„ storage_tbl è¡¨çš„æ•°æ®</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310181932553.png\" alt=\"image-20231018193242522\"></p>\n<p>å¯ä»¥çœ‹åˆ°å®Œæˆäº†æ•°æ®çš„å›æ»š</p>\n<h4 id=\"2427-sagaæ¨¡å¼\"><a class=\"markdownIt-Anchor\" href=\"#2427-sagaæ¨¡å¼\">#</a> 2.4.2.7ã€Saga æ¨¡å¼ğŸŒ´</h4>\n<p>Saga æ¨¡å¼æ˜¯ SEATA æä¾›çš„é•¿äº‹åŠ¡è§£å†³æ–¹æ¡ˆã€‚ä¹Ÿåˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š</p>\n<ul>\n<li>ä¸€é˜¶æ®µï¼šç›´æ¥æäº¤æœ¬åœ°äº‹åŠ¡</li>\n<li>äºŒé˜¶æ®µï¼šæˆåŠŸåˆ™ä»€ä¹ˆéƒ½ä¸åšï¼Œå¤±è´¥åˆ™é€šè¿‡ç¼–å†™è¡¥å¿ä¸šåŠ¡æ¥å›æ»š</li>\n</ul>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310181938269.png\" alt=\"image-20231018193808535\"></p>\n<p>Saga æ¨¡å¼ä¼˜ç‚¹ï¼š</p>\n<p>1ã€äº‹åŠ¡å‚ä¸è€…å¯ä»¥åŸºäºäº‹åŠ¡é©±åŠ¨å®ç°å¼‚æ­¥è°ƒç”¨ï¼Œååé«˜</p>\n<p>2ã€ä¸€é˜¶æ®µç›´æ¥æäº¤äº‹åŠ¡ï¼Œæ— é”ï¼Œæ€§èƒ½å¥½</p>\n<p>3ã€ä¸ç”¨ç¼–å†™ TCC ä¸­çš„ä¸‰ä¸ªé˜¶æ®µï¼Œå®ç°ç®€å•</p>\n<p>ç¼ºç‚¹ï¼š</p>\n<p>1ã€è½¯çŠ¶æ€æ”¯æŒæ—¶é—´ä¸ç¡®å®šï¼Œæ—¶æ•ˆæ€§å·®</p>\n<p>2ã€æ²¡æœ‰é”ï¼Œæ²¡æœ‰äº‹åŠ¡éš”ç¦»ï¼Œä¼šæœ‰è„å†™</p>\n<h4 id=\"2428-å››ç§æ¨¡å¼å¯¹æ¯”\"><a class=\"markdownIt-Anchor\" href=\"#2428-å››ç§æ¨¡å¼å¯¹æ¯”\">#</a> 2.4.2.8ã€å››ç§æ¨¡å¼å¯¹æ¯”ğŸŒ´</h4>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>XA</th>\n<th>AT</th>\n<th>TCC</th>\n<th>SAGA</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>ä¸€è‡´æ€§</td>\n<td>å¼ºä¸€è‡´</td>\n<td>å¼±ä¸€è‡´</td>\n<td>å¼±ä¸€è‡´</td>\n<td>æœ€ç»ˆä¸€è‡´</td>\n</tr>\n<tr>\n<td>éš”ç¦»æ€§</td>\n<td>å®Œå…¨éš”ç¦»</td>\n<td>åŸºäºå…¨å±€é”éš”ç¦»</td>\n<td>åŸºäºèµ„æºé¢„ç•™éš”ç¦»</td>\n<td>æ— éš”ç¦»</td>\n</tr>\n<tr>\n<td>ä»£ç ä¾µå…¥</td>\n<td>æ— </td>\n<td>æ— </td>\n<td>æœ‰ï¼Œè¦ç¼–å†™ä¸‰ä¸ªæ¥å£</td>\n<td>æœ‰ï¼Œè¦ç¼–å†™çŠ¶æ€æœºå’Œè¡¥å¿ä¸šåŠ¡</td>\n</tr>\n<tr>\n<td>æ€§èƒ½</td>\n<td>å·®</td>\n<td>å¥½</td>\n<td>éå¸¸å¥½</td>\n<td>éå¸¸å¥½</td>\n</tr>\n<tr>\n<td>åœºæ™¯</td>\n<td>å¯¹ä¸€è‡´æ€§ï¼Œéš”ç¦»æ€§æœ‰é«˜è¦æ±‚çš„ä¸šåŠ¡</td>\n<td>åŸºäºå…³ç³»å‹æ•°æ®åº“çš„å¤§å¤šæ•°åˆ†å¸ƒå¼åœºæ™¯éƒ½å¯ä»¥</td>\n<td>å¯¹æ€§èƒ½è¦æ±‚è¾ƒé«˜çš„äº‹åŠ¡<br />æœ‰éå…³ç³»å‹æ•°æ®åº“è¦å‚ä¸çš„äº‹åŠ¡</td>\n<td>ä¸šåŠ¡æµç¨‹é•¿ï¼Œä¸šåŠ¡æµç¨‹å¤š<br />å‚ä¸è€…åŒ…å«å…¶å®ƒå…¬å¸æˆ–é—ç•™ç³»ç»ŸæœåŠ¡ï¼Œæ— æ³•æä¾› TCC æ¨¡å¼è¦æ±‚çš„ä¸‰ä¸ªæ¥å£</td>\n</tr>\n</tbody>\n</table>\n<h1 id=\"ä¸‰-é«˜å¯ç”¨\"><a class=\"markdownIt-Anchor\" href=\"#ä¸‰-é«˜å¯ç”¨\">#</a> ä¸‰ã€é«˜å¯ç”¨ğŸ„</h1>\n<ul>\n<li>é«˜å¯ç”¨é›†ç¾¤ç»“æ„</li>\n<li>å®ç°é«˜å¯ç”¨é›†ç¾¤</li>\n</ul>\n<p><strong>TC çš„å¼‚åœ°å¤šæœºæˆ¿å®¹ç¾æ¶æ„</strong></p>\n<p>TC æœåŠ¡ä½œä¸º Seata çš„æ ¸å¿ƒæœåŠ¡ï¼Œä¸€å®šè¦ä¿è¯<mark>é«˜å¯ç”¨</mark>å’Œ<mark>å¼‚åœ°å®¹ç¾</mark>.</p>\n<p>å…·ä½“å®ç°æŸ¥çœ‹æ–‡ç« ï¼š<a href=\"../Seata/seata%E7%9A%84%E9%83%A8%E7%BD%B2%E5%92%8C%E9%9B%86%E6%88%90.md\">seata çš„éƒ¨ç½²å’Œé›†æˆ.md</a>.</p>\n<h1 id=\"å››å¤šçº§ç¼“å­˜\"><a class=\"markdownIt-Anchor\" href=\"#å››å¤šçº§ç¼“å­˜\">#</a> å››ï¼Œå¤šçº§ç¼“å­˜ğŸ„</h1>\n<p>äº¿çº§æµé‡çš„ç¼“å­˜æ–¹æ¡ˆ</p>\n<h2 id=\"41-ä¼ ç»Ÿç¼“å­˜çš„é—®é¢˜\"><a class=\"markdownIt-Anchor\" href=\"#41-ä¼ ç»Ÿç¼“å­˜çš„é—®é¢˜\">#</a> 4.1ã€ä¼ ç»Ÿç¼“å­˜çš„é—®é¢˜ğŸŒ³</h2>\n<p>ä¼ ç»Ÿçš„ç¼“å­˜ç­–ç•¥ä¸€èˆ¬æ˜¯è¯·æ±‚åˆ°è¾¾ Tomcat åï¼Œå…ˆæŸ¥è¯¢ redisï¼Œå¦‚æœæœªå‘½ä¸­åˆ™æŸ¥è¯¢æ•°æ®åº“ï¼Œå­˜åœ¨ä¸‹é¢çš„é—®é¢˜ï¼š</p>\n<p>1ã€è¯·æ±‚è¦ç»è¿‡ Tomcat å¤„ç†ï¼ŒTomcat çš„æ€§èƒ½æˆä¸ºæ•´ä¸ªç³»ç»Ÿçš„ç“¶é¢ˆ</p>\n<p>2ã€Redis ç¼“å­˜å¤±æ•ˆæ—¶ï¼Œä¼šå¯¹æ•°æ®åº“äº§ç”Ÿå†²å‡»</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310191526124.png\" alt=\"image-20231019152653849\"></p>\n<h2 id=\"42-å¤šçº§ç¼“å­˜æ–¹æ¡ˆ\"><a class=\"markdownIt-Anchor\" href=\"#42-å¤šçº§ç¼“å­˜æ–¹æ¡ˆ\">#</a> 4.2ã€å¤šçº§ç¼“å­˜æ–¹æ¡ˆğŸŒ³</h2>\n<p>å¤šçº§ç¼“å­˜å°±æ˜¯å……åˆ†åˆ©ç”¨è¯·æ±‚å¤„ç†çš„æ¯ä¸ªç¯èŠ‚ï¼Œåˆ†åˆ«æ·»åŠ ç¼“å­˜ï¼Œå‡è½» Tomcat å‹åŠ›ï¼Œæå‡æœåŠ¡æ€§èƒ½ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310191532661.png\" alt=\"image-20231019153224519\"></p>\n<p>ç”¨ä½œç¼“å­˜çš„ Nginx æ˜¯ä¸šåŠ¡ Nginxï¼Œéœ€è¦éƒ¨ç½²ä¸ºé›†ç¾¤ï¼Œå†æœ‰ä¸“é—¨çš„ Nginx ç”¨æ¥åšåå‘ä»£ç†ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310191534434.png\" alt=\"image-20231019153411071\"></p>\n<h2 id=\"43-jvmè¿›ç¨‹ç¼“å­˜\"><a class=\"markdownIt-Anchor\" href=\"#43-jvmè¿›ç¨‹ç¼“å­˜\">#</a> 4.3ã€JVM è¿›ç¨‹ç¼“å­˜ğŸŒ³</h2>\n<ul>\n<li>å¯¼å…¥å•†å“æ¡ˆä¾‹</li>\n<li>åˆå§‹ Caffeine</li>\n<li>å®ç°è¿›ç¨‹ç¼“å­˜</li>\n</ul>\n<h3 id=\"431-å¯¼å…¥å•†å“æ¡ˆä¾‹\"><a class=\"markdownIt-Anchor\" href=\"#431-å¯¼å…¥å•†å“æ¡ˆä¾‹\">#</a> 4.3.1ã€å¯¼å…¥å•†å“æ¡ˆä¾‹ğŸŒ²</h3>\n<p>æŸ¥çœ‹æ–‡ç« ï¼š<a href=\"./%E6%A1%88%E4%BE%8B%E5%AF%BC%E5%85%A5%E8%AF%B4%E6%98%8E/%E6%A1%88%E4%BE%8B%E5%AF%BC%E5%85%A5%E8%AF%B4%E6%98%8E.md\">æ¡ˆä¾‹å¯¼å…¥è¯´æ˜</a>.</p>\n<h3 id=\"432-åˆå§‹caffeine\"><a class=\"markdownIt-Anchor\" href=\"#432-åˆå§‹caffeine\">#</a> 4.3.2ã€åˆå§‹ CaffeineğŸŒ²</h3>\n<h4 id=\"4321-æœ¬åœ°è¿›ç¨‹ç¼“å­˜\"><a class=\"markdownIt-Anchor\" href=\"#4321-æœ¬åœ°è¿›ç¨‹ç¼“å­˜\">#</a> 4.3.2.1ã€æœ¬åœ°è¿›ç¨‹ç¼“å­˜ğŸŒ´</h4>\n<p>ç¼“å­˜åœ¨æ—¥å¸¸å¼€å‘ä¸­èµ·åˆ°è‡³å…³é‡è¦çš„ä½œç”¨ã€‚ç”±äºæ˜¯å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œæ•°æ®çš„è¯»å–é€Ÿåº¦æ˜¯éå¸¸å¿«çš„ï¼Œèƒ½å¤§é‡å‡å°‘å¯¹æ•°æ®åº“çš„è®¿é—®ï¼Œå‡å°‘æ•°æ®åº“çš„å‹åŠ›ã€‚æˆ‘ä»¬å§ç¼“å­˜åˆ†ä¸ºä¸¤ç±»ï¼š</p>\n<p>1ã€åˆ†å¸ƒå¼ç¼“å­˜ï¼Œä¾‹å¦‚ Redisï¼š</p>\n<ul>\n<li>ä¼˜ç‚¹ï¼šå­˜å‚¨å®¹é‡æ›´å¤§ï¼Œå¯é æ€§æ›´å¥½ï¼Œå¯ä»¥åœ¨é›†ç¾¤é—´å…±äº«</li>\n<li>ç¼ºç‚¹ï¼šè®¿é—®ç¼“å­˜æœ‰ç½‘ç»œå¼€é”€</li>\n<li>åœºæ™¯ï¼šç¼“å­˜æ•°æ®é‡è¾ƒå¤§ï¼Œå¯é æ€§è¦æ±‚è¾ƒé«˜ï¼Œéœ€è¦åœ¨é›†ç¾¤é—´å…±äº«</li>\n</ul>\n<p>2ã€è¿›ç¨‹æœ¬åœ°ç¼“å­˜ï¼Œä¾‹å¦‚ HashMapï¼ŒGuavaCacheï¼š</p>\n<ul>\n<li>ä¼˜ç‚¹ï¼šè¯»å–æœ¬åœ°å†…å­˜ï¼Œæ²¡æœ‰ç½‘ç»œå¼€é”€ï¼Œé€Ÿåº¦æ›´å¿«</li>\n<li>ç¼ºç‚¹ï¼šå­˜å‚¨å®¹é‡æœ‰é™ï¼Œå¯é æ€§è¾ƒä½ï¼Œæ— æ³•å…±äº«</li>\n<li>åœºæ™¯ï¼šæ€§èƒ½è¦æ±‚è¾ƒé«˜ï¼Œç¼“å­˜æ•°æ®é‡è¾ƒå°</li>\n</ul>\n<p>Caffeine æ˜¯ä¸€ä¸ªåŸºäº java8 å¼€å‘çš„ï¼Œæä¾›äº†è¿‘ä¹æœ€ä½³å‘½ä¸­ç‡çš„é«˜æ€§èƒ½çš„æœ¬åœ°ç¼“å­˜åº“ã€‚ç›®å‰ Spring å†…éƒ¨çš„ç¼“å­˜ä½¿ç”¨çš„å°±æ˜¯ Caffeineã€‚Github åœ°å€ï¼š<a href=\"https://github.com/ben-manes/caffeine\">https://github.com/ben-manes/caffeine</a></p>\n<h5 id=\"43211-caffeineç¤ºä¾‹\"><a class=\"markdownIt-Anchor\" href=\"#43211-caffeineç¤ºä¾‹\">#</a> 4.3.2.1.1ã€Caffeine ç¤ºä¾‹ğŸ‹</h5>\n<p>å¯ä»¥é€šè¿‡ item-service é¡¹ç›®ä¸­çš„å•å…ƒæµ‹è¯•æ¥å­¦ä¹  Caffeine çš„ä½¿ç”¨ï¼š</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Test</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">testBasicOpsTwo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   <span class=\"token comment\">// 1. æ„å»º cache å¯¹è±¡</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   <span class=\"token class-name\">Cache</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> cache <span class=\"token operator\">=</span> <span class=\"token class-name\">Caffeine</span><span class=\"token punctuation\">.</span><span class=\"token function\">newBuilder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   <span class=\"token comment\">// 2. å­˜æ•°æ®</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   cache<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"gf\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"éƒ­æ˜ç„¶\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   <span class=\"token comment\">// 3. å–æ•°æ®</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   <span class=\"token class-name\">String</span> gf <span class=\"token operator\">=</span> cache<span class=\"token punctuation\">.</span><span class=\"token function\">getIfPresent</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"gf\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"gf = \"</span> <span class=\"token operator\">+</span> gf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   <span class=\"token comment\">// 4. å–æ•°æ®ï¼Œå¦‚æœæœªå‘½ä¸­ï¼Œåˆ™æŸ¥è¯¢æ•°æ®åº“</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   <span class=\"token class-name\">String</span> defaultGF <span class=\"token operator\">=</span> cache<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"defaultGF\"</span><span class=\"token punctuation\">,</span> key <span class=\"token operator\">-></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token comment\">// 4.1. æ ¹æ® key å»æŸ¥è¯¢æ•°æ®åº“</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token keyword\">return</span> <span class=\"token string\">\"æ˜¯ä¸ªå‚»å­\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>   <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>   <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"defaultGF = \"</span> <span class=\"token operator\">+</span> defaultGF<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\">//------------------ æ‰§è¡Œç»“æœ ------------------</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>gf <span class=\"token operator\">=</span> éƒ­æ˜ç„¶</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>defaultGF <span class=\"token operator\">=</span> æ˜¯ä¸ªå‚»å­</pre></td></tr></table></figure><p>Caffeine æä¾›äº†ä¸‰ç§ç¼“å­˜é©±é€ç­–ç•¥ï¼š</p>\n<p>1ã€åŸºäºå®¹é‡ï¼šè®¾ç½®ç¼“å­˜çš„æ•°é‡ä¸Šé™</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Test</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">testBasicOpsTwo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   <span class=\"token comment\">// 1. æ„å»º cache å¯¹è±¡</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   <span class=\"token class-name\">Cache</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> cache <span class=\"token operator\">=</span> <span class=\"token class-name\">Caffeine</span><span class=\"token punctuation\">.</span><span class=\"token function\">newBuilder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      <span class=\"token punctuation\">.</span><span class=\"token function\">maximumSize</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// è®¾ç½®ç¼“å­˜å¤§å°ä¸Šé™ä¸º 1</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   <span class=\"token comment\">// 2. å­˜æ•°æ®</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   cache<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"gf\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"éƒ­æ˜ç„¶\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   cache<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"gf1\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"éƒ­æ˜ç„¶1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   cache<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"gf2\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"éƒ­æ˜ç„¶2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   <span class=\"token comment\">//        try &#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>   <span class=\"token comment\">//            // å»¶è¿Ÿ 10msï¼Œç»™æ¸…ç†çº¿ç¨‹ä¸€ç‚¹æ—¶é—´</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>   <span class=\"token comment\">//            Thread.sleep(100);</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>   <span class=\"token comment\">//        &#125; catch (InterruptedException e) &#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>   <span class=\"token comment\">//            throw new RuntimeException(e);</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>   <span class=\"token comment\">//        &#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>   <span class=\"token comment\">// 3. å–æ•°æ®</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>   <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>cache<span class=\"token punctuation\">.</span><span class=\"token function\">getIfPresent</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"gf\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>   <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>cache<span class=\"token punctuation\">.</span><span class=\"token function\">getIfPresent</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"gf1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>   <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>cache<span class=\"token punctuation\">.</span><span class=\"token function\">getIfPresent</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"gf2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\">//---------------- æ‰“å°ç»“æœ ----------------</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>éƒ­æ˜ç„¶</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>éƒ­æ˜ç„¶<span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>éƒ­æ˜ç„¶<span class=\"token number\">2</span></pre></td></tr></table></figure><p>ä½¿ç”¨çº¿ç¨‹ç¡çœ è®©å…¶ç­‰å¾… 10ms ç»™æ¸…ç†çº¿ç¨‹ä¸€ç‚¹æ—¶é—´</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Test</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">testBasicOpsTwo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   <span class=\"token comment\">// 1. æ„å»º cache å¯¹è±¡</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   <span class=\"token class-name\">Cache</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> cache <span class=\"token operator\">=</span> <span class=\"token class-name\">Caffeine</span><span class=\"token punctuation\">.</span><span class=\"token function\">newBuilder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      <span class=\"token punctuation\">.</span><span class=\"token function\">maximumSize</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// è®¾ç½®ç¼“å­˜å¤§å°ä¸Šé™ä¸º 1</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   <span class=\"token comment\">// 2. å­˜æ•°æ®</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   cache<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"gf\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"éƒ­æ˜ç„¶\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   cache<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"gf1\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"éƒ­æ˜ç„¶1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   cache<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"gf2\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"éƒ­æ˜ç„¶2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>       <span class=\"token comment\">// å»¶è¿Ÿ 10msï¼Œç»™æ¸…ç†çº¿ç¨‹ä¸€ç‚¹æ—¶é—´</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>       <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">10l</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>   <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>       <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RuntimeException</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>   <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>   <span class=\"token comment\">// 3. å–æ•°æ®</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>   <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>cache<span class=\"token punctuation\">.</span><span class=\"token function\">getIfPresent</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"gf\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>   <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>cache<span class=\"token punctuation\">.</span><span class=\"token function\">getIfPresent</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"gf1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>   <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>cache<span class=\"token punctuation\">.</span><span class=\"token function\">getIfPresent</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"gf2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\">//---------------- æ‰“å°ç»“æœ ----------------</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token keyword\">null</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token keyword\">null</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>éƒ­æ˜ç„¶<span class=\"token number\">2</span></pre></td></tr></table></figure><p>2ã€åŸºäºæ—¶é—´ï¼šè®¾ç½®ç¼“å­˜çš„æœ‰æ•ˆæ—¶é—´</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Test</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">testBasicOpsTwo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   <span class=\"token comment\">// 1. æ„å»º cache å¯¹è±¡</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   <span class=\"token class-name\">Cache</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> cache <span class=\"token operator\">=</span> <span class=\"token class-name\">Caffeine</span><span class=\"token punctuation\">.</span><span class=\"token function\">newBuilder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      <span class=\"token punctuation\">.</span><span class=\"token function\">expireAfterWrite</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Duration</span><span class=\"token punctuation\">.</span><span class=\"token function\">ofSeconds</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// è®¾ç½®ç¼“å­˜æœ‰æ•ˆæœŸä¸º 10 ç§’ï¼Œä»æœ€åä¸€æ¬¡å†™å…¥å¼€å§‹è®¡æ—¶</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   <span class=\"token comment\">// 2. å­˜æ•°æ®</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   cache<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"gf\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"éƒ­æ˜ç„¶\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   cache<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"gf1\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"éƒ­æ˜ç„¶1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   cache<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"gf2\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"éƒ­æ˜ç„¶2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   <span class=\"token comment\">// 3. å–æ•°æ®</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>   <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>cache<span class=\"token punctuation\">.</span><span class=\"token function\">getIfPresent</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"gf\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>   <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      <span class=\"token comment\">// å»¶è¿Ÿ 10msï¼Œç»™æ¸…ç†çº¿ç¨‹ä¸€ç‚¹æ—¶é—´</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">11000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>   <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RuntimeException</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>   <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>   <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>cache<span class=\"token punctuation\">.</span><span class=\"token function\">getIfPresent</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"gf1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>   <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>cache<span class=\"token punctuation\">.</span><span class=\"token function\">getIfPresent</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"gf2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\">//------------------- æ‰“å°ç»“æœ -------------------</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>éƒ­æ˜ç„¶</pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token keyword\">null</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token keyword\">null</span></pre></td></tr></table></figure><p>3ã€åŸºäºå¼•ç”¨ï¼šè®¾ç½®ç¼“å­˜ä¸ºè½¯å¼•ç”¨æˆ–å¼±å¼•ç”¨ï¼Œåˆ©ç”¨ GC æ¥å›æ”¶ç¼“å­˜æ•°æ®ã€‚æ€§èƒ½è¾ƒå·®ï¼Œä¸å»ºè®®ä½¿ç”¨ã€‚</p>\n<p><mark>è½¯å¼•ç”¨</mark>ï¼šå†…å­˜ä¸è¶³æ—¶æ‰ä¼šå›æ”¶ï¼›       <mark>å¼±å¼•ç”¨</mark>ï¼šå°±ç®—å†…å­˜å……è¶³æ—¶ä¹Ÿä¼šå›æ”¶ï¼›</p>\n<p>åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“ä¸€ä¸ªç¼“å­˜å…ƒç´ è¿‡æœŸçš„æ—¶å€™ï¼ŒCaffeine ä¸ä¼šè‡ªåŠ¨ç«‹å³å°†å…¶æ¸…ç†å’Œé©±é€ã€‚è€Œæ˜¯åœ¨ä¸€æ¬¡è¯»æˆ–å†™æ“ä½œåï¼Œæˆ–è€…åœ¨ç©ºé—²æ—¶é—´å®Œæˆå¯¹å¤±æ•ˆæ•°æ®çš„é©±é€ã€‚</p>\n<h3 id=\"433-å®ç°è¿›ç¨‹ç¼“å­˜\"><a class=\"markdownIt-Anchor\" href=\"#433-å®ç°è¿›ç¨‹ç¼“å­˜\">#</a> 4.3.3ã€å®ç°è¿›ç¨‹ç¼“å­˜ğŸŒ²</h3>\n<h4 id=\"4331-æ¡ˆä¾‹å®ç°å•†å“çš„æŸ¥è¯¢çš„æœ¬åœ°è¿›ç¨‹ç¼“å­˜\"><a class=\"markdownIt-Anchor\" href=\"#4331-æ¡ˆä¾‹å®ç°å•†å“çš„æŸ¥è¯¢çš„æœ¬åœ°è¿›ç¨‹ç¼“å­˜\">#</a> 4.3.3.1ã€æ¡ˆä¾‹ï¼Œå®ç°å•†å“çš„æŸ¥è¯¢çš„æœ¬åœ°è¿›ç¨‹ç¼“å­˜ğŸŒ´</h4>\n<p>åˆ©ç”¨ Caffeine å®ç°ä¸‹åˆ—éœ€æ±‚ï¼š</p>\n<p>1ã€ç»™æ ¹æ® id æŸ¥è¯¢å•†å“çš„ä¸šåŠ¡æ·»åŠ ç¼“å­˜ï¼Œç¼“å­˜æœªå‘½ä¸­æ—¶æŸ¥è¯¢æ•°æ®åº“</p>\n<p>2ã€ç»™æ ¹æ® id æŸ¥è¯¢å•†å“å­˜åº“çš„ä¸šåŠ¡æ·»åŠ ç¼“å­˜ï¼Œç¼“å­˜æœªå‘½ä¸­æ—¶æŸ¥è¯¢æ•°æ®åº“</p>\n<p>3ã€ç¼“å­˜åˆå§‹å¤§å°ä¸º 100</p>\n<p>4ã€ç¼“å­˜ä¸Šé™ä¸º 10000</p>\n<p>æ­¥éª¤ï¼š</p>\n<p>1ã€ç»™æ ¹æ® id æŸ¥è¯¢å•†å“çš„ä¸šåŠ¡æ·»åŠ ç¼“å­˜ï¼Œç¼“å­˜æœªå‘½ä¸­æ—¶æŸ¥è¯¢æ•°æ®åº“</p>\n<p>2ã€ç»™æ ¹æ® id æŸ¥è¯¢å•†å“å­˜åº“çš„ä¸šåŠ¡æ·»åŠ ç¼“å­˜ï¼Œç¼“å­˜æœªå‘½ä¸­æ—¶æŸ¥è¯¢æ•°æ®åº“</p>\n<p>3ã€ç¼“å­˜åˆå§‹å¤§å°ä¸º 100</p>\n<p>4ã€ç¼“å­˜ä¸Šé™ä¸º 10000</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Configuration</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CaffeineConfig</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token annotation punctuation\">@Bean</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Cache</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Item</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">itemCache</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token class-name\">Caffeine</span><span class=\"token punctuation\">.</span><span class=\"token function\">newBuilder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                <span class=\"token punctuation\">.</span><span class=\"token function\">initialCapacity</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// è®¾ç½®ç¼“å­˜åˆå§‹åŒ–å¤§å°</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                <span class=\"token punctuation\">.</span><span class=\"token function\">maximumSize</span><span class=\"token punctuation\">(</span><span class=\"token number\">10_000</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// è®¾ç½®ç¼“å­˜æœ€å¤§ä¸Šé™å€¼</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token annotation punctuation\">@Bean</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Cache</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ItemStock</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">itemStockCache</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token class-name\">Caffeine</span><span class=\"token punctuation\">.</span><span class=\"token function\">newBuilder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                <span class=\"token punctuation\">.</span><span class=\"token function\">initialCapacity</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// è®¾ç½®ç¼“å­˜åˆå§‹åŒ–å¤§å°</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                <span class=\"token punctuation\">.</span><span class=\"token function\">maximumSize</span><span class=\"token punctuation\">(</span><span class=\"token number\">10_000</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// è®¾ç½®ç¼“å­˜æœ€å¤§ä¸Šé™å€¼</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>5ã€åœ¨ controller å±‚è¿›è¡Œä¸¤ä¸ªç¼“å­˜å¯¹è±¡çš„è‡ªåŠ¨è£…é…</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Autowired</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">private</span> <span class=\"token class-name\">Cache</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Item</span><span class=\"token punctuation\">></span></span> itemCache<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token annotation punctuation\">@Autowired</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">private</span> <span class=\"token class-name\">Cache</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ItemStock</span><span class=\"token punctuation\">></span></span> itemStockCache<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>6ã€ç¼–å†™ç¼“å­˜ä»£ç </p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/&#123;id&#125;\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">Item</span> <span class=\"token function\">findById</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@PathVariable</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"id\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   <span class=\"token comment\">// ä¼˜å…ˆæ ¹æ®ç¼“å­˜æŸ¥ï¼Œå¦‚æœæœªå‘½ä¸­åˆ™æŸ¥è¯¢æ•°æ®åº“</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   <span class=\"token keyword\">return</span> itemCache<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> key <span class=\"token operator\">-></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      <span class=\"token keyword\">return</span> itemService<span class=\"token punctuation\">.</span><span class=\"token function\">query</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>         <span class=\"token punctuation\">.</span><span class=\"token function\">ne</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"status\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">eq</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"id\"</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>         <span class=\"token punctuation\">.</span><span class=\"token function\">one</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/stock/&#123;id&#125;\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">ItemStock</span> <span class=\"token function\">findStockById</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@PathVariable</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"id\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>   <span class=\"token keyword\">return</span> itemStockCache<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> key <span class=\"token operator\">-></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token keyword\">return</span> stockService<span class=\"token punctuation\">.</span><span class=\"token function\">getById</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>   <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>è¯·æ±‚æ¥å£è¿›è¡Œæµ‹è¯•ï¼š<a href=\"http://localhost:8081/item/10001\">http://localhost:8081/item/10001</a></p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310191732546.png\" alt=\"image-20231019173236082\"></p>\n<p>ç¬¬ä¸€æ¬¡è¯·æ±‚æˆ‘ä»¬å¯ä»¥åœ¨ idea æ§åˆ¶å°ä¸­çœ‹åˆ°æ‰“å°äº†ä¸€æ®µæ‰§è¡Œ SQL çš„æ—¥å¿—ï¼Œè¯´æ˜æŸ¥äº†ä¸€ä¸‹æ•°æ®åº“</p>\n<pre><code>17:31:53:355 DEBUG 5692 --- [nio-8081-exec-1] c.h.item.mapper.ItemMapper.selectOne     : ==&gt;  Preparing: SELECT id,name,title,price,image,category,brand,spec,status,create_time,update_time FROM tb_item WHERE (status &lt;&gt; ? AND id = ?)\n17:31:53:383 DEBUG 5692 --- [nio-8081-exec-1] c.h.item.mapper.ItemMapper.selectOne     : ==&gt; Parameters: 3(Integer), 10001(Long)\n17:31:53:405 DEBUG 5692 --- [nio-8081-exec-1] c.h.item.mapper.ItemMapper.selectOne     : &lt;==      Total: 1\n</code></pre>\n<p>æ¸…ç©º idea æ§åˆ¶å°å†å¯¹è¯¥é¡µé¢è¿›è¡Œä¸€æ¬¡è®¿é—®ï¼Œå› ä¸ºç¼“å­˜ä¸€å¼€å§‹å°±æ˜¯ç©ºçš„</p>\n<p>å½“æˆ‘ä»¬æ‰§è¡Œè¿‡ä¸€æ¬¡åæ•°æ®å°±ä¼šè¢«ç¼“å­˜èµ·æ¥ï¼Œç¬¬äºŒæ¬¡æ‰§è¡Œå°±ç›´æ¥æ‹¿ç¼“å­˜çš„æ•°æ®äº†å¯ä»¥çœ‹åˆ°æ§åˆ¶å°å¾ˆå¹²å‡€æ²¡æœ‰ä¸€ç‚¹æ‰“å°ä¿¡æ¯</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310191733727.png\" alt=\"image-20231019173347678\"></p>\n<p>å½“ç„¶åº“å­˜ä¹Ÿæ˜¯ä¸€æ ·çš„é“ç†</p>\n<p>è®¿é—® uriï¼š<a href=\"http://localhost:8081/item/stock/10001\">http://localhost:8081/item/stock/10001</a></p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310191735447.png\" alt=\"image-20231019173509976\"></p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310191734949.png\" alt=\"image-20231019173456734\"></p>\n<p>æ¸…ç©ºæ§åˆ¶å°ä¿¡æ¯è¿›è¡Œç¬¬äºŒæ¬¡è®¿é—®ï¼Œæ­¤æ—¶æ•°æ®å·²ç»è¢«ç¼“å­˜èµ·æ¥äº†ã€‚</p>\n<p>äºŒæ¬¡ä¾æ—§å¾ˆå¹²å‡€</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310191735198.png\" alt=\"image-20231019173553835\"></p>\n<h1 id=\"äº”-luaè¯­è¨€å…¥é—¨\"><a class=\"markdownIt-Anchor\" href=\"#äº”-luaè¯­è¨€å…¥é—¨\">#</a> äº”ã€Lua è¯­è¨€å…¥é—¨ğŸ„</h1>\n<p>å› ä¸º Nginx å¼€å‘éœ€è¦ä½¿ç”¨ Lua è¯­è¨€æ¥è¿›è¡Œç¼–ç¨‹ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±éœ€è¦å­¦ä¹  Lua è¯­è¨€</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310191745432.png\" alt=\"image-20231019174517515\"></p>\n<p>å­¦ä¹ å†…å®¹ï¼š</p>\n<ul>\n<li>åˆå§‹ Lua</li>\n<li>å˜é‡å’Œå¾ªç¯</li>\n<li>æ¡ä»¶æ§åˆ¶ï¼Œå‡½æ•°</li>\n</ul>\n<h2 id=\"51-åˆå§‹lua\"><a class=\"markdownIt-Anchor\" href=\"#51-åˆå§‹lua\">#</a> 5.1ã€åˆå§‹ LuağŸŒ³</h2>\n<p>Lua æ˜¯ä¸€ç§è½»é‡çº§å°å·§çš„è„šæœ¬è¯­è¨€ï¼Œç”¨æ ‡å‡† C è¯­è¨€ç¼–å†™å¹¶ä»¥æºä»£ç å½¢å¼å¼€æ”¾ï¼Œå…¶è®¾è®¡ç›®çš„æ˜¯ä¸ºäº†åµŒå…¥åº”ç”¨ç¨‹åºä¸­ï¼Œä»è€Œä¸ºåº”ç”¨ç¨‹åºæä¾›çµæ´»çš„æ‰©å±•å’Œå®šåˆ¶åŠŸèƒ½ã€‚å®˜ç½‘ï¼š<a href=\"http://www.lua.org/\">http://www.lua.org/</a></p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310191751131.png\" alt=\"image-20231019175148607\"></p>\n<h3 id=\"511-helloworld\"><a class=\"markdownIt-Anchor\" href=\"#511-helloworld\">#</a> 5.1.1ã€HelloWorldğŸŒ²</h3>\n<p>1ã€åœ¨ Linux è™šæ‹Ÿæœºçš„ä»»æ„ç›®å½•ä¸‹ï¼Œæ–°å»ºä¸€ä¸ª hello.lua æ–‡ä»¶</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim hello.lua</span></pre></td></tr></table></figure><p>2ã€æ·»åŠ ä¸‹é¢çš„å†…å®¹</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>print<span class=\"token punctuation\">(</span><span class=\"token string\">\"Hello World!\"</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>3ã€è¿è¡Œ</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># lua hello.lua</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Hello World<span class=\"token operator\">!</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\">#</span></pre></td></tr></table></figure><h3 id=\"512-æ•°æ®ç±»å‹\"><a class=\"markdownIt-Anchor\" href=\"#512-æ•°æ®ç±»å‹\">#</a> 5.1.2ã€æ•°æ®ç±»å‹ğŸŒ²</h3>\n<table>\n<thead>\n<tr>\n<th>æ•°æ®ç±»å‹</th>\n<th>æè¿°</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>nil</td>\n<td>è¿™ä¸ªæœ€ç®€å•ï¼Œåªæœ‰å€¼ nil å±äºè¯¥ç±»ï¼Œè¡¨ç¤ºä¸€ä¸ªæ— æ•ˆå€¼ (åœ¨æ¡ä»¶è¡¨è¾¾å¼ä¸­ç›¸å½“äº false)</td>\n</tr>\n<tr>\n<td>boolean</td>\n<td>åŒ…å«ä¸¤ä¸ªå€¼ï¼šfalse å’Œ true</td>\n</tr>\n<tr>\n<td>number</td>\n<td>è¡¨ç¤ºåŒç²¾åº¦ç±»å‹çš„å®æµ®ç‚¹æ•°</td>\n</tr>\n<tr>\n<td>string</td>\n<td>å­—ç¬¦ä¸²ç”±ä¸€å¯¹åŒå¼•å·æˆ–å•å¼•å·æ¥è¡¨ç¤º</td>\n</tr>\n<tr>\n<td>function</td>\n<td>ç”± C æˆ– Lua ç¼–å†™çš„å‡½æ•°</td>\n</tr>\n<tr>\n<td>table</td>\n<td>Lua ä¸­çš„è¡¨ (table) å…¶å®æ˜¯ä¸€ä¸ª â€œå…³è”æ•°ç»„â€ (associative arrays)ï¼Œæ•°ç»„çš„ç´¢å¼•å¯ä»¥æ˜¯æ•°å­—ï¼Œå­—ç¬¦ä¸²æˆ–è¡¨ç±»å‹ã€‚åœ¨ Lua é‡Œï¼Œtable çš„åˆ›å»ºæ˜¯é€šè¿‡ â€œæ„é€ è¡¨è¾¾å¼â€ æ¥å®Œæˆï¼Œæœ€ç®€å•æ„é€ è¡¨è¾¾å¼æ˜¯ { }ï¼Œç”¨æ¥åˆ›å»ºä¸€ä¸ªç©ºè¡¨ã€‚</td>\n</tr>\n</tbody>\n</table>\n<p>å¯ä»¥åˆ©ç”¨ type å‡½æ•°æµ‹è¯•ç»™å®šå˜é‡æˆ–è€…å€¼çš„ç±»å‹</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim hello.lua</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># lua hello.lua</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>string</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat hello.lua</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>print<span class=\"token punctuation\">(</span>type<span class=\"token punctuation\">(</span><span class=\"token string\">\"Hello World!\"</span><span class=\"token punctuation\">))</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\">#</span></pre></td></tr></table></figure><figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim hello.lua</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># lua hello.lua</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>number</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat hello.lua</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>print<span class=\"token punctuation\">(</span>type<span class=\"token punctuation\">(</span><span class=\"token number\">10.4</span> * <span class=\"token number\">3</span><span class=\"token punctuation\">))</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\">#</span></pre></td></tr></table></figure><h3 id=\"513-å˜é‡\"><a class=\"markdownIt-Anchor\" href=\"#513-å˜é‡\">#</a> 5.1.3ã€å˜é‡ğŸŒ²</h3>\n<p>Lua å£°æ˜å˜é‡çš„æ—¶å€™ï¼Œå¹¶ä¸éœ€è¦æŒ‡å®šæ•°æ®ç±»å‹ï¼š</p>\n<figure class=\"highlight lua\"><figcaption data-lang=\"lua\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- å£°æ˜å­—ç¬¦ä¸²</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">local</span> str <span class=\"token operator\">=</span> <span class=\"token string\">'hello'</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">-- å£°æ˜æ•°å­—</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">local</span> num <span class=\"token operator\">=</span> <span class=\"token number\">21</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">-- å£°æ˜å¸ƒå°”ç±»å‹</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">local</span> flag <span class=\"token operator\">=</span> <span class=\"token keyword\">true</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">-- å£°æ˜æ•°ç»„ key ä¸ºç´¢å¼•çš„ table </span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">local</span> arr <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token string\">'java'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'python'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'lua'</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">-- å£°æ˜ table ï¼Œç±»ä¼¼ java çš„ map</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">local</span> map <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span>name <span class=\"token operator\">=</span> <span class=\"token string\">'Jack'</span><span class=\"token punctuation\">,</span> age <span class=\"token operator\">=</span> <span class=\"token number\">21</span><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>è®¿é—® tableï¼š</p>\n<figure class=\"highlight lua\"><figcaption data-lang=\"lua\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- è®¿é—®æ•°ç»„ï¼Œlua æ•°ç»„çš„è§’æ ‡ä» 1 å¼€å§‹</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">print</span><span class=\"token punctuation\">(</span>arr<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">-- è®¿é—® table</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">print</span><span class=\"token punctuation\">(</span>map<span class=\"token punctuation\">[</span><span class=\"token string\">'name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">print</span><span class=\"token punctuation\">(</span>map<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>å­—ç¬¦ä¸²æ‹¼æ¥ä½¿ç”¨  <code>..</code></p>\n<h3 id=\"514-å¾ªç¯\"><a class=\"markdownIt-Anchor\" href=\"#514-å¾ªç¯\">#</a> 5.1.4ã€å¾ªç¯ğŸŒ²</h3>\n<p>æ•°ç»„ï¼Œtable éƒ½å¯ä»¥åˆ©ç”¨ for å¾ªç¯æ¥éå†</p>\n<ul>\n<li>éå†æ•°ç»„ï¼š</li>\n</ul>\n<figure class=\"highlight lua\"><figcaption data-lang=\"lua\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- å£°æ˜æ•°ç»„ key ä¸ºç´¢å¼•çš„ table</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">local</span> arr <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token string\">'java'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'python'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'lua'</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">-- éå†æ•°ç»„</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">for</span> index<span class=\"token punctuation\">,</span> value <span class=\"token keyword\">in</span> <span class=\"token function\">ipairs</span><span class=\"token punctuation\">(</span>arr<span class=\"token punctuation\">)</span> <span class=\"token keyword\">do</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   <span class=\"token function\">print</span><span class=\"token punctuation\">(</span>index<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">end</span></pre></td></tr></table></figure><ul>\n<li>éå† table</li>\n</ul>\n<figure class=\"highlight lua\"><figcaption data-lang=\"lua\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- å£°æ˜ mapï¼Œä¹Ÿå°±æ˜¯ table</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">local</span> map <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span>name <span class=\"token operator\">=</span> <span class=\"token string\">'Jack'</span><span class=\"token punctuation\">,</span> age <span class=\"token operator\">=</span> <span class=\"token number\">21</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">-- éå† table</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">for</span> key<span class=\"token punctuation\">,</span>value <span class=\"token keyword\">in</span> <span class=\"token function\">pairs</span><span class=\"token punctuation\">(</span>map<span class=\"token punctuation\">)</span> <span class=\"token keyword\">do</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   <span class=\"token function\">print</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">end</span></pre></td></tr></table></figure><h3 id=\"515-å‡½æ•°\"><a class=\"markdownIt-Anchor\" href=\"#515-å‡½æ•°\">#</a> 5.1.5ã€å‡½æ•°ğŸŒ²</h3>\n<p>å®šä¹‰å‡½æ•°çš„è¯­æ³•ï¼š</p>\n<figure class=\"highlight lua\"><figcaption data-lang=\"lua\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">function</span> å‡½æ•°å<span class=\"token punctuation\">(</span> argument1<span class=\"token punctuation\">,</span> argument2<span class=\"token punctuation\">,</span> argument3 <span class=\"token punctuation\">...</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   <span class=\"token comment\">-- å‡½æ•°ä½“</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   <span class=\"token keyword\">return</span> è¿”å›å€¼</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">end</span></pre></td></tr></table></figure><p>ä¾‹å¦‚ï¼Œå®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œç”¨æ¥æ‰“å°æ•°ç»„ï¼š</p>\n<figure class=\"highlight lua\"><figcaption data-lang=\"lua\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">printArr</span><span class=\"token punctuation\">(</span>arr<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   <span class=\"token keyword\">for</span> index<span class=\"token punctuation\">,</span> value <span class=\"token keyword\">in</span> <span class=\"token function\">ipairs</span><span class=\"token punctuation\">(</span>arr<span class=\"token punctuation\">)</span> <span class=\"token keyword\">do</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>      <span class=\"token function\">print</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   <span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">end</span></pre></td></tr></table></figure><h3 id=\"516-æ¡ä»¶æ§åˆ¶\"><a class=\"markdownIt-Anchor\" href=\"#516-æ¡ä»¶æ§åˆ¶\">#</a> 5.1.6ã€æ¡ä»¶æ§åˆ¶ğŸŒ²</h3>\n<p>ç±»ä¼¼ Java çš„æ¡ä»¶æ§åˆ¶ï¼Œä¾‹å¦‚ if , else è¯­æ³•ï¼š</p>\n<figure class=\"highlight lua\"><figcaption data-lang=\"lua\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>å¸ƒå°”è¡¨è¾¾å¼<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   <span class=\"token comment\">-- [å¸ƒå°”è¡¨è¾¾å¼ä¸º true æ—¶æ‰§è¡Œè¯¥è¯­å¥å— --]</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   <span class=\"token comment\">-- [å¸ƒå°”è¡¨è¾¾å¼ä¸º false æ—¶æ‰§è¡Œè¯¥è¯­å¥å— --]</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">end</span></pre></td></tr></table></figure><p>ä¸ java ä¸åŒï¼Œå¸ƒå°”è¡¨è¾¾å¼ä¸­çš„é€»è¾‘è¿ç®—æ˜¯åŸºäºè‹±æ–‡å•è¯ï¼š</p>\n<table>\n<thead>\n<tr>\n<th>æ“ä½œç¬¦</th>\n<th>æè¿°</th>\n<th>å®ä¾‹</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>and</td>\n<td>é€»è¾‘ä¸æ“ä½œç¬¦ã€‚è‹¥ A ä¸º falseï¼Œåˆ™è¿”å› Aï¼Œå¦åˆ™è¿”å› B</td>\n<td>(A and B) ä¸º false</td>\n</tr>\n<tr>\n<td>or</td>\n<td>é€»è¾‘æˆ–æ“ä½œç¬¦ã€‚è‹¥ A ä¸º trueï¼Œåˆ™è¿”å› Aï¼Œå¦åˆ™è¿”å› B</td>\n<td>(A or B) ä¸º true</td>\n</tr>\n<tr>\n<td>not</td>\n<td>é€»è¾‘éæ“ä½œç¬¦ã€‚ä¸é€»è¾‘è¿ç®—ç»“æœç›¸åï¼Œå¦‚æœæ¡ä»¶ä¸º trueï¼Œé€»è¾‘éä¸º false</td>\n<td>not (A and B) ä¸º true</td>\n</tr>\n</tbody>\n</table>\n<h1 id=\"å…­-å¤šçº§ç¼“å­˜\"><a class=\"markdownIt-Anchor\" href=\"#å…­-å¤šçº§ç¼“å­˜\">#</a> å…­ã€å¤šçº§ç¼“å­˜ğŸ„</h1>\n<ul>\n<li>å®‰è£… OpenResty</li>\n<li>OpenResty å¿«é€Ÿå…¥é—¨</li>\n<li>è¯·æ±‚å‚æ•°å¤„ç†</li>\n<li>æŸ¥è¯¢ Tomcat</li>\n<li>Redis ç¼“å­˜é¢„çƒ­</li>\n<li>æŸ¥è¯¢ Redis ç¼“å­˜</li>\n<li>Nginx æœ¬åœ°ç¼“å­˜</li>\n</ul>\n<h2 id=\"61-åˆå§‹openresty\"><a class=\"markdownIt-Anchor\" href=\"#61-åˆå§‹openresty\">#</a> 6.1ã€åˆå§‹ OpenRestyğŸŒ³</h2>\n<p>OpenResty æ˜¯ä¸€ä¸ªåŸºäº Nginx çš„é«˜æ€§èƒ½ Web å¹³å°ï¼Œç”¨äºæ–¹ä¾¿åœ°æ­å»ºèƒ½å¤Ÿå¤„ç†é«˜å¹¶å‘ï¼Œæ‰©å±•æ€§æé«˜çš„åŠ¨æ€ Web åº”ç”¨ï¼ŒWeb æœåŠ¡å’ŒåŠ¨æ€ç½‘å…³ã€‚å…·å¤‡ä¸‹åˆ—ç‰¹ç‚¹ï¼š</p>\n<ul>\n<li>å…·å¤‡ Nginx çš„å®Œæ•´åŠŸèƒ½</li>\n<li>åŸºäº Lua è¯­è¨€è¿›è¡Œæ‰©å±•ï¼Œé›†æˆäº†å¤§é‡ç²¾è‰¯çš„ Lua åº“ï¼Œç¬¬ä¸‰æ–¹æ¨¡å—</li>\n<li>å…è®¸ä½¿ç”¨ Lua è‡ªå®šä¹‰ä¸šåŠ¡é€»è¾‘ï¼Œè‡ªå®šä¹‰åº“</li>\n</ul>\n<p>å®˜æ–¹ç½‘ç«™ï¼š<a href=\"https://openresty.org/cn/\">https://openresty.org/cn/</a></p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310200852606.png\" alt=\"image-20231020085036341\"></p>\n<h3 id=\"611-openrestyå®‰è£…\"><a class=\"markdownIt-Anchor\" href=\"#611-openrestyå®‰è£…\">#</a> 6.1.1ã€OpenResty å®‰è£…ğŸŒ²</h3>\n<p>æŸ¥çœ‹æ–‡ç« ï¼š<a href=\"./OpenResty%E5%AE%89%E8%A3%85/%E5%AE%89%E8%A3%85OpenResty.md\">å®‰è£… OpenResty</a>.</p>\n<h3 id=\"612-æ¡ˆä¾‹openrestyå¿«é€Ÿå…¥é—¨å®ç°å•†å“è¯¦æƒ…é¡µæ•°æ®æŸ¥è¯¢\"><a class=\"markdownIt-Anchor\" href=\"#612-æ¡ˆä¾‹openrestyå¿«é€Ÿå…¥é—¨å®ç°å•†å“è¯¦æƒ…é¡µæ•°æ®æŸ¥è¯¢\">#</a> 6.1.2ã€æ¡ˆä¾‹ï¼ŒOpenResty å¿«é€Ÿå…¥é—¨ï¼Œå®ç°å•†å“è¯¦æƒ…é¡µæ•°æ®æŸ¥è¯¢ğŸŒ²</h3>\n<p>å•†å“è¯¦æƒ…é¡µç›®å‰å±•ç¤ºçš„æ˜¯å‡æ•°æ®ï¼Œåœ¨æµè§ˆå™¨çš„æ§åˆ¶å°å¯ä»¥çœ‹åˆ°æŸ¥è¯¢å•†å“ä¿¡æ¯çš„è¯·æ±‚ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310200915073.png\" alt=\"image-20231020091453815\"></p>\n<p>è€Œè¿™ä¸ªè¯·æ±‚æœ€ç»ˆè¢«åå‘ä»£ç†åˆ°è™šæ‹Ÿæœºçš„ OpenResty é›†ç¾¤ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310200915958.png\" alt=\"image-20231020091503555\"></p>\n<p>éœ€æ±‚ï¼šåœ¨ OpenResty ä¸­æ¥æ”¶è¿™ä¸ªè¯·æ±‚ï¼Œå¹¶è¿”å›ä¸€æ®µå•†å“çš„å‡æ•°æ®ã€‚</p>\n<p>æ­¥éª¤ï¼šä¸€ã€‚</p>\n<p>1ã€åœ¨ nginx.conf çš„ http ä¸‹é¢ï¼Œæ·»åŠ å¯¹ OpenResty çš„ Lua æ¨¡å—çš„åŠ è½½</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># lua æ¨¡å—</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>lua_package_path <span class=\"token string\">\"/usr/local/openresty/lualib/?.lua;;\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># c æ¨¡å—     </span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>lua_package_cpath <span class=\"token string\">\"/usr/local/openresty/lualib/?.so;;\"</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>2ã€åœ¨ nginx.conf çš„ server ä¸‹é¢ï¼Œæ·»åŠ å¯¹ /api/item è¿™ä¸ªè·¯å¾„çš„ç›‘å¬</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># è¿™é‡Œå¯ä»¥ç†è§£ä¸ºå°±æ˜¯ SpringMVC ä¸­çš„ Controller</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>location /api/item <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># é»˜è®¤çš„å“åº”ç±»å‹</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>default_type application/json<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># è¿™é‡Œå¯ä»¥ç†è§£ä¸ºå°±æ˜¯ Service ä¸šåŠ¡é€»è¾‘å±‚</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># å“åº”ç»“æœç”± lua/item.lua ä¸‹çš„æ–‡ä»¶å†³å®š</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>content_by_lua_file lua/item.lua<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>æ­¥éª¤ï¼šäºŒã€‚</p>\n<p>1ã€åœ¨ nginx ç›®å½•åˆ›å»ºæ–‡ä»¶å¤¹ï¼šlua</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@localhost nginx<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir lua</span></pre></td></tr></table></figure><p>2ã€åœ¨ lua æ–‡ä»¶å¤¹ä¸‹ï¼Œæ–°å»ºæ–‡ä»¶ï¼šitem.lua</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@localhost nginx<span class=\"token punctuation\">]</span><span class=\"token comment\"># touch lua/item.lua</span></pre></td></tr></table></figure><p>3ã€å†…å®¹å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight lua\"><figcaption data-lang=\"lua\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">--  è¿”å›å‡æ•°æ®ï¼Œè¿™é‡Œçš„ ngx.say () å‡½æ•°ï¼Œå°±æ˜¯å†™æ•°æ®åˆ° Response ä¸­</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>ngx<span class=\"token punctuation\">.</span><span class=\"token function\">say</span><span class=\"token punctuation\">(</span><span class=\"token string\">'&#123;\"id\":10001, \"name\":\"SALSA AIR\"&#125;'</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>è¿™é‡Œé¢çš„å‡æ•°æ®å» uriï¼š<a href=\"http://localhost/item.html?id=10001%E4%B8%AD%E6%89%93%E5%BC%80%E6%8E%A7%E5%88%B6%E5%8F%B0%E9%80%89%E6%8B%A9vue%E7%84%B6%E5%90%8E%E8%B5%8B%E5%80%BCItem%E4%B9%9F%E5%B0%B1%E6%98%AFObject%E5%AF%B9%E8%B1%A1%EF%BC%8C%E5%B0%86%E9%87%8C%E9%9D%A2%E7%9A%84%E6%95%B0%E6%8D%AE%E4%BD%9C%E4%B8%BA%E5%81%87%E6%95%B0%E6%8D%AE%E4%BD%BF%E7%94%A8\">http://localhost/item.html?id=10001 ä¸­æ‰“å¼€æ§åˆ¶å°é€‰æ‹© vue ç„¶åèµ‹å€¼ Item ä¹Ÿå°±æ˜¯ Object å¯¹è±¡ï¼Œå°†é‡Œé¢çš„æ•°æ®ä½œä¸ºå‡æ•°æ®ä½¿ç”¨</a></p>\n<p>è¿™ä¸ªé¡µé¢æ˜¯ä» nginx ä»£ç†é‡Œé¢è®¿é—®è¿‡æ¥çš„</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310200940251.png\" alt=\"image-20231020094054757\"></p>\n<p>å°†å‡æ•°æ®æ‹·è´åˆ° ngx.say (â€˜â€™) é‡Œé¢</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310200942719.png\" alt=\"image-20231020094215395\"></p>\n<p>ä¸ºäº†èƒ½åŒºåˆ†ä¸€ä¸‹æ˜¯å¦æˆåŠŸï¼Œæˆ‘ä»¬å°†é‡Œé¢çš„ä¸€äº›æ•°æ®è¿›è¡Œä¸€ä¸‹ä¿®æ”¹</p>\n<p>æ­¤å¤„åªæ˜¯ä¿®æ”¹äº†å°ºå¯¸å’Œä»·æ ¼</p>\n<figure class=\"highlight lua\"><figcaption data-lang=\"lua\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>ngx<span class=\"token punctuation\">.</span><span class=\"token function\">say</span><span class=\"token punctuation\">(</span><span class=\"token string\">'&#123;\"id\":10001,\"name\":\"SALSA AIR\",\"title\":\"RIMOWA 31å¯¸æ‰˜è¿ç®±æ‹‰æ†ç®± SALSA AIRç³»åˆ—æœç»¿è‰² 820.70.36.4\",\"price\":27900,\"image\":\"https://m.360buyimg.com/mobilecms/s720x720_jfs/t6934/364/1195375010/84676/e9f2c55f/597ece38N0ddcbc77.jpg!q70.jpg.webp\",\"category\":\"æ‹‰æ†ç®±\",\"brand\":\"RIMOWA\",\"spec\":\"\",\"status\":1,\"createTime\":\"2019-04-30T16:00:00.000+00:00\",\"updateTime\":\"2019-04-30T16:00:00.000+00:00\",\"stock\":2999,\"sold\":31290&#125;'</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>å®Œæ•´çš„ nginx.conf é…ç½®å†…å®¹ï¼š</p>\n<figure class=\"highlight nginx\"><figcaption data-lang=\"nginx\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#user  nobody;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token directive\"><span class=\"token keyword\">worker_processes</span>  <span class=\"token number\">1</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token directive\"><span class=\"token keyword\">error_log</span>  logs/error.log</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token directive\"><span class=\"token keyword\">events</span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token directive\"><span class=\"token keyword\">worker_connections</span>  <span class=\"token number\">1024</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token directive\"><span class=\"token keyword\">http</span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token directive\"><span class=\"token keyword\">include</span>       mime.types</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token directive\"><span class=\"token keyword\">default_type</span>  application/octet-stream</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token directive\"><span class=\"token keyword\">sendfile</span>        <span class=\"token boolean\">on</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token directive\"><span class=\"token keyword\">keepalive_timeout</span>  <span class=\"token number\">65</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token comment\"># lua æ¨¡å—</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token directive\"><span class=\"token keyword\">lua_package_path</span> <span class=\"token string\">\"/usr/local/openresty/lualib/?.lua;;\"</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token comment\"># c æ¨¡å—     </span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token directive\"><span class=\"token keyword\">lua_package_cpath</span> <span class=\"token string\">\"/usr/local/openresty/lualib/?.so;;\"</span></span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token directive\"><span class=\"token keyword\">server</span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token directive\"><span class=\"token keyword\">listen</span>       <span class=\"token number\">8081</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token directive\"><span class=\"token keyword\">server_name</span>  localhost</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token directive\"><span class=\"token keyword\">location</span> /api/item</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>          <span class=\"token comment\"># é»˜è®¤çš„å“åº”ç±»å‹</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>          <span class=\"token directive\"><span class=\"token keyword\">default_type</span> application/json</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>          <span class=\"token comment\"># å“åº”ç»“æœç”± lua/item.lua ä¸‹çš„æ–‡ä»¶å†³å®š</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>          <span class=\"token directive\"><span class=\"token keyword\">content_by_lua_file</span> lua/item.lua</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token directive\"><span class=\"token keyword\">location</span> /</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            <span class=\"token directive\"><span class=\"token keyword\">root</span>   html</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            <span class=\"token directive\"><span class=\"token keyword\">index</span>  index.html index.htm</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token directive\"><span class=\"token keyword\">error_page</span>   <span class=\"token number\">500</span> <span class=\"token number\">502</span> <span class=\"token number\">503</span> <span class=\"token number\">504</span>  /50x.html</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token directive\"><span class=\"token keyword\">location</span> = /50x.html</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            <span class=\"token directive\"><span class=\"token keyword\">root</span>   html</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>4ã€é‡æ–°åŠ è½½é…ç½®</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>nginx <span class=\"token parameter variable\">-s</span> reload</pre></td></tr></table></figure><p>æŸ¥çœ‹å•†å“é¡µé¢ï¼Œæ²¡æœ‰åˆ·æ–°å‰</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310200946010.png\" alt=\"image-20231020094617482\"></p>\n<p>åˆ·æ–°å</p>\n<p>å¯ä»¥çœ‹åˆ°å°ºå¯¸å’Œä»·æ ¼è¢«ä¿®æ”¹äº†ä½†æ˜¯ä¸­æ–‡ä¹Ÿä¹±ç äº†ã€‚ã€‚ã€‚</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310200951850.png\" alt=\"image-20231020095132419\"></p>\n<h2 id=\"62-openrestyè·å–è¯·æ±‚å‚æ•°\"><a class=\"markdownIt-Anchor\" href=\"#62-openrestyè·å–è¯·æ±‚å‚æ•°\">#</a> 6.2ã€OpenResty è·å–è¯·æ±‚å‚æ•°ğŸŒ³</h2>\n<p>OpenResty æä¾›äº†å„ç§ API ç”¨æ¥è·å–ä¸åŒç±»å‹çš„è¯·æ±‚å‚æ•°ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310200958589.png\" alt=\"image-20231020095810221\"></p>\n<h3 id=\"621-æ¡ˆä¾‹è·å–è¯·æ±‚è·¯å¾„ä¸­çš„å•†å“idä¿¡æ¯æ‹¼æ¥åˆ°jsonç»“æœä¸­è¿”å›\"><a class=\"markdownIt-Anchor\" href=\"#621-æ¡ˆä¾‹è·å–è¯·æ±‚è·¯å¾„ä¸­çš„å•†å“idä¿¡æ¯æ‹¼æ¥åˆ°jsonç»“æœä¸­è¿”å›\">#</a> 6.2.1ã€æ¡ˆä¾‹ï¼Œè·å–è¯·æ±‚è·¯å¾„ä¸­çš„å•†å“ id ä¿¡æ¯ï¼Œæ‹¼æ¥åˆ° json ç»“æœä¸­è¿”å›ğŸŒ²</h3>\n<p>åœ¨æŸ¥è¯¢å•†å“ä¿¡æ¯çš„è¯·æ±‚ä¸­ï¼Œé€šè¿‡è·¯å¾„å ä½ç¬¦çš„æ–¹å¼ï¼Œä¼ é€’äº†å•†å“ id åˆ°åå°ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310201002974.png\" alt=\"image-20231020100241654\"></p>\n<p>éœ€æ±‚ï¼šåœ¨ OpenResty ä¸­æ¥æ”¶è¿™ä¸ªè¯·æ±‚ï¼Œå¹¶è·å–è·¯å¾„ä¸­çš„ id ä¿¡æ¯ï¼Œæ‹¼æ¥åˆ°ç»“æœçš„ json å­—ç¬¦ä¸²ä¸­è¿”å›</p>\n<p>OpenResty ä¸­æ¥å—è¯·æ±‚</p>\n<figure class=\"highlight nginx\"><figcaption data-lang=\"nginx\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token directive\"><span class=\"token keyword\">location</span> ~ /api/item(\\d+)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   <span class=\"token comment\"># é»˜è®¤çš„å“åº”ç±»å‹</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   <span class=\"token directive\"><span class=\"token keyword\">default_type</span> application/json</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   <span class=\"token comment\"># å“åº”ç»“æœç”± lua/item.lua ä¸‹çš„æ–‡ä»¶å†³å®š</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   <span class=\"token directive\"><span class=\"token keyword\">content_by_lua_file</span> lua/item.lua</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>å¹¶è·å–è·¯å¾„ä¸­çš„ id ä¿¡æ¯ï¼Œæ‹¼æ¥åˆ°ç»“æœçš„ json å­—ç¬¦ä¸²ä¸­è¿”å›</p>\n<figure class=\"highlight lua\"><figcaption data-lang=\"lua\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- è·å–è·¯å¾„å‚æ•°</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">local</span> id <span class=\"token operator\">=</span> ngx<span class=\"token punctuation\">.</span>var<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">-- è¿”å›ç»“æœ</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>ngx<span class=\"token punctuation\">.</span><span class=\"token function\">say</span><span class=\"token punctuation\">(</span><span class=\"token string\">'&#123;\"id\":'</span> <span class=\"token operator\">..</span> id <span class=\"token operator\">..</span> <span class=\"token string\">',\"name\":\"SALSA AIR\",\"title\":\"RIMOWA 31å¯¸æ‰˜è¿ç®±æ‹‰æ†ç®± SALSA AIRç³»åˆ—æœç»¿è‰² 820.70.36.4\",\"price\":27900,\"image\":\"https://m.360buyimg.com/mobilecms/s720x720_jfs/t6934/364/1195375010/84676/e9f2c55f/597ece38N0ddcbc77.jpg!q70.jpg.webp\",\"category\":\"æ‹‰æ†ç®±\",\"brand\":\"RIMOWA\",\"spec\":\"\",\"status\":1,\"createTime\":\"2019-04-30T16:00:00.000+00:00\",\"updateTime\":\"2019-04-30T16:00:00.000+00:00\",\"stock\":2999,\"sold\":31290&#125;'</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>é‡å¯ Linux ä¸­çš„ nginx æœåŠ¡å™¨</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>nginx <span class=\"token parameter variable\">-s</span> reload</pre></td></tr></table></figure><p>è®¿é—®é¡µé¢è¿›è¡Œæµ‹è¯•ï¼š</p>\n<p><a href=\"http://localhost/item.html?id=10001\">http://localhost/item.html?id=10001</a></p>\n<p>è¯·æ±‚ç»“æœ</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310201022922.png\" alt=\"image-20231020102241989\"></p>\n<p><a href=\"http://localhost/item.html?id=10002\">http://localhost/item.html?id=10002</a></p>\n<p>è¯·æ±‚ç»“æœ</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310201023953.png\" alt=\"image-20231020102259850\"></p>\n<p>å¯ä»¥çœ‹åˆ° id å°±ä¸å†æ˜¯å†™æ­»çš„äº†ï¼Œè€Œæ˜¯å¯ä»¥äº‹å®å˜åŒ–çš„</p>\n<h2 id=\"63-æŸ¥è¯¢tomcat\"><a class=\"markdownIt-Anchor\" href=\"#63-æŸ¥è¯¢tomcat\">#</a> 6.3ã€æŸ¥è¯¢ TomcatğŸŒ³</h2>\n<p>å…ˆçœ‹ä¸‹å¤šçº§ç¼“å­˜çš„æ¶æ„ã€‚ç›®å‰å·²ç»å‡†å¤‡å¥½äº† nginx åå‘ä»£ç†æœåŠ¡å™¨ï¼Œå®ƒå»æ¥å—å‰ç«¯çš„è¯·æ±‚å¹¶ä¸”è½¬åˆ° OpenRestyï¼ŒæœåŠ¡ç«¯ä¹Ÿç¼–å†™å¥½äº†è¿›ç¨‹ç¼“å­˜ OpenResty ä¹Ÿæ­å¥½äº†ï¼Œä½†æ˜¯ OpenResty æ¥æ”¶åˆ°è¯·æ±‚åè¦æŸ¥è¯¢æ•°æ®ã€‚æˆ‘ä»¬å…ˆå®ç°ä» Tomcat å»æŸ¥ç„¶åå†å­˜å‚¨åˆ°ç¼“å­˜ä¸­ã€‚</p>\n<p>éœ€è¦æ³¨å†Œ OPenResty åœ¨è™šæ‹Ÿæœºä¸Šï¼Œè€Œ Tomcat åœ¨æœ¬æœºä¸Šï¼Œip åœ°å€ä¸åŒ</p>\n<p>ä¸¤ä¸ª ip åœ°å€è®¿é—®çš„ä¾¿æ·æ–¹å¼ï¼šä¸ç®¡è™šæ‹Ÿæœºçš„ ip åœ°å€æ˜¯ä»€ä¹ˆåªè¦å®˜å‰ä¸‰ä½å°±è¡Œäº†ï¼Œç„¶åæŠŠæœ€åä¸€ä½æ›¿æ¢æˆ 1 ä¸€å®šå¾—åˆ°çš„å°±æ˜¯ windows ç”µè„‘çš„ä½ç½®ã€‚å‰ææ˜¯éœ€è¦å…³é—­é˜²ç«å¢™</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310201030614.png\" alt=\"image-20231020103028998\"></p>\n<h3 id=\"631-æ¡ˆä¾‹è·å–è¯·æ±‚è·¯å¾„ä¸­çš„å•†å“idä¿¡æ¯æ ¹æ®idå‘tomcatæŸ¥è¯¢å•†å“ä¿¡æ¯\"><a class=\"markdownIt-Anchor\" href=\"#631-æ¡ˆä¾‹è·å–è¯·æ±‚è·¯å¾„ä¸­çš„å•†å“idä¿¡æ¯æ ¹æ®idå‘tomcatæŸ¥è¯¢å•†å“ä¿¡æ¯\">#</a> 6.3.1ã€æ¡ˆä¾‹ï¼Œè·å–è¯·æ±‚è·¯å¾„ä¸­çš„å•†å“ id ä¿¡æ¯ï¼Œæ ¹æ® id å‘ Tomcat æŸ¥è¯¢å•†å“ä¿¡æ¯ğŸŒ²</h3>\n<p>è¿™é‡Œè¦ä¿®æ”¹ item.luaï¼Œæ»¡è¶³ä¸‹é¢çš„éœ€æ±‚ï¼š</p>\n<p>1ã€è·å–è¯·æ±‚å‚æ•°ä¸­çš„ id</p>\n<p>2ã€æ ¹æ® id å‘ Tomcat æœåŠ¡å‘é€è¯·æ±‚ï¼ŒæŸ¥è¯¢å•†å“ä¿¡æ¯</p>\n<p>3ã€æ ¹æ® id å‘ Tomcat æœåŠ¡å‘é€è¯·æ±‚ï¼ŒæŸ¥è¯¢åº“å­˜ä¿¡æ¯</p>\n<p>4ã€ç»„è£…å•†å“ä¿¡æ¯ï¼Œåº“å­˜ä¿¡æ¯ï¼Œåºåˆ—åŒ–ä¸º Json æ ¼å¼å¹¶è¿”å›</p>\n<p>æ­¥éª¤ï¼š</p>\n<p>ä¸€ï¼Œnginx å†…éƒ¨å‘é€ Http è¯·æ±‚</p>\n<p>nginx æä¾›äº†å†…éƒ¨ API ç”¨ä»¥å‘é€ http è¯·æ±‚ï¼š</p>\n<figure class=\"highlight nginx\"><figcaption data-lang=\"nginx\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># æ³¨æ„ï¼šè¿™é‡Œçš„ path æ˜¯è·¯å¾„ï¼Œå¹¶ä¸åŒ…å« ip å’Œç«¯å£ã€‚è¿™ä¸ªè¯·æ±‚ä¼šè¢« nginx å†…éƒ¨çš„ server ç›‘å¬å¹¶å¤„ç†</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># è¿™è‚¯å®šä¸è¡Œï¼Œå› ä¸ºæˆ‘ä»¬å¸Œæœ›å¯ä»¥å‘é€ç»™ Tomcat æ‰€ä»¥å°±è¦æŒ‡å®š Tomcat çš„ ip å’Œç«¯å£</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token directive\"><span class=\"token keyword\">local</span> resp = ngx.location.capture(<span class=\"token string\">\"/path\"</span>,</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   \t<span class=\"token directive\"><span class=\"token keyword\">method</span> = ngx.HTTP_GET, -- è¯·æ±‚æ–¹å¼</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      args =</span> <span class=\"token punctuation\">&#123;</span>a = 1, b = 2<span class=\"token punctuation\">&#125;</span>, -- getæ–¹å¼ä¼ å‚æ•°</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      body = \"c=3&amp;d=4\" -- postæ–¹å¼ä¼ å‚æ•°</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span>)</pre></td></tr></table></figure><p>è¿”å›çš„å“åº”å†…å®¹åŒ…æ‹¬ï¼š</p>\n<ul>\n<li>resp.statusï¼šå“åº”çŠ¶æ€ç </li>\n<li>resp.headerï¼šå“åº”å¤´ï¼Œæ˜¯ä¸€ä¸ª table</li>\n<li>resp.bodyï¼šå“åº”ä½“ï¼Œå°±æ˜¯å“åº”æ•°æ®</li>\n</ul>\n<p>æˆ‘ä»¬å¸Œæœ›è¿™ä¸ªè¯·æ±‚å‘é€åˆ° Tomcat æœåŠ¡å™¨ï¼Œæ‰€ä»¥è¿˜éœ€è¦ç¼–å†™ä¸€ä¸ª server æ¥å¯¹è¿™ä¸ªè·¯å¾„åšåå‘ä»£ç†ï¼š</p>\n<figure class=\"highlight nginx\"><figcaption data-lang=\"nginx\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token directive\"><span class=\"token keyword\">location</span> /path</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   <span class=\"token comment\"># è¿™é‡Œæ˜¯ windows ç”µè„‘çš„ ip å’Œ Java æœåŠ¡ç«¯å£ï¼Œéœ€è¦ç¡®ä¿ windows é˜²ç«å¢™å¤„äºå…³é—­çŠ¶æ€</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   <span class=\"token directive\"><span class=\"token keyword\">proxy_pass</span> http://192.168.137.169:8081</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>ç¼–å†™ä»£ç ï¼š</p>\n<figure class=\"highlight nginx\"><figcaption data-lang=\"nginx\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token directive\"><span class=\"token keyword\">server</span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   <span class=\"token directive\"><span class=\"token keyword\">listen</span>       <span class=\"token number\">8081</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   <span class=\"token directive\"><span class=\"token keyword\">server_name</span>  localhost</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   <span class=\"token directive\"><span class=\"token keyword\">location</span> /item</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      <span class=\"token directive\"><span class=\"token keyword\">proxy_pass</span> http://192.168.137.1:8081</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   <span class=\"token directive\"><span class=\"token keyword\">location</span> ~ /api/item/(\\d+)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      <span class=\"token comment\"># é»˜è®¤çš„å“åº”ç±»å‹</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token directive\"><span class=\"token keyword\">default_type</span> application/json</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token comment\"># å“åº”ç»“æœç”± lua/item.lua ä¸‹çš„æ–‡ä»¶å†³å®š</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token directive\"><span class=\"token keyword\">content_by_lua_file</span> lua/item.lua</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>   <span class=\"token directive\"><span class=\"token keyword\">location</span> /</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token directive\"><span class=\"token keyword\">root</span>   html</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      <span class=\"token directive\"><span class=\"token keyword\">index</span>  index.html index.htm</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>   <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>   <span class=\"token directive\"><span class=\"token keyword\">error_page</span>   <span class=\"token number\">500</span> <span class=\"token number\">502</span> <span class=\"token number\">503</span> <span class=\"token number\">504</span>  /50x.html</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>   <span class=\"token directive\"><span class=\"token keyword\">location</span> = /50x.html</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      <span class=\"token directive\"><span class=\"token keyword\">root</span>   html</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>   <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>Tomcat çš„åå‘ä»£ç†æå®šäº†ï¼Œä»¥ååªè¦è°ƒç”¨ capture API è¯·æ±‚æ˜¯ item å¼€å¤´å°±ä¸€å®šèƒ½è¾¾åˆ° Tomcatã€‚æ‰€ä»¥ä»¥åå°±å¯ä»¥æ”¾å¿ƒçš„ä½¿ç”¨è¿™å¥— API äº†ï¼Œé‚£ä¹ˆæ—¢ç„¶è¿™ä¸ª API ç»å¸¸è¦ä½¿ç”¨ã€‚é‚£æˆ‘ä»¬å¯ä»¥å°†å‘è¯·æ±‚çš„ä»£ç å°è£…æˆä¸€ä¸ªå‡½æ•°</p>\n<h4 id=\"6311-å°è£…httpæŸ¥è¯¢çš„å‡½æ•°\"><a class=\"markdownIt-Anchor\" href=\"#6311-å°è£…httpæŸ¥è¯¢çš„å‡½æ•°\">#</a> 6.3.1.1ã€å°è£… HTTP æŸ¥è¯¢çš„å‡½æ•°ğŸŒ´</h4>\n<p>æˆ‘ä»¬å¯ä»¥å§ http æŸ¥è¯¢çš„è¯·æ±‚å°è£…ä¸ºä¸€ä¸ªå‡½æ•°ï¼Œæ”¾åˆ° OPenResty å‡½æ•°åº“ä¸­ï¼Œæ–¹ä¾¿åæœŸä½¿ç”¨ã€‚</p>\n<p>1ã€åœ¨ /usr/local/openresty/lualib ç›®å½•ä¸‹åˆ›å»º common.lua æ–‡ä»¶ï¼š</p>\n<p>ä¸ºä»€ä¹ˆæ˜¯è¿™ä¸ªä½ç½®ï¼Ÿ å› ä¸ºåœ¨ä¸Šè¿°é…ç½® nginx åŠ è½½æ¨¡å—ä¸­æŒ‡å®šçš„è·¯å¾„å°±æ˜¯åŠ è½½è¿™ä¸ªä½ç½®çš„ä»»ä½•.lua æ–‡ä»¶</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">vim</span> /usr/local/openresty/lualib/common.lua</pre></td></tr></table></figure><p>2ã€åœ¨ common.lua ä¸­å°è£… http æŸ¥è¯¢çš„å‡½æ•°</p>\n<figure class=\"highlight lua\"><figcaption data-lang=\"lua\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- å°è£…å‡½æ•°ï¼Œå‘é€ http è¯·æ±‚ï¼Œå¹¶è§£æå“åº”</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">local</span> <span class=\"token keyword\">function</span> <span class=\"token function\">read_http</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">,</span> params<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">local</span> resp <span class=\"token operator\">=</span> ngx<span class=\"token punctuation\">.</span>location<span class=\"token punctuation\">.</span><span class=\"token function\">capture</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">,</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        method <span class=\"token operator\">=</span> ngx<span class=\"token punctuation\">.</span>HTTP_GET<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        args <span class=\"token operator\">=</span> params<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> resp <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token comment\">-- è®°å½•é”™è¯¯ä¿¡æ¯ï¼Œè¿”å› 404</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        ngx<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>ngx<span class=\"token punctuation\">.</span>ERR<span class=\"token punctuation\">,</span> <span class=\"token string\">\"http not found, path: \"</span><span class=\"token punctuation\">,</span> path <span class=\"token punctuation\">,</span> <span class=\"token string\">\", args: \"</span><span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        ngx<span class=\"token punctuation\">.</span><span class=\"token function\">exit</span><span class=\"token punctuation\">(</span><span class=\"token number\">404</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">return</span> resp<span class=\"token punctuation\">.</span>body</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">-- å°†æ–¹æ³•å¯¼å‡º</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">local</span> _M <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    read_http <span class=\"token operator\">=</span> read_http</pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span>  </pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token keyword\">return</span> _M</pre></td></tr></table></figure><p>åœ¨ item.lua æ–‡ä»¶ä¸­ç¼–å†™ä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight lua\"><figcaption data-lang=\"lua\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- å¯¼å…¥ common å‡½æ•°åº“</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">local</span> common <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'common'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">local</span> read_http <span class=\"token operator\">=</span> common<span class=\"token punctuation\">.</span>read_http</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">-- è·å–è·¯å¾„å‚æ•°</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">local</span> id <span class=\"token operator\">=</span> ngx<span class=\"token punctuation\">.</span>var<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">-- æŸ¥è¯¢å•†å“ä¿¡æ¯</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">local</span> itemJSON <span class=\"token operator\">=</span> <span class=\"token function\">read_http</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/item/\"</span> <span class=\"token operator\">..</span> id<span class=\"token punctuation\">,</span> <span class=\"token keyword\">nil</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">-- æŸ¥è¯¢åº“å­˜ä¿¡æ¯</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">local</span> stockJSON <span class=\"token operator\">=</span> <span class=\"token function\">read_http</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/item/stock\"</span> <span class=\"token operator\">..</span> id<span class=\"token punctuation\">,</span> <span class=\"token keyword\">nil</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">-- è¿”å›ç»“æœ</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>ngx<span class=\"token punctuation\">.</span><span class=\"token function\">say</span><span class=\"token punctuation\">(</span>itemJSON<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>è®¿é—® uri è¿›è¡Œä¸€ä¸‹è¯·æ±‚æµ‹è¯•ï¼š<a href=\"http://localhost/item.html?id=10003\">http://localhost/item.html?id=10003</a></p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310201318784.png\" alt=\"image-20231020131800919\"></p>\n<p>è¿”å›çš„æ•°æ®</p>\n<pre><code>&#123;\n    &quot;id&quot;: 10003,\n    &quot;name&quot;: &quot;éŸ©ç‰ˆç‰›ä»”è£¤&quot;,\n    &quot;title&quot;: &quot;å”ç‹®æ–°å“ç‰›ä»”è£¤å¥³å­¦ç”ŸéŸ©ç‰ˆå®½æ¾è£¤å­ Aæ¬¾/ä¸­ç‰›ä»”è“ï¼ˆæ— ç»’æ¬¾ï¼‰ 26&quot;,\n    &quot;price&quot;: 84600,\n    &quot;image&quot;: &quot;https://m.360buyimg.com/mobilecms/s720x720_jfs/t26989/116/124520860/644643/173643ea/5b860864N6bfd95db.jpg!q70.jpg.webp&quot;,\n    &quot;category&quot;: &quot;ç‰›ä»”è£¤&quot;,\n    &quot;brand&quot;: &quot;å”ç‹®&quot;,\n    &quot;spec&quot;: &quot;&#123;\\&quot;é¢œè‰²\\&quot;: \\&quot;è“è‰²\\&quot;, \\&quot;å°ºç \\&quot;: \\&quot;26\\&quot;&#125;&quot;,\n    &quot;status&quot;: 1,\n    &quot;createTime&quot;: &quot;2019-05-01T00:00:00.000+00:00&quot;,\n    &quot;updateTime&quot;: &quot;2019-05-01T00:00:00.000+00:00&quot;,\n    &quot;stock&quot;: null,\n    &quot;sold&quot;: null\n&#125;\n</code></pre>\n<p>ç°åœ¨æ‰€æœ‰çš„å•†å“éƒ½èƒ½æ­£å¸¸æŸ¥è¯¢äº†ï¼Œä½†æ˜¯ï¼</p>\n<p>é‡Œé¢çš„ï¼Œé”€é‡å’Œå­˜åº“çš„æ•°æ®è¿˜æ²¡æœ‰ã€‚</p>\n<p>ä½†æ˜¯å¦‚æœè¦æ˜¯æœ‰ 3 å¼ è¡¨ï¼Œ4 å¼ è¡¨ï¼Œ5 å¼ è¡¨éƒ½éœ€è¦æŠŠå®ƒä»¬æ‹¼æ¥èµ·æ¥ï¼Œæ‰€ä»¥æœ€ç»ˆéœ€è¦çš„æ˜¯å®Œæ•´çš„æ•°æ®</p>\n<p>ä½†æ˜¯ itemJSON å¾—åˆ°çš„æ•°æ®æ˜¯ä¸€ä¸ª Json æ•°æ®ï¼Œæˆ‘ä»¬éœ€è¦è½¬æ¢ä¸º Lua é‡Œé¢çš„å¯¹è±¡ï¼Œä½¿ç”¨ table è¿™ä¸ªæ•°æ®ç±»å‹æ¥è¿›è¡Œå­˜å‚¨</p>\n<p>å¦‚ä¸‹å°±æ˜¯å°† JSON ååºåˆ—åŒ–ä¸º Lua å¯¹è±¡çš„æ–¹å¼ï¼š</p>\n<h4 id=\"6312-jsonç»“æœå¤„ç†\"><a class=\"markdownIt-Anchor\" href=\"#6312-jsonç»“æœå¤„ç†\">#</a> 6.3.1.2ã€JSON ç»“æœå¤„ç†ğŸŒ´</h4>\n<p>OPenResty æä¾›äº†ä¸€ä¸ª cjson çš„æ¨¡å—ç”¨æ¥å¤„ç† JSON çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚</p>\n<p>å®˜æ–¹åœ°å€ï¼š<a href=\"https://github.com/openresty/lua-cjson/\">https://github.com/openresty/lua-cjson/</a></p>\n<p>è¯¥æ¨¡å—çš„ç›®å½•ä½ç½®å¦‚ä¸‹ï¼š/usr/local/openresty/lualib/</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310201330405.png\" alt=\"image-20231020133045031\"></p>\n<p><strong>ä½¿ç”¨</strong>ï¼š</p>\n<p>1ã€å¯¼å…¥ cjson æ¨¡å—ï¼š</p>\n<figure class=\"highlight lua\"><figcaption data-lang=\"lua\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">local</span> cjson <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'cjson'</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>2ã€åºåˆ—åŒ–ï¼š</p>\n<figure class=\"highlight lua\"><figcaption data-lang=\"lua\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">local</span> obj <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   name <span class=\"token operator\">=</span> <span class=\"token string\">'jack'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   age <span class=\"token operator\">=</span> <span class=\"token number\">21</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">local</span> json <span class=\"token operator\">=</span> cjson<span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>3ã€ååºåˆ—åŒ–</p>\n<figure class=\"highlight lua\"><figcaption data-lang=\"lua\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">local</span> json <span class=\"token operator\">=</span> <span class=\"token string\">'&#123;\"name\": \"jack\", \"age\": 21&#125;'</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">-- ååºåˆ—åŒ–</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">local</span> obj <span class=\"token operator\">=</span> cjson<span class=\"token punctuation\">.</span><span class=\"token function\">decode</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">print</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>ç»§ç»­ä¸‹é¢çš„ä»£ç æ­¥éª¤ï¼š</p>\n<p>1ã€å°†è¯·æ±‚åˆ°çš„ json æ•°æ®åºåˆ—åŒ–ä¸º lua ä¸­çš„ table æ•°æ®</p>\n<p>2ã€å†å°†åºåˆ—åŒ–çš„æ•°æ®è¿›è¡Œè°ƒç”¨æ‹¼æ¥</p>\n<p>3ã€æ‹¼æ¥å®Œæ¯•åå†å°† lua ä¸­ table æ•°æ®åºåˆ—åŒ–ä¸º json å“åº”åˆ°å‰ç«¯</p>\n<figure class=\"highlight lua\"><figcaption data-lang=\"lua\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- å¯¼å…¥ common å‡½æ•°åº“</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">local</span> common <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'common'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">local</span> read_http <span class=\"token operator\">=</span> common<span class=\"token punctuation\">.</span>read_http</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">-- å¯¼å…¥ cjson åº“</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">local</span> cjson <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'cjson'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">-- è·å–è·¯å¾„å‚æ•°</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">local</span> id <span class=\"token operator\">=</span> ngx<span class=\"token punctuation\">.</span>var<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">-- æŸ¥è¯¢å•†å“ä¿¡æ¯</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">local</span> itemJSON <span class=\"token operator\">=</span> <span class=\"token function\">read_http</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/item/\"</span> <span class=\"token operator\">..</span> id<span class=\"token punctuation\">,</span> <span class=\"token keyword\">nil</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">-- æŸ¥è¯¢åº“å­˜ä¿¡æ¯</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">local</span> stockJSON <span class=\"token operator\">=</span> <span class=\"token function\">read_http</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/item/stock/\"</span> <span class=\"token operator\">..</span> id<span class=\"token punctuation\">,</span> <span class=\"token keyword\">nil</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\">-- JSON è½¬åŒ–ä¸º lua çš„ table</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token keyword\">local</span> item <span class=\"token operator\">=</span> cjson<span class=\"token punctuation\">.</span><span class=\"token function\">decode</span><span class=\"token punctuation\">(</span>itemJSON<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token keyword\">local</span> sto <span class=\"token operator\">=</span> cjson<span class=\"token punctuation\">.</span><span class=\"token function\">decode</span><span class=\"token punctuation\">(</span>stockJSON<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\">-- ç»„åˆæ•°æ®</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>item<span class=\"token punctuation\">.</span>stock <span class=\"token operator\">=</span> sto<span class=\"token punctuation\">.</span>stock</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>item<span class=\"token punctuation\">.</span>sold <span class=\"token operator\">=</span> sto<span class=\"token punctuation\">.</span>sold</pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\">-- æŠŠ item åºåˆ—åŒ–ä¸º json è¿”å›ç»“æœ</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>ngx<span class=\"token punctuation\">.</span><span class=\"token function\">say</span><span class=\"token punctuation\">(</span>cjson<span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>è¯·æ±‚ uri è¿›è¡Œæµ‹è¯•ï¼š<a href=\"http://localhost/item.html?id=10004\">http://localhost/item.html?id=10004</a></p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310201343013.png\" alt=\"image-20231020134303536\"></p>\n<p>è¯·æ±‚åˆ°çš„æ•°æ®</p>\n<pre><code>&#123;\n    &quot;spec&quot;: &quot;&#123;\\&quot;é¢œè‰²\\&quot;: \\&quot;ç™½è‰²\\&quot;, \\&quot;å°ºç \\&quot;: \\&quot;36\\&quot;&#125;&quot;,\n    &quot;sold&quot;: 974,\n    &quot;status&quot;: 1,\n    &quot;updateTime&quot;: &quot;2019-05-01T00:00:00.000+00:00&quot;,\n    &quot;title&quot;: &quot;æ£®é©¬(senma)ä¼‘é—²é‹å¥³2019æ˜¥å­£æ–°æ¬¾éŸ©ç‰ˆç³»å¸¦æ¿é‹å­¦ç”Ÿç™¾æ­å¹³åº•å¥³é‹ é»„è‰² 36&quot;,\n    &quot;stock&quot;: 99999,\n    &quot;price&quot;: 10400,\n    &quot;image&quot;: &quot;https://m.360buyimg.com/mobilecms/s720x720_jfs/t1/29976/8/2947/65074/5c22dad6Ef54f0505/0b5fe8c5d9bf6c47.jpg!q70.jpg.webp&quot;,\n    &quot;createTime&quot;: &quot;2019-05-01T00:00:00.000+00:00&quot;,\n    &quot;category&quot;: &quot;ä¼‘é—²é‹&quot;,\n    &quot;name&quot;: &quot;ä¼‘é—²æ¿é‹&quot;,\n    &quot;brand&quot;: &quot;æ£®é©¬&quot;,\n    &quot;id&quot;: 10004\n&#125;\n</code></pre>\n<p>å¯ä»¥çœ‹åˆ°æœ‰åº“å­˜å’Œé”€é‡çš„æ•°æ®äº†</p>\n<h3 id=\"632-tomcaté›†ç¾¤çš„è´Ÿè½½å‡è¡¡\"><a class=\"markdownIt-Anchor\" href=\"#632-tomcaté›†ç¾¤çš„è´Ÿè½½å‡è¡¡\">#</a> 6.3.2ã€Tomcat é›†ç¾¤çš„è´Ÿè½½å‡è¡¡ğŸŒ²</h3>\n<p>æˆ‘ä»¬å·²ç»å®ç°äº†ï¼Œä» OPenResty å‘ tomcat å‘é€ä¸€ä¸ª http è¯·æ±‚å»æŸ¥è¯¢å•†å“ä¿¡æ¯è¿”å›é¡µé¢ï¼Œå®Œæˆæ¸²æŸ“ã€‚ä½†æ˜¯åœ¨ä¸Šè¿°å®ç°æ¡ˆä¾‹ä¸­ Tomcat åªæœ‰ä¸€å°</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310201346554.png\" alt=\"image-20231020134614455\"></p>\n<p>åœ¨å®é™…ç”Ÿäº§ä¸­ Tomcat ä¸€å®šæ˜¯ä¸€ä¸ªé›†ç¾¤ã€‚æ‰€ä»¥ OPenResty å†å‘é€è¯·æ±‚æ—¶å¿…é¡»å¾—å¯¹å¤šå° Tomcat å®ç°ä¸€ä¸ªè´Ÿè½½å‡è¡¡</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310201349192.png\" alt=\"image-20231020134913570\"></p>\n<p>æ¯”æ–¹è¯´ è´Ÿè½½å‡è¡¡æŒ‘é€‰äº† 8081ï¼Œç„¶åè¯·æ±‚å°±ä¼šåˆ°è¾¾ 8081 ç„¶åå»æŸ¥è¯¢æ•°æ®åº“ã€‚</p>\n<p>æŸ¥è¯¢å®Œæ•°æ®åº“åä¼šå½¢æˆä¸€ä¸ª jvm è¿›ç¨‹ç¼“å­˜ï¼Œä¿å­˜åœ¨ 8081 è¿™å°æœåŠ¡å™¨ä¸Šï¼Œç¼“å­˜æœ‰äº†ä»¥åä¸‹æ¬¡å¯ä»¥ç›´æ¥è¯»å–ç¼“å­˜å°±ä¸ç”¨æŸ¥è¯¢æ•°æ®åº“äº†æ€§èƒ½å°±éå¸¸å¥½äº†ã€‚ä½†æ˜¯éå¸¸å¯æƒœçš„æ˜¯è¿›ç¨‹ç¼“å­˜æ˜¯ä¸èƒ½å…±äº«çš„ 8081 æœ‰è¿™ä¸ªç¼“å­˜ï¼Œ8082 å¹¶æ²¡æœ‰ï¼Œè€Œè´Ÿè½½å‡è¡¡çš„è§„åˆ™æ˜¯ è½®è¯¢ã€‚å¦‚æœè¿™æ ·è®¿é—®ç¼“å­˜å°±ä¼šåœ¨å¤šå° Tomcat å»å†—ä½™çš„ä¿å­˜ã€‚ç¬¬ä¸€ä¸ªå ç”¨é¢å¤–ç©ºé—´ï¼Œç¬¬äºŒæ˜¯ç¼“å­˜çš„å‘½ä¸­ç‡ä¹Ÿæœ‰ç‚¹æƒ¨</p>\n<p>å¦‚æœè¯´æˆ‘æƒ³è¦å•†å“ 10001 ç¬¬ä¸€æ¬¡æŸ¥è¯¢å®Œä»¥åæ°¸è¿œéƒ½æœ‰ç¼“å­˜ã€‚é‚£ä¹ˆæˆ‘å¿…é¡»è®© item/10001 è¿™ä¸ªè¯·æ±‚æ¯æ¬¡éƒ½æŒ‡å‘åŒä¸€ä¸ªæœåŠ¡å™¨ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯è¿™ä¸ªç¼“å­˜ä¸€ç›´ç”Ÿæ•ˆã€‚å‡å¦‚è¯´åˆæ¥ä¸€ä¸ª item/10002 é‚£æˆ‘å°±è®©å®ƒæŒ‡å‘ä¸‹ä¸€ä¸ªæœåŠ¡å™¨ã€‚</p>\n<p>ä¸åŒå•†å“æ°¸è¿œè®¿é—®ä¸åŒæœåŠ¡å™¨ï¼Œç›¸åŒå•†å“æ°¸è¿œè®¿é—®åŒä¸€ä¸ªæœåŠ¡å™¨ï¼Œè¿™æ ·å°±èƒ½ä¿è¯ç¼“å­˜æ°¸è¿œå‘½ä¸­ã€‚</p>\n<p>è¿™æ · jvm è¿›ç¨‹ç¼“å­˜æ‰æœ‰æ„ä¹‰ã€‚ä½†æ˜¯ç°åœ¨æ˜¯è½®è¯¢è‚¯å®šåšä¸åˆ°è¿™ä¸€ç‚¹ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¿®æ”¹ nginx è´Ÿè½½å‡è¡¡çš„ç®—æ³•äº†ã€‚</p>\n<figure class=\"highlight nginx\"><figcaption data-lang=\"nginx\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># tomcat é›†ç¾¤é…ç½®</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token directive\"><span class=\"token keyword\">upstream</span> tomcat-cluster</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   <span class=\"token comment\"># æ ¹æ®è¯·æ±‚è¿‡æ¥çš„è·¯å¾„æ¥è®¡ç®— hash å€¼ç„¶åå†³å®šè®¿é—®å“ªä¸ªæœåŠ¡å™¨</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token directive\"><span class=\"token keyword\">hash</span> <span class=\"token variable\">$request_uri</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   <span class=\"token directive\"><span class=\"token keyword\">server</span> 192.168.249.128:8081</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   <span class=\"token directive\"><span class=\"token keyword\">server</span> 192.168.249.128:8082</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>ä»£ç æ¼”ç¤ºå¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight nginx\"><figcaption data-lang=\"nginx\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token directive\"><span class=\"token keyword\">http</span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token directive\"><span class=\"token keyword\">include</span>       mime.types</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token directive\"><span class=\"token keyword\">default_type</span>  application/octet-stream</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token directive\"><span class=\"token keyword\">sendfile</span>        <span class=\"token boolean\">on</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token directive\"><span class=\"token keyword\">keepalive_timeout</span>  <span class=\"token number\">65</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token comment\"># lua æ¨¡å—</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token directive\"><span class=\"token keyword\">lua_package_path</span> <span class=\"token string\">\"/usr/local/openresty/lualib/?.lua;;\"</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token comment\"># c æ¨¡å—     </span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token directive\"><span class=\"token keyword\">lua_package_cpath</span> <span class=\"token string\">\"/usr/local/openresty/lualib/?.so;;\"</span></span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token directive\"><span class=\"token keyword\">upstream</span> tomcat-cluster</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token directive\"><span class=\"token keyword\">hash</span> <span class=\"token variable\">$request_uri</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token directive\"><span class=\"token keyword\">server</span> 192.168.249.128:8081</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token directive\"><span class=\"token keyword\">server</span> 192.168.249.128:8082</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token directive\"><span class=\"token keyword\">server</span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token directive\"><span class=\"token keyword\">listen</span>       <span class=\"token number\">8081</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token directive\"><span class=\"token keyword\">server_name</span>  localhost</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token directive\"><span class=\"token keyword\">location</span> /item</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            <span class=\"token directive\"><span class=\"token keyword\">proxy_pass</span> http://tomcat-cluster</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token directive\"><span class=\"token keyword\">location</span> ~ /api/item/(\\d+)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>          <span class=\"token comment\"># é»˜è®¤çš„å“åº”ç±»å‹</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>          <span class=\"token directive\"><span class=\"token keyword\">default_type</span> application/json</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>          <span class=\"token comment\"># å“åº”ç»“æœç”± lua/item.lua ä¸‹çš„æ–‡ä»¶å†³å®š</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>          <span class=\"token directive\"><span class=\"token keyword\">content_by_lua_file</span> lua/item.lua</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        <span class=\"token directive\"><span class=\"token keyword\">location</span> /</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            <span class=\"token directive\"><span class=\"token keyword\">root</span>   html</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            <span class=\"token directive\"><span class=\"token keyword\">index</span>  index.html index.htm</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token directive\"><span class=\"token keyword\">error_page</span>   <span class=\"token number\">500</span> <span class=\"token number\">502</span> <span class=\"token number\">503</span> <span class=\"token number\">504</span>  /50x.html</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token directive\"><span class=\"token keyword\">location</span> = /50x.html</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            <span class=\"token directive\"><span class=\"token keyword\">root</span>   html</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>åœ¨ idea ä¸­å¼€å¯ 8082 ç«¯å£çš„æœåŠ¡</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310201435034.png\" alt=\"image-20231020143541296\"></p>\n<p>å¯åŠ¨</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310201436217.png\" alt=\"image-20231020143629316\"></p>\n<p>è®¿é—® uri è¿›è¡Œæµ‹è¯•ï¼š<a href=\"http://localhost/item.html?id=10001\">http://localhost/item.html?id=10001</a></p>\n<p>è¿™ä¸ª uri è®¿é—®è¯·æ±‚åˆ°çš„ Tomcat æœåŠ¡ä¸ºå¦‚ä¸‹ï¼š</p>\n<p>idea æ§åˆ¶å°ä¸­æ‰“å°ä¿¡æ¯ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310201441979.png\" alt=\"image-20231020144146827\"></p>\n<p>è®¿é—® uri è¿›è¡Œæµ‹è¯•ï¼š<a href=\"http://localhost/item.html?id=10002\">http://localhost/item.html?id=10002</a></p>\n<p>è¿™ä¸ª uri è®¿é—®è¯·æ±‚åˆ°çš„ Tomcat æœåŠ¡ä¸ºå¦‚ä¸‹ï¼š</p>\n<p>idea æ§åˆ¶å°ä¸­æ‰“å°ä¿¡æ¯ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310201442866.png\" alt=\"image-20231020144213109\"></p>\n<p>å°†è¿ä¸ªæœåŠ¡çš„æ§åˆ¶å°æ‰“å°çš„ä¿¡æ¯éƒ½æ¸…ç©ºç„¶åå†å»è®¿é—®ä¸€ä¸‹ 10001 å’Œ 10002</p>\n<p>æ§åˆ¶å°éƒ½æ²¡æœ‰æ‰“å°ä»»ä½•çš„ä¿¡æ¯è¯´æ˜ç¼“å­˜èµ·ä½œç”¨äº†ã€‚</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310201443037.png\" alt=\"image-20231020144338972\"></p>\n<h2 id=\"64-æ·»åŠ redisç¼“å­˜çš„éœ€æ±‚\"><a class=\"markdownIt-Anchor\" href=\"#64-æ·»åŠ redisç¼“å­˜çš„éœ€æ±‚\">#</a> 6.4ã€æ·»åŠ  Redis ç¼“å­˜çš„éœ€æ±‚ğŸŒ³</h2>\n<p>è¯·æ±‚æˆåŠŸåä¸åº”è¯¥ç›´æ¥æŸ¥è¯¢ jvm è¿›ç¨‹ç¼“å­˜è€Œæ˜¯åº”è¯¥å…ˆåˆ° redis ä¸­çœ‹çœ‹æœ‰æ²¡æœ‰ç¼“å­˜å†å»çœ‹ jvm è¿›ç¨‹ç¼“å­˜</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310201447926.png\" alt=\"image-20231020144727615\"></p>\n<h3 id=\"641-æ·»åŠ redisç¼“å­˜è¦é¢ä¸´çš„é—®é¢˜\"><a class=\"markdownIt-Anchor\" href=\"#641-æ·»åŠ redisç¼“å­˜è¦é¢ä¸´çš„é—®é¢˜\">#</a> 6.4.1ã€æ·»åŠ  Redis ç¼“å­˜è¦é¢ä¸´çš„é—®é¢˜ğŸŒ²</h3>\n<h4 id=\"6411-å†·å¯åŠ¨ä¸ç¼“å­˜é¢„çƒ­\"><a class=\"markdownIt-Anchor\" href=\"#6411-å†·å¯åŠ¨ä¸ç¼“å­˜é¢„çƒ­\">#</a> 6.4.1.1ã€å†·å¯åŠ¨ä¸ç¼“å­˜é¢„çƒ­ğŸŒ´</h4>\n<p><mark>å†·å¯åŠ¨</mark>ï¼šæœåŠ¡åˆšåˆšå¯åŠ¨æ—¶ï¼ŒRedis ä¸­å¹¶æ²¡æœ‰ç¼“å­˜ï¼Œå¦‚æœæ‰€æœ‰å•†å“æ•°æ®éƒ½åœ¨ç¬¬ä¸€æ¬¡æŸ¥è¯¢æ˜¯æ·»åŠ ç¼“å­˜ï¼Œå¯èƒ½ä¼šç»™æ•°æ®åº“å¸¦æ¥è¾ƒå¤§å‹åŠ›</p>\n<p><mark>ç¼“å­˜é¢„çƒ­</mark>ï¼šåœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨å¤§æ•°æ®ç»Ÿè®¡ç”¨æˆ·è®¿é—®çš„çƒ­ç‚¹æ•°æ®ï¼Œåœ¨é¡¹ç›®å¯åŠ¨æ—¶å°†è¿™äº›çƒ­ç‚¹æ•°æ®æå‰æŸ¥è¯¢å¹¶ä¿å­˜åˆ° Redis ä¸­</p>\n<p>æˆ‘ä»¬æ•°æ®æµé‡è¾ƒå°‘ï¼Œå¯ä»¥åœ¨å¯åŠ¨æ—¶å°†æ‰€æœ‰æ•°æ®éƒ½å­˜å…¥ç¼“å­˜ä¸­ã€‚</p>\n<h4 id=\"6412-ç¼“å­˜é¢„çƒ­\"><a class=\"markdownIt-Anchor\" href=\"#6412-ç¼“å­˜é¢„çƒ­\">#</a> 6.4.1.2ã€ç¼“å­˜é¢„çƒ­ğŸŒ´</h4>\n<p>æ­¥éª¤ï¼š</p>\n<p>1ã€åˆ©ç”¨ Docker å®‰è£… Redis</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@localhost nginx<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker run --name redis -p 6379:6379 -d redis redis-server --appendonly yes</span></pre></td></tr></table></figure><p>2ã€åœ¨ item-service æœåŠ¡ä¸­å¼•å…¥ redis ä¾èµ–</p>\n<figure class=\"highlight xml\"><figcaption data-lang=\"XML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">></span></span>org.springframework.boot<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">></span></span>spring-boot-starter-data-redis<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">></span></span></pre></td></tr></table></figure><p>3ã€é…ç½® Redis åœ°å€</p>\n<figure class=\"highlight yml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">redis</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token key atrule\">host</span><span class=\"token punctuation\">:</span> 192.168.249.128</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">6379</span></pre></td></tr></table></figure><p>4ã€ç¼–å†™åˆå§‹åŒ–ç±»</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Component</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">RedisHandler</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">InitializingBean</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token annotation punctuation\">@Autowired</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">StringRedisTemplate</span> redisTemplate<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token annotation punctuation\">@Autowired</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">ItemService</span> itemService<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token annotation punctuation\">@Autowired</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">IItemStockService</span> stockService<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">ObjectMapper</span> <span class=\"token constant\">MAPPER</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ObjectMapper</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">afterPropertiesSet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token comment\">// åˆå§‹åŒ–ç¼“å­˜</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token comment\">// 1. æŸ¥è¯¢å•†å“ä¿¡æ¯</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Item</span><span class=\"token punctuation\">></span></span> list <span class=\"token operator\">=</span> itemService<span class=\"token punctuation\">.</span><span class=\"token function\">list</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token comment\">// 2. æ”¾å…¥ç¼“å­˜</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Item</span> item <span class=\"token operator\">:</span> list<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            <span class=\"token comment\">// 2.1. åºåˆ—åŒ–ä¸º json</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            <span class=\"token class-name\">String</span> json <span class=\"token operator\">=</span> <span class=\"token constant\">MAPPER</span><span class=\"token punctuation\">.</span><span class=\"token function\">writeValueAsString</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            <span class=\"token comment\">// 2.2. å­˜å…¥ redis</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            redisTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">opsForValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"item:id:\"</span> <span class=\"token operator\">+</span> item<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token comment\">// 1. æŸ¥è¯¢åº“å­˜ä¿¡æ¯</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ItemStock</span><span class=\"token punctuation\">></span></span> list1 <span class=\"token operator\">=</span> stockService<span class=\"token punctuation\">.</span><span class=\"token function\">list</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token comment\">// 2. æ”¾å…¥ç¼“å­˜</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">ItemStock</span> itemStock <span class=\"token operator\">:</span> list1<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            <span class=\"token comment\">// 2.1. åºåˆ—åŒ–ä¸º json</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            <span class=\"token class-name\">String</span> json <span class=\"token operator\">=</span> <span class=\"token constant\">MAPPER</span><span class=\"token punctuation\">.</span><span class=\"token function\">writeValueAsString</span><span class=\"token punctuation\">(</span>itemStock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            <span class=\"token comment\">// 2.2. å­˜å…¥ redis</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            redisTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">opsForValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"item:stock:id:\"</span> <span class=\"token operator\">+</span> itemStock<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>é‡å¯æˆ–å¯åŠ¨ 8081 å’Œ 8082 ä¸¤ä¸ªæœåŠ¡å™¨</p>\n<p>å¯ä»¥çœ‹åˆ°å¯åŠ¨æ—¶ redis åˆå§‹åŒ–ç¼“å­˜å»æŸ¥è¯¢äº†æ•°æ®åº“æ­¤æ—¶å¯ä»¥çœ‹ä¸‹ redis ä¸­çš„æ•°æ®æƒ…å†µ</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310201513672.png\" alt=\"image-20231020151344361\"></p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@localhost nginx<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker exec -it redis redis-cli</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">127.0</span>.0.1:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> keys *</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"item:id:10004\"</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"item:stock:id:10004\"</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"item:id:10002\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"item:stock:id:10005\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"item:id:10001\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre> <span class=\"token number\">6</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"item:stock:id:10001\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre> <span class=\"token number\">7</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"item:stock:id:10003\"</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre> <span class=\"token number\">8</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"item:id:10003\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre> <span class=\"token number\">9</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"item:stock:id:10002\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token number\">10</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"item:id:10005\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token number\">127.0</span>.0.1:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span></pre></td></tr></table></figure><h2 id=\"65-æŸ¥è¯¢redisç¼“å­˜\"><a class=\"markdownIt-Anchor\" href=\"#65-æŸ¥è¯¢redisç¼“å­˜\">#</a> 6.5ã€æŸ¥è¯¢ Redis ç¼“å­˜ğŸŒ³</h2>\n<h3 id=\"651-openrestyçš„redisæ¨¡å—\"><a class=\"markdownIt-Anchor\" href=\"#651-openrestyçš„redisæ¨¡å—\">#</a> 6.5.1ã€OpenResty çš„ Redis æ¨¡å—ğŸŒ²</h3>\n<p>OPenResty æä¾›äº†æ“ä½œ Redis çš„æ¨¡å—ï¼Œæˆ‘ä»¬åªè¦å¼•å…¥è¯¥æ¨¡å—å°±èƒ½ç›´æ¥ä½¿ç”¨ï¼š</p>\n<p>åœ¨ common.lua æ–‡ä»¶ä¸­è¿›è¡Œç¼–å†™</p>\n<ul>\n<li>å¼•å…¥ Redis æ¨¡å—ï¼Œå¹¶åˆå§‹åŒ– Redis å¯¹è±¡</li>\n</ul>\n<p>ä¸ºä»€ä¹ˆå¼•å…¥æ¨¡å—ä¸­æ–‡ä»¶åä¸­é—´éœ€è¦ä¸€ä¸ª . ï¼Ÿ</p>\n<p>è§£é‡Šï¼šå› ä¸ºæˆ‘ä»¬ä¸Šè¿°æ–‡ç« ä¸­éƒ½æ˜¯å¼•å…¥çš„ lualib ç›®å½•ä¸‹çš„æ¨¡å—å› ä¸ºç›´æ¥åœ¨ lua ç›®å½•æ‰€ä»¥å¯ä»¥ç›´æ¥å†™æ–‡ä»¶åå°±è¡Œäº†ã€‚ä½†æ˜¯è¿™ä¸ª redis å¯ä¸å† lualib æ ¹ç›®å½•ä¸­è€Œæ˜¯åœ¨ resty ç›®å½•ä¸‹</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310201533407.png\" alt=\"image-20231020153335950\"></p>\n<figure class=\"highlight lua\"><figcaption data-lang=\"lua\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- å¼•å…¥ redis æ¨¡å—</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">local</span> redis <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'resty.redis'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">-- åˆå§‹åŒ– redis å¯¹è±¡</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">local</span> red <span class=\"token operator\">=</span> redis<span class=\"token punctuation\">:</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">-- è®¾ç½® redis è¶…æ—¶æ—¶é—´</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>red<span class=\"token punctuation\">:</span><span class=\"token function\">set_timeouts</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><ul>\n<li>å°è£…å‡½æ•°ï¼Œç”¨æ¥é‡Šæ”¾ Redis é“¾æ¥ï¼Œå…¶å®æ˜¯æ”¾å…¥è¿æ¥æ± </li>\n</ul>\n<figure class=\"highlight lua\"><figcaption data-lang=\"lua\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- å…³é—­ redis è¿æ¥çš„å·¥å…·æ–¹æ³•ï¼Œå…¶å®æ˜¯æ”¾å…¥è¿æ¥æ± </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">local</span> <span class=\"token keyword\">function</span> <span class=\"token function\">close_redis</span><span class=\"token punctuation\">(</span>red<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">local</span> pool_max_idle_time <span class=\"token operator\">=</span> <span class=\"token number\">10000</span> <span class=\"token comment\">-- è¿æ¥çš„ç©ºé—²æ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">local</span> pool_size <span class=\"token operator\">=</span> <span class=\"token number\">100</span> <span class=\"token comment\">-- è¿æ¥æ± å¤§å°</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">local</span> ok<span class=\"token punctuation\">,</span> err <span class=\"token operator\">=</span> red<span class=\"token punctuation\">:</span><span class=\"token function\">set_keepalive</span><span class=\"token punctuation\">(</span>pool_max_idle_time<span class=\"token punctuation\">,</span> pool_size<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> ok <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        ngx<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>ngx<span class=\"token punctuation\">.</span>ERR<span class=\"token punctuation\">,</span> <span class=\"token string\">\"æ”¾å…¥redisè¿æ¥æ± å¤±è´¥: \"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">end</span></pre></td></tr></table></figure><p>OPenResty æä¾›äº†æ“ä½œ Redis çš„æ¨¡å—ï¼Œæˆ‘ä»¬åªè¦å¼•å…¥è¯¥æ¨¡å—å°±èƒ½ç›´æ¥ä½¿ç”¨ï¼š</p>\n<ul>\n<li>å°è£…å‡½æ•°ï¼Œä» Redis è¯»æ•°æ®å¹¶è¿”å›ï¼š</li>\n</ul>\n<figure class=\"highlight lua\"><figcaption data-lang=\"lua\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- æŸ¥è¯¢ redis çš„æ–¹æ³• ip å’Œ port æ˜¯ redis åœ°å€ï¼Œkey æ˜¯æŸ¥è¯¢çš„ key</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">local</span> <span class=\"token keyword\">function</span> <span class=\"token function\">read_redis</span><span class=\"token punctuation\">(</span>ip<span class=\"token punctuation\">,</span> port<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token comment\">-- è·å–ä¸€ä¸ªè¿æ¥</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">local</span> ok<span class=\"token punctuation\">,</span> err <span class=\"token operator\">=</span> red<span class=\"token punctuation\">:</span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>ip<span class=\"token punctuation\">,</span> port<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> ok <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        ngx<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>ngx<span class=\"token punctuation\">.</span>ERR<span class=\"token punctuation\">,</span> <span class=\"token string\">\"è¿æ¥rediså¤±è´¥ : \"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token keyword\">nil</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token comment\">-- æŸ¥è¯¢ redis</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">local</span> resp<span class=\"token punctuation\">,</span> err <span class=\"token operator\">=</span> red<span class=\"token punctuation\">:</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token comment\">-- æŸ¥è¯¢å¤±è´¥å¤„ç†</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> resp <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        ngx<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>ngx<span class=\"token punctuation\">.</span>ERR<span class=\"token punctuation\">,</span> <span class=\"token string\">\"æŸ¥è¯¢Rediså¤±è´¥: \"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">,</span> <span class=\"token string\">\", key = \"</span> <span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token comment\">-- å¾—åˆ°çš„æ•°æ®ä¸ºç©ºå¤„ç†</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">if</span> resp <span class=\"token operator\">==</span> ngx<span class=\"token punctuation\">.</span>null <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        resp <span class=\"token operator\">=</span> <span class=\"token keyword\">nil</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        ngx<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>ngx<span class=\"token punctuation\">.</span>ERR<span class=\"token punctuation\">,</span> <span class=\"token string\">\"æŸ¥è¯¢Redisæ•°æ®ä¸ºç©º, key = \"</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token function\">close_redis</span><span class=\"token punctuation\">(</span>red<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">return</span> resp</pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token keyword\">end</span></pre></td></tr></table></figure><p>å®Œæ•´çš„ä»£ç ç¼–å†™ï¼š</p>\n<figure class=\"highlight lua\"><figcaption data-lang=\"lua\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- å¼•å…¥ redis æ¨¡å—</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">local</span> redis <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'resty.redis'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">-- åˆå§‹åŒ– redis å¯¹è±¡</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">local</span> red <span class=\"token operator\">=</span> redis<span class=\"token punctuation\">:</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">-- è®¾ç½® redis è¶…æ—¶æ—¶é—´</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>red<span class=\"token punctuation\">:</span><span class=\"token function\">set_timeouts</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">-- å…³é—­ redis è¿æ¥çš„å·¥å…·æ–¹æ³•ï¼Œå…¶å®æ˜¯æ”¾å…¥è¿æ¥æ± </span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">local</span> <span class=\"token keyword\">function</span> <span class=\"token function\">close_redis</span><span class=\"token punctuation\">(</span>red<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">local</span> pool_max_idle_time <span class=\"token operator\">=</span> <span class=\"token number\">10000</span> <span class=\"token comment\">-- è¿æ¥çš„ç©ºé—²æ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">local</span> pool_size <span class=\"token operator\">=</span> <span class=\"token number\">100</span> <span class=\"token comment\">-- è¿æ¥æ± å¤§å°</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">local</span> ok<span class=\"token punctuation\">,</span> err <span class=\"token operator\">=</span> red<span class=\"token punctuation\">:</span><span class=\"token function\">set_keepalive</span><span class=\"token punctuation\">(</span>pool_max_idle_time<span class=\"token punctuation\">,</span> pool_size<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> ok <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        ngx<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>ngx<span class=\"token punctuation\">.</span>ERR<span class=\"token punctuation\">,</span> <span class=\"token string\">\"æ”¾å…¥redisè¿æ¥æ± å¤±è´¥: \"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\">-- æŸ¥è¯¢ redis çš„æ–¹æ³• ip å’Œ port æ˜¯ redis åœ°å€ï¼Œkey æ˜¯æŸ¥è¯¢çš„ key</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token keyword\">local</span> <span class=\"token keyword\">function</span> <span class=\"token function\">read_redis</span><span class=\"token punctuation\">(</span>ip<span class=\"token punctuation\">,</span> port<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token comment\">-- è·å–ä¸€ä¸ªè¿æ¥</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">local</span> ok<span class=\"token punctuation\">,</span> err <span class=\"token operator\">=</span> red<span class=\"token punctuation\">:</span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>ip<span class=\"token punctuation\">,</span> port<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> ok <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        ngx<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>ngx<span class=\"token punctuation\">.</span>ERR<span class=\"token punctuation\">,</span> <span class=\"token string\">\"è¿æ¥rediså¤±è´¥ : \"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token keyword\">nil</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token comment\">-- æŸ¥è¯¢ redis</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token keyword\">local</span> resp<span class=\"token punctuation\">,</span> err <span class=\"token operator\">=</span> red<span class=\"token punctuation\">:</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token comment\">-- æŸ¥è¯¢å¤±è´¥å¤„ç†</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> resp <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        ngx<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>ngx<span class=\"token punctuation\">.</span>ERR<span class=\"token punctuation\">,</span> <span class=\"token string\">\"æŸ¥è¯¢Rediså¤±è´¥: \"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">,</span> <span class=\"token string\">\", key = \"</span> <span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token comment\">-- å¾—åˆ°çš„æ•°æ®ä¸ºç©ºå¤„ç†</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token keyword\">if</span> resp <span class=\"token operator\">==</span> ngx<span class=\"token punctuation\">.</span>null <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        resp <span class=\"token operator\">=</span> <span class=\"token keyword\">nil</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        ngx<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>ngx<span class=\"token punctuation\">.</span>ERR<span class=\"token punctuation\">,</span> <span class=\"token string\">\"æŸ¥è¯¢Redisæ•°æ®ä¸ºç©º, key = \"</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token function\">close_redis</span><span class=\"token punctuation\">(</span>red<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token keyword\">return</span> resp</pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token comment\">-- å°è£…å‡½æ•°ï¼Œå‘é€ http è¯·æ±‚ï¼Œå¹¶è§£æå“åº”</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token keyword\">local</span> <span class=\"token keyword\">function</span> <span class=\"token function\">read_http</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">,</span> params<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token keyword\">local</span> resp <span class=\"token operator\">=</span> ngx<span class=\"token punctuation\">.</span>location<span class=\"token punctuation\">.</span><span class=\"token function\">capture</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">,</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        method <span class=\"token operator\">=</span> ngx<span class=\"token punctuation\">.</span>HTTP_GET<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        args <span class=\"token operator\">=</span> params<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> resp <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        <span class=\"token comment\">-- è®°å½•é”™è¯¯ä¿¡æ¯ï¼Œè¿”å› 404</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        ngx<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>ngx<span class=\"token punctuation\">.</span>ERR<span class=\"token punctuation\">,</span> <span class=\"token string\">\"http æŸ¥è¯¢å¤±è´¥äº†~, path: \"</span><span class=\"token punctuation\">,</span> path <span class=\"token punctuation\">,</span> <span class=\"token string\">\", args: \"</span><span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        ngx<span class=\"token punctuation\">.</span><span class=\"token function\">exit</span><span class=\"token punctuation\">(</span><span class=\"token number\">404</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    <span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token keyword\">return</span> resp<span class=\"token punctuation\">.</span>body</pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token comment\">-- å°†æ–¹æ³•å¯¼å‡º</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token keyword\">local</span> _M <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    read_http <span class=\"token operator\">=</span> read_http<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    read_redis <span class=\"token operator\">=</span> read_redis</pre></td></tr><tr><td data-num=\"58\"></td><td><pre><span class=\"token punctuation\">&#125;</span>  </pre></td></tr><tr><td data-num=\"59\"></td><td><pre><span class=\"token keyword\">return</span> _M</pre></td></tr></table></figure><p>åœ¨ item.lua æ–‡ä»¶ä¸­è¿›è¡Œå¯¼å…¥ redis å·¥å…·å‡½æ•°</p>\n<figure class=\"highlight lua\"><figcaption data-lang=\"lua\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">local</span> read_redis <span class=\"token operator\">=</span> common<span class=\"token punctuation\">.</span>read_redis</pre></td></tr></table></figure><p>ç”±äºæ·»åŠ äº† redis ç¼“å­˜é‚£ä¹ˆä¹‹å‰çš„æŸ¥è¯¢å•†å“ä¿¡æ¯å’Œåº“å­˜çš„å‡½æ•°å°±éœ€è¦ä¿®æ”¹äº†ã€‚</p>\n<p>ä½†æ˜¯éœ€è¦ä¿®æ”¹ä¸¤ä¸ªå¤ªéº»çƒ¦äº†æ‰€ä»¥å¯¹å…¶è¿›è¡Œå°è£…å‡½æ•°ï¼š</p>\n<p>éœ€æ±‚ï¼š</p>\n<p>1ã€ä¿®æ”¹ item.luaï¼Œå°è£…ä¸€ä¸ªå‡½æ•° read_dataï¼Œå®ç°å…ˆæŸ¥è¯¢ redisï¼Œå¦‚æœæœªå‘½ä¸­ï¼Œå†æŸ¥è¯¢ tomcat</p>\n<p>2ã€ä¿®æ”¹ item.luaï¼ŒæŸ¥è¯¢å•†å“å’Œåº“å­˜æ—¶éƒ½è°ƒç”¨ read_data è¿™ä¸ªå‡½æ•°</p>\n<figure class=\"highlight lua\"><figcaption data-lang=\"lua\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- å°è£…æŸ¥è¯¢å‡½æ•°ï¼Œå…ˆæŸ¥è¯¢ redisï¼Œå¦‚æœæœªå‘½ä¸­å†æŸ¥è¯¢ tomcat</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">local</span> <span class=\"token keyword\">function</span> <span class=\"token function\">read_data</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> path<span class=\"token punctuation\">,</span> params<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token comment\">-- æŸ¥è¯¢ redis</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token keyword\">local</span> resp <span class=\"token operator\">=</span> <span class=\"token function\">read_redis</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"192.168.249.128\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">6379</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token comment\">-- åˆ¤æ–­ redis æ˜¯å¦å‘½ä¸­</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> resp <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token comment\">-- redis æŸ¥è¯¢å¤±è´¥ï¼Œå†æŸ¥è¯¢ tomcat</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    resp <span class=\"token operator\">=</span> <span class=\"token function\">read_http</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">,</span> params<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token keyword\">return</span> resp</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">end</span></pre></td></tr></table></figure><p>ç¼–å†™å®Œå°è£…å‡½æ•°åå°†åŸæ¥çš„è¯·æ±‚å‡½æ•°è¿›è¡Œæ›¿æ¢</p>\n<figure class=\"highlight lua\"><figcaption data-lang=\"lua\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- æŸ¥è¯¢å•†å“ä¿¡æ¯</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">local</span> itemJSON <span class=\"token operator\">=</span> <span class=\"token function\">read_data</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"item:id:\"</span> <span class=\"token operator\">..</span> id<span class=\"token punctuation\">,</span> <span class=\"token string\">\"/item/\"</span> <span class=\"token operator\">..</span> id<span class=\"token punctuation\">,</span> <span class=\"token keyword\">nil</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">-- æŸ¥è¯¢åº“å­˜ä¿¡æ¯</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">local</span> stockJSON <span class=\"token operator\">=</span> <span class=\"token function\">read_data</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"item:stock:id:\"</span> <span class=\"token operator\">..</span> id<span class=\"token punctuation\">,</span> <span class=\"token string\">\"/item/stock/\"</span> <span class=\"token operator\">..</span> id<span class=\"token punctuation\">,</span> <span class=\"token keyword\">nil</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>item.lua æ–‡ä»¶çš„å®Œæ•´ä»£ç ï¼š</p>\n<figure class=\"highlight lua\"><figcaption data-lang=\"lua\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- å¯¼å…¥ common å‡½æ•°åº“</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">local</span> common <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'common'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">local</span> read_http <span class=\"token operator\">=</span> common<span class=\"token punctuation\">.</span>read_http</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">local</span> read_redis <span class=\"token operator\">=</span> common<span class=\"token punctuation\">.</span>read_redis</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">-- å¯¼å…¥ cjson åº“</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">local</span> cjson <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'cjson'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">-- å°è£…æŸ¥è¯¢å‡½æ•°ï¼Œå…ˆæŸ¥è¯¢ redisï¼Œå¦‚æœæœªå‘½ä¸­å†æŸ¥è¯¢ tomcat</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">local</span> <span class=\"token keyword\">function</span> <span class=\"token function\">read_data</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> path<span class=\"token punctuation\">,</span> params<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token comment\">-- æŸ¥è¯¢ redis</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token keyword\">local</span> resp <span class=\"token operator\">=</span> <span class=\"token function\">read_redis</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"192.168.249.128\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">6379</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token comment\">-- åˆ¤æ–­ redis æ˜¯å¦å‘½ä¸­</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> resp <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token comment\">-- redis æŸ¥è¯¢å¤±è´¥ï¼Œå†æŸ¥è¯¢ tomcat</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    ngx<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"redisæŸ¥è¯¢å¤±è´¥,å°è¯•æŸ¥è¯¢http, key :\"</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    resp <span class=\"token operator\">=</span> <span class=\"token function\">read_http</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">,</span> params<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token keyword\">return</span> resp</pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\">-- è·å–è·¯å¾„å‚æ•°</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token keyword\">local</span> id <span class=\"token operator\">=</span> ngx<span class=\"token punctuation\">.</span>var<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token comment\">-- æŸ¥è¯¢å•†å“ä¿¡æ¯</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token keyword\">local</span> itemJSON <span class=\"token operator\">=</span> <span class=\"token function\">read_data</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"item:id:\"</span> <span class=\"token operator\">..</span> id<span class=\"token punctuation\">,</span> <span class=\"token string\">\"/item/\"</span> <span class=\"token operator\">..</span> id<span class=\"token punctuation\">,</span> <span class=\"token keyword\">nil</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token comment\">-- æŸ¥è¯¢åº“å­˜ä¿¡æ¯</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token keyword\">local</span> stockJSON <span class=\"token operator\">=</span> <span class=\"token function\">read_data</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"item:stock:id:\"</span> <span class=\"token operator\">..</span> id<span class=\"token punctuation\">,</span> <span class=\"token string\">\"/item/stock/\"</span> <span class=\"token operator\">..</span> id<span class=\"token punctuation\">,</span> <span class=\"token keyword\">nil</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token comment\">-- JSON è½¬åŒ–ä¸º lua çš„ table</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token keyword\">local</span> item <span class=\"token operator\">=</span> cjson<span class=\"token punctuation\">.</span><span class=\"token function\">decode</span><span class=\"token punctuation\">(</span>itemJSON<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token keyword\">local</span> sto <span class=\"token operator\">=</span> cjson<span class=\"token punctuation\">.</span><span class=\"token function\">decode</span><span class=\"token punctuation\">(</span>stockJSON<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token comment\">-- ç»„åˆæ•°æ®</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>item<span class=\"token punctuation\">.</span>stock <span class=\"token operator\">=</span> sto<span class=\"token punctuation\">.</span>stock</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>item<span class=\"token punctuation\">.</span>sold <span class=\"token operator\">=</span> sto<span class=\"token punctuation\">.</span>sold</pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token comment\">-- æŠŠ item åºåˆ—åŒ–ä¸º json è¿”å›ç»“æœ</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>ngx<span class=\"token punctuation\">.</span><span class=\"token function\">say</span><span class=\"token punctuation\">(</span>cjson<span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>é‡å¯è™šæ‹Ÿæœºä¸­çš„ nginx</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@localhost nginx<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -s reload</span></pre></td></tr></table></figure><p>è®¿é—® uri è¿›è¡Œæµ‹è¯•ï¼š<a href=\"http://localhost/item.html?id=10002\">http://localhost/item.html?id=10002</a></p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310201603830.png\" alt=\"image-20231020160328617\"></p>\n<p>æŸ¥çœ‹ idea æ§åˆ¶å°</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310201603637.png\" alt=\"image-20231020160349587\"></p>\n<p>å°†æ§åˆ¶å°ä¿¡æ¯æ¸…ç©ºåå†æ¬¡è®¿é—® uriï¼š<a href=\"http://localhost/item.html?id=10002\">http://localhost/item.html?id=10002</a></p>\n<p>æ§åˆ¶å°æƒ…å†µ</p>\n<p>è¯´æ˜æ•°æ®å·²ç»è¢«ç¼“å­˜äº†</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310201604800.png\" alt=\"image-20231020160432732\"></p>\n<p>æˆ‘ä»¬æŠŠä¸¤ä¸ªæœåŠ¡å™¨å…¨å…³äº†</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310201605790.png\" alt=\"image-20231020160510420\"></p>\n<p>å†è®¿é—®ä¸€ä¸‹ uriï¼š<a href=\"http://localhost/item.html?id=10002\">http://localhost/item.html?id=10002</a></p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310201634990.png\" alt=\"image-20231020163445555\"></p>\n<p>å¯ä»¥çœ‹åˆ°å¦‚æœæ²¡æœ‰å¯åŠ¨ Tomcat ä¹Ÿæ²¡äº‹å„¿å› ä¸ºå…ˆå»çœ‹äº†ä¸‹ Redis å‘ç°æœ‰ç›¸å…³æ•°æ®ç›´æ¥æ‹¿æ¥å°±ä¸æ‰¾æœåŠ¡å™¨äº†ã€‚</p>\n<h2 id=\"66-nginxæœ¬åœ°ç¼“å­˜\"><a class=\"markdownIt-Anchor\" href=\"#66-nginxæœ¬åœ°ç¼“å­˜\">#</a> 6.6ã€Nginx æœ¬åœ°ç¼“å­˜ğŸŒ³</h2>\n<p>OPenResty ä¸º Nginx æä¾›äº† shard dict çš„åŠŸèƒ½ï¼Œå¯ä»¥åœ¨ Nginx çš„å¤šä¸ª worker ä¹‹é—´å…±äº«æ•°æ®ï¼Œå®ç°ç¼“å­˜åŠŸèƒ½ã€‚</p>\n<p>1ã€å¼€å¯å…±äº«å­—å…¸ï¼Œåœ¨ nginx.conf çš„ http ä¸‹æ·»åŠ é…ç½®</p>\n<figure class=\"highlight nginx\"><figcaption data-lang=\"nginx\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># å…±äº«å­—å…¸ï¼Œä¹Ÿå°±æ˜¯æœ¬åœ°ç¼“å­˜ï¼Œåç§°å«åšï¼šitem_cacheï¼Œå¤§å° 150m</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token directive\"><span class=\"token keyword\">lua_shared_dict</span> item_cache <span class=\"token number\">150m</span></span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>2ã€æ“ä½œå…±äº«å­—å…¸</p>\n<p>åœ¨ item.lua æ–‡ä»¶ä¸­å¯¼å…¥</p>\n<figure class=\"highlight lua\"><figcaption data-lang=\"lua\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- å¯¼å…¥å…±äº«è¯å…¸ï¼Œæœ¬åœ°ç¼“å­˜</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">local</span> item_cache <span class=\"token operator\">=</span> ngx<span class=\"token punctuation\">.</span>shared<span class=\"token punctuation\">.</span>item_cache</pre></td></tr></table></figure><h3 id=\"661-æ¡ˆä¾‹åœ¨æŸ¥è¯¢å•†å“æ—¶ä¼˜å…ˆæŸ¥è¯¢openrestyçš„æœ¬åœ°ç¼“å­˜\"><a class=\"markdownIt-Anchor\" href=\"#661-æ¡ˆä¾‹åœ¨æŸ¥è¯¢å•†å“æ—¶ä¼˜å…ˆæŸ¥è¯¢openrestyçš„æœ¬åœ°ç¼“å­˜\">#</a> 6.6.1ã€æ¡ˆä¾‹ï¼Œåœ¨æŸ¥è¯¢å•†å“æ—¶ï¼Œä¼˜å…ˆæŸ¥è¯¢ OPenResty çš„æœ¬åœ°ç¼“å­˜ğŸŒ²</h3>\n<p>éœ€æ±‚ï¼š</p>\n<p>1ã€ä¿®æ”¹ item.lua ä¸­çš„ read_data å‡½æ•°ï¼Œä¼˜å…ˆæŸ¥è¯¢æœ¬åœ°ç¼“å­˜ï¼Œæœªå‘½ä¸­æ—¶åœ¨æŸ¥è¯¢ Redisï¼ŒTomcat</p>\n<p>2ã€æŸ¥è¯¢ Redis æˆ– Tomcat æˆåŠŸåï¼Œå°†æ•°æ®å†™å…¥æœ¬åœ°ç¼“å­˜ï¼Œå¹¶è®¾ç½®æœ‰æ•ˆæœŸ</p>\n<p>3ã€å•†å“åŸºæœ¬ä¿¡æ¯ï¼Œæœ‰æ•ˆæœŸ 30 åˆ†é’Ÿ</p>\n<p>4ã€åº“å­˜ä¿¡æ¯ï¼Œæœ‰æ•ˆæœŸ 1 åˆ†é’Ÿ</p>\n<figure class=\"highlight lua\"><figcaption data-lang=\"lua\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- å°è£…æŸ¥è¯¢å‡½æ•°ï¼Œå…ˆæŸ¥è¯¢ redisï¼Œå¦‚æœæœªå‘½ä¸­å†æŸ¥è¯¢ tomcat</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">read_data</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> expire<span class=\"token punctuation\">,</span> path<span class=\"token punctuation\">,</span> params<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token comment\">-- æŸ¥è¯¢æœ¬åœ°ç¼“å­˜</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token keyword\">local</span> val <span class=\"token operator\">=</span> item_cache<span class=\"token punctuation\">:</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> val <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token comment\">-- æŸ¥è¯¢ redis</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    val <span class=\"token operator\">=</span> <span class=\"token function\">read_redis</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"192.168.249.128\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">6379</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token comment\">-- åˆ¤æ–­æŸ¥è¯¢ç»“æœ</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> val <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token comment\">-- redis æŸ¥è¯¢å¤±è´¥ï¼ŒæŸ¥è¯¢ tomcat</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        val <span class=\"token operator\">=</span> <span class=\"token function\">read_http</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">,</span> params<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token keyword\">end</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token comment\">-- æŸ¥è¯¢æˆåŠŸï¼ŒæŠŠæ•°æ®å†™å…¥æœ¬åœ°ç¼“å­˜</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  item_cache<span class=\"token punctuation\">:</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> val<span class=\"token punctuation\">,</span> expire<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token comment\">-- è¿”å›æ•°æ®</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token keyword\">return</span> val</pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token keyword\">end</span></pre></td></tr></table></figure><p>æµ‹è¯•</p>\n<p>åˆ‡æ¢åˆ° nginx ç›®å½•ä¸‹æ¥ç›‘æ§ error.log æ–‡ä»¶çš„æ‰“å°æƒ…å†µ</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@localhost nginx<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -s reload</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@localhost nginx<span class=\"token punctuation\">]</span><span class=\"token comment\"># pwd</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>/usr/local/openresty/nginx</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@localhost nginx<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -f logs/error.log</span></pre></td></tr></table></figure><h1 id=\"ä¸ƒ-ç¼“å­˜åŒæ­¥\"><a class=\"markdownIt-Anchor\" href=\"#ä¸ƒ-ç¼“å­˜åŒæ­¥\">#</a> ä¸ƒã€ç¼“å­˜åŒæ­¥ğŸ„</h1>\n<ul>\n<li>æ•°æ®åŒæ­¥ç­–ç•¥</li>\n<li>å®‰è£… Canal</li>\n<li>ç›‘å¬ Canal</li>\n</ul>\n<h2 id=\"71-æ•°æ®åŒæ­¥ç­–ç•¥\"><a class=\"markdownIt-Anchor\" href=\"#71-æ•°æ®åŒæ­¥ç­–ç•¥\">#</a> 7.1ã€æ•°æ®åŒæ­¥ç­–ç•¥ğŸŒ³</h2>\n<p>ç¼“å­˜æ•°æ®åŒæ­¥çš„å¸¸è§æ–¹å¼æœ‰ä¸‰ç§ï¼š</p>\n<p><mark>1ã€è®¾ç½®æœ‰æ•ˆæœŸ</mark>ï¼šç»™ç¼“å­˜è®¾ç½®æœ‰æ•ˆæœŸï¼Œåˆ°æœŸåè‡ªåŠ¨åˆ é™¤ã€‚å†æ¬¡æŸ¥è¯¢æ—¶æ›´æ–°</p>\n<p>1.1ã€ä¼˜åŠ¿ï¼šç®€å•ï¼Œæ–¹ä¾¿</p>\n<p>1.2ã€ç¼ºç‚¹ï¼šæ—¶æ•ˆæ€§å·®ï¼Œç¼“å­˜è¿‡æœŸä¹‹å‰å¯èƒ½ä¸ä¸€è‡´</p>\n<p>1.3ã€åœºæ™¯ï¼šæ›´æ–°é¢‘ç‡è¾ƒä½ï¼Œæ—¶æ•ˆæ€§è¦æ±‚ä½çš„ä¸šåŠ¡</p>\n<p><mark>2ã€åŒæ­¥åŒå†™</mark>ï¼šåœ¨ä¿®æ”¹æ•°æ®åº“çš„åŒæ—¶ï¼Œç›´æ¥ä¿®æ”¹ç¼“å­˜</p>\n<p>2.1ã€ä¼˜åŠ¿ï¼šæ—¶æ•ˆæ€§å¼ºï¼Œç¼“å­˜ä¸æ•°æ®åº“å¼ºä¸€è‡´</p>\n<p>2.2ã€ç¼ºç‚¹ï¼šæœ‰ä»£ç ä¾µå…¥ï¼Œè€¦åˆåº¦é«˜</p>\n<p>2.3ã€åœºæ™¯ï¼šå¯¹ä¸€è‡´æ€§ï¼Œæ—¶æ•ˆæ€§è¦æ±‚è¾ƒé«˜çš„ç¼“å­˜æ•°æ®</p>\n<p><mark>3ã€å¼‚æ­¥é€šçŸ¥</mark>ï¼šä¿®æ”¹æ•°æ®åº“æ—¶å‘é€äº‹ä»¶é€šçŸ¥ï¼Œç›¸å…³æœåŠ¡ç›‘å¬åˆ°é€šçŸ¥åä¿®æ”¹ç¼“å­˜æ•°æ®</p>\n<p>3.1ã€ä¼˜åŠ¿ï¼šä½è€¦åˆï¼Œå¯ä»¥åŒæ—¶é€šçŸ¥å¤šä¸ªç¼“å­˜æœåŠ¡</p>\n<p>3.2ã€ç¼ºç‚¹ï¼šæ—¶æ•ˆæ€§ä¸€èˆ¬ï¼Œå¯èƒ½å­˜åœ¨ç»ˆæçˆ±ä½ ä¸ä¸€è‡´çŠ¶æ€</p>\n<p>3.3ã€åœºæ™¯ï¼šæ—¶æ•ˆæ€§è¦æ±‚ä¸€èˆ¬ï¼Œæœ‰å¤šä¸ªæœåŠ¡éœ€è¦åŒæ­¥</p>\n<h3 id=\"711-ç¼“å­˜åŒæ­¥ç­–ç•¥\"><a class=\"markdownIt-Anchor\" href=\"#711-ç¼“å­˜åŒæ­¥ç­–ç•¥\">#</a> 7.1.1ã€ç¼“å­˜åŒæ­¥ç­–ç•¥ğŸŒ²</h3>\n<p>å¼‚æ­¥é€šçŸ¥å¯ä»¥ä½¿ç”¨åŸºäº MQ çš„å¼‚æ­¥é€šçŸ¥</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310210915149.png\" alt=\"image-20231021091552370\"></p>\n<p>ä½†æ˜¯åŸºäº MQ è¿˜æ˜¯è¦ä¿®æ”¹é‡Œé¢çš„ä»£ç å‘é€æ¶ˆæ¯ï¼Œè€Œä¸‹é¢è¦è®²çš„æ˜¯åŸºäº Canal çš„å¼‚æ­¥é€šçŸ¥</p>\n<p>åŸºäº Canal çš„å¼‚æ­¥é€šçŸ¥</p>\n<p>canal å¯ä»¥å»ç›‘å¬æ•°æ®åº“çš„å˜åŒ–</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310210917386.png\" alt=\"image-20231021091750935\"></p>\n<h3 id=\"712-åˆå§‹canal\"><a class=\"markdownIt-Anchor\" href=\"#712-åˆå§‹canal\">#</a> 7.1.2ã€åˆå§‹ CanalğŸŒ²</h3>\n<p>Canal æ„è¯‘ä¸º æ°´é“ / ç®¡é“ / æ²Ÿæ¸ ï¼ŒCanal æ˜¯é˜¿é‡Œå·´å·´æ——ä¸‹çš„ä¸€æ¬¾å¼€æºé¡¹ç›®ï¼ŒåŸºäº Java å¼€å‘ã€‚åŸºäºæ•°æ®åº“å¢é‡æ—¥å¿—è§£æï¼Œæä¾›å¢é‡æ•°æ®è®¢é˜… &amp; æ¶ˆè´¹ã€‚GiHub åœ°å€ï¼š<a href=\"https://github.com/alibaba/canal\">https://github.com/alibaba/canal</a></p>\n<p>Canal æ˜¯åŸºäº mysql çš„ä¸»ä»åŒæ­¥æ¥å®ç°çš„ï¼ŒMySQL ä¸»ä»åŒæ­¥çš„åŸç†å¦‚ä¸‹ï¼š</p>\n<p>master å°±æ˜¯ mysql çš„ä¸»èŠ‚ç‚¹ï¼Œslave å°±æ˜¯ mysql çš„ä»èŠ‚ç‚¹ã€‚ä¸»ä»æ•°æ®æ˜¯è¦åšåŒæ­¥çš„ï¼Œé‚£å®ƒæ€ä¹ˆåšåˆ°çš„å‘¢ï¼Ÿé¦–å…ˆ mysql çš„ä¸»èŠ‚ç‚¹åœ¨åšå¢åˆ æ”¹æŸ¥æ—¶å°±å›å»è®°å½•æ—¥å¿—åˆ° binary.log æ–‡ä»¶ä¸­è¿™ä¸ªæ–‡ä»¶ç§°ä¸ºäºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶ã€‚å…¶ä¸­è®°å½•çš„å°±æ˜¯ binary log eventsï¼Œé‡Œé¢è®°å½•çš„å°±æ˜¯ä¸šåŠ¡ sqlã€‚slave ä¼šå¼€å¯ä¸€ä¸ªçº¿ç¨‹ä¸æ–­çš„æ¥è¯»å–è¿™ä¸ªæ—¥å¿—æ–‡ä»¶æŠŠè¿™ä¸ªæ–‡ä»¶è¯»è¿‡æ¥æ”¾åˆ°ä¸€ä¸ª relay log æ–‡ä»¶ä¸­ã€‚è¿™æ ·ä¸»èŠ‚ç‚¹åšäº†å“ªäº› sql ä»èŠ‚ç‚¹ ä¹Ÿåšå“ªäº› sql</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310210922728.png\" alt=\"image-20231021092228657\"></p>\n<p>è€Œ Canal å°±æ˜¯æŠŠè‡ªå·±ä¼ªè£…æˆ MySQL çš„ä¸€ä¸ª Slave èŠ‚ç‚¹ï¼Œä»è€Œç›‘å¬ master çš„ binary log å˜åŒ–ã€‚å†æŠŠå¾—åˆ°çš„å˜åŒ–ä¿¡æ¯é€šçŸ¥ç»™ Canal çš„å®¢æˆ·ç«¯ï¼Œè¿›è€Œå®Œæˆå¯¹å…¶å®ƒæ•°æ®åº“çš„åŒæ­¥ã€‚</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310210929872.png\" alt=\"image-20231021092859461\"></p>\n<h3 id=\"713-canalå®‰è£…\"><a class=\"markdownIt-Anchor\" href=\"#713-canalå®‰è£…\">#</a> 7.1.3ã€Canal å®‰è£…ğŸŒ²</h3>\n<p>æŸ¥çœ‹æ–‡ç« ï¼š<a href=\"./Canal/%E5%AE%89%E8%A3%85Canal.md\">å®‰è£… Canal</a>.</p>\n<h3 id=\"714-canalå®¢æˆ·ç«¯\"><a class=\"markdownIt-Anchor\" href=\"#714-canalå®¢æˆ·ç«¯\">#</a> 7.1.4ã€Canal å®¢æˆ·ç«¯ğŸŒ²</h3>\n<p>Canal æä¾›äº†å„ç§è¯­è¨€çš„å®¢æˆ·ç«¯ï¼Œå½“ Canal ç›‘å¬åˆ° binlog å˜åŒ–æ—¶ï¼Œä¼šé€šçŸ¥ Canal çš„å®¢æˆ·ç«¯ã€‚ä¸è¿‡è¿™é‡Œæˆ‘ä»¬ä¼šä½¿ç”¨ Github ä¸Šçš„ç¬¬ä¸‰æ–¹å¼€æºçš„ canal-staterã€‚åœ°å€ï¼š<a href=\"https://github.com/NormanGyllenhaal/canal-client\">https://github.com/NormanGyllenhaal/canal-client</a></p>\n<p>å¼•å…¥ä¾èµ–ï¼š</p>\n<figure class=\"highlight xml\"><figcaption data-lang=\"XML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">></span></span>top.javatool<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">></span></span>canal-spring-boot-starter<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>version</span><span class=\"token punctuation\">></span></span>1.2.1-RELEASE<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>version</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">></span></span></pre></td></tr></table></figure><p>ç¼–å†™é…ç½®ï¼š</p>\n<figure class=\"highlight yml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">canal</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">destination</span><span class=\"token punctuation\">:</span> dkx1 <span class=\"token comment\"># canal å®ä¾‹åç§°ï¼Œè¦è·Ÿ canal-server è¿è¡Œæ—¶è®¾ç½®çš„ destiation ä¸€è‡´</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token key atrule\">server</span><span class=\"token punctuation\">:</span> 192.168.249.128<span class=\"token punctuation\">:</span><span class=\"token number\">11111</span> <span class=\"token comment\"># canal åœ°å€</span></pre></td></tr></table></figure><p>ç¼–å†™ç›‘å¬å™¨ï¼Œç›‘å¬ Canal æ¶ˆæ¯ï¼š</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// æŒ‡å®šè¦ç›‘å¬çš„è¡¨</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token annotation punctuation\">@CanalTable</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"tb_item\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token annotation punctuation\">@Component</span>                                    <span class=\"token comment\">// æŒ‡å®šè¡¨å…³è”çš„å®ä½“ç±»</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ItemHandler</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">EntryHandler</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Item</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   <span class=\"token comment\">// ä¸‹é¢ä¸‰ä¸ªé‡å†™æ–¹æ³•æ˜¯ï¼Œç›‘å¬åˆ°æ•°æ®åº“çš„å¢åˆ æ”¹çš„æ¶ˆæ¯çš„</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">insert</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Item</span> item<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token comment\">// å†™æ•°æ®åˆ° redis</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token comment\">// å†™æ•°æ®åˆ° jvm è¿›ç¨‹ç¼“å­˜</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token class-name\">EntryHandler</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">insert</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">update</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Item</span> before<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Item</span> after<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token comment\">// å†™æ•°æ®åˆ° redis</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token comment\">// å†™æ•°æ®åˆ° jvm è¿›ç¨‹ç¼“å­˜</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token class-name\">EntryHandler</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span>before<span class=\"token punctuation\">,</span> after<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">delete</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Item</span> item<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token comment\">// å†™æ•°æ®åˆ° redis</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token comment\">// å†™æ•°æ®åˆ° jvm è¿›ç¨‹ç¼“å­˜</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token class-name\">EntryHandler</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">delete</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>Canal æ¨é€ç»™ canal-client çš„æ˜¯è¢«ä¿®æ”¹çš„è¿™ä¸€è¡Œæ•°æ® (row) ï¼Œè€Œæˆ‘ä»¬å¼•å…¥çš„ canal-client åˆ™ä¼šå¸®æˆ‘ä»¬æŠŠè¡Œæ•°æ®å°è£…åˆ° item å®ä½“ç±»ä¸­ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­éœ€è¦çŸ¥é“æ•°æ®åº“ä¸å®ä½“çš„æ˜ å°„å…³ç³»ï¼Œè¦ç”¨åˆ° JPA çš„å‡ ä¸ªæ³¨è§£ï¼š</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Data</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token annotation punctuation\">@TableName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"tb_item\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Item</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token annotation punctuation\">@TableId</span><span class=\"token punctuation\">(</span>type <span class=\"token operator\">=</span> <span class=\"token class-name\">IdType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">AUTO</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token comment\">// æ ‡è®°è¡¨ä¸­çš„ id å­—æ®µ</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token annotation punctuation\">@Id</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">;</span><span class=\"token comment\">// å•†å“ id</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> å…¶å®ƒå­—æ®µ çœç•¥</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Date</span> updateTime<span class=\"token punctuation\">;</span><span class=\"token comment\">// æ›´æ–°æ—¶é—´</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token comment\">// @Transient æ ‡è®°ä¸å±äºè¡¨ä¸­çš„å­—æ®µ  å¿½ç•¥</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token annotation punctuation\">@TableField</span><span class=\"token punctuation\">(</span>exist <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token annotation punctuation\">@Transient</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Integer</span> stock<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token annotation punctuation\">@TableField</span><span class=\"token punctuation\">(</span>exist <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token annotation punctuation\">@Transient</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Integer</span> sold<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>ç¼–å†™ redis çš„ç¼“å­˜ç±» ï¼Œæ·»åŠ ä¸¤ä¸ªå‡½æ•°ï¼Œä¸€ä¸ªæ–°å¢æˆ–æ›´æ–°ï¼Œä¸€ä¸ªæ˜¯åˆ é™¤</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">saveItem</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Item</span> item<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      <span class=\"token class-name\">String</span> json <span class=\"token operator\">=</span> <span class=\"token constant\">MAPPER</span><span class=\"token punctuation\">.</span><span class=\"token function\">writeValueAsString</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      redisTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">opsForValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"item:id:\"</span> <span class=\"token operator\">+</span> item<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">JsonProcessingException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RuntimeException</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">deleteItemById</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   redisTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">delete</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"item:id:\"</span> <span class=\"token operator\">+</span> id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>å®šä¹‰å®Œ redis çš„ç¼“å­˜ç±»é‡Œé¢çš„å‡½æ•°åå†å›åˆ°ç¼–å†™ç›‘å¬å™¨çš„ç±»é‡Œé¢ç¼–å†™ä»£ç ï¼š</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@CanalTable</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"tb_item\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token annotation punctuation\">@Component</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ItemHandler</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">EntryHandler</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Item</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token annotation punctuation\">@Autowired</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">RedisHandler</span> redisHandler<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token annotation punctuation\">@Autowired</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Cache</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Item</span><span class=\"token punctuation\">></span></span> cache<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">insert</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Item</span> item<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token comment\">// å†™æ•°æ®åˆ° jvm è¿›ç¨‹ç¼“å­˜</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        cache<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token comment\">// å†™æ•°æ®åˆ° redis</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        redisHandler<span class=\"token punctuation\">.</span><span class=\"token function\">saveItem</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">update</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Item</span> before<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Item</span> after<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token comment\">// å†™æ•°æ®åˆ° jvm è¿›ç¨‹ç¼“å­˜</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        cache<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>after<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> after<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token comment\">// å†™æ•°æ®åˆ° redis</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        redisHandler<span class=\"token punctuation\">.</span><span class=\"token function\">saveItem</span><span class=\"token punctuation\">(</span>after<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token class-name\">EntryHandler</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span>before<span class=\"token punctuation\">,</span> after<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">delete</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Item</span> item<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token comment\">// å†™æ•°æ®åˆ° jvm è¿›ç¨‹ç¼“å­˜</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        cache<span class=\"token punctuation\">.</span><span class=\"token function\">invalidate</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token comment\">// å†™æ•°æ®åˆ° redis</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        redisHandler<span class=\"token punctuation\">.</span><span class=\"token function\">deleteItemById</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token class-name\">EntryHandler</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">delete</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>å¯åŠ¨æœåŠ¡æŸ¥çœ‹ idea æ‰“å°ä¿¡æ¯ï¼š</p>\n<pre><code>meters: 10005(Long)\n14:50:32:387 DEBUG 4956 --- [nio-8081-exec-7] c.h.i.mapper.ItemStockMapper.selectById  : &lt;==      Total: 1\n14:50:32:472  INFO 4956 --- [l-client-thread] t.j.c.client.client.AbstractCanalClient  : è·å–æ¶ˆæ¯ Message[id=-1,entries=[],raw=false,rawEntries=[]]\n14:50:34:474  INFO 4956 --- [l-client-thread] t.j.c.client.client.AbstractCanalClient  : è·å–æ¶ˆæ¯ Message[id=-1,entries=[],raw=false,rawEntries=[]]\n14:50:36:477  INFO 4956 --- [l-client-thread] t.j.c.client.client.AbstractCanalClient  : è·å–æ¶ˆæ¯ Message[id=-1,entries=[],raw=false,rawEntries=[]]\n14:50:38:478  INFO 4956 --- [l-client-thread] t.j.c.client.client.AbstractCanalClient  : è·å–æ¶ˆæ¯ Message[id=-1,entries=[],raw=false,rawEntries=[]]\n14:50:40:472  INFO 4956 --- [l-client-thread] t.j.c.client.client.AbstractCanalClient  : è·å–æ¶ˆæ¯ Message[id=-1,entries=[],raw=false,rawEntries=[]]\n</code></pre>\n<p>è¡¨ç¤º canal ä¸ java æˆåŠŸçš„è¿æ¥åˆ°äº†</p>\n<p>é‚£ä¹ˆæµ‹è¯•ä¸€ä¸‹æ•°æ®åŒæ­¥æ‰“å¼€ 8081 ç«¯å£çš„é¡µé¢</p>\n<p>æ¯”å¦‚è¯´ä¿®æ”¹ 10001 è¿™ä¸ªå•†å“çš„æ•°æ®ï¼š</p>\n<p>åŸæ¥çš„æ•°æ®å¦‚ä¸‹ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310211452116.png\" alt=\"image-20231021145237319\"></p>\n<p>ä¿®æ”¹åçš„æ•°æ®å¦‚ä¸‹ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310211453292.png\" alt=\"image-20231021145302067\"></p>\n<p>ç‚¹å‡»ç¡®å®š</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310211453164.png\" alt=\"image-20231021145357351\"></p>\n<p>å†æŸ¥çœ‹ idea çš„æ§åˆ¶å°ä¿¡æ¯ï¼š</p>\n<p>å¯ä»¥çœ‹åˆ°æ‰“å°äº†ä¸€å †æ—¥å¿—ä¿¡æ¯</p>\n<pre><code>  version: 1\n  logfileName: &quot;mysql-bin.000006&quot;\n  logfileOffset: 1173\n  serverId: 1000\n  serverenCode: &quot;UTF-8&quot;\n  executeTime: 1697871191000\n  sourceType: MYSQL\n  schemaName: &quot;&quot;\n  tableName: &quot;&quot;\n  eventLength: 91\n&#125;\nentryType: TRANSACTIONBEGIN\nstoreValue: &quot; H&quot;\n, header &#123;\n  version: 1\n  logfileName: &quot;mysql-bin.000006&quot;\n  logfileOffset: 1344\n  serverId: 1000\n  serverenCode: &quot;UTF-8&quot;\n  executeTime: 1697871191000\n  sourceType: MYSQL\n  schemaName: &quot;dkx&quot;\n  tableName: &quot;tb_item&quot;\n  eventLength: 620\n  eventType: UPDATE\n  props &#123;\n    key: &quot;rowsCount&quot;\n    value: &quot;1&quot;\n  &#125;\n&#125;\nentryType: ROWDATA\nstoreValue: &quot;\\b_\\020\\002P\\000b\\324\\n\\n&amp;\\b\\000\\020\\373\\377\\377\\377\\377\\377\\377\\377\\377\\001\\032\\002id \\001(\\0000\\000B\\00510001R\\006bigint\\nd\\b\\001\\020\\f\\032\\005title \\000(\\0000\\000BCRIMOWA 21\\345\\257\\270\\346\\211\\230\\350\\277\\220\\347\\256\\261\\346\\213\\211\\346\\235\\206\\347\\256\\261 SALSA AIR\\347\\263\\273\\345\\210\\227\\346\\236\\234\\347\\273\\277\\350\\211\\262 820.70.36.4R\\fvarchar(264)\\n)\\b\\002\\020\\f\\032\\004name \\000(\\0000\\000B\\tSALSA AIRR\\fvarchar(128)\\n)\\b\\003\\020\\373\\377\\377\\377\\377\\377\\377\\377\\377\\001\\032\\005price \\000(\\0000\\000B\\00516900R\\006bigint\\n\\226\\001\\b\\004\\020\\f\\032\\005image \\000(\\0000\\000Buhttps://m.360buyimg.com/mobilecms/s720x720_jfs/t6934/364/1195375010/84676/e9f2c55f/597ece38N0ddcbc77.jpg!q70.jpg.webpR\\fvarchar(200)\\n-\\b\\005\\020\\f\\032\\bcategory \\000(\\0000\\000B\\t\\346\\213\\211\\346\\235\\206\\347\\256\\261R\\fvarchar(200)\\n\\'\\b\\006\\020\\f\\032\\005brand \\000(\\0000\\000B\\006RIMOWAR\\fvarchar(100)\\nG\\b\\a\\020\\f\\032\\004spec \\000(\\0000\\000B\\'&#123;\\&quot;\\351\\242\\234\\350\\211\\262\\&quot;: \\&quot;\\347\\272\\242\\350\\211\\262\\&quot;, \\&quot;\\345\\260\\272\\347\\240\\201\\&quot;: \\&quot;26\\345\\257\\270\\&quot;&#125;R\\fvarchar(200)\\n\\032\\b\\b\\020\\004\\032\\006status \\000(\\0000\\000B\\0011R\\003int\\n6\\b\\t\\020]\\032\\vcreate_time \\000(\\0000\\000B\\0232019-05-01 00:00:00R\\bdatetime\\n6\\b\\n\\020]\\032\\vupdate_time \\000(\\0000\\000B\\0232019-05-01 00:00:00R\\bdatetime\\022&amp;\\b\\000\\020\\373\\377\\377\\377\\377\\377\\377\\377\\377\\001\\032\\002id \\001(\\0000\\000B\\00510001R\\006bigint\\022d\\b\\001\\020\\f\\032\\005title \\000(\\0000\\000BCRIMOWA 21\\345\\257\\270\\346\\211\\230\\350\\277\\220\\347\\256\\261\\346\\213\\211\\346\\235\\206\\347\\256\\261 SALSA AIR\\347\\263\\273\\345\\210\\227\\346\\236\\234\\347\\273\\277\\350\\211\\262 820.70.36.4R\\fvarchar(264)\\022)\\b\\002\\020\\f\\032\\004name \\000(\\0000\\000B\\tSALSA AIRR\\fvarchar(128)\\022)\\b\\003\\020\\373\\377\\377\\377\\377\\377\\377\\377\\377\\001\\032\\005price \\000(\\0010\\000B\\00528900R\\006bigint\\022\\226\\001\\b\\004\\020\\f\\032\\005image \\000(\\0000\\000Buhttps://m.360buyimg.com/mobilecms/s720x720_jfs/t6934/364/1195375010/84676/e9f2c55f/597ece38N0ddcbc77.jpg!q70.jpg.webpR\\fvarchar(200)\\022-\\b\\005\\020\\f\\032\\bcategory \\000(\\0000\\000B\\t\\346\\213\\211\\346\\235\\206\\347\\256\\261R\\fvarchar(200)\\022\\'\\b\\006\\020\\f\\032\\005brand \\000(\\0000\\000B\\006RIMOWAR\\fvarchar(100)\\022G\\b\\a\\020\\f\\032\\004spec \\000(\\0010\\000B\\'&#123;\\&quot;\\351\\242\\234\\350\\211\\262\\&quot;: \\&quot;\\347\\272\\242\\350\\211\\262\\&quot;, \\&quot;\\345\\260\\272\\347\\240\\201\\&quot;: \\&quot;33\\345\\257\\270\\&quot;&#125;R\\fvarchar(200)\\022\\032\\b\\b\\020\\004\\032\\006status \\000(\\0000\\000B\\0011R\\003int\\0226\\b\\t\\020]\\032\\vcreate_time \\000(\\0000\\000B\\0232019-05-01 00:00:00R\\bdatetime\\0226\\b\\n\\020]\\032\\vupdate_time \\000(\\0000\\000B\\0232019-05-01 00:00:00R\\bdatetime&quot;\n],raw=false,rawEntries=[]]\n</code></pre>\n<p>æˆ‘ä»¬å†å»è®¿é—®å•†å“æ•°æ®çš„å±•ç¤ºé¡µé¢æŸ¥çœ‹æ•°æ®æ˜¯å¦è¢«ä¿®æ”¹äº†</p>\n<p>è®¿é—® uriï¼š<a href=\"http://localhost/item.html?id=10001#index\">http://localhost/item.html?id=10001#index</a></p>\n<p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªé¡µé¢çš„æ•°æ®ä¹Ÿè¢«ä¿®æ”¹äº†è¯´æ˜ç¼“å­˜åŒæ­¥æˆåŠŸäº†</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310211504526.png\" alt=\"image-20231021150447258\"></p>\n<h1 id=\"å…«-æ€»ç»“å¤šçº§ç¼“å­˜æ¶æ„\"><a class=\"markdownIt-Anchor\" href=\"#å…«-æ€»ç»“å¤šçº§ç¼“å­˜æ¶æ„\">#</a> å…«ã€æ€»ç»“å¤šçº§ç¼“å­˜æ¶æ„ğŸ„</h1>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310211510207.png\" alt=\"image-20231021151019996\"></p>\n<p>æœ‰ä¸€ä¸ªé¡µé¢å« item.html æ”¾åˆ°äº† windows çš„ nginx æœåŠ¡å™¨ä¸Šã€‚å®ƒçš„ ä¸»è¦ä½œç”¨å°±æ˜¯ä¸€ä¸ªé™æ€èµ„æºæœåŠ¡å™¨å’Œåå‘ä»£ç†æœåŠ¡å™¨ã€‚å½“ç”¨æˆ·é€šè¿‡æµè§ˆå™¨æ¥è¯·æ±‚å®ƒæ—¶å®ƒå°±å¯ä»¥æŠŠé¡µé¢è¿”å›ç»™ç”¨æˆ·è€Œæµè§ˆå™¨åœ¨æ¸²æŸ“æ—¶å‘ç°ç¼ºå°‘æ•°æ®å°±ä¼šå‘é€ ajax è¯·æ±‚æ¥æŸ¥è¯¢æ•°æ®ã€‚æŸ¥è¯¢åœ°å€å°±æ˜¯ item/10001 è¿™æ—¶çš„ nginx åå‘ä»£ç†æœåŠ¡å™¨ä¸å›å»å¤„ç†ä¸šåŠ¡ï¼Œåªæ˜¯åšåå‘ä»£ç†ï¼Œæ‰€ä»¥å®ƒä¼šæŠŠè¯·æ±‚ä»£ç†ç»™ OPenResty é›†ç¾¤ï¼Œæƒ³è¦å»æŸ¥è¯¢æ•°æ®åˆæœ‰å…ˆå»æœ¬åœ°å¦‚æœæœ‰åˆ™ç›´æ¥è¿”å›ï¼Œæœ¬åœ°å…±äº«è¯å…¸æ•°æ®åªèƒ½åœ¨å½“å‰ nginx ä¸­ä½¿ç”¨ã€‚å¦‚æœæˆ‘ä»¬éƒ¨ç½²æˆ OPenResty é›†ç¾¤å®ƒä»¬ä¹‹é—´çš„å†…å­˜æ˜¯ä¸å…±äº«çš„ï¼Œæ‰€ä»¥è¿™é‡Œä¹Ÿå¯ä»¥é‡‡ç”¨é€šè¿‡ id è®¡ç®— hash æ¥è·¯ç”±æŒ‡å®šé›†ç¾¤æœåŠ¡å™¨çš„æ–¹å¼è¿™æ ·å°±ä¼šä¿è¯ OPenResty ç¼“å­˜ä¸€ç›´ç”Ÿæ•ˆã€‚æœ¬åœ°ç¼“å­˜å¦‚æœæœªå‘½ä¸­åˆ™å»æŸ¥è¯¢ redis ç¼“å­˜ï¼Œå‘½ä¸­åˆ™è¿”å›ï¼Œæœªå‘½ä¸­åˆ™æŸ¥è¯¢ tomcatã€‚æŸ¥è¯¢ tomcat ä¹Ÿæ˜¯é›†ç¾¤ä¹Ÿåšäº† jvm è¿›ç¨‹ç¼“å­˜ï¼Œtomcat æœåŠ¡å™¨ä¹‹é—´æ˜¯ä¸å…±äº«å†…å­˜çš„æ‰€ä»¥è¿˜éœ€è¦ä½¿ç”¨é€šè¿‡ id è®¡ç®— hash å€¼çš„æ–¹å¼æ¥è·¯ç”±æŒ‡å®š tomcat æœåŠ¡å™¨</p>\n<p>é‚£ä¹ˆå¤šçº§ç¼“å­˜å®Œæˆåå°±ä¼šé¢ä¸´ä¸€ä¸ªé—®é¢˜å°±æ˜¯æ•°æ®åŒæ­¥çš„é—®é¢˜ã€‚</p>\n<p>mysql çš„æ•°æ®è¿›è¡Œäº†ä¿®æ”¹ redis å’Œ tomcat è¿›ç¨‹ç¼“å­˜å’Œ nginx ç¼“å­˜éƒ½éœ€è¦åšåŒæ­¥</p>\n<p>åœ¨ OPenResty ä¸­ä½¿ç”¨çš„è¶…æ—¶åŒæ­¥ï¼Œè®¾ç½®è¿‡æœŸæ—¶é—´è¿‡æœŸè‡ªåŠ¨åˆ é™¤å°±å˜æˆæ–°æ•°æ®äº†ï¼Œè¿™ç§æ–¹å¼é€‚åˆäºæ›´æ–°é¢‘ç‡è¾ƒä½çš„æ•°æ®</p>\n<p>è€Œ redis ä¸ mysql ä¹‹é—´çš„æ•°æ®åŒæ­¥é‡‡ç”¨äº† canal ç›‘å¬ mysql çš„æ–¹å¼</p>\n<h1 id=\"ä¹-æœåŠ¡å¼‚æ­¥é€šè®¯\"><a class=\"markdownIt-Anchor\" href=\"#ä¹-æœåŠ¡å¼‚æ­¥é€šè®¯\">#</a> ä¹ã€æœåŠ¡å¼‚æ­¥é€šè®¯ğŸ„</h1>\n<p>é«˜çº§ç¯‡ - rabbitmq çš„é«˜çº§ç‰¹æ€§</p>\n<p>æˆ‘ä»¬å·²ç»å­¦ä¹ è¿‡å®ƒçš„åŸºæœ¬ç”¨æ³•äº†ï¼Œå­¦ä¹ äº†å¦‚ä½•åˆ©ç”¨ springamqp æ”¶å’Œå‘æ¶ˆæ¯ï¼Œä½†æ˜¯æ”¶å’Œå‘æ¶ˆæ¯åªæ˜¯ mq çš„æœ€åŸºæœ¬çš„åŠŸèƒ½ã€‚å› ä¸ºåœ¨æ”¶å’Œå‘æ¶ˆæ¯çš„è¿‡ç¨‹å½“ä¸­è¿˜æœ‰å¾ˆå¤šé—®é¢˜éœ€è¦æ€è€ƒéœ€è¦å»è§£å†³è¿™æ—¶å°±éœ€è¦ä½¿ç”¨ mq çš„é«˜çº§ç‰¹æ€§å»è§£å†³äº†</p>\n<p>MQ çš„ä¸€äº›å¸¸è§é—®é¢˜</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310211532979.png\" alt=\"image-20231021153238893\"></p>\n<p>å­¦ä¹ å†…å®¹ï¼š</p>\n<ul>\n<li>æ¶ˆæ¯å¯é æ€§</li>\n<li>æ­»ä¿¡äº¤æ¢æœº</li>\n<li>æƒ°æ€§é˜Ÿåˆ—</li>\n<li>MQ é›†ç¾¤</li>\n</ul>\n<h2 id=\"91-æ¶ˆæ¯å¯é æ€§é—®é¢˜\"><a class=\"markdownIt-Anchor\" href=\"#91-æ¶ˆæ¯å¯é æ€§é—®é¢˜\">#</a> 9.1ã€æ¶ˆæ¯å¯é æ€§é—®é¢˜ğŸŒ³</h2>\n<p>æ¶ˆæ¯ä»ç”Ÿäº§è€…å‘é€åˆ° exchangeï¼Œå†åˆ° queueï¼Œå†åˆ°æ¶ˆè´¹è€…ï¼Œæœ‰å“ªäº›å¯¼è‡´æ¶ˆæ¯ä¸¢å¤±çš„å¯èƒ½æ€§ï¼Ÿ</p>\n<p>å…ˆæ¥æ¸©ä¹ ä¸€ä¸‹ mq çš„æ•´ä¸ªæµç¨‹</p>\n<p>æ¶ˆæ¯çš„å‘é€è€…ç§°ä¸º publisherï¼Œå®ƒæŠŠæ¶ˆæ¯æŠ•é€’ç»™äº¤æ¢æœº exchangeï¼Œè€Œäº¤æ¢æœºä¼šæ ¹æ® routingkey å°†æ¶ˆæ¯è·¯ç”±åˆ°é˜Ÿåˆ— queue ä¸­ï¼Œè€Œé˜Ÿåˆ—å†æŠŠæ¶ˆæ¯æŠ•é€’ç»™æ¶ˆè´¹è€… consumer</p>\n<p>åœ¨æ•´ä¸ªè¿™æ ·çš„æµç¨‹å½“ä¸­æ¶ˆæ¯å¯èƒ½ä¼šå‘ç”Ÿä¸¢å¤±</p>\n<ul>\n<li>å‘é€æ—¶ä¸¢å¤±ï¼š\n<ul>\n<li>ç”Ÿäº§è€…å‘é€çš„æ¶ˆæ¯æœªé€è¾¾ exchange</li>\n<li>æ¶ˆæ¯åˆ°è¾¾ exchange åæœªè¾¾åˆ° queue</li>\n</ul>\n</li>\n<li>MQ å®•æœºï¼Œqueue å°†æ¶ˆæ¯ä¸¢å¤±</li>\n<li>consumer æ¥æ”¶åˆ°æ¶ˆæ¯åæœªæ¶ˆæ¯å°±å®•æœº</li>\n</ul>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310211536652.png\" alt=\"image-20231021153606449\"></p>\n<p>é’ˆå¯¹ä¸Šè¿°é—®é¢˜æˆ‘ä»¬æ¥å­¦ä¹ å¦‚ä¸‹å†…å®¹ï¼š</p>\n<ul>\n<li>ç”Ÿäº§è€…æ¶ˆæ¯ç¡®è®¤</li>\n<li>æ¶ˆæ¯æŒä¹…åŒ–</li>\n<li>æ¶ˆè´¹è€…æ¶ˆæ¯ç¡®è®¤</li>\n<li>æ¶ˆè´¹å¤±è´¥é‡è¯•æœºåˆ¶</li>\n</ul>\n<h3 id=\"911-ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶\"><a class=\"markdownIt-Anchor\" href=\"#911-ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶\">#</a> 9.1.1ã€ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶ğŸŒ²</h3>\n<p>RabbitMQ æä¾›äº† publisher confirm æœºåˆ¶æ¥é¿å…æ¶ˆæ¯å‘é€åˆ° MQ è¿‡ç¨‹ä¸­ä¸¢å¤±ã€‚æ¶ˆæ¯å‘é€åˆ° MQ ä»¥åï¼Œä¼šè¿”å›ä¸€ä¸ªç»“æœç»™å‘é€è€…ï¼Œè¡¨ç¤ºæ¶ˆæ¯æ˜¯å¦å¤„ç†æˆåŠŸã€‚ç»“æœæœ‰ä¸¤ç§è¯·æ±‚ï¼š</p>\n<ul>\n<li>publisher-confirmï¼Œå‘é€è€…ç¡®è®¤\n<ul>\n<li>æ¶ˆæ¯æˆåŠŸæŠ•é€’åˆ°äº¤æ¢æœºï¼Œè¿”å› ack</li>\n<li>æ¶ˆæ¯æœªæŠ•é€’åˆ°äº¤æ¢æœºï¼Œè¿”å› nack</li>\n</ul>\n</li>\n<li>publisher-returnï¼Œå‘é€è€…å›æ‰§\n<ul>\n<li>æ¶ˆæ¯æŠ•é€’åˆ°äº¤æ¢æœºäº†ï¼Œä½†æ˜¯æ²¡æœ‰è·¯ç”±åˆ°é˜Ÿåˆ—ã€‚è¿”å› ACKï¼ŒåŠè·¯ç”±å¤±è´¥åŸå› ã€‚</li>\n</ul>\n</li>\n</ul>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310211546864.png\" alt=\"image-20231021154614145\"></p>\n<blockquote>\n<p><font color='red'>æ³¨æ„</font>ï¼š</p>\n<p>ç¡®è®¤æœºåˆ¶å‘é€æ¶ˆæ¯æ—¶ï¼Œéœ€è¦ç»™æ¯ä¸ªæ¶ˆæ¯è®¾ç½®ä¸€ä¸ªå…¨å±€å”¯ä¸€ idï¼Œä»¥åŒºåˆ†ä¸åŒæ¶ˆæ¯ï¼Œé¿å… ack å†²çª</p>\n</blockquote>\n<p>å¼•å…¥ demo å·¥ç¨‹</p>\n<p>é¦–å…ˆï¼Œéœ€è¦å¼•å…¥é¡¹ç›®ï¼š<a href=\"https://gitee.com/doukaixin/typora.git\">https://gitee.com/doukaixin/typora.git</a></p>\n<p>æ‹‰å–åˆ†æ”¯ï¼šmq-advanced-demo ä»£ç æ¼”ç¤º</p>\n<h2 id=\"92-springamqpå®ç°ç”Ÿäº§è€…ç¡®è®¤\"><a class=\"markdownIt-Anchor\" href=\"#92-springamqpå®ç°ç”Ÿäº§è€…ç¡®è®¤\">#</a> 9.2ã€SpringAMQP å®ç°ç”Ÿäº§è€…ç¡®è®¤ğŸŒ³</h2>\n<p>1ã€åœ¨ publisher è¿™ä¸ªå¾®æœåŠ¡çš„ applicaiton.yml ä¸­æ·»åŠ é…ç½®ï¼š</p>\n<figure class=\"highlight yml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">rabbitmq</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token key atrule\">host</span><span class=\"token punctuation\">:</span> 192.168.249.128 <span class=\"token comment\"># rabbitMQ çš„ ip åœ°å€</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5672</span> <span class=\"token comment\"># ç«¯å£</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token key atrule\">username</span><span class=\"token punctuation\">:</span> itcast</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token key atrule\">password</span><span class=\"token punctuation\">:</span> <span class=\"token number\">123321</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token key atrule\">virtual-host</span><span class=\"token punctuation\">:</span> /</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token comment\">#------------------------------------</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token key atrule\">publisher-confirm-type</span><span class=\"token punctuation\">:</span> correlated</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token key atrule\">publisher-returns</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token key atrule\">mandatory</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span></pre></td></tr></table></figure><p>é…ç½®è¯´æ˜ï¼š</p>\n<ul>\n<li>publishe-confirm-typeï¼šå¼€å¯ publisher-confirmï¼Œè¿™é‡Œæ”¯æŒä¸¤ç§ç±»å‹ï¼š\n<ul>\n<li>simpleï¼šåŒæ­¥ç­‰å¾… confirm ç»“æœï¼Œç›´åˆ°è¶…æ—¶</li>\n<li>correlatedï¼šå¼‚æ­¥å›è°ƒï¼Œå®šä¹‰ ConfirmCallbackï¼ŒMQ è¿”å›ç»“æœæ—¶ä¼šå›è°ƒè¿™ä¸ª ConfirmCallback</li>\n</ul>\n</li>\n<li>publish-returnsï¼šå¼€å¯ publish-return åŠŸèƒ½ï¼ŒåŒæ ·æ˜¯åŸºäº callback æœºåˆ¶ï¼Œä¸è¿‡æ˜¯å®šä¹‰ ReturnCallback</li>\n<li>template.mandatoryï¼šå®šä¹‰æ¶ˆæ¯è·¯ç”±å¤±è´¥æ—¶çš„ç­–ç•¥ã€‚trueï¼Œåˆ™è°ƒç”¨ ReturnCallback; falseï¼šåˆ™ç›´æ¥ä¸¢å¼ƒæ¶ˆæ¯</li>\n</ul>\n<p>2ã€æ¯ä¸ª RabbitTemplate åªèƒ½é…ç½®ä¸€ä¸ª ReturnCallbackï¼Œå› æ­¤éœ€è¦åœ¨é¡¹ç›®å¯åŠ¨è¿‡ç¨‹ä¸­é…ç½®ï¼š</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Slf4j</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token annotation punctuation\">@Configuration</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">//                         å®ç° Spring å·¥å‚çš„é€šçŸ¥</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CommonConfig</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">ApplicationContextAware</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token comment\">// é‡å†™ Bean å·¥å‚å‡†å¤‡å¥½åè°ƒç”¨çš„å‡½æ•°</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">setApplicationContext</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ApplicationContext</span> applicationContext<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">BeansException</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token comment\">// å–å‡º RabbitTempalte çš„ Bean</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token class-name\">RabbitTemplate</span> rabbitTemplate <span class=\"token operator\">=</span> applicationContext<span class=\"token punctuation\">.</span><span class=\"token function\">getBean</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">RabbitTemplate</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token comment\">// é…ç½® ReturnCallback</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        rabbitTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">setReturnCallback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">,</span> s<span class=\"token punctuation\">,</span> s1<span class=\"token punctuation\">,</span> s2<span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            <span class=\"token comment\">// è®°å½•æ—¥å¿— &#123;&#125; ä¸ºå ä½ç¬¦</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            log<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"æ¶ˆæ¯å‘é€åˆ°é˜Ÿåˆ—å¤±è´¥ï¼Œå“åº”ç ï¼š&#123;&#125;ï¼Œå¤±è´¥åŸå› ï¼š&#123;&#125;ï¼Œ\"</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                    <span class=\"token string\">\"äº¤æ¢æœºï¼š&#123;&#125;ï¼Œè·¯ç”±keyï¼š&#123;&#125;ï¼Œæ¶ˆæ¯ï¼š&#123;&#125;\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                    i<span class=\"token punctuation\">,</span> s<span class=\"token punctuation\">,</span> s1<span class=\"token punctuation\">,</span> s2<span class=\"token punctuation\">,</span> message<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token comment\">// å¦‚æœæœ‰éœ€è¦çš„è¯ï¼Œé‡å‘æ¶ˆæ¯</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>returncallback æ˜¯ exchange è·¯ç”±ä¸åˆ° queue æ—¶ï¼Œæ‰è§¦å‘çš„å›è°ƒ</p>\n<p>confirmcallback æ˜¯åœ¨æ¶ˆæ¯è¾¾ä¸åˆ°äº¤æ¢æœºæ—¶ï¼Œæ‰å›è°ƒ</p>\n<p>3ã€å‘é€æ¶ˆæ¯ï¼ŒæŒ‡å®šæ¶ˆæ¯ IDï¼Œæ¶ˆæ¯ ConfirmCallback</p>\n<p>å…ˆä½¿ç”¨ test ä»£ç è¿›è¡Œä¸€ä¸‹æµ‹è¯•</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310211718275.png\" alt=\"image-20231021171827222\"></p>\n<p>å‘é€æ¶ˆæ¯çš„ä»£ç ä¸­ï¼Œæœ‰ äº¤æ¢æœºï¼Œä½†æ˜¯ Routingkey ä¸å­˜åœ¨ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å»åˆ›å»ºä¸€ä¸‹</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310211719943.png\" alt=\"image-20231021171807188\"></p>\n<p>ç‚¹å‡» bind</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310211719018.png\" alt=\"image-20231021171942977\"></p>\n<p>ä½†æ˜¯ï¼åœ¨å‘é€æ¶ˆæ¯çš„æµ‹è¯•ä»£ç ä¸­ä»¥å‰æ˜¯é‚£æ ·å†™çš„ï¼Œä½†æ˜¯ç°åœ¨è¦åšæ¶ˆæ¯ç¡®è®¤æœºåˆ¶æ‰€ä»¥å°±è¦å¤šä¼ é€’ä¸€ä¸ªå‚æ•°äº†</p>\n<p>æµ‹è¯•ä»£ç ï¼š</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Slf4j</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token annotation punctuation\">@RunWith</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SpringRunner</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token annotation punctuation\">@SpringBootTest</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">SpringAmqpTest</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token annotation punctuation\">@Autowired</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">RabbitTemplate</span> rabbitTemplate<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token annotation punctuation\">@Test</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">testSendMessage2SimpleQueue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token class-name\">String</span> routingKey <span class=\"token operator\">=</span> <span class=\"token string\">\"simple.test\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token comment\">// 1. å‡†å¤‡æ¶ˆæ¯</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token class-name\">String</span> message <span class=\"token operator\">=</span> <span class=\"token string\">\"hello, spring amqp!\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token comment\">// 1.1. å‡†å¤‡ CorrelationData</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token comment\">// 1.2. æ¶ˆæ¯ ID</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token class-name\">CorrelationData</span> correlationData <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">CorrelationData</span><span class=\"token punctuation\">(</span><span class=\"token constant\">UUID</span><span class=\"token punctuation\">.</span><span class=\"token function\">randomUUID</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token comment\">// 1.3. å‡†å¤‡ ConfirmCallback</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token comment\">// æˆåŠŸçš„å›è°ƒå‡½æ•°</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        correlationData<span class=\"token punctuation\">.</span><span class=\"token function\">getFuture</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">addCallback</span><span class=\"token punctuation\">(</span>confirm <span class=\"token operator\">-></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            <span class=\"token comment\">// åˆ¤æ–­ç»“æœ</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>confirm<span class=\"token punctuation\">.</span><span class=\"token function\">isAck</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                <span class=\"token comment\">// ACK</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                log<span class=\"token punctuation\">.</span><span class=\"token function\">debug</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"æ¶ˆæ¯æˆåŠŸæŠ•é€’åˆ°äº¤æ¢æœº ï¼æ¶ˆæ¯ID: &#123;&#125;\"</span><span class=\"token punctuation\">,</span> correlationData<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                <span class=\"token comment\">// NACK</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                log<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"æ¶ˆæ¯æŠ•é€’åˆ°äº¤æ¢æœºå¤±è´¥äº† ï¼ æ¶ˆæ¯ID: &#123;&#125;\"</span><span class=\"token punctuation\">,</span> correlationData<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                <span class=\"token comment\">// é‡å‘æ¶ˆæ¯</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            <span class=\"token comment\">// å¤±è´¥çš„å›è°ƒå‡½æ•°</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> throwable <span class=\"token operator\">-></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            <span class=\"token comment\">// è®°å½•æ—¥å¿—</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>            log<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"æ¶ˆæ¯å‘é€å¤±è´¥ ! \"</span><span class=\"token punctuation\">,</span> throwable<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            <span class=\"token comment\">// é‡å‘æ¶ˆæ¯</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        <span class=\"token comment\">// 2. å‘é€æ¶ˆæ¯</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        rabbitTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">convertAndSend</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"amq.topic\"</span><span class=\"token punctuation\">,</span> routingKey<span class=\"token punctuation\">,</span> message<span class=\"token punctuation\">,</span>correlationData <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>è¿è¡Œè¿™ä¸ªæµ‹è¯•ä»£ç </p>\n<p>idea æ§åˆ¶å°æ‰“å°ä¿¡æ¯å¦‚ä¸‹ï¼š</p>\n<pre><code>æ¶ˆæ¯æˆåŠŸæŠ•é€’åˆ°äº¤æ¢æœº ï¼æ¶ˆæ¯ID: a4abf2f4-85f5-4fdc-bb73-7be9ab91b6bd\n</code></pre>\n<p>æŸ¥çœ‹æ¶ˆæ¯é˜Ÿåˆ—æ˜¯å¦æ¥å—åˆ°äº†ä¸€ä¸ªæ¶ˆæ¯å¹¶æŸ¥çœ‹å†…å®¹</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310211737447.png\" alt=\"image-20231021173713091\"></p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310211737796.png\" alt=\"image-20231021173730615\"></p>\n<blockquote>\n<p><strong>æ€»ç»“</strong>ï¼š</p>\n<p>SpringAMQP ä¸­å¤„ç†æ¶ˆæ¯ç¡®è®¤çš„å‡ ç§æƒ…å†µï¼š</p>\n<ul>\n<li>publisher-confirm\n<ul>\n<li>æ¶ˆæ¯æˆåŠŸå‘é€åˆ° exchangeï¼Œè¿”å› ack</li>\n<li>æ¶ˆæ¯å‘é€å¤±è´¥ï¼Œæ²¡æœ‰åˆ°è¾¾äº¤æ¢æœºï¼Œè¿”å› nack</li>\n<li>æ¶ˆæ¯å‘é€è¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸ï¼Œæ²¡æœ‰æ”¶åˆ°å›æ‰§</li>\n</ul>\n</li>\n<li>æ¶ˆæ¯æˆåŠŸå‘é€åˆ° exchangeï¼Œä½†æ²¡æœ‰è·¯ç”±åˆ° queue\n<ul>\n<li>è°ƒç”¨ ReturnCallback</li>\n</ul>\n</li>\n</ul>\n</blockquote>\n<p>ä»¥ä¸Šå°±æ˜¯ç”Ÿäº§ç¡®è®¤çš„æœºåˆ¶äº†ã€‚é€šè¿‡è¿™äº›æœºåˆ¶å°±èƒ½å¤Ÿç¡®è®¤æ¶ˆæ¯ èƒ½å¤Ÿåˆ°è¾¾æ¶ˆæ¯é˜Ÿåˆ—</p>\n<h2 id=\"93-æ¶ˆæ¯æŒä¹…åŒ–\"><a class=\"markdownIt-Anchor\" href=\"#93-æ¶ˆæ¯æŒä¹…åŒ–\">#</a> 9.3ã€æ¶ˆæ¯æŒä¹…åŒ–ğŸŒ³</h2>\n<p>ç”±äº RabbitMQ é»˜è®¤æ˜¯å†…å­˜å­˜å‚¨ï¼Œå¦‚æœæ­¤æ—¶ mq å‘ç”Ÿäº†å®•æœºï¼Œæ¶ˆæ¯ä¹Ÿæ˜¯æœ‰å¯èƒ½ä¸¢å¤±çš„ã€‚è¦æƒ³è®©æ¶ˆæ¯çœŸæ­£å®‰å…¨ï¼Œæˆ‘ä»¬å¿…é¡»ç¡®ä¿è¿™ä¸ªæ¶ˆæ¯èƒ½å¤Ÿåšåˆ°æŒä¹…åŒ–ã€‚ä¹Ÿå°±æ˜¯æŠŠå®ƒå†™å…¥åˆ°ç£ç›˜ä¸­</p>\n<p>åœ¨æ¶ˆè´¹è€…çš„ config ç±»ä¸­è¿›è¡Œé…ç½®</p>\n<p>1ã€äº¤æ¢æœºæŒä¹…åŒ–ï¼š</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Bean</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">DirectExchange</span> <span class=\"token function\">simpleExchange</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   <span class=\"token comment\">// ä¸‰ä¸ªå‚æ•°ï¼šäº¤æ¢æœºåç§°ï¼Œæ˜¯å¦æŒä¹…åŒ–ï¼Œå½“æ²¡æœ‰ queue ä¸å…¶ç»‘å®šæ—¶æ˜¯å¦è‡ªåŠ¨åˆ é™¤</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">DirectExchange</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"simple.direct\"</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>2ã€é˜Ÿåˆ—æŒä¹…åŒ–</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Bean</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">Queue</span> <span class=\"token function\">simpleQueue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   <span class=\"token comment\">// ä½¿ç”¨ QueueBuilder æ„å»ºé˜Ÿåˆ—ï¼Œdurable å°±æ˜¯æŒä¹…åŒ–çš„</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   <span class=\"token keyword\">return</span> <span class=\"token class-name\">QueueBuilder</span><span class=\"token punctuation\">.</span><span class=\"token function\">durable</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"simple.queue\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>å¯åŠ¨æœåŠ¡è¿›è¡Œæµ‹è¯•ï¼Œç»“æœå¦‚ä¸‹ï¼š</p>\n<p>é˜Ÿåˆ—</p>\n<p>å…¶ä¸­çš„ D å°±æ˜¯ durable å°±æ˜¯æŒä¹…åŒ–çš„æ„æ€</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310211756121.png\" alt=\"image-20231021175655932\"></p>\n<p>äº¤æ¢æœº</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310211759449.png\" alt=\"image-20231021175939976\"></p>\n<p>å…³é—­æ‰€æœ‰æœåŠ¡å™¨</p>\n<p>å‘é€ä¸€ä¸‹æ¶ˆæ¯è¿›è¡Œæµ‹è¯•ä¸€ä¸‹æ¶ˆæ¯æ˜¯å¦ä¹Ÿèƒ½æŒä¹…åŒ–</p>\n<p>æˆ‘ä»¬å‘ simple.queue ä¸­å‘é€ä¸€æ¡æ¶ˆæ¯</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310211831349.png\" alt=\"image-20231021183122204\"></p>\n<p>æ­¤æ—¶é˜Ÿåˆ—ä¸­å°±ä¼šå­˜ç•™ä¸€æ¡æ¶ˆæ¯</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310211833155.png\" alt=\"image-20231021183339726\"></p>\n<p>é‚£ä¹ˆç°åœ¨æˆ‘ä»¬é˜Ÿåˆ—é‡Œé¢æœ‰æ¶ˆæ¯äº†ï¼Œå¹¶ä¸”é˜Ÿåˆ—å·²ç»æŒä¹…åŒ–äº†ï¼Œæˆ‘ä»¬å†å»é‡å¯ mq æ¥æµ‹è¯•ä¸€ä¸‹</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@localhost nginx<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker restart mq</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>mq</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@localhost nginx<span class=\"token punctuation\">]</span><span class=\"token comment\">#</span></pre></td></tr></table></figure><p>å›åˆ°é¡µé¢ä¸­è¿›è¡ŒæŸ¥çœ‹</p>\n<p>å¯ä»¥çœ‹åˆ°æ¶ˆæ¯ æ²¡äº†ï¼</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310211835842.png\" alt=\"image-20231021183522398\"></p>\n<p>è¿™å°±è¯æ˜æ¶ˆæ¯æ²¡æœ‰æŒä¹…åŒ–ï¼Œé‚£æˆ‘ä»¬çš„ç›®çš„æ˜¯è®©æ¶ˆæ¯ä¹Ÿèƒ½æŒä¹…å•Šï¼Œé‚£æ€ä¹ˆåŠï¼Ÿ</p>\n<p>3ã€æ¶ˆæ¯æŒä¹…åŒ–ï¼ŒSpringAMQP ä¸­çš„æ¶ˆæ¯é»˜è®¤æ˜¯æŒä¹…çš„ï¼Œå¯ä»¥é€šè¿‡ MessageProperties ä¸­çš„ DeliveryMode æ¥æŒ‡å®šï¼š</p>\n<p>åœ¨æµ‹è¯•ä»£ç ä¸­è¿›è¡Œç¼–å†™ï¼š</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Test</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">testDurableMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   <span class=\"token comment\">// 1. å‡†å¤‡æ¶ˆæ¯</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   <span class=\"token class-name\">Message</span> message <span class=\"token operator\">=</span> <span class=\"token class-name\">MessageBuilder</span><span class=\"token punctuation\">.</span><span class=\"token function\">withBody</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hello, spring\"</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                                             <span class=\"token function\">getBytes</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">StandardCharsets</span><span class=\"token punctuation\">.</span><span class=\"token constant\">UTF_8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// æ¶ˆæ¯ä½“</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token punctuation\">.</span><span class=\"token function\">setDeliveryMode</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MessageDeliveryMode</span><span class=\"token punctuation\">.</span><span class=\"token constant\">PERSISTENT</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// æŒä¹…åŒ–</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   <span class=\"token comment\">// 2. å‘é€æ¶ˆæ¯</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   rabbitTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">convertAndSend</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"simple.queue\"</span><span class=\"token punctuation\">,</span> message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>å¯åŠ¨æˆåŠŸåæŸ¥çœ‹é˜Ÿåˆ—æƒ…å†µï¼š</p>\n<p>å¯ä»¥çœ‹åˆ°é˜Ÿåˆ—ä¸­å°±æœ‰äº†ä¸€æ¡æ¶ˆæ¯äº†</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310211842026.png\" alt=\"image-20231021184255870\"></p>\n<p>åœ¨é˜Ÿåˆ—çš„è¯¦æƒ…é¡µé¢é‡Œé¢çš„ get message ä¸­å¯ä»¥çœ‹åˆ° delivery_modeï¼š2 è¡¨ç¤ºæ¶ˆæ¯æŒä¹…åŒ–</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310211844251.png\" alt=\"image-20231021184420061\"></p>\n<p>é‡å¯ mq æµ‹è¯•æ¶ˆæ¯æ˜¯å¦çœŸçš„å°±æ˜¯æŒä¹…åŒ–äº†ï¼š</p>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@localhost nginx<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker restart mq</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>mq</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@localhost nginx<span class=\"token punctuation\">]</span><span class=\"token comment\">#</span></pre></td></tr></table></figure><p>è®¿é—® mq é˜Ÿé‡Œæƒ…å†µï¼š</p>\n<p>å¯ä»¥çœ‹åˆ°è¿™æ¡æ¶ˆæ¯è¿˜å­˜åœ¨ç€</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310211845144.png\" alt=\"image-20231021184553048\"></p>\n<h2 id=\"94-æ¶ˆè´¹è€…ç¡®è®¤\"><a class=\"markdownIt-Anchor\" href=\"#94-æ¶ˆè´¹è€…ç¡®è®¤\">#</a> 9.4ã€æ¶ˆè´¹è€…ç¡®è®¤ğŸŒ³</h2>\n<p>RabbitMQ æ”¯æŒæ¶ˆè´¹è€…ç¡®è®¤æœºåˆ¶ï¼Œå³ï¼šæ¶ˆè´¹è€…å¤„ç†æ¶ˆæ¯åå¯ä»¥å‘ MQ å‘é€ ack å›æ‰§ï¼ŒMQ æ”¶åˆ° ack å›æ‰§åæ‰ä¼šåˆ é™¤æ¶ˆæ¯ã€‚è€Œ SpringAMQP åˆ™å…è®¸é…ç½®ä¸‰ç§ç¡®è®¤æ¨¡å¼ï¼š</p>\n<ul>\n<li>manualï¼šæ‰‹åŠ¨ ackï¼Œéœ€è¦åœ¨ä¸šåŠ¡ä»£ç ç»“æŸåï¼Œè°ƒç”¨ api å‘é€ ack</li>\n<li>autoï¼šè‡ªåŠ¨ ackï¼Œç”± Spring æ£€æµ‹ listener ä»£ç æ˜¯å¦å‡ºç°å¼‚å¸¸ï¼Œæ²¡æœ‰å¼‚å¸¸åˆ™è¿”å› ackï¼›æŠ›å‡ºå¼‚å¸¸åˆ™è¿”å› nack</li>\n<li>noneï¼šå…³é—­ ackï¼ŒMQ å‡å®šæ¶ˆè´¹è€…è·å–æ¶ˆæ¯åä¼šæˆåŠŸå¤„ç†ï¼Œå› æ­¤æ¶ˆæ¯æŠ•é€’åç«‹å³è¢«åˆ é™¤</li>\n</ul>\n<p>é…ç½®æ–¹å¼æ˜¯ä¿®æ”¹ application.yml æ–‡ä»¶ï¼Œæ·»åŠ ä¸‹é¢é…ç½®ï¼š</p>\n<figure class=\"highlight yml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">rabbitmq</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token key atrule\">host</span><span class=\"token punctuation\">:</span> 192.168.249.128 <span class=\"token comment\"># rabbitMQ çš„ ip åœ°å€</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5672</span> <span class=\"token comment\"># ç«¯å£</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token key atrule\">username</span><span class=\"token punctuation\">:</span> itcast</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token key atrule\">password</span><span class=\"token punctuation\">:</span> <span class=\"token number\">123321</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token key atrule\">virtual-host</span><span class=\"token punctuation\">:</span> /</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token key atrule\">listener</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token key atrule\">simple</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token key atrule\">prefetch</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token key atrule\">acknowledge-mode</span><span class=\"token punctuation\">:</span> auto <span class=\"token comment\"># è‡ªåŠ¨ ack</span></pre></td></tr></table></figure><p>å…ˆçœ‹ä¸‹ mq çš„é˜Ÿåˆ—æƒ…å†µ</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310212025971.png\" alt=\"image-20231021202521333\"></p>\n<p>é˜Ÿåˆ—ä¸­æœ‰ä¸€æ¡æ¶ˆæ¯</p>\n<p>æˆ‘ä»¬åœ¨ consumer çš„æ¶ˆè´¹ä»£ç ç¼–å†™ä¸€ä¸ªå¼‚å¸¸</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Slf4j</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token annotation punctuation\">@Component</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">SpringRabbitListener</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token annotation punctuation\">@RabbitListener</span><span class=\"token punctuation\">(</span>queues <span class=\"token operator\">=</span> <span class=\"token string\">\"simple.queue\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">listenSimpleQueue</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> msg<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token operator\">*</span>        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"æ¶ˆè´¹è€…æ¥æ”¶åˆ°simple.queueçš„æ¶ˆæ¯ï¼šã€\"</span> <span class=\"token operator\">+</span> msg <span class=\"token operator\">+</span> <span class=\"token string\">\"ã€‘\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">/</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"æ¶ˆè´¹è€…å¤„ç†æ¶ˆæ¯æˆåŠŸ ï¼\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>é…ç½®å®Œæˆåå¯åŠ¨ consumer æœåŠ¡è¿›è¡Œæµ‹è¯•</p>\n<p>æ­¤æ—¶ç¨‹åºèµ°åˆ° debug å¤„ï¼Œæ²¡æœ‰æ‰§è¡Œå®Œæ¯•æˆ‘ä»¬çœ‹ä¸‹ç°åœ¨çš„é˜Ÿåˆ—æƒ…å†µ</p>\n<p>å¯ä»¥çœ‹åˆ°å®ƒæ²¡æœ‰åˆ é™¤è¿™æ¡æ¶ˆæ¯è€Œæ˜¯æ ‡è®°ä¸ºäº† Unacked</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310212027453.png\" alt=\"image-20231021202727506\"></p>\n<p>å¦‚æœç¨‹åºä¸è¿›è¡Œä¸€ç›´ç­‰å¾…åˆ™ä¼šå˜å›åŸæ¥çš„çŠ¶æ€</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310212029138.png\" alt=\"image-20231021202909987\"></p>\n<p>java ä»£ç ç¨‹åºå¾€ä¸‹èµ°å°±ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œä½†æ˜¯å®ƒä¼šè¿›è¡Œé‡æ–°æŠ•é€’</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310212048599.gif\" alt=\"test\"></p>\n<p>ä½†æ˜¯æˆ‘ä»¬å¹¶ä¸å¸Œæœ›å®ƒå°±è¿™æ ·å¤±è´¥äº†å°±æ— è„‘é‡è¯•é‚£æ€ä¹ˆåŠå‘¢ï¼Ÿçœ‹ä¸‹é¢çš„å†…å®¹ã€‚</p>\n<h2 id=\"95-å¤±è´¥é‡è¯•æœºåˆ¶\"><a class=\"markdownIt-Anchor\" href=\"#95-å¤±è´¥é‡è¯•æœºåˆ¶\">#</a> 9.5ã€å¤±è´¥é‡è¯•æœºåˆ¶ğŸŒ³</h2>\n<p>å½“æ¶ˆè´¹è€…å‡ºç°å¼‚å¸¸åï¼Œæ¶ˆè´¹ä¼šä¸æ–­ requue (é‡æ–°å…¥é˜Ÿ) åˆ°é˜Ÿåˆ—ï¼Œå†é‡æ–°å‘é€ç»™æ¶ˆè´¹è€…ï¼Œç„¶åå†æ¬¡å¼‚å¸¸ï¼Œå†æ¬¡ requeueï¼Œæ— é™å¾ªç¯ï¼Œå¯¼è‡´ mq çš„æ¶ˆæ¯å¤„ç†é£™å‡ï¼Œå¸¦æ¥ä¸å¿…è¦çš„å‹åŠ›ï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310212051338.png\" alt=\"image-20231021205137135\"></p>\n<p>æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ Spring çš„ retry æœºåˆ¶ï¼Œåœ¨æ¶ˆè´¹è€…å‡ºç°å¼‚å¸¸æ—¶åˆ©ç”¨æœ¬åœ°é‡è¯•ï¼Œè€Œä¸æ˜¯æ— é™åˆ¶çš„ requeue åˆ° mq é˜Ÿåˆ—ã€‚</p>\n<p>å½“ç„¶æœ¬åœ°é‡è¯•ä¹Ÿä¸æ˜¯æ— é™è®©å®ƒä¸€ç›´é‡è¯•</p>\n<p>åœ¨æ¶ˆè´¹è€…æœåŠ¡ä¸­è¿›è¡Œé…ç½®ï¼š</p>\n<figure class=\"highlight yml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">rabbitmq</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token key atrule\">host</span><span class=\"token punctuation\">:</span> 192.168.249.128 <span class=\"token comment\"># rabbitMQ çš„ ip åœ°å€</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5672</span> <span class=\"token comment\"># ç«¯å£</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token key atrule\">username</span><span class=\"token punctuation\">:</span> itcast</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token key atrule\">password</span><span class=\"token punctuation\">:</span> <span class=\"token number\">123321</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token key atrule\">virtual-host</span><span class=\"token punctuation\">:</span> /</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token key atrule\">listener</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token key atrule\">simple</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token key atrule\">prefetch</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token key atrule\">acknowledge-mode</span><span class=\"token punctuation\">:</span> auto</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token comment\">#------------------------------------------------------</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token key atrule\">retry</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>          <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span> <span class=\"token comment\"># å¼€å¯æ¶ˆè´¹è€…å¤±è´¥é‡è¯•</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>          <span class=\"token key atrule\">initial-interval</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1000</span> <span class=\"token comment\"># åˆå§‹çš„å¤±è´¥ç­‰å¾…æ—¶é•¿ä¸º 1 ç§’</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          <span class=\"token key atrule\">multiplier</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3</span> <span class=\"token comment\"># ä¸‹æ¬¡å¤±è´¥çš„ç­‰å¾…æ—¶é•¿å€æ•°ï¼Œä¸‹æ¬¡ç­‰å¾…æ—¶é•¿ = multiplier *last-interval</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>          <span class=\"token key atrule\">max-attempts</span><span class=\"token punctuation\">:</span> <span class=\"token number\">4</span> <span class=\"token comment\"># æœ€å¤§é‡è¯•æ¬¡æ•°</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>          <span class=\"token key atrule\">stateless</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span> <span class=\"token comment\"># true æ— çŠ¶æ€ï¼›false æœ‰çŠ¶æ€ã€‚å¦‚æœä¸šåŠ¡ä¸­åŒ…å«äº‹åŠ¡ï¼Œè¿™é‡Œæ”¹ä¸º false</span></pre></td></tr></table></figure><p>å¯åŠ¨æ¶ˆè´¹è€…æœåŠ¡åè¿›è¡Œæµ‹è¯• idea æ§åˆ¶å°æ‰“å°å¦‚ä¸‹ï¼š</p>\n<p>æŠ¥äº†ä¸€ä¸ªå¼‚å¸¸ï¼Œè¯´é‡è¯•æ¬¡æ•°è€—å°½äº†</p>\n<pre><code>mqp.rabbit.support.ListenerExecutionFailedException: Retry Policy Exhausted\n\tat org.springframework.amqp.rabbit.retry.RejectAndDontRequeueRecoverer.recover(RejectAndDontRequeueRecoverer.java:45) ~[spring-rabbit-2.2.15.RELEASE.jar:2.2.15.RELEASE]\n\tat org.springframework.amqp.rabbit.config.StatelessRetryOperationsInterceptorFactoryBean.lambda$createRecoverer$0(StatelessRetryOperationsInterceptorFactoryBean.java:74) ~[spring-rabbit-2.2.15.RELEASE.jar:2.2.15.RELEASE]\n\tat org.springframework.retry.interceptor.RetryOperationsInterceptor$ItemRecovererCallback.recover(RetryOperationsInterceptor.java:141) ~[spring-retry-1.2.5.RELEASE.jar:na]\n\tat org.springframework.retry.support.RetryTemplate.handleRetryExhausted(RetryTemplate.java:512) ~[spring-retry-1.2.5.RELEASE.jar:na]\n</code></pre>\n<p>è¿™æ¡æ¶ˆæ¯å°±ä¼šè¢«ä¸¢å¼ƒæ‰</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310220940740.png\" alt=\"image-20231022094032330\"></p>\n<h3 id=\"951-æ¶ˆè´¹è€…å¤±è´¥æ¶ˆæ¯å¤„ç†ç­–ç•¥\"><a class=\"markdownIt-Anchor\" href=\"#951-æ¶ˆè´¹è€…å¤±è´¥æ¶ˆæ¯å¤„ç†ç­–ç•¥\">#</a> 9.5.1ã€æ¶ˆè´¹è€…å¤±è´¥æ¶ˆæ¯å¤„ç†ç­–ç•¥ğŸŒ²</h3>\n<p>åœ¨å¼€å¯é‡è¯•æ¨¡å¼åï¼Œé‡è¯•æ¬¡æ•°è€—å°½ï¼Œå¦‚æœæ¶ˆæ¯ä¾ç„¶å¤±è´¥ï¼Œåˆ™éœ€è¦æœ‰ MessageRecoverer æ¥å£æ¥å¤„ç†ï¼Œå®ƒåŒ…å«ä¸‰ç§ä¸åŒçš„å®ç°ï¼š</p>\n<p>1ã€RejectAndDontRequeueRecovererï¼šé‡è¯•è€—å°½åï¼Œç›´æ¥ rejectï¼Œä¸¢å¼ƒæ¶ˆæ¯ã€‚é»˜è®¤å°±æ˜¯è¿™ç§æ–¹å¼</p>\n<p>2ã€ImmediateRequeueMessageRecovererï¼šé‡è¯•è€—å°½åï¼Œè¿”å› nackï¼Œæ¶ˆæ¯é‡æ–°å…¥é˜Ÿ</p>\n<p>3ã€RepublishMessageRecovererï¼šé‡è¯•è€—å°½åï¼Œå°†å¤±è´¥æ¶ˆæ¯æŠ•é€’åˆ°æŒ‡å®šçš„äº¤æ¢æœº</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310221014285.png\" alt=\"image-20231022101421805\"></p>\n<p>æµ‹è¯•ä¸‹ RepublishMessageRcoverer å¤„ç†æ¨¡å¼ï¼š</p>\n<p>1ã€é¦–å…ˆï¼Œå®šä¹‰æ¥æ”¶å¤±è´¥æ¶ˆæ¯çš„äº¤æ¢æœºï¼Œé˜Ÿåˆ—åŠå…¶ç»‘å®šå…³ç³»ï¼š</p>\n<p>2ã€ç„¶åå®šä¹‰ RepublishMessageRecovererï¼š</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Configuration</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ErrorMessageConfig</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token annotation punctuation\">@Bean</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">DirectExchange</span> <span class=\"token function\">errorMessageExchange</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">DirectExchange</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"error.direct\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token annotation punctuation\">@Bean</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Queue</span> <span class=\"token function\">errorQueue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Queue</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"error.queue\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token annotation punctuation\">@Bean</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Binding</span> <span class=\"token function\">errorMessageBinding</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token class-name\">BindingBuilder</span><span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token function\">errorQueue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">to</span><span class=\"token punctuation\">(</span><span class=\"token function\">errorMessageExchange</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">with</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"error\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token annotation punctuation\">@Bean</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">MessageRecoverer</span> <span class=\"token function\">republishMessageRecoverer</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">RabbitTemplate</span> rabbitTemplate<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RepublishMessageRecoverer</span><span class=\"token punctuation\">(</span>rabbitTemplate<span class=\"token punctuation\">,</span> <span class=\"token string\">\"error.direct\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"error\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>å¯åŠ¨æ¶ˆè´¹è€…æœåŠ¡æŸ¥çœ‹ mq çš„äº¤æ¢æœºå’Œé˜Ÿåˆ—æƒ…å†µ</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310221027869.png\" alt=\"image-20231022102732042\"></p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310221027294.png\" alt=\"image-20231022102744943\"></p>\n<p>å‘é€ä¸€æ¡æ¶ˆæ¯è¿›è¡Œæµ‹è¯•ï¼Œæ‰¾åˆ° simple.queue è¿›è¡Œå‘é€æ¶ˆæ¯</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310221030573.png\" alt=\"image-20231022103002600\"></p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310221032487.png\" alt=\"image-20231022103250120\"></p>\n<p>idea æ§åˆ¶å°æ‰“å°æƒ…å†µ</p>\n<pre><code>æ¶ˆè´¹è€…æ¥æ”¶åˆ°simple.queueçš„æ¶ˆæ¯ï¼šã€hello spring !ã€‘\næ¶ˆè´¹è€…æ¥æ”¶åˆ°simple.queueçš„æ¶ˆæ¯ï¼šã€hello spring !ã€‘\næ¶ˆè´¹è€…æ¥æ”¶åˆ°simple.queueçš„æ¶ˆæ¯ï¼šã€hello spring !ã€‘\n10:30:18:538  WARN 6996 --- [ntContainer#0-1] o.s.a.r.retry.RepublishMessageRecoverer  : Republishing failed message to exchange 'error.direct' with routing key error\n</code></pre>\n<p>ç„¶åå†æŸ¥çœ‹é˜Ÿåˆ—æƒ…å†µ</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310221031933.png\" alt=\"image-20231022103105401\"></p>\n<p>åœ¨ error.queue é˜Ÿåˆ—çš„è¯¦ç»†æ¶ˆæ¯ä¸­å¯ä»¥çœ‹åˆ°æŠ¥é”™çš„ä¿¡æ¯</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310221032636.png\" alt=\"image-20231022103202192\"></p>\n<blockquote>\n<p><strong>æ€»ç»“</strong>:</p>\n<p>å¦‚ä½•ç¡®ä¿ RabbitMQ æ¶ˆæ¯çš„å¯é æ€§ï¼Ÿ</p>\n<ol>\n<li>å¼€å¯ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶ï¼Œç¡®ä¿ç”Ÿäº§è€…çš„æ¶ˆæ¯èƒ½åˆ°è¾¾é˜Ÿåˆ—</li>\n<li>å¼€å¯æŒä¹…åŒ–åŠŸèƒ½ï¼Œç¡®ä¿æ¶ˆæ¯æœªæ¶ˆè´¹å‰åœ¨é˜Ÿåˆ—ä¸­ä¸ä¼šä¸¢å¤±</li>\n<li>å¼€å¯æ¶ˆè´¹è€…ç¡®è®¤æœºåˆ¶ä¸º autoï¼Œç”± spring ç¡®è®¤æ¶ˆæ¯å¤„ç†æˆåŠŸåå®Œæˆ ack</li>\n<li>å¼€å¯æ¶ˆè´¹è€…å¤±è´¥é‡è¯•æœºåˆ¶ï¼Œå¹¶è®¾ç½® MessageRecovererï¼Œå¤šæ¬¡é‡è¯•å¤±è´¥åå°†æ¶ˆæ¯æŠ•é€’åˆ°å¼‚å¸¸äº¤æ¢æœºï¼Œäº¤ç”±äººå·¥å¤„ç†</li>\n</ol>\n</blockquote>\n<h1 id=\"å-æ­»ä¿¡äº¤æ¢æœº\"><a class=\"markdownIt-Anchor\" href=\"#å-æ­»ä¿¡äº¤æ¢æœº\">#</a> åã€æ­»ä¿¡äº¤æ¢æœºğŸ„</h1>\n<ul>\n<li>åˆè¯†æ­»ä¿¡äº¤æ¢æœº</li>\n<li>TTL</li>\n<li>å»¶è¿Ÿé˜Ÿåˆ—</li>\n</ul>\n<h2 id=\"101-åˆè¯†æ­»ä¿¡äº¤æ¢æœº\"><a class=\"markdownIt-Anchor\" href=\"#101-åˆè¯†æ­»ä¿¡äº¤æ¢æœº\">#</a> 10.1ã€åˆè¯†æ­»ä¿¡äº¤æ¢æœºğŸŒ³</h2>\n<p>å½“ä¸€ä¸ªé˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯æ»¡è¶³ä¸‹åˆ—æƒ…å†µä¹‹ä¸€æ—¶ï¼Œå¯ä»¥ç§°ä¸º<font color='red'>æ­»ä¿¡ (dead letter)</font>ï¼š</p>\n<p>1ã€æ¶ˆè´¹è€…ä½¿ç”¨ basic.reject æˆ– basic.nack å£°æ˜æ¶ˆè´¹å¤±è´¥ï¼Œå¹¶ä¸”æ¶ˆæ¯çš„ requeue å‚æ•°è®¾ç½®ä¸º false</p>\n<p>2ã€æ¶ˆæ¯æ˜¯ä¸€ä¸ªè¿‡æœŸæ¶ˆæ¯ï¼Œè¶…æ—¶æ— äººæ¶ˆè´¹</p>\n<p>3ã€è¦æŠ•é€’çš„é˜Ÿåˆ—æ¶ˆæ¯å †ç§¯æ»¡äº†ï¼Œæœ€æ—©çš„æ¶ˆæ¯å¯èƒ½æˆä¸ºæ­»ä¿¡</p>\n<p>å¦‚æœè¯¥é˜Ÿåˆ—é…ç½®äº† dead-letter-exchange å±æ€§ï¼ŒæŒ‡å®šäº†ä¸€ä¸ªäº¤æ¢æœºï¼Œé‚£ä¹ˆé˜Ÿåˆ—ä¸­çš„æ­»ä¿¡å°±ä¼šæŠ•é€’åˆ°è¿™ä¸ªäº¤æ¢æœºä¸­ï¼Œè€Œè¿™ä¸ªäº¤æ¢æœºç§°ä¸º<font color='red'>æ­»ä¿¡äº¤æ¢æœº</font>. (Dead Letter Exchange ï¼Œ ç®€ç§° DLX)ã€‚</p>\n<p>å¦‚æœæœ‰ä¸€ä¸ªæ¶ˆæ¯å‘é€åˆ°äº†æ¶ˆè´¹è€…ï¼Œå‡è®¾æ¶ˆè´¹è€…é‡‡ç”¨é»˜è®¤çš„é‡è¯•æœºåˆ¶ä¸æ–­é‡è¯•ç›´åˆ°æ¬¡æ•°è€—å°½å°±ä¼šå°†æ¶ˆæ¯æ‹’ç»ï¼Œè€Œæ¶ˆæ¯ä¸€æ—¦è¢«æ‹’ç»é»˜è®¤æƒ…å†µä¸‹å°±ä¼šè¢«ä¸¢å¼ƒäº†ã€‚</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310221043785.png\" alt=\"image-20231022104354267\"></p>\n<p>å¦‚æœè¯´ä¸æƒ³ä¸¢å¤±å°±å¿…é¡»ç»™ simple.queue è¿™ä¸ªé˜Ÿåˆ—ç»‘å®šæ­»ä¿¡äº¤æ¢æœºï¼Œè¿™æ—¶æ¶ˆæ¯å°±ä¸ä¼šè¢«ä¸¢å¼ƒäº†è€Œæ˜¯å˜æˆä¸€ä¸ªæ­»ä¿¡å†å›åˆ°é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—å†æŠ•é€’åˆ°æ­»ä¿¡äº¤æ¢æœºã€‚</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310221046386.png\" alt=\"image-20231022104628552\"></p>\n<p>äº¤æ¢æœºä¸èƒ½å­˜å‚¨æ¶ˆæ¯é‚£ä¹ˆä¸ºäº†ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±ï¼Œè¿˜éœ€è¦ç»‘å®šä¸€ä¸ªé˜Ÿåˆ—ï¼Œè¿™ä¸ªæ¶ˆæ¯å°±ä¼šåˆ°è¾¾ dl.queue é˜Ÿåˆ—ä¸­ç§°ä¸ºæ­»ä¿¡é˜Ÿåˆ—</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310221049450.png\" alt=\"image-20231022104901077\"></p>\n<p>è¿™é‡Œä¸ä¸Šè¿°çš„ æ¶ˆè´¹è€…å¤±è´¥æ¶ˆæ¯å¤„ç†ç­–ç•¥ ä¸€æ ·ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰å·®å¼‚çš„ï¼Œå°±æ˜¯åœ¨ä¸Šè¿°æ–¹å¼ä¸­ï¼Œæ‰€æœ‰çš„å¤±è´¥æ¶ˆæ¯éƒ½æ˜¯æœ‰æ¶ˆè´¹è€…æ¥åšæŠ•é€’çš„ã€‚è€Œåœ¨ç°åœ¨çš„æ–¹å¼ä¸­æ˜¯ç”±é˜Ÿåˆ—åšæŠ•é€’çš„</p>\n<p>å¦‚æœåªæ˜¯åšæ¶ˆæ¯çš„å…œåº•å¤„ç†å»ºè®®ä½¿ç”¨ä¸Šè¿°æ–¹å¼ï¼Œå¦‚æœæ˜¯åšæ¶ˆæ¯å…œåº•å¤„ç†ä»¥åŠé¢å¤–çš„åŠŸèƒ½å»ºè®®ä½¿ç”¨å½“å‰æ–¹å¼</p>\n<blockquote>\n<p><strong>æ€»ç»“</strong>ï¼š</p>\n<p>ä»€ä¹ˆæ ·çš„æ¶ˆæ¯ä¼šæˆä¸ºæ­»ä¿¡ï¼Ÿ</p>\n<p>1ã€æ¶ˆæ¯è¢«æ¶ˆè´¹è€… reject æˆ–è€…è¿”å› nack</p>\n<p>2ã€æ¶ˆæ¯è¶…æ—¶æœªæ¶ˆè´¹</p>\n<p>3ã€é˜Ÿåˆ—æ»¡äº†</p>\n<p>å¦‚ä½•ç»™é˜Ÿåˆ—ç»‘å®šæ­»ä¿¡äº¤æ¢æœºï¼Ÿ</p>\n<p>1ã€ç»™é˜Ÿåˆ—è®¾ç½® dead-letter-exchange å±æ€§ï¼ŒæŒ‡å®šä¸€ä¸ªäº¤æ¢æœº</p>\n<p>2ã€ç»™é˜Ÿåˆ—è®¾ç½® dead-letter-routing-key å±æ€§ï¼Œè®¾ç½®æ­»ä¿¡äº¤æ¢æœºä¸æ­»ä¿¡é˜Ÿåˆ—çš„ RoutingKey</p>\n</blockquote>\n<h2 id=\"102-ttl\"><a class=\"markdownIt-Anchor\" href=\"#102-ttl\">#</a> 10.2ã€TTLğŸŒ³</h2>\n<p>TTLï¼Œä¹Ÿå°±æ˜¯ Time-To-Liveã€‚å¦‚æœä¸€ä¸ªé˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ TTL ç»“æŸä»æœªæ¶ˆè´¹ï¼Œåˆ™ä¼šå˜ä¸ºæ­»ä¿¡ï¼ŒTTL è¶…æ—¶åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š</p>\n<p>1ã€æ¶ˆæ¯æ‰€åœ¨çš„é˜Ÿåˆ—è®¾ç½®äº†å­˜æ´»æ—¶é—´</p>\n<p>2ã€æ¶ˆæ¯æœ¬èº«è®¾ç½®äº†å­˜æ´»æ—¶é—´</p>\n<p>å‡å¦‚ä¸€ä¸ªæ¶ˆæ¯è‡ªå·±è®¾ç½®äº†æ—¶é—´ä¸º 5000 æ¯«ç§’åˆ°æ¶ˆæ¯å‘å‡ºå»ï¼Œåˆ°è¾¾äº†é˜Ÿåˆ—çš„æ—¶å€™å°±ä¼šå¼€å§‹è®¡æ—¶ï¼Œè®¡æ—¶ç»“æŸåè¿™ä¸ªæ¶ˆæ¯å°±ä¼šæˆä¸ºæ­»ä¿¡ï¼Œä»è€ŒæŠ•é€’åˆ°æ­»ä¿¡äº¤æ¢æœº æœ€ç»ˆåˆ°è¾¾äº†æ­»ä¿¡é˜Ÿåˆ—ã€‚è¿™æ—¶å¦‚æœæ°å¥½æœ‰ä¸€ä¸ªæ¶ˆè´¹è€…åœ¨ç›‘å¬æ­»ä¿¡é˜Ÿåˆ—å®ƒå°±ä¼šæ”¶åˆ°è¿™ä¸ªæ­»ä¿¡æ¶ˆæ¯</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310221102065.gif\" alt=\"test\"></p>\n<p>æˆ‘ä»¬å£°æ˜ä¸€ç»„æ­»ä¿¡äº¤æ¢æœºå’Œé˜Ÿåˆ—ï¼ŒåŸºäºæ³¨è§£æ–¹å¼ï¼š</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@RabbitListener</span><span class=\"token punctuation\">(</span>bindings <span class=\"token operator\">=</span> <span class=\"token annotation punctuation\">@QueueBinding</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   value <span class=\"token operator\">=</span> <span class=\"token annotation punctuation\">@Queue</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"dl.queue\"</span><span class=\"token punctuation\">,</span> durable <span class=\"token operator\">=</span> <span class=\"token string\">\"true\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   exchange <span class=\"token operator\">=</span> <span class=\"token annotation punctuation\">@Exchange</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"dl.direct\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   key <span class=\"token operator\">=</span> <span class=\"token string\">\"dl\"</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">listenDlQueue</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> msg<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"æ¶ˆè´¹è€…æ¥æ”¶åˆ°äº†dl.queueçš„å»¶è¿Ÿæ¶ˆæ¯\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>è¦ç»™é˜Ÿåˆ—è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œéœ€è¦åœ¨å£°æ˜é˜Ÿåˆ—çš„ç±»ä¸­ç¼–å†™å¦‚ä¸‹ä»£ç ï¼š</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Configuration</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">TTLMessageConfig</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token annotation punctuation\">@Bean</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">DirectExchange</span> <span class=\"token function\">ttlDirectExchange</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">DirectExchange</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ttl.direct\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token annotation punctuation\">@Bean</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Queue</span> <span class=\"token function\">ttlQueue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token class-name\">QueueBuilder</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                <span class=\"token punctuation\">.</span><span class=\"token function\">durable</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ttl.queue\"</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// æŒ‡å®šé˜Ÿåˆ—åç§°ï¼Œå¹¶æŒä¹…åŒ–</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                <span class=\"token punctuation\">.</span><span class=\"token function\">ttl</span><span class=\"token punctuation\">(</span><span class=\"token number\">10000</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// è®¾ç½®é˜Ÿåˆ—çš„è¶…æ—¶æ—¶é—´ï¼Œ10 ç§’</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                <span class=\"token punctuation\">.</span><span class=\"token function\">deadLetterExchange</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dl.direct\"</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// æŒ‡å®šæ­»ä¿¡äº¤æ¢æœº</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                <span class=\"token punctuation\">.</span><span class=\"token function\">deadLetterRoutingKey</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dl\"</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// æŒ‡å®šæ­»ä¿¡ RoutingKey</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token annotation punctuation\">@Bean</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Binding</span> <span class=\"token function\">ttlBinding</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token class-name\">BindingBuilder</span><span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token function\">ttlQueue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">to</span><span class=\"token punctuation\">(</span><span class=\"token function\">ttlDirectExchange</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">with</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ttl\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>ç¼–å†™å‘å¸ƒè€…ä»£ç ï¼š</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Test</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">testTTLMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   <span class=\"token comment\">// 1. å‡†å¤‡æ¶ˆæ¯</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   <span class=\"token class-name\">Message</span> message <span class=\"token operator\">=</span> <span class=\"token class-name\">MessageBuilder</span><span class=\"token punctuation\">.</span><span class=\"token function\">withBody</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hello, ttl message\"</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                                             <span class=\"token function\">getBytes</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">StandardCharsets</span><span class=\"token punctuation\">.</span><span class=\"token constant\">UTF_8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token punctuation\">.</span><span class=\"token function\">setDeliveryMode</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MessageDeliveryMode</span><span class=\"token punctuation\">.</span><span class=\"token constant\">PERSISTENT</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   <span class=\"token comment\">// 2. å‘é€æ¶ˆæ¯</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   rabbitTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">convertAndSend</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ttl.direct\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"ttl\"</span><span class=\"token punctuation\">,</span> message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   <span class=\"token comment\">// 3. è®°å½•æ—¥å¿—</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"æ¶ˆæ¯å·²ç»æˆåŠŸå‘é€äº† ï¼\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>å¯åŠ¨æœåŠ¡è¿›è¡Œæµ‹è¯•ï¼š</p>\n<p>æ¶ˆæ¯å‘å¸ƒè€…å‘é€å‡ºå»çš„æ—¶é—´ä¸ºï¼š46</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310221122622.png\" alt=\"image-20231022112215176\"></p>\n<p>æ¶ˆæ¯æ¥æ”¶è€…æ¥æ”¶åˆ°æ¶ˆæ¯æ—¶é—´ä¸ºï¼š56</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310221122464.png\" alt=\"image-20231022112249139\"></p>\n<p>å»¶è¿Ÿäº† 10 ç§’é’Ÿçš„æ—¶é—´ï¼Œè¿™æ ·å»¶è¿Ÿæ¶ˆæ¯å°±å®ç°äº†</p>\n<p>ä¸Šè¿°æ˜¯åŸºäºé˜Ÿåˆ—å®ç°çš„å»¶è¿Ÿæ¶ˆæ¯ï¼Œä¸‹é¢æ¥å­¦ä¹ ç»™æ¶ˆæ¯è®¾ç½®å»¶è¿Ÿæ—¶é—´</p>\n<p>å‘é€æ¶ˆæ¯æ—¶ï¼Œç»™æ¶ˆæ¯æœ¬èº«è®¾ç½®è¶…æ—¶æ—¶é—´ï¼š</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Test</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">testTTLMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   <span class=\"token comment\">// 1. å‡†å¤‡æ¶ˆæ¯</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   <span class=\"token class-name\">Message</span> message <span class=\"token operator\">=</span> <span class=\"token class-name\">MessageBuilder</span><span class=\"token punctuation\">.</span><span class=\"token function\">withBody</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hello, ttl message\"</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                                             <span class=\"token function\">getBytes</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">StandardCharsets</span><span class=\"token punctuation\">.</span><span class=\"token constant\">UTF_8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token punctuation\">.</span><span class=\"token function\">setDeliveryMode</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MessageDeliveryMode</span><span class=\"token punctuation\">.</span><span class=\"token constant\">PERSISTENT</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      <span class=\"token punctuation\">.</span><span class=\"token function\">setExpiration</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"5000\"</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// è®¾ç½®æ¶ˆæ¯çš„å»¶è¿Ÿæ—¶é—´ä¸º 5 ç§’</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   <span class=\"token comment\">// 2. å‘é€æ¶ˆæ¯</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   rabbitTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">convertAndSend</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ttl.direct\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"ttl\"</span><span class=\"token punctuation\">,</span> message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   <span class=\"token comment\">// 3. è®°å½•æ—¥å¿—</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>   log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"æ¶ˆæ¯å·²ç»æˆåŠŸå‘é€äº† ï¼\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>å¯åŠ¨æœåŠ¡å™¨æµ‹è¯•æŸ¥çœ‹æ¶ˆæ¯å»¶è¿Ÿå¤šä¹…æ—¶é—´ï¼š</p>\n<p>å‘é€è€…å‘é€æ¶ˆæ¯æ—¶é—´ä¸ºï¼š16</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310221127666.png\" alt=\"image-20231022112741830\"></p>\n<p>æ¥å—è€…æ”¶åˆ°æ¶ˆæ¯æ—¶é—´ä¸ºï¼š21</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310221128275.png\" alt=\"image-20231022112808892\"></p>\n<p>æ¶ˆæ¯å»¶è¿Ÿäº† 5 ç§’çš„æ—¶é—´ï¼Œ<mark>å½“é˜Ÿåˆ—ä¸æ¶ˆæ¯æœ¬èº«éƒ½è®¾ç½®äº†å»¶è¿Ÿæ—¶é—´æ—¶ï¼Œä»¥æœ€çŸ­çš„æ—¶é—´ä¸ºå‡†</mark>ã€‚</p>\n<blockquote>\n<p><strong>æ€»ç»“</strong>ï¼š</p>\n<p>æ¶ˆæ¯è¶…æ—¶çš„ä¸¤ç§æ–¹å¼æ˜¯ï¼Ÿ</p>\n<p>1ã€ç»™é˜Ÿåˆ—è®¾ç½® ttl å±æ€§ï¼Œè¿›å…¥é˜Ÿåˆ—åè¶…è¿‡ ttl æ—¶é—´çš„æ¶ˆæ¯å˜ä¸ºæ­»ä¿¡</p>\n<p>2ã€ç»™æ¶ˆæ¯è®¾ç½® ttl å±æ€§ï¼Œé˜Ÿåˆ—æ¥æ”¶åˆ°æ¶ˆæ¯è¶…è¿‡ ttl æ—¶é—´åå˜ä¸ºæ­»ä¿¡</p>\n<p>3ã€ä¸¤è€…å…±å­˜æ—¶ï¼Œä»¥æ—¶é—´çŸ­çš„ ttl ä¸ºå‡†</p>\n<p>å¦‚ä½•å®ç°å‘é€ä¸€ä¸ªæ¶ˆæ¯ 20 ç§’åæ¶ˆè´¹è€…æ‰æ”¶åˆ°æ¶ˆæ¯ï¼Ÿ</p>\n<p>1ã€ç»™æ¶ˆæ¯çš„ç›®æ ‡é˜Ÿåˆ—æŒ‡å®šæ­»ä¿¡äº¤æ¢æœº</p>\n<p>2ã€æ¶ˆè´¹è€…ç›‘å¬ä¸æ­»ä¿¡äº¤æ¢æœºç»‘å®šçš„é˜Ÿåˆ—</p>\n<p>3ã€å‘é€æ¶ˆæ¯æ—¶ç»™æ¶ˆæ¯è®¾ç½® tll ä¸º 20 ç§’</p>\n</blockquote>\n<p>ä¸‹é¢å­¦ä¹ å»¶è¿Ÿé˜Ÿåˆ—çš„æ’ä»¶æ¥å®ç°å»¶è¿Ÿæ¶ˆæ¯</p>\n<h2 id=\"103-å»¶è¿Ÿé˜Ÿåˆ—\"><a class=\"markdownIt-Anchor\" href=\"#103-å»¶è¿Ÿé˜Ÿåˆ—\">#</a> 10.3ã€å»¶è¿Ÿé˜Ÿåˆ—ğŸŒ³</h2>\n<p>åˆ©ç”¨ TTL ç»“åˆæ­»ä¿¡äº¤æ¢æœºï¼Œæˆ‘ä»¬å®ç°äº†æ¶ˆæ¯å‘å‡ºåï¼Œæ¶ˆè´¹è€…å»¶è¿Ÿæ”¶åˆ°æ¶ˆæ¯çš„æ•ˆæœã€‚è¿™ç§æ¶ˆæ¯æ¨¡å¼å°±ç§°ä¸º <font color='red'>å»¶è¿Ÿé˜Ÿåˆ— (Delay Queue) æ¨¡å¼</font>.</p>\n<p>å»¶è¿Ÿé˜Ÿåˆ—çš„ä½¿ç”¨åœºæ™¯åŒ…æ‹¬ï¼š</p>\n<p>1ã€å»¶è¿Ÿå‘é€çŸ­ä¿¡</p>\n<p>2ã€ç”¨æˆ·ä¸‹å•ï¼Œå¦‚æœç”¨æˆ·åœ¨ 15 åˆ†é’Ÿå†…æœªæ”¯ä»˜ï¼Œåˆ™è‡ªåŠ¨å–æ¶ˆ</p>\n<p>3ã€é¢„çº¦å·¥ä½œä¼šè®®ï¼Œ20 åˆ†é’Ÿåè‡ªåŠ¨é€šçŸ¥æ‰€æœ‰å‚ä¼šäººå‘˜</p>\n<h3 id=\"1031-å»¶è¿Ÿé˜Ÿåˆ—æ’ä»¶\"><a class=\"markdownIt-Anchor\" href=\"#1031-å»¶è¿Ÿé˜Ÿåˆ—æ’ä»¶\">#</a> 10.3.1ã€å»¶è¿Ÿé˜Ÿåˆ—æ’ä»¶ğŸŒ²</h3>\n<p>å› ä¸ºå»¶è¿Ÿé˜Ÿåˆ—çš„éœ€æ±‚éå¸¸å¤šï¼Œæ‰€ä»¥ RabbitMQ çš„å®˜æ–¹ä¹Ÿæ¨å‡ºäº†ä¸€ä¸ªæ’ä»¶ï¼ŒåŸç”Ÿæ”¯æŒå»¶è¿Ÿé˜Ÿåˆ—æ•ˆæœã€‚</p>\n<p>è¯¦ç»†å®‰è£…æŸ¥çœ‹æ–‡ç« ï¼š<a href=\"../RabbitMQ/%E9%AB%98%E7%BA%A7%E7%AF%87/RabbitMQ%E9%83%A8%E7%BD%B2%E6%8C%87%E5%8D%97.md\">RabbitMQ éƒ¨ç½²æŒ‡å—</a>.</p>\n<h3 id=\"1032-springamqpä½¿ç”¨å»¶è¿Ÿé˜Ÿåˆ—æ’ä»¶\"><a class=\"markdownIt-Anchor\" href=\"#1032-springamqpä½¿ç”¨å»¶è¿Ÿé˜Ÿåˆ—æ’ä»¶\">#</a> 10.3.2ã€SpringAMQP ä½¿ç”¨å»¶è¿Ÿé˜Ÿåˆ—æ’ä»¶ğŸŒ²</h3>\n<p>DelayExchange çš„æœ¬è´¨è¿˜æ˜¯å®˜æ–¹çš„ä¸‰ç§äº¤æ¢æœºï¼Œåªæ˜¯æ·»åŠ äº†å»¶è¿ŸåŠŸèƒ½ã€‚å› æ­¤ä½¿ç”¨æ—¶åªéœ€è¦å£°æ˜ä¸€ä¸ªäº¤æ¢æœºï¼Œäº¤æ¢æœºçš„ç±»å‹å¯ä»¥æ˜¯ä»»æ„ç±»å‹ï¼Œç„¶åè®¾å®š delayed å±æ€§ä¸º true å³å¯</p>\n<p>åŸºäºæ³¨è§£æ–¹å¼ï¼š</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@RabbitListener</span><span class=\"token punctuation\">(</span>bindings <span class=\"token operator\">=</span> <span class=\"token annotation punctuation\">@QueueBinding</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   value <span class=\"token operator\">=</span> <span class=\"token annotation punctuation\">@Queue</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"delay.queue\"</span><span class=\"token punctuation\">,</span> durable <span class=\"token operator\">=</span> <span class=\"token string\">\"true\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   exchange <span class=\"token operator\">=</span> <span class=\"token annotation punctuation\">@Exchange</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"delay.direct\"</span><span class=\"token punctuation\">,</span> delayed <span class=\"token operator\">=</span> <span class=\"token string\">\"true\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   key <span class=\"token operator\">=</span> <span class=\"token string\">\"delay\"</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">listenDelayExchange</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> msg<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"æ¶ˆè´¹è€…æ¥æ”¶åˆ°äº†delay.queueçš„å»¶è¿Ÿæ¶ˆæ¯ , &#123;&#125;\"</span><span class=\"token punctuation\">,</span> msg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>å…ˆå¯åŠ¨æ¶ˆè´¹è€…æœåŠ¡è®©å®ƒå…ˆç­‰ç€</p>\n<p>æŸ¥çœ‹ mq çš„äº¤æ¢æœºæƒ…å†µï¼š</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310221614876.png\" alt=\"image-20231022161400235\"></p>\n<p>ç„¶åæˆ‘ä»¬å‘è¿™ä¸ª delay ä¸º true çš„äº¤æ¢æœºä¸­å‘é€æ¶ˆæ¯ï¼Œä¸€å®šè¦ç»™æ¶ˆæ¯æ·»åŠ ä¸€ä¸ª header: x-delayï¼Œå€¼ä¸ºå»¶è¿Ÿçš„æ—¶é—´ï¼Œå•ä½ä¸ºæ¯«ç§’ï¼š</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Test</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">testSndDelayMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   <span class=\"token class-name\">Message</span> message <span class=\"token operator\">=</span> <span class=\"token class-name\">MessageBuilder</span><span class=\"token punctuation\">.</span><span class=\"token function\">withBody</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hello, ttl message\"</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                                             <span class=\"token function\">getBytes</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">StandardCharsets</span><span class=\"token punctuation\">.</span><span class=\"token constant\">UTF_8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      <span class=\"token punctuation\">.</span><span class=\"token function\">setDeliveryMode</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MessageDeliveryMode</span><span class=\"token punctuation\">.</span><span class=\"token constant\">PERSISTENT</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      <span class=\"token punctuation\">.</span><span class=\"token function\">setHeader</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"x-delay\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5000</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// è®¾ç½®æ¶ˆæ¯çš„å»¶è¿Ÿæ—¶é—´ä¸º 5 ç§’</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   <span class=\"token comment\">// 1.1. å‡†å¤‡ CorrelationData</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   <span class=\"token comment\">// 1.2. æ¶ˆæ¯ ID</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   <span class=\"token class-name\">CorrelationData</span> correlationData <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">CorrelationData</span><span class=\"token punctuation\">(</span><span class=\"token constant\">UUID</span><span class=\"token punctuation\">.</span><span class=\"token function\">randomUUID</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   <span class=\"token comment\">// 2. å‘é€æ¶ˆæ¯</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   rabbitTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">convertAndSend</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"delay.direct\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"delay\"</span><span class=\"token punctuation\">,</span> message<span class=\"token punctuation\">,</span>correlationData <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>   log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"æ¶ˆæ¯å‘é€æˆåŠŸ\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>å†å¯åŠ¨å‘å¸ƒè€…æµ‹è¯•ä»£ç è¿›è¡Œå‘å¸ƒï¼š</p>\n<p>å‘å¸ƒåæµ‹è¯•ä»£ç ä¼šæç¤ºä¸€ä¸ªé”™è¯¯ä½†æ˜¯è¿™ä¸ªé”™è¯¯æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œå› ä¸ºå»¶è¿Ÿå®ƒä¼šè¯¯ä»¥ä¸ºéœ€è¦é‡è¯•ï¼Œå°±ä¼šè§¦å‘é‡å‘æœºåˆ¶ã€‚ä½†æ˜¯æˆ‘ä»¬ä¸éœ€è¦å¯¹å»¶è¿Ÿæ¶ˆæ¯è¿›è¡Œé‡è¯•ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¯¹å…¶åšä¸€ä¸‹åˆ¤æ–­</p>\n<pre><code>ERROR 17588 --- [nectionFactory1] cn.itcast.mq.config.CommonConfig         : æ¶ˆæ¯å‘é€åˆ°é˜Ÿåˆ—å¤±è´¥ï¼Œå“åº”ç ï¼š312ï¼Œå¤±è´¥åŸå› ï¼šNO_ROUTEï¼Œäº¤æ¢æœºï¼šdelay.directï¼Œè·¯ç”±keyï¼šdelayï¼Œæ¶ˆæ¯ï¼š(Body:'[B@71c09e9d(byte[18])' MessageProperties [headers=&#123;spring_returned_message_correlation=b85f2836-22b6-406e-9e49-d5f44a07af32&#125;, contentType=application/octet-stream, contentLength=0, receivedDeliveryMode=PERSISTENT, priority=0, receivedDelay=5000, deliveryTag=0])\n</code></pre>\n<p>å¯¹ receivedDelay è¿›è¡Œåˆ¤æ–­æ˜¯å¦å­˜åœ¨å€¼</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Slf4j</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token annotation punctuation\">@Configuration</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">//                         å®ç° Spring å·¥å‚çš„é€šçŸ¥</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CommonConfig</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">ApplicationContextAware</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token comment\">// é‡å†™ Bean å·¥å‚å‡†å¤‡å¥½åè°ƒç”¨çš„å‡½æ•°</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">setApplicationContext</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ApplicationContext</span> applicationContext<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">BeansException</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token comment\">// å–å‡º RabbitTempalte çš„ Bean</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token class-name\">RabbitTemplate</span> rabbitTemplate <span class=\"token operator\">=</span> applicationContext<span class=\"token punctuation\">.</span><span class=\"token function\">getBean</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">RabbitTemplate</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token comment\">// é…ç½® ReturnCallback</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        rabbitTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">setReturnCallback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">,</span> s<span class=\"token punctuation\">,</span> s1<span class=\"token punctuation\">,</span> s2<span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            <span class=\"token comment\">// åˆ¤æ–­æ˜¯å¦æ˜¯å»¶è¿Ÿæ¶ˆæ¯</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">.</span><span class=\"token function\">getMessageProperties</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getReceivedDelay</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                <span class=\"token comment\">// æ˜¯ä¸€ä¸ªå»¶è¿Ÿæ¶ˆæ¯ï¼Œå¿½ç•¥è¿™ä¸ªé”™è¯¯æç¤º</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            <span class=\"token comment\">// è®°å½•æ—¥å¿— &#123;&#125; ä¸ºå ä½ç¬¦</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            log<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"æ¶ˆæ¯å‘é€åˆ°é˜Ÿåˆ—å¤±è´¥ï¼Œå“åº”ç ï¼š&#123;&#125;ï¼Œå¤±è´¥åŸå› ï¼š&#123;&#125;ï¼Œ\"</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                    <span class=\"token string\">\"äº¤æ¢æœºï¼š&#123;&#125;ï¼Œè·¯ç”±keyï¼š&#123;&#125;ï¼Œæ¶ˆæ¯ï¼š&#123;&#125;\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                    i<span class=\"token punctuation\">,</span> s<span class=\"token punctuation\">,</span> s1<span class=\"token punctuation\">,</span> s2<span class=\"token punctuation\">,</span> message<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            <span class=\"token comment\">// å¦‚æœæœ‰éœ€è¦çš„è¯ï¼Œé‡å‘æ¶ˆæ¯</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>åœ¨è¿è¡Œå‘å¸ƒè€…æµ‹è¯•ä»£ç åæ‰“å°å¦‚ä¸‹ï¼š</p>\n<p>å¯ä»¥çœ‹åˆ°å°±æ²¡æœ‰é”™è¯¯æç¤ºäº†ï¼Œä¹Ÿå°±è§£å†³äº†æ˜æ˜æ²¡æœ‰é”™è¯¯å´é‡è¯•çš„é—®é¢˜äº†</p>\n<pre><code>16:22:35:703  INFO 2568 --- [           main] cn.itcast.mq.spring.SpringAmqpTest       : æ¶ˆæ¯å‘é€æˆåŠŸ\n</code></pre>\n<blockquote>\n<p><strong>æ€»ç»“</strong>ï¼š</p>\n<p>å»¶è¿Ÿé˜Ÿåˆ—æ’ä»¶çš„ä½¿ç”¨æ­¥éª¤åŒ…æ‹¬å“ªäº›ï¼Ÿ</p>\n<p>1ã€å£°æ˜ä¸€ä¸ªäº¤æ¢æœºï¼Œæ·»åŠ  delayed å±æ€§ä¸º true</p>\n<p>2ã€å‘é€æ¶ˆæ¯æ—¶ï¼Œæ·»åŠ  x-delay å¤´ï¼Œå€¼ä¸ºè¶…æ—¶æ—¶é—´</p>\n</blockquote>\n<h1 id=\"åä¸€-æƒ°æ€§é˜Ÿåˆ—\"><a class=\"markdownIt-Anchor\" href=\"#åä¸€-æƒ°æ€§é˜Ÿåˆ—\">#</a> åä¸€ã€æƒ°æ€§é˜Ÿåˆ—ğŸ„</h1>\n<ul>\n<li>æ¶ˆæ¯å †ç§¯é—®é¢˜</li>\n<li>æƒ°æ€§é˜Ÿåˆ—</li>\n</ul>\n<h2 id=\"111-æ¶ˆæ¯å †ç§¯é—®é¢˜\"><a class=\"markdownIt-Anchor\" href=\"#111-æ¶ˆæ¯å †ç§¯é—®é¢˜\">#</a> 11.1ã€æ¶ˆæ¯å †ç§¯é—®é¢˜ğŸŒ³</h2>\n<p>å½“ç”Ÿäº§è€…å‘é€æ¶ˆæ¯çš„é€Ÿåº¦è¶…è¿‡äº†æ¶ˆè´¹è€…å¤„ç†æ¶ˆæ¯çš„é€Ÿåº¦ï¼Œå°±ä¼šå¯¼è‡´é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯å †ç§¯ï¼Œç›´åˆ°é˜Ÿåˆ—å­˜å‚¨æ¶ˆæ¯è¾¾åˆ°ä¸Šé™ã€‚æœ€æ—©æ¥æ”¶åˆ°çš„æ¶ˆæ¯ï¼Œå¯èƒ½å°±ä¼šæˆä¸ºæ­»ä¿¡ï¼Œä¼šè¢«ä¸¢å¼ƒï¼Œè¿™å°±æ˜¯<font color='red'>æ¶ˆæ¯å †ç§¯</font>é—®é¢˜ã€‚</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310221629911.gif\" alt=\"test\"></p>\n<p><strong>è§£å†³æ¶ˆæ¯å †ç§¯æœ‰ä¸‰ç§æ€è·¯</strong>ï¼š</p>\n<p>1ã€å¢åŠ æ›´å¤šæ¶ˆè´¹è€…ï¼Œæé«˜æ¶ˆè´¹é€Ÿåº¦</p>\n<p>2ã€åœ¨æ¶ˆè´¹è€…å†…å¼€å¯çº¿ç¨‹æ± åŠ å¿«æ¶ˆæ¯å¤„ç†é€Ÿåº¦</p>\n<p>3ã€æ‰©å¤§é˜Ÿåˆ—å®¹ç§¯ï¼Œæé«˜å †ç§¯ä¸Šé™</p>\n<h2 id=\"112-æƒ°æ€§é˜Ÿåˆ—\"><a class=\"markdownIt-Anchor\" href=\"#112-æƒ°æ€§é˜Ÿåˆ—\">#</a> 11.2ã€æƒ°æ€§é˜Ÿåˆ—ğŸŒ³</h2>\n<p>ä» RabbitMQ çš„ 3.6.0 ç‰ˆæœ¬å¼€å§‹ï¼Œå°±å¢åŠ äº† Lazy Queues çš„æ¦‚å¿µï¼Œä¹Ÿå°±æ˜¯<font color='red'>æƒ°æ€§é˜Ÿåˆ—</font>.</p>\n<p>æƒ°æ€§é˜Ÿåˆ—çš„ç‰¹å¾å¦‚ä¸‹ï¼š</p>\n<p>1ã€æ¥å—åˆ°æ¶ˆæ¯åç›´æ¥å­˜å…¥ç£ç›˜è€Œéå†…å­˜</p>\n<p>2ã€æ¶ˆè´¹è€…è¦æ¶ˆè´¹æ—¶æ‰ä¼šä»ç£ç›˜ä¸­è¯»å–å¹¶åŠ è½½åˆ°å†…å­˜</p>\n<p>3ã€æ”¯æŒæ•°ç™¾ä¸‡æ¡çš„æ¶ˆæ¯å­˜å‚¨</p>\n<p>è€Œè¦è®¾ç½®ä¸€ä¸ªé˜Ÿåˆ—ä¸ºæƒ°æ€§é˜Ÿåˆ—ï¼Œåªéœ€è¦åœ¨å£°æ˜é˜Ÿåˆ—æ—¶ï¼ŒæŒ‡å®š x-queue-mode å±æ€§ä¸º lazy å³å¯ã€‚å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œå°†ä¸€ä¸ªè¿è¡Œä¸­çš„é˜Ÿåˆ—ä¿®æ”¹ä¸ºæƒ°æ€§é˜Ÿåˆ—ï¼š</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>rabbitmqctl set_policy <span class=\"token class-name\">Lazy</span> <span class=\"token string\">\"^lazy-queue$\"</span> '<span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"queue-mode\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"lazy\"</span><span class=\"token punctuation\">&#125;</span>' <span class=\"token operator\">--</span>apply<span class=\"token operator\">-</span><span class=\"token keyword\">to</span> <span class=\"token namespace\">queues</span></pre></td></tr></table></figure><p>ç”¨ SpringAMQP å£°æ˜æƒ°æ€§é˜Ÿåˆ—åˆ†ä¸¤ç§æ–¹å¼ï¼š</p>\n<p>@Bean æ–¹å¼</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Configuration</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">LazyConfig</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token annotation punctuation\">@Bean</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Queue</span> <span class=\"token function\">lazyQueue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token class-name\">QueueBuilder</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                <span class=\"token punctuation\">.</span><span class=\"token function\">durable</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"lazy.queue\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                <span class=\"token punctuation\">.</span><span class=\"token function\">lazy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// å¼€å¯ x-queue-mode ä¸º lazy</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>æ³¨è§£æ–¹å¼ï¼š</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@RabbitListener</span><span class=\"token punctuation\">(</span>queuesToDeclare <span class=\"token operator\">=</span> <span class=\"token annotation punctuation\">@Queue</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\tname <span class=\"token operator\">=</span> <span class=\"token string\">\"lazy.queue\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   durable <span class=\"token operator\">=</span> <span class=\"token string\">\"true\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   <span class=\"token string\">\"arguments\"</span> <span class=\"token operator\">=</span> <span class=\"token annotation punctuation\">@Argument</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"x-queue-mode\"</span><span class=\"token punctuation\">,</span> value <span class=\"token operator\">=</span> <span class=\"token string\">\"lazy\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">listenLazyQueue</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> msg<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"æ¥æ”¶åˆ° lazy.queueçš„æ¶ˆæ¯: &#123;&#125;\"</span> <span class=\"token punctuation\">,</span> msg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>ç¼–å†™æµ‹è¯•ä»£ç è¿›è¡Œç™¾ä¸‡æ¶ˆæ¯æµ‹è¯•ï¼š</p>\n<p>å…ˆå¯¹ delay.direct æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œç™¾ä¸‡æ¶ˆæ¯çš„æµ‹è¯•</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Test</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">testLazyQueue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>i <span class=\"token operator\">&lt;</span> <span class=\"token number\">1000000</span><span class=\"token punctuation\">;</span>i <span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      <span class=\"token comment\">// 1. å‡†å¤‡æ¶ˆæ¯</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      <span class=\"token class-name\">Message</span> message <span class=\"token operator\">=</span> <span class=\"token class-name\">MessageBuilder</span><span class=\"token punctuation\">.</span><span class=\"token function\">withBody</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hello, ttl message\"</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                                                <span class=\"token function\">getBytes</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">StandardCharsets</span><span class=\"token punctuation\">.</span><span class=\"token constant\">UTF_8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>         <span class=\"token punctuation\">.</span><span class=\"token function\">setDeliveryMode</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MessageDeliveryMode</span><span class=\"token punctuation\">.</span><span class=\"token constant\">NON_PERSISTENT</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>         <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token comment\">// 2. å‘é€æ¶ˆæ¯</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      rabbitTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">convertAndSend</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"delay.direct\"</span><span class=\"token punctuation\">,</span> message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å®ƒæ²¡æœ‰å­˜å‚¨ç£ç›˜è€Œå´å‘¢çˆ†çº¢äº†</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310221657687.png\" alt=\"image-20231022165706663\"></p>\n<p>ä¸‹é¢æµ‹è¯•æƒ°æ€§é˜Ÿåˆ—çš„æƒ…å†µï¼š</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Test</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">testLazyQueue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>i <span class=\"token operator\">&lt;</span> <span class=\"token number\">1000000</span><span class=\"token punctuation\">;</span>i <span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      <span class=\"token comment\">// 1. å‡†å¤‡æ¶ˆæ¯</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      <span class=\"token class-name\">Message</span> message <span class=\"token operator\">=</span> <span class=\"token class-name\">MessageBuilder</span><span class=\"token punctuation\">.</span><span class=\"token function\">withBody</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hello, ttl message\"</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                                                <span class=\"token function\">getBytes</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">StandardCharsets</span><span class=\"token punctuation\">.</span><span class=\"token constant\">UTF_8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>         <span class=\"token punctuation\">.</span><span class=\"token function\">setDeliveryMode</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MessageDeliveryMode</span><span class=\"token punctuation\">.</span><span class=\"token constant\">NON_PERSISTENT</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>         <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token comment\">// 2. å‘é€æ¶ˆæ¯</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      rabbitTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">convertAndSend</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"lazy.queue\"</span><span class=\"token punctuation\">,</span>  message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æ¶ˆæ¯éƒ½å­˜å‚¨åˆ°äº†ç£ç›˜ä¸­ï¼Œè¿™æ ·æ€§èƒ½å°±ä¼šæ¯”è¾ƒå¥½</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310221702921.png\" alt=\"image-20231022170213243\"></p>\n<blockquote>\n<p><strong>æ€»ç»“</strong>ï¼š</p>\n<p>æ¶ˆæ¯å †ç§¯é—®é¢˜çš„è§£å†³æ–¹æ¡ˆï¼Ÿ</p>\n<p>1ã€é˜Ÿåˆ—ä¸Šç»‘å®šå¤šä¸ªæ¶ˆè´¹è€…ï¼Œæé«˜æ¶ˆè´¹é€Ÿåº¦</p>\n<p>2ã€ç»™æ¶ˆè´¹è€…å¼€å¯çº¿ç¨‹æ± ï¼Œæé«˜æ¶ˆè´¹é€Ÿåº¦</p>\n<p>3ã€ä½¿ç”¨æƒ°æ€§é˜Ÿåˆ—ï¼Œå¯ä»¥å† mq ä¸­ä¿å­˜æ›´å¤šæ¶ˆæ¯</p>\n<p>æƒ°æ€§é˜Ÿåˆ—çš„ä¼˜ç‚¹æœ‰å“ªäº›ï¼Ÿ</p>\n<p>1ã€åŸºäºç£ç›˜å­˜å‚¨ï¼Œæ¶ˆæ¯ä¸Šé™é«˜</p>\n<p>2ã€æ²¡æœ‰é—´æ­‡æ€§çš„ page-outï¼Œæ€§èƒ½æ¯”è¾ƒç¨³å®š</p>\n<p>æƒ°æ€§é˜Ÿåˆ—çš„ç¼ºç‚¹æœ‰å“ªäº›ï¼Ÿ</p>\n<p>1ã€åŸºäºç£ç›˜å­˜å‚¨ï¼Œæ¶ˆæ¯æ—¶æ•ˆæ€§ä¼šé™ä½</p>\n<p>2ã€æ€§èƒ½å—é™äºç£ç›˜çš„ IO</p>\n</blockquote>\n<h1 id=\"åäºŒ-mqé›†ç¾¤\"><a class=\"markdownIt-Anchor\" href=\"#åäºŒ-mqé›†ç¾¤\">#</a> åäºŒã€MQ é›†ç¾¤ğŸ„</h1>\n<ul>\n<li>é›†ç¾¤åˆ†ç±»</li>\n<li>æ™®é€šé›†ç¾¤</li>\n<li>é•œåƒé›†ç¾¤</li>\n<li>ä»²è½½é˜Ÿåˆ—</li>\n</ul>\n<h2 id=\"121-é›†ç¾¤åˆ†ç±»\"><a class=\"markdownIt-Anchor\" href=\"#121-é›†ç¾¤åˆ†ç±»\">#</a> 12.1ã€é›†ç¾¤åˆ†ç±»ğŸŒ³</h2>\n<p>RabbitMQ æ˜¯åŸºäº Erlang è¯­è¨€ç¼–å†™ï¼Œè€Œ Erlang åˆæ˜¯ä¸€ä¸ªé¢å‘å¹¶å‘çš„è¯­è¨€ï¼Œå¤©ç„¶æ”¯æŒé›†ç¾¤æ¨¡å¼ï¼Œæ­å»ºæ¯”è¾ƒç®€å•ã€‚RabbitMQ çš„é›†ç¾¤æœ‰ä¸¤ç§æ¨¡å¼ï¼š</p>\n<p>1ã€<mark>æ™®é€šé›†ç¾¤</mark>ï¼šæ˜¯ä¸€ç§åˆ†å¸ƒå¼é›†ç¾¤ï¼Œå°†é˜Ÿåˆ—åˆ†æ•£åˆ°é›†ç¾¤çš„å„ä¸ªèŠ‚ç‚¹ï¼Œä»è€Œæé«˜æ•´ä¸ªé›†ç¾¤çš„å¹¶å‘èƒ½åŠ›ã€‚</p>\n<p>2ã€<mark>é•œåƒé›†ç¾¤</mark>ï¼šæ˜¯ä¸€ç§ä¸»ä»é›†ç¾¤ï¼Œæ™®é€šé›†ç¾¤çš„åŸºç¡€ä¸Šï¼Œæ·»åŠ äº†ä¸»ä»å¤‡ä»½åŠŸèƒ½ï¼Œæé«˜é›†ç¾¤çš„æ•°æ®å¯ç”¨æ€§ã€‚</p>\n<p>é•œåƒé›†ç¾¤è™½ç„¶æ”¯æŒä¸»ä»ï¼Œä½†ä¸»ä»åŒæ­¥å¹¶ä¸æ˜¯å¼ºä¸€è‡´çš„ï¼ŒæŸäº›æƒ…å†µä¸‹å¯èƒ½æœ‰æ•°æ®ä¸¢å¤±çš„é£é™©ã€‚å› æ­¤åœ¨ RabbitMQ çš„ 3.8 ç‰ˆæœ¬ä»¥åï¼Œæ¨å‡ºäº†æ–°çš„åŠŸèƒ½ï¼š<mark>ä»²è½½é˜Ÿåˆ—</mark> æ¥ä»£æ›¿é•œåƒé›†ç¾¤ï¼Œåº•å±‚é‡‡ç”¨ Raft åè®®ç¡®ä¿ä¸»ä»çš„æ•°æ®ä¸€è‡´æ€§ã€‚</p>\n<h3 id=\"1211-æ™®é€šé›†ç¾¤\"><a class=\"markdownIt-Anchor\" href=\"#1211-æ™®é€šé›†ç¾¤\">#</a> 12.1.1ã€æ™®é€šé›†ç¾¤ğŸŒ²</h3>\n<p>æ™®é€šé›†ç¾¤ï¼Œæˆ–è€…å«æ ‡å‡†é›†ç¾¤ (classic cluster) ï¼Œå…·å¤‡ä¸‹åˆ—ç‰¹å¾ï¼š</p>\n<ul>\n<li>ä¼šåœ¨é›†ç¾¤çš„å„ä¸ªèŠ‚ç‚¹é—´å…±äº«éƒ¨åˆ†æ•°æ®ï¼Œ åŒ…æ‹¬ï¼šäº¤æ¢æœºï¼Œé˜Ÿåˆ—å…ƒä¿¡æ¯ã€‚ä¸åŒ…å«é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ã€‚</li>\n</ul>\n<p>æ¯”å¦‚è¯´æœ‰ä¸‰å° RabbitMQï¼Œç„¶ååˆ›å»ºä¸€ä¸ªäº¤æ¢æœº</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310221716648.png\" alt=\"image-20231022171634984\"></p>\n<p>ç”±äºäº¤æ¢æœºå¯ä»¥åœ¨å„ä¸ªèŠ‚ç‚¹é—´å…±äº«ï¼Œæ‰€ä»¥å°†æ¥è¿™ä¸‰ä¸ªèŠ‚ç‚¹éƒ½èƒ½çœ‹åˆ°</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310221717792.png\" alt=\"image-20231022171726859\"></p>\n<p>ä½†æ˜¯ï¼Œç°åœ¨è¦åˆ›å»ºä¸€ä¸ªé˜Ÿåˆ—è¿™ä¸ªé˜Ÿåˆ—å« queue1 å®ƒæ˜¯åœ¨ç¬¬ä¸€ä¸ªäº¤æ¢æœºä¸Šå£°æ˜çš„ï¼Œæ­¤æ—¶é˜Ÿåˆ—æ˜¯ä¸å…±äº«çš„ã€‚ä½†æ˜¯æœ‰é˜Ÿåˆ—å…ƒä¿¡æ¯ï¼Œæ¯”å¦‚è¯´ queue1 å®ƒä¼šæœ‰å…¶å®ƒèŠ‚ç‚¹ä¸Šæœ‰ queue1 çš„åå­—ï¼Œä½ç½®ç­‰ä¿¡æ¯ã€‚ç›¸å½“äºæ˜¯ä¸€ä¸ªå¼•ç”¨</p>\n<ul>\n<li>å½“è®¿é—®é›†ç¾¤æŸèŠ‚ç‚¹æ—¶ï¼Œå¦‚æœé˜Ÿåˆ—ä¸åœ¨è¯¥èŠ‚ç‚¹ï¼Œä¼šä»æ•°æ®æ‰€åœ¨èŠ‚ç‚¹ä¼ é€’åˆ°å½“å‰èŠ‚ç‚¹å¹¶è¿”å›</li>\n</ul>\n<p>æ¯”å¦‚è¯´ç°åœ¨æœ‰ä¸€ä¸ªæ¶ˆè´¹è€…ç»‘å®šåˆ°äº† queue1 ä½†æ˜¯åœ¨è®¿é—®çš„æ—¶å€™ä¸å°å¿ƒè®¿é—®åˆ°äº†ç¬¬ä¸‰ä¸ªèŠ‚ç‚¹ã€‚è¿™ä¸ªèŠ‚ç‚¹ä¸Šæ²¡æœ‰ queue1 ä½†æ˜¯æœ‰ queue1 çš„å…ƒä¿¡æ¯ï¼Œå½“è·å–æ•°æ®çš„æ—¶å€™å°±ä¼šæ ¹æ®ç¬¬ä¸‰èŠ‚ç‚¹æœ‰ queue1 çš„ä½ç½®ä¿¡æ¯æ¥æ‰¾åˆ° queue1 ç„¶åæ‹¿åˆ°æ•°æ®</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310221722945.png\" alt=\"image-20231022172221484\"></p>\n<ul>\n<li>é˜Ÿåˆ—æ‰€åœ¨èŠ‚ç‚¹å®•æœºï¼Œé˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯å°±ä¼šä¸¢å¤±</li>\n</ul>\n<p>æ¯”å¦‚è¯´ queue1 æŒ‚äº†ï¼Œå› ä¸ºç¬¬ä¸‰èŠ‚ç‚¹å’Œ queue1 æ˜¯å¼•ç”¨å…³ç³»å†æ¥å–æ•°æ®çš„æ—¶å€™å°±å–ä¸åˆ°äº†</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310221723703.png\" alt=\"image-20231022172351386\"></p>\n<h4 id=\"12111-æ­å»ºæ™®é€šé›†ç¾¤\"><a class=\"markdownIt-Anchor\" href=\"#12111-æ­å»ºæ™®é€šé›†ç¾¤\">#</a> 12.1.1.1ã€æ­å»ºæ™®é€šé›†ç¾¤ğŸŒ´</h4>\n<p>æ­å»ºæ™®é€šé›†ç¾¤å¯ä»¥å‚è€ƒæ–‡ç« ï¼š<a href=\"../RabbitMQ/%E9%AB%98%E7%BA%A7%E7%AF%87/RabbitMQ%E9%83%A8%E7%BD%B2%E6%8C%87%E5%8D%97.md\">RabbitMQ éƒ¨ç½²æŒ‡å—</a>.</p>\n<h3 id=\"1212-é•œåƒé›†ç¾¤\"><a class=\"markdownIt-Anchor\" href=\"#1212-é•œåƒé›†ç¾¤\">#</a> 12.1.2ã€é•œåƒé›†ç¾¤ğŸŒ²</h3>\n<p>æ¯”æ–¹è¯´ï¼Œä¸‰ä¸ªèŠ‚ç‚¹ï¼Œäº¤æ¢æœºéƒ½èƒ½çœ‹åˆ°ã€‚é‚£é˜Ÿåˆ—å‘¢è¿™æ—¶å°±è¦çœ‹ä½ æ˜¯ä¸æ˜¯é•œåƒäº†ã€‚æ¯”æ–¹è¯´åœ¨ queue1 è¿™ä¸ªèŠ‚ç‚¹ä¸Šåˆ›å»ºäº†ä¸€ä¸ªé˜Ÿåˆ—ã€‚å› ä¸ºæ˜¯åœ¨èŠ‚ç‚¹ 1 ä¸Šåˆ›å»ºçš„ queue1 é˜Ÿåˆ—æ‰€ä»¥èŠ‚ç‚¹ 1 å°±æ˜¯ queue1 çš„ä¸»èŠ‚ç‚¹ï¼Œç„¶åæˆ‘ä»¬è¿˜å¯ä»¥æŒ‘å‡ºä¸€ä¸ªé•œåƒèŠ‚ç‚¹ã€‚æ¯”å¦‚è¯´åœ¨èŠ‚ç‚¹äºŒä¸Šåšä¸€ä¸ªé•œåƒï¼Œé‚£ä¹ˆèŠ‚ç‚¹äºŒå°±ä¼šæ‰¾èŠ‚ç‚¹ä¸€å»åŒæ­¥ queue1 çš„æ‰€æœ‰æ•°æ®ã€‚è¿™æ ·å®ƒä¿©çš„æ•°æ®å°±å…±äº«äº†ã€‚</p>\n<p>è€Œä¸»èŠ‚ç‚¹å’Œé•œåƒèŠ‚ç‚¹æ˜¯å¯ä»¥äº’ç›¸å¤‡ä»½çš„</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310221753072.png\" alt=\"image-20231022175329422\"></p>\n<p>é•œåƒé›†ç¾¤ï¼šæœ¬è´¨æ˜¯ä¸»ä»æ¨¡å¼ï¼Œå…·å¤‡ä¸‹é¢çš„ç‰¹å¾ï¼š</p>\n<p>1ã€äº¤æ¢æœºï¼Œé˜Ÿåˆ—ï¼Œé˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ä¼šåœ¨å„ä¸ª mq çš„é•œåƒèŠ‚ç‚¹ä¹‹é—´åŒæ­¥å¤‡ä»½ã€‚</p>\n<p>2ã€åˆ›å»ºé˜Ÿåˆ—çš„èŠ‚ç‚¹è¢«ç§°ä¸ºè¯¥é˜Ÿåˆ—çš„<strong>ä¸»èŠ‚ç‚¹</strong>ï¼Œå¤‡ä»½åˆ°çš„å…¶å®ƒèŠ‚ç‚¹å«åšè¯¥é˜Ÿåˆ—çš„<strong>é•œåƒ</strong>èŠ‚ç‚¹ã€‚</p>\n<p>3ã€ä¸€ä¸ªé˜Ÿåˆ—çš„ä¸»èŠ‚ç‚¹å¯èƒ½æ˜¯å¦ä¸€ä¸ªé˜Ÿåˆ—çš„é•œåƒèŠ‚ç‚¹</p>\n<p>4ã€æ‰€æœ‰æ“ä½œéƒ½æ˜¯ä¸»èŠ‚ç‚¹å®Œæˆï¼Œç„¶ååŒæ­¥ç»™é•œåƒèŠ‚ç‚¹</p>\n<p>5ã€ä¸»å®•æœºåï¼Œé•œåƒèŠ‚ç‚¹ä¼šæ›¿ä»£æˆæ–°çš„ä¸»</p>\n<p>æ¯”æ–¹è¯´ queue1 å®ƒçš„é•œåƒèŠ‚ç‚¹æ˜¯åœ¨ queue2 ä¸Šï¼Œqueue2 è¿™ä¸ªé˜Ÿåˆ—æ˜¯åœ¨èŠ‚ç‚¹ 2 ä¸Šçš„ï¼Œä½†æ˜¯å®ƒå¯ä»¥å†èŠ‚ç‚¹ 3 ä¸Šå¤‡ä»½ï¼Œè€Œ queue3 æ˜¯åœ¨èŠ‚ç‚¹ 3 ä¸Šï¼Œè€Œå®ƒçš„é•œåƒèŠ‚ç‚¹æ˜¯åœ¨èŠ‚ç‚¹ 1 ä¸Šã€‚</p>\n<p><img src=\"https://raw.githubusercontent.com/PigPigLetsGo/imeages/master/202310221942543.png\" alt=\"image-20231022194205210\"></p>\n<h4 id=\"12121-æ­å»ºé•œåƒé›†ç¾¤\"><a class=\"markdownIt-Anchor\" href=\"#12121-æ­å»ºé•œåƒé›†ç¾¤\">#</a> 12.1.2.1ã€æ­å»ºé•œåƒé›†ç¾¤ğŸŒ´</h4>\n<p>æ­å»ºé•œåƒé›†ç¾¤å¯ä»¥å‚è€ƒæ–‡ç« ï¼š<a href=\"../RabbitMQ/%E9%AB%98%E7%BA%A7%E7%AF%87/RabbitMQ%E9%83%A8%E7%BD%B2%E6%8C%87%E5%8D%97.md\">RabbitMQ éƒ¨ç½²æŒ‡å—</a>.</p>\n<h3 id=\"1213-ä»²è½½é˜Ÿåˆ—\"><a class=\"markdownIt-Anchor\" href=\"#1213-ä»²è½½é˜Ÿåˆ—\">#</a> 12.1.3ã€ä»²è½½é˜Ÿåˆ—ğŸŒ²</h3>\n<p>ä»²è½½é˜Ÿåˆ—ï¼šä»²è½½é˜Ÿåˆ—æ˜¯åœ¨ 3.8 ç‰ˆæœ¬ä»¥åæ‰æœ‰çš„æ–°åŠŸèƒ½ï¼Œç”¨æ¥æ›¿ä»£é•œåƒé˜Ÿåˆ—ï¼Œå…·å¤‡ä¸‹åˆ—ç‰¹å¾ï¼š</p>\n<p>1ã€ä¸é•œåƒé˜Ÿåˆ—ä¸€æ ·ï¼Œéƒ½æ˜¯ä¸»ä»æ¨¡å¼ï¼Œæ”¯æŒä¸»ä»æ•°æ®åŒæ­¥</p>\n<p>2ã€ä½¿ç”¨éå¸¸ç®€å•ï¼Œæ²¡æœ‰å¤æ‚çš„é…ç½®</p>\n<p>3ã€ä¸»ä»åŒæ­¥åŸºäº Raft åè®®ï¼Œå¼ºä¸€è‡´</p>\n<h4 id=\"12131-ä»²è½½é˜Ÿåˆ—æ­å»º\"><a class=\"markdownIt-Anchor\" href=\"#12131-ä»²è½½é˜Ÿåˆ—æ­å»º\">#</a> 12.1.3.1ã€ä»²è½½é˜Ÿåˆ—æ­å»ºğŸŒ´</h4>\n<p>ä»²è½½é˜Ÿåˆ—æ­å»ºå¯ä»¥å‚è€ƒæ–‡ç« ï¼š<a href=\"../RabbitMQ/%E9%AB%98%E7%BA%A7%E7%AF%87/RabbitMQ%E9%83%A8%E7%BD%B2%E6%8C%87%E5%8D%97.md\">RabbitMQ éƒ¨ç½²æŒ‡å—</a>.</p>\n",
            "tags": [
                "è®¡ç®—æœºå­¦ç§‘",
                "springcloud"
            ]
        }
    ]
}